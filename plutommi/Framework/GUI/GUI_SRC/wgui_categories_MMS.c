/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*****************************************************************************
 *
 * Filename:
 * ---------
 *  wgui_categories_MMS.c
 *
 * Project:
 * --------
 *  MAUI
 *
 * Description:
 * ------------
 *  MMS related categories. 
 *
 *  [Category275]       MMS SMIL editor
 *
 *  Note: Most MMS screens are located in mcu\wapadp\msf_ui\ instead of here.
 *
 * Author:
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/

#include "MMI_features.h"
//#include "StdC.h"
//#include "mmi_platform.h"
//#include "mmi_frm_gprot.h"

//#include "GlobalDefs.h"
/* gui related include */
//#include "WguiCategoryGprot.h"
//#include "gui_font_size.h"

//RHR
    #include "MMIDataType.h"
    #include "wgui_categories_MMS.h"
    #include "CustThemesRes.h"
    #include "gui.h"
    #include "kal_general_types.h"
    #include "wgui_draw_manager.h"
    #include "wgui_categories_util.h"
    #include "wgui_inputs.h"
    #include "gui_typedef.h"
    #include "wgui_include.h"
    #include "wgui.h"
    #include "gui_data_types.h"
    #include "gui_inputs.h"
    #include "ImeGprot.h"
    #include "mmi_frm_mem_gprot.h"
    #include "kal_public_api.h"
    #include "wgui_categories_enum.h"
    #include "gui_config.h"
    #include "gui_themes.h"
    #include "mmi_frm_events_gprot.h"
    #include "wgui_categories_inputs.h"
    #include "gui_buttons.h"
    #include "gdi_include.h"
    #include "gdi_const.h"
    #include "CustDataRes.h"
    #include "gui_theme_struct.h"
    #include "wgui_title.h"
    #include "mmi_rp_app_uiframework_def.h"
    #include "GlobalConstants.h"

#if defined(__MMI_SMART_MESSAGE_MO__) && !defined(__MMI_MESSAGES_EMS__)
#include "SmsGuiInterfaceType.h"
#endif 

#if defined(__MMI_SMART_MESSAGE_MT__) || (defined(__MMI_SMART_MESSAGE_MO__) && !defined(__MMI_MESSAGES_EMS__))
#include "MessagesExDcl.h"
extern S32 wgui_inputbox_buffer_size;
#endif /* defined(__MMI_SMART_MESSAGE_MT__) || (defined(__MMI_SMART_MESSAGE_MO__) && !defined(__MMI_MESSAGES_EMS__)) */ 


extern void dm_set_scr_bg_image_no_draw(U16 image_id, S8 *file_name, S32 x, S32 y, U8 opacity);        /* 092005 grayscale Calvin */

/***************************************************************************** 
* Define
*****************************************************************************/
#if defined(__MMI_MAINLCD_240X320__) || defined(__MMI_MAINLCD_240X400__)
#define CAT275_MIN_LINE_HEIGHT         (26)
#elif defined(__MMI_MAINLCD_320X480__)
#define CAT275_MIN_LINE_HEIGHT         (29)
#elif defined(__MMI_MAINLCD_176X220__)
#define CAT275_MIN_LINE_HEIGHT         (20)
#elif defined(__MMI_MAINLCD_128X160__)
#define CAT275_MIN_LINE_HEIGHT         (19)
#else 
/* However, category 275 should not be used on 128x128 display */
#define CAT275_MIN_LINE_HEIGHT         (19)
#endif 

/***************************************************************************** 
* Typedef 
*****************************************************************************/

typedef struct
{
    U32 identifier;
    wgui_cat275_draw_title_hdlr draw_title_fp;
    wgui_cat275_draw_area_hdlr draw_area_1_fp;
    wgui_cat275_draw_area_hdlr draw_area_2_fp;
    S16 draw_area_1_height;
    S16 draw_area_2_height;
    UI_filled_area *backup_normal_filler;   /* normal filler of editor */
} gui_cat275_context_struct;

/***************************************************************************** 
* Local Variable
*****************************************************************************/

static gui_cat275_context_struct *g_mmi_gui_cat275_context_p;

static BOOL g_mmi_gui_cat275_modified;

#define CAT275_CTX         (g_mmi_gui_cat275_context_p)

static UI_filled_area g_mmi_gui_cat275_editor_filler = {UI_FILLED_AREA_TYPE_COLOR | UI_FILLED_AREA_BORDER,
    NULL,
    NULL,
    {255, 255, 255, 100},
    {0, 0, 0, 0},
    {0, 0, 0, 0},
    {0, 0, 0, 0},
    0
};


#if defined (__MMI_WALLPAPER_ON_BOTTOM__)
static U8 editor_scr_bg_opacity;
#endif /* defined (__MMI_WALLPAPER_ON_BOTTOM__) */ 

/* Global variables for storing the Title bar buttons index of Category276 Screen */
#if defined(__MMI_TOUCH_SCREEN__)
U16 g_cat276_prev_btn_item_id = 0;  
U16 g_cat276_next_btn_item_id = 0;
static void DrawCat276TitleButton(U16 index);
#endif /* __MMI_TOUCH_SCREEN__ */

/***************************************************************************** 
* Local Function
*****************************************************************************/

/*****************************************************************************
 * FUNCTION
 *  category275_header_callback
 * DESCRIPTION
 *  redraw header 
 * PARAMETERS
 *  yoffset     [IN]        offset Y
 *  clip_x1     [IN]        start x
 *  clip_y1     [IN]        start y
 *  clip_x2     [IN]        end x
 *  clip_y2     [IN]        end y
 * RETURNS
 *  void
 *****************************************************************************/
static void category275_header_callback(MMI_BOOL is_draw, S32 yoffset, S32 height, S32 clip_x1, S32 clip_y1, S32 clip_x2, S32 clip_y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (is_draw == MMI_FALSE)
    {
        return ;
    }

    if (CAT275_CTX)
    {
        ((wgui_cat275_draw_area_hdlr_ex)(CAT275_CTX->draw_area_1_fp))(CAT275_CTX->identifier, yoffset, clip_x1, clip_y1, clip_x2, clip_y2, is_draw);
    }
}


/*****************************************************************************
 * FUNCTION
 *  category275_footer_callback
 * DESCRIPTION
 *  redraw footer
 * PARAMETERS
 *  yoffset     [IN]        offset Y
 *  clip_x1     [IN]        start x
 *  clip_y1     [IN]        start y
 *  clip_x2     [IN]        end x
 *  clip_y2     [IN]        end y
 * RETURNS
 *  void
 *****************************************************************************/
static void category275_footer_callback(MMI_BOOL is_draw, S32 yoffset, S32 height, S32 clip_x1, S32 clip_y1, S32 clip_x2, S32 clip_y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (is_draw == MMI_FALSE)
    {
        return ;
    }

    if (CAT275_CTX)
    {
        ((wgui_cat275_draw_area_hdlr_ex)(CAT275_CTX->draw_area_2_fp))(CAT275_CTX->identifier, yoffset, clip_x1, clip_y1, clip_x2, clip_y2, is_draw);
    }
}


/*****************************************************************************
 * FUNCTION
 *  category275_change_callback
 * DESCRIPTION
 *  change callbakc, set modified
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void category275_change_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_mmi_gui_cat275_modified = TRUE;
}

/***************************************************************************** 
* Global Variable
*****************************************************************************/

/***************************************************************************** 
* Global Function
*****************************************************************************/


/*****************************************************************************
 * FUNCTION
 *  DrawCate275CategoryControlArea
 * DESCRIPTION
 *  draw category 275 control area
 * PARAMETERS
 *  coordinate      [IN]     area to redraw
 * RETURNS
 *  void
 *****************************************************************************/
void DrawCate275CategoryControlArea(dm_coordinates *coordinate)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if !defined(GUI_COMMON_USE_SPECIFIC_STYLE) || (defined(GUI_COMMON_USE_SPECIFIC_STYLE) && defined(GUI_COMMON_SHOW_STATUS_ICON))
    show_title_status_icon();
#endif
    CAT275_CTX->draw_title_fp(CAT275_CTX->identifier);

    wgui_show_inputbox();

    if (RedrawSpellingOrCandidateBoxesFunction)
    {
        RedrawSpellingOrCandidateBoxesFunction();
    }

}


/* For detail description, please refer to wgui_categories_MMS.h */
void RedrawCategory275Screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gui_lock_double_buffer();

    clear_screen();

    CAT275_CTX->draw_title_fp(CAT275_CTX->identifier);

    wgui_show_inputbox();

    show_softkey_background();
    show_left_softkey();
    show_right_softkey();

    gui_unlock_double_buffer();
    gui_BLT_double_buffer(0, 0, UI_device_width - 1, UI_device_height - 1);

    if (RedrawSpellingOrCandidateBoxesFunction)
    {
        RedrawSpellingOrCandidateBoxesFunction();
    }
}


/* For detail description, please refer to wgui_categories_MMS.h */
void Category275GotoTop(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_multiline_inputbox.cursor_p = MMI_multiline_inputbox.text;

    MMI_multiline_inputbox.flags |= UI_MULTI_LINE_INPUT_BOX_DISABLE_DRAW;
    gui_show_multi_line_input_box(&MMI_multiline_inputbox);
    MMI_multiline_inputbox.flags &= ~UI_MULTI_LINE_INPUT_BOX_DISABLE_DRAW;

    MMI_multiline_inputbox.text_offset_y = 0;
    gui_show_multi_line_input_box(&MMI_multiline_inputbox);
}


/* For detail description, please refer to wgui_categories_MMS.h */
void Category275GotoBottom(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (MMI_multiline_inputbox.text_length >= 2)
    {
        MMI_multiline_inputbox.cursor_p =
            (UI_buffer_type) ((U8*) (MMI_multiline_inputbox.text) + (MMI_multiline_inputbox.text_length - 2));
    }
    MMI_multiline_inputbox.flags |= UI_MULTI_LINE_INPUT_BOX_DISABLE_DRAW;
    gui_show_multi_line_input_box(&MMI_multiline_inputbox);
    MMI_multiline_inputbox.flags &= ~UI_MULTI_LINE_INPUT_BOX_DISABLE_DRAW;

    if (MMI_multiline_inputbox.text_height > MMI_multiline_inputbox.edit_height)
    {
        MMI_multiline_inputbox.text_offset_y = MMI_multiline_inputbox.edit_height - MMI_multiline_inputbox.text_height;
    }
    gui_show_multi_line_input_box(&MMI_multiline_inputbox);
}


/* For detail description, please refer to wgui_categories_MMS.h */
void Category275SetUnmodified(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_mmi_gui_cat275_modified = FALSE;
}


/* For detail description, please refer to wgui_categories_MMS.h */
BOOL Category275CheckIfModified(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return g_mmi_gui_cat275_modified;
}


/*****************************************************************************
 * FUNCTION
 *  cat275_virtual_keypad_callback
 * DESCRIPTION
 *  virtual keypad callback
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void cat275_virtual_keypad_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(__MMI_TOUCH_SCREEN__)
    mmi_imc_redraw_screen_by_state();
#endif 
}


/* For detail description, please refer to wgui_categories_MMS.h */
void ShowCategory275Screen(
        U32 identifier,
        U16 left_softkey,
        U16 left_softkey_icon,
        U16 right_softkey,
        U16 right_softkey_icon,
        U32 input_type,
        U8 *buffer,
        S32 buffer_size,
        U16 vbar_width,
        wgui_cat275_draw_title_hdlr draw_title_fp,
        U16 draw_area_1_height,
        wgui_cat275_draw_area_hdlr draw_area_1_fp,
        U16 draw_area_2_height,
        wgui_cat275_draw_area_hdlr draw_area_2_fp,
        U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(__MMI_MAINLCD_320X240__)
    /* Landscape do not have status icon */
    MMI_content_y = 0;
    MMI_content_height = UI_DEVICE_HEIGHT - MMI_BUTTON_BAR_HEIGHT - MMI_content_y;
#endif /* defined(__MMI_MAINLCD_320X240__) */

    ShowCategory277Screen(
        identifier, 
        left_softkey, 
        left_softkey_icon, 
        right_softkey, 
        right_softkey_icon, 
        input_type, 
        buffer, 
        buffer_size, 
        vbar_width, 
        draw_title_fp, 
        draw_area_1_height,
        draw_area_1_fp,
        draw_area_2_height,
        draw_area_2_fp,
        NULL,
        NULL,
        NULL,
        NULL,
        history_buffer);
}


/* For detail description, please refer to wgui_categories_MMS.h */
void ShowCategory277Screen(
        U32 identifier,
        U16 left_softkey,
        U16 left_softkey_icon,
        U16 right_softkey,
        U16 right_softkey_icon,
        U32 input_type,
        U8 *buffer,
        S32 buffer_size,
        U16 vbar_width,
        wgui_cat275_draw_title_hdlr draw_title_fp,
        U16 draw_area_1_height,
        wgui_cat275_draw_area_hdlr draw_area_1_fp,
        U16 draw_area_2_height,
        wgui_cat275_draw_area_hdlr draw_area_2_fp,
        UI_font_type *text_font,
        color *text_color,
        color *selected_text_color,
        color *bg_color,
        U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    dm_data_struct dm_data;
    S32 inputbox_height;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Setup context */
    g_mmi_gui_cat275_context_p = OslMalloc(sizeof(gui_cat275_context_struct));
    CAT275_CTX->identifier = identifier;
    CAT275_CTX->draw_title_fp = draw_title_fp;
    CAT275_CTX->draw_area_1_fp = draw_area_1_fp;
    CAT275_CTX->draw_area_2_fp = draw_area_2_fp;
    CAT275_CTX->draw_area_1_height = draw_area_1_height;
    CAT275_CTX->draw_area_2_height = draw_area_2_height;

    /* Setup layout */
    gui_lock_double_buffer();

    wgui_title_set_menu_shortcut_number(-1);
    wgui_title_disable_menu_shortcut_display(MMI_TRUE);
    change_left_softkey(left_softkey, left_softkey_icon);
    change_right_softkey(right_softkey, right_softkey_icon);
    SetupCategoryKeyHandlers();

    wgui_setup_inputbox_ext(0, MMI_content_y, MMI_content_width,
                            MMI_content_height,
                            buffer, buffer_size,
                            MMI_CATEGORY275_ID, get_string(right_softkey), get_image(right_softkey_icon),
                            input_type, history_buffer, NULL,
#ifdef __MMI_FTE_SUPPORT__        
                            0,
#else
                            1, 
#endif
                            UI_MULTI_LINE_INPUT_BOX_DRAW_UNDERLINE,
#if defined(__MMI_MAINLCD_176X220__) || defined(__MMI_MAINLCD_240X320__) || defined(__MMI_MAINLCD_240X400__)        // TODO: tune style 4
                            (S16) (draw_area_1_height + draw_area_2_height + CAT275_MIN_LINE_HEIGHT * 2),
#else 
                            (S16) (draw_area_1_height + draw_area_2_height + CAT275_MIN_LINE_HEIGHT),
#endif 
                            CAT275_MIN_LINE_HEIGHT, (S16) draw_area_1_height, (S16) draw_area_2_height, NULL);

    inputbox_height = MMI_content_height - wgui_inputbox_information_bar_height;
    if (MMI_multiline_inputbox.height > inputbox_height)
    {
        gui_resize_multi_line_input_box(&MMI_multiline_inputbox, MMI_multiline_inputbox.width, inputbox_height);
    }

    /* Input box attributes */
    MMI_multiline_inputbox.header_callback = category275_header_callback;
    MMI_multiline_inputbox.footer_callback = category275_footer_callback;
    MMI_multiline_inputbox.change_callback = category275_change_callback;

    /* Disable editor border and set background color of multitap */
    CAT275_CTX->backup_normal_filler = MMI_multiline_inputbox.normal_filler;

    if (MMI_multiline_inputbox.normal_filler)
    {
        if ((MMI_multiline_inputbox.normal_filler->flags & UI_FILLED_AREA_MASK_TYPE) == UI_FILLED_AREA_TYPE_COLOR)
        {
            g_mmi_gui_cat275_editor_filler.flags = UI_FILLED_AREA_TYPE_COLOR | UI_FILLED_AREA_BORDER;
            if (bg_color != NULL)
            {
                g_mmi_gui_cat275_editor_filler.c = *bg_color;
            }
            else
            {
                g_mmi_gui_cat275_editor_filler.c = MMI_multiline_inputbox.normal_filler->c;
            }
            
            /* Tricky. Use multitap text color as editor border color */
            g_mmi_gui_cat275_editor_filler.border_color = gui_color(0, 0, 0); /* *current_MMI_theme->multitap_normal_text_color; */

            MMI_multiline_inputbox.normal_filler = (UI_filled_area*)&g_mmi_gui_cat275_editor_filler;       
        }
   }

    if (text_color != NULL)
    {
        MMI_multiline_inputbox.normal_text_color = *text_color;
    }
    
    if (selected_text_color != NULL)
    {
        MMI_multiline_inputbox.selected_text_color = *selected_text_color;
    }

    if (text_font != NULL)
    {
        MMI_multiline_inputbox.text_font = *text_font;
    }


#ifdef __MMI_WALLPAPER_ON_BOTTOM__
    MMI_multiline_inputbox.flags |= UI_MULTI_LINE_INPUT_BOX_TRANSPARENT_BACKGROUND;
    dm_get_scr_bg_opacity(&editor_scr_bg_opacity);
    dm_set_scr_bg_opacity((U8)(current_MMI_theme->bg_opacity_low));
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */ 

    gui_unlock_double_buffer();

    /* Setup standard category handler */
    ExitCategoryFunction = ExitCategory275Screen;
    dm_setup_category_functions(dm_redraw_category_screen, GetCategory275History, GetCategory275HistorySize);
    dm_data.s32ScrId = (S32) GetActiveScreenId();
    dm_data.s32CatId = MMI_CATEGORY275_ID;
    dm_data.s32flags = DM_CLEAR_SCREEN_BACKGROUND;
    dm_data.s32flags |= DM_SHOW_VKPAD;
    dm_setup_data(&dm_data);
    dm_register_category_controlled_callback(DrawCate275CategoryControlArea);
    dm_register_vkpad_callback(cat275_virtual_keypad_callback);
    dm_redraw_category_screen();
}


/* For detail description, please refer to wgui_categories_MMS.h */
void ExitCategory275Screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Reset UI */
    wgui_close_inputbox();
    reset_softkeys();

#ifdef __MMI_WALLPAPER_ON_BOTTOM__
    dm_set_scr_bg_opacity(editor_scr_bg_opacity);
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */ 

    /*
     * Release context after other deinitialization routine
     * * because they might refer to CAT275_CTX
     */

    MMI_multiline_inputbox.normal_filler = CAT275_CTX->backup_normal_filler;

    OslMfree(g_mmi_gui_cat275_context_p);
    g_mmi_gui_cat275_context_p = NULL;
}


/* For detail description, please refer to wgui_categories_MMS.h */
S32 GetCategory275HistorySize(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return sizeof(multiline_inputbox_category_history);
}


/* For detail description, please refer to wgui_categories_MMS.h */
U8 *GetCategory275History(U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    get_multiline_inputbox_category_history(MMI_CATEGORY275_ID, history_buffer);
    return history_buffer;
}


/* For detail description, please refer to wgui_categories_MMS.h */
void AppendCategory275String(U32 input_type, U8 *buffer, S32 buffer_size, U8 *s, U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    wgui_multiline_inputbox_append_string(input_type, buffer, buffer_size, s, history_buffer, MMI_CATEGORY275_ID, NULL);
}


#if defined(__MMI_SMART_MESSAGE_MO__) && !defined(__MMI_MESSAGES_EMS__) || defined(__MMI_SMART_MESSAGE_MT__)
/*****************************************************************************
 * FUNCTION
 *  cat275NSM_virtual_keypad_callback
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void cat275NSM_virtual_keypad_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(__MMI_TOUCH_SCREEN__)
    mmi_imc_redraw_screen_by_state();
#endif 
}


/*****************************************************************************
 * FUNCTION
 *  ShowCategoryNSM275Screen
 * DESCRIPTION
 *  Displays the categoryNSM275 screen
 * PARAMETERS
 *  identifier              [IN]        Used as parameter for the callback functions described before
 *  left_softkey            [IN]        Left softkey label
 *  left_softkey_icon       [IN]        Icon for the left softkey
 *  right_softkey           [IN]        Right softkey label
 *  right_softkey_icon      [IN]        Icon for the right softkey
 *  input_type              [IN]        Type of input to use
 *  buffer                  [IN]        Buffer the input box should use.
 *  buffer_size             [IN]        Size of the buffer.
 *  vbar_width              [IN]        Width of vertical bar
 *  draw_title_fp           [IN]        Function pointer to draw the title bar
 *  draw_area_1_height      [IN]        Height of the area where picture is to be shown
 *  draw_area_1_fp          [IN]        Function to draw the picture in area1
 *  draw_area_2_height      [IN]        Text area height
 *  draw_area_2_fp          [IN]        Function to insert the text
 *  history_buffer          [IN]        History buffer
 * RETURNS
 *  void
 *****************************************************************************/
#if defined(__MMI_SMART_MESSAGE_MO__) && !defined(__MMI_MESSAGES_EMS__)
extern nsm_msg_struct g_nsm_msg_context;
extern S32 mmi_nsm_get_infobar_maxlen(void);
#endif /* defined(__MMI_SMART_MESSAGE_MO__) && !defined(__MMI_MESSAGES_EMS__) */ 

void ShowCategoryNSM275Screen(
        U32 identifier,
        U16 left_softkey,
        U16 left_softkey_icon,
        U16 right_softkey,
        U16 right_softkey_icon,
        U32 input_type,
        U8 *buffer,
        S32 buffer_size,
        U16 vbar_width,
        wgui_cat275_draw_title_hdlr draw_title_fp,
        U16 draw_area_1_height,
        wgui_cat275_draw_area_hdlr draw_area_1_fp,
        U16 draw_area_2_height,
        wgui_cat275_draw_area_hdlr draw_area_2_fp,
        U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    dm_data_struct dm_data;
    S32 inputbox_height;
    U32 flagID;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Setup context */
    g_mmi_gui_cat275_context_p = OslMalloc(sizeof(gui_cat275_context_struct));
    CAT275_CTX->identifier = identifier;
    CAT275_CTX->draw_title_fp = draw_title_fp;
    CAT275_CTX->draw_area_1_fp = draw_area_1_fp;
    CAT275_CTX->draw_area_2_fp = draw_area_2_fp;
    CAT275_CTX->draw_area_1_height = draw_area_1_height;
    CAT275_CTX->draw_area_2_height = draw_area_2_height;

    /* Setup layout */
    gui_lock_double_buffer();

    wgui_title_set_menu_shortcut_number(-1);
    wgui_title_disable_menu_shortcut_display(MMI_TRUE);
    change_left_softkey(left_softkey, left_softkey_icon);
    change_right_softkey(right_softkey, right_softkey_icon);
    SetupCategoryKeyHandlers();

    flagID = UI_MULTI_LINE_INPUT_BOX_CHECK_GSM_EXTENDED | UI_MULTI_LINE_INPUT_BOX_USE_ENCODING_BASED_LENGTH;

    wgui_setup_inputbox_ext(0, MMI_content_y, MMI_content_width,
                            MMI_content_height,
                            buffer, buffer_size, MMI_CATEGORY275_ID, get_string(right_softkey), get_image(right_softkey_icon), input_type, history_buffer, NULL,
#ifdef __MMI_FTE_SUPPORT__        
                            0,
#else
                            1, 
#endif
                            flagID,   /* PMT JAI : 05012005 FOR NSM PHASE-II */
                            14, 14,
                            draw_area_1_height, draw_area_2_height, NULL);

    inputbox_height = MMI_content_height - wgui_inputbox_information_bar_height;
    if (MMI_multiline_inputbox.height > inputbox_height)
    {
        gui_resize_multi_line_input_box(&MMI_multiline_inputbox, MMI_multiline_inputbox.width, inputbox_height);
    }

    /* Input box attributes */
    MMI_multiline_inputbox.header_callback = category275_header_callback;
    MMI_multiline_inputbox.footer_callback = category275_footer_callback;
    MMI_multiline_inputbox.change_callback = category275_change_callback;

#ifdef __MMI_WALLPAPER_ON_BOTTOM__
    MMI_multiline_inputbox.flags |= UI_MULTI_LINE_INPUT_BOX_TRANSPARENT_BACKGROUND;
    dm_get_scr_bg_opacity(&editor_scr_bg_opacity);
    dm_set_scr_bg_opacity((U8)(current_MMI_theme->bg_opacity_low));  
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */ 

    gui_unlock_double_buffer();

    /* Setup standard category handler */
    ExitCategoryFunction = ExitCategoryNSM275Screen;    /* JP : after Justin suggestion */

#if defined(__MMI_SMART_MESSAGE_MO__) && !defined(__MMI_MESSAGES_EMS__)
    MMI_multiline_inputbox.available_length = mmi_nsm2_get_remaining_len();
    wgui_inputbox_buffer_size = (MMI_multiline_inputbox.available_length >> 1);

    if (g_nsm_msg_context.is_template_insert == TRUE)
    {
        MMI_multiline_inputbox.cursor_p = (MMI_multiline_inputbox.text + g_nsm_msg_context.cursor_pos_after_template);
        g_nsm_msg_context.is_template_insert = FALSE;
        g_nsm_msg_context.cursor_pos_after_template = 0;
    }
#endif /* defined(__MMI_SMART_MESSAGE_MO__) && !defined(__MMI_MESSAGES_EMS__) */ 

#if defined(__MMI_SMART_MESSAGE_MT__)
    MMI_multiline_inputbox.available_length = mmi_nsm_get_infobar_maxlen();
    wgui_inputbox_buffer_size = (MMI_multiline_inputbox.available_length >> 1);
#endif /* defined(__MMI_SMART_MESSAGE_MT__) */ 

    dm_setup_category_functions(dm_redraw_category_screen, GetCategory275History, GetCategory275HistorySize);
    dm_data.s32ScrId = (S32) GetActiveScreenId();
    dm_data.s32CatId = MMI_CATEGORY_NSM275;
    dm_data.s32flags = DM_CLEAR_SCREEN_BACKGROUND;
    dm_data.s32flags |= DM_SHOW_VKPAD;
    dm_setup_data(&dm_data);
    dm_register_category_controlled_callback(DrawCate275CategoryControlArea);
    dm_register_vkpad_callback(cat275NSM_virtual_keypad_callback);
    dm_redraw_category_screen();

}


/*****************************************************************************
 * FUNCTION
 *  ExitCategoryNSM275Screen
 * DESCRIPTION
 *  Exits the categoryNSM275 screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void ExitCategoryNSM275Screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Reset UI */
    wgui_close_inputbox();
    reset_softkeys();

#ifdef __MMI_WALLPAPER_ON_BOTTOM__
    dm_set_scr_bg_opacity(editor_scr_bg_opacity);
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */ 

    OslMfree(g_mmi_gui_cat275_context_p);
    g_mmi_gui_cat275_context_p = NULL;
}


/*****************************************************************************
 * FUNCTION
 *  RedrawCategoryNSM275Screen
 * DESCRIPTION
 *  Redraws the categoryNSM275 screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void RedrawCategoryNSM275Screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gui_lock_double_buffer();

    clear_screen();

    show_title_status_icon();
    CAT275_CTX->draw_title_fp(CAT275_CTX->identifier); 

    wgui_show_inputbox();

    show_softkey_background();
    show_left_softkey();
    show_right_softkey();

    gui_unlock_double_buffer();
    gui_BLT_double_buffer(0, 0, UI_device_width - 1, UI_device_height - 1);

    if (RedrawSpellingOrCandidateBoxesFunction)
    {
        RedrawSpellingOrCandidateBoxesFunction();
    }
}

#endif /* defined(__MMI_SMART_MESSAGE_MO__) && !defined(__MMI_MESSAGES_EMS__) || defined(__MMI_SMART_MESSAGE_MT__) */ 

/* deepali view screen */
#define CAT276_SLIDING_BAR_H_SPACE     8
#define CAT276_SLIDING_BAR_V_SPACE     4

/*
 * This Blend Effect is required for mixing the Current MMI Theme Title Color with BLACK color
 * in a ratio defined by the CAT276_BLEND_EFFECT macro
 */
#define CAT276_BLEND_EFFECT            20


/* For detail description, please refer to wgui_categories_MMS.h */
void RedrawCategory276Screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gui_lock_double_buffer();
    clear_screen();
    draw_title();

    show_softkey_background();
    show_left_softkey();
    show_right_softkey();

    gui_unlock_double_buffer();
    gui_BLT_double_buffer(0, 0, UI_device_width - 1, UI_device_height - 1);

}

#if 0
/* under construction !*/
#endif
extern void cat129_clear_icon_bg(void *button);


/*****************************************************************************
 * FUNCTION
 *  cat276_clear_icon_bg_title
 * DESCRIPTION
 *  clear icon background title
 * PARAMETERS
 *  button      [IN]     icontext_button
 * RETURNS
 *  void
 *****************************************************************************/
void cat276_clear_icon_bg_title(void *button)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    icontext_button *b = (icontext_button*) button;
    S32 x1 = b->x;
    S32 y1 = b->y;
    S32 x2 = b->x + b->width - 1;
    S32 y2 = b->y + b->height - 1;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_push_clip();
    gdi_layer_set_clip(x1, y1, x2 + 1, y2 + 1);
    gdi_draw_solid_rect(MMI_title_x, MMI_title_y, MMI_title_x + MMI_title_width - 1, MMI_title_y + MMI_title_height - 1, GDI_COLOR_WHITE);
#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif
        gui_draw_filled_area(
            MMI_title_x,
            MMI_title_y,
            MMI_title_x + MMI_title_width - 1,
            MMI_title_y + MMI_title_height - 1,
            current_UI_theme->window_title_theme->active_filler);
#if 0
/* under construction !*/
#endif
    gdi_layer_pop_clip();
}


/* For detail description, please refer to wgui_categories_MMS.h */
void ShowCategory276Screen(
        U8 *title,
        U16 title_icon,
        U16 left_softkey,
        U16 left_softkey_icon,
        U16 right_softkey,
        U16 right_softkey_icon,
        U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    dm_data_struct dm_data;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_lock_frame_buffer();

    wgui_title_disable_menu_shortcut_display(MMI_TRUE);
    change_left_softkey(left_softkey, left_softkey_icon);
    change_right_softkey(right_softkey, right_softkey_icon);
    SetupCategoryKeyHandlers();

    if (gOnFullScreen & MMI_LEAVE_FULL_SCREEN)
    {
        gOnFullScreen = MMI_IN_NORMAL_SCREEN;
    }

    wgui_status_icon_bar_reset_display(WGUI_STATUS_ICON_BAR_H_BAR);
    #ifdef WGUI_STATUS_ICON_SHOW_V_BAR
    wgui_status_icon_bar_reset_display(WGUI_STATUS_ICON_BAR_V_BAR);
    #endif
    MMI_title_icon = (PU8) get_image(title_icon);
    MMI_title_string = (UI_string_type) title;

#if defined(__MMI_TOUCH_SCREEN__)
    if (wgui_is_touch_title_bar_buttons())
    {
        g_cat276_prev_btn_item_id = dm_add_button(
                                        NULL,
                                        get_image(LEFT_RED_ARROW),
                                        get_image(LEFT_RED_ARROW),
                                        cat276_clear_icon_bg_title);
        g_cat276_next_btn_item_id = dm_add_button(
                                        NULL,
                                        get_image(RIGHT_RED_ARROW),
                                        get_image(RIGHT_RED_ARROW),
                                        cat276_clear_icon_bg_title);
#if 0
/* under construction !*/
#endif
    }
#endif /* defined(__MMI_TOUCH_SCREEN__) */ 
    gdi_layer_unlock_frame_buffer();

    ExitCategoryFunction = ExitCategory276Screen;

    #if defined(__MMI_TOUCH_SCREEN__)
    if (wgui_is_touch_title_bar_buttons())
    {
        /* register the handler for pen event down istead of pen event up */
        dm_register_button_functions(g_cat276_prev_btn_item_id, KEY_EVENT_UP, gMMI_touch_title_button1_down_handler);
        dm_register_button_functions(g_cat276_next_btn_item_id, KEY_EVENT_UP, gMMI_touch_title_button2_down_handler);
    }
    #endif /* defined(__MMI_TOUCH_SCREEN__) */ 
    dm_setup_category_functions(dm_redraw_category_screen, dummy_get_history, dummy_get_history_size);
    dm_data.s32ScrId = (S32) GetActiveScreenId();
    dm_data.s32CatId = MMI_CATEGORY276_ID;
    dm_data.s32flags = DM_CLEAR_SCREEN_BACKGROUND;
    dm_setup_data(&dm_data);
    #if !defined(__MMI_TOUCH_SCREEN__)
    dm_register_category_controlled_callback(dm_category_276_controlled_area);
    #endif /* __MMI_TOUCH_SCREEN__ */
    dm_redraw_category_screen();

}


/* For detail description, please refer to wgui_categories_MMS.h */
void dm_category_276_controlled_area(dm_coordinates *coordinate)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    RedrawCategory276Screen();
}


#if defined(__MMI_TOUCH_SCREEN__)


/* For detail description, please refer to wgui_categories_MMS.h */
static void DrawCat276TitleButton(U16 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#if defined(__MMI_TOUCH_SCREEN__)
    icontext_button *b;
#endif 

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(__MMI_TOUCH_SCREEN__)
    b = dm_get_button(index);
    gdi_layer_push_clip();
    gdi_layer_set_clip(b->x, b->y, b->x + b->width - 1, b->y + b->height - 1);
    gui_show_icontext_button(b);
    gdi_layer_pop_clip();
#endif /* defined(__MMI_TOUCH_SCREEN__) */ 
}
#endif /* defined(__MMI_TOUCH_SCREEN__) */ 


/*****************************************************************************
 * FUNCTION
 *  DrawCat276Title
 * DESCRIPTION
 *  Draw category 276 title
 * PARAMETERS
 *  title       [IN]        Title to be Displayed
 * RETURNS
 *  void
 *****************************************************************************/
void DrawCat276Title(U8 *title)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gui_lock_double_buffer();
    MMI_title_string = (UI_string_type) title;
    draw_title();
#if defined(__MMI_TOUCH_SCREEN__)
    if (wgui_is_touch_title_bar_buttons())
    {
        DrawCat276TitleButton(g_cat276_prev_btn_item_id);
        DrawCat276TitleButton(g_cat276_next_btn_item_id);
    }
#endif /* defined(__MMI_TOUCH_SCREEN__) */ 
    /*  we are showing the title bar of non touch screen phone same as touch screen phone 
       The following lines for showing left and right arrow for non touch screen phone and this title bar
       is not applicable for S880(128x160) phone */

    gui_unlock_double_buffer();
    gui_BLT_double_buffer(
        MMI_title_x,
        MMI_title_y,
        MMI_title_x + MMI_title_width - 1,
        MMI_title_y + MMI_title_height - 1);

}


void DrawCat276SlidingBar(U8 percentage)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 x1, y1, x2, y2, x3;
    color bg_color, bar_border_color, bar_filler_color, bar_unfill_color;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    x1 = 0;
    y1 = 0;
    x2 = UI_device_width - 1;
    y2 = MMI_title_y - 1;

    gui_lock_double_buffer();

    gui_push_clip();
    gui_set_clip(x1, y1, x2, y2);

    bg_color = current_MMI_theme->title_filler->c;

    gui_fill_rectangle(x1, y1, x2, y2, gui_color(bg_color.r, bg_color.g, bg_color.b));

    x1 += CAT276_SLIDING_BAR_H_SPACE;
    y1 += CAT276_SLIDING_BAR_V_SPACE;
    x2 -= CAT276_SLIDING_BAR_H_SPACE;
    y2 -= CAT276_SLIDING_BAR_V_SPACE;

    bar_border_color = gui_color(0, 0, 0);

    gui_line(x1, y1 + 1, x1, y2 - 1, bar_border_color);
    gui_line(x2, y1 + 1, x2, y2 - 1, bar_border_color);
    gui_line(x1 + 1, y1, x2 - 1, y1, bar_border_color);
    gui_line(x1 + 1, y2, x2 - 1, y2, bar_border_color);

    x1++;
    y1++;
    x2--;
    y2--;

    if (percentage > 100)
    {
        percentage = 100;
    }

    x3 = x1 + (((x2 - x1) * percentage) / 100);

    /* Get the Current Theme Title Color */
    bar_filler_color = *(current_MMI_theme->title_text_color);

    /* Get the Unfilll Color */
    bar_unfill_color = gui_color(255, 255, 255);

    /* 
     * Mix Current Theme Title Text Color with Black Color in a ratio defined by  CAT276_BLEND_EFFECT 
     * This mixing is required to differentiate between slider background color with slider color in 
     * case the bar_unfill_color matches with current_MMI_theme->title_text_color
     */
    bar_filler_color =
        gui_blend_two_color(bar_filler_color, gui_color(0, 0, 0), 100 - CAT276_BLEND_EFFECT,
                            CAT276_BLEND_EFFECT);

    /* Now fill the New color for drawing the slider */
    gui_fill_rectangle(x1, y1, x3, y2, bar_filler_color);

    /* And draw the Unfill Color for rest of the slider */
    gui_fill_rectangle(x3 + 1, y1, x2, y2, bar_unfill_color);

    gui_pop_clip();

    gui_unlock_double_buffer();

    gui_BLT_double_buffer(0, 0, UI_device_width - 1, MMI_title_y - 1);
}


/* For detail description, please refer to wgui_categories_MMS.h */
void ExitCategory276Screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gui_hide_animations();
    
#if defined(__MMI_TOUCH_SCREEN__)
    if (wgui_is_touch_title_bar_buttons())
    {
#if 0
/* under construction !*/
#endif
        wgui_reset_touch_title_bar_buttons();
    }
#endif /* defined(__MMI_TOUCH_SCREEN__) */ 
    /* when we come out from the MMS view screen then reset the value of title_bg_id to zero which we set in showcategory276screen */
    ExitCategoryFunction = MMI_dummy_function;
    RedrawCategoryFunction = MMI_dummy_function;
    GetCategoryHistory = dummy_get_history;
    GetCategoryHistorySize = dummy_get_history_size;
    leave_full_screen();
}


