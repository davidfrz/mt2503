/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*****************************************************************************/

/*****************************************************************************
 *
 * Filename:
 * ---------
 * MMSJSRSrvMain.c
 *
 * Project:
 * --------
 *   MAUI
 *
 * Description:
 * ------------
 *   
 *
 * Author:
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/
#include "MMI_features.h"
#ifdef __MMI_MMS_2__

#if defined(MMS_SUPPORT)

#include "MMSJsrSrvTypes.h"
#include "MMSJsrSrvProts.h"

#include "MMSJSRSrvSndRcv.h"
/* Stack related header files */
#include "kal_public_defs.h"  /* All the primitives declaration */
/* send primitive related header files */
#include "stack_ltlcom.h"       /* allocate_ilm, msg_send_ext_queue */
       /* MMI_L4C_SAP, J2ME_WAP_SAP */
 /* ilm_struct, TD_CTRL */
#include "mmi_frm_events_gprot.h"       /* OslMsgSendExtQueue, mmi_msg_send_ext_queue, MMI_FRM_INIT_EVENT */
#include "mmi_frm_queue_gprot.h"        /* MYQUEUE, OslConstructDataPtr */
#include "custom_wap_config.h"  /* wap_custom_get_max_mms_msg_size */
#include "string.h"     /* strlen .. */
#include "stdlib.h"     /* atoi .. */
#include "stdio.h"      /* sprintf */
#include "Unicodexdcl.h"        /* mmi_ucs2XXX */

#ifdef __J2ME__
#include "jam_msg_handler.h"
#endif 
#include "JavaAgencyGProt.h"
#include "JavaAgencyDef.h"

/* File system related header */
#include "fs_func.h"    /* FS_Open... */
#include "fs_type.h"    /* FS_HANDLE, FS_DIR_TYPE .. */
#include "fs_errcode.h" /* FS_PATH_NOT_FOUND */
#include "FileMgrSrvGProt.h"    /* SRV_FMGR_PUBLIC_DRV, srv_fmgr_async_XXX  */

#include "WAPProfileSrvType.h"
#include "WAPProfileSrvGProt.h"

/* Memory manager related Header */
#include "MMSMemoryManagerSrv.h"        /* srv_mms_mem_mgr_app_adm_alloc/free */
#include "mmi_frm_mem_gprot.h"  /* OslMfree, mmi_mfree */

/* XML Header file for Objects & attachment */
#include "MmsSrvGprot.h"        /* srv_mms_viewer_get_attachment_list, srv_mms_show_status_icon, EVT_ID_JSR_DELETE_MMS */
#include "MmsXMLDefSrv.h"

/* MMC related header files */
#include "mmc_struct.h"
#include "mma_api.h"    /* MODE, folder_id, storage type, get_box, Get_home_dir */
#include "mmi_msg_struct.h"     /* Upload, Read, Delete operation structure */
#include "mma_struct.h"
#include "mms_sap_struct.h"     /* MMA_APP_ID_JSR */
#include "mms_adp.h"    /* mms_get_service_module */

/* UM, UC related header files */
#include "UmSrvDefs.h"  /* srv_um_msg_box_enum, INBOX, OUTBOX... */
#include "UmSrvGprot.h" /* srv_um_check_ready */
#include "UmSrvStruct.h"        /* srv_um_refresh_ind_struct, msg_box_type */
#include "MmsSrvGprot.h"  /* srv_mms_if_is_mms_in_open_state */
#include "UcSrvGprot.h" /* srv_uc_is_mms_in_use */
#include "mmi_cb_mgr_gprot.h"   /* MMI_FRM_CB_EMIT_EVENT */

/* Catcher log related Header files */
#include "MMI_inet_app_trc.h"   /* MMI_INET_TRC_G6_MMS, MMI_JSR_XXXX */
#include "DebugInitDef_Int.h"   /* MMI_TRACE */
#include "kal_trace.h"  /* TRACE_GROUP_6, kal_trace */
#include "MMSBGSRSrvProt.h"

#define JSR_MAX_PROGRESS_STRING_LENGTH 100
/***************************************************************************** 
* Define
*****************************************************************************/

/***************************************************************************** 
* Typedef 
*****************************************************************************/
extern srv_um_msg_box_enum mmi_um_get_current_msg_box_type(void);
extern void srv_mms_bgsr_cancel_send_java_msg_req(U32 msg_id);

/***************************************************************************** 
* Local Variable
*****************************************************************************/

/***************************************************************************** 
* Local Function
*****************************************************************************/
#ifdef __MMI_UMMS_PST__
static mmc_result_enum srv_mms_jsr_write_folder_status_to_file(U32 no_of_message, JsrMessageInfo *list);
#endif

#ifdef __MMI_UMMS_JSR205__
static MMI_BOOL srv_mms_jsr_write_object_list_to_file(void);
static MMI_BOOL srv_mms_jsr_insert_appid_info_to_list(
                    jsr_appid_msgid_list **appid_object_list,
                    S8 *string,
                    jsr_msg_info *msg_list);
static MMI_BOOL srv_mms_jsr_remove_appid_info_from_list(jsr_appid_msgid_list **list, S8 *appId);
static MMI_BOOL srv_mms_jsr_remove_appid_info_from_list_recursive(jsr_appid_msgid_list **list);
static MMI_BOOL srv_mms_jsr_insert_msg_info_to_list(jsr_msg_info **msg_list, U32 msgId, U8 ischecked);
static MMI_BOOL srv_mms_jsr_remove_msg_info_from_list(jsr_msg_info **list, U32 msgId);
static MMI_BOOL srv_mms_jsr_remove_msg_info_from_list_recursive(jsr_msg_info **list);
static U32 srv_mms_jsr_get_digit_of_integer(U32 msgId);
static U32 srv_mms_jsr_get_current_size_of_object_list(
            jsr_appid_msgid_list *appid_object_list,
            U32 *max_chrs_in_line);
static void srv_mms_jsr_read_line_from_file(U32 filehandle, S8 *buffer, U32 buf_length, U32 *line_length, S32 *ret);
static MMI_BOOL srv_mms_jsr_check_appId(S8 *appId);
#endif

extern kal_bool mma_get_home_directory(kal_wchar *buffer, kal_uint32 buffer_size, U8 storage);
extern kal_bool mma_get_msg_file_name(kal_uint32 msg_id, kal_wchar *buffer, kal_uint32 buffer_size);
extern kal_uint32 wap_custom_get_max_mms_msg_size(void);
static mmi_ret srv_mms_jsr_file_copy_callback_proc(mmi_event_struct *msg);

/*****************************************************************************
* Global Variable
*****************************************************************************/

jsr_context_struct jsr_cntx;
jsr_context_struct *jsr_cntx_p = &jsr_cntx;

#ifdef __MMI_UMMS_JSR205__
jsr_appid_msgid_list *g_jsr_appid_object_list = NULL;
jsr_appid_info_struct *jsr_appid_db[JSR_MAX_APP_ID_NUM];    /* for registered apps */
#endif

/*****************************************************************************
* Global Function
*****************************************************************************/
extern mma_folder_enum mma_get_box(kal_uint32 msg_id);
#ifdef __MMI_UMMS_JSR205__
static int new_java_mms_dest_mod_id = MOD_J2ME;
#endif


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_init
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_init(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_UMMS_PST__
    SetProtocolEventHandler(srv_mms_jsr_read_folder_status_req_hldr, MSG_ID_WAP_MMC_READ_FOLDER_STATUS_REQ_IND);
    SetProtocolEventHandler(srv_mms_jsr_upload_msg_req_hldr, MSG_ID_WAP_MMC_UPLOAD_MSG_REQ_IND);
    SetProtocolEventHandler(srv_mms_jsr_delete_msg_req_hldr, MSG_ID_WAP_MMC_DELETE_MSG_REQ_IND);
    SetProtocolEventHandler(srv_mms_jsr_read_msg_path_req_hdlr, MSG_ID_WAP_MMC_READ_MSG_PATH_IND);
#endif  /* __MMI_UMMS_PST__ */ 

#ifdef __MMI_UMMS_JSR205__
    SetProtocolEventHandler((PsFuncPtr) srv_mms_jsr_send_appmms_req_hldr, MSG_ID_WAP_MMC_SEND_APPMMS_REQ);
    SetProtocolEventHandler(srv_mms_jsr_send_post_appmms_msg_part_rsp, MSG_ID_WAP_MMC_POST_APPMMS_MSG_PART_RES);
    SetProtocolEventHandler(srv_mms_jsr_receive_appmms_req_hldr, MSG_ID_WAP_MMC_RECV_APPMMS_REQ);
    SetProtocolEventHandler(srv_mms_jsr_read_appmms_msg_part_req, MSG_ID_WAP_MMC_READ_APPMMS_MSG_PART_REQ);

    SetProtocolEventHandler(srv_mms_jsr_cfg_appmms_appid_req, MSG_ID_WAP_MMC_CFG_APPMMS_APPID_REQ);
    SetProtocolEventHandler(srv_mms_jsr_check_appmms_coming_req, MSG_ID_WAP_MMC_CHECK_APPMMS_COMING_REQ);
    SetProtocolEventHandler(srv_mms_jsr_get_mms_profile_req, MSG_ID_WAP_MMC_GET_MMS_PROF_REQ);
    SetProtocolEventHandler(srv_mms_jsr_abort_appmms_req, MSG_ID_WAP_MMC_ABORT_APPMMS_REQ);

    mmi_frm_set_protocol_event_handler(
        MSG_ID_WAP_MMA_GET_CONTENT_RSP,
        (PsIntFuncPtr) srv_mms_jsr_get_msg_content_rsp,
        MMI_TRUE);
    mmi_frm_set_protocol_event_handler(
        MSG_ID_WAP_MMA_READY_IND,
        (PsIntFuncPtr) srv_mms_jsr_mma_ready_ind_hdlr,
        MMI_TRUE);
#endif /* __MMI_UMMS_JSR205__ */ 
    
#ifdef __MMI_UMMS_PST__
    mmi_frm_set_protocol_event_handler(
        MSG_ID_MMI_UM_GET_MSG_NUM_RSP,
        (PsIntFuncPtr) srv_mms_jsr_get_msg_num_rsp,
        MMI_TRUE);
    mmi_frm_set_protocol_event_handler(
        MSG_ID_MMI_UM_DELETE_FOLDER_RSP,
        (PsIntFuncPtr) srv_mms_jsr_delete_folder_rsp,
        MMI_TRUE);
    mmi_frm_set_protocol_event_handler(
        MSG_ID_WAP_MMA_GET_MSG_INFO_RSP,
        (PsIntFuncPtr) srv_mms_jsr_get_msg_info_rsp,
        MMI_TRUE);
    mmi_frm_set_protocol_event_handler(
        MSG_ID_WAP_MMA_GET_MSG_LIST_RSP,
        (PsIntFuncPtr) srv_mms_jsr_get_message_list_rsp,
        MMI_TRUE);
#endif  /* __MMI_UMMS_PST__ */
#if defined (__MMI_UMMS_PST__) || defined (__MMI_UMMS_JSR205__)
    mmi_frm_set_protocol_event_handler(
        MSG_ID_WAP_MMA_CREATE_RSP,
        (PsIntFuncPtr) srv_mms_jsr_create_mms_msg_rsp,
        MMI_TRUE);
    mmi_frm_set_protocol_event_handler(MSG_ID_WAP_MMA_DELETE_RSP, (PsIntFuncPtr) srv_mms_jsr_delete_msg_rsp, MMI_TRUE);
    mmi_frm_set_protocol_event_handler(
        MSG_ID_WAP_MMA_TERMINATE_IND,
        (PsIntFuncPtr) srv_mms_jsr_terminate_ind_handler,
        MMI_TRUE);
#endif
    SetProtocolEventHandler(srv_mms_jsr_get_active_mms_attachment_req, MSG_ID_MMS_GET_ACTIVE_MMS_ATTACHMENT_REQ);
    srv_mms_init_jsr_folder();
}


/*****************************************************************************
 * FUNCTION
 *  JsrCleanContext
 * DESCRIPTION
 *  Clear the JSR context information.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void JsrCleanContext(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (JSR_CNTX)
    {
        JSR_CNTX->op = 0;
        JSR_CNTX->state = 0;
        JSR_CNTX->msgId = 0;
        JSR_CNTX->curr_media_obj_no = 0;
        JSR_CNTX->total_media_obj_no = 0;
        JSR_CNTX->retrievalMode = 0;

        JSR_CNTX->folderId = 0xFFFF;
        JSR_CNTX->numofMsg = 0;
        JSR_CNTX->numofUnreadMsg = 0;
        JSR_CNTX->counter = 0;
        JSR_CNTX->is_abort_get_req = MMI_FALSE;
        JSR_CNTX->is_more_msg = MMI_FALSE;

        /* JSR_CNTX->msg_list = NULL; */
        if (JSR_CNTX->msgIDList)
        {
            srv_mms_mem_mgr_app_adm_free(JSR_CNTX->msgIDList);
            JSR_CNTX->msgIDList = NULL;
        }

        /* if (JSR_CNTX->msgInfolist)
           {
           srv_mms_mem_mgr_app_adm_alloc(JSR_CNTX->msgInfolist);
           JSR_CNTX->msgInfolist = NULL;
           } */

        JSR_CNTX->req_id = 0;

        JSR_CNTX->xml_file_size = 0;
        JSR_CNTX->buffer_index = 0;

        if (JSR_CNTX->file_handle)
        {
            FS_Close(JSR_CNTX->file_handle);
            JSR_CNTX->file_handle = 0;
        }
        /* if (JSR_CNTX->xml_file_handle)
           {
           FS_Close(JSR_CNTX->xml_file_handle);
           JSR_CNTX->xml_file_handle = 0;
           } */
        if (JSR_CNTX->object_file)
        {
            srv_mms_mem_mgr_app_adm_free(JSR_CNTX->object_file);
            JSR_CNTX->object_file = NULL;
        }
        if (JSR_CNTX->file_path)
        {
            srv_mms_mem_mgr_app_adm_free(JSR_CNTX->file_path);
            JSR_CNTX->file_path = NULL;
        }

    }
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_terminate_ind_handler
 * DESCRIPTION
 *  Invokes to handle terminate ind from MMA
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_terminate_ind_handler(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_UMMS_JSR205__
    srv_mms_jsr_mma_terminate_ind_hdlr();
#endif 
    srv_mms_jsr_terminate_req_handler();
    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_terminate_req_handler
 * DESCRIPTION
 *  Invokes to handle terminate req from MMA
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_terminate_req_handler(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (JSR_CNTX->state)
    {
        case JSR_STATE_IDLE:
            return;
    #ifdef __MMI_UMMS_PST__
        case JSR_STATE_READ_FOLDER:
            srv_mms_jsr_read_folder_status_output_req_hldr(MMC_RESULT_ERROR, NULL, JSR_CNTX->dest_mod_id);
            break;
        case JSR_STATE_UPLOAD_MSG:
            srv_mms_jsr_upload_msg_output_req_hldr(MMC_RESULT_ERROR, 0, JSR_CNTX->dest_mod_id);
            break;
        case JSR_STATE_DELETE_MSG:
            srv_mms_jsr_delete_msg_output_req_hldr(MMC_RESULT_ERROR, JSR_CNTX->dest_mod_id);
            break;
    #endif  /* __MMI_UMMS_PST__ */
    #ifdef __MMI_UMMS_JSR205__
            /* case JSR_STATE_CREATE_MSG: */
        case JSR_STATE_PROCESS_SEND_MSG_HDR:
        case JSR_STATE_PROCESS_SEND_MSG_BDY:
        case JSR_STATE_SEND_MSG:
            srv_mms_jsr_send_appmms_rsp(MMC_RESULT_ERROR, JSR_CNTX->dest_mod_id);
            break;
        case JSR_STATE_RECV_MSG_HDR:
        case JSR_STATE_RECV_MSG_BDY:
        {
            wap_mmc_recv_appmms_rsp_struct response;

            response.result = MMC_RESULT_ERROR;
            srv_mms_jsr_receive_appmms_rsp(&response, NULL, 0, JSR_CNTX->dest_mod_id);
            break;
        }
    #endif /* __MMI_UMMS_JSR205__ */ 
        default:
            break;
    }
    JsrCleanContext();
    srv_mms_init_jsr_folder();
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_convert_phsuite_folder_to_jsr_folder
 * DESCRIPTION
 *  Converts Phone Suite folder type to JSR folder type
 * PARAMETERS
 *  folder      [IN]        
 *  S32(?)(?)
 * RETURNS
 *  S32
 *****************************************************************************/
S32 srv_mms_jsr_convert_phsuite_folder_to_jsr_folder(S32 folder)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    JsrPhSuiteFolderType phsuite_folder = (JsrPhSuiteFolderType) folder;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (phsuite_folder)
    {
        case JSR_PHSUITE_NONE:
            return (S32) JSR_NONE;
        case JSR_PHSUITE_INBOX:
            return (S32) JSR_INBOX;
        case JSR_PHSUITE_OUTBOX:
            return (S32) JSR_OUTBOX;
        case JSR_PHSUITE_DRAFTS:
            return (S32) JSR_DRAFTS;
        case JSR_PHSUITE_SENT:
            return (S32) JSR_SENT;
        case JSR_PHSUITE_PREDEF_TEMPLATE:
            return (S32) JSR_PREDEF_TEMPLATE;
        default:
            return -1;
    }
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_convert_um_folder_to_jsr_folder
 * DESCRIPTION
 *  Converts UM folder type to JSR folder type
 * PARAMETERS
 *  folder      [IN]        
 *  S32(?)(?)
 * RETURNS
 *  S32
 *****************************************************************************/
S32 srv_mms_jsr_convert_um_folder_to_jsr_folder(S32 folder)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_um_msg_box_enum um_folder = (srv_um_msg_box_enum) folder;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (um_folder)
    {
        case SRV_UM_MSG_BOX_NONE:
            return (S32) JSR_NONE;
        case SRV_UM_MSG_BOX_INBOX:
            return (S32) JSR_INBOX;
        case SRV_UM_MSG_BOX_UNSENT:
            return (S32) JSR_OUTBOX;
        case SRV_UM_MSG_BOX_DRAFT:
            return (S32) JSR_DRAFTS;
        case SRV_UM_MSG_BOX_SENT:
            return (S32) JSR_SENT;
        case SRV_UM_MSG_BOX_PREDEF_TEMPLATES:
            return (S32) JSR_PREDEF_TEMPLATE;
        default:
            return -1;
    }
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_convert_jsr_folder_to_um_folder
 * DESCRIPTION
 *  Converts JSR folder type to UM folder type
 * PARAMETERS
 *  folder      [IN]        
 *  S32(?)(?)
 * RETURNS
 *  S32
 *****************************************************************************/
S32 srv_mms_jsr_convert_jsr_folder_to_um_folder(S32 folder)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    JsrFolderType jsr_folder = (JsrFolderType) folder;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (jsr_folder)
    {
        case JSR_NONE:
            return (S32) SRV_UM_MSG_BOX_NONE;
        case JSR_INBOX:
            return (S32) SRV_UM_MSG_BOX_INBOX;
        case JSR_OUTBOX:
            return (S32) SRV_UM_MSG_BOX_UNSENT;
        case JSR_DRAFTS:
            return (S32) SRV_UM_MSG_BOX_DRAFT;
        case JSR_SENT:
            return (S32) SRV_UM_MSG_BOX_SENT;
        case JSR_PREDEF_TEMPLATE:
            return (S32) SRV_UM_MSG_BOX_PREDEF_TEMPLATES;
        case JSR_USRDEF_TEMPLATE:
            return (S32) SRV_UM_MSG_BOX_USRDEF_TEMPLATES;
    #ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__
        case JSR_ARCHIVE:
            return (S32) SRV_UM_MSG_BOX_ARCHIVE;
    #endif /* __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__ */ 
        default:
            return -1;
    }
}

#ifdef __MMI_MMS_BGSR_SUPPORT__


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_convert_jsr_folder_to_bgsr_folder
 * DESCRIPTION
 *  Converts JSR folder type to BGSR folder type
 * PARAMETERS
 *  folder      [IN]        
 * RETURNS
 *  S32
 *****************************************************************************/
U32 srv_mms_jsr_convert_jsr_folder_to_bgsr_folder(U32 folder)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    JsrFolderType jsr_folder = (JsrFolderType) folder;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (jsr_folder)
    {
        case JSR_INBOX:
            return SRV_MMS_BGSR_FOLDER_INBOX;
        case JSR_OUTBOX:
            return SRV_MMS_BGSR_FOLDER_OUTBOX;
    #ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__
        case JSR_ARCHIVE:
            return SRV_MMS_BGSR_FOLDER_ARCHIVE;
    #endif /* __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__ */ 
        default:
            return SRV_MMS_BGSR_FOLDER_NONE;
    }
}
#endif /* __MMI_MMS_BGSR_SUPPORT__ */ 

/* AT COMMANDS API */

#ifdef __MMI_UMMS_PST__
/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_read_folder_status_req_hldr
 * DESCRIPTION
 *  Create a WAP_MMC_READ_FOLDER_STATUS_REQ_IND primitive to L4
 * PARAMETERS
 *  msg         [?]         [?]     [?]     [?]     [?]     Message received from L4
 *  mod_id      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_read_folder_status_req_hldr(void *msg, int mod_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mmc_read_folder_status_req_ind_struct *Message;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    Message = (wap_mmc_read_folder_status_req_ind_struct*) msg;

    Message->folderId = (U8) srv_mms_jsr_convert_phsuite_folder_to_jsr_folder((S32) Message->folderId);

    if (MMI_FALSE == srv_um_check_ready())
    {
        srv_mms_jsr_read_folder_status_output_req_hldr(MMC_RESULT_MMS_NO_READY, NULL, mod_id);
        return;
    }

    if (JSR_CNTX->state == JSR_STATE_IDLE)
    {
        JsrCleanContext();  /* clean context first */
        JSR_CNTX->dest_mod_id = mod_id;

        if (    /* check for valid folder ID */
               (Message->folderId == JSR_INBOX)
               || (Message->folderId == JSR_OUTBOX)
               || (Message->folderId == JSR_SENT)
               || (Message->folderId == JSR_DRAFTS)
               || (Message->folderId == JSR_PREDEF_TEMPLATE)
               || (Message->folderId == JSR_USRDEF_TEMPLATE) || (Message->folderId == JSR_ARCHIVE))
        {
            if ((Message->retrievalMode == JSR_BASIC_PHONE) || (Message->retrievalMode == JSR_FULL_PHONE) ||
                (Message->retrievalMode == JSR_BASIC_CARD) || (Message->retrievalMode == JSR_FULL_CARD))
            {
                JSR_CNTX->state = JSR_STATE_READ_FOLDER;
                JSR_CNTX->op = JSR_OP_READ_MSG;
                JSR_CNTX->retrievalMode = Message->retrievalMode;
                JSR_CNTX->folderId = Message->folderId; /* update folder ID */

                /* get message ID list, message info, inbox message number */
                JSR_CNTX->req_id = mma_get_request_id();    /* get request ID here as msg list can be multiple */
                srv_mms_jsr_get_msg_list_req();
            }
            else
            {   /* wrong retrevial mode */
                srv_mms_jsr_read_folder_status_output_req_hldr(MMC_RESULT_INVALID_PARAMETER, NULL, mod_id);
            }
        }
        else
        {   /* wrong folder ID */
            srv_mms_jsr_read_folder_status_output_req_hldr(MMC_RESULT_INVALID_PARAMETER, NULL, mod_id);
        }
    }
    else
    {   /* JSR Moduel is busy in processing other commands */
        srv_mms_jsr_read_folder_status_output_req_hldr(MMC_RESULT_BUSY, NULL, mod_id);
    }
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_get_msg_list_req
 * DESCRIPTION
 *  Create a MSG_ID_WAP_MMA_GET_MSG_LSIT_REQ primitive to MMA
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_get_msg_list_req(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mma_get_msg_list_req_struct *msglist;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    msglist = (wap_mma_get_msg_list_req_struct*) OslConstructDataPtr(sizeof(*msglist));

    msglist->app_id = MMA_APP_ID_JSR;
    msglist->req_id = JSR_CNTX->req_id; /* mma_get_request_id(); */
    msglist->folder = JSR_CNTX->folderId;
    if ((JSR_CNTX->retrievalMode == JSR_BASIC_PHONE) || (JSR_CNTX->retrievalMode == JSR_FULL_PHONE))
    {
        msglist->storage = MMA_MSG_STORAGE_PHONE;
    }
    else if ((JSR_CNTX->retrievalMode == JSR_BASIC_CARD) || (JSR_CNTX->retrievalMode == JSR_FULL_CARD))
    {
        msglist->storage = MMA_MSG_STORAGE_CARD1;
    }

    srv_mms_jsr_post_message(
        /* send request for message list */ MOD_MMI,
        mms_get_service_module(MSG_ID_WAP_MMA_GET_MSG_LIST_REQ),
        0,
        MSG_ID_WAP_MMA_GET_MSG_LIST_REQ,
        (oslParaType*) msglist,
        NULL);
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_get_message_list_rsp
 * DESCRIPTION
 *  Decode MSG_ID_WAP_MMA_GET_MSG_LIST_RSP primitive from MMA
 *  Will come in two states
 *  - Read Folder to get all message list to get the message info
 *  - Delete folder to check if the message id requested is from default templates or not
 * PARAMETERS
 *  msgRsp      [?]     [?]     [?]     [?]
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_get_message_list_rsp(void *msgRsp)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 ifst = 0;
    U32 jnxt = 0;
    mmc_result_enum result;

    wap_mma_get_msg_list_rsp_struct *msgList = (wap_mma_get_msg_list_rsp_struct*) msgRsp;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (msgList->app_id == MMA_APP_ID_JSR)
    {
        if (JSR_CNTX->state == JSR_STATE_READ_FOLDER)
        {   /* if state is get folder message info */

            if (msgList->result != MMC_RESULT_OK)
            {   /* if not Ok then send error result */
                srv_mms_jsr_read_folder_status_output_req_hldr(MMC_RESULT_INVALID_FOLDER, NULL, JSR_CNTX->dest_mod_id);
                return MMI_TRUE;
            }

            if (JSR_CNTX->msgIDList == NULL)
            {   /* allocate memory first time only */

                JSR_CNTX->numofMsg = msgList->no_of_msg;

                if (JSR_CNTX->numofMsg == 0)
                {
                    result = srv_mms_jsr_write_folder_status_to_file(JSR_CNTX->numofMsg, JSR_CNTX->msgInfolist);

                    if (result != MMC_RESULT_OK)
                    {   /* problem in writing folder info in file */
                        srv_mms_jsr_read_folder_status_output_req_hldr(result, NULL, JSR_CNTX->dest_mod_id);
                        return MMI_TRUE;
                    }
                    /* send folder info resp */
                    srv_mms_jsr_fill_folder_info_output_req();
                    return MMI_TRUE;
                }

                /* allocate memory for message ID list */
                JSR_CNTX->msgIDList = (U32*) srv_mms_mem_mgr_app_adm_alloc(sizeof(U32) * (msgList->no_of_msg));
                if (JSR_CNTX->msgIDList == NULL)
                {
                    srv_mms_jsr_read_folder_status_output_req_hldr(
                        MMC_RESULT_INSUFFICIENT_MEMORY,
                        NULL,
                        JSR_CNTX->dest_mod_id);
                    return MMI_TRUE;
                }

                memset(JSR_CNTX->msgIDList, 0, ((msgList->no_of_msg) * sizeof(U32)));

                ifst = 0;
                jnxt = 0;

                while (msgList->msg_id[jnxt] != 0)
                {   /* start copying the msgId */
                    JSR_CNTX->msgIDList[ifst] = msgList->msg_id[jnxt];
                    ifst++;
                    jnxt++;
                    if (jnxt == msgList->no_of_msg)
                    {
                        break;
                    }
                }

                /* allocate memory for message info list */
                if (JSR_CNTX->msgInfolist == NULL)
                {
                    srv_mms_jsr_read_folder_status_output_req_hldr(
                        MMC_RESULT_INSUFFICIENT_MEMORY,
                        NULL,
                        JSR_CNTX->dest_mod_id);
                    return MMI_TRUE;
                }
                memset(JSR_CNTX->msgInfolist, 0, 10 * sizeof(JsrMessageInfo));
            }
            else
            {   /* coming here for succesive message list responses > 399 */
                ifst = 0;
                jnxt = 0;

                while (JSR_CNTX->msgIDList[ifst] != 0)
                {
                    ifst++; /* reach to the end of the list */
                }

                while (msgList->msg_id[jnxt] != 0)
                {   /* start copying the msgId at the end of the list */
                    JSR_CNTX->msgIDList[ifst] = msgList->msg_id[jnxt];
                    ifst++;
                    jnxt++;
                    if (jnxt == msgList->no_of_msg)
                    {
                        break;
                    }
                }
            }

            if (msgList->more)
            {
                srv_mms_jsr_get_msg_list_req(); /* more msg ID list send req again */
            }
            else
            {
                srv_mms_jsr_get_msg_info_req(); /* get message info based on message ID one by one */
            }
            return MMI_TRUE;
        }
        else    /* should not come here */
        {
            /* MAUI_01361475: case when the Terminate ind is send by MOD_MMS. After sending the Terminate_IND 
               primitive, it can send other primitive to MMI before finally get terminated. */
            /* No need to do anything, as already the response is send in the terminate function. */
            return MMI_TRUE;
        }
    }
    else
    {
        return MMI_FALSE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_get_msg_info_req
 * DESCRIPTION
 *  Send MSG_ID_WAP_MMA_GET_MSG_INFO_REQ primitive to MMA
 * PARAMETERS
 *  void
 *  Global counter of message ID list(?)(?)(?)(?)
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_get_msg_info_req()
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mma_get_msg_info_req_struct *msgInfo;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    msgInfo = (wap_mma_get_msg_info_req_struct*) OslConstructDataPtr(sizeof(*msgInfo));

    msgInfo->app_id = MMA_APP_ID_JSR;
    msgInfo->req_id = mma_get_request_id();
    msgInfo->msg_id = JSR_CNTX->msgIDList[JSR_CNTX->counter];
    /* send req for message info */
    srv_mms_jsr_post_message(
        MOD_MMI,
        mms_get_service_module(MSG_ID_WAP_MMA_GET_MSG_INFO_REQ),
        0,
        MSG_ID_WAP_MMA_GET_MSG_INFO_REQ,
        (oslParaType*) msgInfo,
        NULL);
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_get_msg_info_rsp
 * DESCRIPTION
 *  Decode MSG_ID_WAP_MMA_GET_MSG_INFO_RSP primitive from MMA
 * PARAMETERS
 *  msgRsp      [?]     [?]     [?]     [?]     [?]
 *  msg RSP(?)(?)(?)(?)(?)
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_get_msg_info_rsp(void *msgRsp)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    JsrMessageInfo JsrMsgInfo;
    mmc_result_enum result;
    U8 hfile[JSR_FILENAME_LEN];

    wap_mma_get_msg_info_rsp_struct *msgInfo = (wap_mma_get_msg_info_rsp_struct*) msgRsp;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (msgInfo->app_id == MMA_APP_ID_JSR)
    {
        if (JSR_CNTX->state == JSR_STATE_READ_FOLDER)
        {
            memset(&JsrMsgInfo, 0, sizeof(JsrMessageInfo));
            JsrMsgInfo.msgId = JSR_CNTX->msgIDList[JSR_CNTX->counter];
            JsrMsgInfo.offset = 0;
            JsrMsgInfo.size = msgInfo->msg_size;
            JsrMsgInfo.date = msgInfo->date;

            mma_get_msg_file_name(JsrMsgInfo.msgId, (kal_wchar*) & hfile, JSR_FILENAME_LEN);
            mmi_ucs2_n_to_asc((S8*) JsrMsgInfo.filename, (S8*) & hfile, JSR_FILENAME_LEN * ENCODING_LENGTH);

            if ((JSR_CNTX->retrievalMode == JSR_FULL_PHONE) || (JSR_CNTX->retrievalMode == JSR_FULL_CARD))
            {
                /* write address and subject only when retrieval mode is JSR_FULL */
                mmi_chset_ucs2_to_utf8_string((U8*) JsrMsgInfo.address, JSR_ADDR_LEN, (U8*) msgInfo->from_address);
                mmi_chset_ucs2_to_utf8_string((U8*) JsrMsgInfo.subject, JSR_SUBJECT_LEN, (U8*) msgInfo->subject);
            }

            memcpy(&JSR_CNTX->msgInfolist[JSR_CNTX->counter % 10], &JsrMsgInfo, sizeof(JsrMsgInfo));

            JSR_CNTX->counter++;    /* increment the counter now to point to mext ID */

            if ((JSR_CNTX->counter % 10 == 0))
            {
                result = srv_mms_jsr_write_folder_status_to_file(10, JSR_CNTX->msgInfolist);

                if (result != MMC_RESULT_OK)
                {
                    /* problem in writing folder info in file */
                    srv_mms_jsr_read_folder_status_output_req_hldr(result, NULL, JSR_CNTX->dest_mod_id);
                    return MMI_TRUE;
                }
                memset(JSR_CNTX->msgInfolist, 0, 10 * sizeof(JsrMessageInfo));
            }

            if (JSR_CNTX->counter < JSR_CNTX->numofMsg)
                /* check if we have got message info of all the message ID's */
            {
                srv_mms_jsr_get_msg_info_req();
            }
            else
            {   /* YES: we have got message info of all the Messages */
                if (((JSR_CNTX->counter % 10) != 0))
                {
                    result = srv_mms_jsr_write_folder_status_to_file(JSR_CNTX->counter % 10, JSR_CNTX->msgInfolist);

                    if (result != MMC_RESULT_OK)
                    {   /* problem in writing folder info in file */
                        srv_mms_jsr_read_folder_status_output_req_hldr(result, NULL, JSR_CNTX->dest_mod_id);
                        return MMI_TRUE;
                    }
                }
                /* folder info properly created */
                if (JSR_CNTX->folderId == JSR_INBOX)
                    /* if its inbox get no. of unread msg */
                {
                    srv_mms_jsr_get_msg_num_req();
                }
                else
                    /* send folder info resp */
                {
                    srv_mms_jsr_fill_folder_info_output_req();
                }
            }
        }
        /* No need to check for the else case. While get the Terminate ind, response is already sent */
        return MMI_TRUE;
    }
    else
    {
        return MMI_FALSE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_get_msg_num_req
 * DESCRIPTION
 *  Send MSG_ID_MMI_UM_GET_MSG_NUM_REQ primitive to UM
 * PARAMETERS
 *  void
 *  folder ID(?)(?)(?)(?)
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_get_msg_num_req(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_um_get_msg_num_req_struct *msgReq;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    msgReq = (srv_um_get_msg_num_req_struct*) OslConstructDataPtr(sizeof(*msgReq));
    msgReq->app_id = MMA_APP_ID_JSR;
    msgReq->msg_type = SRV_UM_MSG_MMS;
    srv_mms_jsr_post_message(
        MOD_MMI,
        mms_get_service_module(MSG_ID_MMI_UM_GET_MSG_NUM_REQ),
        0,
        MSG_ID_MMI_UM_GET_MSG_NUM_REQ,
        (oslParaType*) msgReq,
        NULL);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_get_msg_num_rsp
 * DESCRIPTION
 *  Decode MSG_ID_MMI_UM_GET_MSG_NUM_RSP primitive from UM
 * PARAMETERS
 *  msgRsp      [?]     [?]     [?]     [?]     [?]
 *  finMsg(?)(?)(?)(?)(?)
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_get_msg_num_rsp(void *msgRsp)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_um_get_msg_num_rsp_struct *msgNum = (srv_um_get_msg_num_rsp_struct*) msgRsp;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (msgNum->app_id == MMA_APP_ID_JSR)
    {
        if (JSR_CNTX->state == JSR_STATE_READ_FOLDER)
        {
            if (msgNum->result != KAL_TRUE)
            {
                srv_mms_jsr_read_folder_status_output_req_hldr(MMC_RESULT_INVALID_FOLDER, NULL, JSR_CNTX->dest_mod_id);
                return MMI_TRUE;
            }

            switch (JSR_CNTX->folderId)
            {
                case JSR_INBOX:
                    JSR_CNTX->numofUnreadMsg = msgNum->inbox_unread_msg_number;
                    break;
            #if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
            #endif /* 0 */ 
                default:
                {
                    srv_mms_jsr_read_folder_status_output_req_hldr(
                        MMC_RESULT_INVALID_FOLDER,
                        NULL,
                        JSR_CNTX->dest_mod_id);
                    return MMI_TRUE;
                }
            }
            /* got no.of unread message and hence send folder info */
            srv_mms_jsr_fill_folder_info_output_req();
        }
        return MMI_TRUE;
    }
    else
    {
        return MMI_FALSE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_write_folder_status_to_file
 * DESCRIPTION
 *  Write mms folder status to information file
 * PARAMETERS
 *  no_of_msgs      [IN]        Number of messages
 *  list            [?]         [?]         [?]         [?]         [?]         [?]         List of messages
 * RETURNS
 *  mmc_result_enum
 *****************************************************************************/
mmc_result_enum srv_mms_jsr_write_folder_status_to_file(U32 no_of_msgs, JsrMessageInfo *list)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    /* U32 msg_no = 0; */
    U32 info_file_size = 0;
    mmc_result_enum result = MMC_RESULT_ERROR;
    int fs_ret = 0;
    U32 bytes_written = 0;
    U8 pInFilename[JSR_FILENAME_LEN_MMA];
    FS_HANDLE fh = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(pInFilename, 0, JSR_FILENAME_LEN_MMA);
    MAKE_JSR_INFO_FILE(pInFilename);
    /* Writing file for the first chunk of information, remove old file */
    if (JSR_CNTX->counter < 11)
    {
        FS_Delete((U16*) pInFilename);
    }

    if (no_of_msgs == 0)
    {   /* if no message then don't write anything in file and return */
        result = MMC_RESULT_OK;
        goto END;
    }

    fh = FS_Open((U16*) pInFilename, FS_CREATE | FS_READ_WRITE);
    if (fh < 0)
    {
        MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_FS_OPEN_ERROR, __LINE__, fh);
        if (fh == FS_PATH_NOT_FOUND)    /* FS_PATH_NOT_FOUND -19 */
        {
            U8 folder_path[MMA_MAX_INTERNAL_FILENAME_LENGTH];

            /* create the folder */
            memset(folder_path, 0, MMA_MAX_INTERNAL_FILENAME_LENGTH);
            SRV_MMS_MAKE_JSR_FOLDER_PATH(folder_path);
            if ((fh = FS_CreateDir((WCHAR*) folder_path)) < 0)
            {
                MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_FS_OPEN_ERROR, __LINE__, fh);
                result = MMC_RESULT_FILE_OPERATION_ERROR;
                goto END;
            }
            FS_SetAttributes((unsigned short*)folder_path, FS_ATTR_DIR | FS_ATTR_HIDDEN);
            fh = FS_Open((U16*) pInFilename, FS_CREATE | FS_READ_WRITE);
            if (fh < 0)
            {
                MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_FS_OPEN_ERROR, __LINE__, fh);
                result = MMC_RESULT_FILE_OPERATION_ERROR;
                goto END;
            }
        }
        else
        {
            result = MMC_RESULT_FILE_OPERATION_ERROR;
            goto END;
        }
    }
    FS_Seek(fh, 0, FS_FILE_END);

    info_file_size = no_of_msgs * sizeof(JsrMessageInfo);

    fs_ret = FS_Write(fh, list, info_file_size, &bytes_written);
    if (fs_ret < 0)
    {
        MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_FS_WRITE_ERROR, __LINE__, fs_ret);
        if (bytes_written != info_file_size)
        {
            FS_Delete((U16*) pInFilename);
            result = MMC_RESULT_FILE_OPERATION_ERROR;
            goto END;
        }
    }

    MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_WRITE_FOLDER_INFO_FILE, __LINE__);

    result = MMC_RESULT_OK;

  END:

    if (fh != 0)
    {
        FS_Close(fh);
    }
    return result;
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_fill_folder_info_output_req
 * DESCRIPTION
 *  Fill up folder info from JST COntext global structure
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_fill_folder_info_output_req()
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    JsrFolderInfo *folderInfo = NULL;
    U8 pInFilename[JSR_FILENAME_LEN_MMA];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    folderInfo = (JsrFolderInfo*) srv_mms_mem_mgr_app_adm_alloc(sizeof(JsrFolderInfo));
    if (folderInfo == NULL)
    {
        srv_mms_jsr_read_folder_status_output_req_hldr(MMC_RESULT_INSUFFICIENT_MEMORY, NULL, JSR_CNTX->dest_mod_id);
        return;
    }

    memset(folderInfo, 0, sizeof(JsrFolderInfo));

    memset(pInFilename, 0, JSR_FILENAME_LEN_MMA);
    MAKE_JSR_INFO_FILE(pInFilename);

    mmi_ucs2ncpy((S8*) folderInfo->infoFilePath, (S8*) pInFilename, JSR_FILENAME_LEN_MMA / 2);

    folderInfo->numOfMsg = JSR_CNTX->numofMsg;
    folderInfo->numOfUnreadMsg = JSR_CNTX->numofUnreadMsg;

    if ((JSR_CNTX->retrievalMode == JSR_BASIC_PHONE) || (JSR_CNTX->retrievalMode == JSR_FULL_PHONE))
    {
        mma_get_home_directory((kal_wchar*) folderInfo->mmsHomeDirectory, JSR_FILENAME_LEN_MMA, MMA_MSG_STORAGE_PHONE);
    }
    else if ((JSR_CNTX->retrievalMode == JSR_BASIC_CARD) || (JSR_CNTX->retrievalMode == JSR_FULL_CARD))
    {
        mma_get_home_directory((kal_wchar*) folderInfo->mmsHomeDirectory, JSR_FILENAME_LEN_MMA, MMA_MSG_STORAGE_CARD1);
    }

    srv_mms_jsr_read_folder_status_output_req_hldr(MMC_RESULT_OK, folderInfo, JSR_CNTX->dest_mod_id);
    srv_mms_mem_mgr_app_adm_free(folderInfo);
    return;
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_read_folder_status_output_req_hldr
 * DESCRIPTION
 *  Create a WAP_MMC_READ_FOLDER_STATUS_OUTPUT_REQ primitive to L4
 * PARAMETERS
 *  result          [IN]        
 *  folderInfo      [?]         [?]         [?]         [?]         [?]         [?]
 *  mod_id          [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_read_folder_status_output_req_hldr(mmc_result_enum result, JsrFolderInfo *folderInfo, int mod_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mmc_read_folder_status_output_req_struct *myMsgPtr;
    ilm_struct *ilm_ptr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    myMsgPtr = (wap_mmc_read_folder_status_output_req_struct*)
        OslConstructDataPtr(sizeof(wap_mmc_read_folder_status_output_req_struct));

    if (myMsgPtr)
    {
        memset((char*)(myMsgPtr) + 4, 0x00, (sizeof(wap_mmc_read_folder_status_output_req_struct) - 4));
        myMsgPtr->result = (U8) result;
        if (folderInfo)
        {
            myMsgPtr->numOfMsg = folderInfo->numOfMsg;
            myMsgPtr->numOfUnreadMsg = folderInfo->numOfUnreadMsg;

            memset(myMsgPtr->mmsHomeDirectory, 0x00, JSR_FILENAME_LEN_MMA);
            memset(myMsgPtr->infoFilePath, 0x00, JSR_FILENAME_LEN_MMA);

            memcpy(
                myMsgPtr->mmsHomeDirectory,
                folderInfo->mmsHomeDirectory,
                (mmi_ucs2strlen((char*)folderInfo->mmsHomeDirectory) * ENCODING_LENGTH));
            memcpy(
                myMsgPtr->infoFilePath,
                folderInfo->infoFilePath,
                (mmi_ucs2strlen((char*)folderInfo->infoFilePath) * ENCODING_LENGTH));
        }

        ilm_ptr = allocate_ilm(MOD_MMI);

        ilm_ptr->src_mod_id = MOD_MMI;
        ilm_ptr->sap_id = MMI_L4C_SAP;
        ilm_ptr->dest_mod_id = (module_type)mod_id;
        ilm_ptr->local_para_ptr = (local_para_struct*) myMsgPtr;
        ilm_ptr->msg_id = MSG_ID_WAP_MMC_READ_FOLDER_STATUS_OUTPUT_REQ;
        ilm_ptr->peer_buff_ptr = NULL;

        msg_send_ext_queue(ilm_ptr);

        if (result != MMC_RESULT_BUSY)
        {
            JsrCleanContext();
        }

    }
    else
    {
        MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_FOLDER_REQ_HDLR, __LINE__);

        ASSERT(0);
    }
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_upload_msg_req_hldr
 * DESCRIPTION
 *  Create a MSG_ID_WAP_MMC_UPLOAD_MSG_REQ_IND primitive to L4
 * PARAMETERS
 *  msg         [?]         [?]     [?]     [?]     [?]     [?]
 *  mod_id      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_upload_msg_req_hldr(void *msg, int mod_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mmc_upload_msg_req_ind_struct *Message;
    int len = 0;
    S32 handle = -1;
    U32 size;
    U8 ret;

    /* kal_wchar *fname = NULL; */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    Message = (wap_mmc_upload_msg_req_ind_struct*) msg;

    if (MMI_FALSE == srv_um_check_ready())
    {
        srv_mms_jsr_upload_msg_output_req_hldr(MMC_RESULT_MMS_NO_READY, 0, mod_id);
        return;
    }
    handle = FS_Open((WCHAR*) Message->filePath, FS_READ_ONLY | FS_OPEN_SHARED);

    if (handle < 0)
    {
        MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_FS_OPEN_ERROR, __LINE__, handle);
        srv_mms_jsr_upload_msg_output_req_hldr(MMC_RESULT_FILE_OPERATION_ERROR, 0, mod_id);
        return;
    }

    ret = (U8) FS_GetFileSize(handle, &size);
    if (ret != MMC_RESULT_OK)
    {
        srv_mms_jsr_upload_msg_output_req_hldr(MMC_RESULT_FILE_OPERATION_ERROR, 0, mod_id);
        FS_Close(handle);
        return;
    }
    if (size > (U32) wap_custom_get_max_mms_msg_size())
    {
        srv_mms_jsr_upload_msg_output_req_hldr(MMC_RESULT_EXCEED_MAX_MSGS, 0, mod_id);
        FS_Close(handle);
        return;
    }

    FS_Close(handle);

    /* Check the MMS folder for Max messages. */

    if (JSR_CNTX->state == JSR_STATE_IDLE)
    {
        JsrCleanContext();  /* clean context first */
        JSR_CNTX->op = JSR_OP_UPLOAD_MSG;
        JSR_CNTX->state = JSR_STATE_UPLOAD_MSG;
        JSR_CNTX->dest_mod_id = mod_id;

        if (((U16*) Message->filePath)[0])
        {
            len = mmi_charset_ucs2_to_utf8_length_in_bytes(Message->filePath);

            if (len < JSR_FILENAME_LEN_MMA * sizeof(kal_wchar))
            {
                srv_mms_jsr_create_mms_msg_req((kal_wchar*) Message->filePath);        /* create message */
            }
            else
            {
                /* File path too long. */
                srv_mms_jsr_upload_msg_output_req_hldr(MMC_RESULT_INVALID_PARAMETER, 0, mod_id);
            }
        }
        else
        {
            srv_mms_jsr_upload_msg_output_req_hldr(MMC_RESULT_INVALID_MESSAGE, 0, mod_id);
        }
    }
    else
    {
        srv_mms_jsr_upload_msg_output_req_hldr(MMC_RESULT_BUSY, 0, mod_id);
    }
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_create_mms_msg_req
 * DESCRIPTION
 *  Create a MMS message with file path as specified and save the same in outbox
 * PARAMETERS
 *  fname       [?]     [?]     [?]     [?]     [?]
 *  msg     [?](?)(?)(?)(?)(?)
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_create_mms_msg_req(kal_wchar *fname)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mma_create_req_struct *msg_req;

    /* peer_buff_struct *peer_buff_ptr; */
    /* U32 read_size; */
    /* U16 peer_buff_len = 0; */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    msg_req = (wap_mma_create_req_struct*) OslConstructDataPtr(sizeof(wap_mma_create_req_struct));
    msg_req->req_id = mma_get_request_id();

    /* reset */
    msg_req->mode = MMA_MODE_UPLOAD;
    msg_req->msg_id = 0;
    msg_req->app_id = MMA_APP_ID_JSR;

    msg_req->buffer_index = 0;
    msg_req->xml_size = 0;
    msg_req->more = MMI_FALSE;

    mmi_ucs2cpy((S8*) msg_req->msg_file_path, (S8*) fname);

    /*    peer_buff_ptr = construct_peer_buff((kal_uint16) msg_req->buffer_size, 0, 0, TD_CTRL); */

    srv_mms_jsr_post_message(
        MOD_MMI,
        mms_get_service_module(MSG_ID_WAP_MMA_CREATE_REQ),
        0,
        MSG_ID_WAP_MMA_CREATE_REQ,
        (oslParaType*) msg_req,
        NULL);
    return;
}
#endif  /* __MMI_UMMS_PST__ */

#if defined (__MMI_UMMS_PST__) || defined (__MMI_UMMS_JSR205__)
/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_create_mms_msg_rsp
 * DESCRIPTION
 *  Create a MMS message rsp with file path as specified and save the same in outbox
 *  Come in two states
 *  - Upload Message
 *  - Send MMS ...before sending will create MMS
 * PARAMETERS
 *  inMsg       [?]     [?]     [?]     [?]     [?]
 *  msg     [?](?)(?)(?)(?)(?)
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_create_mms_msg_rsp(void *inMsg)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mma_create_rsp_struct *msg_rsp = (wap_mma_create_rsp_struct*) inMsg;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (msg_rsp->app_id == MMA_APP_ID_JSR)
    {
        if (JSR_CNTX->state == JSR_STATE_UPLOAD_MSG)
        {
            if (msg_rsp->result != MMC_RESULT_OK)
            {
                srv_mms_jsr_upload_msg_output_req_hldr(
                    MMC_RESULT_ERROR_MSG_CORRUPTED,
                    msg_rsp->msg_id,
                    JSR_CNTX->dest_mod_id);
            }
            else
            {
                JSR_CNTX->msg_storage = msg_rsp->storage;
                srv_mms_jsr_upload_msg_output_req_hldr((mmc_result_enum)(msg_rsp->result), msg_rsp->msg_id, JSR_CNTX->dest_mod_id);
                srv_mms_show_status_icon();
            }
        }
    #ifdef __MMI_UMMS_JSR205__
        else if ((JSR_CNTX->state == JSR_STATE_PROCESS_SEND_MSG_BDY) ||
                 (JSR_CNTX->state == JSR_STATE_PROCESS_SEND_MSG_HDR))
        {
            srv_mms_jsr_create_for_send_mms_rsp(msg_rsp);
        }
    #endif /* __MMI_UMMS_JSR205__ */ /* #ifdef __MMI_UMMS_JSR205__ */
        return MMI_TRUE;
    }
    else
    {
        return MMI_FALSE;
    }
}
#endif

#ifdef __MMI_UMMS_PST__
/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_upload_msg_output_req_hldr
 * DESCRIPTION
 *  Create a MSG_ID_WAP_MMC_UPLOAD_MSG_OUTPUT_REQ primitive to L4
 * PARAMETERS
 *  result      [IN]        
 *  msgId       [IN]        
 *  mod_id      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_upload_msg_output_req_hldr(mmc_result_enum result, U32 msgId, int mod_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mmc_upload_msg_output_req_struct *myMsgPtr;
    ilm_struct *ilm_ptr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    myMsgPtr = (wap_mmc_upload_msg_output_req_struct*)
        OslConstructDataPtr(sizeof(wap_mmc_upload_msg_output_req_struct));
    if (myMsgPtr)
    {
        memset((char*)(myMsgPtr) + 4, 0x00, (sizeof(wap_mmc_upload_msg_output_req_struct) - 4));
        myMsgPtr->result = (U8) result;
        myMsgPtr->msgId = msgId;
        myMsgPtr->storage = JSR_CNTX->msg_storage;

        ilm_ptr = allocate_ilm(MOD_MMI);

        ilm_ptr->src_mod_id = MOD_MMI;
        ilm_ptr->sap_id = MMI_L4C_SAP;
        ilm_ptr->dest_mod_id = (module_type)mod_id;
        ilm_ptr->local_para_ptr = (local_para_struct*) myMsgPtr;
        ilm_ptr->msg_id = MSG_ID_WAP_MMC_UPLOAD_MSG_OUTPUT_REQ;
        ilm_ptr->peer_buff_ptr = NULL;

        msg_send_ext_queue(ilm_ptr);

        if (result != MMC_RESULT_BUSY)
        {
            if (result == MMC_RESULT_OK)
            {
                /* Refresh the MMS folder menu screen. */
                /* amit to check mmi_um_jmms_highlight_mms_message_ind */
                srv_mms_jsr_um_refresh_ind(JSR_DRAFTS, msgId, (U8) SRV_UM_REFRESH_CREATE_MSG);  /* new message will always created in draft folder */
            }
            JsrCleanContext();
        }

    }
    else
    {
        MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_UPLOAD_REQ_HDLR, __LINE__);
        ASSERT(0);
    }
}
#endif  /* __MMI_UMMS_PST__ */

#if defined (__MMI_UMMS_PST__) || defined (__MMI_UMMS_JSR205__)
/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_um_refresh_ind
 * DESCRIPTION
 *  Send refresh Ind to UM
 * PARAMETERS
 *  folderID            [IN]        
 *  msg_id              [IN]        
 *  refresh_type        [IN]        
 *  msgId(?)        [IN](?)(?)(?)(?)
 *  result(?)       [IN](?)(?)(?)(?)
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_um_refresh_ind(U32 folderID, U32 msg_id, U8 refresh_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    /* ilm_struct *ilm_ptr = NULL; */
    srv_um_refresh_ind_struct *um_refresh_ind = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    um_refresh_ind =
        (srv_um_refresh_ind_struct*) construct_local_para((kal_uint16) sizeof(srv_um_refresh_ind_struct), 0);
    um_refresh_ind->msg_type = SRV_UM_MSG_MMS;
    um_refresh_ind->msg_box_type = (srv_um_msg_box_enum) srv_mms_jsr_convert_jsr_folder_to_um_folder(folderID);
    um_refresh_ind->refresh_type = (srv_um_refresh_enum) refresh_type;
    um_refresh_ind->msg_id = msg_id;

    srv_mms_jsr_post_message(MOD_MMI, MOD_MMI, 0, MSG_ID_MMI_UM_REFRESH_IND, (oslParaType*) um_refresh_ind, NULL);

    return;
}
#endif

#ifdef __MMI_UMMS_PST__
/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_delete_msg_send_event
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 *  mms_ready(?)
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_delete_msg_send_event(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_event_struct event_data;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_FRM_INIT_EVENT(&event_data, EVT_ID_JSR_DELETE_MMS);
    MMI_FRM_CB_EMIT_EVENT(&event_data);
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_delete_msg_req_hldr
 * DESCRIPTION
 *  Create a MSG_ID_WAP_MMC_DELETE_MSG_REQ_IND primitive to L4
 * PARAMETERS
 *  msg         [?]         [?]     [?]     [?]     [?]     [?]
 *  mod_id      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_delete_msg_req_hldr(void *msg, int mod_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mmc_delete_msg_req_ind_struct *Message;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    Message = (wap_mmc_delete_msg_req_ind_struct*) msg;

    Message->folderId = (U8) srv_mms_jsr_convert_phsuite_folder_to_jsr_folder((S32) Message->folderId);

    if (MMI_FALSE == srv_um_check_ready())
    {
        srv_mms_jsr_delete_msg_output_req_hldr(MMC_RESULT_MMS_NO_READY, mod_id);
        return;
    }

    if (JSR_CNTX->state == JSR_STATE_IDLE)
    {
        JsrCleanContext();  /* clean context first */

        JSR_CNTX->op = JSR_OP_DELETE_MSG;
        JSR_CNTX->state = JSR_STATE_DELETE_MSG;
        JSR_CNTX->msgId = Message->msgId;
        JSR_CNTX->folderId = Message->folderId;
        JSR_CNTX->dest_mod_id = mod_id;

        if (Message->folderId != 0)
        {   /* delete all messages in folder of that particilar msgID */
            if ((Message->folderId == JSR_INBOX)
                || (Message->folderId == JSR_OUTBOX)
                || (Message->folderId == JSR_SENT)
                || (Message->folderId == JSR_DRAFTS)
                || (Message->folderId == JSR_USRDEF_TEMPLATE) || (Message->folderId == JSR_ARCHIVE))
            {
                JsrFolderType jsr_folder;
                srv_um_msg_box_enum um_folder;

                um_folder = mmi_um_get_current_msg_box_type();
                /* send request to delete all message of that folder */
                /* To check if any that Folder is open or any MMS is open from that particular message Box */
                jsr_folder = (JsrFolderType) srv_mms_jsr_convert_um_folder_to_jsr_folder((S32) um_folder);
                if (jsr_folder == Message->folderId)
                {
                    srv_mms_jsr_delete_msg_output_req_hldr(MMC_RESULT_ACCESS_DENY, mod_id);
                }
                else
                {
                    srv_mms_jsr_delete_msg_req(Message->folderId, Message->msgId);
                }
            }
            else
                /* folder can be from JSR_PREDEF_TEMPLATE  and then is not allowed to delete */
            {
                srv_mms_jsr_delete_msg_output_req_hldr(MMC_RESULT_INVALID_FOLDER, mod_id);
            }
        }
        else
        {   /* delete one particular message ID */
            /* to do check if message is opened or folder is template */
            if ((KAL_TRUE == srv_mms_if_is_mms_in_open_state((U32) Message->msgId))
        #if (defined(__MMI_UNIFIED_COMPOSER__) || defined(__MMI_MMS_STANDALONE_COMPOSER__))
                || (KAL_TRUE == srv_uc_is_mms_in_use((U32) Message->msgId))
        #endif 
        #ifdef __MMI_MMS_BGSR_SUPPORT__
                || (srv_mms_bgsr_get_sending_msg_id() == Message->msgId)
                || (srv_mms_bgsr_get_downloading_msg_id() == Message->msgId)
        #endif /* __MMI_MMS_BGSR_SUPPORT__ */ 
                )
            {
                srv_mms_jsr_delete_msg_output_req_hldr(MMC_RESULT_ACCESS_DENY, mod_id);
            }
            else
            {
                mma_folder_enum folder = mma_get_box(JSR_CNTX->msgId);

                JSR_CNTX->folderId = folder;
                if ((folder != MMA_FOLDER_NONE) && (folder != MMA_FOLDER_TEMPLATE))
                {
                    srv_mms_jsr_delete_msg_req(JSR_NONE, JSR_CNTX->msgId);
                    return;
                }
                else
                {
                    srv_mms_jsr_delete_msg_output_req_hldr(MMC_RESULT_INVALID_FOLDER, mod_id);
                    return;
                }
                /* JSR_CNTX->folderId = JSR_PREDEF_TEMPLATE;
                   JSR_CNTX->req_id = mma_get_request_id();
                   srv_mms_jsr_get_msg_list_req(); */

            }
        }
    }
    else
    {
        srv_mms_jsr_delete_msg_output_req_hldr(MMC_RESULT_BUSY, mod_id);
    }
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_delete_msg_req
 * DESCRIPTION
 *  Create a MSG_ID_WAP_MMA_DELETE_REQ primitive to MMA
 * PARAMETERS
 *  folderId        [IN]        
 *  msgId           [IN]        
 *  msg     [?](?)(?)(?)(?)(?)
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_delete_msg_req(U32 folderId, U32 msgId)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (folderId)
    {   /* delete all message in folder */
        srv_um_delete_folder_req_struct *deleteReq;

        /* tell BGSR that a folder is deleted */
    #ifdef __MMI_MMS_BGSR_SUPPORT__
        if (JSR_CNTX->folderId == JSR_INBOX)
        {
            srv_mms_bgsr_change_msg_notify(
                JSR_CNTX->msgId,
                SRV_MMS_BGSR_OP_DELETE_ALL_INBOX,
                (srv_mms_bgsr_msg_box_enum)srv_mms_jsr_convert_jsr_folder_to_bgsr_folder((U32) JSR_CNTX->folderId),
                NULL,
                MMA_MSG_STORAGE_PHONE);
        }
        else if (JSR_CNTX->folderId == JSR_OUTBOX)
        {
            srv_mms_bgsr_change_msg_notify(
                JSR_CNTX->msgId,
                SRV_MMS_BGSR_OP_DELETE_ALL_OUTBOX,
                (srv_mms_bgsr_msg_box_enum)srv_mms_jsr_convert_jsr_folder_to_bgsr_folder((U32) JSR_CNTX->folderId),
                NULL,
                MMA_MSG_STORAGE_PHONE);
        }
        else if (JSR_CNTX->folderId == JSR_ARCHIVE)
        {
            srv_mms_bgsr_change_msg_notify(
                JSR_CNTX->msgId,
                SRV_MMS_BGSR_OP_DELETE_ALL_ARCHIVE,
                (srv_mms_bgsr_msg_box_enum)srv_mms_jsr_convert_jsr_folder_to_bgsr_folder((U32) JSR_CNTX->folderId),
                NULL,
                MMA_MSG_STORAGE_PHONE);
        }
    #endif /* __MMI_MMS_BGSR_SUPPORT__ */ 

        deleteReq = (srv_um_delete_folder_req_struct*) OslConstructDataPtr(sizeof(srv_um_delete_folder_req_struct));
        deleteReq->msg_type = SRV_UM_MSG_MMS;
        deleteReq->app_id = MMA_APP_ID_JSR;
        deleteReq->msg_box_type = (srv_um_msg_box_enum) srv_mms_jsr_convert_jsr_folder_to_um_folder(folderId);
        srv_mms_jsr_post_message(
            MOD_MMI,
            mms_get_service_module(MSG_ID_MMI_UM_DELETE_FOLDER_REQ),
            0,
            MSG_ID_MMI_UM_DELETE_FOLDER_REQ,
            (oslParaType*) deleteReq,
            NULL);
    }
    else
    {   /* delete specific message only */
        wap_mma_delete_req_struct *deleteReq;

        /* tell BGSR that a msg is deleted */
    #ifdef __MMI_MMS_BGSR_SUPPORT__
        if ((JSR_CNTX->folderId == JSR_INBOX) || (JSR_CNTX->folderId == JSR_OUTBOX))
        {
            srv_mms_bgsr_change_msg_notify(
                JSR_CNTX->msgId,
                SRV_MMS_BGSR_OP_DELETE,
                (srv_mms_bgsr_msg_box_enum)srv_mms_jsr_convert_jsr_folder_to_bgsr_folder((U32) JSR_CNTX->folderId),
                NULL,
                MMA_MSG_STORAGE_PHONE);
        }
    #endif /* __MMI_MMS_BGSR_SUPPORT__ */ 

        deleteReq = (wap_mma_delete_req_struct*) OslConstructDataPtr(sizeof(wap_mma_delete_req_struct));
        deleteReq->app_id = MMA_APP_ID_JSR;
        deleteReq->req_id = mma_get_request_id();
        deleteReq->msg_id[0] = msgId;
        deleteReq->no_of_msg = 1;
        srv_mms_jsr_post_message(
            MOD_MMI,
            mms_get_service_module(MSG_ID_WAP_MMA_DELETE_REQ),
            0,
            MSG_ID_WAP_MMA_DELETE_REQ,
            (oslParaType*) deleteReq,
            NULL);
    }
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_delete_folder_rsp
 * DESCRIPTION
 *  Decodes a MSG_ID_WAP_MMA_DELETE_RSP primitive from MMA
 *  Will come in two states
 *  - Delete message req
 *  - Receive message req
 * PARAMETERS
 *  delfolder       [?]     [?]
 *  delmsg      [?]     [?]     [?](?)(?)
 *  msg(?)(?)(?)(?)(?)
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_delete_folder_rsp(void *delfolder)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_um_delete_folder_rsp_struct *msg = (srv_um_delete_folder_rsp_struct*) delfolder;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* for delete */
    if (msg->app_id == MMA_APP_ID_JSR)
    {
        if (JSR_CNTX->state == JSR_STATE_DELETE_MSG)
        {
            if (msg->result != KAL_TRUE)
            {
                srv_mms_jsr_delete_msg_output_req_hldr(MMC_RESULT_MESSAGE_ID_NOT_FOUND, JSR_CNTX->dest_mod_id);
                /* case when some message are deleted from Folder. */
                srv_mms_jsr_um_refresh_ind(JSR_CNTX->folderId, 0, SRV_UM_REFRESH_MSG_DELETED);
            }
            else
            {
                srv_mms_jsr_delete_msg_output_req_hldr(MMC_RESULT_OK, JSR_CNTX->dest_mod_id);
                /* srv_mms_jsr_um_refresh_ind(JSR_CNTX->folderId); */
                srv_mms_show_status_icon();
            }
        }
        return MMI_TRUE;
    }
    else
    {
        return MMI_FALSE;
    }
}
#endif  /* __MMI_UMMS_PST__ */

#if defined (__MMI_UMMS_PST__) || defined (__MMI_UMMS_JSR205__)
/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_delete_msg_rsp
 * DESCRIPTION
 *  Decodes a MSG_ID_WAP_MMA_DELETE_RSP primitive from MMA
 *  Will come in two states
 *  - Delete message req
 *  - Receive message req
 * PARAMETERS
 *  delmsg      [?]     [?]     [?]     [?]     [?]
 *  msg(?)(?)(?)(?)(?)
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_delete_msg_rsp(void *delmsg)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mma_delete_rsp_struct *msg = (wap_mma_delete_rsp_struct*) delmsg;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* for delete */
    if (msg->app_id == MMA_APP_ID_JSR)
    {
        if (JSR_CNTX->state == JSR_STATE_DELETE_MSG)
        {
            JSR_CNTX->msgId = msg->msg_id[0];
            if (msg->result[0] != MMC_RESULT_OK)
            {
                srv_mms_jsr_delete_msg_output_req_hldr(MMC_RESULT_MESSAGE_ID_NOT_FOUND, JSR_CNTX->dest_mod_id);
            }
            else
            {
                srv_mms_jsr_delete_msg_output_req_hldr((mmc_result_enum)(msg->result[0]), JSR_CNTX->dest_mod_id);
                srv_mms_show_status_icon();
            }
        }
    #ifdef __MMI_UMMS_JSR205__
        /* for receive MMS */
        else if (JSR_CNTX->state == JSR_STATE_RECV_MSG_HDR || JSR_CNTX->state == JSR_STATE_RECV_MSG_BDY)
        {
            if (msg->result[0] == MMC_RESULT_OK)
            {
                srv_mms_jsr_um_refresh_ind(JSR_CNTX->folderId, msg->msg_id[0], SRV_UM_REFRESH_MSG_DELETED);
                srv_mms_show_status_icon();
            }
            srv_mms_jsr_reset_get_content_struct_mem();
            JsrCleanContext();
            /* srv_mms_jsr_reset_xml_struct_msg(); */
        }
        /* for Send MMS */
        else if (JSR_CNTX->state == JSR_STATE_PROCESS_SEND_MSG_HDR || JSR_CNTX->state == JSR_STATE_PROCESS_SEND_MSG_BDY
                 || JSR_CNTX->state == JSR_STATE_SEND_MSG)
        {
            if (msg->result[0] == MMC_RESULT_OK)
            {
                /* No need to send the REFRESH IND to UM. This mms is in Hidden folder. */
                /* srv_mms_jsr_um_refresh_ind(JSR_DRAFTS); */
                srv_mms_show_status_icon();
            }

            JsrCleanContext();
        }
    #endif /* __MMI_UMMS_JSR205__ */ 
        return MMI_TRUE;
    }
    else
    {
        return MMI_FALSE;
    }
}
#endif

#ifdef __MMI_UMMS_PST__
/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_delete_msg_output_req_hldr
 * DESCRIPTION
 *  Create a MSG_ID_WAP_MMC_DELETE_MSG_OUTPUT_REQ primitive to L4
 * PARAMETERS
 *  result      [IN]        
 *  mod_id      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_delete_msg_output_req_hldr(mmc_result_enum result, int mod_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mmc_delete_msg_output_req_struct *myMsgPtr;
    ilm_struct *ilm_ptr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    myMsgPtr = (wap_mmc_delete_msg_output_req_struct*)
        OslConstructDataPtr(sizeof(wap_mmc_delete_msg_output_req_struct));
    if (myMsgPtr)
    {
        memset((char*)(myMsgPtr) + 4, 0x00, (sizeof(wap_mmc_delete_msg_output_req_struct) - 4));
        myMsgPtr->result = (U8) result;

        ilm_ptr = allocate_ilm(MOD_MMI);

        ilm_ptr->src_mod_id = MOD_MMI;
        ilm_ptr->sap_id = MMI_L4C_SAP;
        ilm_ptr->dest_mod_id = (module_type)mod_id;
        ilm_ptr->local_para_ptr = (local_para_struct*) myMsgPtr;
        ilm_ptr->msg_id = MSG_ID_WAP_MMC_DELETE_MSG_OUTPUT_REQ;
        ilm_ptr->peer_buff_ptr = NULL;

        msg_send_ext_queue(ilm_ptr);

        if (result != MMC_RESULT_BUSY)
        {
            if (result == MMC_RESULT_OK)
            {
                if (JSR_CNTX->folderId == JSR_INBOX)
                {
                    srv_mms_jsr_delete_msg_send_event();
                }
                if (JSR_CNTX->folderId == JSR_USRDEF_TEMPLATE)
                {
                    /* Can't use the mma_get_folder API, as the entry is already deleted in MMA */
                    /* this folder ID is specifically checked in the DELETE_REQ function for the MMA */
                #ifdef __MMI_MMS_TEMPLATE_SUPPORT__
                    srv_mms_phone_suit_template_support_callback(JSR_CNTX->msgId);
                #endif 
                }
                /* Refresh the MMS folder menu screen. */
                srv_mms_jsr_um_refresh_ind(JSR_CNTX->folderId, JSR_CNTX->msgId, SRV_UM_REFRESH_MSG_DELETED);    /* amit to get the folder ID */
            }
            JsrCleanContext();
        }
    }
    else
    {
        MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_DELETE_REQ_HDLR, __LINE__);

        ASSERT(0);
    }
}


extern kal_bool mma_msgmgr_check_msg_exist(kal_uint32 msg_id);
extern kal_uint8 mma_get_mms_storage(kal_uint32 msg_id);
/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_read_msg_path_req_hdlr
 * DESCRIPTION
 *  Get MSG_ID_WAP_MMC_READ_MSG_PATH_IND primitive from Java
 * PARAMETERS
 *  msgpathreq      [?]         
 *  mod_id          [IN]        
 *  result(?)       [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_read_msg_path_req_hdlr(void *msgpathreq, int mod_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mmc_read_msg_path_ind_struct *msg_path_req;
    U8 msg_path[(MMA_MAX_INTERNAL_FILENAME_LENGTH + 1) * ENCODING_LENGTH];
    U8 msg_file_path[(MMA_MAX_INTERNAL_FILENAME_LENGTH + 1) * ENCODING_LENGTH];
    kal_uint8 msg_storage = MMA_MSG_STORAGE_PHONE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    msg_path_req = (wap_mmc_read_msg_path_ind_struct*) msgpathreq;
    if (MMI_FALSE == srv_um_check_ready())
    {
        srv_mms_jsr_read_msg_path_rsp(msg_path_req->msgId, msg_path, MMC_RESULT_MMS_NO_READY, mod_id);
        return;
    }
    if (mma_msgmgr_check_msg_exist(msg_path_req->msgId) == FALSE)
    {
        srv_mms_jsr_read_msg_path_rsp(msg_path_req->msgId, msg_path, MMC_RESULT_MESSAGE_ID_NOT_FOUND, mod_id);
        return;
    }
#ifdef __MMI_MMS_MEMORY_CARD_STORAGE_SUPPORT__
    msg_storage = mma_get_mms_storage(msg_path_req->msgId);
#endif 
    mma_get_home_directory((kal_wchar*) msg_path, MMA_MAX_INTERNAL_FILENAME_LENGTH, msg_storage);
    mma_get_msg_file_name(msg_path_req->msgId, (kal_wchar*) msg_file_path, MMA_MAX_INTERNAL_FILENAME_LENGTH);
    mmi_ucs2cat((S8*) msg_path, (S8*) "\\");
    mmi_ucs2cat((S8*) msg_path, (S8*) msg_file_path);
    srv_mms_jsr_read_msg_path_rsp(msg_path_req->msgId, msg_path, MMC_RESULT_OK, mod_id);
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_read_msg_path_rsp
 * DESCRIPTION
 *  Get MSG_ID_WAP_MMC_READ_MSD_PATH_RES_REQ primitive from Java
 * PARAMETERS
 *  msgId           [IN]        
 *  msg_path        [?]         
 *  result          [IN]        
 *  mod_id          [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_read_msg_path_rsp(kal_uint32 msgId, kal_uint8 msg_path[], kal_uint8 result, int mod_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mmc_read_msg_path_res_req_struct *msg_path_rsp;
    ilm_struct *ilm_ptr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    msg_path_rsp =
        (wap_mmc_read_msg_path_res_req_struct*) OslConstructDataPtr(sizeof(wap_mmc_read_msg_path_res_req_struct));
    msg_path_rsp->result = (kal_uint8) result;
    msg_path_rsp->msgId = msgId;

    if (result == MMC_RESULT_OK)
    {
        memcpy(msg_path_rsp->path, msg_path, MMA_MAX_INTERNAL_FILENAME_LENGTH);
    }
    ilm_ptr = allocate_ilm(MOD_MMI);

    ilm_ptr->src_mod_id = MOD_MMI;
    ilm_ptr->sap_id = MMI_L4C_SAP;
    ilm_ptr->dest_mod_id = (module_type)mod_id;
    ilm_ptr->local_para_ptr = (local_para_struct*) msg_path_rsp;
    ilm_ptr->msg_id = MSG_ID_WAP_MMC_READ_MSG_PATH_RES_REQ;
    ilm_ptr->peer_buff_ptr = NULL;

    msg_send_ext_queue(ilm_ptr);

}
#endif  /* __MMI_UMMS_PST__ */


/* JSR MESSAGE HANDLER API */
#ifdef __MMI_UMMS_JSR205__
/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_cfg_appmms_appid_req
 * DESCRIPTION
 *  Create a MSG_ID_WAP_MMC_CFG_APPMMS_APPID_REQ primitive to Java
 * PARAMETERS
 *  msg         [?]         [?]     [?]     [?]     [?]     [?]
 *  mod_id      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_cfg_appmms_appid_req(void *msg, int mod_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mmc_cfg_appmms_appid_req_struct *Message;
    mmc_result_enum result;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    Message = (wap_mmc_cfg_appmms_appid_req_struct*) msg;
    new_java_mms_dest_mod_id = mod_id;
    result = srv_mms_jsr_cfg_app_id(Message->app_id, Message->app_id_len, Message->op);
    srv_mms_jsr_cfg_appmms_appid_rsp(result, mod_id, Message->vm_id);
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_cfg_app_id
 * DESCRIPTION
 *  Register/Deregister the Java application
 * PARAMETERS
 *  app_id              [?]         [?]         [?]         [?]         [?]         [?]
 *  app_id_length       [IN]        
 *  is_remove           [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
mmc_result_enum srv_mms_jsr_cfg_app_id(U8 *app_id, U8 app_id_length, U8 is_remove)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((app_id == NULL) || (app_id_length == 0))
    {
        return MMC_RESULT_INVALID_PARAMETER;
    }
    if (is_remove == MMI_TRUE)
    {
        for (i = 0; i < JSR_MAX_APP_ID_NUM; i++)
        {
            if ((jsr_appid_db[i])
                && (jsr_appid_db[i]->appId) && (strcmp((S8*) jsr_appid_db[i]->appId, (S8*) app_id) == 0))
            {
                srv_mms_mem_mgr_app_adm_free(jsr_appid_db[i]->appId);
                srv_mms_mem_mgr_app_adm_free(jsr_appid_db[i]);
                jsr_appid_db[i] = NULL;
                return MMC_RESULT_OK;
            }
        }
        return MMC_RESULT_ERROR_APPID_NOT_FOUND;
    }
    else
    {
        S32 empty_slot = -1;

        for (i = 0; i < JSR_MAX_APP_ID_NUM; i++)
        {
            if (jsr_appid_db[i] == NULL)
            {
                empty_slot = i;
                break;
            }
            else
            {
                if ((jsr_appid_db[i]->appId) && (strcmp((S8*) jsr_appid_db[i]->appId, (S8*) app_id) == 0))
                {
                    return MMC_RESULT_ERROR_APPID_EXIST;
                }
            }
        }
        if (empty_slot < 0)
        {
            return MMC_RESULT_ERROR_APPID_FULL;
        }
        else
        {
            jsr_appid_db[i] = (jsr_appid_info_struct*) srv_mms_mem_mgr_app_adm_alloc(sizeof(jsr_appid_info_struct));
            if (jsr_appid_db[i] == NULL)
            {
                return MMC_RESULT_INSUFFICIENT_MEMORY;
            }
            jsr_appid_db[i]->appId = (S8*) srv_mms_mem_mgr_app_adm_alloc(app_id_length + 1);
            if (jsr_appid_db[i]->appId == NULL)
            {
                srv_mms_mem_mgr_app_adm_free(jsr_appid_db[i]);
                jsr_appid_db[i] = NULL;
                return MMC_RESULT_INSUFFICIENT_MEMORY;
            }
            memcpy(jsr_appid_db[i]->appId, app_id, app_id_length);
            jsr_appid_db[i]->appId[app_id_length] = '\0';
            return MMC_RESULT_OK;
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_cfg_appmms_appid_rsp
 * DESCRIPTION
 *  Create a MSG_ID_WAP_MMC_CFG_APPMMS_APPID_RSP primitive to Java
 * PARAMETERS
 *  result      [IN]        
 *  mod_id      [IN]        
 *  vm_id       [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_cfg_appmms_appid_rsp(mmc_result_enum result, int mod_id, int vm_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mmc_cfg_appmms_appid_rsp_struct *myMsgPtr;
    ilm_struct *ilm_ptr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    myMsgPtr = (wap_mmc_cfg_appmms_appid_rsp_struct*) OslConstructDataPtr(sizeof(wap_mmc_cfg_appmms_appid_rsp_struct));
    myMsgPtr->result = (U8) result;
    myMsgPtr->vm_id = vm_id;

    ilm_ptr = allocate_ilm(MOD_MMI);

    ilm_ptr->src_mod_id = MOD_MMI;
    ilm_ptr->sap_id = J2ME_WAP_SAP;
    ilm_ptr->dest_mod_id = (module_type)mod_id;
    ilm_ptr->local_para_ptr = (local_para_struct*) myMsgPtr;
    ilm_ptr->msg_id = MSG_ID_WAP_MMC_CFG_APPMMS_APPID_RSP;
    ilm_ptr->peer_buff_ptr = NULL;

    msg_send_ext_queue(ilm_ptr);
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_check_appmms_coming_req
 * DESCRIPTION
 *  Create a MSG_ID_WAP_MMC_CHECK_APPMMS_COMING_REQ primitive to Java
 * PARAMETERS
 *  msg         [?]         [?]     [?]     [?]     [?]     [?]
 *  mod_id      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_check_appmms_coming_req(void *msg, int mod_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mmc_check_appmms_coming_req_struct *Message;
    MMI_BOOL result = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    Message = (wap_mmc_check_appmms_coming_req_struct*) msg;
    result = srv_mms_jsr_check_appid_msgs(Message->app_id, Message->app_id_len, (U8) Message->only_new);
    srv_mms_jsr_check_appmms_coming_rsp(result, mod_id);
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_check_appid_msgs
 * DESCRIPTION
 *  Checks the application object list for specific application
 * PARAMETERS
 *  app_id              [?]         [?]         [?]         [?]         [?]         [?]
 *  app_id_length       [IN]        
 *  is_new              [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_check_appid_msgs(U8 *app_id, U8 app_id_length, U8 is_new)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_jsr_appid_object_list == NULL)
    {
        srv_mms_jsr_read_object_list_from_file();
    }
    if (g_jsr_appid_object_list)
    {
        jsr_appid_msgid_list *appid_list = g_jsr_appid_object_list;

        while (appid_list)
        {
            if ((appid_list->appId) && (strcmp((S8*) appid_list->appId, (S8*) app_id) == 0))
            {
                jsr_msg_info *msg_list = appid_list->msgs;

                while (msg_list)
                {
                    MMI_TRACE(
                        MMI_INET_TRC_G6_MMS,
                        MMI_JSR_CHECK_APPID_MSGS,
                        msg_list->msgId,
                        msg_list->is_checked,
                        is_new);
                    if (msg_list->is_checked == MMI_FALSE)
                    {
                        msg_list->is_checked = MMI_TRUE;
                        srv_mms_jsr_write_object_list_to_file();
                        return MMI_TRUE;
                    }
                    else
                    {
                        if (is_new == MMI_FALSE)
                        {
                            return MMI_TRUE;
                        }
                    }
                    msg_list = msg_list->next;
                }
                return MMI_FALSE;
            }
            appid_list = appid_list->next;
        }
    }
    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_check_appmms_coming_rsp
 * DESCRIPTION
 *  Create a MSG_ID_WAP_MMC_CHECK_APPMMS_COMING_RSP primitive to Java
 * PARAMETERS
 *  result      [IN]        
 *  mod_id      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_check_appmms_coming_rsp(MMI_BOOL result, int mod_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mmc_check_appmms_coming_rsp_struct *myMsgPtr;
    ilm_struct *ilm_ptr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    myMsgPtr = (wap_mmc_check_appmms_coming_rsp_struct*)
        OslConstructDataPtr(sizeof(wap_mmc_check_appmms_coming_rsp_struct));
    myMsgPtr->result = (result) ? (1) : (0);

    ilm_ptr = allocate_ilm(MOD_MMI);

    ilm_ptr->src_mod_id = MOD_MMI;
    ilm_ptr->sap_id = J2ME_WAP_SAP;
    ilm_ptr->dest_mod_id = (module_type)mod_id;
    ilm_ptr->local_para_ptr = (local_para_struct*) myMsgPtr;
    ilm_ptr->msg_id = MSG_ID_WAP_MMC_CHECK_APPMMS_COMING_RSP;
    ilm_ptr->peer_buff_ptr = NULL;

    msg_send_ext_queue(ilm_ptr);
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_add_recv_java_mms_content
 * DESCRIPTION
 *  Thsi will be called by MMS applicaiton when JAVA Message is recived
 * PARAMETERS
 *  msgId       [IN]        
 *  app_id      [?]         [?]         [?]         [?]         [?]
 *  contentType     [?](?)(?)(?)(?)(?)
 * RETURNS
 *  
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_add_recv_java_mms_content(U32 msgId, U8 *app_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_ADD_NEW_JAVA_MMS_ENTRY, __LINE__);
    if (MMI_TRUE == srv_mms_jsr_insert_msgId_to_appId_list(msgId, app_id, FALSE))
    {
        if (MMI_TRUE == srv_mms_jsr_check_appId((S8*) app_id))
        {
            MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_CFG_APPID_JAVA_MMS, __LINE__);
            srv_mms_jsr_send_appmms_new_mms_ind(app_id, (U32) strlen((S8*) app_id));
        }
        return MMI_TRUE;
    }
    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_send_appmms_new_mms_ind
 * DESCRIPTION
 *  Create a MSG_ID_WAP_MMC_APPMMS_NEW_MMS_IND primitive to Java
 * PARAMETERS
 *  appId       [?]         [?]         [?]         [?]         [?]         [?]
 *  length      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_send_appmms_new_mms_ind(U8 *appId, U32 length)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mmc_appmms_new_mms_ind_struct *myMsgPtr;
    ilm_struct *ilm_ptr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    myMsgPtr = (wap_mmc_appmms_new_mms_ind_struct*) OslConstructDataPtr(sizeof(wap_mmc_appmms_new_mms_ind_struct));
    memcpy(myMsgPtr->app_id, appId, length);
    myMsgPtr->app_id_len = length;

    ilm_ptr = allocate_ilm(MOD_MMI);

    ilm_ptr->src_mod_id = MOD_MMI;
    ilm_ptr->sap_id = J2ME_WAP_SAP;
    ilm_ptr->dest_mod_id = (module_type)new_java_mms_dest_mod_id;
    ilm_ptr->local_para_ptr = (local_para_struct*) myMsgPtr;
    ilm_ptr->msg_id = MSG_ID_WAP_MMC_APPMMS_NEW_MMS_IND;
    ilm_ptr->peer_buff_ptr = NULL;

    msg_send_ext_queue(ilm_ptr);
}

/* JAVA PROFILE SETTINGS API */


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_get_mms_profile_req
 * DESCRIPTION
 *  Create a MSG_ID_WAP_MMC_GET_MMS_PROF_REQ primitive to Java
 * PARAMETERS
 *  msg         [?]         [?]     [?]     [?]     [?]     [?]
 *  mod_id      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_get_mms_profile_req(void *msg, int mod_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mmc_get_mms_prof_req_struct *Message;

    srv_wap_prof_profile_content_struct *profile_data;
    U8 result = 2;  /* invalid prof id. */
    U8 value_length = 0;
    U8 *value = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    Message = (wap_mmc_get_mms_prof_req_struct*) msg;

    switch (Message->access_id)
    {
        case JSR_WAP_MMS_PROF_MMSC_ADDRESS:
        {
            value = (U8*) srv_mms_mem_mgr_app_adm_alloc(256);
            ASSERT(value);

        #if (MMI_MAX_SIM_NUM >= 4)
            if (Message->simId == MMC_SIM_CARD_SIM4)
            {
                profile_data = srv_wap_prof_get_profile_content(
                                SRV_WAP_PROF_SIMID_SIM4,
                                SRV_WAP_PROF_APPID_MMS,
                                (U8) - 1,
                                SRV_WAP_PROF_DTCNT_PRIMARY,
                                NULL);
            }
            else
        #endif /* (MMI_MAX_SIM_NUM >= 4) */ 
        #if (MMI_MAX_SIM_NUM >= 3)
            if (Message->simId == MMC_SIM_CARD_SIM3)
            {
                profile_data = srv_wap_prof_get_profile_content(
                                SRV_WAP_PROF_SIMID_SIM3,
                                SRV_WAP_PROF_APPID_MMS,
                                (U8) - 1,
                                SRV_WAP_PROF_DTCNT_PRIMARY,
                                NULL);
            }
            else
        #endif /* (MMI_MAX_SIM_NUM >= 3) */ 
        #if (MMI_MAX_SIM_NUM >= 2)
            if (Message->simId == MMC_SIM_CARD_SIM2)
            {
                profile_data = srv_wap_prof_get_profile_content(
                                SRV_WAP_PROF_SIMID_SIM2,
                                SRV_WAP_PROF_APPID_MMS,
                                (U8) - 1,
                                SRV_WAP_PROF_DTCNT_PRIMARY,
                                NULL);
            }
            else
        #endif /* (MMI_MAX_SIM_NUM >= 2) */ 
            {
                profile_data = srv_wap_prof_get_profile_content(
                                SRV_WAP_PROF_SIMID_DEFAULT,
                                SRV_WAP_PROF_APPID_MMS,
                                (U8) - 1,
                                SRV_WAP_PROF_DTCNT_PRIMARY,
                                NULL);
            }
            if (NULL == profile_data)
            {
                result = 1; /* MMS not ready yet. */
                break;
            }
            value_length = strlen((S8*) profile_data->url) + 1;

            if (value_length > 256)
            {
                ASSERT(0);  /* memory corruption */
            }
            memcpy(value, profile_data->url, value_length);
            result = 0;
            if (profile_data != NULL)
            {
                OslMfree(profile_data);
                profile_data = NULL;
            }
            break;
        default:    /* will send result as 2 invalid profile */
            break;
        }
    }
    srv_mms_jsr_get_mms_profile_rsp(result, value, value_length, mod_id);

    if (NULL != value)
    {
        srv_mms_mem_mgr_app_adm_free(value);
    }
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_get_mms_profile_rsp
 * DESCRIPTION
 *  Create a MSG_ID_WAP_MMC_GET_MMS_PROF_RSP primitive to Java
 * PARAMETERS
 *  result              [IN]        
 *  value               [?]         [?]         [?]         [?]         [?]         [?]
 *  value_length        [IN]        
 *  mod_id              [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_get_mms_profile_rsp(U8 result, U8 *value, U8 value_length, int mod_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mmc_get_mms_prof_rsp_struct *myMsgPtr = NULL;
    ilm_struct *ilm_ptr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    myMsgPtr = (wap_mmc_get_mms_prof_rsp_struct*) OslConstructDataPtr(sizeof(wap_mmc_get_mms_prof_rsp_struct));
    myMsgPtr->result = result;
    myMsgPtr->value_len = value_length;
    if (value_length > 0 && value != NULL)
    {
        memcpy(myMsgPtr->value, value, value_length);
    }

    ilm_ptr = allocate_ilm(MOD_MMI);

    ilm_ptr->src_mod_id = MOD_MMI;
    ilm_ptr->sap_id = J2ME_MMI_SAP;
    if (mod_id == MOD_JAM)
    {
        ilm_ptr->dest_mod_id = (module_type)mod_id;
    }
    else
    {
        ilm_ptr->dest_mod_id = MOD_JAM;
    }
    ilm_ptr->local_para_ptr = (local_para_struct*) myMsgPtr;
    ilm_ptr->msg_id = MSG_ID_WAP_MMC_GET_MMS_PROF_RSP;
    ilm_ptr->peer_buff_ptr = NULL;

    msg_send_ext_queue(ilm_ptr);
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_abort_appmms_req
 * DESCRIPTION
 *  Create a MSG_ID_WAP_MMC_ABORT_APPMMS_REQ primitive to Java
 * PARAMETERS
 *  msg         [?]         [?]     [?]     [?]     [?]     [?]
 *  mod_id      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_abort_appmms_req(void *msg, int mod_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 file_name_p[JSR_FILENAME_LEN_MMA];

    /* U32 file_path_len = 0; */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    JSR_CNTX->is_abort_get_req = MMI_TRUE;
    if (((JSR_CNTX->op == JSR_OP_ABORT_SENDING_MSG) || (JSR_CNTX->op == JSR_OP_ABORT_RECIEVING_MSG)) ||
        ((JSR_CNTX->op != JSR_OP_SEND_MSG) && (JSR_CNTX->op != JSR_OP_RECV_MSG)))
    {
        srv_mms_jsr_abort_appmms_rsp(MMC_RESULT_ACCESS_DENY, mod_id);
    }
    else
    {
        if (JSR_CNTX->op == JSR_OP_SEND_MSG)
        {
            if ((JSR_CNTX->state == JSR_STATE_PROCESS_SEND_MSG_HDR)
                || (JSR_CNTX->state == JSR_STATE_PROCESS_SEND_MSG_BDY))
            {
                memset(file_name_p, 0, JSR_FILENAME_LEN_MMA);
                MAKE_JSR_MEDIA_OBJECT_FILE(file_name_p);

                srv_mms_jsr_abort_appmms_rsp(MMC_RESULT_OK, mod_id);

                FS_Delete((U16*) file_name_p);
                JsrCleanContext();
                srv_mms_jsr_reset_xml_struct_msg();
            }
            else
            {
                srv_mms_jsr_cancel_send_msg_req();
                JSR_CNTX->dest_mod_id = mod_id;
            }
            JSR_CNTX->op = JSR_OP_ABORT_SENDING_MSG;
        }
        else
        {
            /* Aborting receiving of Java MMS by Java app. */
            memset(file_name_p, 0, JSR_FILENAME_LEN_MMA);
            MAKE_JSR_MEDIA_OBJECT_FILE(file_name_p);

            srv_mms_jsr_abort_appmms_rsp(MMC_RESULT_OK, mod_id);
            FS_Delete((U16*) file_name_p);
            srv_mms_jsr_reset_get_content_struct_mem();
            JsrCleanContext();
            /* srv_mms_jsr_reset_xml_struct_msg(); */
            JSR_CNTX->op = JSR_OP_ABORT_RECIEVING_MSG;
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_cancel_send_msg_req
 * DESCRIPTION
 *  Create a MSG_ID_WAP_MMA_CANCEL_SEND_REQ primitive to MMA
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_cancel_send_msg_req(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    srv_mms_bgsr_cancel_send_java_msg_req((U32) JSR_CNTX->msgId);
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_cancel_send_msg_rsp
 * DESCRIPTION
 *  Decodes a MSG_ID_WAP_MMA_CANCEL_SEND_RSP primitive from MMA
 * PARAMETERS
 *  result      [IN]        
 *  msgRsp      [?]     [?]     [?]     [?](?)
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_cancel_send_msg_rsp(U8 result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (srv_mms_jsr_translate_bgsr_to_mmc_result(result) != MMC_RESULT_OK)
    {
        srv_mms_jsr_abort_appmms_rsp(MMC_RESULT_ERROR_SEND_CANCEL_BY_SYSTEM, JSR_CNTX->dest_mod_id);
    }
    else
    {
        srv_mms_jsr_abort_appmms_rsp(MMC_RESULT_OK, JSR_CNTX->dest_mod_id);
        /* Send_Rsp fail flow will take care of resetting structures,icons and deleting MMS from drafts */
    }

}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_abort_appmms_rsp
 * DESCRIPTION
 *  Create a MSG_ID_WAP_MMC_ABORT_APPMMS_RSP primitive to Java
 * PARAMETERS
 *  result      [IN]        
 *  mod_id      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_abort_appmms_rsp(mmc_result_enum result, int mod_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wap_mmc_abort_appmms_rsp_struct *myMsgPtr;
    ilm_struct *ilm_ptr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    myMsgPtr = (wap_mmc_abort_appmms_rsp_struct*) OslConstructDataPtr(sizeof(wap_mmc_abort_appmms_rsp_struct));
    myMsgPtr->result = (U8) result;

    ilm_ptr = allocate_ilm(MOD_MMI);

    ilm_ptr->src_mod_id = MOD_MMI;
    ilm_ptr->sap_id = J2ME_WAP_SAP;
    ilm_ptr->dest_mod_id = (module_type)mod_id;
    ilm_ptr->local_para_ptr = (local_para_struct*) myMsgPtr;
    ilm_ptr->msg_id = MSG_ID_WAP_MMC_ABORT_APPMMS_RSP;
    ilm_ptr->peer_buff_ptr = NULL;

    msg_send_ext_queue(ilm_ptr);
}


/* JSR INTERNAL APIs */
/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_insert_msgId_to_appId_list
 * DESCRIPTION
 *  Insert the message information in application object list when new JAVA MSG Comes.
 * PARAMETERS
 *  msgId           [IN]        
 *  appId           [?]         [?]         [?]         [?]         [?]         [?]
 *  is_checked      [IN]        
 * RETURNS
 *  MMI_BOOL result
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_insert_msgId_to_appId_list(U32 msgId, U8 *appId, BOOL is_checked)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    jsr_appid_msgid_list *appid_list = NULL;
    jsr_msg_info *msg_list = NULL;
    MMI_BOOL result = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_jsr_appid_object_list == NULL)
    {
        srv_mms_jsr_read_object_list_from_file();
    }
    appid_list = g_jsr_appid_object_list;

    while (appid_list)
    {
        if ((appid_list->appId) && (strcmp((S8*) appid_list->appId, (S8*) appId) == 0))
        {
            result = srv_mms_jsr_insert_msg_info_to_list(&(appid_list->msgs), msgId, is_checked);
            break;
        }
        appid_list = appid_list->next;
    }
    if (appid_list == NULL)
    {
        if (srv_mms_jsr_insert_msg_info_to_list(&msg_list, msgId, is_checked))
        {
            result = srv_mms_jsr_insert_appid_info_to_list(&appid_list, (S8*) appId, msg_list);
            if (!g_jsr_appid_object_list)
            {
                g_jsr_appid_object_list = appid_list;
            }
        }
    }
    if (result == MMI_TRUE)
    {
        srv_mms_jsr_write_object_list_to_file();
    }
    return result;
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_remove_msgId_from_appId_list
 * DESCRIPTION
 *  Delete the message information from application object list.
 *  Used in recive Java MMS routines.
 * PARAMETERS
 *  msgId       [IN]        
 * RETURNS
 *  MMI_BOOL result
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_remove_msgId_from_appId_list(U32 msgId)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    jsr_appid_msgid_list *appid_list = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_jsr_appid_object_list == NULL)
    {
        srv_mms_jsr_read_object_list_from_file();
    }
    appid_list = g_jsr_appid_object_list;

    while (appid_list)
    {
        if (appid_list->msgs)
        {
            jsr_msg_info *msg_list = appid_list->msgs;

            while (msg_list)
            {
                if (msg_list->msgId == msgId)
                {
                    srv_mms_jsr_remove_msg_info_from_list(&(appid_list->msgs), msgId);
                    if (appid_list->msgs == NULL)
                    {
                        srv_mms_jsr_remove_appid_info_from_list(&g_jsr_appid_object_list, appid_list->appId);
                    }
                    srv_mms_jsr_write_object_list_to_file();
                    return MMI_TRUE;
                }
                msg_list = msg_list->next;
            }
        }
        appid_list = appid_list->next;
    }
    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_read_object_list_from_file
 * DESCRIPTION
 *  Read the application object list information from a file.
 *  srv_mms_jsr_add_recv_java_mms_content
 *  srv_mms_jsr_check_appmms_coming_req
 *  srv_mms_jsr_receive_appmms_req_hldr
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_read_object_list_from_file(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 filename[JSR_FILENAME_LEN_MMA];
    int filehandle = -1;
    S8 *buff = NULL;
    U32 buf_size = FILE_BUF_SIZE;
    U32 line_length;
    S32 ret;
    MMI_BOOL update_file = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(filename, 0, JSR_FILENAME_LEN_MMA);
    MAKE_JSR_APPID_LIST_FILE(filename);

    filehandle = FS_Open((U16*) (filename), FS_READ_ONLY);
    if (filehandle < 0)
    {
        MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_FS_OPEN_ERROR, __LINE__, filehandle);
        return;
    }

    buff = (S8*) srv_mms_mem_mgr_app_adm_alloc(buf_size);
    if (buff == NULL)
    {
        FS_Close(filehandle);
        return;
    }

    while (1)
    {
        S8 *appid_string = NULL;
        jsr_msg_info *msg_list = NULL;
        U32 step = 1;

        for (step = 1; step < 4; step++)
        {
            /* applib_file_read_line(filehandle, buff, buf_size, &line_length, &ret); */
            srv_mms_jsr_read_line_from_file(filehandle, buff, buf_size, &line_length, &ret);
            if ((ret == 0) && (line_length == 0))
            {
                FS_Close(filehandle);
                srv_mms_mem_mgr_app_adm_free(buff);
                if (update_file == MMI_TRUE)
                {
                    srv_mms_jsr_write_object_list_to_file();
                }
                return;
            }
            else if (ret < 0)
            {
                FS_Close(filehandle);
                srv_mms_mem_mgr_app_adm_free(buff);
                /* File format corrupted, so remove all the appid info. */
                srv_mms_jsr_remove_appid_info_from_list_recursive(&g_jsr_appid_object_list);
                return;
            }
            ASSERT(line_length > 2);
            /* replace '\r''\n' with '\0''\0' */
            *(buff + line_length - 1) = '\0';
            *(buff + line_length - 2) = '\0';

            /* Read appid from file */
            if (step == 1)
            {
                appid_string = (S8*) srv_mms_mem_mgr_app_adm_alloc(strlen((char*)buff) + 1);
                ASSERT(appid_string);
                strcpy((S8*) appid_string, (S8*) buff);
            }
            /* Read msgid and isChecked string */
            else if (step == 2)
            {
                S8 *text = buff;
                S8 *colon = NULL;
                S8 *next_token = NULL;
                U32 msgId;
                U8 isChecked;

                while (text)
                {
                    next_token = (S8*) strchr((char*)text, ',');
                    if (next_token != NULL)
                    {
                        *(next_token++) = '\0';
                    }
                    colon = (S8*) strchr((char*)text, ':');
                    ASSERT(colon);
                    *(colon++) = '\0';
                    msgId = atoi((char*)text);
                    isChecked = atoi((char*)colon);
                    if ( /* amit to do srv_mms_jsr_check_msg_id(msgId) */ 1 == TRUE)
                    {
                        srv_mms_jsr_insert_msg_info_to_list(&msg_list, msgId, isChecked);
                    }
                    else
                    {
                        update_file = MMI_TRUE;
                    }
                    text = next_token;
                }
            }
            /* '\r' and '\n' */
            else if (step == 3)
            {
                if (msg_list != NULL)
                {
                    srv_mms_jsr_insert_appid_info_to_list(&g_jsr_appid_object_list, appid_string, msg_list);
                }
                else
                {
                    if (appid_string)
                    {
                        srv_mms_mem_mgr_app_adm_free(appid_string);
                    }
                }
            }
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_write_object_list_to_file
 * DESCRIPTION
 *  Write the application object list information to file.
 * PARAMETERS
 *  void
 * RETURNS
 *  MMI_BOOL result
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_write_object_list_to_file(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 filename[JSR_FILENAME_LEN_MMA];
    U8 orig_file[JSR_FILENAME_LEN_MMA];
    S8 *buff = NULL;
    U32 buf_size = 0;
    U32 filesize = 0;
    U32 datalen = 0;
    int filehandle = -1;
    U32 written = 0;
    S32 result = -1;
    jsr_appid_msgid_list *appid_list = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_jsr_appid_object_list == NULL)
    {
        memset(orig_file, 0, JSR_FILENAME_LEN_MMA);
        MAKE_JSR_APPID_LIST_FILE(orig_file);
        FS_Delete((U16*) orig_file);
        return MMI_FALSE;
    }

    filesize = srv_mms_jsr_get_current_size_of_object_list(g_jsr_appid_object_list, &buf_size);
    ASSERT(filesize);

    memset(orig_file, 0, JSR_FILENAME_LEN_MMA);
    MAKE_JSR_APPID_LIST_FILE(orig_file);

    memset(filename, 0, JSR_FILENAME_LEN_MMA);
    MAKE_APPID_LIST_FILE_TMP(filename);

    FS_Delete((U16*) filename);

    filehandle = FS_Open((U16*) filename, FS_CREATE_ALWAYS | FS_READ_WRITE);
    if (filehandle < 0)
    {
        MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_FS_OPEN_ERROR, __LINE__, filehandle);
        return MMI_FALSE;
    }
    FS_SetAttributes((U16*) filename, FS_ATTR_HIDDEN);
    buff = (S8*) srv_mms_mem_mgr_app_adm_alloc(sizeof(S8) * buf_size + 1);
    ASSERT(buff);
    appid_list = g_jsr_appid_object_list;
    while (appid_list)
    {
        ASSERT(appid_list->appId);
        {
            datalen = 0;
            sprintf((char*)buff, "%s\r\n", appid_list->appId);
            datalen = strlen((char*)appid_list->appId) + 2;
            result = FS_Write(filehandle, buff, datalen, &written);
            if (result < 0)
            {
                MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_FS_WRITE_ERROR, __LINE__, result);
                FS_Close(filehandle);
                srv_mms_mem_mgr_app_adm_free(buff);
                return MMI_FALSE;
            }
        }
        ASSERT(appid_list->msgs);
        {
            jsr_msg_info *msg_list = appid_list->msgs;

            datalen = 0;
            while (msg_list)
            {
                MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_WRITE_OBJECT_LIST, msg_list->msgId, msg_list->is_checked);
                sprintf((char*)(buff + datalen), "%d:%1d", msg_list->msgId, msg_list->is_checked);
                datalen += srv_mms_jsr_get_digit_of_integer(msg_list->msgId) + 2;
                if (msg_list->next)
                {
                    sprintf((char*)(buff + datalen), ",");
                    datalen += 1;
                }
                msg_list = msg_list->next;
            }
            sprintf((char*)(buff + datalen), "\r\n*\r\n");
            datalen += 5;
            ASSERT(buf_size >= datalen);
            result = FS_Write(filehandle, buff, datalen, &written);
            if (result < 0)
            {
                MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_FS_WRITE_ERROR, __LINE__, result);
                FS_Close(filehandle);
                srv_mms_mem_mgr_app_adm_free(buff);
                return MMI_FALSE;
            }
        }
        appid_list = appid_list->next;
    }
    FS_Close(filehandle);
    srv_mms_mem_mgr_app_adm_free(buff);
    FS_Delete((U16*) orig_file);
    FS_Rename((U16*) filename, (U16*) orig_file);
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_insert_appid_info_to_list
 * DESCRIPTION
 *  Insert the application info to application object list.
 * PARAMETERS
 *  appid_object_list       [IN]        
 *  string                  [?]         [?]         [?]         [?]         [?]         [?]
 *  msg_list                [?]         [?]         [?]         [?]         [?]         [?]
 * RETURNS
 *  MMI_BOOL result
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_insert_appid_info_to_list(
            jsr_appid_msgid_list **appid_object_list,
            S8 *string,
            jsr_msg_info *msg_list)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    jsr_appid_msgid_list *node = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (appid_object_list == NULL)
    {
        return MMI_FALSE;
    }
    node = (jsr_appid_msgid_list*) srv_mms_mem_mgr_app_adm_alloc(sizeof(jsr_appid_msgid_list));
    ASSERT(node);
    memset(node, 0, sizeof(jsr_appid_msgid_list));
    node->appId = (S8*) srv_mms_mem_mgr_app_adm_alloc(strlen((S8*) string) + 1);
    ASSERT(node->appId);
    strcpy((S8*) node->appId, (S8*) string);
    node->msgs = msg_list;
    if (!g_jsr_appid_object_list)
    {
        node->prev = node;
        *appid_object_list = node;
        return MMI_TRUE;
    }
    else
    {
        jsr_appid_msgid_list *tempnode = g_jsr_appid_object_list;

        while (tempnode->next)
        {
            tempnode = tempnode->next;
        }
        tempnode->next = node;
        node->prev = tempnode;
        return MMI_TRUE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_remove_appid_info_from_list
 * DESCRIPTION
 *  Remove the application info from application object list.
 * PARAMETERS
 *  list        [IN]        
 *  appId       [?]         [?]         [?]         [?]         [?]         [?]
 * RETURNS
 *  MMI_BOOL result
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_remove_appid_info_from_list(jsr_appid_msgid_list **list, S8 *appId)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    jsr_appid_msgid_list *appid_list;
    jsr_appid_msgid_list *temp;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((list == NULL) || (*(list) == NULL))
    {
        return MMI_FALSE;
    }

    appid_list = *list;
    if ((appid_list->appId) && (appId) && (strcmp((S8*) appid_list->appId, (S8*) appId) == 0))
    {

        *list = appid_list->next;
        srv_mms_mem_mgr_app_adm_free(appid_list->appId);
        srv_mms_jsr_remove_msg_info_from_list_recursive(&(appid_list->msgs));
        srv_mms_mem_mgr_app_adm_free(appid_list);
        return MMI_TRUE;
    }
    while (appid_list->next)
    {
        if ((appid_list->next->appId) && (appId) && (strcmp((S8*) appid_list->next->appId, (S8*) appId) == 0))
        {
            temp = appid_list->next;
            appid_list->next = appid_list->next->next;
            srv_mms_mem_mgr_app_adm_free(temp->appId);
            srv_mms_jsr_remove_msg_info_from_list_recursive(&(temp->msgs));
            srv_mms_mem_mgr_app_adm_free(temp);
            return MMI_TRUE;
        }
        appid_list = appid_list->next;
    }
    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_remove_appid_info_from_list_recursive
 * DESCRIPTION
 *  Remove the appid info of all the messages in the application object list.
 * PARAMETERS
 *  list        [IN]        
 * RETURNS
 *  MMI_BOOL result
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_remove_appid_info_from_list_recursive(jsr_appid_msgid_list **list)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    jsr_appid_msgid_list *appid_list;
    jsr_appid_msgid_list *appid_list_temp = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((list == NULL) || (*list == NULL))
    {
        return MMI_FALSE;
    }

    appid_list = *list;
    while (appid_list)
    {
        appid_list_temp = appid_list->next;
        srv_mms_mem_mgr_app_adm_free(appid_list->appId);
        srv_mms_jsr_remove_msg_info_from_list_recursive(&(appid_list->msgs));
        srv_mms_mem_mgr_app_adm_free(appid_list);
        appid_list = appid_list_temp;
    }
    *list = NULL;
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_insert_msg_info_to_list
 * DESCRIPTION
 *  Insert the message info to application object list.
 * PARAMETERS
 *  msg_list        [IN]        
 *  msgId           [IN]        
 *  ischecked       [IN]        
 * RETURNS
 *  MMI_BOOL result
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_insert_msg_info_to_list(jsr_msg_info **msg_list, U32 msgId, U8 ischecked)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    jsr_msg_info *node = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (msg_list == NULL)
    {
        return MMI_FALSE;
    }
    node = (jsr_msg_info*) srv_mms_mem_mgr_app_adm_alloc(sizeof(jsr_msg_info));
    ASSERT(node);
    memset(node, 0, sizeof(jsr_msg_info));
    node->msgId = msgId;
    node->is_checked = ischecked;
    MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_INSERT_MESSAGE_INFO, msgId, ischecked);
    if (*msg_list == NULL)
    {
        node->prev = node;
        *msg_list = node;
        return MMI_TRUE;
    }
    else
    {
        jsr_msg_info *tempnode = *msg_list;

        while (tempnode->next)
        {
            tempnode = tempnode->next;
        }
        tempnode->next = node;
        node->prev = tempnode;
        return MMI_TRUE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_remove_msg_info_from_list
 * DESCRIPTION
 *  Remove the message info from application object list.
 * PARAMETERS
 *  list        [IN]        
 *  msgId       [IN]        
 * RETURNS
 *  MMI_BOOL result
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_remove_msg_info_from_list(jsr_msg_info **list, U32 msgId)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    jsr_msg_info *msg_list;
    jsr_msg_info *temp;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((list == NULL) || (*(list) == NULL))
    {
        return MMI_FALSE;
    }

    msg_list = *list;

    if (msg_list->msgId == msgId)
    {
        *list = msg_list->next;
        srv_mms_mem_mgr_app_adm_free(msg_list);
        return MMI_TRUE;
    }
    while (msg_list->next)
    {
        if (msg_list->next->msgId == msgId)
        {
            temp = msg_list->next;
            msg_list->next = msg_list->next->next;
            srv_mms_mem_mgr_app_adm_free(temp);
            return MMI_TRUE;
        }
        msg_list = msg_list->next;
    }

    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_remove_msg_info_from_list_recursive
 * DESCRIPTION
 *  Remove the message info of all the messages in the message list.
 * PARAMETERS
 *  list        [IN]        
 * RETURNS
 *  MMI_BOOL result
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_remove_msg_info_from_list_recursive(jsr_msg_info **list)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    jsr_msg_info *msg_list;
    jsr_msg_info *msg_list_temp = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((list == NULL) || (*(list) == NULL))
    {
        return MMI_FALSE;
    }

    msg_list = *list;
    while (msg_list)
    {
        msg_list_temp = msg_list->next;
        srv_mms_mem_mgr_app_adm_free(msg_list);
        msg_list = msg_list_temp;
    }
    *list = NULL;
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_get_digit_of_integer
 * DESCRIPTION
 *  Calculates the number of digits in an integer.
 * PARAMETERS
 *  msgId       [IN]        
 * RETURNS
 *  U32 length
 *****************************************************************************/
U32 srv_mms_jsr_get_digit_of_integer(U32 msgId)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S8 buff[16];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    sprintf((S8*) buff, "%d", msgId);
    return strlen((S8*) buff);
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_get_current_size_of_object_list
 * DESCRIPTION
 *  Calculates the current size of application object list.
 * PARAMETERS
 *  appid_object_list       [?]     [?]     [?]     [?]     [?]     [?]
 *  max_chrs_in_line        [?]     [?]     [?]     [?]     [?]     [?]
 * RETURNS
 *  U32 size
 *****************************************************************************/
U32 srv_mms_jsr_get_current_size_of_object_list(jsr_appid_msgid_list *appid_object_list, U32 *max_chrs_in_line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 sum = 0;
    U32 chrs = 0;
    U32 max_chrs = 0;
    jsr_appid_msgid_list *appid_list;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    *(max_chrs_in_line) = 0;

    if (appid_object_list == NULL)
    {
        return 0;
    }

    appid_list = appid_object_list;

    while (appid_list)
    {
        if (appid_list->appId)
        {
            chrs = strlen((S8*) appid_list->appId) + 2; /* appid string+\r\n */
            sum += chrs;
            if (chrs > max_chrs)
            {
                max_chrs = chrs;
            }
        }
        chrs = 0;
        if (appid_list->msgs)
        {
            jsr_msg_info *msg_list = appid_list->msgs;

            while (msg_list)
            {
                /* msgid:isChecked */
                chrs += (srv_mms_jsr_get_digit_of_integer(msg_list->msgId) + 2);
                if (msg_list->next)
                {
                    chrs += 1;
                }
                msg_list = msg_list->next;
            }
            chrs += 5;  /* \r\n*\r\n */
            sum += chrs;
            if (chrs > max_chrs)
            {
                max_chrs = chrs;
            }
        }
        appid_list = appid_list->next;
    }

    *max_chrs_in_line = max_chrs;
    return sum;
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_read_line_from_file
 * DESCRIPTION
 *  Reads a line from a file and store it in buffer.
 * PARAMETERS
 *  filehandle      [IN]        
 *  buffer          [?]         [?]         [?]         [?]         [?]         [?]
 *  buf_length      [IN]        
 *  line_length     [?]         [?]         [?]         [?]         [?]         [?]
 *  ret             [?]         [?]         [?]         [?]         [?]         [?]
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_read_line_from_file(U32 filehandle, S8 *buffer, U32 buf_length, U32 *line_length, S32 *ret)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S8 *pos = buffer;
    U32 rd_no = 0;
    U32 count = 0;
    MMI_BOOL CR = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(buffer, 0, buf_length);
    *line_length = 0;

    while (buf_length)
    {
        *ret = FS_Read(filehandle, pos, 1, &rd_no);
        if (*ret < 0)
        {
            *line_length = count;
            return;
        }
        else if (rd_no != 1)
        {
            *line_length = count;
            return;
        }
        else
        {
            count++;
            if (*pos == '\r')
            {
                CR = MMI_TRUE;
            }
            else if (*pos == '\n')
            {
                if (CR == MMI_TRUE)
                {
                    *line_length = count;
                    return;
                }
                else
                {
                    CR = MMI_FALSE;
                }
            }
            else
            {
                CR = MMI_FALSE;
            }
        }
        buf_length--;
        pos++;
    }
    *ret = -1;
    *line_length = rd_no;
    return;
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_check_appId
 * DESCRIPTION
 *  Checks whether the application is registered or not.
 * PARAMETERS
 *  appId       [?]     [?]     [?]     [?]     [?]     [?]
 * RETURNS
 *  MMI_BOOL result
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_check_appId(S8 *appId)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < JSR_MAX_APP_ID_NUM; i++)
    {
        if (jsr_appid_db[i] && jsr_appid_db[i]->appId && (strcmp((S8*) jsr_appid_db[i]->appId, (S8*) appId) == 0))
        {
            return MMI_TRUE;
        }
    }
    return MMI_FALSE;
}
#endif /* __MMI_UMMS_JSR205__ */ 


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_post_message
 * DESCRIPTION
 *  
 * PARAMETERS
 *  MOD_SRC         [IN]        
 *  MOD_DEST        [IN]        
 *  MSG_SAP         [IN]        
 *  MSG_ID          [IN]        
 *  LOCAL           [?]         [?]         [?]         [?]         [?]
 *  PEER            [?]         [?]         [?]         [?]         [?]
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_post_message(
        module_type MOD_SRC,
        module_type MOD_DEST,
        U8 MSG_SAP,
        const U16 MSG_ID,
        void *LOCAL,
        void *PEER)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MYQUEUE Message;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    Message.oslSrcId = MOD_SRC;
    Message.oslDestId = MOD_DEST;
    Message.oslSapId = (sap_type)MSG_SAP;
    Message.oslMsgId = (msg_type)MSG_ID;
    Message.oslDataPtr = LOCAL;
    Message.oslPeerBuffPtr = PEER;
    OslMsgSendExtQueue(&Message);
}

//Testing Stubs start
//wap_mmc_read_folder_status_req_ind_struct folder_status;
//wap_mmc_recv_appmms_rsp_struct recv_struct;
//wap_mmc_delete_msg_req_ind_struct delete_struct;

/* wap_mmc_upload_msg_req_ind_struct upload_struct; */


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_get_active_mms_attachment_req
 * DESCRIPTION
 *  MSG_ID_MMS_GET_ACTIVE_MMS_ATTACHMENT_REQ
 * PARAMETERS
 *  in_msg      [?]         [?]     [?]     [?]
 *  mod_id      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_get_active_mms_attachment_req(void *in_msg, int mod_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mms_get_attachment_req_struct *msg_req;
    mms_get_attachment_rsp_struct *msg_rsp;
    mma_mms_attachment_info_struct *attachment_list = NULL;
    mma_mms_attachment_info_struct *temp;
    mma_mms_object_struct *object_info = NULL;
    U32 num_attachment;

    FS_HANDLE file_handle;
    U16 *object_file = NULL;
    S8 *file_path = NULL;
    mmc_result_enum rsp_result = MMC_RESULT_BUSY;
    U8 flag = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (JSR_CNTX->state == JSR_STATE_IDLE)
    {
        JsrCleanContext();
        msg_req = (mms_get_attachment_req_struct*) in_msg;
        srv_mms_viewer_get_attachment_list(&attachment_list, &num_attachment);

        if ((num_attachment >= 2) && (attachment_list != NULL))
        {
            U8 count = 0;

            temp = attachment_list;

            for (count = 0; count < num_attachment; count++)
            {
                object_info = temp->object;

                /* Check for the required file */
                if (mmi_ucs2cmp((S8*) msg_req->filename, (S8*) object_info->file_name_ucs) == 0)
                {
                    /* File name matched. Set the result as 1. */
                    flag = 1;
                    break;
                }
                /* Move to the next attachment information node */
                temp = temp->next;
            }
        }
        /* Ashok no need to check for the else case here. */
        /* As in the else case, the flag parameter is already 0 in else case */
        if (flag == 0)
        {
            /* Case of above if condition is true but required file not found */
            rsp_result = MMC_RESULT_INVALID_PARAMETER;
            goto SEND_RSP;
        }

        if (object_info->is_virtual_file)
        {
            object_file = (U16*) srv_mms_mem_mgr_app_adm_alloc(SRV_MMS_VIEWER_VFN_NUM_OF_WCHAR * ENCODING_LENGTH);
            if (object_file == NULL)
            {
                rsp_result = MMC_RESULT_INSUFFICIENT_MEMORY;
                goto SEND_RSP;
            }
            file_handle = FS_Open(object_info->file_path_ucs, FS_READ_ONLY | FS_OPEN_SHARED);
            if (file_handle < 0)
            {
                rsp_result = MMC_RESULT_FILE_OPERATION_ERROR;
                goto SEND_RSP;
            }

            FS_GenVirtualFileName(
                file_handle,
                object_file,
                (unsigned int)FS_GenVFN_SIZE,
                object_info->offset,
                object_info->size);

            if (MMI_TRUE == srv_mms_jsr_get_file_name(&file_path, (S8*) object_info->file_name_ucs))
            {
                FS_Delete((U16*) file_path);
                JSR_CNTX->file_handle = file_handle;
                JSR_CNTX->file_path = file_path;
                JSR_CNTX->object_file = object_file;
                JSR_CNTX->dest_mod_id = mod_id;

                srv_fmgr_async_copy(
                    (WCHAR*) object_file,
                    (WCHAR*) file_path,
                    0,
                    srv_mms_jsr_file_copy_callback_proc,
                    NULL);
                return;
            }
            else
            {
                rsp_result = MMC_RESULT_FILE_OPERATION_ERROR;
                FS_Close(file_handle);
            }
        }
        else
        {
            msg_rsp = (mms_get_attachment_rsp_struct*) OslConstructDataPtr(sizeof(mms_get_attachment_rsp_struct));
            msg_rsp->result = MMC_RESULT_OK;
            mmi_ucs2cpy((S8*) msg_rsp->filepath, (S8*) object_info->file_path_ucs);
            srv_mms_jsr_post_message(
                MOD_MMI,
                (module_type)mod_id,
                0,
                MSG_ID_MMS_GET_ACTIVE_MMS_ATTACHMENT_RSP,
                (oslParaType*) msg_rsp,
                NULL);
            return;
        }
    }
  SEND_RSP:
    if (object_file != NULL)
    {
        srv_mms_mem_mgr_app_adm_free(object_file);
    }
    msg_rsp = (mms_get_attachment_rsp_struct*) OslConstructDataPtr(sizeof(mms_get_attachment_rsp_struct));
    msg_rsp->result = rsp_result;
    srv_mms_jsr_post_message(
        MOD_MMI,
        (module_type)mod_id,
        0,
        MSG_ID_MMS_GET_ACTIVE_MMS_ATTACHMENT_RSP,
        (oslParaType*) msg_rsp,
        NULL);

}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_file_copy_callback_proc
 * DESCRIPTION
 *  Temporary File Save response handling and send
 *  MSG_ID_MMS_GET_ACTIVE_MMS_ATTACHMENT_RSP
 * PARAMETERS
 *  msg     [IN]        Variable stores the result of copy
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret srv_mms_jsr_file_copy_callback_proc(mmi_event_struct *msg)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_fmgr_async_done_event_struct *async_evt = (srv_fmgr_async_done_event_struct*) msg;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (msg->evt_id)
    {
        case EVT_ID_SRV_FMGR_ASYNC_DONE:
        {
            mms_get_attachment_rsp_struct *msg_rsp;

            async_evt = (srv_fmgr_async_done_event_struct*) msg;
            msg_rsp = (mms_get_attachment_rsp_struct*) OslConstructDataPtr(sizeof(mms_get_attachment_rsp_struct));
            if (async_evt->result >= 0)
            {
                mmi_ucs2cpy((S8*) msg_rsp->filepath, (S8*) JSR_CNTX->file_path);
                msg_rsp->result = MMC_RESULT_OK;
            }
            else
            {
                msg_rsp->result = MMC_RESULT_FILE_OPERATION_ERROR;
            }

            srv_mms_jsr_post_message(
                MOD_MMI,
                (module_type)JSR_CNTX->dest_mod_id,
                0,
                MSG_ID_MMS_GET_ACTIVE_MMS_ATTACHMENT_RSP,
                (oslParaType*) msg_rsp,
                NULL);
            JsrCleanContext();
            break;
        }
    }
    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_get_file_name
 * DESCRIPTION
 *  To generate temp Object File Name
 * PARAMETERS
 *  file_path       [IN]        
 *  file_name       [IN]        
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
MMI_BOOL srv_mms_jsr_get_file_name(S8 **const file_path, S8 const *const file_name)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    U16 path_buf[(SRV_FMGR_PATH_MAX_LEN + 1)] = {0};
    U32 fpath_len = 0;
    S32 fsHandle = -1;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    kal_wsprintf(path_buf, "%c:\\%s\\", SRV_FMGR_PUBLIC_DRV, JSR_FOLDER_NAME);

    fsHandle = FS_Open((WCHAR*) path_buf, FS_READ_ONLY | FS_OPEN_SHARED | FS_OPEN_DIR);
    if (fsHandle <= 0)
    {
        if (FS_CreateDir(path_buf) < 0)
        {
            return MMI_FALSE;
        }
    }
    else
    {
        FS_Close(fsHandle);
    }

    mmi_ucs2cat((PS8) path_buf, (PS8) ATTACHMENT_FILE);
    fpath_len = (mmi_ucs2strlen((S8*) path_buf) + 1) * ENCODING_LENGTH;
    *file_path = (S8*) srv_mms_mem_mgr_app_adm_alloc(fpath_len);
    if (*file_path == NULL)
    {
        return MMI_FALSE;
    }

    mmi_ucs2cpy((S8*) * file_path, (S8*) path_buf);
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  srv_mms_init_jsr_folder
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_init_jsr_folder(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    FS_HANDLE file_handle;
    S32 result;
    U8 folder_path[MMA_MAX_INTERNAL_FILENAME_LENGTH];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(folder_path, 0, MMA_MAX_INTERNAL_FILENAME_LENGTH);
    SRV_MMS_MAKE_JSR_FOLDER_PATH(folder_path);

    /* if the dir exists, delete it */
    file_handle = FS_Open((WCHAR*) folder_path, FS_OPEN_DIR | FS_READ_ONLY);
    if (file_handle >= 0)
    {
        S32 file_counts = 0;

        FS_Close(file_handle);
        file_counts = FS_Count((WCHAR*) folder_path, FS_FILE_TYPE, NULL, 0);
        if (file_counts > 0)
        {
            FS_XDelete((WCHAR*) folder_path, FS_FILE_TYPE | FS_DIR_TYPE | FS_RECURSIVE_TYPE, NULL, 0);
        }
        else
        {
            FS_SetAttributes((unsigned short*)folder_path, FS_ATTR_DIR | FS_ATTR_HIDDEN);
            return;
        }
    }

    result = FS_CreateDir((WCHAR*) folder_path);

    if (result < 0)
    {
        MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_INIT_JSR_FOLDER, __LINE__);
    }

    FS_SetAttributes((unsigned short*)folder_path, FS_ATTR_DIR | FS_ATTR_HIDDEN);
    return;
}

#ifdef __MMI_UMMS_JSR205__


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_translate_bgsr_to_mmc_result
 * DESCRIPTION
 *  
 * PARAMETERS
 *  result      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
mmc_result_enum srv_mms_jsr_translate_bgsr_to_mmc_result(U8 result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* add a catcher log */
    MMI_TRACE(MMI_INET_TRC_G6_MMS, MMI_JSR_TRANSLATE_BGSR_ERROR, result);

    switch (result)
    {
        case SRV_MMS_BGSR_RESULT_OK:
            return MMC_RESULT_OK;
        case SRV_MMS_BGSR_RESULT_FAIL_NOT_READY:
            return MMC_RESULT_MMS_NO_READY;
        case SRV_MMS_BGSR_RESULT_FAIL_INCALL:
            return MMC_RESULT_ACCESS_DENY;
        default:
            return MMC_RESULT_ERROR;
    }
}
#endif /* __MMI_UMMS_JSR205__ */ 


/*****************************************************************************
 * FUNCTION
 *  srv_mms_jsr_testing
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void srv_mms_jsr_testing(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    /*    wap_mmc_upload_msg_req_ind_struct upload_struct;
       //       mmi_ucs2cpy(upload_struct.filePath,"D\0:\0\\\0t\0e\0m\0p\0.\0m\0");
       mmi_ucs2cpy((S8*)upload_struct.filePath,(S8*)"D\0:\0\\\0t\0e\0s\0t\0.\0m\0m\0s"); 
       srv_mms_jsr_upload_msg_req_hldr(&upload_struct, MOD_L4C); */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* pre_srv_mms_jsr_get_msg_content_req(); */
    //{
    //        wap_mmc_read_folder_status_req_ind_struct Message;

    //        Message.folderId = JSR_INBOX;
    //        Message.retrievalMode = JSR_FULL;
    //        srv_mms_jsr_read_folder_status_req_hldr(&Message);

    //              wap_mmc_upload_msg_req_ind_struct upload_struct;
    //              mmi_ucs2cpy((S8*)upload_struct.filePath,(S8*)"C\0:\0\\\0t\0e\0m\0p\0.\0m\0");
    //              srv_mms_jsr_upload_msg_req_hldr(&upload_struct);

    /* srv_mms_jsr_um_refresh_ind(JSR_DRAFTS); */
#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif /* 0 */ 
#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif /* 0 */ 
#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif /* 0 */ 
}

/* Testing Stubs end. */
#endif /* defined(MMS_SUPPORT) */ 

#endif /* __MMI_MMS_2__ */ 

