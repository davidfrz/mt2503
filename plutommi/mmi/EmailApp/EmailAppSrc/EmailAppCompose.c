/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*******************************************************************************
 * Filename:
 * ---------
 * EmailAppMain.c
 *
 * Project:
 * --------
 * MAUI
 *
 * Description:
 * ------------
 * 
 *
 * Author:
 * -------
 * 
 *
 *==============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!! 
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!! 
 *==============================================================================
 *******************************************************************************/
#include "MMI_features.h"

#ifdef __MMI_EMAIL__

#include "CommonScreens.h"
#include "custom_events_notify.h"

#include "conversions.h"
#include "Inlinecuigprot.h"
#include "Fseditorcuigprot.h"
#include "Menucuigprot.h"
#include "PhbCuiGprot.h"
#include "Filemgrcuigprot.h"
#include "filemgrsrvgprot.h"
#ifdef __MMI_IMAGE_VIEWER__
#include "Imageviewcuigprot.h"
#endif /* __MMI_IMAGE_VIEWER__ */
#include "MediaAppGProt.h"

#ifdef __DRM_SUPPORT__
#include "Drm_gprot.h"
#include "RightsMgrGProt.h"
#endif /* __DRM_SUPPORT__ */

#include "mmi_rp_menu_misc_def.h"
#include "wgui_categories_util.h"
#ifdef __USB_IN_NORMAL_MODE__
#include "USBDeviceGprot.h"
#include "USBSrvGProt.h"
#endif

#include "EmailSrvGprot.h"
#include "EmailAppMem.h"
#include "EmailAppAccount.h"
#include "EmailAppGProt.h"
#include "EmailAppProt.h"
#include "EmailAppCore.h"

#include "MMIDataType.h"
#include "customer_ps_inc.h"
#include "kal_general_types.h"
#include "GlobalResDef.h"
#include "mmi_rp_app_email_def.h"
#include "drm_def.h"
#include "gui_data_types.h"
#include "mmi_frm_scenario_gprot.h"
#include "string.h"
#include "mmi_frm_mem_gprot.h"
#include "kal_public_api.h"
#include "Unicodexdcl.h"
#include "fs_type.h"
#include "fs_func.h"
#include "CustDataRes.h"
#include "mmi_frm_events_gprot.h"
#include "wgui_categories_popup.h"
#include "GlobalConstants.h"
#include "fs_errcode.h"
#include "DebugInitDef_Int.h"
#include "mmi_inet_app_trc.h"
#include "kal_trace.h"
#include "gui_typedef.h"
#include "mmi_frm_input_gprot.h"
#include "AlertScreen.h"
#include "wgui_categories_list.h"
#include "ImeGprot.h"
#include "PhbSrvGprot.h"
#include "app_mine.h"
#include "mmi_rp_file_type_def.h"
#ifdef __MMI_RMGR__
#include "mmi_rp_app_rmgr_def.h"
#endif
#include "mmi_res_range_def.h"
#include "MediaPlayerGProt.h"
#include "CbmCuiGprot.h"
#include "CbmSrvGprot.h"
#include "wgui_touch_screen.h"
#include "wgui_categories.h"

#include "EmailAppNetwork.h"
#include "EmailAppStateMgr.h"
#include "EmailAppLib.h"

#ifdef __MMI_FTE_SUPPORT__
#define __MMI_EMAIL_INLINE_EDIT__
#endif

/************************************************************************/
/*                   defines                                            */
/************************************************************************/

typedef enum
{
    MMI_EMAIL_COMP_FIRST_HILIT_OTHER = 0,
    MMI_EMAIL_COMP_FIRST_HILIT_TO,
    MMI_EMAIL_COMP_FIRST_HILIT_CONTENT
} email_app_comp_first_hilit_item_enum;


typedef enum
{
    MMI_EMAIL_COMP_ADDR_CT_TO,
    MMI_EMAIL_COMP_ADDR_CT_CC,
    MMI_EMAIL_COMP_ADDR_CT_BCC,
    MMI_EMAIL_COMP_ADDR_CT_ALL
} email_app_comp_addr_ct_enum;


// Should greater than MMI_EMAIL_MAX_ADDR_NUM
#define MMI_EMAIL_MAX_RECENT_INPUT_NUM 50 
#define MMI_EMAIL_MAX_RECENT_INPUT_VERSION 0x20101114 

typedef struct
{
    // Version control, if either one of these changes, invalid the file.
    S32 max_addr_len, max_addr_num; 

    S32 curr_addr_num; // current valid item number
    U32 version;

    // recent input email address array.
    WCHAR addr[MMI_EMAIL_MAX_RECENT_INPUT_NUM][SRV_EMAIL_MAX_ADDR_LEN + 1]; 
    U8 state[MMI_EMAIL_MAX_RECENT_INPUT_NUM]; /* 0 for uncheck, 1 for checked */
    S32 curr_highlight;
}email_app_recent_input_list_struct;

typedef struct 
{
    mmi_id parent_id;
    mmi_id grp_id;
    mmi_id inline_id;
    mmi_id option_grp_id;
    mmi_id addr_grp_id;
    mmi_id rinput_grp_id;
    mmi_id attach_grp_id;
    mmi_id phb_cui_id;
    mmi_id viewer_cui_id;
    mmi_id fmgr_cui_id;
    mmi_id fseditor_id;
    mmi_id size_grp_id;
    EMAIL_MSG_ID msg_id;
    EMAIL_FLDR_ID draft_fldr_id;
    EMAIL_FLDR_ID outbox_fldr_id;
    EMAIL_ACCT_ID acct_id;
    EMAIL_MSG_HANDLE msg_handle;
    U8 priority;
    U32 to_num;
    U32 cc_num;
    U32 bcc_num;
    U32 att_num;
    BOOL att_changed; // To remember if new added attachment via FTE TOOLBAR
    
    BOOL is_show_cc_field;
    BOOL is_show_bcc_field;
    BOOL is_show_att_field;
    BOOL is_new_address;
    BOOL is_new_attach;
    BOOL is_close_parent;
    BOOL edit_from_outbox;
    srv_email_addr_struct addr_list[MMI_EMAIL_MAX_ADDR_NUM];
    WCHAR to_display[MMI_EMAIL_MAX_ADDR_DISP_LEN];
    WCHAR cc_display[MMI_EMAIL_MAX_ADDR_DISP_LEN];
    WCHAR bcc_display[MMI_EMAIL_MAX_ADDR_DISP_LEN];
    WCHAR subj[MMI_EMAIL_MAX_SUBJ_LEN + 1];
    WCHAR content[MMI_EMAIL_MAX_CONT_LEN + 1];
    WCHAR attach_display[MMI_EMAIL_MAX_ATT_DISP_LEN + 1];
    email_app_comp_first_hilit_item_enum first_hilit_field;
    email_app_comp_addr_ct_enum change_type;
    mmi_email_prepare_comp_type_enum type;
    email_app_save_part_enum save_part;
    U32 attach_total_size;
    S32 subj_len;
    S32 cont_len;
    U16 curr_item_id;
    S32 curr_hilit_addr_index;
    S32 curr_hilit_attach_index;
} email_app_comp_info_struct;


typedef enum
{
    MMI_EMAIL_COMP_TO_ITEM_ID = (CUI_INLINE_ITEM_ID_BASE + 0),
    MMI_EMAIL_COMP_CC_ITEM_ID,
    MMI_EMAIL_COMP_BCC_ITEM_ID,
    MMI_EMAIL_COMP_SUBJECT_ITEM_ID,
    MMI_EMAIL_COMP_ATTACH_ITEM_ID,
    MMI_EMAIL_COMP_CONTENT_ITEM_ID
} email_app_comp_msg_item_enum;


typedef enum
{
    MMI_EMAIL_COMP_ADDR_FIX_ADD_NEW = 0,
    MMI_EMAIL_COMP_ADDR_FIX_ADD_RECENT,
    MMI_EMAIL_COMP_ADDR_FIX_ADD_PHB,
    MMI_EMAIL_COMP_ADDR_FIX_TOTAL
} email_app_comp_addr_fix_enum;

#define MMI_EMAIL_COMP_TOTAL    (MMI_EMAIL_COMP_CONTENT_ITEM_ID - MMI_EMAIL_COMP_TO_ITEM_ID + 1)
#define MMI_EMAIL_COMP_DEFAULT_ADDR_LIST_ITEM_NUM           MMI_EMAIL_COMP_ADDR_FIX_TOTAL + 1
#define MMI_EMAIL_COMP_DEFAULT_ADDR_HL_WITHOUT_RECP         MMI_EMAIL_COMP_ADDR_FIX_ADD_PHB
#define MMI_EMAIL_COMP_DEFAULT_ADDR_HL_WITH_RECP            MMI_EMAIL_COMP_ADDR_FIX_TOTAL


typedef enum
{
    MMI_EMAIL_COMP_ATTACH_ADD_NEW = 0,
    MMI_EMAIL_COMP_ATTACH_FIX_TOTAL
} email_app_comp_attach_fix_enum;


#define MMI_EMAIL_COMP_DEFAULT_ATTACH_LIST_ITEM_NUM         MMI_EMAIL_COMP_ATTACH_FIX_TOTAL + 1
#define MMI_EMAIL_COMP_DEFAULT_ATTACH_HL_WITHOUT_ITEM       MMI_EMAIL_COMP_ATTACH_ADD_NEW
#define MMI_EMAIL_COMP_DEFAULT_ATTACH_HL_WITH_ITEM          MMI_EMAIL_COMP_ATTACH_FIX_TOTAL

#ifdef __MMI_FTE_SUPPORT__
#define MMI_EMAIL_COMP_TB_SEND_MESSAGE                      0
#define MMI_EMAIL_COMP_TB_ATTACHMENT                        1
#define MMI_EMAIL_COMP_TB_TOTAL                             2
#endif /* __MMI_FTE_SUPPORT__ */

/* copy attach */
typedef void (*mmi_email_comp_cp_att_callback)(BOOL result);

/************************************************************************/
/*                          Variables                                   */
/************************************************************************/

#if ((defined __MMI_EMAIL_CREATE_UE__) || (defined __MMI_EMAIL_INLINE_EDIT__))
static cui_inline_item_softkey_struct email_comp_softkey_struct = {{
    {STR_GLOBAL_OPTIONS, IMG_GLOBAL_OPTIONS},
    {CUI_INLINE_SOFTKEY_DEFAULT_VALUE, CUI_INLINE_SOFTKEY_DEFAULT_VALUE},
    {0, CUI_INLINE_SOFTKEY_DEFAULT_VALUE}}};
#else
static cui_inline_item_softkey_struct email_comp_softkey_struct = {{
    {STR_GLOBAL_OPTIONS, IMG_GLOBAL_OPTIONS},
    {STR_GLOBAL_BACK, IMG_GLOBAL_BACK},
    {0, CUI_INLINE_SOFTKEY_DEFAULT_VALUE}}};
#endif

static cui_inline_set_item_struct email_comp_inline_item[MMI_EMAIL_COMP_TOTAL] = {0};
static cui_inline_struct email_comp_inline_struct = {0};

#ifdef __MMI_EMAIL_CREATE_UE__
static cui_inline_item_text_edit_struct email_comp_text_edit_struct = {0};
static cui_inline_item_display_only_struct email_comp_display_only_struct = {0};
static cui_inline_item_multiline_edit_struct email_comp_multiline_edit_struct = {0};
#else
static cui_inline_item_display_only_struct email_comp_display_only_struct[MMI_EMAIL_COMP_TOTAL - 1] = {0};
#ifndef __MMI_EMAIL_INLINE_EDIT__
static cui_inline_item_multiline_rdonly_struct email_comp_multi_rdonly_struct = {0};
#endif
#endif

#ifdef __MMI_EMAIL_INLINE_EDIT__
static cui_inline_item_text_edit_struct email_comp_text_edit_subject_struct = {0, 0, 127, IMM_INPUT_TYPE_SENTENCE, 7};
static cui_inline_item_multiline_edit_struct email_comp_multiline_edit_content_struct = {0, 1024, IMM_INPUT_TYPE_SENTENCE, 7};
#endif /* __MMI_EMAIL_INLINE_EDIT__ */

static email_app_comp_info_struct email_app_comp;
static srv_email_attach_struct attach_info_array[MMI_EMAIL_MAX_ATTACH_NUMBER];
static WCHAR selected_file_path[SRV_FMGR_PATH_MAX_LEN + 1];
static WCHAR edit_buff[MMI_EMAIL_MAX_CONT_LEN + 1];
static mmi_menu_id email_app_comp_addr_search[] = {MENU_ID_EMAIL_COMP_ADDR_SEARCH};
static mmi_menu_id email_app_comp_cont_insert[] = {MENU_ID_EMAIL_COMP_CONT_INSERT};
static srv_email_addr_struct email_editing_addr_buff;
static email_app_save_send_proc_struct email_app_save_send;
static mmi_id email_comp_select_acct_grp_id;
static vobj_email_cb vobj_callback = NULL;      /* callback function for PHB to delete temporary file and release memory */
static void *vobj_buff = NULL;                  /* input memory buffer pointer */
static U8 email_comp_selected_index = 0;
static EMAIL_ACCT_ID email_comp_acct_id_array[MMI_EMAIL_MAX_ACCTS];
static WCHAR email_comp_acct_name[MMI_EMAIL_MAX_ACCTS][SRV_EMAIL_MAX_ACCT_NAME_LEN + 1];
static mmi_email_app_send_param_struct email_comp_mail_param;
static email_app_send_param_fill_enum email_comp_mail_param_fill_flag;
static mmi_email_app_send_param_struct *email_comp_acct_select_mail_param;
static email_app_send_param_fill_enum email_comp_acct_select_mail_param_fill_flag;
static WCHAR email_ss_loading_str[100];
//static BOOL email_ss_is_show = FALSE;
static BOOL is_email_comp_close_screen = FALSE;

#ifdef __MMI_ICON_BAR_SUPPORT__
static PU8 email_toolbar_content_icon[MMI_EMAIL_MAX_TB_NUMBER] = {NULL, NULL, NULL};
static PU8 email_toolbar_disabled_content_icon[MMI_EMAIL_MAX_TB_NUMBER] = {NULL, NULL, NULL};
static PU8 email_toolbar_string[MMI_EMAIL_MAX_TB_NUMBER] = {NULL, NULL, NULL};
#endif /* __MMI_ICON_BAR_SUPPORT__ */

static EMAIL_FLDR_ID email_comp_curr_fldr_id = 0;
static EMAIL_MSG_ID email_comp_curr_msg_id = 0;
static WCHAR email_comp_size_string[50] = {0};

static BOOL email_is_drm_file_deleted = FALSE;
static BOOL email_is_recip_too_many = FALSE;
static BOOL email_is_attach_over_size = FALSE;
static BOOL email_is_recip_invalid = FALSE;
static BOOL email_is_sig_fail = FALSE;
static BOOL email_is_sig_empty_file = FALSE;
static BOOL email_is_sig_missing = FALSE;

/* copy attach */
static U32 email_comp_add_attach_done_file_size = 0;
static S32 email_comp_copy_attach_job_id = 0;
static S32 email_comp_copy_attach_index = 0;
static WCHAR *email_comp_copy_attach_dst_path = NULL;
static mmi_email_comp_cp_att_callback email_comp_copy_attach_callback = NULL;

#ifdef __DRM_SUPPORT__
extern CHAR rights_issuer[DRM_MAX_URL_LENGTH];
#endif /* __DRM_SUPPORT__ */

static BOOL g_is_asm_created_by_others;
static void *g_memory_pool_ptr = NULL;
static mmi_email_prepare_comp_struct g_asm_comp_data;

static email_app_recent_input_list_struct *g_recent_addr_list_p = NULL;


/************************************************************************/
/*                          Prototypes                                  */
/************************************************************************/
static void mmi_email_prepare_entry_comp_ext(mmi_email_prepare_comp_struct *comp_data);

static void mmi_email_comp_init_inline_item_struct(
                cui_inline_set_item_struct *p_inline_item,
                U16 item_id,
                U32 item_flag,
                U16 image_id,
                void *item_data);
static srv_email_result_enum mmi_email_comp_add_sig_info(mmi_id parent_id, EMAIL_ACCT_ID acct_id);
static mmi_ret mmi_email_comp_group_proc(mmi_event_struct *event);
static void mmi_email_comp_quit_ask_lsk(void);
static void mmi_email_comp_hide_menu(void *comp_data);
static void mmi_email_comp_add_field_to_display(U16 field);
static void mmi_email_comp_option_handler(mmi_menu_id menu_id, mmi_id grp_id);
static mmi_ret mmi_email_comp_size_group_proc(mmi_event_struct *event);
static void mmi_email_comp_size_loading(void);
static void mmi_email_comp_size_callback(MMI_BOOL succ, S32 err_major, S32 err_minor, U32 size, void *user_data);
static void mmi_email_comp_inline_notify(cui_event_inline_notify_struct *event);
static void mmi_email_comp_inline_csk_press(cui_event_inline_csk_press_struct *event);
static void mmi_email_entry_comp(void);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_comp_tap_callback(mmi_tap_type_enum tap_type, S32 index);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

#ifdef __MMI_ICON_BAR_SUPPORT__
static void mmi_email_comp_tb_callback(S32 index);
#endif /* __MMI_ICON_BAR_SUPPORT__ */

static void mmi_email_comp_goto_addr(email_app_comp_addr_ct_enum type);
static void mmi_email_comp_addr_fill_display_info(void);
static mmi_ret mmi_email_comp_addr_proc(mmi_event_struct *evt);
static void mmi_email_entry_comp_addr(void);
static mmi_ret mmi_email_comp_addr_del_callback(mmi_event_struct *evt);
static void mmi_email_comp_addr_hilit_handler(S32 index);
static MMI_BOOL mmi_email_comp_addr_get_seperator_line(S32 index, U32* flag, U32* flag_ex);
static pBOOL mmi_email_comp_addr_get_item(S32 item_index, UI_string_type str_buff, PU8 *img_buff_p, U8 str_img_mask);
static S32 mmi_email_comp_addr_get_item_hint(S32 item_index, UI_string_type *hint_array);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_comp_addr_tap_callback(mmi_tap_type_enum tap_type, S32 index);
#endif

static void mmi_email_comp_addr_add_new(void);
static void mmi_email_comp_addr_add_phb(void);
static void mmi_email_comp_addr_add_recent(void);
static void mmi_email_comp_addr_add_recent_screen(void);
static mmi_ret mmi_email_comp_addr_add_recent_proc(mmi_event_struct *evt);
static void mmi_email_comp_addr_add_recent_highlight_hdlr(S32 idx);
static void mmi_email_comp_addr_add_recent_option_lsk(void);
static void mmi_email_comp_addr_add_recent_option_csk(void);
static void mmi_email_comp_addr_add_recent_option_rsk(void);
static void mmi_email_comp_addr_add_recent_option_hide(mmi_id grp_id);
static void mmi_email_comp_addr_add_recent_option_action(mmi_id menu_id);
static void mmi_email_comp_addr_recent_change_state(void);
static void mmi_email_comp_asm_ready(void);
static void *mmi_email_comp_asm_create(void);
static void mmi_email_comp_asm_destroy(void);

static S32 mmi_email_comp_addr_recent_num_checked(void);
static S32 mmi_email_comp_addr_recent_num_input(void);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
void mmi_email_comp_addr_add_recent_fte_tap_callback(mmi_tap_type_enum tap_type, S32 index);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

#ifdef __MMI_TOUCH_SCREEN__
static void mmi_note_mark_several_pen_down(void);
#endif

static void mmi_email_comp_addr_add_recent_load(void);
static void mmi_email_comp_addr_add_recent_save(void);
static void mmi_email_comp_addr_add_recent_free(void);

static void mmi_email_comp_addr_addr_recent_add_single(WCHAR addr_w[SRV_EMAIL_MAX_ADDR_LEN + 1]);
static void mmi_email_comp_addr_addr_recent_add_multy(void);

static void mmi_email_comp_send(void);
static void mmi_email_comp_addr_edit(void);
static void mmi_email_comp_addr_opt(void);
static void mmi_email_comp_addr_add_to_list(void);
static void mmi_email_comp_addr_update_item(void);
#ifdef __MMI_EMAIL_CREATE_UE__
static void mmi_email_comp_addr_change_item_type(void);
#endif
static void mmi_email_comp_addr_del_from_list(void);
static void mmi_email_comp_addr_del_all(void);
static void mmi_email_comp_addr_hide_menu(void *comp_data, mmi_id option_id);
static void mmi_email_comp_addr_options_handler(void *comp_data, mmi_menu_id menu_id, mmi_id grp_id);
static void mmi_email_comp_edit_subject(void);
static void mmi_email_comp_edit_content(void);
static void mmi_email_comp_get_attach_display_field(EMAIL_MSG_HANDLE msg_handle);
static void mmi_email_comp_attach(void);
static mmi_ret mmi_email_comp_attach_proc(mmi_event_struct *evt);
static void mmi_email_comp_attach_add_new_done(void *evt);
static BOOL mmi_email_comp_attach_fill_new_info(mmi_id parent_id, S32 index, WCHAR *file_path, U32 size);
static void mmi_email_entry_comp_attach(void);
static mmi_ret mmi_email_comp_attach_del_callback(mmi_event_struct *evt);
static void mmi_email_comp_attach_hilit_handler(S32 index);
static MMI_BOOL mmi_email_comp_attach_get_seperator_line(S32 index, U32* flag, U32* flag_ex);
static pBOOL mmi_email_comp_attach_get_item(S32 item_index, UI_string_type str_buff, PU8 *img_buff_p, U8 str_img_mask);
static S32 mmi_email_comp_attach_get_item_hint(S32 item_index, UI_string_type *hint_array);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_comp_attach_tap_callback(mmi_tap_type_enum tap_type, S32 index);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

static void mmi_email_comp_attach_hide_menu(mmi_id option_id);
static void mmi_email_comp_attach_options_handler(mmi_menu_id menu_id, mmi_id grp_id);
static void mmi_email_comp_attach_opt(void);
static void mmi_email_comp_attach_add(void);
static void mmi_email_comp_attach_add_new(mmi_id parent_id);
static void mmi_email_comp_attach_view(void);
static void mmi_email_comp_attach_del(void);
static void mmi_email_comp_attach_del_all(void);

static mmi_ret mmi_email_ss_group_proc(mmi_event_struct *evt);
static void mmi_email_ss_entry_loading(void);
static void mmi_email_ss_general_cancel(void);
static void mmi_email_ss_func_callback(srv_email_result_struct *result, EMAIL_REQ_ID req_id, void *user_data);
//static void mmi_email_ss_proc_callback(srv_email_nwk_proc_struct *data);

static void mmi_email_app_send_attch_from_vobj_free(void);
static mmi_ret mmi_email_comp_acct_select_group_proc(mmi_event_struct *evt);
static void mmi_email_comp_entry_acct_select(void);
static void mmi_email_comp_hilit_acct_handler(S32 index);
static mmi_ret mmi_email_comp_acct_select_end_key(mmi_event_struct *evt);
static void mmi_email_comp_acct_select_lsk(void);
static BOOL mmi_email_app_send_file_check(
                WCHAR *filePath,
                email_app_send_param_fill_enum mail_param_fill_flag);
static void mmi_email_app_send_copy_param(
                mmi_email_app_send_param_struct *dst_mail_param,
                email_app_send_param_fill_enum *dst_mail_param_fill_falg,
                mmi_email_app_send_param_struct *mail_param,
                email_app_send_param_fill_enum mail_param_fill_flag);
static void mmi_email_app_send_copy_addr(
                mmi_email_app_send_addr_struct *addr_param,
                mmi_email_app_send_addr_struct *addr_dest);
static void mmi_email_app_send_copy_subj(WCHAR *subj, WCHAR **dst_subj);
static void mmi_email_app_send_copy_cont(WCHAR *cont, WCHAR **dst_cont);
static BOOL mmi_email_app_check_send_addr(mmi_email_app_send_param_struct *mail_param);
static void mmi_email_app_send_free_mem(void);
static void mmi_email_app_send_free_mem_ext(void);
static void mmi_email_app_exec_send(void);
static void mmi_email_app_exec_send_ext(void);
static BOOL mmi_email_app_send_fill_data(void);
static mmi_ret mmi_email_app_to_addr_group_proc(mmi_event_struct *event);
static void mmi_email_app_entry_send_file_to_addr(void);
static void mmi_email_comp_send_to_addr_option_handler(mmi_menu_id menu_id, mmi_id grp_id);

static void mmi_email_comp_copy_to_view_attach(WCHAR *new_file_path);
/* copy attach */
static void mmi_email_comp_copy_attach_done_entry_comp(BOOL result);
static void mmi_email_comp_copy_attach_loading(void);
static void mmi_email_comp_copy_attach_cancel(void);
static mmi_ret mmi_email_comp_copy_attach_del_callback(mmi_event_struct *evt);
static void mmi_email_comp_pre_copy_attach(S32 index, WCHAR *file_path);
static void mmi_email_comp_copy_attach_next(void);
static void mmi_email_comp_get_free_attach_filename(WCHAR *filename);
static void mmi_email_comp_copy_attach(WCHAR *file_path);
static mmi_ret mmi_email_comp_copy_attach_ret_callback(mmi_event_struct *param);
static void mmi_email_comp_add_attach_done_copy_ret_handler(BOOL result);
static void mmi_email_comp_to_addr_add_attach_done_copy_ret_handler(BOOL result);


/************************************************************************/
/*                           Implements                                 */
/************************************************************************/
srv_email_addr_struct *mmi_email_comp_get_addlist(void)
{
    return email_app_comp.addr_list;
}

srv_email_attach_struct *mmi_email_comp_get_attlist(void)
{
    return attach_info_array;
}

WCHAR *mmi_email_comp_get_content_buffer(void)
{
    return email_app_comp.content;
}

void mmi_email_reset_curr_comp_info(void)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_RESET_CURR_COMP_INFO, __LINE__);

    email_app_comp.att_num = 0;
    if (email_comp_select_acct_grp_id)
    {    
        mmi_frm_group_close(email_comp_select_acct_grp_id);
    }
    if (email_app_comp.phb_cui_id)
    {
        cui_phb_list_select_contact_close(email_app_comp.phb_cui_id);
        email_app_comp.phb_cui_id = 0;
    }
    if (email_app_comp.fseditor_id)
    {
        cui_fseditor_close(email_app_comp.fseditor_id);
        email_app_comp.fseditor_id = 0;
    }
    if (email_app_comp.fmgr_cui_id)
    {
        cui_file_selector_close(email_app_comp.fmgr_cui_id);
        email_app_comp.fmgr_cui_id = 0;
    }
#ifdef __MMI_IMAGE_VIEWER__
    if (email_app_comp.viewer_cui_id)
    {
        cui_imgview_close(email_app_comp.viewer_cui_id);
        email_app_comp.viewer_cui_id = 0;
    }
#endif /* __MMI_IMAGE_VIEWER__ */
    if (email_app_comp.inline_id)
    {
        cui_inline_close(email_app_comp.inline_id);
        email_app_comp.inline_id = 0;
    }
    mmi_email_exit_save_send();
    if (email_app_comp.msg_handle)
    {
        srv_email_msg_destroy(email_app_comp.msg_handle);
        email_app_comp.msg_handle = 0;
    }

    if (email_app_comp.grp_id)
    {
        mmi_frm_group_close(email_app_comp.grp_id);
        email_app_comp.grp_id = 0;
    }

    memset(&email_app_comp, 0, sizeof(email_app_comp_info_struct));
    memset(attach_info_array, 0, sizeof(attach_info_array));
}


void mmi_email_comp_save_send_callback(BOOL result, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_SAVE_SEND_CALLBACK, __LINE__);

    if ((result) ||
        (is_email_comp_close_screen))
    {
        mmi_frm_group_close(email_app_comp.grp_id);
    }
}


void mmi_email_comp_fill_sender_info(EMAIL_MSG_HANDLE msg_handle)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_acct_info_struct *acct_info = NULL;
    EMAIL_ACCT_HANDLE acct_handle = 0;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_FILL_SENDER_INFO, __LINE__);

    result = srv_email_acct_create(0, &acct_handle);
    result = srv_email_acct_open(acct_handle, email_app_comp.acct_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        srv_email_acct_destroy(acct_handle);
        return;
    }
    acct_info = OslMalloc(sizeof(srv_email_acct_info_struct));
    result = srv_email_acct_read(acct_handle, acct_info);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        srv_email_acct_destroy(acct_handle);
        OslMfree(acct_info);
        return;
    }
    srv_email_acct_destroy(acct_handle);
    if (mmi_wcslen(acct_info->reply_to_addr.email_addr))
    {
        result = srv_email_msg_update_reply_to(
                    msg_handle,
                    &(acct_info->reply_to_addr));
    }
    if (mmi_wcslen(acct_info->email_addr.email_addr))
    {
        result = srv_email_msg_update_sender(
                    msg_handle,
                    &(acct_info->email_addr));
    }
    OslMfree(acct_info);
}


static void mmi_email_comp_init_inline_item_struct(
                cui_inline_set_item_struct *p_inline_item,
                U16 item_id,
                U32 item_flag,
                U16 image_id,
                void *item_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_INIT_INLINE_ITEM_STRUCT, __LINE__);

    p_inline_item->item_id = item_id;
    p_inline_item->item_flag = item_flag;
    p_inline_item->image_id = image_id;
    p_inline_item->item_data = item_data;
}


static srv_email_result_enum mmi_email_comp_add_sig_info(mmi_id parent_id, EMAIL_ACCT_ID acct_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_app_core_result_enum result = MMI_EMAIL_SUCCESS;
    MMI_BOOL status = MMI_FALSE;
    mmi_email_sig_struct *sig_info = NULL;
    U16 index = email_app_comp.att_num, sig_index = 0, j = 0;
    U32 size = 0;
    FS_HANDLE handle = 0;
    WCHAR *temp_cont = NULL;
    srv_email_msg_update_content_struct cont_buf;
    WCHAR line[] = {0x0A, 0x00};
#ifdef __DRM_SUPPORT__
    S32 fwd_flag = 0;
#endif /* __DRM_SUPPORT__ */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADD_SIG_INFO, __LINE__);

    result = mmi_email_sig_get_status(acct_id, &status);
    if (result != MMI_EMAIL_SUCCESS)
    {
        return SRV_EMAIL_RESULT_SUCC;
    }
    if (!status)
    {
        return SRV_EMAIL_RESULT_SUCC;
    }
    sig_info = OslMalloc(sizeof(mmi_email_sig_struct));
    result = mmi_email_sig_get_signature(acct_id, sig_info);
    if (result != MMI_EMAIL_SUCCESS)
    {
        OslMfree(sig_info);
        return SRV_EMAIL_RESULT_SUCC;
    }
    if (email_app_comp.cont_len)
    {
        temp_cont = email_app_comp.content + email_app_comp.cont_len;
        if (email_app_comp.cont_len + mmi_wcslen(sig_info->text) + mmi_wcslen(line) <= MMI_EMAIL_MAX_CONT_LEN)
        {
            mmi_wcscpy(temp_cont, line);
            temp_cont += mmi_wcslen(line);
            mmi_wcscpy(temp_cont, sig_info->text);
            email_app_comp.cont_len += mmi_wcslen(sig_info->text) + mmi_wcslen(line);
        }
    }
    else
    {
        mmi_wcscpy(email_app_comp.content, sig_info->text);
        email_app_comp.cont_len += mmi_wcslen(sig_info->text);
    }
    cont_buf.buff = email_app_comp.content;
    cont_buf.buff_len = email_app_comp.cont_len + 1;
    cont_buf.buff_type = MMI_TRUE;
    cont_buf.charset = MMI_CHSET_UCS2;
    srv_email_msg_update_content(
        email_app_comp.msg_handle,
        &cont_buf);
    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_CON;
    for (; j < sig_info->image_num; j++)
    {
        memset(selected_file_path, 0, sizeof(selected_file_path));
        size = 0;
        result = mmi_email_sig_get_image_path(acct_id, sig_index, selected_file_path, SRV_FMGR_PATH_MAX_LEN);
        if (result != MMI_EMAIL_SUCCESS)
        {
            goto SIG_RET;
        }
        handle = FS_Open((U16*)selected_file_path, FS_READ_ONLY | FS_OPEN_SHARED);
        if (handle > 0)
        {
            FS_GetFileSize(handle, &size);
            FS_Close(handle);
            email_is_sig_missing = FALSE;
        }
        else
        {
            email_is_sig_missing = TRUE;
            goto SIG_RET;
        }

#ifdef __DRM_SUPPORT__
        fwd_flag = mmi_rmgr_check_forward((U16*)selected_file_path);
        if (!(fwd_flag & MMI_RMGR_USAGE_SEND))
        {
            email_is_drm_file_deleted = TRUE;
            goto SIG_RET;
        }
        if (fwd_flag < 0)
        {
            email_is_sig_missing = TRUE;
            goto SIG_RET;
        }
#endif /* __DRM_SUPPORT__ */

        if (size > MMI_EMAIL_TOTAL_MAX_ATTACH_SIZE)
        {
            email_is_sig_fail = TRUE;
            goto SIG_RET;
        }
        else
        {
            email_is_sig_fail = FALSE;
        }
        if (size == 0)
        {
            email_is_sig_empty_file = TRUE;
            goto SIG_RET;
        }
        else
        {
            email_is_sig_empty_file = FALSE;
        }
        if (!mmi_email_comp_attach_fill_new_info(parent_id, index, selected_file_path, size))
        {
            goto SIG_RET;
        }
        mmi_wcscpy(attach_info_array[index].name, sig_info->image_name[sig_index]);
        attach_info_array[index].name_len = mmi_wcslen(attach_info_array[index].name);
        mmi_email_util_get_mine_type(
            attach_info_array[index].name,
            &attach_info_array[index].mime_type,
            &attach_info_array[index].mime_subtype);
        attach_info_array[index].charset = MMI_CHSET_UCS2;
        attach_info_array[index].downloaded = MMI_TRUE;
        email_app_comp.att_num += 1;
        sig_index += 1;
        index += 1;
        email_app_comp.is_show_att_field = TRUE;
    }
SIG_RET:
    if (email_app_comp.att_num != 0)
    {
        srv_email_result_enum ret = SRV_EMAIL_RESULT_SUCC;
        email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_ATT;
        ret = srv_email_msg_update_attach(
            email_app_comp.msg_handle,
            email_app_comp.att_num,
            attach_info_array);
        if (ret != SRV_EMAIL_RESULT_SUCC)
        {
            OslMfree(sig_info);
            return ret;
        }
        else
        {
            mmi_email_comp_get_attach_display_field(email_app_comp.msg_handle);
        }
    }
    OslMfree(sig_info);
    return SRV_EMAIL_RESULT_SUCC;
}


static void mmi_email_comp_check_reply_address_valid(srv_email_addr_struct *addr_list, U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_addr_struct *temp_addr = OslMalloc(sizeof(srv_email_addr_struct));
    U32 index = 0, valid_count = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_CHECK_REPLY_ADDRESS_VALID, __LINE__);

    for (; index < *count; index++)
    {
        memcpy(temp_addr, &addr_list[index], sizeof(srv_email_addr_struct));
        if (mmi_email_util_chk_addr(temp_addr->email_addr))
        {
            memcpy(&addr_list[valid_count], temp_addr, sizeof(srv_email_addr_struct));
            valid_count++;
        }
        else
        {
            continue;
        }
    }
    if (valid_count < *count)
    {
        memset(&addr_list[valid_count], 0, sizeof(srv_email_addr_struct) * (*count - valid_count));
        email_is_recip_invalid = TRUE;
    }
    *count = valid_count;
    OslMfree(temp_addr);
}


static MMI_BOOL mmi_email_comp_is_duplicate_addr(
                    WCHAR *email_addr,
                    srv_email_addr_struct *addr_list,
                    U32 addr_count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 i = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_IS_DUPLICATE_ADDR, __LINE__);

    for (i = 0; i < addr_count; i++)
    {
        if (!mmi_wcscmp(email_addr, addr_list[i].email_addr))
        {
            return MMI_TRUE;
        }
    }

    return MMI_FALSE;
}


static void *mmi_email_comp_asm_create(void)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ASM_CREATE, __LINE__);

    g_memory_pool_ptr = mmi_email_app_mem_get_ptr();
    if (g_memory_pool_ptr == NULL)
    {
        g_is_asm_created_by_others = FALSE;
        g_memory_pool_ptr = mmi_email_app_mem_pool_malloc(MMI_EMAIL_MEM_POOL_SIZE);
        if (g_memory_pool_ptr == NULL)
        {
            mmi_frm_appmem_prompt_to_release_mem(
                APPLIB_MEM_AP_ID_EMAIL,
                0,
                MMI_EMAIL_MEM_POOL_SIZE,
                mmi_email_comp_asm_ready);
            return NULL;
        }
    }
    else
    {
        g_is_asm_created_by_others = TRUE;
    }

    return g_memory_pool_ptr;
}

static void mmi_email_comp_asm_destroy(void)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ASM_DESTROY, __LINE__);

    /* Free ASM */
    if (!g_is_asm_created_by_others)
    {
        if (mmi_email_app_mem_get_ptr() != NULL)
        {
            mmi_email_app_mem_pool_free(g_memory_pool_ptr);
        }
        g_is_asm_created_by_others = FALSE;
        g_memory_pool_ptr = NULL;
    }
}

void mmi_email_comp_asm_stop(void)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ASM_STOP, __LINE__);

    if (email_app_comp.grp_id != 0)
    {
        mmi_frm_group_close(email_app_comp.grp_id);
        email_app_comp.grp_id = 0;
    }
}

static void mmi_email_comp_asm_ready(void)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ASM_READY, __LINE__);

    // Check T card / SIM removed or USB mode etc
    if (!mmi_email_smgr_network_check())
    {
        return;
    }

    mmi_email_app_exec_send_ext();
}

void mmi_email_prepare_entry_comp(mmi_email_prepare_comp_struct *comp_data)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PREPARE_ENTRY_COMP, __LINE__);

    /* Create ASM again */
    if (mmi_email_app_mem_get_ptr() == NULL)
    {
        /* create it */
        g_is_asm_created_by_others = FALSE;
        g_memory_pool_ptr = mmi_email_app_mem_pool_malloc(MMI_EMAIL_MEM_POOL_SIZE);
        if (g_memory_pool_ptr == NULL)
        {
            mmi_frm_appmem_prompt_to_release_mem(
                APPLIB_MEM_AP_ID_EMAIL,
                0,
                MMI_EMAIL_MEM_POOL_SIZE,
                mmi_email_comp_asm_ready);
            if (comp_data)
            {
                memcpy(&g_asm_comp_data, comp_data, sizeof(mmi_email_prepare_comp_struct));
            }
            else
            {
                memset(&g_asm_comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
            }
            return;
        }
    }

    mmi_email_comp_addr_add_recent_load();
    if (g_recent_addr_list_p == NULL)
    {
        return;
    }

    email_app_comp.grp_id = 0;
    mmi_email_prepare_entry_comp_ext(comp_data);
    if (email_app_comp.grp_id == 0)
    {
        mmi_email_comp_addr_add_recent_free();
        mmi_email_comp_asm_destroy();
    }
}

static void mmi_email_prepare_entry_comp_ext(mmi_email_prepare_comp_struct *comp_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    srv_email_msg_get_basic_info_struct *basic_info = NULL;
    srv_email_msg_get_recipient_struct *recp_info = NULL;
    U32 sub_len = 0, cont_len = 0, temp_addr_num = 0;
    S32 sub_char = 0, cont_char = 0;
    EMAIL_MSG_HANDLE msg_handle;
    WCHAR *temp_sub_ptr = NULL;
    S32 fldr_type_array[2] = {SRV_EMAIL_FLDR_TYPE_DRAFT, SRV_EMAIL_FLDR_TYPE_OUTBOX};
    EMAIL_FLDR_ID fldr_id_array[2] = {0};
    srv_email_msg_update_basic_info_struct *basic_update = NULL;
    S8 cont_state = 0;
    S8 html_state = 0;

#ifdef __MMI_EMAIL_HTML__    
    WCHAR *read_html_cont = NULL;
#endif /* __MMI_EMAIL_HTML__ */

    EMAIL_ACCT_HANDLE acct_handle = EMAIL_ACCT_INVALID_HANDLE;
    srv_email_acct_info_struct *acct_info_p = NULL;
    WCHAR email_addr[SRV_EMAIL_MAX_ADDR_LEN + 1];
    U32 i = 0;
    BOOL ret_fill = FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PREPARE_ENTRY_COMP_EXT, __LINE__);

    if ((comp_data->type == EMAIL_PRE_COMP_TYPE_NEW) ||
        (comp_data->type == EMAIL_PRE_COMP_TYPE_TEMPLATE) ||
        (comp_data->type == EMAIL_PRE_COMP_TYPE_EXTRACT) ||
        (comp_data->type == EMAIL_PRE_COMP_TYPE_ADDR_SEND))
    {
        memset(&email_app_comp, 0, sizeof(email_app_comp_info_struct));
        memset(attach_info_array, 0, sizeof(attach_info_array));
        email_app_comp.priority = EMAIL_MSG_PRIO_MED;
        email_app_comp.parent_id = comp_data->parent_id;
        email_app_comp.acct_id = comp_data->acct_id;
        email_app_comp.first_hilit_field = MMI_EMAIL_COMP_FIRST_HILIT_TO;
        mmi_email_util_get_fldr_id_by_acct(
            comp_data->acct_id,
            2,
            fldr_type_array,
            fldr_id_array);
        email_app_comp.draft_fldr_id = fldr_id_array[0];
        email_app_comp.outbox_fldr_id = fldr_id_array[1];
        result = srv_email_msg_create(0, &msg_handle);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(comp_data->parent_id, result);
            return;
        }
        result = srv_email_msg_set_new(msg_handle);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(comp_data->parent_id, result);
            srv_email_msg_destroy(msg_handle);
            return;
        }
        email_app_comp.msg_handle = msg_handle;

        if (comp_data->type == EMAIL_PRE_COMP_TYPE_TEMPLATE)
        {
            srv_email_msg_update_content_struct cont_buf;
            WCHAR *temp_cont = NULL;
            temp_cont = mmi_email_get_template_content();
            if (temp_cont)
            {
                mmi_wcscpy(email_app_comp.content, temp_cont);
                email_app_comp.cont_len = mmi_wcslen(email_app_comp.content);
                cont_buf.buff = email_app_comp.content;
                cont_buf.buff_len = email_app_comp.cont_len + 1;
                cont_buf.buff_type = MMI_TRUE;
                cont_buf.charset = MMI_CHSET_UCS2;
                srv_email_msg_update_content(
                    email_app_comp.msg_handle,
                    &cont_buf);
                email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_CON;
            }
            comp_data->type = EMAIL_PRE_COMP_TYPE_NEW;
        }
        
        result = mmi_email_comp_add_sig_info(comp_data->parent_id, comp_data->acct_id);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(comp_data->parent_id, result);
            srv_email_msg_destroy(msg_handle);
            return;
        }
        mmi_email_comp_fill_sender_info(email_app_comp.msg_handle);
        if (comp_data->type == EMAIL_PRE_COMP_TYPE_EXTRACT)
        {
            WCHAR *temp_addr = NULL;
            temp_addr = mmi_email_read_extract_get_sent_addr();
            if (temp_addr)
            {
                mmi_wcscpy(email_app_comp.addr_list[0].email_addr, temp_addr);
                email_app_comp.addr_list[0].disp_charset = MMI_CHSET_UCS2;
                email_app_comp.to_num += 1;
                if (email_app_comp.addr_list[0].disp_name_len)
                {
                    kal_wsprintf(
                        email_app_comp.to_display,
                        "%w%w%w%w",
                        email_app_comp.addr_list[0].disp_name,
                        g_email_subj_left_op,
                        email_app_comp.addr_list[0].email_addr,
                        g_email_subj_right_op);
                }
                else
                {
                    mmi_wcscpy(email_app_comp.to_display, email_app_comp.addr_list[0].email_addr);
                }
                srv_email_msg_update_recipient(
                    email_app_comp.msg_handle,
                    SRV_EMAIL_ADDR_TYPE_TO,
                    email_app_comp.to_num,
                    email_app_comp.addr_list);
                email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
            }
            comp_data->type = EMAIL_PRE_COMP_TYPE_NEW;
        }
        if (comp_data->type == EMAIL_PRE_COMP_TYPE_ADDR_SEND)
        {
            WCHAR *temp_addr = NULL;
            WCHAR *temp_name = NULL;
            mmi_email_read_recipient_get_sent_addr(&temp_addr, &temp_name);
            if (temp_addr)
            {
                mmi_wcscpy(email_app_comp.addr_list[0].email_addr, temp_addr);
                email_app_comp.addr_list[0].disp_charset = MMI_CHSET_UCS2;
                if (temp_name)
                {
                    mmi_wcscpy(email_app_comp.addr_list[0].disp_name, temp_name);
                    email_app_comp.addr_list[0].disp_name_len = mmi_wcslen(email_app_comp.addr_list[0].disp_name);
                }
                email_app_comp.to_num += 1;
                if (email_app_comp.addr_list[0].disp_name_len)
                {
                    kal_wsprintf(
                        email_app_comp.to_display,
                        "%w%w%w%w",
                        email_app_comp.addr_list[0].disp_name,
                        g_email_subj_left_op,
                        email_app_comp.addr_list[0].email_addr,
                        g_email_subj_right_op);
                }
                else
                {
                    mmi_wcscpy(email_app_comp.to_display, email_app_comp.addr_list[0].email_addr);
                }
                srv_email_msg_update_recipient(
                    email_app_comp.msg_handle,
                    SRV_EMAIL_ADDR_TYPE_TO,
                    email_app_comp.to_num,
                    email_app_comp.addr_list);
                email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
            }
            comp_data->type = EMAIL_PRE_COMP_TYPE_NEW;
        }
        email_app_comp.type = comp_data->type;
        goto ENTRY_COMP;
    }
    else if (comp_data->type == EMAIL_PRE_COMP_TYPE_CONTINUE)
    {
        email_app_comp.parent_id = comp_data->parent_id;
        email_app_comp.acct_id = comp_data->acct_id;
        mmi_email_util_get_fldr_id_by_acct(
            comp_data->acct_id,
            2,
            fldr_type_array,
            fldr_id_array);
        email_app_comp.draft_fldr_id = fldr_id_array[0];
        email_app_comp.outbox_fldr_id = fldr_id_array[1];
        result = srv_email_msg_create(0, &msg_handle);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(comp_data->parent_id, result);
            return;
        }
        result = srv_email_msg_set_new(msg_handle);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(comp_data->parent_id, result);
            srv_email_msg_destroy(msg_handle);
            return;
        }
        email_app_comp.msg_handle = msg_handle;
        email_app_comp.type = comp_data->type;
        ret_fill = mmi_email_app_send_fill_data();
        if (!ret_fill)
        {
            //mmi_email_util_display_error_popup(comp_data->parent_id, result);
            srv_email_msg_destroy(msg_handle);
            return;
        }
        mmi_email_comp_addr_fill_display_info();
        goto ENTRY_COMP;
    }
    else
    {
        result = srv_email_acct_create(0, &acct_handle);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(comp_data->parent_id, result);
            return;
        }

        result = srv_email_acct_open(acct_handle, comp_data->acct_id);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            srv_email_acct_destroy(acct_handle);
            mmi_email_util_display_error_popup(comp_data->parent_id, result);
            return;
        }

        acct_info_p = (srv_email_acct_info_struct*)OslMalloc(sizeof(srv_email_acct_info_struct));
        result = srv_email_acct_read(acct_handle, acct_info_p);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            OslMfree(acct_info_p);
            srv_email_acct_destroy(acct_handle);
            mmi_email_util_display_error_popup(comp_data->parent_id, result);
            return;
        }

        mmi_wcscpy(email_addr, acct_info_p->email_addr.email_addr);
        OslMfree(acct_info_p);
        srv_email_acct_destroy(acct_handle);

        memset(&email_app_comp, 0, sizeof(email_app_comp_info_struct));
        memset(attach_info_array, 0, sizeof(attach_info_array));
        email_is_drm_file_deleted = FALSE;
        email_is_recip_too_many = FALSE;
        email_is_attach_over_size = FALSE;
        email_is_recip_invalid = FALSE;
        result = srv_email_msg_create(0, &msg_handle);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(comp_data->parent_id, result);
            return;
        }
        result = srv_email_msg_open(
                    msg_handle,
                    comp_data->acct_id,
                    comp_data->fldr_id,
                    comp_data->msg_id);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(comp_data->parent_id, result);
            srv_email_msg_destroy(msg_handle);
            return;
        }
        email_app_comp.acct_id = comp_data->acct_id;
        mmi_email_util_get_fldr_id_by_acct(
            comp_data->acct_id,
            2,
            fldr_type_array,
            fldr_id_array);
        email_app_comp.draft_fldr_id = fldr_id_array[0];
        email_app_comp.outbox_fldr_id = fldr_id_array[1];
        email_app_comp.msg_id = comp_data->msg_id;
        basic_info = OslMalloc(sizeof(srv_email_msg_get_basic_info_struct));
        result = srv_email_msg_get_basic_info(
                    msg_handle,
                    basic_info);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(comp_data->parent_id, result);
            OslMfree(basic_info);
            srv_email_msg_destroy(msg_handle);
            return;
        }
        email_app_comp.to_num = 0;
        temp_addr_num = basic_info->to_addr_num;
        email_app_comp.cc_num = basic_info->cc_addr_num;
        email_app_comp.bcc_num = basic_info->bcc_addr_num;
        if (comp_data->type == EMAIL_PRE_COMP_TYPE_FORWARD)
        {
            email_app_comp.cc_num = 0;
            email_app_comp.bcc_num = 0;
        }
        email_app_comp.att_num = basic_info->attach_num;
        email_app_comp.priority = (U8)basic_info->priority;
        OslMfree(basic_info);
        if ((comp_data->type == EMAIL_PRE_COMP_TYPE_REPLY) ||
            (comp_data->type == EMAIL_PRE_COMP_TYPE_REPLY_ALL))
        {
            result = srv_email_msg_get_reply_to(
                        msg_handle,
                        email_app_comp.addr_list);
            if (result != SRV_EMAIL_RESULT_SUCC)
            {
                mmi_email_util_display_error_popup(comp_data->parent_id, result);
                srv_email_msg_destroy(msg_handle);
                return;
            }
            if ((mmi_wcslen(email_app_comp.addr_list[0].email_addr) == 0) ||
                (!mmi_email_util_chk_addr(email_app_comp.addr_list[0].email_addr)))
            {
                result = srv_email_msg_get_sender(
                            msg_handle,
                            email_app_comp.addr_list);
                if (result != SRV_EMAIL_RESULT_SUCC)
                {
                    mmi_email_util_display_error_popup(comp_data->parent_id, result);
                    srv_email_msg_destroy(msg_handle);
                    return;
                }
            }
            if (mmi_wcslen(email_app_comp.addr_list[0].email_addr))
            {
                if (mmi_email_util_chk_addr(email_app_comp.addr_list[0].email_addr))
                {
                    email_app_comp.to_num = 1;
                }
                else
                {
                    email_is_recip_invalid = TRUE;
                }
            }
        }
        recp_info = OslMalloc(sizeof(srv_email_msg_get_recipient_struct));
        if ((comp_data->type == EMAIL_PRE_COMP_TYPE_REPLY_ALL) ||
            (comp_data->type == EMAIL_PRE_COMP_TYPE_EDIT))
        {
            if (temp_addr_num)
            {
                recp_info->type = SRV_EMAIL_ADDR_TYPE_TO;
                recp_info->number = 1;

                for (i = 0; i < temp_addr_num && email_app_comp.to_num < MMI_EMAIL_MAX_ADDR_NUM; i++)
                {
                    recp_info->addr_list = &email_app_comp.addr_list[email_app_comp.to_num];
                    recp_info->start_index = i;

                    result = srv_email_msg_get_recipient(msg_handle, recp_info);
                    if (result != SRV_EMAIL_RESULT_SUCC)
                    {
                        mmi_email_util_display_error_popup(comp_data->parent_id, result);
                        OslMfree(recp_info);
                        srv_email_msg_destroy(msg_handle);
                        return;
                    }

                    if (mmi_email_util_chk_addr(recp_info->addr_list->email_addr))
                    {
                        if (comp_data->type == EMAIL_PRE_COMP_TYPE_EDIT ||
                            (mmi_wcscmp(email_addr, recp_info->addr_list->email_addr) &&
                             !mmi_email_comp_is_duplicate_addr(
                                recp_info->addr_list->email_addr,
                                email_app_comp.addr_list,
                                email_app_comp.to_num)))
                        {
                            email_app_comp.to_num++;
                        }
                    }
                    else
                    {
                        email_is_recip_invalid = TRUE;
                    }
                }

                if (i < temp_addr_num)
                {
                    email_is_recip_too_many = TRUE;
                }
            }

            if (email_app_comp.to_num < MMI_EMAIL_MAX_ADDR_NUM && email_app_comp.cc_num)
            {
                temp_addr_num = email_app_comp.cc_num;
                email_app_comp.cc_num = 0;

                recp_info->type = SRV_EMAIL_ADDR_TYPE_CC;
                recp_info->number = 1;

                for (i = 0;
                     (i < temp_addr_num &&
                      email_app_comp.to_num + email_app_comp.cc_num < MMI_EMAIL_MAX_ADDR_NUM);
                     i++)
                {
                    recp_info->addr_list = &email_app_comp.addr_list[email_app_comp.to_num + email_app_comp.cc_num];
                    recp_info->start_index = i;

                    result = srv_email_msg_get_recipient(msg_handle, recp_info);
                    if (result != SRV_EMAIL_RESULT_SUCC)
                    {
                        mmi_email_util_display_error_popup(comp_data->parent_id, result);
                        OslMfree(recp_info);
                        srv_email_msg_destroy(msg_handle);
                        return;
                    }

                    if (mmi_email_util_chk_addr(recp_info->addr_list->email_addr))
                    {
                        if (comp_data->type == EMAIL_PRE_COMP_TYPE_EDIT ||
                            (mmi_wcscmp(email_addr, recp_info->addr_list->email_addr) &&
                             !mmi_email_comp_is_duplicate_addr(
                                recp_info->addr_list->email_addr,
                                email_app_comp.addr_list,
                                email_app_comp.to_num + email_app_comp.cc_num)))
                        {
                            email_app_comp.cc_num++;
                        }
                    }
                    else
                    {
                        email_is_recip_invalid = TRUE;
                    }
                }

                if (i < temp_addr_num)
                {
                    email_is_recip_too_many = TRUE;
                }
            }
            else
            {
                email_app_comp.cc_num = 0;
            }

            if (email_app_comp.cc_num)
            {
                email_app_comp.is_show_cc_field = TRUE;
            }
            else
            {
                email_app_comp.is_show_cc_field = FALSE;
            }

            if ((email_app_comp.to_num + email_app_comp.cc_num < MMI_EMAIL_MAX_ADDR_NUM) &&
                (email_app_comp.bcc_num) &&
                (comp_data->type == EMAIL_PRE_COMP_TYPE_EDIT))
            {
                recp_info->start_index = 0;
                recp_info->addr_list = &(email_app_comp.addr_list[email_app_comp.to_num + email_app_comp.cc_num]);
                if (email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num > MMI_EMAIL_MAX_ADDR_NUM)
                {
                    recp_info->number = MMI_EMAIL_MAX_ADDR_NUM - email_app_comp.to_num - email_app_comp.cc_num;
                    email_is_recip_too_many = TRUE;
                }
                else
                {
                    recp_info->number = email_app_comp.bcc_num;
                }
                recp_info->type = SRV_EMAIL_ADDR_TYPE_BCC;
                result = srv_email_msg_get_recipient(
                            msg_handle,
                            recp_info);
                if (result != SRV_EMAIL_RESULT_SUCC)
                {
                    mmi_email_util_display_error_popup(comp_data->parent_id, result);
                    OslMfree(recp_info);
                    srv_email_msg_destroy(msg_handle);
                    return;
                }
                mmi_email_comp_check_reply_address_valid(recp_info->addr_list, &recp_info->number);
                email_app_comp.bcc_num = recp_info->number;
                email_app_comp.is_show_bcc_field = TRUE;
            }
            else
            {
                email_app_comp.bcc_num = 0;
                email_app_comp.is_show_bcc_field = FALSE;
            }
        }
        else
        {
            email_app_comp.cc_num = 0;
            email_app_comp.bcc_num = 0;
        }
        OslMfree(recp_info);
        result = srv_email_msg_get_subject_len(
                    msg_handle,
                    &sub_len,
                    &sub_char);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(comp_data->parent_id, result);
            srv_email_msg_destroy(msg_handle);
            return;
        }
        memset(&email_app_comp.subj, 0, sizeof(email_app_comp.subj));
        if (comp_data->type == EMAIL_PRE_COMP_TYPE_EDIT)
        {
            email_app_comp.subj_len = 0;
        }
        else if (comp_data->type == EMAIL_PRE_COMP_TYPE_FORWARD)
        {
            mmi_wcscpy(email_app_comp.subj, (WCHAR*)GetString(STR_EMAIL_FWD_IND_ID));
            email_app_comp.subj_len = mmi_wcslen(email_app_comp.subj);
        }
        else if ((comp_data->type == EMAIL_PRE_COMP_TYPE_REPLY) ||
                 (comp_data->type == EMAIL_PRE_COMP_TYPE_REPLY_ALL))
        {
            mmi_wcscpy(email_app_comp.subj, (WCHAR*)GetString(STR_EMAIL_REPLY_IND_ID));
            email_app_comp.subj_len = mmi_wcslen(email_app_comp.subj);
        }
        temp_sub_ptr = email_app_comp.subj + email_app_comp.subj_len;
        if (sub_len)
        {
            if (sub_len + email_app_comp.subj_len > MMI_EMAIL_MAX_SUBJ_LEN)
            {
                sub_len = MMI_EMAIL_MAX_SUBJ_LEN - email_app_comp.subj_len + 1;
            }
            else
            {
                sub_len += 1;
            }
            result = srv_email_msg_get_subject(
                        msg_handle,
                        temp_sub_ptr,
                        &sub_len);
            if (result != SRV_EMAIL_RESULT_SUCC)
            {
                mmi_email_util_display_error_popup(comp_data->parent_id, result);
                srv_email_msg_destroy(msg_handle);
                return;
            }
            email_app_comp.subj_len += sub_len;
        }
        result = srv_email_msg_cont_status(
                    msg_handle,
                    &cont_state,
                    &html_state);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(comp_data->parent_id, result);
            srv_email_msg_destroy(msg_handle);
            return;
        }
        if (cont_state & SRV_EMAIL_MSG_CONT_PART_EXIST)
        {
            result = srv_email_msg_get_content_len(
                        msg_handle,
                        &cont_len,
                        &cont_char);
            if (result != SRV_EMAIL_RESULT_SUCC)
            {
                mmi_email_util_display_error_popup(comp_data->parent_id, result);
                srv_email_msg_destroy(msg_handle);
                return;
            }
            if (cont_len)
            {
                if (cont_len > MMI_EMAIL_MAX_CONT_LEN)
                {
                    email_app_comp.cont_len = MMI_EMAIL_MAX_CONT_LEN;
                }
                else
                {
                    email_app_comp.cont_len = cont_len + 1;
                }
                email_app_comp.cont_len += 2;
                result = srv_email_msg_get_content(
                            msg_handle,
                            MMI_TRUE,
                            email_app_comp.content,
                            (U32*)(&email_app_comp.cont_len));
                if (result != SRV_EMAIL_RESULT_SUCC)
                {
                    mmi_email_util_display_error_popup(comp_data->parent_id, result);
                    srv_email_msg_destroy(msg_handle);
                    return;
                }
                email_app_comp.content[email_app_comp.cont_len] = L'\0';
                email_app_comp.content[MMI_EMAIL_MAX_CONT_LEN] = L'\0';
            }
        }
#ifdef __MMI_EMAIL_HTML__
        else if ((html_state & SRV_EMAIL_MSG_CONT_PART_EXIST) &&
                 (html_state & SRV_EMAIL_MSG_CONT_DOWNLOADED))
        {
            read_html_cont = mmi_email_get_read_cont_buff_ptr(&email_app_comp.cont_len);
            mmi_wcscpy(email_app_comp.content, read_html_cont);
        }
#endif /* __MMI_EMAIL_HTML__ */

        memset(email_app_comp.attach_display, 0, sizeof(email_app_comp.attach_display));
        memset(&attach_info_array, 0, sizeof(attach_info_array));
        email_app_comp.is_show_att_field = FALSE;
        if ((comp_data->type == EMAIL_PRE_COMP_TYPE_FORWARD) ||
            (comp_data->type == EMAIL_PRE_COMP_TYPE_EDIT))
        {
            if (email_app_comp.att_num)
            {
                U32 i = 0, j = 0;
                S32 att_count = 1, fwd_flag = 0;
                mmi_email_comp_get_attach_display_field(msg_handle);
                for (; i < email_app_comp.att_num; i++)
                {
                    result = srv_email_msg_get_attachment_info(
                        msg_handle,
                        i,
                        &att_count,
                        &attach_info_array[j]);
                    if (result != SRV_EMAIL_RESULT_SUCC)
                    {
                        mmi_email_util_display_error_popup(comp_data->parent_id, result);
                        srv_email_msg_destroy(msg_handle);
                        return;
                    }
                    if (!attach_info_array[j].downloaded)
                    {
                        memset(&attach_info_array[j], 0, sizeof(srv_email_attach_struct));
                        continue;
                    }

#ifdef __DRM_SUPPORT__
                    fwd_flag = mmi_rmgr_check_forward((U16*)attach_info_array[j].path);
                    if (!(fwd_flag & MMI_RMGR_USAGE_SEND))
                    {
                        memset(&attach_info_array[j], 0, sizeof(srv_email_attach_struct));
                        email_is_drm_file_deleted = TRUE;
                        continue;
                    }
#endif /* __DRM_SUPPORT__ */

                    if (email_app_comp.attach_total_size + attach_info_array[j].size > MMI_EMAIL_TOTAL_MAX_ATTACH_SIZE)
                    {
                        memset(&attach_info_array[j], 0, sizeof(srv_email_attach_struct));
                        email_is_attach_over_size = TRUE;
                        continue;
                    }
                    if (attach_info_array[j].name_len)
                    {
                        mmi_email_util_get_mine_type(
                            attach_info_array[j].name,
                            &attach_info_array[j].mime_type,
                            &attach_info_array[j].mime_subtype);
                    }
                    else
                    {
                        attach_info_array[j].mime_type = 0;
                        attach_info_array[j].mime_subtype = 0;
                    }
                    email_app_comp.attach_total_size += attach_info_array[j].size;
                    j++;
                }
                email_app_comp.att_num = j;
                if (j)
                {
                    email_app_comp.is_show_att_field = TRUE;
                }
            }
        }
        else
        {
            email_app_comp.att_num = 0;
        }
        if (comp_data->type == EMAIL_PRE_COMP_TYPE_EDIT)
        {
            srv_email_msg_get_permission(msg_handle);
        }
        else
        {
            srv_email_msg_destroy(msg_handle);
            result = srv_email_msg_create(0, &msg_handle);
            if (result != SRV_EMAIL_RESULT_SUCC)
            {
                mmi_email_util_display_error_popup(comp_data->parent_id, result);
                return;
            }
            result = srv_email_msg_set_new(msg_handle);
            if (result != SRV_EMAIL_RESULT_SUCC)
            {
                mmi_email_util_display_error_popup(comp_data->parent_id, result);
                srv_email_msg_destroy(msg_handle);
                return;
            }
        }
        email_app_comp.msg_handle = msg_handle;
        mmi_email_comp_addr_fill_display_info();
        email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
        mmi_email_comp_fill_sender_info(email_app_comp.msg_handle);
        if (email_app_comp.subj_len)
        {
            srv_email_msg_update_subject(
                email_app_comp.msg_handle,
                email_app_comp.subj,
                MMI_CHSET_UCS2,
                email_app_comp.subj_len);
            email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_SUB;
        }
        if (email_app_comp.cont_len)
        {
            srv_email_msg_update_content_struct cont_buf;
            cont_buf.buff = email_app_comp.content;
            cont_buf.buff_len = email_app_comp.cont_len + 1;
            cont_buf.buff_type = MMI_TRUE;
            cont_buf.charset = MMI_CHSET_UCS2;
            srv_email_msg_update_content(
                email_app_comp.msg_handle,
                &cont_buf);
            email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_CON;
        }
        email_app_comp.type = comp_data->type;
        if (comp_data->type == EMAIL_PRE_COMP_TYPE_REPLY ||
            comp_data->type == EMAIL_PRE_COMP_TYPE_REPLY_ALL)
        {
            email_app_comp.first_hilit_field = MMI_EMAIL_COMP_FIRST_HILIT_CONTENT;
        }
        else
        {
            email_app_comp.first_hilit_field = MMI_EMAIL_COMP_FIRST_HILIT_TO;
        }
    }

ENTRY_COMP:
    email_app_comp.parent_id = comp_data->parent_id;
    email_app_comp.is_close_parent = comp_data->is_close_parent;
    email_app_comp.edit_from_outbox = comp_data->edit_from_outbox;
    email_comp_curr_fldr_id = comp_data->fldr_id;
    email_comp_curr_msg_id = comp_data->msg_id;
    basic_update = OslMalloc(sizeof(srv_email_msg_update_basic_info_struct));
    basic_update->acct_id = comp_data->acct_id;
    basic_update->fldr_id = 0;
    basic_update->priority = email_app_comp.priority;
    basic_update->flag = EMAIL_MSG_FLAG_SEEN;
    srv_email_msg_update_basic_info(
        email_app_comp.msg_handle,
        basic_update);
    OslMfree(basic_update);

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PREPARE_ENTRY_COMP_EXT, __LINE__);

    email_app_comp.grp_id = mmi_frm_group_create(
                                comp_data->parent_id,
                                GRP_ID_AUTO_GEN,
                                mmi_email_comp_group_proc,
                                NULL);

    mmi_frm_group_enter(email_app_comp.grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    if (
        (comp_data->type == EMAIL_PRE_COMP_TYPE_NEW) ||
        (comp_data->type == EMAIL_PRE_COMP_TYPE_TEMPLATE) ||
        (comp_data->type == EMAIL_PRE_COMP_TYPE_EXTRACT) ||
        (comp_data->type == EMAIL_PRE_COMP_TYPE_ADDR_SEND)||
        (comp_data->type == EMAIL_PRE_COMP_TYPE_FORWARD) ||
        (comp_data->type == EMAIL_PRE_COMP_TYPE_CONTINUE)
        )
    {
        if (email_app_comp.att_num)
        {
            email_comp_copy_attach_callback = mmi_email_comp_copy_attach_done_entry_comp;
            mmi_email_comp_pre_copy_attach(0, NULL);
            return;
        }
    }
    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_ATT;
    //if (comp_data->type != EMAIL_PRE_COMP_TYPE_EDIT)
    {
        srv_email_msg_update_attach(
            email_app_comp.msg_handle,
            email_app_comp.att_num,
            attach_info_array);
    }

    if (email_app_comp.att_num)
    {
        mmi_email_comp_get_attach_display_field(email_app_comp.msg_handle);
    }

    mmi_email_entry_comp();
}


static void mmi_email_comp_copy_attach_done_entry_comp(BOOL result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_COPY_ATTACH_DONE_ENTRY_COMP, __LINE__);
    if (result)
    {
        email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_ATT;
        srv_email_msg_update_attach(
            email_app_comp.msg_handle,
            email_app_comp.att_num,
            attach_info_array);
        if (email_app_comp.att_num)
        {
            mmi_email_comp_get_attach_display_field(email_app_comp.msg_handle);
        }
        mmi_email_entry_comp();
        mmi_email_app_send_attch_from_vobj_free();
    }
    mmi_frm_scrn_close(email_app_comp.grp_id, SCR_ID_EMAIL_COMP_ATTACH_COPY);
}


static void mmi_email_comp_copy_attach_loading(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_COPY_ATTACH_LOADING, __LINE__);

    if (!mmi_frm_scrn_enter(
            email_app_comp.grp_id,
            SCR_ID_EMAIL_COMP_ATTACH_COPY,
            NULL,
            mmi_email_comp_copy_attach_loading,
            MMI_FRM_FULL_SCRN))
    {
        return;
    }
    ShowCategory66Screen(
        STR_GLOBAL_EMAIL,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        0,
        0,
        STR_GLOBAL_CANCEL,
        IMG_GLOBAL_BACK,
        (U8*)GetString(STR_GLOBAL_LOADING),
        mmi_email_lib_get_progress_img_id(),
        NULL);
    SetLeftSoftkeyFunction(NULL, KEY_EVENT_UP);
    SetRightSoftkeyFunction(mmi_email_comp_copy_attach_cancel, KEY_EVENT_UP);
    mmi_frm_scrn_set_leave_proc(
        email_app_comp.grp_id,
        SCR_ID_EMAIL_COMP_ATTACH_COPY,
        mmi_email_comp_copy_attach_del_callback);
}


static void mmi_email_comp_copy_attach_cancel(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_COPY_ATTACH_CANCEL, __LINE__);

    mmi_frm_scrn_close(email_app_comp.grp_id, SCR_ID_EMAIL_COMP_ATTACH_COPY);
}


static mmi_ret mmi_email_comp_copy_attach_del_callback(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_COPY_ATTACH_DEL_CALLBACK, __LINE__);

    switch (evt->evt_id)
    {
        case EVT_ID_SCRN_GOBACK_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ:
        case EVT_ID_SCRN_GOBACK:
            if (email_comp_copy_attach_job_id)
            {
                srv_fmgr_async_abort(
                    email_comp_copy_attach_job_id,
                    MMI_TRUE);
            }
            email_comp_copy_attach_job_id = 0;
            email_comp_copy_attach_callback = NULL;
            if (email_comp_copy_attach_dst_path)
            {
                OslMfree(email_comp_copy_attach_dst_path);
                email_comp_copy_attach_dst_path = NULL;
            }
            break;
    }
    return MMI_RET_OK;
}


static void mmi_email_comp_pre_copy_attach(S32 index, WCHAR *file_path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_PRE_COPY_ATTACH, __LINE__);

    email_comp_copy_attach_dst_path = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(WCHAR));
    memset(email_comp_copy_attach_dst_path, 0, (SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(WCHAR));
    if (file_path == NULL)
    {
        kal_wsprintf(email_comp_copy_attach_dst_path, "%scopy_file\\", srv_email_get_root_path());
        if (!mmi_email_util_dir_exist(email_comp_copy_attach_dst_path))
        {
            if (FS_CreateDir(email_comp_copy_attach_dst_path) != FS_NO_ERROR)
            {
                (*email_comp_copy_attach_callback)(FALSE);
                return;
            }
        }
        email_comp_copy_attach_index = -1;
        mmi_email_comp_copy_attach_next();
    }
    else
    {
        email_comp_copy_attach_index = index;
        mmi_email_comp_copy_attach(file_path);
    }

    if (email_comp_copy_attach_job_id > 0)
    {
        mmi_email_comp_copy_attach_loading();
    }
}


static void mmi_email_comp_copy_attach_next(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_COPY_ATTACH_NEXT, __LINE__);

    email_comp_copy_attach_index++;
    mmi_email_comp_copy_attach(attach_info_array[email_comp_copy_attach_index].path);
}


static void mmi_email_comp_get_free_attach_filename(WCHAR *filename)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 i = 0;
    U32 j = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GET_FREE_ATTACH_FILENAME, __LINE__);

    for (i = 0; i < MMI_EMAIL_MAX_ATTACH_NUMBER; i++)
    {
        kal_wsprintf(filename, "%scopy_file\\attach%d.mca", srv_email_get_root_path(), i);
        for (j = 0; j < email_app_comp.att_num; j++)
        {
            if (mmi_wcscmp(attach_info_array[j].path, filename) == 0)
            {
                break;
            }
        }

        if (j == email_app_comp.att_num)
        {
            break;
        }
    }

    MMI_EXT_ASSERT(
        i < MMI_EMAIL_MAX_ATTACH_NUMBER,
        MMI_EMAIL_MAX_ATTACH_NUMBER,
        i,
        email_app_comp.att_num);
}


static void mmi_email_comp_copy_attach(WCHAR *file_path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    CHAR drive = srv_email_get_drive();
    S32 attr = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    //kal_wsprintf(email_comp_copy_attach_dst_path, "%scopy_file\\attach%d.mca", srv_email_get_root_path(), email_comp_copy_attach_index);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_COPY_ATTACH, __LINE__);

    mmi_email_comp_get_free_attach_filename(email_comp_copy_attach_dst_path);
    attr = FS_GetAttributes((const WCHAR*)email_comp_copy_attach_dst_path);
    if (attr & FS_ATTR_READ_ONLY)
    {
        FS_SetAttributes((const WCHAR*)email_comp_copy_attach_dst_path, (U8)(attr & ~(FS_ATTR_READ_ONLY)));
    }
    FS_Delete((U16*)email_comp_copy_attach_dst_path);
    email_comp_copy_attach_job_id =
        srv_fmgr_async_copy(
            file_path,
            email_comp_copy_attach_dst_path,
            0,
            mmi_email_comp_copy_attach_ret_callback,
            NULL);
    if (email_comp_copy_attach_job_id <= 0)
    {
        mmi_email_util_display_popup(
            0,
            GetString((U16)srv_fmgr_fs_error_get_string(email_comp_copy_attach_job_id)),
            MMI_EVENT_FAILURE);
        OslMfree(email_comp_copy_attach_dst_path);
        email_comp_copy_attach_dst_path = NULL;
    }
}


static mmi_ret mmi_email_comp_copy_attach_ret_callback(mmi_event_struct *param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_fmgr_async_done_event_struct *async_evt;
    BOOL is_exit = FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_COPY_ATTACH_RET_CALLBACK, __LINE__);

    switch (param->evt_id)
    {
        case EVT_ID_SRV_FMGR_ASYNC_DONE:
            {
                async_evt = (srv_fmgr_async_done_event_struct*)param;
                if (email_comp_copy_attach_job_id == 0)
                {
                    is_exit = TRUE;
                }
                email_comp_copy_attach_job_id = 0;
                if (!is_exit)
                {
                    if (async_evt->result == 0)
                    {
                        if (email_app_comp.inline_id)
                        {
                            (*email_comp_copy_attach_callback)(TRUE);
                        }
                        else
                        {
                            mmi_wcscpy(attach_info_array[email_comp_copy_attach_index].path, email_comp_copy_attach_dst_path);
                            if (email_comp_copy_attach_index < (S32)(email_app_comp.att_num - 1))
                            {
                                mmi_email_comp_copy_attach_next();
                            }
                            else
                            {
                                (*email_comp_copy_attach_callback)(TRUE);
                            }
                        }
                    }
                    else
                    {
                        mmi_email_util_display_popup(
                            0, //email_app_comp.grp_id,
                            GetString((U16)srv_fmgr_fs_error_get_string(async_evt->result)),
                            MMI_EVENT_FAILURE);
                        (*email_comp_copy_attach_callback)(FALSE);
                    }
                }
            }
            break;
    }
    return MMI_RET_OK;
}


static mmi_ret mmi_email_comp_group_proc(mmi_event_struct *event)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (event->evt_id)
    {
        case EVT_ID_GROUP_FOCUSED:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GROUP_PROC, __LINE__);
            mmi_email_set_active_group_id(email_app_comp.grp_id);
            break;

        case EVT_ID_GROUP_DEINIT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GROUP_PROC, __LINE__);
            if (email_app_comp.inline_id)
            {
                cui_inline_close(email_app_comp.inline_id);
                email_app_comp.inline_id = 0;
            }
            if (email_app_comp.msg_handle)
            {
                srv_email_msg_destroy(email_app_comp.msg_handle);
                email_app_comp.msg_handle = 0;
            }
            email_app_comp.grp_id = 0;
            mmi_email_comp_addr_add_recent_free();
            mmi_email_comp_asm_destroy();
            mmi_email_lib_empty_copy_file_dir();
            break;

        case EVT_ID_CUI_INLINE_NOTIFY:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GROUP_PROC, __LINE__);
            mmi_email_comp_inline_notify((cui_event_inline_notify_struct*)event);
            break;

        case EVT_ID_CUI_INLINE_CSK_PRESS:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GROUP_PROC, __LINE__);
            mmi_email_comp_inline_csk_press((cui_event_inline_csk_press_struct*)event);
            break;

        case EVT_ID_CUI_INLINE_MAIN_SCREEN_ACTIVE:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GROUP_PROC, __LINE__);

#ifdef __MMI_ICON_BAR_SUPPORT__
            email_toolbar_content_icon[MMI_EMAIL_COMP_TB_SEND_MESSAGE] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_SEND_MESSAGE);
            email_toolbar_content_icon[MMI_EMAIL_COMP_TB_ATTACHMENT] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_ATTACHMENT);
            email_toolbar_disabled_content_icon[MMI_EMAIL_COMP_TB_SEND_MESSAGE] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_SEND_MESSAGE_DISABLED);
            email_toolbar_disabled_content_icon[MMI_EMAIL_COMP_TB_ATTACHMENT] = (PU8)GetImage(IMG_GLOBAL_TOOLBAR_ATTACHMENT_DISABLED);
            email_toolbar_string[MMI_EMAIL_COMP_TB_SEND_MESSAGE] = (PU8)GetString(STR_GLOBAL_SEND);
            email_toolbar_string[MMI_EMAIL_COMP_TB_ATTACHMENT] = (PU8)GetString(STR_EMAIL_TB_HINT_ADD_ATTACHMENT_ID);
            wgui_icon_bar_setup(
                MMI_EMAIL_COMP_TB_TOTAL,
                email_toolbar_content_icon,
                email_toolbar_disabled_content_icon,
                email_toolbar_string,
                mmi_email_comp_tb_callback);
            if (email_app_comp.to_num || email_app_comp.cc_num || email_app_comp.bcc_num)
            {
                wgui_icon_bar_set_item_enable_state(MMI_EMAIL_COMP_TB_SEND_MESSAGE, MMI_TRUE);
            }
            else
            {
                wgui_icon_bar_set_item_enable_state(MMI_EMAIL_COMP_TB_SEND_MESSAGE, MMI_FALSE);
            }
            if (email_app_comp.att_num == MMI_EMAIL_MAX_ATTACH_NUMBER)
            {
                wgui_icon_bar_set_item_enable_state(MMI_EMAIL_COMP_TB_ATTACHMENT, MMI_FALSE);
            }
            else
            {
                wgui_icon_bar_set_item_enable_state(MMI_EMAIL_COMP_TB_ATTACHMENT, MMI_TRUE);
            }
#endif /* __MMI_ICON_BAR_SUPPORT__ */

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
            wgui_register_tap_callback(mmi_email_comp_tap_callback);
#endif

            if (email_app_comp.att_changed && email_app_comp.att_num > 0)
            {
                cui_inline_set_highlight_item(email_app_comp.inline_id, MMI_EMAIL_COMP_ATTACH_ITEM_ID);
            }
            email_app_comp.att_changed = FALSE;
            break;

        case EVT_ID_CUI_INLINE_MAIN_SCREEN_SHOWN:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GROUP_PROC, __LINE__);
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_AUTOTEST_EDIT_READY);
            if (email_is_recip_too_many)
            {
                mmi_email_lib_infor_popup(STR_EMAIL_RECIPIENT_TOO_MANY_ID);
                email_is_recip_too_many = FALSE;
                break;
            }
            if (email_is_drm_file_deleted)
            {
                mmi_email_util_display_popup(
                    email_app_comp.grp_id,
                    GetString(STR_EMAIL_DRM_FILE_IGNORE_ID),
                    MMI_EVENT_INFO);
                email_is_drm_file_deleted = FALSE;
                break;
            }
            if (email_is_attach_over_size)
            {
                mmi_email_lib_infor_popup(STR_EMAIL_TOO_LARGE_TO_ADD_ID);
                email_is_attach_over_size = FALSE;
                break;
            }
            if (email_is_recip_invalid)
            {
                mmi_email_lib_infor_popup(STR_GLOBAL_INVALID_EMAIL_ADDRESS);
                email_is_recip_invalid = FALSE;
                break;
            }
            if (email_is_sig_empty_file)
            {
                mmi_email_lib_infor_popup(STR_EMAIL_EMPTY_FILE_ID);
                email_is_sig_empty_file = FALSE;
                break;
            }
            if (email_is_sig_fail)
            {
                mmi_email_lib_infor_popup(STR_EMAIL_SIG_ADD_FAIL_ID);
                email_is_sig_fail = FALSE;
                break;
            }
            if (email_is_sig_missing)
            {
                mmi_email_lib_infor_popup(STR_EMAIL_SIG_ADD_MISSING_ID);
                email_is_sig_missing = FALSE;
                break;
            }
            break;

        case EVT_ID_CUI_INLINE_SUBMIT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GROUP_PROC, __LINE__);
            {
#ifdef __MMI_EMAIL_CREATE_UE__
                cui_event_inline_submit_struct *submit_evt = (cui_event_inline_submit_struct*)event;
                if (submit_evt->sofktey_type == MMI_CENTER_SOFTKEY)
                {
                    mmi_email_comp_goto_addr(email_app_comp.change_type);
                }
                else
#endif
                {
                    email_app_comp.option_grp_id = cui_menu_create(
                        email_app_comp.grp_id,
                        CUI_MENU_SRC_TYPE_RESOURCE,
                        CUI_MENU_TYPE_OPTION,
                        MENU_ID_EMAIL_COMP_OPT,
                        MMI_FALSE,
                        (void*)(&email_app_comp));
                    cui_menu_set_default_title(email_app_comp.option_grp_id, NULL, get_image(GetRootTitleIcon(MENU_ID_EMAIL_MAIN)));
                    cui_menu_run(email_app_comp.option_grp_id);
                }
            }
            break;
        case EVT_ID_CUI_INLINE_ABORT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GROUP_PROC, __LINE__);
            {
                cui_event_inline_abort_struct *abort_evt = (cui_event_inline_abort_struct*)event;
                if (email_app_comp.save_part != 0)
                {
                    mmi_email_util_display_confirm(
                        email_app_comp.grp_id,
                        mmi_email_comp_quit_ask_lsk,
                        mmi_frm_scrn_close_active_id,
                        NULL,
                        TRUE,
                        GetString(STR_EMAIL_COMMON_QUIT_WITHOUT_SAVING_ASK_ID),
                        MMI_EVENT_QUERY);
                }
                else
                {
                    cui_inline_close(abort_evt->sender_id);
                    email_app_comp.inline_id = 0;
                }
            }
            break;
        case EVT_ID_CUI_INLINE_GROUP_DEINIT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GROUP_PROC, __LINE__);
            {
                cui_event_inline_abort_struct *abort_evt = (cui_event_inline_abort_struct*)event;
                cui_inline_close(abort_evt->sender_id);
                email_app_comp.inline_id = 0;
                break;
            }
        case EVT_ID_CUI_MENU_LIST_ENTRY:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GROUP_PROC, __LINE__);
            {
                cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)event;
                mmi_email_comp_hide_menu(menu_evt->app_data);
                break;
            }
        case EVT_ID_CUI_MENU_ITEM_SELECT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GROUP_PROC, __LINE__);
            {
                cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)event;
                mmi_email_comp_option_handler(menu_evt->highlighted_menu_id, menu_evt->sender_id);
                break;
            }
        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GROUP_PROC, __LINE__);
            {
                cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)event;
                cui_menu_close(menu_evt->sender_id);
                break;
            }
        case EVT_ID_CUI_FSEDITOR_SUBMMIT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GROUP_PROC, __LINE__);
            {
                cui_fseditor_get_text(
                    email_app_comp.fseditor_id,
                    edit_buff,
                    sizeof(edit_buff));
                if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_SUBJECT_ITEM_ID)
                {
                    mmi_wcscpy(email_app_comp.subj, edit_buff);
                    email_app_comp.subj_len = mmi_wcslen(email_app_comp.subj);
                    srv_email_msg_update_subject(
                        email_app_comp.msg_handle,
                        email_app_comp.subj,
                        MMI_CHSET_UCS2,
                        email_app_comp.subj_len);
                    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_SUB;
                }
                else
                {
                    srv_email_msg_update_content_struct cont_buf;
                    mmi_wcscpy(email_app_comp.content, edit_buff);
                    email_app_comp.cont_len = mmi_wcslen(email_app_comp.content);
                    cont_buf.buff = email_app_comp.content;
                    cont_buf.buff_len = email_app_comp.cont_len + 1;
                    cont_buf.buff_type = MMI_TRUE;
                    cont_buf.charset = MMI_CHSET_UCS2;
                    srv_email_msg_update_content(
                        email_app_comp.msg_handle,
                        &cont_buf);
                    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_CON;
                    cui_inline_set_value(
                        email_app_comp.inline_id,
                        MMI_EMAIL_COMP_CONTENT_ITEM_ID,
                        email_app_comp.content);
                }
                cui_fseditor_close(email_app_comp.fseditor_id);
                email_app_comp.fseditor_id = 0;
            }
            break;
        case EVT_ID_CUI_FSEDITOR_ABORT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GROUP_PROC, __LINE__);
            cui_fseditor_close(email_app_comp.fseditor_id);
            email_app_comp.fseditor_id = 0;
            break;

        case EVT_ID_CUI_FSEDITOR_CUSTOM_MENU_SELECTED:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GROUP_PROC, __LINE__);
            mmi_email_pre_entry_template_list(email_app_comp.fseditor_id, TRUE);
            break;

        case EVT_ID_CUI_FILE_SELECTOR_RESULT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GROUP_PROC, __LINE__);
            mmi_email_comp_attach_add_new_done((void*)event);
            break;
        default:
            break;
    }

#if ((defined __MMI_EMAIL_CREATE_UE__) || (defined __MMI_EMAIL_INLINE_EDIT__))
    if(cui_menu_is_menu_event(event->evt_id))
    {
        if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_CONTENT_ITEM_ID ||
            email_app_comp.curr_item_id == MMI_EMAIL_COMP_SUBJECT_ITEM_ID)
        {
            wgui_inputs_options_menu_handler(event, email_app_comp.grp_id);
        }
    }
#endif

    return MMI_RET_OK;
}


static void mmi_email_comp_quit_ask_lsk(void)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_QUIT_ASK_LSK, __LINE__);

    if (email_app_comp.is_close_parent)
    {
        mmi_frm_group_close(email_app_comp.parent_id);
        return;
    }
    mmi_frm_group_close(email_app_comp.grp_id);
    memset(&email_app_comp, 0, sizeof(email_app_comp));
    memset(attach_info_array, 0, sizeof(attach_info_array));
}


void mmi_email_comp_hide_menu(void *comp_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    email_app_comp_info_struct *app_data = (email_app_comp_info_struct*)comp_data;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_HIDE_MENU, __LINE__);

#ifdef __MMI_EMAIL_CREATE_UE__
    cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_EDIT_FIELD, MMI_TRUE);
    cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_SEND_MSG, MMI_FALSE);
#else /* __MMI_EMAIL_CREATE_UE__ */

#ifdef __MMI_EMAIL_INLINE_EDIT__
    //cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_EDIT_FIELD, MMI_TRUE);
    if (app_data->curr_item_id == MMI_EMAIL_COMP_TO_ITEM_ID ||
        app_data->curr_item_id == MMI_EMAIL_COMP_CC_ITEM_ID ||
        app_data->curr_item_id == MMI_EMAIL_COMP_BCC_ITEM_ID)
    {
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_EDIT_FIELD, MMI_FALSE);
    }
    else
    {
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_EDIT_FIELD, MMI_TRUE);
    }
#else /* __MMI_EMAIL_INLINE_EDIT__ */
    cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_EDIT_FIELD, MMI_FALSE);
#endif /* __MMI_EMAIL_INLINE_EDIT__ */

    cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_SEND_MSG, MMI_TRUE);
    if (app_data->to_num + app_data->cc_num + app_data->bcc_num >= 1)
    {
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_SEND_MSG, MMI_FALSE);
    }
#endif /* __MMI_EMAIL_CREATE_UE__ */

#if ((defined __MMI_EMAIL_CREATE_UE__) || (defined __MMI_EMAIL_INLINE_EDIT__))
    if (app_data->curr_item_id == MMI_EMAIL_COMP_CONTENT_ITEM_ID ||
        app_data->curr_item_id == MMI_EMAIL_COMP_SUBJECT_ITEM_ID)
    {
        cui_menu_set_group_hidden(app_data->option_grp_id, MENU_GROUP_EDITOR, MMI_FALSE);
    }
    else
#endif
    {
        cui_menu_set_group_hidden(app_data->option_grp_id, MENU_GROUP_EDITOR, MMI_TRUE);
    }

#if ((defined __MMI_EMAIL_CREATE_UE__) || (defined __MMI_EMAIL_INLINE_EDIT__))
    if (app_data->curr_item_id == MMI_EMAIL_COMP_CONTENT_ITEM_ID)
    {
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_TEMPLATE, MMI_FALSE);
    }
    else
#endif /* __MMI_EMAIL_CREATE_UE__ */
    {
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_TEMPLATE, MMI_TRUE);
    }

#ifndef __MMI_EMAIL_CREATE_UE__
    if (app_data->is_show_cc_field)
    {
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_SHOW_CC, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_HIDE_CC, MMI_FALSE);
    }
    else
    {
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_SHOW_CC, MMI_FALSE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_HIDE_CC, MMI_TRUE);
    }
    if (app_data->is_show_bcc_field)
    {
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_SHOW_BCC, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_HIDE_BCC, MMI_FALSE);
    }
    else
    {
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_SHOW_BCC, MMI_FALSE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_HIDE_BCC, MMI_TRUE);
    }
#else
    cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_ADDR_FIELD_OPT, MMI_TRUE);
#endif
    if (app_data->priority == EMAIL_MSG_PRIO_MED)
    {
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_PRI_HIGH, MMI_FALSE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_PRI_MED, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_PRI_LOW, MMI_FALSE);
    }
    else if (app_data->priority == EMAIL_MSG_PRIO_HIGH)
    {
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_PRI_HIGH, MMI_TRUE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_PRI_MED, MMI_FALSE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_PRI_LOW, MMI_FALSE);
    }
    else
    {
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_PRI_HIGH, MMI_FALSE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_PRI_MED, MMI_FALSE);
        cui_menu_set_item_hidden(app_data->option_grp_id, MENU_ID_EMAIL_COMP_PRI_LOW, MMI_TRUE);
    }
}


void mmi_email_comp_add_field_to_display(U16 field)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_inline_set_item_struct item = {0};
    cui_inline_item_display_only_struct display_only_struct = {0};
    U16 csk_icon_id = 0, pre_id = 0;
    WCHAR *display = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADD_FIELD_TO_DISPLAY, __LINE__);

    if (field == MMI_EMAIL_COMP_CC_ITEM_ID)
    {
        display = email_app_comp.cc_display;
        if (email_app_comp.is_show_bcc_field)
        {
            pre_id = MMI_EMAIL_COMP_BCC_ITEM_ID;
        }
        else
        {
            pre_id = MMI_EMAIL_COMP_SUBJECT_ITEM_ID;
        }
        display_only_struct.default_text_id = STR_EMAIL_CC_ID;
        item.image_id = IMG_EMAIL_CC_ID;
        item.item_id = MMI_EMAIL_COMP_CC_ITEM_ID;
    }
    else if (field == MMI_EMAIL_COMP_BCC_ITEM_ID)
    {
        display = email_app_comp.bcc_display;
        pre_id = MMI_EMAIL_COMP_SUBJECT_ITEM_ID;
        display_only_struct.default_text_id = STR_EMAIL_BCC_ID;
        item.image_id = IMG_EMAIL_BCC_ID;
        item.item_id = MMI_EMAIL_COMP_BCC_ITEM_ID;
    }
    else
    {
#ifdef __MMI_EMAIL_CREATE_UE__
        display = email_app_comp.attach_display;
        pre_id = CUI_INLINE_INSERT_TAIL;
        item.image_id = IMG_EMAIL_ATTACHMENT_ID;
        item.item_id = MMI_EMAIL_COMP_ATTACH_ITEM_ID;
#else
        display = email_app_comp.attach_display;
        pre_id = MMI_EMAIL_COMP_CONTENT_ITEM_ID;
        item.image_id = IMG_EMAIL_ATTACHMENT_ID;
        item.item_id = MMI_EMAIL_COMP_ATTACH_ITEM_ID;
#endif
    }
    item.item_flag = CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY;
    item.item_data = (void*)(&display_only_struct);
    cui_inline_insert_item(
        email_app_comp.inline_id,
        pre_id,
        &item);
#ifdef __MMI_EMAIL_CREATE_UE__
    if ((field == MMI_EMAIL_COMP_ATTACH_ITEM_ID) ||
        (email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num == 0))
    {
        csk_icon_id = IMG_GLOBAL_COMMON_CSK;
    }
    else if (email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num >= 1)
    {
        csk_icon_id = IMG_GLOBAL_SEND_MSG_CSK;
    }
    else
#endif
    {
        csk_icon_id = IMG_GLOBAL_COMMON_CSK;
    }
    cui_inline_set_item_attributes(
        email_app_comp.inline_id,
        field,
        CUI_INLINE_SET_ATTRIBUTE,
        CUI_INLINE_ITEM_DEFAULT_TEXT);
    cui_inline_set_value(
        email_app_comp.inline_id,
        field,
        display);
    cui_inline_set_softkey_icon(
        email_app_comp.inline_id,
        field,
        MMI_CENTER_SOFTKEY,
        csk_icon_id);
    cui_inline_set_softkey_text(
        email_app_comp.inline_id,
        field,
        MMI_LEFT_SOFTKEY,
        STR_GLOBAL_OPTIONS);
    cui_inline_set_softkey_icon(
        email_app_comp.inline_id,
        field,
        MMI_LEFT_SOFTKEY,
        IMG_GLOBAL_OPTIONS);
    cui_inline_set_highlight_item(
        email_app_comp.inline_id,
        field);
}


void mmi_email_comp_option_handler(mmi_menu_id menu_id, mmi_id grp_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_OPTION_HANDLER, __LINE__);
    switch (menu_id)
    {
        case MENU_ID_EMAIL_COMP_EDIT_FIELD:
            {
                if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_TO_ITEM_ID ||
                    email_app_comp.curr_item_id == MMI_EMAIL_COMP_CC_ITEM_ID ||
                    email_app_comp.curr_item_id == MMI_EMAIL_COMP_BCC_ITEM_ID)
                {
                    mmi_email_comp_goto_addr(MMI_EMAIL_COMP_ADDR_CT_ALL);
                }
                else if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_SUBJECT_ITEM_ID)
                {
                    mmi_email_comp_edit_subject();
                }
                else if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_ATTACH_ITEM_ID)
                {
                    mmi_email_comp_attach();
                }
                else
                {
                    mmi_email_comp_edit_content();
                }
            }
            break;
        case MENU_ID_EMAIL_SEND_MSG:
#ifdef __MMI_EMAIL_CREATE_UE__
            mmi_email_comp_goto_addr(email_app_comp.change_type);
#else
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_AUTOTEST_SEND_START);
            mmi_email_comp_send();
#endif
            break;

#if ((defined __MMI_EMAIL_CREATE_UE__) || (defined __MMI_EMAIL_INLINE_EDIT__))
        case MENU_ID_EMAIL_COMP_TEMPLATE:
            mmi_email_pre_entry_template_list(email_app_comp.grp_id, TRUE);
            break;
#endif /* #if ((defined __MMI_EMAIL_CREATE_UE__) || (defined __MMI_EMAIL_INLINE_EDIT__)) */

        case MENU_ID_EMAIL_COMP_ATTACH:
            {
                if (email_app_comp.att_num == 0)
                {
                    mmi_email_comp_attach_add_new(email_app_comp.grp_id);
                }
                else
                {
                    mmi_email_comp_attach();
                }
            }
            break;
        case MENU_ID_EMAIL_COMP_SHOW_CC:
            email_app_comp.is_show_cc_field = TRUE;
            mmi_email_comp_add_field_to_display(MMI_EMAIL_COMP_CC_ITEM_ID);
            cui_menu_close(grp_id);
            break;
        case MENU_ID_EMAIL_COMP_HIDE_CC:
            email_app_comp.is_show_cc_field = FALSE;
            cui_inline_delete_item(email_app_comp.inline_id, MMI_EMAIL_COMP_CC_ITEM_ID);
            cui_menu_close(grp_id);
            break;
        case MENU_ID_EMAIL_COMP_SHOW_BCC:
            email_app_comp.is_show_bcc_field = TRUE;
            mmi_email_comp_add_field_to_display(MMI_EMAIL_COMP_BCC_ITEM_ID);
            cui_menu_close(grp_id);
            break;
        case MENU_ID_EMAIL_COMP_HIDE_BCC:
            email_app_comp.is_show_bcc_field = FALSE;
            cui_inline_delete_item(email_app_comp.inline_id, MMI_EMAIL_COMP_BCC_ITEM_ID);
            cui_menu_close(grp_id);
            break;
        case MENU_ID_EMAIL_COMP_PRI_HIGH:
            email_app_comp.priority = EMAIL_MSG_PRIO_HIGH;
            email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_PRI;
            cui_menu_close(grp_id);
            break;
        case MENU_ID_EMAIL_COMP_PRI_MED:
            email_app_comp.priority = EMAIL_MSG_PRIO_MED;
            email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_PRI;
            cui_menu_close(grp_id);
            break;
        case MENU_ID_EMAIL_COMP_PRI_LOW:
            email_app_comp.priority = EMAIL_MSG_PRIO_LOW;
            email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_PRI;
            cui_menu_close(grp_id);
            break;
        case MENU_ID_EMAIL_COMP_SAVE:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_AUTOTEST_SAVE_DRAFT_START);
            {
                srv_email_msg_update_basic_info_struct *basic_info = NULL;
                email_app_save_send_proc_struct *info = NULL;

#if ((defined __MMI_EMAIL_CREATE_UE__) || (defined __MMI_EMAIL_INLINE_EDIT__))
                srv_email_msg_update_content_struct cont_buf;
                /* update subject */
                cui_inline_get_value(
                    email_app_comp.inline_id,
                    MMI_EMAIL_COMP_SUBJECT_ITEM_ID,
                    email_app_comp.subj);
                email_app_comp.subj_len = mmi_wcslen(email_app_comp.subj);
                srv_email_msg_update_subject(
                    email_app_comp.msg_handle,
                    email_app_comp.subj,
                    MMI_CHSET_UCS2,
                    email_app_comp.subj_len);
                email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_SUB;
                /* update content */
                email_app_comp.cont_len = mmi_wcslen(email_app_comp.content);
                cont_buf.buff = email_app_comp.content;
                cont_buf.buff_len = email_app_comp.cont_len + 1;
                cont_buf.buff_type = MMI_TRUE;
                cont_buf.charset = MMI_CHSET_UCS2;
                srv_email_msg_update_content(
                    email_app_comp.msg_handle,
                    &cont_buf);
                email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_CON;
#endif /* ((defined __MMI_EMAIL_CREATE_UE__) || (defined __MMI_EMAIL_INLINE_EDIT__)) */

                basic_info = OslMalloc(sizeof(srv_email_msg_update_basic_info_struct));
                basic_info->acct_id = email_app_comp.acct_id;
                if (email_app_comp.edit_from_outbox)
                {
                    basic_info->fldr_id = email_app_comp.outbox_fldr_id;
                }
                else
                {
                    basic_info->fldr_id = email_app_comp.draft_fldr_id;
                }
                basic_info->priority = email_app_comp.priority;
                basic_info->flag = EMAIL_MSG_FLAG_SEEN;
                srv_email_msg_update_basic_info(
                    email_app_comp.msg_handle,
                    basic_info);
                OslMfree(basic_info);
                info = OslMalloc(sizeof(email_app_save_send_proc_struct));
                memset(info, 0, sizeof(email_app_save_send_proc_struct));
                is_email_comp_close_screen = FALSE;
                if (email_app_comp.type == EMAIL_PRE_COMP_TYPE_EDIT)
                {
                    if (email_app_comp.edit_from_outbox)
                    {
                        info->dst_acct_id = email_app_comp.acct_id;
                        info->dst_fldr_id = email_app_comp.draft_fldr_id;
                        info->opt |= MMI_EMAIL_SS_CHANGE;
                    }
                    info->opt |= MMI_EMAIL_SS_SAVE;
                    info->save_part = SRV_EMAIL_MSG_SAVE_ALL;
                    is_email_comp_close_screen = TRUE;
                }
                else
                {
                    info->dst_acct_id = email_app_comp.acct_id;
                    info->dst_fldr_id = email_app_comp.draft_fldr_id;
                    info->opt |= MMI_EMAIL_SS_SAVE_NEW;
                }
                info->parent_id = email_app_comp.parent_id;
                info->msg_handle = email_app_comp.msg_handle;
                info->callback = mmi_email_comp_save_send_callback;
                info->user_data = NULL;
                mmi_email_set_ss(info);
                OslMfree(info);
                mmi_email_save_send();
            }
            break;
        case MENU_ID_EMAIL_COMP_SIZE:
            {
                srv_email_msg_update_content_struct cont_buf;

                email_app_comp.size_grp_id = mmi_frm_group_create(
                    email_app_comp.grp_id,
                    GRP_ID_AUTO_GEN,
                    mmi_email_comp_size_group_proc,
                    NULL);
                mmi_frm_group_enter(email_app_comp.size_grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
                mmi_email_comp_size_loading();

                email_app_comp.cont_len = mmi_wcslen(email_app_comp.content);
                cont_buf.buff = email_app_comp.content;
                cont_buf.buff_len = email_app_comp.cont_len + 1;
                cont_buf.buff_type = MMI_TRUE;
                cont_buf.charset = MMI_CHSET_UCS2;
                srv_email_msg_update_content(
                    email_app_comp.msg_handle,
                    &cont_buf);

                srv_email_comp_msg_size(email_app_comp.msg_handle, mmi_email_comp_size_callback, NULL);
            }
            break;
        case MENU_ID_EMAIL_COMP_EXIT:
            mmi_frm_group_close(email_app_comp.grp_id);
            break;
        default:
            break;
    }
    return;
}

static mmi_ret mmi_email_comp_size_group_proc(mmi_event_struct *evt)
{
    // Abort SIZE 
    switch (evt->evt_id)
    {
    case EVT_ID_GROUP_INACTIVE:
        srv_email_comp_msg_size_abort(email_app_comp.msg_handle);
        mmi_frm_scrn_close(email_app_comp.size_grp_id, SCR_EMAIL_LOADING_ID);
        break;

    default:
        break;
    }

    return MMI_RET_OK;
}


static void mmi_email_comp_size_loading(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_SIZE_LOADING, __LINE__);

    if (!mmi_frm_scrn_enter(
            email_app_comp.size_grp_id,
            SCR_EMAIL_LOADING_ID,
            NULL,
            mmi_email_comp_size_loading,
            MMI_FRM_FULL_SCRN))
    {
        return;
    }
    ShowCategory66Screen(
        STR_GLOBAL_EMAIL,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        0,
        0,
        0,
        0,
        (U8*)GetString(STR_GLOBAL_LOADING),
        mmi_email_lib_get_progress_img_id(),
        NULL);
    SetLeftSoftkeyFunction(NULL, KEY_EVENT_UP);
    SetRightSoftkeyFunction(NULL, KEY_EVENT_UP);
    SetKeyHandler(NULL, KEY_END, KEY_EVENT_DOWN);
}


static void mmi_email_comp_size_callback(MMI_BOOL succ, S32 err_major, S32 err_minor, U32 size, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_confirm_property_struct property;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_SIZE_CALLBACK, __LINE__);

    if (succ)
    {
        mmi_confirm_property_init(&property, CNFM_TYPE_OK);
        property.parent_id = email_app_comp.grp_id;
        property.callback = NULL;
        kal_wsprintf(
            email_comp_size_string,
            "%w\n%uKB",
            (WCHAR*)GetString(STR_EMAIL_COMPOSE_SIZE_SEND_ID),
            (size + 1023) / 1024);
        mmi_confirm_display(
            email_comp_size_string,
            MMI_EVENT_INFO,
            &property);
        SetLeftSoftkeyFunction(mmi_frm_scrn_close_active_id, KEY_EVENT_UP);
        SetRightSoftkeyFunction(NULL, KEY_EVENT_UP);
    }
    else
    {
        mmi_email_util_display_popup(
            email_app_comp.grp_id,
            GetString(mmi_email_util_get_err_code(err_major, err_minor)),
            MMI_EVENT_FAILURE);
    }
    mmi_frm_scrn_close(email_app_comp.size_grp_id, SCR_EMAIL_LOADING_ID);
}


void mmi_email_comp_inline_notify(cui_event_inline_notify_struct *event)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_INLINE_NOTIFY, __LINE__);

    switch (event->event_type)
    {
        case CUI_INLINE_NOTIFY_HIGHLIGHT_ITEM:
            {
                email_app_comp.curr_item_id = event->item_id;
                if (event->item_id == MMI_EMAIL_COMP_TO_ITEM_ID)
                {
                    cui_inline_set_title_string(email_app_comp.inline_id, get_string(STR_EMAIL_TO_ID));
                }
                else if (event->item_id == MMI_EMAIL_COMP_CC_ITEM_ID)
                {
                    cui_inline_set_title_string(email_app_comp.inline_id, get_string(STR_EMAIL_CC_ID));
                }
                else if (event->item_id == MMI_EMAIL_COMP_BCC_ITEM_ID)
                {
                    cui_inline_set_title_string(email_app_comp.inline_id, get_string(STR_EMAIL_BCC_ID));
                }
                else if (event->item_id == MMI_EMAIL_COMP_SUBJECT_ITEM_ID)
                {
                    cui_inline_set_title_string(email_app_comp.inline_id, get_string(STR_GLOBAL_SUBJECT));
                }
                else if (event->item_id == MMI_EMAIL_COMP_ATTACH_ITEM_ID)
                {
                    cui_inline_set_title_string(email_app_comp.inline_id, get_string(STR_EMAIL_ATTACHMENT_ID));
                }
                else if (event->item_id == MMI_EMAIL_COMP_CONTENT_ITEM_ID)
                {
                    cui_inline_set_title_string(email_app_comp.inline_id, get_string(STR_GLOBAL_CONTENT));
                }
            }
            break;
#if ((defined __MMI_EMAIL_CREATE_UE__) || (defined __MMI_EMAIL_INLINE_EDIT__))
        case CUI_INLINE_NOTIFY_ITEM_CHANGED:
            {
                if (event->item_id == MMI_EMAIL_COMP_SUBJECT_ITEM_ID)
                {
                    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_SUB;
                }
                else if (event->item_id == MMI_EMAIL_COMP_CONTENT_ITEM_ID)
                {
                    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_CON;
                }
            }
            break;
#endif /* #if ((defined __MMI_EMAIL_CREATE_UE__) || (defined __MMI_EMAIL_INLINE_EDIT__)) */
        default:
            break;
    }
}


void mmi_email_comp_inline_csk_press(cui_event_inline_csk_press_struct *event)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_INLINE_CSK_PRESS, __LINE__);

    switch (event->item_id)
    {
        case MMI_EMAIL_COMP_ATTACH_ITEM_ID:
            mmi_email_comp_attach();
            return;
        case MMI_EMAIL_COMP_TO_ITEM_ID:
        case MMI_EMAIL_COMP_CC_ITEM_ID:
        case MMI_EMAIL_COMP_BCC_ITEM_ID:
#ifdef __MMI_EMAIL_CREATE_UE__
            goto COMP_UE;
#else
            mmi_email_comp_goto_addr(MMI_EMAIL_COMP_ADDR_CT_ALL);
#endif
            break;
        case MMI_EMAIL_COMP_SUBJECT_ITEM_ID:
#ifdef __MMI_EMAIL_CREATE_UE__
            goto COMP_UE;
#else
            mmi_email_comp_edit_subject();
#endif
            break;
        case MMI_EMAIL_COMP_CONTENT_ITEM_ID:
#ifdef __MMI_EMAIL_CREATE_UE__
            goto COMP_UE;
#else
            mmi_email_comp_edit_content();
#endif
            break;
        default:
            break;
    }
#ifdef __MMI_EMAIL_CREATE_UE__
COMP_UE:
    //if (email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num >= 1)
    //{
    //    mmi_email_comp_send();
    //}
    //else
    {
        mmi_email_comp_goto_addr(email_app_comp.change_type);
    }
#endif
}


void mmi_email_entry_comp(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 display_index = 0;
    S32 inline_item_index = 0;
    U16 cap_str_id = 0, csk_icon_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_COMP, __LINE__);

#ifndef __MMI_EMAIL_CREATE_UE__
    email_comp_display_only_struct[display_index].default_text_id = STR_EMAIL_TO_ID;

    mmi_email_comp_init_inline_item_struct(
        &email_comp_inline_item[inline_item_index++],
        MMI_EMAIL_COMP_TO_ITEM_ID,
        CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY,
        IMG_EMAIL_TO_ID,
        &email_comp_display_only_struct[display_index++]);
    if (email_app_comp.first_hilit_field == MMI_EMAIL_COMP_FIRST_HILIT_TO)
    {
        cap_str_id = STR_EMAIL_TO_ID;
    }

    if (email_app_comp.is_show_cc_field)
    {
        email_comp_display_only_struct[display_index].default_text_id = STR_EMAIL_CC_ID;
        mmi_email_comp_init_inline_item_struct(
            &email_comp_inline_item[inline_item_index++],
            MMI_EMAIL_COMP_CC_ITEM_ID,
            CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY,
            IMG_EMAIL_CC_ID,
            &email_comp_display_only_struct[display_index++]);
    }

    if (email_app_comp.is_show_bcc_field)
    {
        email_comp_display_only_struct[display_index].default_text_id = STR_EMAIL_BCC_ID;
        mmi_email_comp_init_inline_item_struct(
            &email_comp_inline_item[inline_item_index++],
            MMI_EMAIL_COMP_BCC_ITEM_ID,
            CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY,
            IMG_EMAIL_BCC_ID,
            &email_comp_display_only_struct[display_index++]);
    }

    /* subject */
#ifdef __MMI_EMAIL_INLINE_EDIT__
    email_comp_text_edit_subject_struct.default_text_id = STR_GLOBAL_SUBJECT;
    email_comp_text_edit_subject_struct.buffer_size = MMI_EMAIL_MAX_SUBJ_LEN + 1;
    email_comp_text_edit_subject_struct.input_type = IMM_INPUT_TYPE_SENTENCE;

    mmi_email_comp_init_inline_item_struct(
        &email_comp_inline_item[inline_item_index++],
        MMI_EMAIL_COMP_SUBJECT_ITEM_ID,
        CUI_INLINE_ITEM_TYPE_TEXT_EDIT,
        IMG_EMAIL_SUBJECT_ID,
        &email_comp_text_edit_subject_struct);
#else
    email_comp_display_only_struct[display_index].default_text_id = STR_GLOBAL_SUBJECT;
    mmi_email_comp_init_inline_item_struct(
        &email_comp_inline_item[inline_item_index++],
        MMI_EMAIL_COMP_SUBJECT_ITEM_ID,
        CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY,
        IMG_EMAIL_SUBJECT_ID,
        &email_comp_display_only_struct[display_index++]);
#endif /* __MMI_EMAIL_INLINE_EDIT__ */

    /* attachment */
    if (email_app_comp.att_num > 0)
    {
        mmi_email_comp_init_inline_item_struct(
            &email_comp_inline_item[inline_item_index++],
            MMI_EMAIL_COMP_ATTACH_ITEM_ID,
            CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY,
            IMG_EMAIL_ATTACHMENT_ID,
            &email_comp_display_only_struct[display_index++]);
        email_app_comp.is_show_att_field = TRUE;
    }

    /* content */
#ifdef __MMI_EMAIL_INLINE_EDIT__
    email_comp_multiline_edit_content_struct.buffer_size = MMI_EMAIL_MAX_CONT_LEN + 1;
    email_comp_multiline_edit_content_struct.input_type = IMM_INPUT_TYPE_SENTENCE;

    mmi_email_comp_init_inline_item_struct(
        &email_comp_inline_item[inline_item_index++],
        MMI_EMAIL_COMP_CONTENT_ITEM_ID,
        CUI_INLINE_ITEM_TYPE_MULTILINE_EDIT | CUI_INLINE_ITEM_DISABLE_LIST_HIGHLIGHT,
        0,
        &email_comp_multiline_edit_content_struct);
#else
    email_comp_multi_rdonly_struct.height_of_item = 7;
    mmi_email_comp_init_inline_item_struct(
        &email_comp_inline_item[inline_item_index++],
        MMI_EMAIL_COMP_CONTENT_ITEM_ID,
        CUI_INLINE_ITEM_TYPE_MULTILINE_RD_ONLY | CUI_INLINE_ITEM_DISABLE_LIST_HIGHLIGHT,
        0,
        &email_comp_multi_rdonly_struct);
#endif /* #ifdef __MMI_EMAIL_INLINE_EDIT__ */

#else /* #ifndef __MMI_EMAIL_CREATE_UE__ */
    /* subject */
    email_comp_text_edit_struct.default_text_id = STR_GLOBAL_SUBJECT;
    email_comp_text_edit_struct.buffer_size = MMI_EMAIL_MAX_SUBJ_LEN + 1;
    email_comp_text_edit_struct.input_type = IMM_INPUT_TYPE_SENTENCE;
    mmi_email_comp_init_inline_item_struct(
        &email_comp_inline_item[inline_item_index++],
        MMI_EMAIL_COMP_SUBJECT_ITEM_ID,
        CUI_INLINE_ITEM_TYPE_TEXT_EDIT,
        IMG_EMAIL_SUBJECT_ID,
        &email_comp_text_edit_struct);

    /* content */
    //email_comp_multiline_edit_struct.cursor_p = 0;
    email_comp_multiline_edit_struct.buffer_size = MMI_EMAIL_MAX_CONT_LEN + 1;
    email_comp_multiline_edit_struct.input_type = IMM_INPUT_TYPE_SENTENCE;
    mmi_email_comp_init_inline_item_struct(
        &email_comp_inline_item[inline_item_index++],
        MMI_EMAIL_COMP_CONTENT_ITEM_ID,
        CUI_INLINE_ITEM_TYPE_MULTILINE_EDIT,
        0,
        &email_comp_multiline_edit_struct);

    /* attachment */
    if (email_app_comp.att_num)
    {
        mmi_email_comp_init_inline_item_struct(
            &email_comp_inline_item[inline_item_index++],
            MMI_EMAIL_COMP_ATTACH_ITEM_ID,
            CUI_INLINE_ITEM_TYPE_DISPLAY_ONLY,
            IMG_EMAIL_ATTACHMENT_ID,
            &email_comp_display_only_struct);
        email_app_comp.is_show_att_field = TRUE;
    }
    if (email_app_comp.first_hilit_field != MMI_EMAIL_COMP_FIRST_HILIT_CONTENT)
    {
        cap_str_id = STR_GLOBAL_SUBJECT;
    }
#endif /* #ifndef __MMI_EMAIL_CREATE_UE__ */

    if (email_app_comp.first_hilit_field == MMI_EMAIL_COMP_FIRST_HILIT_CONTENT)
    {
        cap_str_id = STR_GLOBAL_CONTENT;
    }
    email_comp_inline_struct.items_count = inline_item_index;
    email_comp_inline_struct.title = cap_str_id;
    email_comp_inline_struct.title_icon = GetRootTitleIcon(MENU_ID_EMAIL_MAIN);
    email_comp_inline_struct.screen_flag = CUI_INLINE_SCREEN_LOOP | CUI_INLINE_SCREEN_DISABLE_DONE | CUI_INLINE_SCREEN_DEFAULT_TEXT;
    email_comp_inline_struct.softkey = &email_comp_softkey_struct;
    email_comp_inline_struct.items = email_comp_inline_item;

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_COMP, __LINE__);

    email_app_comp.inline_id = cui_inline_create(email_app_comp.grp_id, &email_comp_inline_struct);

#ifdef __MMI_EMAIL_CREATE_UE__
    if (email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num >= 1)
    {
        csk_icon_id = IMG_GLOBAL_SEND_MSG_CSK;
    }
    else
#endif
    {
        csk_icon_id = IMG_GLOBAL_COMMON_CSK;
    }

#ifndef __MMI_EMAIL_CREATE_UE__
    cui_inline_set_item_attributes(
        email_app_comp.inline_id,
        MMI_EMAIL_COMP_TO_ITEM_ID,
        CUI_INLINE_SET_ATTRIBUTE,
        CUI_INLINE_ITEM_DEFAULT_TEXT);
    cui_inline_set_value(
        email_app_comp.inline_id,
        MMI_EMAIL_COMP_TO_ITEM_ID, 
        email_app_comp.to_display);
    cui_inline_set_softkey_icon(
        email_app_comp.inline_id,
        MMI_EMAIL_COMP_TO_ITEM_ID,
        MMI_CENTER_SOFTKEY,
        csk_icon_id);
    if (email_app_comp.is_show_cc_field)
    {
        cui_inline_set_item_attributes(
            email_app_comp.inline_id,
            MMI_EMAIL_COMP_CC_ITEM_ID,
            CUI_INLINE_SET_ATTRIBUTE,
            CUI_INLINE_ITEM_DEFAULT_TEXT);
        cui_inline_set_value(
            email_app_comp.inline_id,
            MMI_EMAIL_COMP_CC_ITEM_ID,
            email_app_comp.cc_display);
        cui_inline_set_softkey_icon(
            email_app_comp.inline_id,
            MMI_EMAIL_COMP_CC_ITEM_ID,
            MMI_CENTER_SOFTKEY,
            csk_icon_id);
    }
    if (email_app_comp.is_show_bcc_field)
    {
        cui_inline_set_item_attributes(
            email_app_comp.inline_id,
            MMI_EMAIL_COMP_BCC_ITEM_ID,
            CUI_INLINE_SET_ATTRIBUTE,
            CUI_INLINE_ITEM_DEFAULT_TEXT);
        cui_inline_set_value(
            email_app_comp.inline_id,
            MMI_EMAIL_COMP_BCC_ITEM_ID,
            email_app_comp.bcc_display);
        cui_inline_set_softkey_icon(
            email_app_comp.inline_id,
            MMI_EMAIL_COMP_BCC_ITEM_ID,
            MMI_CENTER_SOFTKEY,
            csk_icon_id);
    }
#endif

#ifndef __MMI_EMAIL_CREATE_UE__
    cui_inline_set_item_attributes(
        email_app_comp.inline_id,
        MMI_EMAIL_COMP_SUBJECT_ITEM_ID,
        CUI_INLINE_SET_ATTRIBUTE,
        CUI_INLINE_ITEM_DEFAULT_TEXT);
#else
    cui_inline_set_item_attributes(
        email_app_comp.inline_id,
        MMI_EMAIL_COMP_SUBJECT_ITEM_ID,
        CUI_INLINE_SET_ATTRIBUTE,
        CUI_INLINE_ITEM_DEFAULT_TEXT | CUI_INLINE_ITEM_DISABLE_LIST_HIGHLIGHT);
#endif

    cui_inline_set_value(
        email_app_comp.inline_id,
        MMI_EMAIL_COMP_SUBJECT_ITEM_ID,
        email_app_comp.subj);
    cui_inline_set_softkey_icon(
        email_app_comp.inline_id,
        MMI_EMAIL_COMP_SUBJECT_ITEM_ID,
        MMI_CENTER_SOFTKEY,
        csk_icon_id);
    if (email_app_comp.att_num)
    {
        cui_inline_set_value(
            email_app_comp.inline_id,
            MMI_EMAIL_COMP_ATTACH_ITEM_ID,
            email_app_comp.attach_display);
        cui_inline_set_softkey_icon(
            email_app_comp.inline_id,
            MMI_EMAIL_COMP_ATTACH_ITEM_ID,
            MMI_CENTER_SOFTKEY,
            IMG_GLOBAL_COMMON_CSK);
    }

    cui_inline_set_value(
        email_app_comp.inline_id,
        MMI_EMAIL_COMP_CONTENT_ITEM_ID,
        email_app_comp.content);
    cui_inline_set_softkey_icon(
        email_app_comp.inline_id,
        MMI_EMAIL_COMP_CONTENT_ITEM_ID,
        MMI_CENTER_SOFTKEY,
        csk_icon_id);
    if (email_app_comp.first_hilit_field == MMI_EMAIL_COMP_FIRST_HILIT_CONTENT)
    {
        cui_inline_set_highlight_item(email_app_comp.inline_id, MMI_EMAIL_COMP_CONTENT_ITEM_ID);
    }
    
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_COMP, __LINE__);
    email_app_comp.att_changed = FALSE;
    cui_inline_run(email_app_comp.inline_id);
}


#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_comp_tap_callback(mmi_tap_type_enum tap_type, S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 item_array[10] = {0}, i = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_TAP_CALLBACK, __LINE__);
#ifndef __MMI_EMAIL_CREATE_UE__
    item_array[i++] = MMI_EMAIL_COMP_TO_ITEM_ID;
    if (email_app_comp.is_show_cc_field)
    {
        item_array[i++] = MMI_EMAIL_COMP_CC_ITEM_ID;
    }
    if (email_app_comp.is_show_bcc_field)
    {
        item_array[i++] = MMI_EMAIL_COMP_BCC_ITEM_ID;
    }
    item_array[i++] = MMI_EMAIL_COMP_SUBJECT_ITEM_ID;
    if (email_app_comp.att_num)
    {
        item_array[i++] = MMI_EMAIL_COMP_ATTACH_ITEM_ID;
    }
    item_array[i++] = MMI_EMAIL_COMP_CONTENT_ITEM_ID;
    switch (item_array[index])
    {
        case MMI_EMAIL_COMP_TO_ITEM_ID:
        case MMI_EMAIL_COMP_CC_ITEM_ID:
        case MMI_EMAIL_COMP_BCC_ITEM_ID:
            mmi_email_comp_goto_addr(MMI_EMAIL_COMP_ADDR_CT_ALL);
            break;

        case MMI_EMAIL_COMP_SUBJECT_ITEM_ID:
#ifndef __MMI_EMAIL_INLINE_EDIT__
            mmi_email_comp_edit_subject();
#endif /* __MMI_EMAIL_INLINE_EDIT__ */
            break;

        case MMI_EMAIL_COMP_ATTACH_ITEM_ID:
            mmi_email_comp_attach();
            break;

        case MMI_EMAIL_COMP_CONTENT_ITEM_ID:
#ifndef __MMI_EMAIL_INLINE_EDIT__
            mmi_email_comp_edit_content();
#endif /* __MMI_EMAIL_INLINE_EDIT__ */
            break;

        default:
            if (tap_type == ENUM_TAP_ON_HIGHLIGHTED_ITEM)
            {
                mmi_email_comp_addr_edit();
            }
            break;
    }
#else
    item_array[i++] = MMI_EMAIL_COMP_SUBJECT_ITEM_ID;
    item_array[i++] = MMI_EMAIL_COMP_CONTENT_ITEM_ID;
    if (email_app_comp.att_num)
    {
        item_array[i++] = MMI_EMAIL_COMP_ATTACH_ITEM_ID;
    }
    switch (item_array[index])
    {
        case 0:
            break;
        case 1:
            break;
        case 2:
            mmi_email_comp_attach();
            break;
        default:
            break;
    }
#endif
}
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */


#ifdef __MMI_ICON_BAR_SUPPORT__
/*****************************************************************************
* FUNCTION
*  mmi_email_comp_tb_callback
* DESCRIPTION
*  
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
static void mmi_email_comp_tb_callback(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_TB_CALLBACK, __LINE__);

    if (index == MMI_EMAIL_COMP_TB_SEND_MESSAGE)
    {
        mmi_email_comp_send();
    }
    else
    {
        mmi_email_comp_attach_add_new(email_app_comp.grp_id);
    }
}
#endif /* __MMI_ICON_BAR_SUPPORT__ */


BOOL mmi_email_comp_append_template(WCHAR *text)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 orig_text_len = 0, appd_text_len = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_APPEND_TEMPLATE, __LINE__);

#if ((defined __MMI_EMAIL_CREATE_UE__) || (defined __MMI_EMAIL_INLINE_EDIT__))
    orig_text_len = mmi_wcslen(email_app_comp.content);
#else
    orig_text_len = cui_fseditor_get_text_len(email_app_comp.fseditor_id);
#endif

    appd_text_len = mmi_wcslen(text);
    if (appd_text_len == 0)
    {
        return TRUE;
    }

    if (orig_text_len + appd_text_len > MMI_EMAIL_MAX_CONT_LEN)
    {
        mmi_email_lib_error_popup(STR_EMAIL_NO_SPACE_ID);
        return FALSE;
    }

#if ((defined __MMI_EMAIL_CREATE_UE__) || (defined __MMI_EMAIL_INLINE_EDIT__))
    cui_inline_multiline_append_string(
        email_app_comp.inline_id,
        MMI_EMAIL_COMP_CONTENT_ITEM_ID,
        (U8*)text);
#else
    cui_fseditor_append_text(email_app_comp.fseditor_id, text);
#endif

    return TRUE;
}


void mmi_email_comp_goto_addr(email_app_comp_addr_ct_enum type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GOTO_ADDR, __LINE__);

    email_app_comp.addr_grp_id = mmi_frm_group_create(
        email_app_comp.grp_id,
        GRP_ID_AUTO_GEN,
        mmi_email_comp_addr_proc,
        (void*)(&email_app_comp));
    mmi_frm_group_enter(email_app_comp.addr_grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    email_app_comp.curr_hilit_addr_index = 0;
#ifdef __MMI_EMAIL_CREATE_UE__
    email_app_comp.change_type = type;
#else
    email_app_comp.change_type = MMI_EMAIL_COMP_ADDR_CT_ALL;
#endif
    mmi_email_entry_comp_addr();
}


static void mmi_email_comp_addr_fill_display_info(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_FILL_DISPLAY_INFO, __LINE__);
    if (email_app_comp.to_num != 0)
    {
        if (mmi_wcslen(email_app_comp.addr_list[0].email_addr))
        {
            if (email_app_comp.addr_list[0].disp_name_len)
            {
                kal_wsprintf(
                    email_app_comp.to_display,
                    "%w%w%w%w",
                    email_app_comp.addr_list[0].disp_name,
                    g_email_subj_left_op,
                    email_app_comp.addr_list[0].email_addr,
                    g_email_subj_right_op);
            }
            else
            {
                mmi_wcscpy(email_app_comp.to_display, email_app_comp.addr_list[0].email_addr);
            }
            if (email_app_comp.to_num > 1)
            {
                mmi_wcscat(email_app_comp.to_display, g_email_2dots);
            }
        }
    }
    else
    {
        email_app_comp.to_display[0] = L'\0';
    }
    srv_email_msg_update_recipient(
        email_app_comp.msg_handle,
        SRV_EMAIL_ADDR_TYPE_TO,
        email_app_comp.to_num,
        email_app_comp.addr_list);
    if (email_app_comp.cc_num != 0)
    {
        if (mmi_wcslen(email_app_comp.addr_list[email_app_comp.to_num].email_addr))
        {
            if (email_app_comp.addr_list[email_app_comp.to_num].disp_name_len)
            {
                kal_wsprintf(
                    email_app_comp.cc_display,
                    "%w%w%w%w",
                    email_app_comp.addr_list[email_app_comp.to_num].disp_name,
                    g_email_subj_left_op,
                    email_app_comp.addr_list[email_app_comp.to_num].email_addr,
                    g_email_subj_right_op);
            }
            else
            {
                mmi_wcscpy(email_app_comp.cc_display, email_app_comp.addr_list[email_app_comp.to_num].email_addr);
            }
            if (email_app_comp.cc_num > 1)
            {
                mmi_wcscat(email_app_comp.cc_display, g_email_2dots);
            }
        }
    }
    else
    {
        email_app_comp.cc_display[0] = L'\0';
    }
    srv_email_msg_update_recipient(
        email_app_comp.msg_handle,
        SRV_EMAIL_ADDR_TYPE_CC,
        email_app_comp.cc_num,
        &email_app_comp.addr_list[email_app_comp.to_num]);
    if (email_app_comp.bcc_num != 0)
    {
        if (mmi_wcslen(email_app_comp.addr_list[email_app_comp.to_num + email_app_comp.cc_num].email_addr))
        {
            if (email_app_comp.addr_list[email_app_comp.to_num + email_app_comp.cc_num].disp_name_len)
            {
                kal_wsprintf(
                    email_app_comp.bcc_display,
                    "%w%w%w%w",
                    email_app_comp.addr_list[email_app_comp.to_num + email_app_comp.cc_num].disp_name,
                    g_email_subj_left_op,
                    email_app_comp.addr_list[email_app_comp.to_num + email_app_comp.cc_num].email_addr,
                    g_email_subj_right_op);
            }
            else
            {
                mmi_wcscpy(
                    email_app_comp.bcc_display,
                    email_app_comp.addr_list[email_app_comp.to_num + email_app_comp.cc_num].email_addr);
            }
            if (email_app_comp.bcc_num > 1)
            {
                mmi_wcscat(email_app_comp.bcc_display, g_email_2dots);
            }
        }
    }
    else
    {
        email_app_comp.bcc_display[0] = L'\0';
    }
    srv_email_msg_update_recipient(
        email_app_comp.msg_handle,
        SRV_EMAIL_ADDR_TYPE_BCC,
        email_app_comp.bcc_num,
        &email_app_comp.addr_list[email_app_comp.to_num + email_app_comp.cc_num]);
}


static mmi_ret mmi_email_comp_addr_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (menu_evt->evt_id)
    {
        case EVT_ID_GROUP_FOCUSED:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_PROC, __LINE__);
            mmi_email_set_active_group_id(email_app_comp.addr_grp_id);
            break;
        case EVT_ID_GROUP_DEINIT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_PROC, __LINE__);
            if ((email_app_comp.save_part & MMI_EMAIL_COMP_SAVE_TO))
            {
                mmi_email_comp_addr_fill_display_info();
            }
            break;
        case EVT_ID_CUI_MENU_LIST_ENTRY:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_PROC, __LINE__);
            mmi_email_comp_addr_hide_menu(menu_evt->app_data, menu_evt->sender_id);
            break;
        case EVT_ID_CUI_MENU_ITEM_SELECT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_PROC, __LINE__);
            mmi_email_comp_addr_options_handler(menu_evt->app_data, menu_evt->highlighted_menu_id, menu_evt->sender_id);
            break;
        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_PROC, __LINE__);
            cui_menu_close(menu_evt->sender_id);
            break;
        case EVT_ID_CUI_FSEDITOR_SUBMMIT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_PROC, __LINE__);
            {
                srv_email_addr_struct *addr = OslMalloc(sizeof(srv_email_addr_struct));
                cui_fseditor_get_text(
                    email_app_comp.fseditor_id,
                    addr->email_addr,
                    sizeof(addr->email_addr));
                if (mmi_wcslen(addr->email_addr) == 0)
                {
                    mmi_email_lib_error_popup(STR_EMAIL_COMP_UE_PLZ_ADD_RECIPIENT_ID);
                    OslMfree(addr);
                }
                else if (!mmi_email_util_chk_addr(addr->email_addr))
                {
                    mmi_email_lib_error_popup(STR_GLOBAL_INVALID_EMAIL_ADDRESS);
                    OslMfree(addr);
                }
                else
                {
                    mmi_email_comp_addr_addr_recent_add_single(addr->email_addr);

                    memcpy(&email_editing_addr_buff.email_addr, &addr->email_addr, sizeof(addr->email_addr));
                    OslMfree(addr);
                    if (email_app_comp.is_new_address)
                    {
                        mmi_email_comp_addr_add_to_list();
                        email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
                    }
                    else
                    {
                        mmi_email_comp_addr_update_item();
                        email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
                    }
                    cui_fseditor_close(email_app_comp.fseditor_id);
                    email_app_comp.fseditor_id = 0;
                }
            }
            break;
        case EVT_ID_CUI_FSEDITOR_ABORT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_PROC, __LINE__);
            cui_fseditor_close(email_app_comp.fseditor_id);
            email_app_comp.fseditor_id = 0;
            break;
        case EVT_ID_CUI_FSEDITOR_CUSTOM_MENU_SELECTED:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_PROC, __LINE__);
            mmi_email_comp_addr_add_phb();
            break;
        case EVT_ID_PHB_SELECT_CONTACT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_PROC, __LINE__);
            {
                cui_phb_select_contact_result_struct *phb_data = (cui_phb_select_contact_result_struct*)evt;
                mmi_wcscpy(email_editing_addr_buff.email_addr, (WCHAR*)phb_data->select_data);
                mmi_wcsncpy(email_editing_addr_buff.disp_name, (WCHAR*)phb_data->name, SRV_EMAIL_MAX_DISP_NAME_LEN);
                email_editing_addr_buff.disp_name_len = mmi_wcslen(email_editing_addr_buff.disp_name);
                email_editing_addr_buff.disp_charset = MMI_CHSET_UCS2;
                if (email_app_comp.fseditor_id != GRP_ID_INVALID)
                {
                    cui_fseditor_set_text(
                        email_app_comp.fseditor_id,
                        email_editing_addr_buff.email_addr,
                        (SRV_EMAIL_MAX_ADDR_LEN + 1) * ENCODING_LENGTH,
                        SRV_EMAIL_MAX_ADDR_LEN);
                }
                else
                {
                    mmi_email_comp_addr_add_to_list();
                    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
                }
                cui_phb_list_select_contact_close(phb_data->sender_id);
                email_app_comp.phb_cui_id = 0;
            }
            break;
        case EVT_ID_PHB_SELECT_CONTACT_CANCEL:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_PROC, __LINE__);
            {
                cui_phb_select_contact_result_struct *phb_data = (cui_phb_select_contact_result_struct*)evt;
                cui_phb_list_select_contact_close(phb_data->sender_id);
                email_app_comp.phb_cui_id = 0;
            }
            break;
    }
    return MMI_RET_OK;
}


void mmi_email_entry_comp_addr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 num_items = 0, cap_str = 0;
    U8 *gui_buffer = NULL;
    BOOL show_max_screen = FALSE;
    S32 total_addr_num = 0, addr_type_num = 0, highlight_index = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_COMP_ADDR, __LINE__);

    total_addr_num = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
    if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_ALL)
    {
        if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_TO_ITEM_ID)
        {
            addr_type_num = email_app_comp.to_num;
            cap_str = STR_EMAIL_TO_ID;
        }
        else if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_CC_ITEM_ID)
        {
            addr_type_num = email_app_comp.cc_num;
            cap_str = STR_EMAIL_CC_ID;
        }
        else
        {
            addr_type_num = email_app_comp.bcc_num;
            cap_str = STR_EMAIL_BCC_ID;
        }
    }
    else
    {
        addr_type_num = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
        cap_str = STR_EMAIL_ADDRESS_LIST_ID;
    }
    if (addr_type_num == 0)
    {
        if (total_addr_num == MMI_EMAIL_MAX_ADDR_NUM)
        {
            show_max_screen = TRUE;
        }
        else
        {
            num_items = MMI_EMAIL_COMP_DEFAULT_ADDR_LIST_ITEM_NUM;
        }
    }
    else
    {
        if (total_addr_num == MMI_EMAIL_MAX_ADDR_NUM)
        {
            num_items = addr_type_num;
        }
        else
        {
            num_items = addr_type_num + MMI_EMAIL_COMP_ADDR_FIX_TOTAL;
        }
    }
    if (show_max_screen)
    {
        mmi_email_lib_error_popup(STR_EMAIL_COMP_MAX_ADDR_REACHED_ID);
        return;
    }

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_COMP_ADDR, __LINE__);

    if (!mmi_frm_scrn_enter(
            email_app_comp.addr_grp_id,
            SCR_ID_EMAIL_COMP_ADDR,
            NULL,
            mmi_email_entry_comp_addr,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_COMP_ADDR, __LINE__);
        return;
    }
    gui_buffer = mmi_frm_scrn_get_active_gui_buf();
    if (gui_buffer == NULL)
    {
        if (addr_type_num == 0)
        {
            if (total_addr_num == MMI_EMAIL_MAX_ADDR_NUM)
            {
                highlight_index = 0;
            }
            else
            {
                highlight_index = MMI_EMAIL_COMP_DEFAULT_ADDR_HL_WITHOUT_RECP;
            }
        }
        else
        {
            if (total_addr_num == MMI_EMAIL_MAX_ADDR_NUM)
            {
                highlight_index = 0;
            }
            else
            {
                highlight_index = MMI_EMAIL_COMP_DEFAULT_ADDR_HL_WITH_RECP;
            }
        }
    }
    else
    {
        list_menu_category_history *h = (list_menu_category_history*)gui_buffer;
        highlight_index = email_app_comp.curr_hilit_addr_index;
        h->highlighted_item = highlight_index;
    }
    RegisterHighlightHandler(mmi_email_comp_addr_hilit_handler);
    wgui_fixed_list_register_get_flags_handler(mmi_email_comp_addr_get_seperator_line);

    if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_ALL)
    {
        EnableCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    }
    else
    {
        EnableCenterSoftkey(0, IMG_GLOBAL_SEND_MSG_CSK);
    }

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_COMP_ADDR, __LINE__);
    ShowCategory184Screen(
        cap_str,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        num_items,
        mmi_email_comp_addr_get_item,
        mmi_email_comp_addr_get_item_hint,
        highlight_index,
        gui_buffer);

    SetRightSoftkeyFunction(mmi_frm_scrn_close_active_id, KEY_EVENT_UP);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
    wgui_register_tap_callback(mmi_email_comp_addr_tap_callback);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

    mmi_frm_scrn_set_leave_proc(
        email_app_comp.addr_grp_id,
        SCR_ID_EMAIL_COMP_ADDR,
        mmi_email_comp_addr_del_callback);
}


static mmi_ret mmi_email_comp_addr_del_callback(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_DEL_CALLBACK, __LINE__);
    switch (evt->evt_id)
    {
        case EVT_ID_SCRN_GOBACK_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ:
        case EVT_ID_SCRN_GOBACK:
            if (email_app_comp.phb_cui_id && mmi_frm_group_is_present(email_app_comp.phb_cui_id))
            {
                cui_phb_list_select_contact_close(email_app_comp.phb_cui_id);
                email_app_comp.phb_cui_id = 0;
            }
            if (email_app_comp.fseditor_id && mmi_frm_group_is_present(email_app_comp.fseditor_id))
            {
                cui_fseditor_close(email_app_comp.fseditor_id);
                email_app_comp.fseditor_id = 0;
            }
            break;
    }
    return MMI_RET_OK;
}


static void mmi_email_comp_addr_hilit_handler(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 total_addr_num = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_HILIT_HANDLER, __LINE__);

    email_app_comp.curr_hilit_addr_index = index;
    total_addr_num = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
    if (total_addr_num != MMI_EMAIL_MAX_ADDR_NUM)
    {
        switch (index)
        {
            case MMI_EMAIL_COMP_ADDR_FIX_ADD_NEW:
                {
#ifdef __MMI_EMAIL_CREATE_UE__
                    ChangeLeftSoftkey(STR_GLOBAL_OPTIONS, 0);
                    SetLeftSoftkeyFunction(mmi_email_comp_addr_opt, KEY_EVENT_UP);
#else
                    ChangeLeftSoftkey(STR_GLOBAL_OK, 0);
                    SetLeftSoftkeyFunction(mmi_email_comp_addr_add_new, KEY_EVENT_UP);
#endif
                    ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
                    SetCenterSoftkeyFunction(mmi_email_comp_addr_add_new, KEY_EVENT_UP);
                    SetKeyHandler(NULL, KEY_SEND, KEY_EVENT_UP);
                }
                return;
            case MMI_EMAIL_COMP_ADDR_FIX_ADD_PHB:
                {
#ifdef __MMI_EMAIL_CREATE_UE__
                    ChangeLeftSoftkey(STR_GLOBAL_OPTIONS, 0);
                    SetLeftSoftkeyFunction(mmi_email_comp_addr_opt, KEY_EVENT_UP);
#else
                    ChangeLeftSoftkey(STR_GLOBAL_OK, 0);
                    SetLeftSoftkeyFunction(mmi_email_comp_addr_add_phb, KEY_EVENT_UP);
#endif
                    ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
                    SetCenterSoftkeyFunction(mmi_email_comp_addr_add_phb, KEY_EVENT_UP);
                    SetKeyHandler(NULL, KEY_SEND, KEY_EVENT_UP);
                }
                return;

            case MMI_EMAIL_COMP_ADDR_FIX_ADD_RECENT:
                {
#ifdef __MMI_EMAIL_CREATE_UE__
                    ChangeLeftSoftkey(STR_GLOBAL_OPTIONS, 0);
                    SetLeftSoftkeyFunction(mmi_email_comp_addr_opt, KEY_EVENT_UP);
#else
                    ChangeLeftSoftkey(STR_GLOBAL_OK, 0);
                    SetLeftSoftkeyFunction(mmi_email_comp_addr_add_recent, KEY_EVENT_UP);
#endif
                    ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
                    SetCenterSoftkeyFunction(mmi_email_comp_addr_add_recent, KEY_EVENT_UP);
                    SetKeyHandler(NULL, KEY_SEND, KEY_EVENT_UP);
                }
                return;

            default:
                break;
        }
    }
    if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_ALL)
    {
        ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
        SetCenterSoftkeyFunction(mmi_email_comp_addr_edit, KEY_EVENT_UP);
        SetKeyHandler(NULL, KEY_SEND, KEY_EVENT_UP);
    }
    else
    {
        if (total_addr_num > 0)
        {
            ChangeCenterSoftkey(0, IMG_GLOBAL_SEND_MSG_CSK);
            SetCenterSoftkeyFunction(mmi_email_comp_send, KEY_EVENT_UP);
            SetKeyHandler(mmi_email_comp_send, KEY_SEND, KEY_EVENT_UP);
        }
        else
        {
            ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
            SetCenterSoftkeyFunction(mmi_email_comp_addr_edit, KEY_EVENT_UP);
            SetKeyHandler(NULL, KEY_SEND, KEY_EVENT_UP);
        }
    }
    ChangeLeftSoftkey(STR_GLOBAL_OPTIONS, 0);
    SetLeftSoftkeyFunction(mmi_email_comp_addr_opt, KEY_EVENT_UP);
}


static MMI_BOOL mmi_email_comp_addr_get_seperator_line(S32 index, U32* flag, U32* flag_ex)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 addr_type_num = 0;
    U32 total_addr_num = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_GET_SEPERATOR_LINE, __LINE__);

    if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_ALL)
    {
        if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_TO_ITEM_ID)
        {
            addr_type_num = email_app_comp.to_num;
        }
        else if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_CC_ITEM_ID)
        {
            addr_type_num = email_app_comp.cc_num;
        }
        else
        {
            addr_type_num = email_app_comp.bcc_num;
        }
    }
    else
    {
        addr_type_num = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
    }
    total_addr_num = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
    if (total_addr_num != MMI_EMAIL_MAX_ADDR_NUM)
    {
        if (index < MMI_EMAIL_COMP_ADDR_FIX_TOTAL)
        {
            *flag |= UI_MENUITEM_DISABLE_ICON;
        }
        else if (index == MMI_EMAIL_COMP_ADDR_FIX_TOTAL)
        {
            *flag_ex |= UI_MENUITEM_EXT_SHOW_SEPARATORLINE;
            if (addr_type_num == 0)
            {
                *flag |= UI_MENUITEM_DISABLE_ICON;
                *flag |= UI_MENUITEM_STATE_DISABLED;
            }
        }
    }
    return MMI_TRUE;
}


static pBOOL mmi_email_comp_addr_get_item(S32 item_index, UI_string_type str_buff, PU8 *img_buff_p, U8 str_img_mask)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 addr_type_num = 0, addr_start_index = 0;
    U32 total_addr_num = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_GET_ITEM, __LINE__);
    if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_ALL)
    {
        if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_TO_ITEM_ID)
        {
            addr_type_num = email_app_comp.to_num;
            addr_start_index = 0;
        }
        else if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_CC_ITEM_ID)
        {
            addr_type_num = email_app_comp.cc_num;
            addr_start_index = email_app_comp.to_num;
        }
        else
        {
            addr_type_num = email_app_comp.bcc_num;
            addr_start_index = email_app_comp.to_num + email_app_comp.cc_num;
        }
    }
    else
    {
        addr_type_num = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
        addr_start_index = 0;
    }
    total_addr_num = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
    if ((item_index < 0) || ((addr_type_num == 0) && (item_index > MMI_EMAIL_COMP_ADDR_FIX_TOTAL)) ||
        ((addr_type_num > 0) && (item_index > (addr_type_num + MMI_EMAIL_COMP_ADDR_FIX_TOTAL))))
    {
        return FALSE;
    }
    else
    {
        *img_buff_p = NULL;
        if (total_addr_num != MMI_EMAIL_MAX_ADDR_NUM)
        {
            switch (item_index)
            {
                case MMI_EMAIL_COMP_ADDR_FIX_ADD_NEW:
                    {
                        mmi_wcscpy(
                            (WCHAR*)str_buff,
                            (WCHAR*)GetString(STR_EMAIL_COMP_UE_ADDR_ADD_NEW_ID));
                    }
                    return TRUE;
                case MMI_EMAIL_COMP_ADDR_FIX_ADD_RECENT:
                    {
                        mmi_wcscpy(
                            (WCHAR*)str_buff,
                            (WCHAR*)GetString(STR_EMAIL_COMP_RECENT_INPUT_ID));
                    }
                    return TRUE;
                case MMI_EMAIL_COMP_ADDR_FIX_ADD_PHB:
                    {
                        mmi_wcscpy(
                            (WCHAR*)str_buff,
                            (WCHAR*)GetString(STR_EMAIL_COMP_UE_ADDR_ADD_FROM_PHB_ID));
                    }
                    return TRUE;
                default:
                    break;
            }
        }
        if (addr_type_num == 0)
        {
            mmi_wcscpy(
                (WCHAR*)str_buff,
                (WCHAR*)GetString(STR_GLOBAL_EMPTY_LIST));
        }
        else
        {
            WCHAR *addr_p = NULL;
            S32 addr_len = 0;
            S32 dot_len = mmi_wcslen(g_email_2dots);

            if (total_addr_num != MMI_EMAIL_MAX_ADDR_NUM)
            {
                addr_p = email_app_comp.addr_list[addr_start_index + item_index - MMI_EMAIL_COMP_ADDR_FIX_TOTAL].email_addr;
            }
            else
            {
                addr_p = email_app_comp.addr_list[addr_start_index + item_index].email_addr;
            }
            addr_len = mmi_wcslen(addr_p);
            if (addr_len > MAX_SUBMENU_CHARACTERS)
            {
                mmi_wcsncpy((WCHAR*)str_buff, addr_p, MAX_SUBMENU_CHARACTERS - dot_len);
                mmi_wcscat((WCHAR*)str_buff, g_email_2dots);
            }
            else
            {
                mmi_wcscpy((WCHAR*)str_buff, addr_p);
            }
            if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_ALL)
            {
                if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_TO_ITEM_ID)
                {
                    *img_buff_p = get_image(IMG_EMAIL_TO_ID);
                }
                else if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_CC_ITEM_ID)
                {
                    *img_buff_p = get_image(IMG_EMAIL_CC_ID);
                }
                else
                {
                    *img_buff_p = get_image(IMG_EMAIL_BCC_ID);
                }
            }
            else
            {
                S32 index = 0;
                if (total_addr_num != MMI_EMAIL_MAX_ADDR_NUM)
                {
                    index = item_index - MMI_EMAIL_COMP_ADDR_FIX_TOTAL;
                }
                else
                {
                    index = item_index;
                }
                if (index < (S32)email_app_comp.to_num)
                {
                    *img_buff_p = get_image(IMG_EMAIL_TO_ID);
                }
                else if (index < (S32)(email_app_comp.to_num + email_app_comp.cc_num))
                {
                    *img_buff_p = get_image(IMG_EMAIL_CC_ID);
                }
                else
                {
                    *img_buff_p = get_image(IMG_EMAIL_BCC_ID);
                }
            }
        }
        return TRUE;
    }
}


static S32 mmi_email_comp_addr_get_item_hint(S32 item_index, UI_string_type *hint_array)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 addr_type_num = 0, addr_start_index = 0;
    U32 total_addr_num = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_GET_ITEM_HINT, __LINE__);
    if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_ALL)
    {
        if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_TO_ITEM_ID)
        {
            addr_type_num = email_app_comp.to_num;
            addr_start_index = 0;
        }
        else if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_CC_ITEM_ID)
        {
            addr_type_num = email_app_comp.cc_num;
            addr_start_index = email_app_comp.to_num;
        }
        else
        {
            addr_type_num = email_app_comp.bcc_num;
            addr_start_index = email_app_comp.to_num + email_app_comp.cc_num;
        }
    }
    else
    {
        addr_type_num = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
        addr_start_index = 0;
    }
    total_addr_num = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
    if ((item_index < 0) || ((addr_type_num == 0) && (item_index > MMI_EMAIL_COMP_ADDR_FIX_TOTAL)) ||
        ((addr_type_num > 0) && (item_index > (addr_type_num + MMI_EMAIL_COMP_ADDR_FIX_TOTAL))))
    {
        return 0;
    }
    else
    {
        if (total_addr_num != MMI_EMAIL_MAX_ADDR_NUM)
        {
            switch (item_index)
            {
                case MMI_EMAIL_COMP_ADDR_FIX_ADD_NEW:
                case MMI_EMAIL_COMP_ADDR_FIX_ADD_RECENT:
                case MMI_EMAIL_COMP_ADDR_FIX_ADD_PHB:
                    ((WCHAR*)hint_array[0])[0] = L'\0';
                    return 0;
                default:
                    break;
            }
        }
        if (addr_type_num == 0)
        {
            ((WCHAR*)hint_array[0])[0] = L'\0';
            return 0;
        }
        else
        {
            S32 index = 0;
            WCHAR *disp_name_p = NULL;
            S32 disp_name_len = 0;
            S32 dot_len = mmi_wcslen(g_email_2dots);

            if (total_addr_num != MMI_EMAIL_MAX_ADDR_NUM)
            {
                index = addr_start_index + item_index - MMI_EMAIL_COMP_ADDR_FIX_TOTAL;
            }
            else
            {
                index = addr_start_index + item_index;
            }
            if (email_app_comp.addr_list[index].disp_name_len != 0)
            {
                disp_name_p = email_app_comp.addr_list[index].disp_name;
                disp_name_len = mmi_wcslen(disp_name_p);
                if (disp_name_len > MAX_SUBMENU_CHARACTERS)
                {
                    mmi_wcsncpy((WCHAR*)hint_array[0], disp_name_p, MAX_SUBMENU_CHARACTERS - dot_len);
                    mmi_wcscat((WCHAR*)hint_array[0], g_email_2dots);
                }
                else
                {
                    mmi_wcscpy((WCHAR*)hint_array[0], disp_name_p);
                }
                return 1;
            }
            else
            {
                ((WCHAR*)hint_array[0])[0] = L'\0';
                return 0;
            }
        }
    }
}


#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_comp_addr_tap_callback(mmi_tap_type_enum tap_type, S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 total_num = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_TAP_CALLBACK, __LINE__);
    if (total_num != MMI_EMAIL_MAX_ADDR_NUM)
    {
        switch (index)
        {
            case MMI_EMAIL_COMP_ADDR_FIX_ADD_NEW:
                mmi_email_comp_addr_add_new();
                return;
            case MMI_EMAIL_COMP_ADDR_FIX_ADD_PHB:
                mmi_email_comp_addr_add_phb();
                return;
            case MMI_EMAIL_COMP_ADDR_FIX_ADD_RECENT:
                mmi_email_comp_addr_add_recent();
                return;
            default:
                break;
        }
    }
    if (tap_type == ENUM_TAP_ON_HIGHLIGHTED_ITEM)
    {
        mmi_email_comp_addr_edit();
    }
}
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */


static void mmi_email_comp_addr_add_new(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_ADD_NEW, __LINE__);

    email_app_comp.is_new_address = TRUE;
    memset(&email_editing_addr_buff, 0, sizeof(srv_email_addr_struct));
    email_editing_addr_buff.disp_charset = MMI_CHSET_UCS2;
    email_app_comp.fseditor_id = cui_fseditor_create(email_app_comp.addr_grp_id);
    cui_fseditor_set_title(email_app_comp.fseditor_id, STR_EMAIL_INPUT_ADDRESS_ID, GetRootTitleIcon(MENU_ID_EMAIL_MAIN));
    cui_fseditor_set_text(
        email_app_comp.fseditor_id,
        email_editing_addr_buff.email_addr,
        sizeof(email_editing_addr_buff.email_addr),
        SRV_EMAIL_MAX_ADDR_LEN);
    cui_fseditor_set_input_method(
        email_app_comp.fseditor_id,
        IMM_INPUT_TYPE_EMAIL,
        NULL,
        0);
    cui_fseditor_set_custom_options_menu(
        email_app_comp.fseditor_id,
        MMI_FALSE,
        email_app_comp_addr_search,
        sizeof(email_app_comp_addr_search) / sizeof(mmi_menu_id));
    cui_fseditor_run(email_app_comp.fseditor_id);
}


static void mmi_email_comp_addr_add_phb(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_ADD_PHB, __LINE__);

    email_app_comp.phb_cui_id = cui_phb_list_select_contact_create(email_app_comp.addr_grp_id);
    if (email_app_comp.phb_cui_id != GRP_ID_INVALID)
    {
        cui_phb_list_select_contact_set_field_filter(email_app_comp.phb_cui_id, SRV_PHB_ENTRY_FIELD_EMAIL);
        cui_phb_list_select_contact_run(email_app_comp.phb_cui_id);
    }
}



static mmi_ret mmi_email_comp_addr_add_recent_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_ADD_RECENT_PROC, __LINE__);
    switch (menu_evt->evt_id)
    {
        case EVT_ID_GROUP_FOCUSED:
            mmi_email_set_active_group_id(email_app_comp.rinput_grp_id);
            break;

        case EVT_ID_CUI_MENU_LIST_ENTRY:
            mmi_email_comp_addr_add_recent_option_hide(menu_evt->sender_id);
            break;

        case EVT_ID_CUI_MENU_ITEM_SELECT:
            mmi_email_comp_addr_add_recent_option_action(menu_evt->highlighted_menu_id);
            cui_menu_close(menu_evt->sender_id);
            break;

        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
            cui_menu_close(menu_evt->sender_id);
            break;
    }
    return MMI_RET_OK;
}

static void mmi_email_comp_addr_add_recent(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_ADD_RECENT, __LINE__);
    if (g_recent_addr_list_p == NULL || g_recent_addr_list_p->curr_addr_num <= 0)
    {
        mmi_email_lib_error_popup(STR_GLOBAL_EMPTY);
        return;
    }

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_UE_RECENT_CONTACT_TOTAL_LOADED, g_recent_addr_list_p->curr_addr_num);

    /* RESET */
    for (i = 0; i < g_recent_addr_list_p->curr_addr_num; i++)
    {
        g_recent_addr_list_p->state[i] = 0;
    }

    email_app_comp.rinput_grp_id = mmi_frm_group_create(
        email_app_comp.addr_grp_id,
        GRP_ID_AUTO_GEN,
        mmi_email_comp_addr_add_recent_proc,
        (void*)NULL);
    mmi_frm_group_enter(email_app_comp.rinput_grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);

    mmi_email_comp_addr_add_recent_screen();
}


static void mmi_email_comp_addr_add_recent_screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *gui_buffer;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_ADD_RECENT_SCREEN, __LINE__);
    if (MMI_TRUE == mmi_frm_scrn_enter(
                        email_app_comp.rinput_grp_id, 
                        SCR_ID_EMAIL_COMP_RECENT_ADDR,
                        NULL,
                        (FuncPtr)mmi_email_comp_addr_add_recent_screen, 
                        MMI_FRM_FULL_SCRN))
    {
        U8 i;
        static WCHAR* addr_ptr[MMI_EMAIL_MAX_RECENT_INPUT_NUM];
        
        for (i = 0; i < g_recent_addr_list_p->curr_addr_num; i++)
        {
            addr_ptr[i] = g_recent_addr_list_p->addr[i];
        }

        RegisterHighlightHandler(mmi_email_comp_addr_add_recent_highlight_hdlr);
        EnableCenterSoftkey(0, IMG_GLOBAL_MARK_CSK);
        gui_buffer = mmi_frm_scrn_get_active_gui_buf();
        ShowCategory12Screen(
            STR_EMAIL_COMP_RECENT_INPUT_ID,
            GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
            STR_GLOBAL_OPTIONS,
            IMG_GLOBAL_OPTIONS,
            STR_GLOBAL_BACK,
            IMG_GLOBAL_BACK,
            g_recent_addr_list_p->curr_addr_num,
            (U8 **) addr_ptr,
            (U8*) g_recent_addr_list_p->state,
            0,
            gui_buffer);

#ifdef __MMI_TOUCH_SCREEN__
        wgui_register_list_item_selected_callback_all(mmi_note_mark_several_pen_down);
#endif /* __MMI_TOUCH_SCREEN__ */

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
        wgui_register_tap_callback(mmi_email_comp_addr_add_recent_fte_tap_callback);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

        /* set key handler of ENTER and STAR */
        // SetKeyHandler(mmi_note_mark_several_change_mark_state, KEY_STAR, KEY_EVENT_UP);

        SetLeftSoftkeyFunction(mmi_email_comp_addr_add_recent_option_lsk, KEY_EVENT_UP);
        SetRightSoftkeyFunction(mmi_email_comp_addr_add_recent_option_rsk, KEY_EVENT_UP);
        SetCenterSoftkeyFunction(mmi_email_comp_addr_add_recent_option_csk, KEY_EVENT_UP);
    }
}

#ifdef __MMI_TOUCH_SCREEN__
static void mmi_note_mark_several_pen_down(void)
{
    mmi_email_comp_addr_recent_change_state();
}
#endif /* __MMI_TOUCH_SCREEN__ */

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
void mmi_email_comp_addr_add_recent_fte_tap_callback(mmi_tap_type_enum tap_type, S32 index)
{
    ASSERT(g_recent_addr_list_p != NULL);
    g_recent_addr_list_p->curr_highlight = index;
    mmi_email_comp_addr_recent_change_state();
}
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

static void mmi_email_comp_addr_add_recent_highlight_hdlr(S32 idx)
{
    ASSERT(g_recent_addr_list_p != NULL);
    g_recent_addr_list_p->curr_highlight = idx;
}

static void mmi_email_comp_addr_add_recent_option_lsk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	mmi_id menu_cui_id;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_ADD_RECENT_OPTION_LSK, __LINE__);

    menu_cui_id = cui_menu_create(
                    email_app_comp.rinput_grp_id,
                    CUI_MENU_SRC_TYPE_RESOURCE,
                    CUI_MENU_TYPE_OPTION,
                    MENU_ID_EMAIL_COMP_ADDR_RECENT_OPT,
                    MMI_FALSE,
                    (void*)(&email_app_comp));
    cui_menu_set_default_title(menu_cui_id, NULL, get_image(GetRootTitleIcon(MENU_ID_EMAIL_MAIN)));
    cui_menu_run(menu_cui_id);
}

static void mmi_email_comp_addr_add_recent_option_csk(void)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_ADD_RECENT_OPTION_CSK, __LINE__);
    mmi_email_comp_addr_recent_change_state();
}

static void mmi_email_comp_addr_add_recent_option_rsk(void)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_ADD_RECENT_OPTION_RSK, __LINE__);
    mmi_frm_scrn_close_active_id();
}

static S32 mmi_email_comp_addr_recent_num_checked(void)
{
    S32 i, num;

    ASSERT(g_recent_addr_list_p != NULL);

    for (i = 0, num = 0; i < g_recent_addr_list_p->curr_addr_num; i++)
    {
        if (g_recent_addr_list_p->state[i])
        {
            num++;
        }
    }

    return num;
}

static S32 mmi_email_comp_addr_recent_num_input(void)
{
    return email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
}

static void mmi_email_comp_addr_recent_change_state(void)
{
    S32 idx = 0;

    ASSERT(g_recent_addr_list_p != NULL);

    idx = g_recent_addr_list_p->curr_highlight;
    if (idx < 0 || idx >= g_recent_addr_list_p->curr_addr_num)
    {
        return;
    }

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_UE_RECENT_CONTACT_CHANGE_STATE, g_recent_addr_list_p->state[idx], idx);
    if (g_recent_addr_list_p->state[idx] == 0)
    {
        if ((mmi_email_comp_addr_recent_num_checked() + mmi_email_comp_addr_recent_num_input()) >= MMI_EMAIL_MAX_ADDR_NUM)
        {
            // Popup error
            mmi_email_lib_error_popup(STR_EMAIL_COMP_MAX_ADDR_REACHED_ID);
            return;
        }
    }

    g_recent_addr_list_p->state[idx] = !g_recent_addr_list_p->state[idx];
    standard_check_list_handle_left_softkey_up();
    //redraw_fixed_list();
}


static void mmi_email_comp_addr_add_recent_option_hide(mmi_id grp_id)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_ADD_RECENT_OPTION_HIDE, __LINE__);
    ASSERT(g_recent_addr_list_p != NULL);

    if (g_recent_addr_list_p->curr_highlight >= 0 && g_recent_addr_list_p->curr_highlight < g_recent_addr_list_p->curr_addr_num)
    {
        if (g_recent_addr_list_p->state[g_recent_addr_list_p->curr_highlight])
        {
            cui_menu_set_item_hidden(grp_id, MENU_ID_EMAIL_COMP_ADDR_RECENT_MARK, MMI_TRUE);
            cui_menu_set_item_hidden(grp_id, MENU_ID_EMAIL_COMP_ADDR_RECENT_UNMARK, MMI_FALSE);
        }
        else
        {
            cui_menu_set_item_hidden(grp_id, MENU_ID_EMAIL_COMP_ADDR_RECENT_MARK, MMI_FALSE);
            cui_menu_set_item_hidden(grp_id, MENU_ID_EMAIL_COMP_ADDR_RECENT_UNMARK, MMI_TRUE);
        }
    }
    else
    {
        cui_menu_set_item_hidden(grp_id, MENU_ID_EMAIL_COMP_ADDR_RECENT_MARK, MMI_TRUE);
        cui_menu_set_item_hidden(grp_id, MENU_ID_EMAIL_COMP_ADDR_RECENT_UNMARK, MMI_TRUE);
    }

    if (g_recent_addr_list_p->curr_addr_num == 1)
    {
        cui_menu_set_item_hidden(grp_id, MENU_ID_EMAIL_COMP_ADDR_RECENT_MARK_ALL, MMI_TRUE);
        cui_menu_set_item_hidden(grp_id, MENU_ID_EMAIL_COMP_ADDR_RECENT_UNMARK_ALL, MMI_TRUE);
    }
    else if (mmi_email_comp_addr_recent_num_checked() == g_recent_addr_list_p->curr_addr_num)
    {
        cui_menu_set_item_hidden(grp_id, MENU_ID_EMAIL_COMP_ADDR_RECENT_MARK_ALL, MMI_TRUE);
        cui_menu_set_item_hidden(grp_id, MENU_ID_EMAIL_COMP_ADDR_RECENT_UNMARK_ALL, MMI_FALSE);
    }
    else
    {
        cui_menu_set_item_hidden(grp_id, MENU_ID_EMAIL_COMP_ADDR_RECENT_MARK_ALL, MMI_FALSE);
        cui_menu_set_item_hidden(grp_id, MENU_ID_EMAIL_COMP_ADDR_RECENT_UNMARK_ALL, MMI_TRUE);
    }

    cui_menu_set_item_hidden(grp_id, MENU_ID_EMAIL_COMP_ADDR_RECENT_ADD, MMI_FALSE);
}

static void mmi_email_comp_addr_add_recent_option_action(mmi_id menu_id)
{
    S32 i, remain;
    
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_ADD_RECENT_OPTION_ACTION, __LINE__);

    switch (menu_id)
    {
    case MENU_ID_EMAIL_COMP_ADDR_RECENT_MARK:
        if ((mmi_email_comp_addr_recent_num_checked() + mmi_email_comp_addr_recent_num_input()) >= MMI_EMAIL_MAX_ADDR_NUM)
        {
            // Popup error
            mmi_email_lib_error_popup(STR_EMAIL_COMP_MAX_ADDR_REACHED_ID);
            return;
        }
        g_recent_addr_list_p->state[g_recent_addr_list_p->curr_highlight] = 1;
        break;

    case MENU_ID_EMAIL_COMP_ADDR_RECENT_UNMARK:
        ASSERT(g_recent_addr_list_p != NULL);
        g_recent_addr_list_p->state[g_recent_addr_list_p->curr_highlight] = 0;
        //standard_check_list_handle_left_softkey_up();
        //redraw_fixed_list();
        break;

    case MENU_ID_EMAIL_COMP_ADDR_RECENT_MARK_ALL:
        ASSERT(g_recent_addr_list_p != NULL);
        remain = MMI_EMAIL_MAX_ADDR_NUM - mmi_email_comp_addr_recent_num_input();
        if (remain < g_recent_addr_list_p->curr_addr_num)
        {
            mmi_email_lib_error_popup(STR_EMAIL_COMP_MAX_ADDR_REACHED_ID);
        }

        remain = MMI_EMAIL_MAX_ADDR_NUM - mmi_email_comp_addr_recent_num_checked() - mmi_email_comp_addr_recent_num_input();
        for (i = 0; i < g_recent_addr_list_p->curr_addr_num && remain > 0; i++)
        {
            if (g_recent_addr_list_p->state[i] == 0)
            {
                g_recent_addr_list_p->state[i] = 1;
                remain--;
            }
        }
        break;

    case MENU_ID_EMAIL_COMP_ADDR_RECENT_UNMARK_ALL:
        ASSERT(g_recent_addr_list_p != NULL);
        for (i = 0; i < g_recent_addr_list_p->curr_addr_num; i++)
        {
            g_recent_addr_list_p->state[i] = 0;
        }
        break;

    case MENU_ID_EMAIL_COMP_ADDR_RECENT_ADD:
        if (mmi_email_comp_addr_recent_num_checked() == 0)
        {
            mmi_email_lib_error_popup(STR_EMAIL_COMP_RECENT_MARK_FIRST_ID);
        }
        else
        {
            mmi_email_comp_addr_addr_recent_add_multy();
            mmi_frm_group_close(email_app_comp.rinput_grp_id);
            email_app_comp.rinput_grp_id = 0;
        }
        break;

    default:
        return;
    }
}

static WCHAR* mmi_email_comp_addr_get_filename(void)
{
    static WCHAR filepath[32];

    kal_wsprintf(filepath, "%c:\\@email_sys\\%s", 
        (CHAR) FS_GetDrive(FS_DRIVE_I_SYSTEM, 1, FS_DRIVE_I_SYSTEM), 
        "recent_addr.lst");

    ASSERT(mmi_wcslen(filepath) < 32);

    return filepath;
}

#define WSTR_RECENT_ADDR_FILENAME mmi_email_comp_addr_get_filename()

static void mmi_email_comp_addr_add_recent_load(void)
{
    static U8 loaded = 0;

    FS_HANDLE file_h = 0;
    U32 read_size = 0;

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_ADD_RECENT_LOAD, __LINE__);

    if (g_recent_addr_list_p == NULL)
    {
        g_recent_addr_list_p = (email_app_recent_input_list_struct*)mmi_email_app_mem_malloc(sizeof(email_app_recent_input_list_struct));
        if (g_recent_addr_list_p == NULL)
        {
            return;
        }
        loaded = 0;

        memset(g_recent_addr_list_p, 0, sizeof(email_app_recent_input_list_struct));
    }

    if (loaded != 0)
    {
        return;
    }
    loaded = 1;

    file_h = FS_Open(WSTR_RECENT_ADDR_FILENAME, FS_READ_ONLY);
    if (file_h < 0)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_UE_RECENT_CONTACT_LOAD_FAIL, file_h);
        return;
    }

    memset(g_recent_addr_list_p, 0, sizeof(email_app_recent_input_list_struct));
    FS_Read(file_h, g_recent_addr_list_p, sizeof(email_app_recent_input_list_struct), &read_size);
    if (read_size != sizeof(email_app_recent_input_list_struct))
    {
        g_recent_addr_list_p->curr_addr_num = 0;
    }
    FS_Close(file_h);

    /* Version check */
    if (g_recent_addr_list_p->version != MMI_EMAIL_MAX_RECENT_INPUT_VERSION ||
		g_recent_addr_list_p->max_addr_len != SRV_EMAIL_MAX_ADDR_LEN ||
        g_recent_addr_list_p->max_addr_num != MMI_EMAIL_MAX_RECENT_INPUT_NUM)
    {
        memset(g_recent_addr_list_p, 0, sizeof(email_app_recent_input_list_struct));
        g_recent_addr_list_p->curr_addr_num = 0;
    }
}

static void mmi_email_comp_addr_add_recent_save(void)
{
    FS_HANDLE file_h = 0;

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_ADD_RECENT_SAVE, __LINE__);
    if (g_recent_addr_list_p == NULL || mmi_email_app_mem_get_ptr() == NULL)
    {
        return;
    }

    file_h = FS_Open(WSTR_RECENT_ADDR_FILENAME, FS_READ_WRITE | FS_CREATE_ALWAYS);
    if (file_h < 0)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_UE_RECENT_CONTACT_SAVE_FAIL, file_h);
        return;
    }

	g_recent_addr_list_p->version = MMI_EMAIL_MAX_RECENT_INPUT_VERSION;
    g_recent_addr_list_p->max_addr_len = SRV_EMAIL_MAX_ADDR_LEN;
    g_recent_addr_list_p->max_addr_num = MMI_EMAIL_MAX_RECENT_INPUT_NUM;
    FS_Write(file_h, g_recent_addr_list_p, sizeof(email_app_recent_input_list_struct), NULL);
    FS_Close(file_h);
}

static void mmi_email_comp_addr_add_recent_free(void)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_ADD_RECENT_FREE, __LINE__);
    if (g_recent_addr_list_p != NULL)
    {
        if (mmi_email_app_mem_get_ptr() != NULL)
        {
            mmi_email_app_mem_free(g_recent_addr_list_p);
        }
        g_recent_addr_list_p = NULL;
    }
}

static void mmi_email_comp_addr_addr_recent_add_single(WCHAR addr[SRV_EMAIL_MAX_ADDR_LEN + 1])
{
    S32 i, idx;

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_ADDR_RECENT_ADD_SINGLE, __LINE__);
    if (g_recent_addr_list_p == NULL || mmi_email_app_mem_get_ptr() == NULL)
    {
        return;
    }

    if (addr == NULL || !mmi_email_util_chk_addr(addr) || (mmi_wcslen(addr) > SRV_EMAIL_MAX_ADDR_LEN))
    {
        return;
    }

    /* check if duplicated */
    for (i = 0, idx = -1; i < g_recent_addr_list_p->curr_addr_num; i++)
    {
        if (mmi_wcsicmp(addr, g_recent_addr_list_p->addr[i]) == 0)
        {
            idx = i;
            break;
        }
    }

    if (idx == -1)
    {
        /* New address */
        if (g_recent_addr_list_p->curr_addr_num < MMI_EMAIL_MAX_RECENT_INPUT_NUM)
        {
            g_recent_addr_list_p->curr_addr_num++;
        }

        /* Add to the header, remove the last one if full */
        for ( i = g_recent_addr_list_p->curr_addr_num - 1; i > 0; i--)
        {
            memcpy(g_recent_addr_list_p->addr[i], g_recent_addr_list_p->addr[i - 1], (SRV_EMAIL_MAX_ADDR_LEN + 1) * sizeof(WCHAR));
        }
        memcpy(g_recent_addr_list_p->addr[0], addr, (SRV_EMAIL_MAX_ADDR_LEN + 1) * sizeof(WCHAR));
    }
    else
    {
        /* Old address */
        /* Move it to the first */
        for (i = idx; i > 0; i--)
        {
            memcpy(g_recent_addr_list_p->addr[i], g_recent_addr_list_p->addr[i - 1], (SRV_EMAIL_MAX_ADDR_LEN + 1) * sizeof(WCHAR));
        }
        memcpy(g_recent_addr_list_p->addr[0], addr, (SRV_EMAIL_MAX_ADDR_LEN + 1) * sizeof(WCHAR));
    }

    /* save to file */
    mmi_email_comp_addr_add_recent_save();
}

static void mmi_email_comp_addr_addr_recent_add_multy(void)
{
    S32 i, idx, remain;
    U8 state;
    static WCHAR addr[SRV_EMAIL_MAX_ADDR_LEN + 1];

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_ADDR_RECENT_ADD_MULTY, __LINE__);
    if (g_recent_addr_list_p == NULL || mmi_email_app_mem_get_ptr() == NULL)
    {
        return;
    }

    remain = MMI_EMAIL_MAX_ADDR_NUM - mmi_email_comp_addr_recent_num_input();
    for (i = 0,idx = 0; i < g_recent_addr_list_p->curr_addr_num && remain > 0; i++)
    {
        if (g_recent_addr_list_p->state[i] != 0)
        {
            /*TODO add to addr list */
            mmi_wcsncpy(email_editing_addr_buff.email_addr, g_recent_addr_list_p->addr[i], SRV_EMAIL_MAX_ADDR_LEN);
            email_editing_addr_buff.email_addr[SRV_EMAIL_MAX_ADDR_LEN] = 0;
            email_editing_addr_buff.disp_name[0] = 0;
            email_editing_addr_buff.disp_name_len = 0;
            mmi_email_comp_addr_add_to_list();
            remain--;

            /* Move it to the first */
            if (idx == i)
            {
                idx++;
            }
            else
            {
                state = g_recent_addr_list_p->state[i];
                memcpy(addr, g_recent_addr_list_p->addr[i], (SRV_EMAIL_MAX_ADDR_LEN + 1) * sizeof(WCHAR));

                for (; i > idx; i--)
                {
                    memcpy(g_recent_addr_list_p->addr[i], g_recent_addr_list_p->addr[i - 1], (SRV_EMAIL_MAX_ADDR_LEN + 1) * sizeof(WCHAR));
                    g_recent_addr_list_p->state[i] = g_recent_addr_list_p->state[i - 1];
                }

                memcpy(g_recent_addr_list_p->addr[idx], addr, (SRV_EMAIL_MAX_ADDR_LEN + 1) * sizeof(WCHAR));
                g_recent_addr_list_p->state[idx] = state;

                i = idx;
                idx++;
            }
        }
    }

    for (i = 0; i < g_recent_addr_list_p->curr_addr_num; i++)
    {
        g_recent_addr_list_p->state[i] = 0;
    }

    for (; i < MMI_EMAIL_MAX_RECENT_INPUT_NUM; i++)
    {
        g_recent_addr_list_p->addr[i][0] = 0;
    }

    mmi_email_comp_addr_add_recent_save();
}

static void mmi_email_comp_send(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_msg_update_basic_info_struct *basic_info = NULL;
    email_app_save_send_proc_struct *info = NULL;

#if ((defined __MMI_EMAIL_CREATE_UE__) || (defined __MMI_EMAIL_INLINE_EDIT__))
    srv_email_msg_update_content_struct cont_buf;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_SEND, __LINE__);

#if ((defined __MMI_EMAIL_CREATE_UE__) || (defined __MMI_EMAIL_INLINE_EDIT__))
    /* update subject */
    cui_inline_get_value(
        email_app_comp.inline_id,
        MMI_EMAIL_COMP_SUBJECT_ITEM_ID,
        email_app_comp.subj);
    email_app_comp.subj_len = mmi_wcslen(email_app_comp.subj);
    srv_email_msg_update_subject(
        email_app_comp.msg_handle,
        email_app_comp.subj,
        MMI_CHSET_UCS2,
        email_app_comp.subj_len);
    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_SUB;
    /* update content */
    email_app_comp.cont_len = mmi_wcslen(email_app_comp.content);
    cont_buf.buff = email_app_comp.content;
    cont_buf.buff_len = email_app_comp.cont_len + 1;
    cont_buf.buff_type = MMI_TRUE;
    cont_buf.charset = MMI_CHSET_UCS2;
    srv_email_msg_update_content(
        email_app_comp.msg_handle,
        &cont_buf);
    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_CON;
    srv_email_msg_update_recipient(
        email_app_comp.msg_handle,
        SRV_EMAIL_ADDR_TYPE_TO,
        email_app_comp.to_num,
        email_app_comp.addr_list);
    srv_email_msg_update_recipient(
        email_app_comp.msg_handle,
        SRV_EMAIL_ADDR_TYPE_CC,
        email_app_comp.cc_num,
        &email_app_comp.addr_list[email_app_comp.to_num]);
    srv_email_msg_update_recipient(
        email_app_comp.msg_handle,
        SRV_EMAIL_ADDR_TYPE_BCC,
        email_app_comp.bcc_num,
        &email_app_comp.addr_list[email_app_comp.to_num + email_app_comp.cc_num]);
    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
#endif /* ((defined __MMI_EMAIL_CREATE_UE__) || (defined __MMI_EMAIL_INLINE_EDIT__)) */

    basic_info = OslMalloc(sizeof(srv_email_msg_update_basic_info_struct));
    basic_info->acct_id = email_app_comp.acct_id;
    basic_info->fldr_id = email_app_comp.outbox_fldr_id;
    basic_info->priority = email_app_comp.priority;
    basic_info->flag = EMAIL_MSG_FLAG_SEEN;
    srv_email_msg_update_basic_info(
        email_app_comp.msg_handle,
        basic_info);
    OslMfree(basic_info);
    info = OslMalloc(sizeof(email_app_save_send_proc_struct));
    memset(info, 0, sizeof(email_app_save_send_proc_struct));
    info->dst_acct_id = email_app_comp.acct_id;
    info->dst_fldr_id = email_app_comp.outbox_fldr_id;
    is_email_comp_close_screen = FALSE;
    if (email_app_comp.type == EMAIL_PRE_COMP_TYPE_EDIT)
    {
        if (email_app_comp.edit_from_outbox)
        {
            info->opt |= MMI_EMAIL_SS_SAVE;
            info->opt |= MMI_EMAIL_SS_SEND;
        }
        else
        {
            info->opt |= MMI_EMAIL_SS_MOVE;
        }
        is_email_comp_close_screen = TRUE;
    }
    else
    {
        info->opt |= MMI_EMAIL_SS_SAVE_NEW;
        info->opt |= MMI_EMAIL_SS_SEND;
    }
    info->save_part = SRV_EMAIL_MSG_SAVE_ALL;
    info->parent_id = email_app_comp.parent_id;
    info->msg_handle = email_app_comp.msg_handle;
    info->callback = mmi_email_comp_save_send_callback;
    info->user_data = NULL;
    mmi_email_set_ss(info);
    OslMfree(info);
    mmi_email_save_send();
}


static void mmi_email_comp_addr_edit(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 index = 0, total_num = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_EDIT, __LINE__);

    email_app_comp.is_new_address = FALSE;
    total_num = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
    if (total_num != MMI_EMAIL_MAX_ADDR_NUM)
    {
        index = email_app_comp.curr_hilit_addr_index - MMI_EMAIL_COMP_ADDR_FIX_TOTAL;
    }
    else
    {
        index = email_app_comp.curr_hilit_addr_index;
    }
    if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_ALL)
    {
        if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_TO_ITEM_ID)
        {
            index += 0;
        }
        else if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_CC_ITEM_ID)
        {
            index += email_app_comp.to_num;
        }
        else
        {
            index += email_app_comp.to_num + email_app_comp.cc_num;
        }
    }
    memcpy(
        &email_editing_addr_buff,
        &email_app_comp.addr_list[index],
        sizeof(srv_email_addr_struct));
    email_app_comp.fseditor_id = cui_fseditor_create(email_app_comp.addr_grp_id);
    cui_fseditor_set_title(email_app_comp.fseditor_id, STR_EMAIL_INPUT_ADDRESS_ID, GetRootTitleIcon(MENU_ID_EMAIL_MAIN));
    cui_fseditor_set_text(
        email_app_comp.fseditor_id,
        email_editing_addr_buff.email_addr,
        sizeof(email_editing_addr_buff.email_addr),
        SRV_EMAIL_MAX_ADDR_LEN);
    cui_fseditor_set_input_method(
        email_app_comp.fseditor_id,
        IMM_INPUT_TYPE_EMAIL,
        NULL,
        0);
    cui_fseditor_set_custom_options_menu(
        email_app_comp.fseditor_id,
        MMI_FALSE,
        email_app_comp_addr_search,
        sizeof(email_app_comp_addr_search) / sizeof(mmi_menu_id));
    cui_fseditor_run(email_app_comp.fseditor_id);
}


static void mmi_email_comp_addr_opt(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_id opt_grp_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_OPT, __LINE__);

    opt_grp_id = cui_menu_create(
                    email_app_comp.addr_grp_id,
                    CUI_MENU_SRC_TYPE_RESOURCE,
                    CUI_MENU_TYPE_OPTION,
                    MENU_ID_EMAIL_COMP_ADDR_OPT,
                    MMI_FALSE,
                    (void*)(&email_app_comp));
    cui_menu_set_default_title(opt_grp_id, NULL, get_image(GetRootTitleIcon(MENU_ID_EMAIL_MAIN)));
    cui_menu_run(opt_grp_id);
}


static void mmi_email_comp_addr_add_to_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 start_index = 0, total_num = 0, index = 0, *num_ptr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_ADD_TO_LIST, __LINE__);

    total_num = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
    if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_ALL)
    {
        if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_TO_ITEM_ID)
        {
            start_index = email_app_comp.to_num;
            num_ptr = &email_app_comp.to_num;
        }
        else if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_CC_ITEM_ID)
        {
            start_index = email_app_comp.to_num + email_app_comp.cc_num;
            num_ptr = &email_app_comp.cc_num;
        }
        else
        {
            start_index = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
            num_ptr = &email_app_comp.bcc_num;
        }
    }
    else
    {
        if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_TO)
        {
            start_index = email_app_comp.to_num;
            num_ptr = &email_app_comp.to_num;
        }
        else if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_CC)
        {
            start_index = email_app_comp.to_num + email_app_comp.cc_num;
            num_ptr = &email_app_comp.cc_num;
        }
        else
        {
            start_index = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
            num_ptr = &email_app_comp.bcc_num;
        }
    }
    if (total_num != 0)
    {
        for (index = total_num; index > start_index; index--)
        {
            memcpy(
                &email_app_comp.addr_list[index],
                &email_app_comp.addr_list[index - 1],
                sizeof(srv_email_addr_struct));
            if (index == 0)
            {
                break;
            }
        }
    }
    memcpy(
        &email_app_comp.addr_list[start_index],
        &email_editing_addr_buff,
        sizeof(srv_email_addr_struct));
    if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_ALL)
    {
        if (start_index + 1 == MMI_EMAIL_MAX_ADDR_NUM)
        {
            email_app_comp.curr_hilit_addr_index = *num_ptr;
        }
        else
        {
            email_app_comp.curr_hilit_addr_index = *num_ptr + MMI_EMAIL_COMP_ADDR_FIX_TOTAL;
        }
    }
    else
    {
        if (email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num + 1 == MMI_EMAIL_MAX_ADDR_NUM)
        {
            email_app_comp.curr_hilit_addr_index = start_index;
        }
        else
        {
            email_app_comp.curr_hilit_addr_index = start_index + MMI_EMAIL_COMP_ADDR_FIX_TOTAL;
        }
    }
    *num_ptr += 1;
    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
}


static void mmi_email_comp_addr_update_item(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 start_index = 0, total_num = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_UPDATE_ITEM, __LINE__);

    total_num = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
    if (total_num != MMI_EMAIL_MAX_ADDR_NUM)
    {
        start_index = email_app_comp.curr_hilit_addr_index - MMI_EMAIL_COMP_ADDR_FIX_TOTAL;
    }
    else
    {
        start_index = email_app_comp.curr_hilit_addr_index;
    }
    if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_ALL)
    {
        if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_TO_ITEM_ID)
        {
            start_index += 0;
        }
        else if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_CC_ITEM_ID)
        {
            start_index += email_app_comp.to_num;
        }
        else
        {
            start_index += email_app_comp.to_num + email_app_comp.cc_num;
        }
    }
    if (mmi_wcscmp(email_app_comp.addr_list[start_index].email_addr, email_editing_addr_buff.email_addr) != 0)
    {
        memset(&email_editing_addr_buff.disp_name, 0, sizeof(WCHAR) * (SRV_EMAIL_MAX_DISP_NAME_LEN + 1));
        email_editing_addr_buff.disp_name_len = 0;
        email_editing_addr_buff.disp_charset = 0;
    }
    memcpy(
        &email_app_comp.addr_list[start_index],
        &email_editing_addr_buff,
        sizeof(srv_email_addr_struct));
    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
}


#ifdef __MMI_EMAIL_CREATE_UE__
static void mmi_email_comp_addr_change_item_type(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 start_index = 0, total_num = 0, index = 0, *num_ptr = NULL;
    email_app_comp_addr_ct_enum src_type = MMI_EMAIL_COMP_ADDR_CT_ALL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_CHANGE_ITEM_TYPE, __LINE__);

    total_num = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
    /* delete the one */
    if (total_num != MMI_EMAIL_MAX_ADDR_NUM)
    {
        start_index = email_app_comp.curr_hilit_addr_index - MMI_EMAIL_COMP_ADDR_FIX_TOTAL;
    }
    else
    {
        start_index = email_app_comp.curr_hilit_addr_index;
    }
    if (start_index < email_app_comp.to_num)
    {
        src_type = MMI_EMAIL_COMP_ADDR_CT_TO;
        if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_TO)
        {
            return;
        }
    }
    else if (start_index >= email_app_comp.to_num &&
             start_index < email_app_comp.to_num + email_app_comp.cc_num)
    {
        src_type = MMI_EMAIL_COMP_ADDR_CT_CC;
        if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_CC)
        {
            return;
        }
    }
    else
    {
        src_type = MMI_EMAIL_COMP_ADDR_CT_BCC;
        if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_BCC)
        {
            return;
        }
    }
    if (src_type == MMI_EMAIL_COMP_ADDR_CT_TO)
    {
        num_ptr = &email_app_comp.to_num;
    }
    else if (src_type == MMI_EMAIL_COMP_ADDR_CT_CC)
    {
        num_ptr = &email_app_comp.cc_num;
    }
    else
    {
        num_ptr = &email_app_comp.bcc_num;
    }
    memcpy(
        &email_editing_addr_buff,
        &email_app_comp.addr_list[start_index],
        sizeof(srv_email_addr_struct));
    for (index = start_index; index < total_num - 1; index++)
    {
        memcpy(
            &email_app_comp.addr_list[index],
            &email_app_comp.addr_list[index + 1],
            sizeof(srv_email_addr_struct));
    }
    memset(
        &email_app_comp.addr_list[index],
        0,
        sizeof(srv_email_addr_struct));
    *num_ptr -= 1;
    /* add the one */
    total_num = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
    if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_TO)
    {
        start_index = email_app_comp.to_num;
        num_ptr = &email_app_comp.to_num;
    }
    else if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_CC)
    {
        start_index = email_app_comp.to_num + email_app_comp.cc_num;
        num_ptr = &email_app_comp.cc_num;
    }
    else
    {
        start_index = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
        num_ptr = &email_app_comp.bcc_num;
    }
    for (index = total_num; index > start_index; index--)
    {
        memcpy(
            &email_app_comp.addr_list[index],
            &email_app_comp.addr_list[index - 1],
            sizeof(srv_email_addr_struct));
        if (index == 0)
        {
            break;
        }
    }
    memcpy(
        &email_app_comp.addr_list[start_index],
        &email_editing_addr_buff,
        sizeof(srv_email_addr_struct));
    if (email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num + 1 == MMI_EMAIL_MAX_ADDR_NUM)
    {
        email_app_comp.curr_hilit_addr_index = start_index;
    }
    else
    {
        email_app_comp.curr_hilit_addr_index = start_index + MMI_EMAIL_COMP_ADDR_FIX_TOTAL;
    }
    *num_ptr += 1;
    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
}
#endif


static void mmi_email_comp_addr_del_from_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 start_index = 0, total_num = 0, index = 0, *num_ptr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_DEL_FROM_LIST, __LINE__);

    total_num = email_app_comp.to_num + email_app_comp.cc_num + email_app_comp.bcc_num;
    if (total_num != MMI_EMAIL_MAX_ADDR_NUM)
    {
        start_index = email_app_comp.curr_hilit_addr_index - MMI_EMAIL_COMP_ADDR_FIX_TOTAL;
    }
    else
    {
        start_index = email_app_comp.curr_hilit_addr_index;
    }
    if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_ALL)
    {
        if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_TO_ITEM_ID)
        {
            start_index += 0;
            num_ptr = &email_app_comp.to_num;
        }
        else if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_CC_ITEM_ID)
        {
            start_index += email_app_comp.to_num;
            num_ptr = &email_app_comp.cc_num;
        }
        else
        {
            start_index += email_app_comp.to_num + email_app_comp.cc_num;
            num_ptr = &email_app_comp.bcc_num;
        }
    }
    else
    {
        if (start_index < email_app_comp.to_num)
        {
            num_ptr = &email_app_comp.to_num;
        }
        else if (start_index >= email_app_comp.to_num &&
                 start_index < email_app_comp.to_num + email_app_comp.cc_num)
        {
            num_ptr = &email_app_comp.cc_num;
        }
        else
        {
            num_ptr = &email_app_comp.bcc_num;
        }
    }
    for (index = start_index; index < total_num - 1; index++)
    {
        memcpy(
            &email_app_comp.addr_list[index],
            &email_app_comp.addr_list[index + 1],
            sizeof(srv_email_addr_struct));
    }
    memset(
        &email_app_comp.addr_list[index],
        0,
        sizeof(srv_email_addr_struct));
    *num_ptr -= 1;
    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
    if (total_num == MMI_EMAIL_MAX_ADDR_NUM)
    {
        email_app_comp.curr_hilit_addr_index += MMI_EMAIL_COMP_ADDR_FIX_TOTAL;
    }
    if (*num_ptr == 0)
    {
        email_app_comp.curr_hilit_addr_index = MMI_EMAIL_COMP_DEFAULT_ADDR_HL_WITHOUT_RECP;
    }
    mmi_frm_scrn_close_active_id();
}


static void mmi_email_comp_addr_del_all(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 start_index = 0, index = 0, *num_ptr = NULL;
    U32 move_num = 0, move_index = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_DEL_ALL, __LINE__);

    if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_ALL)
    {
        if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_TO_ITEM_ID)
        {
            start_index += 0;
            num_ptr = &email_app_comp.to_num;
            move_num = email_app_comp.cc_num + email_app_comp.bcc_num;
        }
        else if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_CC_ITEM_ID)
        {
            start_index += email_app_comp.to_num;
            num_ptr = &email_app_comp.cc_num;
            move_num = email_app_comp.bcc_num;
        }
        else
        {
            start_index += email_app_comp.to_num + email_app_comp.cc_num;
            num_ptr = &email_app_comp.bcc_num;
            move_num = 0;
        }
    }
    else
    {
        memset(&email_app_comp.addr_list, 0, sizeof(srv_email_addr_struct) * MMI_EMAIL_MAX_ADDR_NUM);
        email_app_comp.to_num = 0;
        email_app_comp.cc_num = 0;
        email_app_comp.bcc_num = 0;
        email_app_comp.curr_hilit_addr_index = MMI_EMAIL_COMP_DEFAULT_ADDR_HL_WITHOUT_RECP;
        email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
        mmi_frm_scrn_close_active_id();
        return;
    }
    if (move_num)
    {
        move_index = start_index + (*num_ptr);
        for (; index < move_num; index++)
        {
            memcpy(
                &email_app_comp.addr_list[start_index + index],
                &email_app_comp.addr_list[move_index + index],
                sizeof(srv_email_addr_struct));
        }
    }
    memset(&email_app_comp.addr_list[start_index + index], 0, sizeof(srv_email_addr_struct) * (*num_ptr));
    *num_ptr = 0;
    email_app_comp.curr_hilit_addr_index = MMI_EMAIL_COMP_DEFAULT_ADDR_HL_WITHOUT_RECP;
    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
    mmi_frm_scrn_close_active_id();
}


static void mmi_email_comp_addr_hide_menu(void *comp_data, mmi_id option_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    email_app_comp_info_struct *app_data = (email_app_comp_info_struct*)comp_data;
    S32 addr_num = app_data->to_num + app_data->cc_num + app_data->bcc_num;
    S32 curr_addr_num = addr_num;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_HIDE_MENU, __LINE__);

#ifdef __MMI_EMAIL_CREATE_UE__
    if ((email_app_comp.curr_hilit_addr_index == 0 ||
         email_app_comp.curr_hilit_addr_index == 1 ||
         email_app_comp.curr_hilit_addr_index == 2) &&
         addr_num != MMI_EMAIL_MAX_ADDR_NUM)
    {
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_SELECT, MMI_FALSE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_SEND, MMI_TRUE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_EDIT, MMI_TRUE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_DELETE, MMI_TRUE);
        if (addr_num > 1)
        {
            cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_DELETE_ALL, MMI_FALSE);
        }
        else
        {
            cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_DELETE_ALL, MMI_TRUE);
        }
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_ADD_NEW, MMI_TRUE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_ADD_FROM_PHB, MMI_TRUE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_ADD_FROM_RECENT, MMI_TRUE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_CHANGE_TYPE_OPT, MMI_FALSE);
        return;
    }
#endif
    cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_SELECT, MMI_TRUE);
    if (addr_num == 0)
    {
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_SEND, MMI_TRUE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_EDIT, MMI_TRUE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_DELETE, MMI_TRUE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_DELETE_ALL, MMI_TRUE);
    }
    else
    {
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_SEND, MMI_FALSE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_EDIT, MMI_FALSE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_DELETE, MMI_FALSE);

        if (email_app_comp.change_type == MMI_EMAIL_COMP_ADDR_CT_ALL)
        {
            if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_TO_ITEM_ID)
            {
                curr_addr_num = app_data->to_num;
            }
            else if (email_app_comp.curr_item_id == MMI_EMAIL_COMP_CC_ITEM_ID)
            {
                curr_addr_num = app_data->cc_num;
            }
            else
            {
                curr_addr_num = app_data->bcc_num;
            }
        }

        if (curr_addr_num > 1)
        {
            cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_DELETE_ALL, MMI_FALSE);
        }
        else
        {
            cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_DELETE_ALL, MMI_TRUE);
        }
    }
    if (addr_num < MMI_EMAIL_MAX_ADDR_NUM)
    {
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_ADD_NEW, MMI_FALSE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_ADD_FROM_PHB, MMI_FALSE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_ADD_FROM_RECENT, MMI_FALSE);
    }
    else
    {
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_ADD_NEW, MMI_TRUE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_ADD_FROM_PHB, MMI_TRUE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_ADD_FROM_RECENT, MMI_TRUE);
    }
    if (app_data->change_type == MMI_EMAIL_COMP_ADDR_CT_ALL)
    {
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_SEND, MMI_TRUE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_CHANGE_TYPE_OPT, MMI_TRUE);
    }
    else
    {
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_SEND, MMI_FALSE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_CHANGE_TYPE_OPT, MMI_FALSE);
#ifdef __MMI_EMAIL_CREATE_UE__
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_CT_TO, MMI_FALSE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_CT_CC, MMI_FALSE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_CT_BCC, MMI_FALSE);
#else
        if (app_data->change_type == MMI_EMAIL_COMP_ADDR_CT_TO)
        {
            cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_CT_TO, MMI_TRUE);
            cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_CT_CC, MMI_FALSE);
            cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_CT_BCC, MMI_FALSE);
        }
        else if (app_data->change_type == MMI_EMAIL_COMP_ADDR_CT_CC)
        {
            cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_CT_TO, MMI_FALSE);
            cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_CT_CC, MMI_TRUE);
            cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_CT_BCC, MMI_FALSE);
        }
        else
        {
            cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_CT_TO, MMI_FALSE);
            cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_CT_CC, MMI_FALSE);
            cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_CT_BCC, MMI_TRUE);
        }
#endif
    }

#ifndef __MMI_PHB_OPTIONAL_FIELD__
    cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ADDR_ADD_FROM_PHB, MMI_TRUE);
#endif
}


static void mmi_email_comp_addr_options_handler(void *comp_data, mmi_menu_id menu_id, mmi_id grp_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#ifdef __MMI_EMAIL_CREATE_UE__
    email_app_comp_info_struct *app_data = (email_app_comp_info_struct*)comp_data;
    S32 addr_num = app_data->to_num + app_data->cc_num + app_data->bcc_num;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADDR_OPTIONS_HANDLER, __LINE__);

    switch (menu_id)
    {
        case MENU_ID_EMAIL_COMP_ADDR_SELECT:
            if (email_app_comp.curr_hilit_addr_index == 0)
            {
                mmi_email_comp_addr_add_new();
            }
            else if (email_app_comp.curr_hilit_addr_index == 1)
            {
                mmi_email_comp_addr_add_recent();
            }
            else
            {
                mmi_email_comp_addr_add_phb();
            }
            break;
        case MENU_ID_EMAIL_COMP_ADDR_SEND:
            mmi_email_comp_send();
            break;
        case MENU_ID_EMAIL_COMP_ADDR_ADD_NEW:
            mmi_email_comp_addr_add_new();
            break;

        case MENU_ID_EMAIL_COMP_ADDR_ADD_FROM_RECENT:
            mmi_email_comp_addr_add_recent();
            break;

        case MENU_ID_EMAIL_COMP_ADDR_ADD_FROM_PHB:
            mmi_email_comp_addr_add_phb();
            break;
        case MENU_ID_EMAIL_COMP_ADDR_EDIT:
            mmi_email_comp_addr_edit();
            break;
        case MENU_ID_EMAIL_COMP_ADDR_DELETE:
            mmi_email_util_display_confirm(
                email_app_comp.addr_grp_id,
                mmi_email_comp_addr_del_from_list,
                mmi_frm_scrn_close_active_id,
                NULL,
                FALSE,
                GetString(STR_EMAIL_DEL_COMP_ADDR_ID),
                MMI_EVENT_QUERY);
            break;
        case MENU_ID_EMAIL_COMP_ADDR_DELETE_ALL:
            mmi_email_util_display_confirm(
                email_app_comp.addr_grp_id,
                mmi_email_comp_addr_del_all,
                mmi_frm_scrn_close_active_id,
                NULL,
                FALSE,
                GetString(STR_EMAIL_DEL_ALL_COMP_ADDR_ID),
                MMI_EVENT_QUERY);
            break;
        case MENU_ID_EMAIL_COMP_ADDR_CT_TO:
            email_app_comp.change_type = MMI_EMAIL_COMP_ADDR_CT_TO;
#ifdef __MMI_EMAIL_CREATE_UE__
            if (addr_num == MMI_EMAIL_MAX_ADDR_NUM ||
                (email_app_comp.curr_hilit_addr_index > 2 && addr_num > 0 && addr_num != MMI_EMAIL_MAX_ADDR_NUM))
            {
                mmi_email_comp_addr_change_item_type();
            }
#endif
            cui_menu_close(grp_id);
            break;
        case MENU_ID_EMAIL_COMP_ADDR_CT_CC:
            email_app_comp.change_type = MMI_EMAIL_COMP_ADDR_CT_CC;
#ifdef __MMI_EMAIL_CREATE_UE__
            if (addr_num == MMI_EMAIL_MAX_ADDR_NUM ||
                (email_app_comp.curr_hilit_addr_index > 2 && addr_num > 0 && addr_num != MMI_EMAIL_MAX_ADDR_NUM))
            {
                mmi_email_comp_addr_change_item_type();
            }
#endif
            cui_menu_close(grp_id);
            break;
        case MENU_ID_EMAIL_COMP_ADDR_CT_BCC:
            email_app_comp.change_type = MMI_EMAIL_COMP_ADDR_CT_BCC;
#ifdef __MMI_EMAIL_CREATE_UE__
            if (addr_num == MMI_EMAIL_MAX_ADDR_NUM ||
                (email_app_comp.curr_hilit_addr_index > 2 && addr_num > 0 && addr_num != MMI_EMAIL_MAX_ADDR_NUM))
            {
                mmi_email_comp_addr_change_item_type();
            }
#endif
            cui_menu_close(grp_id);
            break;
        default:
            break;
    }
    return;
}


static void mmi_email_comp_edit_subject(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_EDIT_SUBJECT, __LINE__);

    memcpy(&edit_buff, email_app_comp.subj, sizeof(email_app_comp.subj));
    email_app_comp.fseditor_id = cui_fseditor_create(email_app_comp.grp_id);
    cui_fseditor_set_title(email_app_comp.fseditor_id, STR_GLOBAL_SUBJECT, GetRootTitleIcon(MENU_ID_EMAIL_MAIN));
    cui_fseditor_set_text(
        email_app_comp.fseditor_id,
        edit_buff,
        sizeof(edit_buff),
        MMI_EMAIL_MAX_SUBJ_LEN);
    cui_fseditor_set_input_method(
        email_app_comp.fseditor_id,
        IMM_INPUT_TYPE_SENTENCE,
        NULL,
        0);
    cui_fseditor_run(email_app_comp.fseditor_id);
}


static void mmi_email_comp_edit_content(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_EDIT_CONTENT, __LINE__);

    memcpy(&edit_buff, email_app_comp.content, sizeof(email_app_comp.content));
    email_app_comp.fseditor_id = cui_fseditor_create(email_app_comp.grp_id);
    cui_fseditor_set_title(email_app_comp.fseditor_id, STR_GLOBAL_CONTENT, GetRootTitleIcon(MENU_ID_EMAIL_MAIN));
    cui_fseditor_set_text(
        email_app_comp.fseditor_id,
        edit_buff,
        sizeof(edit_buff),
        MMI_EMAIL_MAX_CONT_LEN);
    cui_fseditor_set_input_method(
        email_app_comp.fseditor_id,
        IMM_INPUT_TYPE_SENTENCE,
        NULL,
        0);
    cui_fseditor_set_custom_options_menu(
        email_app_comp.fseditor_id,
        MMI_FALSE,
        email_app_comp_cont_insert,
        sizeof(email_app_comp_cont_insert) / sizeof(mmi_menu_id));
    cui_fseditor_run(email_app_comp.fseditor_id);
}


static void mmi_email_comp_get_attach_display_field(EMAIL_MSG_HANDLE msg_handle)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 total_size = 0, size_str_len = 0;
    U32 i = 0;
    WCHAR size_str[10];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_GET_ATTACH_DISPLAY_FIELD, __LINE__);

    if (email_app_comp.att_num == 1)
    {
        kal_wsprintf(size_str, " %dKB", (attach_info_array[0].size + 1023) / 1024);
        size_str_len = mmi_wcslen(size_str);
        if (attach_info_array[0].name_len > MMI_EMAIL_MAX_ATT_DISP_LEN - size_str_len)
        {
            mmi_wcsncpy(
                email_app_comp.attach_display,
                attach_info_array[0].name,
                MMI_EMAIL_MAX_ATT_DISP_LEN - size_str_len - 2);
            mmi_wcscat(email_app_comp.attach_display, g_email_2dots);
            mmi_wcscat(email_app_comp.attach_display, size_str);
        }
        else
        {
            kal_wsprintf(
                email_app_comp.attach_display,
                "%w%w",
                attach_info_array[0].name,
                size_str);
        }
    }
    else
    {
        for (; i < email_app_comp.att_num; i++)
        {
            total_size += attach_info_array[i].size;
        }
        kal_wsprintf(
            email_app_comp.attach_display,
            "%w%w%d%w %dKB",
            (WCHAR*)GetString(STR_EMAIL_ATTACHMENT_ID),
            (WCHAR*)GetString(STR_EMAIL_LEFT_PARENTHESIS_ID),
            email_app_comp.att_num,
            (WCHAR*)GetString(STR_EMAIL_RIGHT_PARENTHESIS_ID),
            ((total_size + 1023) / 1024));
    }
}


void mmi_email_comp_attach(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH, __LINE__);

    email_app_comp.attach_grp_id = mmi_frm_group_create(
        email_app_comp.grp_id,
        GRP_ID_AUTO_GEN,
        mmi_email_comp_attach_proc,
        (void*)(&email_app_comp));

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH, __LINE__);

    mmi_frm_group_enter(email_app_comp.attach_grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH, __LINE__);

    email_app_comp.curr_hilit_attach_index = 0;
    mmi_email_entry_comp_attach();
}


static mmi_ret mmi_email_comp_attach_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (menu_evt->evt_id)
    {
        case EVT_ID_GROUP_FOCUSED:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_PROC, __LINE__);
            mmi_email_set_active_group_id(email_app_comp.attach_grp_id);
            break;

        case EVT_ID_GROUP_DEINIT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_PROC, __LINE__);
            {
                if (email_app_comp.att_num != 0)
                {
                    mmi_email_comp_get_attach_display_field(email_app_comp.msg_handle);
                }
                else
                {
                    email_app_comp.attach_display[0] = L'\0';
                }
            }
            break;

        case EVT_ID_CUI_MENU_LIST_ENTRY:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_PROC, __LINE__);
            mmi_email_comp_attach_hide_menu(menu_evt->sender_id);
            break;

        case EVT_ID_CUI_MENU_ITEM_SELECT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_PROC, __LINE__);
            mmi_email_comp_attach_options_handler(menu_evt->highlighted_menu_id, menu_evt->sender_id);
            break;

        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_PROC, __LINE__);
            cui_menu_close(menu_evt->sender_id);
            break;

        case EVT_ID_CUI_FILE_SELECTOR_RESULT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_PROC, __LINE__);
            mmi_email_comp_attach_add_new_done((void*)evt);
            break;

#ifdef __MMI_IMAGE_VIEWER__
        case EVT_ID_IMGVIEW_CLOSE_GID:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_PROC, __LINE__);
            {
                cui_imgview_close(email_app_comp.viewer_cui_id);
                email_app_comp.viewer_cui_id = 0;
            }
            break;
#endif /* __MMI_IMAGE_VIEWER__ */

    default:
        break;
    }
    return MMI_RET_OK;
}


static void mmi_email_comp_attach_add_new_done(void *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_file_selector_result_event_struct *data =
        (cui_file_selector_result_event_struct*)evt;
    srv_fmgr_fileinfo_struct file_info = {0};
    S32 index = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_ADD_NEW_DONE, __LINE__);
    if (data->result > 0)
    {
        data->result = cui_file_selector_get_selected_filepath(
            data->sender_id,
            &file_info,
            (WCHAR*)selected_file_path,
            (SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(WCHAR));
        if (data->result == 0)
        {
            email_comp_add_attach_done_file_size = file_info.size;
            if (file_info.size == 0)
            {
                mmi_email_lib_error_popup(STR_EMAIL_EMPTY_FILE_ID);
                return;
            }
            /* ensure previous total attachment size + current attachment size no greater than 90K */
            else if (email_app_comp.attach_total_size + file_info.size > MMI_EMAIL_TOTAL_MAX_ATTACH_SIZE)
            {
                kal_wsprintf(
                    selected_file_path,
                    "%uKB %w",
                    (U32)(MMI_EMAIL_TOTAL_MAX_ATTACH_SIZE) / 1024,
                    (WCHAR*)GetString(STR_EMAIL_SIZE_TOO_LARGE));
                mmi_email_util_display_popup(
                    0,
                    (CHAR*)selected_file_path,
                    MMI_EVENT_FAILURE);
                return;
            }
            email_comp_copy_attach_callback = mmi_email_comp_add_attach_done_copy_ret_handler;
            if (email_app_comp.is_new_attach)
            {
                index = email_app_comp.att_num;
            }
            else
            {
                if (email_app_comp.att_num == MMI_EMAIL_MAX_ATTACH_NUMBER)
                {
                    index = email_app_comp.curr_hilit_attach_index;
                }
                else
                {
                    index = email_app_comp.curr_hilit_attach_index - MMI_EMAIL_COMP_ATTACH_FIX_TOTAL;
                }
            }
            mmi_email_comp_pre_copy_attach(index, selected_file_path);
            return;
        }
    }

    cui_file_selector_close(email_app_comp.fmgr_cui_id);
    email_app_comp.fmgr_cui_id = 0;
}


static void mmi_email_comp_add_attach_done_copy_ret_handler(BOOL result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 index = 0;
    srv_email_result_enum ret = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ADD_ATTACH_DONE_COPY_RET_HANDLER, __LINE__);

    if (!result)
    {
        cui_file_selector_close(email_app_comp.fmgr_cui_id);
        email_app_comp.fmgr_cui_id = 0;
        mmi_frm_scrn_close(email_app_comp.grp_id, SCR_ID_EMAIL_COMP_ATTACH_COPY);
        return;
    }

    if (email_app_comp.is_new_attach)
    {
        index = email_app_comp.att_num;
    }
    else
    {
        if (email_app_comp.att_num == MMI_EMAIL_MAX_ATTACH_NUMBER)
        {
            index = email_app_comp.curr_hilit_attach_index;
        }
        else
        {
            index = email_app_comp.curr_hilit_attach_index - MMI_EMAIL_COMP_ATTACH_FIX_TOTAL;
        }
    }
    if (mmi_email_comp_attach_fill_new_info(0, index, selected_file_path, email_comp_add_attach_done_file_size))
    {
        mmi_wcscpy(attach_info_array[index].path, email_comp_copy_attach_dst_path);
        if (email_app_comp.is_new_attach)
        {
            email_app_comp.att_num += 1;
        }
        email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_ATT;

        ret = srv_email_msg_update_attach(
            email_app_comp.msg_handle,
            email_app_comp.att_num,
            attach_info_array);
        if (ret != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(0, ret);
            memset(&attach_info_array[index], 0, sizeof(srv_email_attach_struct));
            email_app_comp.att_num -= 1;
        }
        else
        {
            mmi_email_comp_get_attach_display_field(email_app_comp.msg_handle);
            if (!email_app_comp.is_show_att_field)
            {
                email_app_comp.is_show_att_field = TRUE;
                mmi_email_comp_add_field_to_display(MMI_EMAIL_COMP_ATTACH_ITEM_ID);
            }
            if (email_app_comp.att_num == MMI_EMAIL_MAX_ATTACH_NUMBER)
            {
                email_app_comp.curr_hilit_attach_index = email_app_comp.att_num - 1;
            }
            else
            {
                email_app_comp.curr_hilit_attach_index =
                    email_app_comp.att_num + MMI_EMAIL_COMP_ATTACH_FIX_TOTAL - 1;
            }
            email_app_comp.att_changed = TRUE;
        }
        cui_file_selector_close(email_app_comp.fmgr_cui_id);
        email_app_comp.fmgr_cui_id = 0;
    }
    mmi_frm_scrn_close(email_app_comp.grp_id, SCR_ID_EMAIL_COMP_ATTACH_COPY);
}


static BOOL mmi_email_comp_attach_fill_new_info(mmi_id parent_id, S32 index, WCHAR *file_path, U32 size)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 orig_size = 0;
    BOOL is_drm_obj = FALSE;

#ifdef __DRM_SUPPORT__
    S32 mime_type = 0, mime_subtype = 0;
#endif /* __DRM_SUPPORT__ */

    S32 fwd_flag = 0;
    WCHAR *file_name_ptr = NULL;
    WCHAR *file_ext_ptr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_FILL_NEW_INFO, __LINE__);

#ifdef __DRM_SUPPORT__
    mmi_email_util_get_mine_type(file_path, &mime_type, &mime_subtype);
    if (mime_subtype == MIME_SUBTYPE_DRM_MESSAGE)
    {
        mmi_email_lib_error_popup(STR_GLOBAL_DRM_PROHIBITED);
        return FALSE;
    }
    fwd_flag = mmi_rmgr_check_forward((U16*)file_path);
    if (!(fwd_flag & MMI_RMGR_USAGE_SEND))
    {
        mmi_email_lib_error_popup(STR_GLOBAL_DRM_PROHIBITED);
        return FALSE;
    }
    if (fwd_flag < 0)
    {
        mmi_email_util_display_popup(
            parent_id,
            GetString(srv_fmgr_fs_error_get_string(fwd_flag)),
            MMI_EVENT_FAILURE);
        return FALSE;
    }
    mmi_email_drm_is_file_lock(
        file_path,
        &is_drm_obj);
#endif /* __DRM_SUPPORT__ */

    orig_size = attach_info_array[index].size;
    if (size == 0)
    {
        mmi_email_lib_error_popup(STR_EMAIL_EMPTY_FILE_ID);
        return FALSE;
    }
    /* ensure previous total attachment size + current attachment size no greater than 90K */
    else if (email_app_comp.attach_total_size - orig_size + size > MMI_EMAIL_TOTAL_MAX_ATTACH_SIZE)
    {
        kal_wsprintf(
            selected_file_path,
            "%uKB %w",
            (U32)(MMI_EMAIL_TOTAL_MAX_ATTACH_SIZE) / 1024,
            (WCHAR*)GetString(STR_EMAIL_SIZE_TOO_LARGE));
        mmi_email_util_display_popup(
            parent_id,
            (CHAR*)selected_file_path,
            MMI_EVENT_FAILURE);
        return FALSE;
    }
    memset(
        &attach_info_array[index],
        0,
        sizeof(srv_email_attach_struct));
    attach_info_array[index].drm_object = (MMI_BOOL)is_drm_obj;

    /* get mine type */
#ifdef __DRM_SUPPORT__
    if (attach_info_array[index].drm_object)
    {
        attach_info_array[index].mime_type = MIME_TYPE_APPLICATION;
        attach_info_array[index].mime_subtype = MIME_SUBTYPE_DRM_CONTENT;
        mmi_email_util_get_mine_type(
            file_path,
            &attach_info_array[index].drm_type,
            &attach_info_array[index].drm_subtype);
    }
    else
#endif /* __DRM_SUPPORT__ */
    {
        mmi_email_util_get_mine_type(
            file_path,
            &attach_info_array[index].mime_type,
            &attach_info_array[index].mime_subtype);

#ifdef __DRM_SUPPORT__
        if ((attach_info_array[index].mime_subtype == MIME_SUBTYPE_DRM_CONTENT) ||
            (attach_info_array[index].mime_subtype == MIME_SUBTYPE_DRM_MESSAGE))
        {
            attach_info_array[index].mime_type = MIME_TYPE_UNKNOWN;
            attach_info_array[index].mime_subtype = MIME_SUBTYPE_UNRECOGNIZED;
        }
#endif /* __DRM_SUPPORT__ */
    }
    attach_info_array[index].charset = MMI_CHSET_UCS2;
    mmi_wcscpy(
        attach_info_array[index].path,
        file_path);
    file_name_ptr = srv_fmgr_path_get_filename_ptr(file_path);
    file_ext_ptr = srv_fmgr_path_get_extension_ptr(file_path);
    if (file_ext_ptr != NULL && file_name_ptr != NULL)
    {
        S32 file_name_len = mmi_wcslen(file_name_ptr);
        S32 file_ext_len = mmi_wcslen(file_ext_ptr);
        if (file_ext_len >= EMAIL_ATTCH_FILE_NAME_LEN)
        {
            mmi_wcsncpy(attach_info_array[index].name, file_name_ptr, EMAIL_ATTCH_FILE_NAME_LEN);
        }
        else
        {
            if (file_name_len - file_ext_len > EMAIL_ATTCH_FILE_NAME_LEN - file_ext_len - 1)
            {
                mmi_wcsncpy(attach_info_array[index].name, file_name_ptr, EMAIL_ATTCH_FILE_NAME_LEN - file_ext_len - 1);
                kal_wsprintf(
                    attach_info_array[index].name + (EMAIL_ATTCH_FILE_NAME_LEN - file_ext_len - 1),
                    "%c%w",
                    '.',
                    file_ext_ptr);
            }
            else
            {
                srv_fmgr_fs_path_get_display_name(
                    file_path,
                    attach_info_array[index].name,
                    sizeof(attach_info_array[index].name));
            }
        }
    }
    else
    {
        srv_fmgr_fs_path_get_display_name(
            file_path,
            attach_info_array[index].name,
            sizeof(attach_info_array[index].name));
    }
    attach_info_array[index].name_len = mmi_wcslen(attach_info_array[index].name);
    email_app_comp.attach_total_size = email_app_comp.attach_total_size - orig_size + size;
    attach_info_array[index].size = size;
    attach_info_array[index].downloaded = MMI_TRUE;
    return TRUE;
}


static void mmi_email_entry_comp_attach(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 num_items = 0;
    U8 *gui_buffer = NULL;
    S32 highlight_index = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_COMP_ATTACH, __LINE__);

    if (!mmi_frm_scrn_enter(
            email_app_comp.attach_grp_id,
            SCR_ID_EMAIL_COMP_ATTACH,
            NULL,
            mmi_email_entry_comp_attach,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_COMP_ATTACH, __LINE__);
        return;
    }
    gui_buffer = mmi_frm_scrn_get_active_gui_buf();
    if (email_app_comp.att_num == 0)
    {
        num_items = MMI_EMAIL_COMP_DEFAULT_ATTACH_LIST_ITEM_NUM;
    }
    else
    {
        if (email_app_comp.att_num == MMI_EMAIL_MAX_ATTACH_NUMBER)
        {
            num_items = MMI_EMAIL_MAX_ATTACH_NUMBER;
        }
        else
        {
            num_items = email_app_comp.att_num + MMI_EMAIL_COMP_ATTACH_FIX_TOTAL;
        }
    }
    if (gui_buffer == NULL)
    {
        if (email_app_comp.att_num == 0)
        {
            highlight_index = MMI_EMAIL_COMP_DEFAULT_ATTACH_HL_WITHOUT_ITEM;
        }
        else
        {
            if (email_app_comp.att_num == MMI_EMAIL_MAX_ATTACH_NUMBER)
            {
                highlight_index = 0;
            }
            else
            {
                highlight_index = MMI_EMAIL_COMP_DEFAULT_ATTACH_HL_WITH_ITEM;
            }
        }
    }
    else
    {
        list_menu_category_history *h = (list_menu_category_history*)gui_buffer;
        highlight_index = email_app_comp.curr_hilit_attach_index;
        h->highlighted_item = highlight_index;
    }
    RegisterHighlightHandler(mmi_email_comp_attach_hilit_handler);
    wgui_fixed_list_register_get_flags_handler(mmi_email_comp_attach_get_seperator_line);

    EnableCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    ShowCategory184Screen(
        STR_EMAIL_ATTACHMENT_ID,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        num_items,
        mmi_email_comp_attach_get_item,
        mmi_email_comp_attach_get_item_hint,
        highlight_index,
        gui_buffer);

    SetRightSoftkeyFunction(mmi_frm_scrn_close_active_id, KEY_EVENT_UP);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
    wgui_register_tap_callback(mmi_email_comp_attach_tap_callback);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

    mmi_frm_scrn_set_leave_proc(
        email_app_comp.attach_grp_id,
        SCR_ID_EMAIL_COMP_ATTACH,
        mmi_email_comp_attach_del_callback);

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_COMP_ATTACH, __LINE__);
}


static mmi_ret mmi_email_comp_attach_del_callback(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_DEL_CALLBACK, __LINE__);
    switch (evt->evt_id)
    {
        case EVT_ID_SCRN_GOBACK_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ:
        case EVT_ID_SCRN_GOBACK:
            if (email_app_comp.fmgr_cui_id && mmi_frm_group_is_present(email_app_comp.fmgr_cui_id))
            {
                cui_file_selector_close(email_app_comp.fmgr_cui_id);
                email_app_comp.fmgr_cui_id = 0;
            }
#ifdef __MMI_IMAGE_VIEWER__
            if (email_app_comp.viewer_cui_id && mmi_frm_group_is_present(email_app_comp.viewer_cui_id))
            {
                cui_imgview_close(email_app_comp.viewer_cui_id);
                email_app_comp.viewer_cui_id = 0;
            }
#endif /* __MMI_IMAGE_VIEWER__ */
            break;
    }
    return MMI_RET_OK;
}


static void mmi_email_comp_attach_hilit_handler(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 item_index = 0;
    filetypes_group_type_enum fmgr_type = FMGR_GROUP_UNKNOWN;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    email_app_comp.curr_hilit_attach_index = index;
    if (email_app_comp.att_num != MMI_EMAIL_MAX_ATTACH_NUMBER)
    {
        switch (index)
        {
            case MMI_EMAIL_COMP_ATTACH_ADD_NEW:
                {
                    ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
                    SetCenterSoftkeyFunction(mmi_email_comp_attach_add, KEY_EVENT_UP);
                    ChangeLeftSoftkey(STR_GLOBAL_OK, 0);
                    SetLeftSoftkeyFunction(mmi_email_comp_attach_add, KEY_EVENT_UP);
                    SetKeyHandler(NULL, KEY_SEND, KEY_EVENT_UP);
                }
                return;
            default:
                item_index = index - MMI_EMAIL_COMP_ATTACH_FIX_TOTAL;
                break;
        }
    }
    else
    {
        item_index = index;
    }

    fmgr_type = srv_fmgr_types_find_group_by_filename_str(attach_info_array[item_index].name);
    if (
#ifdef __MMI_IMAGE_VIEWER__
        (fmgr_type == FMGR_GROUP_IMAGE) ||
#endif /* __MMI_IMAGE_VIEWER__ */
        (fmgr_type == FMGR_GROUP_AUDIO) || 
        (fmgr_type == FMGR_GROUP_VIDEO))
    {
        ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
        SetCenterSoftkeyFunction(mmi_email_comp_attach_view, KEY_EVENT_UP);
    }
    else
    {
#ifdef __DRM_SUPPORT__
        if (attach_info_array[item_index].drm_object)
        {
            if (
#ifdef __MMI_IMAGE_VIEWER__
                (attach_info_array[item_index].drm_type == MIME_TYPE_IMAGE) ||
#endif /* __MMI_IMAGE_VIEWER__ */
                (attach_info_array[item_index].drm_type == MIME_TYPE_AUDIO) ||
                (attach_info_array[item_index].drm_type == MIME_TYPE_VIDEO))
            {
                ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
                SetCenterSoftkeyFunction(mmi_email_comp_attach_view, KEY_EVENT_UP);
            }
            else
            {
                ChangeCenterSoftkey(0, IMG_GLOBAL_OPTION_CSK);
                SetCenterSoftkeyFunction(mmi_email_comp_attach_opt, KEY_EVENT_UP);
            }
        }
        else
#endif /* __DRM_SUPPORT__ */
        {
            ChangeCenterSoftkey(0, IMG_GLOBAL_OPTION_CSK);
            SetCenterSoftkeyFunction(mmi_email_comp_attach_opt, KEY_EVENT_UP);
        }
    }
    ChangeLeftSoftkey(STR_GLOBAL_OPTIONS, 0);
    SetLeftSoftkeyFunction(mmi_email_comp_attach_opt, KEY_EVENT_UP);
}


static MMI_BOOL mmi_email_comp_attach_get_seperator_line(S32 index, U32* flag, U32* flag_ex)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (email_app_comp.att_num != MMI_EMAIL_MAX_ATTACH_NUMBER)
    {
        if (index < MMI_EMAIL_COMP_ATTACH_FIX_TOTAL)
        {
            *flag |= UI_MENUITEM_DISABLE_ICON;
        }
        else if (index == MMI_EMAIL_COMP_ATTACH_FIX_TOTAL)
        {
            *flag_ex |= UI_MENUITEM_EXT_SHOW_SEPARATORLINE;
            if (email_app_comp.att_num == 0)
            {
                *flag |= UI_MENUITEM_DISABLE_ICON;
                *flag |= UI_MENUITEM_STATE_DISABLED;
            }
        }
    }
    return MMI_TRUE;
}


static pBOOL mmi_email_comp_attach_get_item(S32 item_index, UI_string_type str_buff, PU8 *img_buff_p, U8 str_img_mask)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((item_index < 0) || ((email_app_comp.att_num == 0) && (item_index > MMI_EMAIL_COMP_ATTACH_FIX_TOTAL)) ||
        ((email_app_comp.att_num > 0) && (item_index > ((S32)email_app_comp.att_num + MMI_EMAIL_COMP_ATTACH_FIX_TOTAL))))
    {
        return FALSE;
    }
    else
    {
        *img_buff_p = NULL;
        if (email_app_comp.att_num != MMI_EMAIL_MAX_ATTACH_NUMBER)
        {
            switch (item_index)
            {
                case MMI_EMAIL_COMP_ATTACH_ADD_NEW:
                    {
                        mmi_wcscpy(
                            (WCHAR*)str_buff,
                            (WCHAR*)GetString(STR_EMAIL_COMP_UE_ADD_ATT_ID));
                    }
                    return TRUE;
                default:
                    break;
            }
        }
        *img_buff_p = get_image(IMG_EMAIL_ATTACHMENT_ID);
        if (email_app_comp.att_num == 0)
        {
            mmi_wcscpy(
                (WCHAR*)str_buff,
                (WCHAR*)GetString(STR_GLOBAL_EMPTY_LIST));
        }
        else
        {
            WCHAR *attach_name_p = NULL;
            S32 attach_name_len = 0;
            S32 dot_len = mmi_wcslen(g_email_2dots);

            if (email_app_comp.att_num != MMI_EMAIL_MAX_ATTACH_NUMBER)
            {
                attach_name_p = attach_info_array[item_index - MMI_EMAIL_COMP_ATTACH_FIX_TOTAL].name;
            }
            else
            {
                attach_name_p = attach_info_array[item_index].name;
            }
            attach_name_len = mmi_wcslen(attach_name_p);
            if (attach_name_len > MAX_SUBMENU_CHARACTERS)
            {
                mmi_wcsncpy((WCHAR*)str_buff, attach_name_p, MAX_SUBMENU_CHARACTERS - dot_len);
                mmi_wcscat((WCHAR*)str_buff, g_email_2dots);
            }
            else
            {
                mmi_wcscpy((WCHAR*)str_buff, attach_name_p);
            }
        }
        return TRUE;
    }
}


static S32 mmi_email_comp_attach_get_item_hint(S32 item_index, UI_string_type *hint_array)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((item_index < 0) || ((email_app_comp.att_num == 0) && (item_index > MMI_EMAIL_COMP_ATTACH_FIX_TOTAL)) ||
        ((email_app_comp.att_num > 0) && (item_index > ((S32)email_app_comp.att_num + MMI_EMAIL_COMP_ATTACH_FIX_TOTAL))))
    {
        return 0;
    }
    else
    {
        if (email_app_comp.att_num != MMI_EMAIL_MAX_ATTACH_NUMBER)
        {
            switch (item_index)
            {
                case MMI_EMAIL_COMP_ATTACH_ADD_NEW:
                    ((WCHAR*)hint_array[0])[0] = L'\0';
                    return 0;
                default:
                    break;
            }
        }
        if (email_app_comp.att_num == 0)
        {
            ((WCHAR*)hint_array[0])[0] = L'\0';
            return 0;
        }
        else
        {
            S32 index = 0;
            if (email_app_comp.att_num != MMI_EMAIL_MAX_ATTACH_NUMBER)
            {
                index = item_index - MMI_EMAIL_COMP_ATTACH_FIX_TOTAL;
            }
            else
            {
                index = item_index;
            }
            kal_wsprintf(
                (WCHAR*)hint_array[0],
                "%uKB",
                (U32)(attach_info_array[index].size + 1023) / 1024);
            return 1;                
        }
    }
}


#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_comp_attach_tap_callback(mmi_tap_type_enum tap_type, S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 item_index = 0;
    filetypes_group_type_enum fmgr_type = FMGR_GROUP_UNKNOWN;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (email_app_comp.att_num != MMI_EMAIL_MAX_ATTACH_NUMBER)
    {
        switch (index)
        {
            case MMI_EMAIL_COMP_ATTACH_ADD_NEW:
                mmi_email_comp_attach_add_new(email_app_comp.attach_grp_id);
                return;
            default:
                item_index = index - MMI_EMAIL_COMP_ATTACH_FIX_TOTAL;
                break;
        }
    }
    else
    {
        item_index = index;
    }

    fmgr_type = srv_fmgr_types_find_group_by_filename_str(attach_info_array[item_index].name);
    if (
#ifdef __MMI_IMAGE_VIEWER__
        (fmgr_type == FMGR_GROUP_IMAGE) || 
#endif /* __MMI_IMAGE_VIEWER__ */
        (fmgr_type == FMGR_GROUP_AUDIO) || 
        (fmgr_type == FMGR_GROUP_VIDEO))
    {
        if (tap_type == ENUM_TAP_ON_HIGHLIGHTED_ITEM)
        {
            mmi_email_comp_attach_view();
            return;
        }
    }

#ifdef __DRM_SUPPORT__
    if (attach_info_array[item_index].drm_object)
    {
        if (
#ifdef __MMI_IMAGE_VIEWER__
            (attach_info_array[item_index].drm_type == MIME_TYPE_IMAGE) ||
#endif /* __MMI_IMAGE_VIEWER__ */
            (attach_info_array[item_index].drm_type == MIME_TYPE_AUDIO) ||
            (attach_info_array[item_index].drm_type == MIME_TYPE_VIDEO))
        {
            if (tap_type == ENUM_TAP_ON_HIGHLIGHTED_ITEM)
            {
                mmi_email_comp_attach_view();
            }
        }
    }
#endif /* __DRM_SUPPORT__ */
}
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */


static void mmi_email_comp_attach_hide_menu(mmi_id option_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 item_index = 0;
    filetypes_group_type_enum fmgr_type = FMGR_GROUP_UNKNOWN;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_HIDE_MENU, __LINE__);

    if (email_app_comp.att_num == 0)
    {
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ATT_VIEW, MMI_TRUE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ATT_DEL, MMI_TRUE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ATT_DEL_ALL, MMI_TRUE);
    }
    else
    {
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ATT_VIEW, MMI_FALSE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ATT_DEL, MMI_FALSE);
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ATT_DEL_ALL, MMI_FALSE);
    }
    if (email_app_comp.att_num < MMI_EMAIL_MAX_ATTACH_NUMBER)
    {
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ATT_ADD, MMI_FALSE);
    }
    else
    {
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ATT_ADD, MMI_TRUE);
    }
    if (email_app_comp.att_num > 1)
    {
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ATT_DEL_ALL, MMI_FALSE);
    }
    else
    {
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ATT_DEL_ALL, MMI_TRUE);
    }
    if (email_app_comp.att_num == MMI_EMAIL_MAX_ATTACH_NUMBER)
    {
        item_index = email_app_comp.curr_hilit_attach_index;
    }
    else
    {
        item_index = email_app_comp.curr_hilit_attach_index - MMI_EMAIL_COMP_ATTACH_FIX_TOTAL;
    }

    fmgr_type = srv_fmgr_types_find_group_by_filename_str(attach_info_array[item_index].name);
    if (
#ifdef __MMI_IMAGE_VIEWER__
        (fmgr_type == FMGR_GROUP_IMAGE) ||
#endif /* __MMI_IMAGE_VIEWER__ */
        (fmgr_type == FMGR_GROUP_AUDIO) || 
        (fmgr_type == FMGR_GROUP_VIDEO))
    {
        cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ATT_VIEW, MMI_FALSE);
    }
    else
    {
#ifdef __DRM_SUPPORT__
        if (attach_info_array[item_index].drm_object)
        {
            if (
#ifdef __MMI_IMAGE_VIEWER__
                (attach_info_array[item_index].drm_type == MIME_TYPE_IMAGE) ||
#endif /* __MMI_IMAGE_VIEWER__ */
                (attach_info_array[item_index].drm_type == MIME_TYPE_AUDIO) ||
                (attach_info_array[item_index].drm_type == MIME_TYPE_VIDEO))
            {
                cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ATT_VIEW, MMI_FALSE);
            }
            else
            {
                cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ATT_VIEW, MMI_TRUE);
            }
        }
        else
#endif /* __DRM_SUPPORT__ */
        {
            cui_menu_set_item_hidden(option_id, MENU_ID_EMAIL_COMP_ATT_VIEW, MMI_TRUE);
        }
    }
}


static void mmi_email_comp_attach_options_handler(mmi_menu_id menu_id, mmi_id grp_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_OPTIONS_HANDLER, __LINE__);

    switch (menu_id)
    {
        case MENU_ID_EMAIL_COMP_ATT_VIEW:
            mmi_email_comp_attach_view();
            break;
        case MENU_ID_EMAIL_COMP_ATT_ADD:
            mmi_email_comp_attach_add_new(email_app_comp.attach_grp_id);
            break;
        case MENU_ID_EMAIL_COMP_ATT_DEL:
            mmi_email_util_display_confirm(
                email_app_comp.attach_grp_id,
                mmi_email_comp_attach_del,
                mmi_frm_scrn_close_active_id,
                NULL,
                FALSE,
                GetString(STR_EMAIL_DEL_COMP_ATT_ID),
                MMI_EVENT_QUERY);
            break;
        case MENU_ID_EMAIL_COMP_ATT_DEL_ALL:
            mmi_email_util_display_confirm(
                email_app_comp.attach_grp_id,
                mmi_email_comp_attach_del_all,
                mmi_frm_scrn_close_active_id,
                NULL,
                FALSE,
                GetString(STR_EMAIL_DEL_COMP_ATT_ALL_ID),
                MMI_EVENT_QUERY);
            break;
        default:
            break;
    }
    return;
}


static void mmi_email_comp_attach_opt(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_id opt_grp_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_OPT, __LINE__);

    opt_grp_id = cui_menu_create(
        email_app_comp.attach_grp_id,
        CUI_MENU_SRC_TYPE_RESOURCE,
        CUI_MENU_TYPE_OPTION,
        MENU_ID_EMAIL_COMP_ATTACH_OPT,
        MMI_FALSE,
        (void*)(&email_app_comp));
    cui_menu_set_default_title(opt_grp_id, (WCHAR*)GetString(STR_GLOBAL_OPTIONS), get_image(GetRootTitleIcon(MENU_ID_EMAIL_MAIN)));
    cui_menu_run(opt_grp_id);
}


static void mmi_email_comp_attach_add(void)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_ADD, __LINE__);
    mmi_email_comp_attach_add_new(email_app_comp.attach_grp_id);
}


static void mmi_email_comp_attach_add_new(mmi_id parent_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    FMGR_FILTER filter;
    U32 option_flag = CUI_FILE_SELECTOR_OPT_DRM_CHECK_SEND_ON |
                      CUI_FILE_SELECTOR_OPT_ARCHIVE_AS_UNKNOWN |
                      CUI_FILE_SELECTOR_OPT_FIXED_PATH_ON;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_ADD_NEW, __LINE__);

    email_app_comp.is_new_attach = TRUE;
    FMGR_FILTER_INIT(&filter);
    FMGR_FILTER_SET_ALL(&filter);
    email_app_comp.fmgr_cui_id = cui_file_selector_create(
        parent_id,
        L"root",
        (const FMGR_FILTER*)&filter,
        CUI_FILE_SELECTOR_STYLE_FILE_ONLY, 
        option_flag);
    cui_file_selector_set_title(
        email_app_comp.fmgr_cui_id,
        0,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN));
    cui_file_selector_set_userdata(
        email_app_comp.fmgr_cui_id,
        (U32)parent_id);
    cui_file_selector_run(email_app_comp.fmgr_cui_id);
}


static void mmi_email_comp_attach_view(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 item_index = 0;
    filetypes_group_type_enum fmgr_type = FMGR_GROUP_UNKNOWN;
    WCHAR *file_ext = NULL;
#ifdef __DRM_SUPPORT__    
    U8 permission = DRM_PERMISSION_NONE;
    U8 method = DRM_METHOD_NONE;
    FS_HANDLE fileHandle;
#endif /* __DRM_SUPPORT__ */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_VIEW, __LINE__);

    if (email_app_comp.att_num != MMI_EMAIL_MAX_ATTACH_NUMBER)
    {
        item_index = email_app_comp.curr_hilit_attach_index - MMI_EMAIL_COMP_ATTACH_FIX_TOTAL;
    }
    else
    {
        item_index = email_app_comp.curr_hilit_attach_index;
    }

    fmgr_type = srv_fmgr_types_find_group_by_filename_str(attach_info_array[item_index].name);
#ifdef __DRM_SUPPORT__
    if (attach_info_array[item_index].drm_object)
    {
        if (fmgr_type == FMGR_GROUP_AUDIO)
        {
            permission = DRM_PERMISSION_PLAY;
        }
        else if (fmgr_type == FMGR_GROUP_VIDEO)
        {
            permission = DRM_PERMISSION_PLAY;
        }
#ifdef __MMI_IMAGE_VIEWER__
        else if (fmgr_type == FMGR_GROUP_IMAGE)
        {
            permission = DRM_PERMISSION_DISPLAY;
        }
#endif /* __MMI_IMAGE_VIEWER__ */

        if ((fileHandle = DRM_open_file(
            (UI_string_type)attach_info_array[item_index].path, 
            FS_READ_ONLY | FS_OPEN_SHARED, 
            permission)) >= FS_NO_ERROR)
        {
            if ((method = DRM_get_object_method(fileHandle, NULL)) != DRM_METHOD_NONE)
            {
                if (DRM_validate_permission(fileHandle, NULL, permission) == MMI_FALSE)
                {
                    if (method & DRM_METHOD_SEPARATE_DELIVERY)
                    {
                        U32 size = sizeof(rights_issuer);
                        /* request rights from server */
                        memset(rights_issuer, 0, sizeof(rights_issuer));
                        if (FS_NO_ERROR <= DRM_get_rights_issuer(fileHandle, rights_issuer, &size))
                        {
#ifdef BROWSER_SUPPORT
                            mmi_email_util_display_confirm(
                                email_app_comp.attach_grp_id,
                                mmi_email_request_rights,
                                mmi_frm_scrn_close_active_id,
                                NULL,
                                TRUE,
                                GetString(STR_ID_RMGR_REQ_RIGHTS),
                                MMI_EVENT_QUERY);
#else
                            mmi_email_lib_error_popup(STR_GLOBAL_DRM_PROHIBITED);
#endif
                            DRM_close_file(fileHandle);
                            return;
                        }
                    }
                    mmi_email_lib_error_popup(STR_GLOBAL_DRM_PROHIBITED);
                    DRM_close_file(fileHandle);
                    return;
                }
            }
            DRM_close_file(fileHandle);
        }
        else
        {
            /* open file fail */
            mmi_email_util_display_popup(
                email_app_comp.attach_grp_id,
                GetString(srv_fmgr_fs_error_get_string(fileHandle)),
                MMI_EVENT_FAILURE);
            return;
        }    
    }
#endif /* __DRM_SUPPORT__ */ 

    if (
#ifdef __MMI_IMAGE_VIEWER__
        fmgr_type == FMGR_GROUP_IMAGE ||
#endif /* __MMI_IMAGE_VIEWER__ */
        fmgr_type == FMGR_GROUP_AUDIO ||
        fmgr_type == FMGR_GROUP_VIDEO)
    {
        file_ext = mmi_email_get_file_ext(attach_info_array[item_index].name);
        mmi_email_copy_file_to_view(
            email_app_comp.attach_grp_id,
            attach_info_array[item_index].path,
            file_ext,
            mmi_email_comp_copy_to_view_attach);
    }
}


void mmi_email_comp_copy_to_view_attach(WCHAR *new_file_path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 item_index = 0;
    filetypes_group_type_enum fmgr_type = FMGR_GROUP_UNKNOWN;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_COPY_TO_VIEW_ATTACH, __LINE__);

    if (email_app_comp.att_num != MMI_EMAIL_MAX_ATTACH_NUMBER)
    {
        item_index = email_app_comp.curr_hilit_attach_index - MMI_EMAIL_COMP_ATTACH_FIX_TOTAL;
    }
    else
    {
        item_index = email_app_comp.curr_hilit_attach_index;
    }
    fmgr_type = srv_fmgr_types_find_group_by_filename_str(attach_info_array[item_index].name);
    if (fmgr_type == FMGR_GROUP_AUDIO)
    {
        mmi_media_app_play_audio_with_title(
            (CHAR*)new_file_path,
            NULL,
            (U16)NULL,
            (CHAR*)attach_info_array[item_index].name);
    }
    else if (fmgr_type == FMGR_GROUP_VIDEO)
    {
#ifdef __MMI_VIDEO_STREAM__  
        S32 type = 0;
        type = srv_fmgr_types_find_type_by_filepath(attach_info_array[item_index].name);
        if (type == FMGR_TYPE_SDP)
        {
            mmi_media_app_play_stream_from_sdp_file_ext((CHAR*)new_file_path, FALSE,
                (CHAR*)attach_info_array[item_index].name);
        }
        else if (type == FMGR_TYPE_RAM)
        {
            mmi_media_app_play_stream_from_ram_file((CHAR*)new_file_path, FALSE);
        }
        else /* other video type */
        {
            mmi_media_app_play_video_ext((CHAR*)new_file_path, FALSE,
                (CHAR*)attach_info_array[item_index].name);
        }
#else
        mmi_media_app_play_video_ext((CHAR*)new_file_path, FALSE,
            (CHAR*)attach_info_array[item_index].name);
#endif /* __MMI_VIDEO_STREAM__ */
    }
#ifdef __MMI_IMAGE_VIEWER__
    else if (fmgr_type == FMGR_GROUP_IMAGE)
    {
        if ((email_app_comp.viewer_cui_id = cui_imgview_create(email_app_comp.attach_grp_id)) != GRP_ID_INVALID)
        {
            cui_imgview_set_mode_filename(email_app_comp.viewer_cui_id, (CHAR*)new_file_path);
            cui_imgview_set_app_id(email_app_comp.viewer_cui_id, APP_IMAGEVIEWER);
            cui_imgview_set_title(email_app_comp.viewer_cui_id, attach_info_array[item_index].name, GetRootTitleIcon(MENU_ID_EMAIL_MAIN));
            cui_imgview_set_ui_direction(email_app_comp.viewer_cui_id, CUI_IMGVIEW_UI_DIRECTION_VERTICAL);
            cui_imgview_set_display_cap(email_app_comp.viewer_cui_id, CUI_IMGVIEW_CAP_ALL, MMI_FALSE);   
            cui_imgview_set_display_cap(email_app_comp.viewer_cui_id, CUI_IMGVIEW_CAP_ZOOM, MMI_TRUE);   
            cui_imgview_set_display_cap(email_app_comp.viewer_cui_id, CUI_IMGVIEW_CAP_IMG_ROTATE, MMI_TRUE);   
            cui_imgview_set_display_cap(email_app_comp.viewer_cui_id, CUI_IMGVIEW_CAP_UI_ROTATE, MMI_TRUE);   
            cui_imgview_set_display_cap(email_app_comp.viewer_cui_id, CUI_IMGVIEW_CAP_TITLE, MMI_TRUE);   
            cui_imgview_run(email_app_comp.viewer_cui_id);
        }
    }
#endif /* __MMI_IMAGE_VIEWER__ */
}


static void mmi_email_comp_attach_del(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 item_index = 0, index = 0;
    U32 orig_size = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_DEL, __LINE__);

    if (email_app_comp.att_num != MMI_EMAIL_MAX_ATTACH_NUMBER)
    {
        item_index = email_app_comp.curr_hilit_attach_index - MMI_EMAIL_COMP_ATTACH_FIX_TOTAL;
    }
    else
    {
        item_index = email_app_comp.curr_hilit_attach_index;
    }

    if (mmi_email_lib_is_copy_file_dir(attach_info_array[item_index].path))
    {
        FS_Delete(attach_info_array[item_index].path);
    }
    orig_size = attach_info_array[item_index].size;
    for (index = item_index; index < (S32)email_app_comp.att_num - 1; index++)
    {
        memcpy(
            &attach_info_array[index],
            &attach_info_array[index + 1],
            sizeof(srv_email_attach_struct));
    }
    memset(
        &attach_info_array[index],
        0,
        sizeof(srv_email_attach_struct));
    if (email_app_comp.att_num == MMI_EMAIL_MAX_ATTACH_NUMBER)
    {
        email_app_comp.curr_hilit_attach_index += MMI_EMAIL_COMP_ATTACH_FIX_TOTAL;
    }
    email_app_comp.att_num -= 1;
    email_app_comp.attach_total_size -= orig_size;
    srv_email_msg_update_attach(
        email_app_comp.msg_handle,
        email_app_comp.att_num,
        attach_info_array);
    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_ATT;
    if (!email_app_comp.att_num)
    {
        email_app_comp.is_show_att_field = FALSE;
        cui_inline_delete_item(email_app_comp.inline_id, MMI_EMAIL_COMP_ATTACH_ITEM_ID);
    }
    email_app_comp.att_changed = TRUE;

    mmi_frm_scrn_close_active_id();
}


static void mmi_email_comp_attach_del_all(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 index = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ATTACH_DEL_ALL, __LINE__);

    for (index = 0; index < email_app_comp.att_num; index++)
    {
        if (mmi_email_lib_is_copy_file_dir(attach_info_array[index].path))
        {
            FS_Delete(attach_info_array[index].path);
        }
    }
    memset(
        &attach_info_array,
        0,
        sizeof(srv_email_attach_struct) * MMI_EMAIL_MAX_ATTACH_NUMBER);
    email_app_comp.att_num = 0;
    email_app_comp.attach_total_size = 0;
    srv_email_msg_update_attach(
        email_app_comp.msg_handle,
        email_app_comp.att_num,
        attach_info_array);
    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_ATT;
    if (email_app_comp.is_show_att_field)
    {
        email_app_comp.is_show_att_field = FALSE;
        cui_inline_delete_item(email_app_comp.inline_id, MMI_EMAIL_COMP_ATTACH_ITEM_ID);
    }
    mmi_frm_scrn_close_active_id();
}


EMAIL_MSG_HANDLE mmi_email_comp_re_get_msg_handle(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_RE_GET_MSG_HANDLE, __LINE__);

    srv_email_msg_destroy(email_app_comp.msg_handle);
    email_app_comp.msg_handle = 0;
    result = srv_email_msg_create(0, &email_app_comp.msg_handle);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        return 0;
    }
    result = srv_email_msg_open(
                email_app_comp.msg_handle,
                email_app_comp.acct_id,
                email_comp_curr_fldr_id,
                email_comp_curr_msg_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        return 0;
    }
    return email_app_comp.msg_handle;
}


void mmi_email_set_ss(email_app_save_send_proc_struct *info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SET_SS, __LINE__);

    memcpy(
        &email_app_save_send,
        info,
        sizeof(email_app_save_send_proc_struct));
    email_app_save_send.new_msg_id = 0;
    email_app_save_send.is_exit = FALSE;
}


void mmi_email_save_send_result(BOOL result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SAVE_SEND_RESULT, __LINE__);

    email_app_save_send.is_exit = TRUE;
    if ((email_app_save_send.opt & MMI_EMAIL_SS_SAVE) ||
        (email_app_save_send.opt & MMI_EMAIL_SS_SAVE_NEW) ||
        (email_app_save_send.opt & MMI_EMAIL_SS_MOVE))
    {
        if (email_app_save_send.curr_opt == MMI_EMAIL_SS_SEND)
        {
            result = TRUE;
        }
    }
    (*email_app_save_send.callback)(result, email_app_save_send.user_data);
    if (email_app_save_send.new_msg_id)
    {
        srv_email_msg_destroy(email_app_save_send.msg_handle);
    }
    mmi_frm_group_close(email_app_save_send.grp_id);
}


void mmi_email_exit_save_send(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_EXIT_SAVE_SEND, __LINE__);
    if (email_app_save_send.grp_id)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_EXIT_SAVE_SEND, __LINE__);
        mmi_frm_group_close(email_app_save_send.grp_id);
        email_app_save_send.grp_id = 0;
    }
}


void mmi_email_save_send(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SAVE_SEND, __LINE__);

    email_app_save_send.grp_id = mmi_frm_group_create(
        email_app_save_send.parent_id,
        GRP_ID_AUTO_GEN,
        mmi_email_ss_group_proc,
        (void*)(&email_app_save_send));

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SAVE_SEND, __LINE__);

    mmi_frm_group_enter(email_app_save_send.grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SAVE_SEND, __LINE__);

    srv_email_msg_regist_callback(
        email_app_save_send.msg_handle,
        mmi_email_ss_func_callback,
        (void*)(&email_app_save_send));

    if (email_app_save_send.opt & MMI_EMAIL_SS_SAVE)
    {
        result = srv_email_msg_update_attach(
            email_app_comp.msg_handle,
            email_app_comp.att_num,
            attach_info_array);
        if (result == SRV_EMAIL_RESULT_SUCC)
        {
            result = srv_email_msg_save(
                email_app_save_send.msg_handle,
                email_app_save_send.save_part,
                &email_app_save_send.req_id);
            email_app_save_send.curr_opt = MMI_EMAIL_SS_SAVE;
        }
    }
    else if (email_app_save_send.opt & MMI_EMAIL_SS_MOVE)
    {
        result = srv_email_msg_update_attach(
            email_app_comp.msg_handle,
            email_app_comp.att_num,
            attach_info_array);
        if (result == SRV_EMAIL_RESULT_SUCC)
        {
            result = srv_email_msg_save(
                email_app_save_send.msg_handle,
                email_app_save_send.save_part,
                &email_app_save_send.req_id);
                email_app_save_send.curr_opt = MMI_EMAIL_SS_MOVE;
        }
    }
    else if (email_app_save_send.opt & MMI_EMAIL_SS_SAVE_NEW)
    {
        result = srv_email_msg_update_attach(
            email_app_comp.msg_handle,
            email_app_comp.att_num,
            attach_info_array);
        if (result == SRV_EMAIL_RESULT_SUCC)
        {
            result = srv_email_msg_save_new(
                email_app_save_send.msg_handle,
                email_app_save_send.dst_acct_id,
                email_app_save_send.dst_fldr_id,
                &email_app_save_send.new_msg_id,
                &email_app_save_send.req_id);
            email_app_save_send.curr_opt = MMI_EMAIL_SS_SAVE_NEW;
        }
    }
    else
    {
        result = SRV_EMAIL_RESULT_SUCC;
    }

    if (result == SRV_EMAIL_RESULT_WOULDBLOCK)
    {
        email_app_save_send.str_id = STR_GLOBAL_SAVING;
        kal_wsprintf(
            email_ss_loading_str,
            "%w\n ",
            (WCHAR*)GetString(STR_GLOBAL_SAVING));
        email_app_save_send.img_id = mmi_get_event_based_image(MMI_EVENT_PROGRESS);
        mmi_email_ss_entry_loading();
        return;
    }
    else if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(0, result);
        if (email_app_save_send.opt & MMI_EMAIL_SS_SEND)
        {
            email_app_save_send.new_msg_id = 0;
        }
        mmi_email_save_send_result(FALSE);
        return;
    }
    else
    {
        // Saved successfully
    }

    if (email_app_save_send.opt & MMI_EMAIL_SS_CHANGE)
    {
        email_app_save_send.msg_handle = mmi_email_comp_re_get_msg_handle();
        if (!email_app_save_send.msg_handle)
        {
            srv_email_msg_destroy(email_app_save_send.msg_handle);
            mmi_email_util_display_error_popup(0, result);
            mmi_email_save_send_result(FALSE);
            return;
        }
        result = srv_email_msg_move(
            email_app_save_send.msg_handle,
            email_app_save_send.dst_acct_id,
            email_app_save_send.dst_fldr_id,
            &email_app_save_send.new_msg_id);
    }

    if ((email_app_save_send.opt & MMI_EMAIL_SS_SEND) ||
        (email_app_save_send.opt & MMI_EMAIL_SS_MOVE))
    {
        if (email_app_save_send.opt & MMI_EMAIL_SS_MOVE)
        {
            email_app_save_send.msg_handle = mmi_email_comp_re_get_msg_handle();
            if (!email_app_save_send.msg_handle)
            {
                srv_email_msg_destroy(email_app_save_send.msg_handle);
                mmi_email_util_display_error_popup(0, result);
                mmi_email_save_send_result(FALSE);
                return;
            }

            srv_email_msg_regist_callback(
                email_app_save_send.msg_handle,
                mmi_email_ss_func_callback,
                (void*)(&email_app_save_send));

            result = srv_email_msg_move(
                email_app_save_send.msg_handle,
                email_app_save_send.dst_acct_id,
                email_app_save_send.dst_fldr_id,
                &email_app_save_send.new_msg_id);
            if (result != SRV_EMAIL_RESULT_SUCC)
            {
                mmi_email_util_display_error_popup(0, result);
                mmi_email_save_send_result(FALSE);
                return;
            }
        }

        if (email_app_save_send.new_msg_id)
        {
            srv_email_msg_clear_callback(email_app_save_send.msg_handle);
            email_app_save_send.msg_handle = 0;

            result = srv_email_msg_create(0, &email_app_save_send.msg_handle);
            result = srv_email_msg_open(
                email_app_save_send.msg_handle,
                email_app_save_send.dst_acct_id,
                email_app_save_send.dst_fldr_id,
                email_app_save_send.new_msg_id);
            if (result != SRV_EMAIL_RESULT_SUCC)
            {
                srv_email_msg_destroy(email_app_save_send.msg_handle);
                mmi_email_util_display_error_popup(0, result);
                mmi_email_save_send_result(FALSE);
                return;
            }
            srv_email_msg_regist_callback(
                email_app_save_send.msg_handle,
                mmi_email_ss_func_callback,
                (void*)(&email_app_save_send));
        }

        // Start to send all
        mmi_email_save_send_result(TRUE);
        mmi_email_app_nwk_user_send(email_app_save_send.dst_acct_id, FALSE);
    }
    else
    {
        //mmi_email_lib_succ_popup(STR_GLOBAL_SAVED);
        mmi_email_save_send_result(TRUE);
    }

    if (result == SRV_EMAIL_RESULT_WOULDBLOCK)
    {
        ASSERT(0);
        email_app_save_send.str_id = STR_GLOBAL_CONNECTING;
        kal_wsprintf(
            email_ss_loading_str,
            "%w\n ",
            (WCHAR*)GetString(STR_GLOBAL_CONNECTING));
        email_app_save_send.img_id = mmi_get_event_based_image(MMI_EVENT_PROGRESS);
        mmi_email_ss_entry_loading();
        return;
    }
    else if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(0, result);
        mmi_email_save_send_result(FALSE);
        return;
    }
}


static mmi_ret mmi_email_ss_group_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (evt->evt_id)
    {
        case EVT_ID_GROUP_DEINIT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SS_GROUP_PROC, __LINE__);
            if (!email_app_save_send.is_exit)
            {
                mmi_email_ss_general_cancel();
            }
            srv_email_msg_clear_callback(email_app_save_send.msg_handle);
            break;

        default:
            break;
    }

    return MMI_RET_OK;
}


void mmi_email_ss_exit_loading(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SS_EXIT_LOADING, __LINE__);
//    email_ss_is_show = FALSE;
}


static void mmi_email_ss_entry_loading(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SS_ENTRY_LOADING, __LINE__);
    if (!mmi_frm_scrn_enter(
            email_app_save_send.grp_id,
            SCR_EMAIL_NWK_SCREEN_ID,
            mmi_email_ss_exit_loading,
            mmi_email_ss_entry_loading,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SS_ENTRY_LOADING, __LINE__);
        return;
    }
    ShowCategory66Screen(
        STR_GLOBAL_EMAIL,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        0,
        0,
        0,//STR_GLOBAL_CANCEL,
        0,//IMG_GLOBAL_BACK,
        (U8*)email_ss_loading_str,
        mmi_email_lib_get_progress_img_id(),
        NULL);
//    email_ss_is_show = TRUE;
    SetLeftSoftkeyFunction(NULL, KEY_EVENT_UP);
    SetRightSoftkeyFunction(NULL, /*mmi_email_ss_general_cancel, */ KEY_EVENT_UP);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SS_ENTRY_LOADING, __LINE__);
}


void mmi_email_ss_entry_disconnecting(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SS_ENTRY_DISCONNECTING, __LINE__);
    if (!mmi_frm_scrn_enter(
            email_app_save_send.grp_id,
            SCR_EMAIL_LOADING_ID,
            NULL,
            mmi_email_ss_entry_disconnecting,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SS_ENTRY_DISCONNECTING, __LINE__);
        return;
    }
    ShowCategory66Screen(
        STR_GLOBAL_EMAIL,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        0,
        0,
        0,
        0,
        (U8*)GetString(STR_GLOBAL_DISCONNECTING),
        mmi_email_lib_get_progress_img_id(),
        NULL);
    SetLeftSoftkeyFunction(NULL, KEY_EVENT_UP);
    SetRightSoftkeyFunction(NULL, KEY_EVENT_UP);
    SetKeyHandler(NULL, KEY_END, KEY_EVENT_DOWN);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SS_ENTRY_DISCONNECTING, __LINE__);
}


static void mmi_email_ss_general_cancel(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SS_GENERAL_CANCEL, __LINE__);
    srv_email_msg_abort(
        email_app_save_send.msg_handle,
        email_app_save_send.req_id);
    mmi_email_save_send_result(FALSE);
}


static void mmi_email_ss_func_callback(srv_email_result_struct *result, EMAIL_REQ_ID req_id, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_result_enum ret = SRV_EMAIL_RESULT_SUCC;
    U16 opt = email_app_save_send.curr_opt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SS_FUNC_CALLBACK, __LINE__);

    ASSERT(opt != MMI_EMAIL_SS_SEND);

    if (result->result)
    {
        if ((opt == MMI_EMAIL_SS_SAVE) ||
            (opt == MMI_EMAIL_SS_SAVE_NEW) ||
            (opt == MMI_EMAIL_SS_MOVE))
        {
            if (email_app_save_send.opt & MMI_EMAIL_SS_CHANGE)
            {
                email_app_save_send.msg_handle = mmi_email_comp_re_get_msg_handle();
                if (!email_app_save_send.msg_handle)
                {
                    srv_email_msg_destroy(email_app_save_send.msg_handle);
                    mmi_email_util_display_error_popup(0, ret);
                    mmi_email_save_send_result(FALSE);
                    return;
                }
                ret = srv_email_msg_move(
                    email_app_save_send.msg_handle,
                    email_app_save_send.dst_acct_id,
                    email_app_save_send.dst_fldr_id,
                    &email_app_save_send.new_msg_id);
            }

            if ((email_app_save_send.opt & MMI_EMAIL_SS_SEND) ||
                (email_app_save_send.opt & MMI_EMAIL_SS_MOVE))
            {
                if (email_app_save_send.opt & MMI_EMAIL_SS_MOVE)
                {
                    email_app_save_send.msg_handle = mmi_email_comp_re_get_msg_handle();
                    if (!email_app_save_send.msg_handle)
                    {
                        mmi_email_util_display_error_popup(0, ret);
                        mmi_email_save_send_result(FALSE);
                        return;
                    }
                    srv_email_msg_regist_callback(
                        email_app_save_send.msg_handle,
                        mmi_email_ss_func_callback,
                        (void*)(&email_app_save_send));

                    ret = srv_email_msg_move(
                        email_app_save_send.msg_handle,
                        email_app_save_send.dst_acct_id,
                        email_app_save_send.dst_fldr_id,
                        &email_app_save_send.new_msg_id);
                    if (ret != SRV_EMAIL_RESULT_SUCC)
                    {
                        mmi_email_util_display_error_popup(email_app_save_send.parent_id, ret);
                        mmi_email_save_send_result(FALSE);
                        return;
                    }
                }

                if (email_app_save_send.new_msg_id)
                {
                    srv_email_msg_clear_callback(email_app_save_send.msg_handle);
                    //srv_email_msg_clear_proc_callback(email_app_save_send.msg_handle);
                    email_app_save_send.msg_handle = 0;
                    ret = srv_email_msg_create(0, &email_app_save_send.msg_handle);
                    ret = srv_email_msg_open(
                        email_app_save_send.msg_handle,
                        email_app_save_send.dst_acct_id,
                        email_app_save_send.dst_fldr_id,
                        email_app_save_send.new_msg_id);
                    if (ret != SRV_EMAIL_RESULT_SUCC)
                    {
                        srv_email_msg_destroy(email_app_save_send.msg_handle);
                        mmi_email_util_display_error_popup(email_app_save_send.parent_id, ret);
                        mmi_email_save_send_result(FALSE);
                        return;
                    }
                    srv_email_msg_regist_callback(
                        email_app_save_send.msg_handle,
                        mmi_email_ss_func_callback,
                        (void*)(&email_app_save_send));
                }

                mmi_email_save_send_result(TRUE);
                mmi_email_app_nwk_user_send(email_app_save_send.dst_acct_id, FALSE);
                return;
            }
        }

        if (opt == MMI_EMAIL_SS_SEND)
        {
            ASSERT(0);
            return;
        }

        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_AUTOTEST_SAVE_DRAFT_DONE);
        mmi_email_save_send_result(TRUE);
        return;
    }
    else
    {
        mmi_email_util_display_popup(
            0,
            GetString(mmi_email_util_get_err_code(result->major, result->minor)),
            MMI_EVENT_FAILURE);
        mmi_email_save_send_result(FALSE);
        return;
    }
}

/************************************************************************/
/*                             APIS                                     */
/************************************************************************/

/*****************************************************************************
 * FUNCTION
 *  mmi_email_app_send_init_param_to_null
 * DESCRIPTION
 *  init the data struct pointer to NULL
 * PARAMETERS
 *  mail_param     [IN]     data struct pointer of mail param
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_email_app_send_init_param_to_null(mmi_email_app_send_param_struct *mail_param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_INIT_PARAM_TO_NULL, __LINE__);

    memset(mail_param, 0, sizeof(mmi_email_app_send_param_struct));
    mail_param->priority = EMAIL_MSG_PRIO_MED;
    mail_param->parent_id = GRP_ID_ROOT;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_app_send_cont
 * DESCRIPTION
 *  Interface for other applications to send a UCS2 string as email content.
 * PARAMETERS
 *  cont             [IN]        input parameter by other application
 *                               the input string should bu UCS2
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_email_app_send_cont(const CHAR *cont)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_app_send_param_struct *email_param = NULL;
    CHAR drive = srv_email_get_drive();

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_CONT, __LINE__);
    if (!mmi_email_smgr_show_ui_check(NULL))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_CONT, -1);
        return;
    }

    email_param = OslMalloc(sizeof(mmi_email_app_send_param_struct));
    mmi_email_app_send_init_param_to_null(email_param);
    email_param->cont = (CHAR*)cont;
    mmi_email_app_send(email_param, EMAIL_CONT_FILL_FLAG);
    OslMfree(email_param);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_app_send_to_ext
 * DESCRIPTION
 *  Interface for other applications to use a UCS2 string as TO address
 *  to send an email
 * PARAMETERS
 *  to_addr             [IN]        input parameter by other application
 *                                  the input string should be UCS2
 *  to_name             [IN]        input parameter by other application
 *                                  the input string should be UCS2
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_email_app_send_to_ext(const CHAR *to_addr, const CHAR *to_name)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_app_send_param_struct *email_param = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_email_smgr_show_ui_check(NULL))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_TO_EXT, -1);
        return;
    }

    if (to_addr == NULL)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_TO_EXT, -2);
        mmi_email_lib_error_popup(STR_GLOBAL_EMPTY);
    }

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_TO_EXT, 0);

    email_param = OslMalloc(sizeof(mmi_email_app_send_param_struct));
    mmi_email_app_send_init_param_to_null(email_param);
    email_param->addr[0].addr_mail = (CHAR*)to_addr;
    email_param->addr[0].addr_name = (CHAR*)to_name;
    email_param->to_num = 1;
    mmi_email_app_send(email_param, EMAIL_TO_FILL_FLAG);
    OslMfree(email_param);
}


/*****************************************************************************
* FUNCTION
*  mmi_email_app_send_to
* DESCRIPTION
*  Interface for other applications to use a UCS2 string as TO address
*  to send an email
* PARAMETERS
*  to_addr             [IN]        input parameter by other application
*                                  the input string should be UCS2
* RETURNS
*  void
*****************************************************************************/
void mmi_email_app_send_to(const CHAR *to_addr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_TO, __LINE__);

    mmi_email_app_send_to_ext(to_addr, NULL);
}

void mmi_email_app_send_attch_for_opera(const CHAR *file_path)
{
    mmi_email_app_send_attch(file_path);
}

/*****************************************************************************
* FUNCTION
*  mmi_email_app_send_attch
* DESCRIPTION
*  Interface for other applications to use a UCS2 string
*  as attachment file path to send an email
* PARAMETERS
*  file_path             [IN]        input parameter by other application
*                                    the input string should be UCS2
* RETURNS
*  void
*****************************************************************************/
void mmi_email_app_send_attch(const CHAR *file_path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_app_send_param_struct *email_param = NULL;
    CHAR drive = srv_email_get_drive();

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_ATTCH, __LINE__);

    if (!mmi_email_smgr_show_ui_check(NULL))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_ATTCH, -1);
        return;
    }

    if (file_path != NULL)
    {
        email_param = OslMalloc(sizeof(mmi_email_app_send_param_struct));
        mmi_email_app_send_init_param_to_null(email_param);
        email_param->attch_file_path = (CHAR*)file_path;
        mmi_email_app_send(email_param, EMAIL_ATTCH_FILL_FLAG);
        OslMfree(email_param);
    }
    else
    {
        mmi_email_lib_error_popup(STR_GLOBAL_EMPTY);
    }
}


/*****************************************************************************
* FUNCTION
*  mmi_email_app_send_attch_from_vobj
* DESCRIPTION
*  Interface for other applications to use a UCS2 string
*  as attachment file path to send an email
* PARAMETERS
*  file_path             [IN]        input parameter by other application
*                                    the input string should be UCS2
*  callback              [IN]        call back function for PHB to release
memory buffer and delete temporary file
* RETURNS
*  void
*****************************************************************************/
void mmi_email_app_send_attch_from_vobj(const CHAR *file_path, vobj_email_cb callback)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_app_send_param_struct *email_param = NULL;
    CHAR drive = srv_email_get_drive();

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_ATTCH_FROM_VOBJ, __LINE__);

    if (!mmi_email_smgr_show_ui_check(NULL))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_ATTCH_FROM_VOBJ, -1);
        return;
    }

    if (file_path != NULL)
    {
        if (vobj_buff != NULL && mmi_wcscmp((WCHAR*)vobj_buff, (WCHAR*)file_path) != 0)
        {
        mmi_email_app_send_attch_from_vobj_free();
        }
        email_param = OslMalloc(sizeof(mmi_email_app_send_param_struct));
        if (email_comp_select_acct_grp_id)
        {    
            mmi_frm_group_close(email_comp_select_acct_grp_id);
        }
        mmi_email_app_send_init_param_to_null(email_param);
        email_param->attch_file_path = (CHAR*)file_path;
        vobj_callback = callback;
        vobj_buff = (void*)file_path;
        mmi_email_app_send(email_param, EMAIL_ATTCH_FILL_FLAG);
        OslMfree(email_param);
    }
    else
    {
        mmi_email_lib_error_popup(STR_GLOBAL_EMPTY);
    }
}


/*****************************************************************************
* FUNCTION
*  mmi_email_app_send_attch_from_vobj_free
* DESCRIPTION
*  Free the memory
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
void mmi_email_app_send_attch_from_vobj_free(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_ATTCH_FROM_VOBJ_FREE, __LINE__);

    if (vobj_buff && vobj_callback)
    {
        (*vobj_callback)(vobj_buff);
        vobj_callback = NULL;
        vobj_buff = NULL;
    }
}


/*****************************************************************************
* FUNCTION
*  mmi_email_app_send_attch_to_addr
* DESCRIPTION
*  Interface for other applications to use a UCS2 string
*  as attachment file path to send to an address via email
* PARAMETERS
*  file_path             [IN]        input parameter by other application
*                                    the input string should be UCS2
* RETURNS
*  void
*****************************************************************************/
void mmi_email_app_send_attch_to_addr(const CHAR *file_path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_app_send_param_struct *email_param = NULL;
    CHAR drive = srv_email_get_drive();

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_ATTCH_TO_ADDR, __LINE__);

    if (!mmi_email_smgr_show_ui_check(NULL))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_ATTCH_TO_ADDR, -1);
        return;
    }

    if (file_path != NULL)
    {
        email_param = OslMalloc(sizeof(mmi_email_app_send_param_struct));
        mmi_email_app_send_init_param_to_null(email_param);
        email_param->attch_file_path = (CHAR*)file_path;
        email_param->is_to_addr = MMI_TRUE;
        mmi_email_app_send(email_param, EMAIL_ATTCH_FILL_FLAG);
        OslMfree(email_param);
    }
    else
    {
        mmi_email_lib_error_popup(STR_GLOBAL_EMPTY);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_app_send
 * DESCRIPTION
 *  Interface for other applications to send a mail.
 * PARAMETERS
 *  mail_param             [IN]        input parameter by other application
 *                                     the input string should bu UCS2
 *  mail_param_fill_flag   [IN]        input parameter fill flag mask
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_email_app_send(
        mmi_email_app_send_param_struct *mail_param,
        email_app_send_param_fill_enum mail_param_fill_flag)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 count = 0;
    EMAIL_ACCT_ID acct_id = 0;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND, __LINE__);

    if (!mmi_email_smgr_show_ui_check(NULL))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND, -1);
        mmi_email_app_send_attch_from_vobj_free();
        return;
    }

    if (email_comp_select_acct_grp_id)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND, __LINE__);
        mmi_frm_group_close(email_comp_select_acct_grp_id);
    }

    if (mail_param == NULL || mail_param_fill_flag == 0x00)
    {
        mmi_email_lib_error_popup(STR_GLOBAL_EMPTY);
        /* PHB buffer release */
        mmi_email_app_send_attch_from_vobj_free();
        return;
    }

    result = srv_email_acct_get_num(&count);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(0, result);
        /* PHB buffer release */
        mmi_email_app_send_attch_from_vobj_free();
        return;
    }

    if (count == 0)
    {
        mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_ACCT_NOT_CONFIG_ID);
        /* PHB buffer release */
        mmi_email_app_send_attch_from_vobj_free();
        return;
    }

    result = srv_email_acct_get_default(&acct_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_lib_error_popup(STR_GLOBAL_CURRENTLY_NOT_AVAILABLE);
        /* PHB buffer release */
        mmi_email_app_send_attch_from_vobj_free();
        return;
    }

    if (mmi_email_app_send_file_check((WCHAR*)mail_param->attch_file_path, mail_param_fill_flag))
    {
        mmi_email_app_send_copy_param(&email_comp_mail_param, &email_comp_mail_param_fill_flag, mail_param, mail_param_fill_flag);
        if (!(mail_param_fill_flag & EMAIL_NEW_FILL_FLAG))
        {
            if (!mmi_email_app_check_send_addr(mail_param))
            {
                mmi_email_lib_error_popup(STR_GLOBAL_INVALID_EMAIL_ADDRESS);
                mmi_email_app_send_free_mem();
                return;
            }
        }

        if (mail_param->acct_id != 0)
        {
            acct_id = mail_param->acct_id;
        }

        if (acct_id == 0)
        {
            email_comp_select_acct_grp_id = mmi_frm_group_create(
                mail_param->parent_id,
                GRP_ID_AUTO_GEN,
                mmi_email_comp_acct_select_group_proc,
                NULL);
            mmi_frm_group_enter(email_comp_select_acct_grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
            email_comp_acct_select_mail_param = OslMalloc(sizeof(mmi_email_app_send_param_struct));
            mmi_email_app_send_copy_param(
                email_comp_acct_select_mail_param,
                &email_comp_acct_select_mail_param_fill_flag,
                &email_comp_mail_param,
                email_comp_mail_param_fill_flag);
            mmi_email_comp_entry_acct_select();
            mmi_email_app_send_free_mem_ext();
            return;
        }
        else
        {
            email_comp_mail_param.acct_id = acct_id;
        }
        mmi_email_app_exec_send();
    }
    else
    {
        /* PHB buffer release */
        mmi_email_app_send_attch_from_vobj_free();
    }
}


static mmi_ret mmi_email_comp_acct_select_group_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch(evt->evt_id)
    {
        case EVT_ID_GROUP_FOCUSED:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ACCT_SELECT_GROUP_PROC, __LINE__);
            mmi_email_set_active_group_id(email_comp_select_acct_grp_id);
            break;

        case EVT_ID_GROUP_DEINIT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ACCT_SELECT_GROUP_PROC, __LINE__);
            if (email_comp_acct_select_mail_param)
            {
                memcpy(&email_comp_mail_param, email_comp_acct_select_mail_param, sizeof(mmi_email_app_send_param_struct));
                email_comp_mail_param_fill_flag = email_comp_acct_select_mail_param_fill_flag;
                mmi_email_app_send_free_mem();
                OslMfree(email_comp_acct_select_mail_param);
                email_comp_acct_select_mail_param = NULL;
            }
            email_comp_acct_select_mail_param_fill_flag = (email_app_send_param_fill_enum)0;
            break;

        default:
            break;
    }
    return MMI_RET_OK;
}


static void mmi_email_comp_entry_acct_select(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 i = 0;
    U8 *nStrItemList[MMI_EMAIL_MAX_ACCTS];
    U32 count = 0;
    U8 *gui_buffer;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    srv_email_acct_info_cache_struct *cache_info = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ENTRY_ACCT_SELECT, __LINE__);
    if (!mmi_frm_scrn_enter(
            email_comp_select_acct_grp_id,
            SCR_ID_EMAIL_COMP_ACCT_SELECT,
            NULL,
            mmi_email_comp_entry_acct_select,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ENTRY_ACCT_SELECT, __LINE__);
        return;
    }
    gui_buffer = mmi_frm_scrn_get_active_gui_buf();
    email_comp_selected_index = 0;
    srv_email_acct_get_num(&count);
    if (count == 0)
    {
        mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_ACCT_NOT_CONFIG_ID);
        mmi_frm_group_close(email_comp_select_acct_grp_id);
        return;
    }
    result = srv_email_acct_get_acct_id(0, (S32*)(&count), email_comp_acct_id_array);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(0, result);
        mmi_frm_group_close(email_comp_select_acct_grp_id);
        return;
    }
    memset(email_comp_acct_name, 0, sizeof(email_comp_acct_name));
    cache_info = OslMalloc(sizeof(srv_email_acct_info_cache_struct));
    for (; i < count; i++)
    {
        srv_email_acct_cache_get(email_comp_acct_id_array[i], cache_info);
        mmi_wcscpy(email_comp_acct_name[i], cache_info->acct_name);
        nStrItemList[i] = (U8*)email_comp_acct_name[i];
    }
    OslMfree(cache_info);
    RegisterHighlightHandler(mmi_email_comp_hilit_acct_handler);
    EnableCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    ShowCategory53Screen(
        STR_EMAIL_EMAIL_ACCTS_ID,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        count,
        nStrItemList,
        (U16*)gIndexIconsImageList,
        NULL,
        0,
        (S32)email_comp_selected_index,
        gui_buffer);
    SetLeftSoftkeyFunction(mmi_email_comp_acct_select_lsk, KEY_EVENT_UP);
    SetRightSoftkeyFunction(mmi_frm_scrn_close_active_id, KEY_EVENT_UP);
    SetCenterSoftkeyFunction(mmi_email_comp_acct_select_lsk, KEY_EVENT_UP);
    mmi_frm_scrn_set_leave_proc(
        email_comp_select_acct_grp_id,
        SCR_ID_EMAIL_COMP_ACCT_SELECT,
        mmi_email_comp_acct_select_end_key);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ENTRY_ACCT_SELECT, __LINE__);
}


static void mmi_email_comp_hilit_acct_handler(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    email_comp_selected_index = (U8)index;
}


static mmi_ret mmi_email_comp_acct_select_end_key(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ACCT_SELECT_END_KEY, __LINE__);
    switch (evt->evt_id)
    {
        case EVT_ID_SCRN_GOBACK_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ:
        case EVT_ID_SCRN_GOBACK:
            email_comp_select_acct_grp_id = 0;
            break;
    }
    return MMI_RET_OK;
}


static void mmi_email_comp_acct_select_lsk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_id acct_id = 0;
    mmi_id grp_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_ACCT_SELECT_LSK, __LINE__);

    acct_id = email_comp_acct_id_array[email_comp_selected_index];
    memcpy(&email_comp_mail_param, email_comp_acct_select_mail_param, sizeof(mmi_email_app_send_param_struct));
    email_comp_mail_param_fill_flag = email_comp_acct_select_mail_param_fill_flag;
    email_comp_mail_param.acct_id = acct_id;
    email_comp_mail_param.parent_id = GRP_ID_ROOT;
    OslMfree(email_comp_acct_select_mail_param);
    email_comp_acct_select_mail_param = NULL;
    email_comp_acct_select_mail_param_fill_flag = (email_app_send_param_fill_enum)0;
    mmi_frm_scrn_set_leave_proc(
        email_comp_select_acct_grp_id,
        SCR_ID_EMAIL_COMP_ACCT_SELECT,
        NULL);
    grp_id = email_comp_select_acct_grp_id;
    email_comp_select_acct_grp_id = 0;
    mmi_email_app_exec_send();
    mmi_frm_group_close(grp_id);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_app_send_file_check
 * DESCRIPTION
 *  Check the file from other APP to send
 * PARAMETERS
 *  filePath                [IN]        Complete file path and name of the selected file
 *  mail_param_fill_flag    [IN]        input parameter fill flag mask
 * RETURNS
 *  TRUE: can send; FALSE: can not
 *****************************************************************************/
static BOOL mmi_email_app_send_file_check(
                WCHAR *filePath,
                email_app_send_param_fill_enum mail_param_fill_flag)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 fileLen = 0;
    S32 f_result = FS_NO_ERROR;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_FILE_CHECK, __LINE__);

    if ((mail_param_fill_flag & EMAIL_ATTCH_FILL_FLAG) && (filePath == NULL))
    {
        mmi_email_lib_error_popup(STR_EMAIL_EMPTY_FILE_ID);
        return FALSE;
    }

#ifdef __DRM_SUPPORT__
    if (mail_param_fill_flag & EMAIL_ATTCH_FILL_FLAG)
    {
        S32 mime_type, mime_subtype;
        S32 fwd_flag = 0;
        mmi_email_util_get_mine_type((WCHAR*)filePath, &mime_type, &mime_subtype);
        if (mime_subtype == MIME_SUBTYPE_DRM_MESSAGE)
        {
            mmi_email_lib_error_popup(STR_GLOBAL_DRM_PROHIBITED);
            return FALSE;
        }
        fwd_flag = mmi_rmgr_check_forward((U16*)filePath);
        if (!(fwd_flag & MMI_RMGR_USAGE_SEND))
        {
            mmi_email_lib_error_popup(STR_GLOBAL_DRM_PROHIBITED);
            return FALSE;
        }
        if (fwd_flag < 0)
        {
            mmi_email_util_display_popup(
                0,
                GetString(srv_fmgr_fs_error_get_string(fwd_flag)),
                MMI_EVENT_FAILURE);
            return FALSE;
        }        
    }
#endif /* __DRM_SUPPORT__ */

    if (!(mail_param_fill_flag & EMAIL_ATTCH_FILL_FLAG))
    {
        return TRUE;
    }
    f_result = FS_Open((U16*)filePath, FS_READ_ONLY | FS_OPEN_SHARED);
    if (f_result > 0)
    {
        FS_GetFileSize(f_result, (UINT*)(&fileLen));
        FS_Close(f_result);
        if (fileLen == 0)
        {
            mmi_email_lib_error_popup(STR_EMAIL_EMPTY_FILE_ID);
            return FALSE;
        }
        else if (fileLen > MMI_EMAIL_TOTAL_MAX_ATTACH_SIZE)
        {
            kal_wsprintf(
                selected_file_path,
                "%uKB %w",
                (U32)(MMI_EMAIL_TOTAL_MAX_ATTACH_SIZE) / 1024,
                (WCHAR*)GetString(STR_EMAIL_SIZE_TOO_LARGE));
            mmi_email_util_display_popup(
                0,
                (CHAR*)selected_file_path,
                MMI_EVENT_FAILURE);
            return FALSE;
        }
    }
    else
    {
        mmi_email_util_display_popup(
            0,
            GetString((U16)srv_fmgr_fs_error_get_string(f_result)),
            MMI_EVENT_FAILURE);
        return FALSE;
    }
    return TRUE;    
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_app_send_copy_param
 * DESCRIPTION
 *  copy parameters from other application
 * PARAMETERS
 *  mail_param              [IN]     parameters from other application
 *  mail_param_fill_flag    [IN]     parameter fill mask
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_email_app_send_copy_param(
                mmi_email_app_send_param_struct *dst_mail_param,
                email_app_send_param_fill_enum *dst_mail_param_fill_falg,
                mmi_email_app_send_param_struct *mail_param,
                email_app_send_param_fill_enum mail_param_fill_flag)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 buf_len = 0;
    U32 i = 0, j = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_COPY_PARAM, __LINE__);

    /*copy param fill flag*/
    *dst_mail_param_fill_falg = mail_param_fill_flag;

    /*init email_comp_mail_param*/
    mmi_email_app_send_init_param_to_null(dst_mail_param);

    /* the parent group ID is not valid now */
    dst_mail_param->parent_id = GRP_ID_ROOT;

    /*copy is_save_to_draft*/
    dst_mail_param->is_save_to_draft = mail_param->is_save_to_draft;

    dst_mail_param->is_to_addr = mail_param->is_to_addr;

    /*copy to*/
    if (mail_param_fill_flag & EMAIL_TO_FILL_FLAG)
    {
        for (i = 0, j = 0; j < mail_param->to_num; j++)
        {
            if (mail_param->addr[i].addr_mail != NULL)
            {
                mmi_email_app_send_copy_addr(&mail_param->addr[i], &dst_mail_param->addr[i]);
                i++;
            }
        }
    }
    dst_mail_param->to_num = mail_param->to_num;

    /*copy cc*/
    if (mail_param_fill_flag & EMAIL_CC_FILL_FLAG)
    {
        for (j = 0; j < mail_param->cc_num; j++)
        {
            if (mail_param->addr[i].addr_mail != NULL)
            {
                mmi_email_app_send_copy_addr(&mail_param->addr[i], &dst_mail_param->addr[i]);
                i++;
            }
        }        
    }
    dst_mail_param->cc_num = mail_param->cc_num;

#ifdef __MMI_EMAIL_BCC__
    /*copy bcc*/
    if (mail_param_fill_flag & EMAIL_BCC_FILL_FLAG)
    {
        for (j = 0; j < mail_param->bcc_num; j++)
        {
            if (mail_param->addr[i].addr_mail != NULL)
            {
                mmi_email_app_send_copy_addr(&mail_param->addr[i], &dst_mail_param->addr[i]);
                i++;
            }
        }       
    }
#endif /*__MMI_EMAIL_BCC__*/
    dst_mail_param->bcc_num = mail_param->bcc_num;

    /*copy subject*/
    if (mail_param_fill_flag & EMAIL_SUBJ_FILL_FLAG)
    {
        mmi_email_app_send_copy_subj((WCHAR*)mail_param->subj, (WCHAR**)(&dst_mail_param->subj));
    }

    /*copy attachment file path*/
    if (mail_param_fill_flag & EMAIL_ATTCH_FILL_FLAG)
    {
        if (mail_param->attch_file_path!= NULL)
        {
            buf_len = mmi_wcslen((WCHAR*)mail_param->attch_file_path);

            if (buf_len > SRV_FMGR_PATH_MAX_LEN)
            {
                buf_len = SRV_FMGR_PATH_MAX_LEN;
            }
            dst_mail_param->attch_file_path = OslMalloc((buf_len + 1) * sizeof(WCHAR));
            mmi_wcsncpy(
                (WCHAR*)dst_mail_param->attch_file_path,
                (WCHAR*)mail_param->attch_file_path,
                (U32)buf_len);
        }
    }

    /*copy priority*/
    if (mail_param_fill_flag & EMAIL_PRIOR_FILL_FLAG)
    {
        dst_mail_param->priority = mail_param->priority;
    }

    /*copy content*/
    if (mail_param_fill_flag & EMAIL_CONT_FILL_FLAG)
    {
        mmi_email_app_send_copy_cont((WCHAR*)mail_param->cont, (WCHAR**)(&dst_mail_param->cont));
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_app_send_copy_addr
 * DESCRIPTION
 *  copy to/cc/bcc parameters from other application
 * PARAMETERS
 *  addr_param     [IN]     address parameter
 *  addr_dest      [IN/OUT]     copying destination
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_email_app_send_copy_addr(
                mmi_email_app_send_addr_struct *addr_param,
                mmi_email_app_send_addr_struct *addr_dest)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 buf_len;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_COPY_ADDR, __LINE__);
    if (addr_param->addr_mail != NULL)
    {
        buf_len = mmi_wcslen((WCHAR*)addr_param->addr_mail);
    
        if (buf_len > MMI_EMAIL_MAX_ADDR_LEN)
        {
            buf_len = MMI_EMAIL_MAX_ADDR_LEN;
        }
        addr_dest->addr_mail = OslMalloc((buf_len + 1) * sizeof(WCHAR));
        mmi_wcsncpy(
            (WCHAR*)addr_dest->addr_mail,
            (WCHAR*)addr_param->addr_mail,
            (U32)buf_len);
    }

    if (addr_param->addr_name != NULL)
    {
        buf_len = mmi_wcslen((WCHAR*)addr_param->addr_name);
    
        if (buf_len > SRV_EMAIL_MAX_DISP_NAME_LEN)
        {
            buf_len = SRV_EMAIL_MAX_DISP_NAME_LEN;
        }
        addr_dest->addr_name = OslMalloc((buf_len + 1) * sizeof(WCHAR));
        mmi_wcsncpy(
            (WCHAR*)addr_dest->addr_name,
            (WCHAR*)addr_param->addr_name,
            (U32)buf_len);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_app_send_copy_subj
 * DESCRIPTION
 *  copy subject parameter from other application
 * PARAMETERS
 *  subj     [IN]     subject parameter
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_email_app_send_copy_subj(WCHAR *subj, WCHAR **dst_subj)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 buf_len;
    BOOL is_trunc = MMI_FALSE;
    S32 dots_len = mmi_wcslen(g_email_2dots);

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_COPY_SUBJ, __LINE__);

    if (subj != NULL)
    {
        buf_len = mmi_wcslen(subj);

        if (buf_len > MMI_EMAIL_MAX_SUBJ_LEN)
        {
            buf_len = MMI_EMAIL_MAX_SUBJ_LEN;
            is_trunc = TRUE;
        }
        *dst_subj = OslMalloc((buf_len + 1) * sizeof(WCHAR));
        mmi_wcsncpy(
            *dst_subj,
            subj,
            (U32)buf_len);
        if (is_trunc == TRUE)
        {
            (*dst_subj)[MMI_EMAIL_MAX_SUBJ_LEN - dots_len] = L'\0';
            mmi_wcscat(*dst_subj, g_email_2dots);
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_app_send_copy_cont
 * DESCRIPTION
 *  copy content parameter from other application
 * PARAMETERS
 *  cont     [IN]     content parameter
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_email_app_send_copy_cont(WCHAR *cont, WCHAR **dst_cont)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 buf_len;
    BOOL is_trunc = FALSE;
    S32 dots_len = mmi_wcslen(g_email_2dots);

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_COPY_CONT, __LINE__);

    if (cont!= NULL)
    {
        buf_len = mmi_wcslen(cont);

        if (buf_len > MMI_EMAIL_MAX_CONT_LEN)
        {
            buf_len = MMI_EMAIL_MAX_CONT_LEN;
            is_trunc = TRUE;
        }
        *dst_cont = OslMalloc((buf_len + 1) * sizeof(WCHAR));
        mmi_wcsncpy(
            *dst_cont,
            cont,
            (U32)buf_len);
        if (is_trunc == TRUE)
        {
            (*dst_cont)[MMI_EMAIL_MAX_CONT_LEN - dots_len] = L'\0';
            mmi_wcscat(*dst_cont, g_email_2dots);
        }
    }
}


/*****************************************************************************
* FUNCTION
*  mmi_email_app_check_send_addr
* DESCRIPTION
*  Check the mail address
* PARAMETERS
*  mail_param             [IN]        input parameter by other application
*                                     the input string should bu UCS2
* RETURNS
*  TURE: valid, FALSE: invalid
*****************************************************************************/
static BOOL mmi_email_app_check_send_addr(mmi_email_app_send_param_struct *mail_param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 i = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_CHECK_SEND_ADDR, __LINE__);

    for (; i < mail_param->to_num; i++)
    {
        if (mmi_wcslen((WCHAR*)mail_param->addr[i].addr_mail) == 0)
        {
            break;
        }
        if (!mmi_email_util_chk_addr((WCHAR*)mail_param->addr[i].addr_mail))
        {
            return FALSE;
        }
    }
    for (; i < mail_param->cc_num; i++)
    {
        if (mmi_wcslen((WCHAR*)mail_param->addr[i].addr_mail) == 0)
        {
            break;
        }
        if (!mmi_email_util_chk_addr((WCHAR*)mail_param->addr[i].addr_mail))
        {
            return FALSE;
        }
    }
#ifdef __MMI_EMAIL_BCC__
    for (; i < mail_param->bcc_num; i++)
    {
        if (mmi_wcslen((WCHAR*)mail_param->addr[i].addr_mail) == 0)
        {
            break;
        }
        if (!mmi_email_util_chk_addr((WCHAR*)mail_param->addr[i].addr_mail))
        {
            return FALSE;
        }
    }
#endif /*__MMI_EMAIL_BCC__*/
    return TRUE;
}


/*****************************************************************************
* FUNCTION
*  mmi_email_app_send_free_mem
* DESCRIPTION
*  Free allocated memory
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
static void mmi_email_app_send_free_mem(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* PHB buffer release */
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_FREE_MEM, __LINE__);

    mmi_email_app_send_attch_from_vobj_free();
    mmi_email_app_send_free_mem_ext();
}


/*****************************************************************************
* FUNCTION
*  mmi_email_app_send_free_mem
* DESCRIPTION
*  Free allocated memory
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
static void mmi_email_app_send_free_mem_ext(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /*release recipients memory*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_FREE_MEM_EXT, __LINE__);

    for (; i < MMI_EMAIL_MAX_ADDR_NUM; i++)
    {
        if (email_comp_mail_param.addr[i].addr_mail != NULL)
        {
            OslMfree(email_comp_mail_param.addr[i].addr_mail);
            email_comp_mail_param.addr[i].addr_mail = NULL;
        }
        if (email_comp_mail_param.addr[i].addr_name != NULL)
        {
            OslMfree(email_comp_mail_param.addr[i].addr_name);
            email_comp_mail_param.addr[i].addr_name = NULL;
        }
    }
    /*release subject memory*/
    if (email_comp_mail_param.subj != NULL)
    {
        OslMfree(email_comp_mail_param.subj);
        email_comp_mail_param.subj = NULL;
    }
    /*release attach memory*/
    if (email_comp_mail_param.attch_file_path != NULL)
    {
        OslMfree(email_comp_mail_param.attch_file_path);
        email_comp_mail_param.attch_file_path = NULL;
    }
    /*release content memory*/
    if (email_comp_mail_param.cont != NULL)
    {
        OslMfree(email_comp_mail_param.cont);
        email_comp_mail_param.cont = NULL;
    }
    memset(&email_comp_mail_param, 0, sizeof(email_comp_mail_param));
}


static void mmi_email_app_exec_send_ext(void)
{
     mmi_email_prepare_comp_struct *comp_data = NULL;

     MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_EXEC_SEND_EXT, __LINE__);

    mmi_email_reset_curr_comp_info();

    /* Prepare ASM */
    if (mmi_email_comp_asm_create() == NULL)
    {
        return;
    }

    comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));
    memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
    comp_data->acct_id = email_comp_mail_param.acct_id;
    comp_data->fldr_id = 0;
    comp_data->msg_id = 0;
    /* the parent group ID is not valid now */
    email_comp_mail_param.parent_id = GRP_ID_ROOT;
    comp_data->parent_id = email_comp_mail_param.parent_id;
    comp_data->type = EMAIL_PRE_COMP_TYPE_CONTINUE;
    mmi_email_prepare_entry_comp(comp_data);
    OslMfree(comp_data);
    mmi_email_app_send_free_mem_ext();
}

/*****************************************************************************
* FUNCTION
*  mmi_email_app_exec_send
* DESCRIPTION
*  Execute sending of a file.
*  Initialize global variable of Write Email screen and send email start request.
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
static void mmi_email_app_exec_send(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_app_core_result_enum ret = MMI_EMAIL_SUCCESS;
    MMI_BOOL status = MMI_FALSE;
    mmi_email_sig_struct *sig_info = NULL;
    U16 index = 0;
    U32 size = 0, total_num = 0, att_size = 0;
    FS_HANDLE handle = 0;
    BOOL ret_fill;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_EXEC_SEND, __LINE__);

    if (email_comp_mail_param_fill_flag & EMAIL_ATTCH_FILL_FLAG)
    {
        ret = mmi_email_sig_get_status(email_comp_mail_param.acct_id, &status);
        if ((ret == MMI_EMAIL_SUCCESS) &&
            (status == MMI_TRUE))
        {
            sig_info = OslMalloc(sizeof(mmi_email_sig_struct));
            ret = mmi_email_sig_get_signature(email_comp_mail_param.acct_id, sig_info);
            if (ret == MMI_EMAIL_SUCCESS)
            {
                for (; index < sig_info->image_num; index++)
                {
                    memset(selected_file_path, 0, sizeof(selected_file_path));
                    size = 0;
                    ret = mmi_email_sig_get_image_path(email_comp_mail_param.acct_id, index, selected_file_path, SRV_FMGR_PATH_MAX_LEN);
                    if (ret == MMI_EMAIL_SUCCESS)
                    {
                        handle = FS_Open((U16*)selected_file_path, FS_READ_ONLY | FS_OPEN_SHARED);
                        if (handle > 0)
                        {
                            FS_GetFileSize(handle, (UINT*)(&size));
                            FS_Close(handle);
                        }
                        total_num += 1;
                    }
                    else
                    {
                        break;
                    }
                }
            }
            OslMfree(sig_info);
        }
        handle = FS_Open((U16*)email_comp_mail_param.attch_file_path, FS_READ_ONLY | FS_OPEN_SHARED);
        if (handle > 0)
        {
            FS_GetFileSize(handle, (UINT*)(&att_size));
            FS_Close(handle);
            if (att_size == 0)
            {
                mmi_email_lib_error_popup(STR_EMAIL_EMPTY_FILE_ID);
                mmi_email_app_send_free_mem();
                return;
            }
            else if (att_size + size > MMI_EMAIL_TOTAL_MAX_ATTACH_SIZE)
            {
                kal_wsprintf(
                    selected_file_path,
                    "%uKB %w",
                    (U32)(MMI_EMAIL_TOTAL_MAX_ATTACH_SIZE) / 1024,
                    (WCHAR*)GetString(STR_EMAIL_SIZE_TOO_LARGE));
                mmi_email_util_display_popup(
                    email_comp_mail_param.parent_id,
                    (CHAR*)selected_file_path,
                    MMI_EVENT_FAILURE);
                mmi_email_app_send_free_mem();
                return;
            }
        }
        else
        {
            mmi_email_util_display_popup(
                email_comp_mail_param.parent_id,
                GetString((U16)srv_fmgr_fs_error_get_string(handle)),
                MMI_EVENT_FAILURE);
            mmi_email_app_send_free_mem();
            return;
        }
    }
    if (!email_comp_mail_param.is_to_addr)
    {
        mmi_email_app_exec_send_ext();
    }
    else
    {
        EMAIL_MSG_HANDLE msg_handle = 0;
        srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
        S32 fldr_type_array[2] = {SRV_EMAIL_FLDR_TYPE_DRAFT, SRV_EMAIL_FLDR_TYPE_OUTBOX};
        EMAIL_FLDR_ID fldr_id_array[2] = {0};
        mmi_id grp_id = 0;
        result = srv_email_msg_create(0, &msg_handle);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(0, result);
            return;
        }
        result = srv_email_msg_set_new(msg_handle);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(0, result);
            srv_email_msg_destroy(msg_handle);
            return;
        }

        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_EXEC_SEND, __LINE__);
        grp_id = mmi_frm_group_create(
            GRP_ID_ROOT,
            GRP_ID_AUTO_GEN,
            mmi_email_app_to_addr_group_proc,
            NULL);

        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_EXEC_SEND, __LINE__);
        mmi_frm_group_enter(grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_EXEC_SEND, __LINE__);

        /*
         * because the account select group will be closed, so we need to
         * create the new group and enter it first to prevent display app screen
         */
        mmi_email_reset_curr_comp_info();
        memset(&email_editing_addr_buff, 0, sizeof(srv_email_addr_struct));
        /* the parent group ID is not valid now */
        email_comp_mail_param.parent_id = GRP_ID_ROOT;
        email_app_comp.parent_id = email_comp_mail_param.parent_id;
        email_app_comp.acct_id = email_comp_mail_param.acct_id;
        email_app_comp.grp_id = grp_id;
        mmi_email_util_get_fldr_id_by_acct(
            email_app_comp.acct_id,
            2,
            fldr_type_array,
            fldr_id_array);
        email_app_comp.draft_fldr_id = fldr_id_array[0];
        email_app_comp.outbox_fldr_id = fldr_id_array[1];
        email_app_comp.msg_handle = msg_handle;
        email_app_comp.type = EMAIL_PRE_COMP_TYPE_CONTINUE;
        email_app_comp.is_close_parent = FALSE;
        ret_fill = mmi_email_app_send_fill_data();
        if (!ret_fill)
        {
            //mmi_email_util_display_error_popup(0, result);
            srv_email_msg_destroy(msg_handle);
            mmi_frm_group_close(grp_id);
            return;
        }
        email_comp_copy_attach_callback = mmi_email_comp_to_addr_add_attach_done_copy_ret_handler;
        mmi_email_comp_pre_copy_attach(0, NULL);
    }
}


static void mmi_email_comp_to_addr_add_attach_done_copy_ret_handler(BOOL result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_entry_send_to_addr_evt_struct entry_evt;
    srv_email_result_enum ret = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_TO_ADDR_ADD_ATTACH_DONE_COPY_RET_HANDLER, __LINE__);
    if (result)
    {
        email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_ATT;
        ret = srv_email_msg_update_attach(
                email_app_comp.msg_handle,
                email_app_comp.att_num,
                attach_info_array);
        if (ret != SRV_EMAIL_RESULT_SUCC)
        {
            mmi_email_util_display_error_popup(0, ret);
            mmi_frm_group_close(email_app_comp.grp_id);
            return;
        }

        mmi_email_app_entry_send_file_to_addr();
        MMI_FRM_INIT_GROUP_EVENT(&entry_evt, EVT_ID_ENTRY_SEND_TO_ADDR_SCREEN, email_app_comp.grp_id);
        MMI_FRM_POST_EVENT(&entry_evt, mmi_email_app_to_addr_group_proc, NULL);
        mmi_email_app_send_free_mem_ext();
        mmi_frm_scrn_close(email_app_comp.grp_id, SCR_ID_EMAIL_COMP_ATTACH_COPY);
    }
    else
    {
        mmi_frm_group_close(email_app_comp.grp_id);
    }
}


static BOOL mmi_email_app_send_fill_data(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 index = 0, j = 0;
    U32 size = 0;
    FS_HANDLE handle = 0;
    srv_email_msg_update_content_struct cont_buf;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_SEND_FILL_DATA, __LINE__);

    if (email_comp_mail_param_fill_flag & EMAIL_TO_FILL_FLAG)
    {
        for (index = 0, j = 0; j < email_comp_mail_param.to_num; j++)
        {
            mmi_wcscpy(
                email_app_comp.addr_list[index].email_addr,
                (WCHAR*)email_comp_mail_param.addr[index].addr_mail);
            if (email_comp_mail_param.addr[index].addr_name)
            {
                mmi_wcscpy(
                    email_app_comp.addr_list[index].disp_name,
                    (WCHAR*)email_comp_mail_param.addr[index].addr_name);
            }
            email_app_comp.addr_list[index].disp_name_len =
                mmi_wcslen(email_app_comp.addr_list[index].disp_name);
            email_app_comp.addr_list[index].disp_charset = MMI_CHSET_UCS2;
            email_app_comp.to_num += 1;
            index++;
        }
        /* update */
        email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
        srv_email_msg_update_recipient(
            email_app_comp.msg_handle,
            SRV_EMAIL_ADDR_TYPE_TO,
            email_app_comp.to_num,
            email_app_comp.addr_list);
    }
    if (email_comp_mail_param_fill_flag & EMAIL_CC_FILL_FLAG)
    {
        for (j = 0; j < email_comp_mail_param.cc_num; j++)
        {
            mmi_wcscpy(
                email_app_comp.addr_list[index].email_addr,
                (WCHAR*)email_comp_mail_param.addr[index].addr_mail);
            if (email_comp_mail_param.addr[index].addr_name)
            {
                mmi_wcscpy(
                    email_app_comp.addr_list[index].disp_name,
                    (WCHAR*)email_comp_mail_param.addr[index].addr_name);
            }
            email_app_comp.addr_list[index].disp_name_len =
                mmi_wcslen(email_app_comp.addr_list[index].disp_name);
            email_app_comp.addr_list[index].disp_charset = MMI_CHSET_UCS2;
            email_app_comp.cc_num += 1;
            index++;
        }
        /* update */
        email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
        srv_email_msg_update_recipient(
            email_app_comp.msg_handle,
            SRV_EMAIL_ADDR_TYPE_CC,
            email_app_comp.cc_num,
            &email_app_comp.addr_list[email_app_comp.to_num]);
    }
#ifdef __MMI_EMAIL_BCC__
    if (email_comp_mail_param_fill_flag & EMAIL_BCC_FILL_FLAG)
    {
        for (j = 0; j < email_comp_mail_param.bcc_num; j++)
        {
            mmi_wcscpy(
                email_app_comp.addr_list[index].email_addr,
                (WCHAR*)email_comp_mail_param.addr[index].addr_mail);
            if (email_comp_mail_param.addr[index].addr_name)
            {
                mmi_wcscpy(
                    email_app_comp.addr_list[index].disp_name,
                    (WCHAR*)email_comp_mail_param.addr[index].addr_name);
            }
            email_app_comp.addr_list[index].disp_name_len =
                mmi_wcslen(email_app_comp.addr_list[index].disp_name);
            email_app_comp.addr_list[index].disp_charset = MMI_CHSET_UCS2;
            email_app_comp.bcc_num += 1;
            index++;
        }
        /* update */
        email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
        srv_email_msg_update_recipient(
            email_app_comp.msg_handle,
            SRV_EMAIL_ADDR_TYPE_BCC,
            email_app_comp.bcc_num,
            &email_app_comp.addr_list[email_app_comp.to_num + email_app_comp.cc_num]);
    }
#endif
    if (email_comp_mail_param_fill_flag & EMAIL_SUBJ_FILL_FLAG)
    {
        mmi_wcscpy(
            email_app_comp.subj,
            (WCHAR*)email_comp_mail_param.subj);
        email_app_comp.subj_len = mmi_wcslen(email_app_comp.subj);
        /* update */
        email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_SUB;
        srv_email_msg_update_subject(
            email_app_comp.msg_handle,
            email_app_comp.subj,
            MMI_CHSET_UCS2,
            email_app_comp.subj_len);
    }
    if (email_comp_mail_param_fill_flag & EMAIL_CONT_FILL_FLAG)
    {
        mmi_wcscpy(
            email_app_comp.content,
            (WCHAR*)email_comp_mail_param.cont);
        email_app_comp.cont_len = mmi_wcslen(email_app_comp.content);
        /* update */
        cont_buf.buff = email_app_comp.content;
        cont_buf.buff_len = email_app_comp.cont_len + 1;
        cont_buf.buff_type = MMI_TRUE;
        cont_buf.charset = MMI_CHSET_UCS2;
        email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_CON;
        srv_email_msg_update_content(
            email_app_comp.msg_handle,
            &cont_buf);
    }
    if (email_comp_mail_param_fill_flag & EMAIL_ATTCH_FILL_FLAG)
    {
        handle = FS_Open((U16*)email_comp_mail_param.attch_file_path, FS_READ_ONLY | FS_OPEN_SHARED);
        if (handle < 0)
        {
            // POPUP ERROR
            mmi_email_util_display_popup(
                0,
                GetString((U16)srv_fmgr_fs_error_get_string(handle)),
                MMI_EVENT_FAILURE);
            return FALSE;
        }

        FS_GetFileSize(handle, &size);
        FS_Close(handle);

        mmi_email_comp_attach_fill_new_info(0, 0, (WCHAR*)email_comp_mail_param.attch_file_path, size);
        email_app_comp.att_num = 1;
        result = mmi_email_comp_add_sig_info(0, email_comp_mail_param.acct_id);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            // POPUP
            mmi_email_util_display_error_popup(0, result);
            return FALSE;
        }
        /* update */
        email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_ATT;
        result = srv_email_msg_update_attach(
            email_app_comp.msg_handle,
            email_app_comp.att_num,
            attach_info_array);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            // POPUP
            mmi_email_util_display_error_popup(0, result);
            return FALSE;
        }
        mmi_email_comp_get_attach_display_field(email_app_comp.msg_handle);
        if ((email_comp_mail_param_fill_flag & EMAIL_SUBJ_FILL_FLAG) == 0)/*No subject*/
        {
            mmi_wcscpy(email_app_comp.subj, (WCHAR*)GetString(STR_EMAIL_COMMON_EMAILING_ID));
            email_app_comp.subj_len = mmi_wcslen((WCHAR*)GetString(STR_EMAIL_COMMON_EMAILING_ID));
            if ((MMI_EMAIL_MAX_SUBJ_LEN - email_app_comp.subj_len) < attach_info_array[0].name_len)
            {
                mmi_wcsncat(
                    email_app_comp.subj,
                    attach_info_array[0].name,
                    MMI_EMAIL_MAX_SUBJ_LEN - mmi_wcslen(g_email_2dots) - email_app_comp.subj_len);
                mmi_wcscat(email_app_comp.subj, g_email_2dots);
            }
            else
            {
                mmi_wcscat(email_app_comp.subj, attach_info_array[0].name);
            }
            email_app_comp.subj_len = mmi_wcslen(email_app_comp.subj);
            /* update */
            email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_SUB;
            srv_email_msg_update_subject(
                email_app_comp.msg_handle,
                email_app_comp.subj,
                MMI_CHSET_UCS2,
                email_app_comp.subj_len);
        }
    }
    else
    {
        result = mmi_email_comp_add_sig_info(0, email_comp_mail_param.acct_id);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            // POPUP
            mmi_email_util_display_error_popup(0, result);
            return FALSE;
        }
    }
    mmi_email_comp_fill_sender_info(email_app_comp.msg_handle);
    if (email_comp_mail_param_fill_flag & EMAIL_PRIOR_FILL_FLAG)
    {
        email_app_comp.priority = email_comp_mail_param.priority;
    }
    else
    {
        email_app_comp.priority = EMAIL_MSG_PRIO_MED;
    }
    return TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_fmgr_send
 * DESCRIPTION
 *  Interface for file manager to send a file.
 * PARAMETERS
 *  filePath        [IN]        Complete file path and name of the selected file
 *  is_short        [IN]        Convert the file name
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_email_fmgr_send(CHAR *file_path, BOOL is_short)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_FMGR_SEND, __LINE__);
    mmi_email_app_send_attch(file_path);
}


/*****************************************************************************
* FUNCTION
*  mmi_email_app_entry_comp
* DESCRIPTION
*  Interface for other applications to create a new Email
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
void mmi_email_app_entry_comp(EMAIL_ACCT_ID acct_id, mmi_id parent_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_app_send_param_struct *email_param = NULL;
    CHAR drive = srv_email_get_drive();

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_ENTRY_COMP, __LINE__);

    if (!mmi_email_smgr_show_ui_check(NULL))
    {
        return;
    }

    email_param = OslMalloc(sizeof(mmi_email_app_send_param_struct));
    mmi_email_app_send_init_param_to_null(email_param);
    email_param->acct_id = acct_id;
    email_param->parent_id = parent_id;
    mmi_email_app_send(email_param, EMAIL_NEW_FILL_FLAG);
    OslMfree(email_param);
}


static mmi_ret mmi_email_app_to_addr_group_proc(mmi_event_struct *event)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (event->evt_id)
    {
        case EVT_ID_GROUP_FOCUSED:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_TO_ADDR_GROUP_PROC, __LINE__);
            mmi_email_set_active_group_id(email_app_comp.grp_id);
            break;
        case EVT_ID_GROUP_DEINIT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_TO_ADDR_GROUP_PROC, __LINE__);
            {
                if (email_app_comp.fseditor_id)
                {
                    cui_fseditor_close(email_app_comp.fseditor_id);
                    email_app_comp.fseditor_id = 0;
                }
                if (email_app_comp.phb_cui_id)
                {
                    cui_phb_list_select_contact_close(email_app_comp.phb_cui_id);
                    email_app_comp.phb_cui_id = 0;
                }
                if (email_app_comp.msg_handle)
                {
                    srv_email_msg_destroy(email_app_comp.msg_handle);
                    email_app_comp.msg_handle = 0;
                }
                email_app_comp.grp_id = 0;
                mmi_email_app_send_free_mem();
            }
            break;
        case EVT_ID_CUI_FSEDITOR_SUBMMIT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_TO_ADDR_GROUP_PROC, __LINE__);
            {
                srv_email_addr_struct *addr = OslMalloc(sizeof(srv_email_addr_struct));
                cui_fseditor_get_text(
                    email_app_comp.fseditor_id,
                    addr->email_addr,
                    sizeof(addr->email_addr));
                if (mmi_wcslen(addr->email_addr) == 0)
                {
                    mmi_email_lib_error_popup(STR_EMAIL_COMP_UE_PLZ_ADD_RECIPIENT_ID);
                    OslMfree(addr);
                }
                else if (!mmi_email_util_chk_addr(addr->email_addr))
                {
                    mmi_email_lib_error_popup(STR_GLOBAL_INVALID_EMAIL_ADDRESS);
                    OslMfree(addr);
                }
                else
                {
                    mmi_wcscpy(email_app_comp.addr_list[0].email_addr, addr->email_addr);
                    mmi_wcscpy(email_app_comp.addr_list[0].disp_name, email_editing_addr_buff.disp_name);
                    email_app_comp.addr_list[0].disp_name_len = mmi_wcslen(email_app_comp.addr_list[0].disp_name);
                    OslMfree(addr);
                    email_app_comp.addr_list[0].disp_charset = MMI_CHSET_UCS2;
                    email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
                    email_app_comp.option_grp_id = cui_menu_create(
                        email_app_comp.grp_id,
                        CUI_MENU_SRC_TYPE_RESOURCE,
                        CUI_MENU_TYPE_APPSUB,
                        MENU_ID_EMAIL_COMP_SEND_TO_ADDR_OPT,
                        MMI_FALSE,
                        NULL);
                    cui_menu_set_default_title(email_app_comp.option_grp_id, (WCHAR*)GetString(STR_GLOBAL_OPTIONS), get_image(GetRootTitleIcon(MENU_ID_EMAIL_MAIN)));
                    cui_menu_run(email_app_comp.option_grp_id);
                }
            }
            break;
        case EVT_ID_CUI_FSEDITOR_ABORT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_TO_ADDR_GROUP_PROC, __LINE__);
            cui_fseditor_close(email_app_comp.fseditor_id);
            email_app_comp.fseditor_id = 0;
            break;
        case EVT_ID_CUI_FSEDITOR_CUSTOM_MENU_SELECTED:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_TO_ADDR_GROUP_PROC, __LINE__);
            {
                email_app_comp.phb_cui_id = cui_phb_list_select_contact_create(email_app_comp.grp_id);
                if (email_app_comp.phb_cui_id != GRP_ID_INVALID)
                {
                    cui_phb_list_select_contact_set_field_filter(email_app_comp.phb_cui_id, SRV_PHB_ENTRY_FIELD_EMAIL);
                    cui_phb_list_select_contact_run(email_app_comp.phb_cui_id);
                }
            }
            break;
        case EVT_ID_PHB_SELECT_CONTACT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_TO_ADDR_GROUP_PROC, __LINE__);
            {
                cui_phb_select_contact_result_struct *phb_data = (cui_phb_select_contact_result_struct*)event;
                mmi_wcscpy(email_editing_addr_buff.email_addr, (WCHAR*)phb_data->select_data);
                mmi_wcsncpy(email_editing_addr_buff.disp_name, (WCHAR*)phb_data->name, SRV_EMAIL_MAX_DISP_NAME_LEN);
                email_editing_addr_buff.disp_name_len = mmi_wcslen(email_editing_addr_buff.disp_name);
                email_editing_addr_buff.disp_charset = MMI_CHSET_UCS2;
                cui_fseditor_set_text(
                    email_app_comp.fseditor_id,
                    email_editing_addr_buff.email_addr,
                    (SRV_EMAIL_MAX_ADDR_LEN + 1) * ENCODING_LENGTH,
                    SRV_EMAIL_MAX_ADDR_LEN);
                email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
                cui_phb_list_select_contact_close(phb_data->sender_id);
                email_app_comp.phb_cui_id = 0;
            }
            break;
        case EVT_ID_PHB_SELECT_CONTACT_CANCEL:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_TO_ADDR_GROUP_PROC, __LINE__);
            {
                cui_phb_select_contact_result_struct *phb_data = (cui_phb_select_contact_result_struct*)event;
                cui_phb_list_select_contact_close(phb_data->sender_id);
                email_app_comp.phb_cui_id = 0;
            }
            break;
        case EVT_ID_CUI_MENU_LIST_ENTRY:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_TO_ADDR_GROUP_PROC, __LINE__);
            {
                cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)event;
                cui_menu_set_item_image(menu_evt->sender_id, MENU_ID_EMAIL_SEND_MSG, gIndexIconsImageList[0]);
                cui_menu_set_item_image(menu_evt->sender_id, MENU_ID_EMAIL_COMP_SAVE, gIndexIconsImageList[1]);
                cui_menu_set_item_image(menu_evt->sender_id, MENU_ID_EMAIL_COMP_EXIT, gIndexIconsImageList[2]);
            }
            break;
        case EVT_ID_CUI_MENU_ITEM_SELECT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_TO_ADDR_GROUP_PROC, __LINE__);
            {
                cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)event;
                mmi_email_comp_send_to_addr_option_handler(menu_evt->highlighted_menu_id, menu_evt->sender_id);
                break;
            }
        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_TO_ADDR_GROUP_PROC, __LINE__);
            {
                cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)event;
                cui_menu_close(menu_evt->sender_id);
                break;
            }
        case EVT_ID_ENTRY_SEND_TO_ADDR_SCREEN:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_TO_ADDR_GROUP_PROC, __LINE__);
            {
                if (email_is_recip_too_many)
                {
                    mmi_email_lib_infor_popup(STR_EMAIL_RECIPIENT_TOO_MANY_ID);
                    email_is_recip_too_many = FALSE;
                    break;
                }
                if (email_is_drm_file_deleted)
                {
                    mmi_email_lib_infor_popup(STR_EMAIL_DRM_FILE_IGNORE_ID);
                    email_is_drm_file_deleted = FALSE;
                    break;
                }
                if (email_is_attach_over_size)
                {
                    mmi_email_lib_infor_popup(STR_EMAIL_TOO_LARGE_TO_ADD_ID);
                    email_is_attach_over_size = FALSE;
                    break;
                }
                if (email_is_recip_invalid)
                {
                    mmi_email_lib_infor_popup(STR_GLOBAL_INVALID_EMAIL_ADDRESS);
                    email_is_recip_invalid = FALSE;
                    break;
                }
                if (email_is_sig_empty_file)
                {
                    mmi_email_lib_infor_popup(STR_EMAIL_EMPTY_FILE_ID);
                    email_is_sig_empty_file = FALSE;
                    break;
                }
                if (email_is_sig_fail)
                {
                    mmi_email_lib_infor_popup(STR_EMAIL_SIG_ADD_FAIL_ID);
                    email_is_sig_fail = FALSE;
                    break;
                }
                if (email_is_sig_missing)
                {
                    mmi_email_lib_infor_popup(STR_EMAIL_SIG_ADD_MISSING_ID);
                    email_is_sig_missing = FALSE;
                    break;
                }
            }
            break;
        default:
            break;
    }
    return MMI_RET_OK;
}


static void mmi_email_app_entry_send_file_to_addr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_ENTRY_SEND_FILE_TO_ADDR, __LINE__);

    memset(&email_editing_addr_buff, 0, sizeof(srv_email_addr_struct));
    email_app_comp.fseditor_id = cui_fseditor_create(email_app_comp.grp_id);
    cui_fseditor_set_title(email_app_comp.fseditor_id, STR_EMAIL_EMAIL_ADDRESS_ID, GetRootTitleIcon(MENU_ID_EMAIL_MAIN));
    cui_fseditor_set_text(
        email_app_comp.fseditor_id,
        email_editing_addr_buff.email_addr,
        sizeof(email_editing_addr_buff.email_addr),
        SRV_EMAIL_MAX_ADDR_LEN);
    cui_fseditor_set_input_method(
        email_app_comp.fseditor_id,
        IMM_INPUT_TYPE_EMAIL,
        NULL,
        0);
    cui_fseditor_set_custom_options_menu(
        email_app_comp.fseditor_id,
        MMI_FALSE,
        email_app_comp_addr_search,
        sizeof(email_app_comp_addr_search) / sizeof(mmi_menu_id));
    cui_fseditor_run(email_app_comp.fseditor_id);
}


static void mmi_email_comp_send_to_addr_option_handler(mmi_menu_id menu_id, mmi_id grp_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_msg_update_basic_info_struct *basic_info = NULL;
    email_app_save_send_proc_struct *info = NULL;
    email_app_save_send_opt_enum opt = MMI_EMAIL_SS_SAVE_NEW;
    EMAIL_FLDR_ID fldr_id = email_app_comp.draft_fldr_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COMP_SEND_TO_ADDR_OPTION_HANDLER, __LINE__);

    switch (menu_id)
    {
        case MENU_ID_EMAIL_SEND_MSG:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_AUTOTEST_SEND_START);
            opt |= MMI_EMAIL_SS_SEND;
            fldr_id = email_app_comp.outbox_fldr_id;
        case MENU_ID_EMAIL_COMP_SAVE:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_AUTOTEST_SAVE_DRAFT_START);
            {
                basic_info = OslMalloc(sizeof(srv_email_msg_update_basic_info_struct));
                basic_info->acct_id = email_app_comp.acct_id;
                basic_info->fldr_id = fldr_id;
                basic_info->priority = email_app_comp.priority;
                basic_info->flag = EMAIL_MSG_FLAG_SEEN;
                srv_email_msg_update_basic_info(
                    email_app_comp.msg_handle,
                    basic_info);
                OslMfree(basic_info);
                if (mmi_wcscmp(email_editing_addr_buff.email_addr, email_app_comp.addr_list[0].email_addr) != 0)
                {
                    memset(email_app_comp.addr_list[0].disp_name, 0, sizeof(SRV_EMAIL_MAX_DISP_NAME_LEN + 1));
                    email_app_comp.addr_list[0].disp_name_len = 0;
                }
                srv_email_msg_update_recipient(
                    email_app_comp.msg_handle,
                    SRV_EMAIL_ADDR_TYPE_TO,
                    1,
                    email_app_comp.addr_list);
                email_app_comp.save_part |= MMI_EMAIL_COMP_SAVE_TO;
                info = OslMalloc(sizeof(email_app_save_send_proc_struct));
                memset(info, 0, sizeof(email_app_save_send_proc_struct));
                info->dst_acct_id = email_app_comp.acct_id;
                info->dst_fldr_id = fldr_id;
                info->parent_id = email_app_comp.parent_id;
                info->msg_handle = email_app_comp.msg_handle;
                info->opt |= opt;
                info->callback = mmi_email_comp_save_send_callback;
                info->user_data = NULL;
                mmi_email_set_ss(info);
                OslMfree(info);
                mmi_email_save_send();
            }
            break;
        case MENU_ID_EMAIL_COMP_EXIT:
            mmi_frm_group_close(email_app_comp.grp_id);
            break;
        default:
            break;
    }
    return;
}


#endif
