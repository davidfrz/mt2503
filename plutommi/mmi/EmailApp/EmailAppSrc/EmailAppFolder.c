/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*******************************************************************************
 * Filename:
 * ---------
 * EmailAppMain.c
 *
 * Project:
 * --------
 * MAUI
 *
 * Description:
 * ------------
 * 
 *
 * Author:
 * -------
 * 
 *
 *==============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!! 
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!! 
 *==============================================================================
 *******************************************************************************/
#include "MMI_features.h"

#ifdef __MMI_EMAIL__

#include "CommonScreens.h"
#include "Menucuigprot.h"
#include "conversions.h"
#include "cbmsrvgprot.h"
#include "cbmcuigprot.h"

#include "EmailSrvGprot.h"
#include "EmailAppMem.h"
#include "EmailAppGProt.h"
#include "EmailAppAccount.h"
#include "EmailAppProt.h"

#include "MMIDataType.h"
#include "kal_general_types.h"
#include "customer_ps_inc.h"
#include "gui_typedef.h"
#include "mmi_frm_scenario_gprot.h"
#include "CustDataRes.h"
#include "GlobalResDef.h"
#include "mmi_rp_app_uiframework_def.h"
#include "mmi_frm_events_gprot.h"
#include "mmi_rp_app_email_def.h"
#include "mmi_frm_mem_gprot.h"
#include "app_mem.h"
#include "string.h"
#include "kal_public_api.h"
#include "Unicodexdcl.h"
#include "wgui_categories_util.h"
#include "wgui_categories_list.h"
#include "GlobalConstants.h"
#include "wgui_categories_popup.h"
#include "custom_events_notify.h"
#include "wgui_categories_email.h"
#include "mmi_inet_app_trc.h"
#include "DebugInitDef_Int.h"
#include "kal_trace.h"
#include "mmi_frm_input_gprot.h"
#include "gui_data_types.h"
#include "app_datetime.h"
#include "wgui_touch_screen.h"
#include "wgui_categories.h"
#ifdef __MMI_USB_SUPPORT__
 #include "USBSrvGProt.h"
#endif

#include "EmailAppLib.h"
#include "EmailAppAccountData.h"
#include "EmailAppNetwork.h"
#include "EmailAppStateMgr.h"

/************************************************************************/
/*                            Defines                                   */
/************************************************************************/
typedef struct 
{
    EMAIL_FLDR_HANDLE fldr_handle;
    EMAIL_MSG_ID curr_msg_id;
    EMAIL_REQ_ID req_id;
    mmi_id parent_grp_id;
    mmi_id option_menu_id;
    mmi_id grp_id;
    mmi_id loading_scr_id;
    mmi_id mark_grp_id;
    S32 mark_hilight_idx;
    BOOL delete_marked;
    EMAIL_MSG_ID mark_msg_id;
    S32 count;
    S32 hilight;
    BOOL is_inbox;
    BOOL mark_all;
    BOOL need_reset;
    srv_email_fldr_type_enum fldr_type;
    srv_email_fldr_create_info_struct folder_info;

    BOOL outside;
    BOOL need_fresh_list;
} email_app_folder_struct;

typedef enum
{
    MMI_EMAIL_FOLDER_OPT_NONE = 0,
    MMI_EMAIL_FOLDER_OPT_LIST,
    MMI_EMAIL_FOLDER_OPT_GET_MSG,
    MMI_EMAIL_FOLDER_OPT_SORT,
    MMI_EMAIL_FOLDER_OPT_DEL,

    MMI_EMAIL_FOLDER_OPT_SET_STATE,
    MMI_EMAIL_FOLDER_OPT_ALL
} email_app_folder_opt_enum;


/************************************************************************/
/*                          Variables                                   */
/************************************************************************/

email_app_folder_struct email_app_acct_fldr_data;
email_app_folder_opt_enum email_app_acct_fldr_opt;

srv_email_fldr_sort_msg_struct email_app_sort_info;
static mmi_id email_fldr_select_acct_grp_id = 0;
static U8 email_fldr_selected_index = 0;
static EMAIL_ACCT_ID email_fldr_acct_id_array[MMI_EMAIL_MAX_ACCTS];
static WCHAR email_fldr_acct_name[MMI_EMAIL_MAX_ACCTS][SRV_EMAIL_MAX_ACCT_NAME_LEN + 1];

static void *email_app_fldr_mem_ptr = NULL;
static mmi_id email_app_entry_fldr_acct_id = 0;


/************************************************************************/
/*                          Prototypes                                  */
/************************************************************************/

static mmi_ret mmi_email_fldr_acct_select_group_proc(mmi_event_struct *evt);
static void mmi_email_fldr_entry_acct_select(void);
static mmi_ret mmi_email_fldr_entry_acct_select_del_callback(mmi_event_struct *evt);
static void mmi_email_fldr_hilit_acct_handler(S32 index);
static void mmi_email_fldr_acct_select_lsk(void);
static void mmi_emaiL_fldr_acct_select_rsk(void);
static void mmi_email_app_entry_inbox_by_acct_ext(void);
static void mmi_email_entry_folder(void);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_acct_folder_tap_callback(mmi_tap_type_enum tap_type, S32 index);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

static mmi_ret mmi_email_folder_main_group_proc(mmi_event_struct *evt);
static void mmi_email_folder_general_callback(srv_email_result_struct *result, EMAIL_REQ_ID req_id, void *user_data);
static void mmi_email_entry_folder_loading(void);
static void mmi_email_folder_general_cancel(void);
static void mmi_email_hilite_acct_folder_item(S32 index);
static void mmi_email_acct_folder_csk(void);
static void mmi_email_acct_folder_lsk(void);
static mmi_ret mmi_email_acct_folder_opt_proc(mmi_event_struct *evt);
static void mmi_email_acct_folder_hide_menu_items(EMAIL_MSG_ID msg_id);
static void mmi_email_acct_folder_hide_reply(EMAIL_MSG_ID msg_id);
static void mmi_email_acct_folder_hide_mark(void);
static void mmi_email_acct_folder_hide_retrieve(void);
static mmi_ret mmi_email_acct_folder_options_handler(mmi_menu_id menu_id, EMAIL_MSG_ID msg_id);

static void mmi_email_acct_folder_read_handler(EMAIL_MSG_ID msg_id);

static void mmi_email_folder_delete_msg_check(BOOL marked);
static void mmi_email_acct_folder_delete_msg(void);
static void mmi_email_acct_folder_move_to_drafts(EMAIL_MSG_ID msg_id, EMAIL_ACCT_ID acct_id, EMAIL_FLDR_ID fldr_id);
static void mmi_email_acct_folder_mark_unread_msg(BOOL marked, EMAIL_MSG_ID msg_id);
static void mmi_email_acct_folder_mark_msg(EMAIL_MSG_ID msg_id, BOOL mark, BOOL mark_all);

static mmi_ret mmi_email_acct_folder_mark_several_proc(mmi_event_struct *evt);
static void mmi_email_acct_folder_mark_several(void);
static void mmi_email_acct_folder_mark_several_screen_enter(void);
static void mmi_email_acct_folder_mark_several_lsk(void);
static void mmi_email_acct_folder_mark_several_csk(void);
static void mmi_email_acct_folder_mark_several_rsk(void);
static S32 mmi_email_acct_folder_get_check_state(S32 item_index, PU8 *checkbox_image);
static void mmi_email_acct_folder_mark_option_hide(mmi_id menu_grp_id);
static void mmi_email_acct_folder_mark_option_action(mmi_id menu_id);
static void mmi_email_acct_folder_mark_several_hilight(S32 index);
static BOOL mmi_email_acct_folder_mark_is_marked(S32 idx, EMAIL_MSG_ID *msg_id);

#ifdef __MMI_TOUCH_SCREEN__
static void mmi_email_acct_folder_mark_several_pen_down(void);
#endif /* __MMI_TOUCH_SCREEN__ */

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_acct_folder_mark_several_tap_callback(mmi_tap_type_enum tap_type, S32 index);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

static S32 mmi_email_acct_folder_mark_several_click(S32 item_index);
static void mmi_email_acct_folder_mark_several_change_state(void);

static void mmi_email_acct_folder_sort_msg(
                EMAIL_MSG_ID msg_id,
                srv_email_fldr_sort_msg_mode_enum sort_mode);
static void mmi_email_entry_folder_opt_loading(void);
static void mmi_email_acct_folder_rsk(void);
static S32 mmi_email_acct_folder_get_items(S32 start_indx, gui_iconlist_menu_item *menuData, S32 num_item);

static void mmi_email_fldr_set_flag_after_read(void);
static void mmi_email_folder_notify_callback(srv_email_om_notify_struct *notify_data, void *user_data);

static void mmi_email_refresh_mark_screen(void);

/************************************************************************/
/*                           Implements                                 */
/************************************************************************/

void mmi_email_reset_curr_fldr_info(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_RESET_CURR_FLDR_INFO, __LINE__);

    if (email_fldr_select_acct_grp_id)
    {
        mmi_frm_group_close(email_fldr_select_acct_grp_id);
        email_fldr_select_acct_grp_id = 0;
    }
    mmi_email_exit_save_send();
    if (email_app_acct_fldr_data.grp_id)
    {
        mmi_frm_group_close(email_app_acct_fldr_data.grp_id);
        email_app_acct_fldr_data.grp_id = 0;
    }
}


void mmi_email_app_entry_inbox_switch_stor_callback(BOOL result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_ENTRY_INBOX_SWITCH_STOR_CALLBACK, result);

    if (result)
    {
        mmi_email_app_entry_inbox();
    }
    else
    {
        mmi_email_lib_error_popup(STR_GLOBAL_CURRENTLY_NOT_AVAILABLE);
    }
}


void mmi_email_app_entry_inbox(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    CHAR drive = srv_email_get_drive();
    U32 count = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_ENTRY_INBOX, 1);
    if (!mmi_email_smgr_show_ui_check(NULL))
    {
        return;
    }

    srv_email_acct_get_num(&count);
    if (count == 0)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_ENTRY_INBOX, 8);
        mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_ACCT_NOT_CONFIG_ID);
        return;
    }
    //mmi_email_stop_receiving_email();
    mmi_email_reset_curr_fldr_info();
    email_app_fldr_mem_ptr = mmi_email_app_mem_pool_malloc(MMI_EMAIL_MEM_POOL_SIZE);
    if (email_app_fldr_mem_ptr == NULL)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_ENTRY_INBOX, 9);
        mmi_frm_appmem_prompt_to_release_mem(
            APPLIB_MEM_AP_ID_EMAIL,
            0,
            MMI_EMAIL_MEM_POOL_SIZE,
            mmi_email_app_entry_inbox);
        return;
    }
    srv_email_set_mem_func(
        0,
        mmi_email_app_mem_malloc,
        mmi_email_app_mem_free);
    memset(&email_app_acct_fldr_data, 0, sizeof(email_app_acct_fldr_data));
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_ENTRY_INBOX, 10);
    email_fldr_select_acct_grp_id = mmi_frm_group_create(
        GRP_ID_ROOT,
        GRP_ID_AUTO_GEN,
        mmi_email_fldr_acct_select_group_proc,
        NULL);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_ENTRY_INBOX, 11);
    mmi_frm_group_enter(email_fldr_select_acct_grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_ENTRY_INBOX, 12);
    mmi_email_fldr_entry_acct_select();
}


void mmi_email_app_entry_inbox_by_acct(EMAIL_ACCT_ID acct_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_ENTRY_INBOX_BY_ACCT, acct_id);
    email_app_entry_fldr_acct_id = acct_id;
    mmi_email_app_entry_inbox_by_acct_ext();
}


void mmi_email_app_entry_inbox_by_acct_ext(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    EMAIL_FLDR_ID fldr_id = 0;
    S32 fldr_type = SRV_EMAIL_FLDR_TYPE_INBOX;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    CHAR drive = srv_email_get_drive();

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_APP_ENTRY_INBOX_BY_ACCT_EXT, __LINE__);
    if (!mmi_email_smgr_show_ui_check(NULL))
    {
        return;
    }

    mmi_email_reset_curr_fldr_info();
    email_app_fldr_mem_ptr = mmi_email_app_mem_pool_malloc(MMI_EMAIL_MEM_POOL_SIZE);
    if (email_app_fldr_mem_ptr == NULL)
    {
        mmi_frm_appmem_prompt_to_release_mem(
            APPLIB_MEM_AP_ID_EMAIL,
            0,
            MMI_EMAIL_MEM_POOL_SIZE,
            mmi_email_app_entry_inbox_by_acct_ext);
        return;
    }
    srv_email_set_mem_func(
        0,
        mmi_email_app_mem_malloc,
        mmi_email_app_mem_free);
    result = mmi_email_util_get_fldr_id_by_acct(
        email_app_entry_fldr_acct_id,
        1,
        &fldr_type,
        &fldr_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(GRP_ID_ROOT, result);
        return;
    }
    mmi_email_pre_entry_folder(
        GRP_ID_ROOT,
        email_app_entry_fldr_acct_id,
        fldr_id,
        SRV_EMAIL_FLDR_TYPE_INBOX,
        TRUE);
}


static mmi_ret mmi_email_fldr_acct_select_group_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_FLDR_ACCT_SELECT_GROUP_PROC, evt->evt_id);
    switch (evt->evt_id)
    {
        case EVT_ID_GROUP_FOCUSED:
            mmi_email_set_active_group_id(email_fldr_select_acct_grp_id);
            break;
        case EVT_ID_GROUP_DEINIT:
            break;
        default:
            break;
    }
    return MMI_RET_OK;
}


static void mmi_email_fldr_entry_acct_select(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 i = 0;
    U8 *nStrItemList[MMI_EMAIL_MAX_ACCTS];
    U32 count = 0;
    U8 *gui_buffer;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    srv_email_acct_info_cache_struct *cache_info = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_FLDR_ENTRY_ACCT_SELECT, 1);
    if (!mmi_frm_scrn_enter(
            email_fldr_select_acct_grp_id,
            SCR_ID_EMAIL_FOLDER_ACCT_SELECT,
            NULL,
            mmi_email_fldr_entry_acct_select,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_FLDR_ENTRY_ACCT_SELECT, 2);
        return;
    }
    gui_buffer = mmi_frm_scrn_get_active_gui_buf();
    email_fldr_selected_index = 0;
    srv_email_acct_get_num(&count);
    if (count == 0)
    {
        mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_ACCT_NOT_CONFIG_ID);
        if (email_app_fldr_mem_ptr)
        {
            mmi_email_app_mem_pool_free(email_app_fldr_mem_ptr);
            email_app_fldr_mem_ptr = NULL;
        }
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_FLDR_ENTRY_ACCT_SELECT, 3);
        mmi_frm_group_close(email_fldr_select_acct_grp_id);
        return;
    }
    result = srv_email_acct_get_acct_id(0, (S32*)(&count), email_fldr_acct_id_array);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(0, result);
        if (email_app_fldr_mem_ptr)
        {
            mmi_email_app_mem_pool_free(email_app_fldr_mem_ptr);
            email_app_fldr_mem_ptr = NULL;
        }
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_FLDR_ENTRY_ACCT_SELECT, 4);
        mmi_frm_group_close(email_fldr_select_acct_grp_id);
        return;
    }
    memset(email_fldr_acct_name, 0, sizeof(email_fldr_acct_name));
    cache_info = OslMalloc(sizeof(srv_email_acct_info_cache_struct));
    for (; i < count; i++)
    {
        srv_email_acct_cache_get(email_fldr_acct_id_array[i], cache_info);
        mmi_wcscpy(email_fldr_acct_name[i], cache_info->acct_name);
        nStrItemList[i] = (U8*)email_fldr_acct_name[i];
    }
    OslMfree(cache_info);
    RegisterHighlightHandler(mmi_email_fldr_hilit_acct_handler);
    EnableCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    ShowCategory53Screen(
        STR_EMAIL_EMAIL_ACCTS_ID,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        count,
        nStrItemList,
        (U16*)gIndexIconsImageList,
        NULL,
        0,
        (S32)email_fldr_selected_index,
        gui_buffer);
    SetLeftSoftkeyFunction(mmi_email_fldr_acct_select_lsk, KEY_EVENT_UP);
    SetRightSoftkeyFunction(mmi_emaiL_fldr_acct_select_rsk, KEY_EVENT_UP);
    SetCenterSoftkeyFunction(mmi_email_fldr_acct_select_lsk, KEY_EVENT_UP);
    mmi_frm_scrn_set_leave_proc(
        email_fldr_select_acct_grp_id,
        SCR_ID_EMAIL_FOLDER_ACCT_SELECT,
        mmi_email_fldr_entry_acct_select_del_callback);
}


static mmi_ret mmi_email_fldr_entry_acct_select_del_callback(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (evt->evt_id)
    {
        case EVT_ID_SCRN_GOBACK_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ:
            if (email_app_fldr_mem_ptr)
            {
                mmi_email_app_mem_pool_free(email_app_fldr_mem_ptr);
                email_app_fldr_mem_ptr = NULL;
            }
            break;
    }
    return MMI_RET_OK;
}


static void mmi_email_fldr_hilit_acct_handler(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    email_fldr_selected_index = (U8)index;
}


static void mmi_email_fldr_acct_select_lsk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    EMAIL_FLDR_ID fldr_id = 0;
    S32 fldr_type = SRV_EMAIL_FLDR_TYPE_INBOX;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_FLDR_ACCT_SELECT_LSK, __LINE__);

    result = mmi_email_util_get_fldr_id_by_acct(
                email_fldr_acct_id_array[email_fldr_selected_index],
                1,
                &fldr_type,
                &fldr_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(GRP_ID_ROOT, result);
        if (email_app_fldr_mem_ptr)
        {
            mmi_email_app_mem_pool_free(email_app_fldr_mem_ptr);
            email_app_fldr_mem_ptr = NULL;
        }
        mmi_frm_group_close(email_fldr_select_acct_grp_id);
        email_fldr_select_acct_grp_id = 0;
        return;
    }
    mmi_email_pre_entry_folder(
        GRP_ID_ROOT,
        email_fldr_acct_id_array[email_fldr_selected_index],
        fldr_id,
        SRV_EMAIL_FLDR_TYPE_INBOX,
        TRUE);
    mmi_frm_group_close(email_fldr_select_acct_grp_id);
    email_fldr_select_acct_grp_id = 0;
}


static void mmi_emaiL_fldr_acct_select_rsk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_FLDR_ACCT_SELECT_RSK, __LINE__);

    if (email_app_fldr_mem_ptr)
    {
        mmi_email_app_mem_pool_free(email_app_fldr_mem_ptr);
        email_app_fldr_mem_ptr = NULL;
    }
    mmi_frm_scrn_set_leave_proc(
        email_fldr_select_acct_grp_id,
        SCR_ID_EMAIL_FOLDER_ACCT_SELECT,
        NULL);
    mmi_frm_scrn_close_active_id();
}


void mmi_email_pre_entry_folder(
        mmi_id parent_id,
        EMAIL_ACCT_ID acct_id,
        EMAIL_FLDR_ID folder_id,
        srv_email_fldr_type_enum folder_type,
        BOOL outside)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_FOLDER, 1);

    mmi_email_reset_curr_fldr_info();
    memset(&email_app_acct_fldr_data, 0, sizeof(email_app_acct_fldr_data));
    email_app_acct_fldr_data.folder_info.fldr_id = folder_id;
    email_app_acct_fldr_data.folder_info.acct_id = acct_id;
    email_app_acct_fldr_data.fldr_type = folder_type;
    email_app_acct_fldr_data.folder_info.sort_mode = SRV_EMAIL_FLDR_SORT_MSG_MODE_TIME;
    email_app_acct_fldr_data.folder_info.sort_order = MMI_FALSE;
    email_app_acct_fldr_data.folder_info.list_field = 0;
    email_app_acct_fldr_data.is_inbox = ((folder_type == SRV_EMAIL_FLDR_TYPE_INBOX) ? TRUE : FALSE);
    result = srv_email_fldr_create(
                0,
                &email_app_acct_fldr_data.folder_info,
                &email_app_acct_fldr_data.fldr_handle);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        if (email_app_fldr_mem_ptr)
        {
            mmi_email_app_mem_pool_free(email_app_fldr_mem_ptr);
            email_app_fldr_mem_ptr = NULL;
        }
        return;
    }
    srv_email_fldr_get_msg_num(
        email_app_acct_fldr_data.fldr_handle,
        SRV_EMAIL_FLDR_MSG,
        &email_app_acct_fldr_data.count);
    if (!email_app_acct_fldr_data.count)
    {
        mmi_email_lib_error_popup(STR_GLOBAL_EMPTY);
        srv_email_fldr_destroy(email_app_acct_fldr_data.fldr_handle);
        if (email_app_fldr_mem_ptr)
        {
            mmi_email_app_mem_pool_free(email_app_fldr_mem_ptr);
            email_app_fldr_mem_ptr = NULL;
        }
        return;
    }

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_FOLDER, 2);
    email_app_acct_fldr_data.grp_id = mmi_frm_group_create(
                                        parent_id,
                                        GRP_ID_AUTO_GEN, 
                                        mmi_email_folder_main_group_proc,
                                        (void*)(&email_app_acct_fldr_data));
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_FOLDER, 3);
    mmi_frm_group_enter(email_app_acct_fldr_data.grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);

    email_app_acct_fldr_data.outside = outside;
    if (email_app_acct_fldr_data.outside)
    {
        mmi_email_app_nwk_user_enter(acct_id);
    }
#ifdef __MMI_NCENTER_SUPPORT__
    else
    {
        mmi_email_batch_receive_remove(acct_id);
    }
#endif /* __MMI_NCENTER_SUPPORT__ */

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_FOLDER, 4);
    mmi_frm_display_dummy_screen();
    srv_email_fldr_regist_callback(email_app_acct_fldr_data.fldr_handle, mmi_email_folder_general_callback, NULL);
    srv_email_fldr_regist_notify(email_app_acct_fldr_data.fldr_handle, mmi_email_folder_notify_callback, NULL);
    result = srv_email_fldr_list_msg(
                email_app_acct_fldr_data.fldr_handle,
                SRV_EMAIL_MSG_TEXT_SUBJ,
                SRV_EMAIL_MSG_CREATED_DATE,
                &email_app_acct_fldr_data.req_id);
    if (result == SRV_EMAIL_RESULT_WOULDBLOCK)
    {
        mmi_email_entry_folder_loading();
        email_app_acct_fldr_opt = MMI_EMAIL_FOLDER_OPT_LIST;
        return;
    }

    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_acct_fldr_data.grp_id, result);
        srv_email_fldr_destroy(email_app_acct_fldr_data.fldr_handle);
        if (email_app_fldr_mem_ptr)
        {
            mmi_email_app_mem_pool_free(email_app_fldr_mem_ptr);
            email_app_fldr_mem_ptr = NULL;
        }
        return;
    }

    mmi_email_entry_folder();
}


static mmi_ret mmi_email_folder_main_group_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_FOLDER_MAIN_GROUP_PROC, evt->evt_id);
    switch(evt->evt_id)
    {
        case EVT_ID_GROUP_INACTIVE:
            break;

        case EVT_ID_GROUP_FOCUSED:
            mmi_email_set_active_group_id(email_app_acct_fldr_data.grp_id);
            if (email_app_acct_fldr_data.need_fresh_list 
                &&(mmi_frm_scrn_get_active_id() == SCR_ID_EMAIL_FOLDER))
            {
                mmi_email_dummy_refresh(NULL);
                email_app_acct_fldr_data.need_fresh_list = FALSE;
            }
            break;

        case EVT_ID_GROUP_DEINIT:
            srv_email_fldr_clear_callback(email_app_acct_fldr_data.fldr_handle);
            srv_email_fldr_destroy(email_app_acct_fldr_data.fldr_handle);
            email_app_acct_fldr_data.grp_id = 0;
            if (email_app_fldr_mem_ptr)
            {
                mmi_email_app_mem_pool_free(email_app_fldr_mem_ptr);
                email_app_fldr_mem_ptr = NULL;
            }

            if (email_app_acct_fldr_data.outside)
            {
                mmi_email_app_nwk_user_leave();
            }
            break;

        default:
            break;
    }

    return MMI_RET_OK;
}


void mmi_email_entry_folder_loading(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_FOLDER_LOADING, 1);
    if (!mmi_frm_scrn_enter(
            email_app_acct_fldr_data.grp_id,
            SCR_EMAIL_LOADING_ID,
            NULL,
            mmi_email_entry_folder_loading,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_FOLDER_LOADING, 2);
        return;
    }
    ShowCategory66Screen(
        STR_GLOBAL_EMAIL,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        0,
        0,
        STR_GLOBAL_CANCEL,
        IMG_GLOBAL_BACK,
        (U8*)GetString(STR_GLOBAL_LOADING),
        mmi_email_lib_get_progress_img_id(),
        NULL);
    SetLeftSoftkeyFunction(NULL, KEY_EVENT_UP);
    SetRightSoftkeyFunction(mmi_email_folder_general_cancel, KEY_EVENT_UP);
}


static void mmi_email_folder_general_cancel(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_FOLDER_GENERAL_CANCEL, __LINE__);

    if (srv_email_fldr_abort(
            email_app_acct_fldr_data.fldr_handle,
            email_app_acct_fldr_data.req_id) == SRV_EMAIL_RESULT_SUCC)
    {
        if (email_app_acct_fldr_opt == MMI_EMAIL_FOLDER_OPT_LIST)
        {
            mmi_frm_group_close(email_app_acct_fldr_data.grp_id);
        }
        else
        {
            mmi_frm_scrn_close(email_app_acct_fldr_data.grp_id, email_app_acct_fldr_data.loading_scr_id);
        }
    }
}


void mmi_email_folder_general_callback(srv_email_result_struct *result, EMAIL_REQ_ID req_id, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_FOLDER_GENERAL_CALLBACK, __LINE__);

    if (req_id == email_app_acct_fldr_data.req_id)
    {
        if (!result->result)
        {
            mmi_email_util_display_popup(
                email_app_acct_fldr_data.parent_grp_id,
                GetString(mmi_email_util_get_err_code(result->major, result->minor)),
                MMI_EVENT_FAILURE);
            srv_email_fldr_destroy(email_app_acct_fldr_data.fldr_handle);
            mmi_frm_group_close(email_app_acct_fldr_data.grp_id);
            return;
        }

        if (email_app_acct_fldr_opt == MMI_EMAIL_FOLDER_OPT_LIST)
        {
            mmi_email_entry_folder();
            mmi_frm_scrn_close(email_app_acct_fldr_data.grp_id, SCR_EMAIL_LOADING_ID);
        }

        if (email_app_acct_fldr_opt == MMI_EMAIL_FOLDER_OPT_DEL)
        {
            mmi_frm_scrn_close(email_app_acct_fldr_data.grp_id, SCR_EMAIL_LOADING_ID);
        }

        if (email_app_acct_fldr_opt == MMI_EMAIL_FOLDER_OPT_SORT)
        {
            email_app_acct_fldr_data.need_reset = TRUE;
            email_app_acct_fldr_data.hilight = email_app_sort_info.msg_index;

            mmi_email_app_nwk_freeze(0, FALSE);
        }

        if ((email_app_acct_fldr_opt == MMI_EMAIL_FOLDER_OPT_SET_STATE) ||
            (email_app_acct_fldr_opt == MMI_EMAIL_FOLDER_OPT_SORT))
        {
            email_app_acct_fldr_data.folder_info.sort_mode = email_app_sort_info.sort_mode;
            email_app_acct_fldr_data.folder_info.sort_order = email_app_sort_info.sort_order;
            mmi_frm_scrn_close(email_app_acct_fldr_data.grp_id, email_app_acct_fldr_data.loading_scr_id);
        }
    }
    email_app_acct_fldr_opt = MMI_EMAIL_FOLDER_OPT_NONE;
    email_app_acct_fldr_data.loading_scr_id = 0;
    email_app_acct_fldr_data.req_id = 0;
}


void mmi_email_folder_notify_callback(srv_email_om_notify_struct *notify_data, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_om_notify_msg_struct *msg_notify_info = NULL;


    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    msg_notify_info = (srv_email_om_notify_msg_struct*)notify_data->data;

    if (notify_data->notify_type == SRV_EMAIL_OM_NOTIFY_MSG_DEL
        && msg_notify_info->msg_id == email_app_acct_fldr_data.curr_msg_id)
    {
        // Close option MENU if
        if (email_app_acct_fldr_data.option_menu_id != 0)
        {
            cui_menu_close(email_app_acct_fldr_data.option_menu_id);
        }
        email_app_acct_fldr_data.curr_msg_id = 0;
    }
}

static void refresh_folder_worker(void)
{
    if(mmi_frm_scrn_get_active_id() != SCR_ID_EMAIL_FOLDER)
    {
        email_app_acct_fldr_data.need_fresh_list = TRUE;
        return;
    }

    email_app_acct_fldr_data.count = 0;
    srv_email_fldr_get_msg_num(
        email_app_acct_fldr_data.fldr_handle,
        SRV_EMAIL_FLDR_MSG,
        &email_app_acct_fldr_data.count);
    if (email_app_acct_fldr_data.count == 0)
    {
        mmi_frm_scrn_close(email_app_acct_fldr_data.grp_id, SCR_ID_EMAIL_FOLDER);
        return;
    }

    if (email_app_acct_fldr_data.hilight >= email_app_acct_fldr_data.count)
    {
        email_app_acct_fldr_data.hilight = email_app_acct_fldr_data.count - 1;
    }

    // Refresh
    mmi_cat_refresh_asyncdynamic_list(
        email_app_acct_fldr_data.count,
        (S32)email_app_acct_fldr_data.hilight,
        mmi_email_acct_folder_get_items,
        NULL);
}


void mmi_email_ui_refresh_folder(EMAIL_ACCT_ID acc_id, EMAIL_FLDR_ID fld_id)
{
    if (acc_id != email_app_acct_fldr_data.folder_info.acct_id)
    {
        return;
    }

    if (fld_id == 0)
    {
        if (email_app_acct_fldr_data.fldr_type != SRV_EMAIL_FLDR_TYPE_OUTBOX)
        {
            return;
        }
    }
    else
    {
        if (fld_id != email_app_acct_fldr_data.folder_info.fldr_id)
        {
            return;
        }
    }

    if(mmi_frm_scrn_get_active_id() != SCR_ID_EMAIL_FOLDER)
    {
        email_app_acct_fldr_data.need_fresh_list = TRUE;
        return;
    }

    mmi_email_dummy_refresh(refresh_folder_worker);
}


void mmi_email_entry_folder(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *gui_buffer;
    S32 list_not_ready;
    U8 *title_string = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_FOLDER, 1);
    if (!mmi_frm_scrn_enter(
            email_app_acct_fldr_data.grp_id,
            SCR_ID_EMAIL_FOLDER,
            NULL,
            mmi_email_entry_folder,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_FOLDER, 2);
        return;
    }
    srv_email_fldr_get_msg_num(
        email_app_acct_fldr_data.fldr_handle,
        SRV_EMAIL_FLDR_MSG,
        &email_app_acct_fldr_data.count);
    if (!email_app_acct_fldr_data.count)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_FOLDER, 3);
        mmi_frm_scrn_close(email_app_acct_fldr_data.grp_id, SCR_ID_EMAIL_FOLDER);
        return;
    }
    if (email_app_acct_fldr_data.need_reset)
    {
        gui_buffer = NULL;
        email_app_acct_fldr_data.need_reset = MMI_FALSE;
    }
    else
    {
        gui_buffer = mmi_frm_scrn_get_active_gui_buf();
    }
    switch (email_app_acct_fldr_data.fldr_type)
    {
        case SRV_EMAIL_FLDR_TYPE_INBOX:
            title_string = (U8*)GetString(STR_GLOBAL_INBOX);
            break;
        case SRV_EMAIL_FLDR_TYPE_OUTBOX:
            title_string = (U8*)GetString(STR_GLOBAL_OUTBOX);
            break;
        case SRV_EMAIL_FLDR_TYPE_SENT:
            title_string = (U8*)GetString(STR_EMAIL_SENT_ID);
            break;
        case SRV_EMAIL_FLDR_TYPE_DRAFT:
            title_string = (U8*)GetString(STR_GLOBAL_DRAFTS);
            break;
        case SRV_EMAIL_FLDR_TYPE_REMOTE:
#ifdef __MMI_EMAIL_REMOTE_FOLDER__
            title_string = (U8*)mmi_email_remote_get_curr_folder_name();
#endif
            break;
    }
    RegisterHighlightHandler(mmi_email_hilite_acct_folder_item);
    EnableCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    wgui_cat263_set_display_style(MMI_CAT263_DISPLAY_ALL);
    ShowCategory263Screen(
        title_string,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        STR_GLOBAL_OPTIONS,
        IMG_GLOBAL_OPTIONS,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        email_app_acct_fldr_data.count,
        mmi_email_acct_folder_get_items,
        NULL,
        (S32)email_app_acct_fldr_data.hilight,
        IMG_EMAIL_READ_NORMAL_ID,
        gui_buffer,
        &list_not_ready);
    if (list_not_ready)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_FOLDER, 4);
        mmi_frm_group_close(email_app_acct_fldr_data.grp_id);
        return;
    }
    SetCenterSoftkeyFunction(mmi_email_acct_folder_csk, KEY_EVENT_UP);
    SetLeftSoftkeyFunction(mmi_email_acct_folder_lsk, KEY_EVENT_UP);
    SetRightSoftkeyFunction(mmi_email_acct_folder_rsk, KEY_EVENT_UP);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
    wgui_register_tap_callback(mmi_email_acct_folder_tap_callback);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */
}


#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_acct_folder_tap_callback(mmi_tap_type_enum tap_type, S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_TAP_CALLBACK, __LINE__);

    email_app_acct_fldr_data.hilight = index;
    if (tap_type == ENUM_TAP_ON_HIGHLIGHTED_ITEM)
    {
        mmi_email_acct_folder_csk();
    }
}
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */


void mmi_email_hilite_acct_folder_item(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    email_app_acct_fldr_data.hilight = index;
}


void mmi_email_acct_folder_csk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 get_count = 1;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    srv_email_fldr_msg_info_struct *msg_info = NULL;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_CSK, 1);

    msg_info = OslMalloc(sizeof(srv_email_fldr_msg_info_struct));
    result = srv_email_fldr_get_msg_list(
        email_app_acct_fldr_data.fldr_handle,
        (U32)email_app_acct_fldr_data.hilight,
        &get_count,
        msg_info);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_CSK, 2);

        mmi_email_util_display_error_popup(email_app_acct_fldr_data.grp_id, result);
        OslMfree(msg_info);
        return;
    }
    email_app_acct_fldr_data.curr_msg_id = msg_info->msg_id;
    OslMfree(msg_info);
    if (!mmi_email_check_msg_valid(email_app_acct_fldr_data.curr_msg_id))
    {
        srv_email_fldr_delete_msg_struct delete_info;

        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_CSK, 3);

        delete_info.delete_all = MMI_FALSE;
        delete_info.delete_all_marked = MMI_FALSE;
        delete_info.delete_header = MMI_FALSE;
        delete_info.delete_server = MMI_TRUE;
        delete_info.msg_id = email_app_acct_fldr_data.curr_msg_id;
        if (email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_DRAFT ||
            email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_OUTBOX ||
            email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_SENT)
        {
            delete_info.delete_header = MMI_TRUE;
        }
        mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID);
        srv_email_fldr_delete_msg(
            email_app_acct_fldr_data.fldr_handle,
            &delete_info,
            &email_app_acct_fldr_data.req_id);
        return;
    }

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_CSK, 4);
    mmi_email_acct_folder_read_handler(email_app_acct_fldr_data.curr_msg_id);
}


void mmi_email_acct_folder_rsk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_RSK, email_app_acct_fldr_data.grp_id);
    mmi_frm_group_close(email_app_acct_fldr_data.grp_id);
}


void mmi_email_acct_folder_lsk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 get_count = 1;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    srv_email_fldr_msg_info_struct *msg_info = NULL;
    mmi_id grp_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_LSK, 1);

    msg_info = OslMalloc(sizeof(srv_email_fldr_msg_info_struct));
    result = srv_email_fldr_get_msg_list(
                email_app_acct_fldr_data.fldr_handle,
                (U32)email_app_acct_fldr_data.hilight,
                &get_count,
                msg_info);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_acct_fldr_data.grp_id, result);
            OslMfree(msg_info);
        return;
    }
    email_app_acct_fldr_data.curr_msg_id = msg_info->msg_id;
    OslMfree(msg_info);
    if (!mmi_email_check_msg_valid(email_app_acct_fldr_data.curr_msg_id))
    {
        srv_email_fldr_delete_msg_struct delete_info;
        delete_info.delete_all = MMI_FALSE;
        delete_info.delete_all_marked = MMI_FALSE;
        delete_info.delete_header = MMI_FALSE;
        delete_info.delete_server = MMI_TRUE;
        delete_info.msg_id = email_app_acct_fldr_data.curr_msg_id;
        if (email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_DRAFT ||
            email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_OUTBOX ||
            email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_SENT)
        {
            delete_info.delete_header = MMI_TRUE;
        }
        mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID);
        srv_email_fldr_delete_msg(
            email_app_acct_fldr_data.fldr_handle,
            &delete_info,
            &email_app_acct_fldr_data.req_id);
        return;
    }

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_LSK, 2);
    grp_id = mmi_frm_group_create(
        email_app_acct_fldr_data.grp_id,
        GRP_ID_AUTO_GEN,
        mmi_email_acct_folder_opt_proc,
        NULL);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_LSK, 3);
    mmi_frm_group_enter(grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_LSK, 4);
    mmi_frm_display_dummy_screen();

    email_app_acct_fldr_data.option_menu_id = cui_menu_create(
                                                grp_id,
                                                CUI_MENU_SRC_TYPE_RESOURCE,
                                                CUI_MENU_TYPE_OPTION,
                                                MENU_ID_EMAIL_FOLDER_OPT,
                                                MMI_FALSE,
                                                (void*)(&email_app_acct_fldr_data));
    cui_menu_set_default_title(email_app_acct_fldr_data.option_menu_id, NULL, get_image(GetRootTitleIcon(MENU_ID_EMAIL_MAIN)));
    cui_menu_run(email_app_acct_fldr_data.option_menu_id);
}


static mmi_ret mmi_email_acct_folder_opt_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)evt;
    EMAIL_MSG_ID msg_id = email_app_acct_fldr_data.curr_msg_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_OPT_PROC, menu_evt->evt_id);
    switch (menu_evt->evt_id)
    {
        case EVT_ID_GROUP_DEINIT:
            email_app_acct_fldr_data.option_menu_id = 0;
            break;

        case EVT_ID_CUI_MENU_LIST_ENTRY:
            mmi_email_acct_folder_hide_menu_items(msg_id);
            break;

        case EVT_ID_CUI_MENU_ITEM_SELECT:
            if (mmi_email_acct_folder_options_handler(menu_evt->highlighted_menu_id, msg_id) == MMI_RET_OK)
            {
                cui_menu_close(menu_evt->sender_id);
            }
            break;

        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
            cui_menu_close(menu_evt->sender_id);
            break;
    }

    return MMI_RET_OK;
}


void mmi_email_acct_folder_hide_menu_items(EMAIL_MSG_ID msg_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_INBOX)
    {
        mmi_email_acct_folder_hide_reply(msg_id);
        mmi_email_acct_folder_hide_retrieve();
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_EDIT, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_FORWARD, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_MOVE_TO_DRAFTS, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_SEND_ALL_START, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_SEND_ALL_STOP, MMI_TRUE);
        mmi_email_acct_folder_hide_mark();
    }
    else if (email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_DRAFT)
    {
        mmi_email_acct_folder_hide_retrieve();
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_REPLY, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_EDIT, MMI_FALSE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_FORWARD, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_MOVE_TO_DRAFTS, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_SEND_ALL_START, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_SEND_ALL_STOP, MMI_TRUE);
        mmi_email_acct_folder_hide_mark();
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_MARK_UNREAD, MMI_TRUE);
    }
    else if (email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_SENT)
    {
        mmi_email_acct_folder_hide_retrieve();
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_REPLY, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_EDIT, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_FORWARD, MMI_FALSE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_MOVE_TO_DRAFTS, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_SEND_ALL_START, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_SEND_ALL_STOP, MMI_TRUE);
        mmi_email_acct_folder_hide_mark();
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_MARK_UNREAD, MMI_TRUE);
    }
    else if (email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_OUTBOX)
    {
        mmi_email_acct_folder_hide_retrieve();
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_REPLY, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_EDIT, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_FORWARD, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_MOVE_TO_DRAFTS, MMI_FALSE);
        if (mmi_email_app_nwk_is_sending(email_app_acct_fldr_data.folder_info.acct_id))
        {
            cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_SEND_ALL_START, MMI_TRUE);
            cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_SEND_ALL_STOP, MMI_FALSE);
        }
        else
        {
            cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_SEND_ALL_START, MMI_FALSE);
            cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_SEND_ALL_STOP, MMI_TRUE);
        }
        mmi_email_acct_folder_hide_mark();
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_MARK_UNREAD, MMI_TRUE);
    }
    else
    {
        mmi_email_acct_folder_hide_retrieve();
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_REPLY, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_EDIT, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_FORWARD, MMI_FALSE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_MOVE_TO_DRAFTS, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_SEND_ALL_START, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_SEND_ALL_STOP, MMI_TRUE);
        mmi_email_acct_folder_hide_mark();
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_MARK_UNREAD, MMI_TRUE);
    }
}


void mmi_email_acct_folder_hide_reply(EMAIL_MSG_ID msg_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    EMAIL_MSG_HANDLE msg_handle = 0;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    srv_email_addr_struct *addr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    srv_email_msg_create(0, &msg_handle);
    result = srv_email_msg_open(
                msg_handle,
                email_app_acct_fldr_data.folder_info.acct_id,
                email_app_acct_fldr_data.folder_info.fldr_id,
                msg_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        srv_email_msg_destroy(msg_handle);
        return;
    }
    addr = OslMalloc(sizeof(srv_email_addr_struct));
    result = srv_email_msg_get_sender(msg_handle, addr);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        srv_email_msg_destroy(msg_handle);
        OslMfree(addr);
        return;
    }
    if (!mmi_wcslen(addr->email_addr))
    {
        memset(addr, 0, sizeof(srv_email_addr_struct));
        result = srv_email_msg_get_reply_to(msg_handle, addr);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            srv_email_msg_destroy(msg_handle);
            OslMfree(addr);
            return;
        }
        if (!mmi_wcslen(addr->email_addr))
        {
            cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_REPLY, MMI_TRUE);
        }
        else
        {
            cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_REPLY, MMI_FALSE);
        }
    }
    else
    {
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_REPLY, MMI_FALSE);
    }
    srv_email_msg_destroy(msg_handle);
    OslMfree(addr);
}


void mmi_email_acct_folder_hide_mark(void)
{
    if (email_app_acct_fldr_data.count > 1)
    {
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_MARK_SEVERAL, MMI_FALSE);
    }
    else
    {
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_MARK_SEVERAL, MMI_TRUE);
    }
}


void mmi_email_acct_folder_hide_retrieve(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    U32 count = 1;
    srv_email_fldr_msg_info_struct data;
    srv_email_acct_info_cache_struct *cache_info = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_DRAFT 
        || email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_OUTBOX
        || email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_SENT))
    {
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_REFRESH_START, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_REFRESH_STOP, MMI_TRUE);
    }
    else if (mmi_email_app_nwk_is_refreshing(email_app_acct_fldr_data.folder_info.acct_id))
    {
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_REFRESH_START, MMI_TRUE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_REFRESH_STOP, MMI_FALSE);
    }
    else
    {
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_REFRESH_START, MMI_FALSE);
        cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_REFRESH_STOP, MMI_TRUE);
    }

    cache_info = OslMalloc(sizeof(srv_email_acct_info_cache_struct));
    srv_email_acct_cache_get(email_app_acct_fldr_data.folder_info.acct_id, cache_info);
    memset(&data, 0, sizeof(srv_email_fldr_msg_info_struct));
    result = srv_email_fldr_get_msg_list(
        email_app_acct_fldr_data.fldr_handle,
        email_app_acct_fldr_data.hilight,
        &count,
        &data);
    if (result == SRV_EMAIL_RESULT_SUCC)
    {
        if (data.flag & EMAIL_MSG_FLAG_SEEN)
        {
            cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_MARK_UNREAD, MMI_FALSE);
        }
        else
        {
            cui_menu_set_item_hidden(email_app_acct_fldr_data.option_menu_id, MENU_ID_EMAIL_MARK_UNREAD, MMI_TRUE);
        }
    }
    OslMfree(cache_info);
}

static mmi_ret mmi_email_acct_folder_options_handler(mmi_menu_id menu_id, EMAIL_MSG_ID msg_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_prepare_comp_struct *comp_data;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (menu_id)
    {
        case MENU_ID_EMAIL_READ_EMAIL:
            mmi_email_acct_folder_read_handler(msg_id);
            break;

        case MENU_ID_EMAIL_WRITE_EMAIL:
                comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));
                memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
                comp_data->acct_id = email_app_acct_fldr_data.folder_info.acct_id;
                comp_data->fldr_id = 0;
                comp_data->msg_id = 0;
                comp_data->parent_id = email_app_acct_fldr_data.grp_id;
                comp_data->type = EMAIL_PRE_COMP_TYPE_NEW;
                mmi_email_reset_curr_comp_info();
                mmi_email_prepare_entry_comp(comp_data);
                OslMfree(comp_data);
            break;

        case MENU_ID_EMAIL_REPLY:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_AUTOTEST_REPLY_START);
                comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));
                memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
                comp_data->acct_id = email_app_acct_fldr_data.folder_info.acct_id;
                comp_data->fldr_id = email_app_acct_fldr_data.folder_info.fldr_id;
                comp_data->msg_id = msg_id;
                comp_data->parent_id = email_app_acct_fldr_data.grp_id;
                comp_data->is_close_parent = FALSE;
                comp_data->type = EMAIL_PRE_COMP_TYPE_REPLY;
                mmi_email_reset_curr_comp_info();
                mmi_email_prepare_entry_comp(comp_data);
                OslMfree(comp_data);
            break;

        case MENU_ID_EMAIL_EDIT:
            comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));
                memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
                comp_data->acct_id = email_app_acct_fldr_data.folder_info.acct_id;
                comp_data->fldr_id = email_app_acct_fldr_data.folder_info.fldr_id;
                comp_data->msg_id = msg_id;
                comp_data->parent_id = email_app_acct_fldr_data.grp_id;
                comp_data->is_close_parent = FALSE;
                if (email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_OUTBOX)
                {
                    comp_data->edit_from_outbox = TRUE;
                }
                comp_data->type = EMAIL_PRE_COMP_TYPE_EDIT;
                mmi_email_reset_curr_comp_info();
                mmi_email_prepare_entry_comp(comp_data);
                OslMfree(comp_data);
            break;

        case MENU_ID_EMAIL_FORWARD:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_AUTOTEST_FORWARD_START);
            comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));
                memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
                comp_data->acct_id = email_app_acct_fldr_data.folder_info.acct_id;
                comp_data->fldr_id = email_app_acct_fldr_data.folder_info.fldr_id;
                comp_data->msg_id = msg_id;
                comp_data->parent_id = email_app_acct_fldr_data.grp_id;
                comp_data->is_close_parent = FALSE;
                comp_data->type = EMAIL_PRE_COMP_TYPE_FORWARD;
                mmi_email_reset_curr_comp_info();
                mmi_email_prepare_entry_comp(comp_data);
                OslMfree(comp_data);
            break;

        case MENU_ID_EMAIL_SEND_ALL_START:
            mmi_email_app_nwk_user_send(email_app_acct_fldr_data.folder_info.acct_id, TRUE);
            break;

        case MENU_ID_EMAIL_SEND_ALL_STOP:
            mmi_email_app_nwk_user_send_stop(email_app_acct_fldr_data.folder_info.acct_id);
            break;

        case MENU_ID_EMAIL_REFRESH_START:
            mmi_email_app_nwk_user_refresh(email_app_acct_fldr_data.folder_info.acct_id);
            break;

        case MENU_ID_EMAIL_REFRESH_STOP:
            mmi_email_app_nwk_user_refresh_stop(email_app_acct_fldr_data.folder_info.acct_id);
            break;

        case MENU_ID_EMAIL_MOVE_TO_DRAFTS:
            mmi_email_acct_folder_move_to_drafts(
                msg_id,
                email_app_acct_fldr_data.folder_info.acct_id,
                email_app_acct_fldr_data.folder_info.fldr_id);
            break;

        case MENU_ID_EMAIL_DELETE:
            mmi_email_folder_delete_msg_check(FALSE);
            break;

        case MENU_ID_EMAIL_MARK_UNREAD:
            mmi_email_acct_folder_mark_unread_msg(FALSE, msg_id);
            break;

        case MENU_ID_EMAIL_MARK_SEVERAL:
            mmi_email_acct_folder_mark_several();
            break;

        case MENU_ID_EMAIL_SORT_BY_DATE:
            mmi_email_acct_folder_sort_msg(msg_id, SRV_EMAIL_FLDR_SORT_MSG_MODE_TIME);
            break;

        case MENU_ID_EMAIL_SORT_BY_SENDER:
            mmi_email_acct_folder_sort_msg(msg_id, SRV_EMAIL_FLDR_SORT_MSG_MODE_ADDR);
            break;

        case MENU_ID_EMAIL_SORT_BY_SUBJ:
            mmi_email_acct_folder_sort_msg(msg_id, SRV_EMAIL_FLDR_SORT_MSG_MODE_BUFFER);
            break;

        case MENU_ID_EMAIL_SORT_BY_SIZE:
            mmi_email_acct_folder_sort_msg(msg_id, SRV_EMAIL_FLDR_SORT_MSG_MODE_SERVER_SIZE);
            break;

        case MENU_ID_EMAIL_MESSAGE_DETAIL:
                mmi_email_init_msg_detail_struct(
                    msg_id,
                    email_app_acct_fldr_data.folder_info.fldr_id,
                    email_app_acct_fldr_data.folder_info.acct_id,
                    email_app_acct_fldr_data.grp_id);
                mmi_email_show_msg_detail();
            break;

        default:
            // Not processed
            return MMI_RET_DONT_CARE;
    }

    return MMI_RET_OK;
}


void mmi_email_acct_folder_read_handler(EMAIL_MSG_ID msg_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_entry_read_struct read_data = {0};

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_READ_HANDLER, __LINE__);
    if (
        (email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_OUTBOX) 
        && (mmi_email_app_nwk_is_sending(email_app_acct_fldr_data.folder_info.acct_id) 
            ||  mmi_email_app_nwk_is_refreshing(email_app_acct_fldr_data.folder_info.acct_id)
           )
       )
    {
        mmi_email_lib_error_popup(STR_EMAIL_CANNOT_VIEW_WHEN_BUSY_ID);
        return;
    }

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_AUTOTEST_READ_START);
    read_data.acct_id = email_app_acct_fldr_data.folder_info.acct_id;
    read_data.fldr_id = email_app_acct_fldr_data.folder_info.fldr_id;
    read_data.folder_type = email_app_acct_fldr_data.fldr_type;
    read_data.msg_id = msg_id;
    read_data.parent_id = email_app_acct_fldr_data.grp_id;
    read_data.entry_from_folder = TRUE;
    mmi_email_reset_curr_read_info();

    if (mmi_email_pre_entry_read(&read_data))
    {
        mmi_email_fldr_set_flag_after_read();
    }
}


void mmi_email_fldr_set_flag_after_read(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_fldr_set_msg_flag_struct flag;
    EMAIL_REQ_ID req_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_FLDR_SET_FLAG_AFTER_READ, __LINE__);

    memset(&flag, 0, sizeof(srv_email_fldr_set_msg_flag_struct));
    flag.set_all = MMI_FALSE;
    flag.set_all_marked = MMI_FALSE;
    flag.msg_id = email_app_acct_fldr_data.curr_msg_id;
    flag.msg_flag = EMAIL_MSG_FLAG_SEEN;
    flag.flag_mask = EMAIL_MSG_FLAG_SEEN;
    srv_email_fldr_set_msg_flag(
        email_app_acct_fldr_data.fldr_handle,
        &flag,
        &req_id);
}


static void mmi_email_folder_delete_msg_check(BOOL marked)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_FOLDER_DELETE_MSG_CHECK, __LINE__);

    email_app_acct_fldr_data.delete_marked = marked;

    if (marked)
    {
        S32 num = 0;
        srv_email_fldr_get_msg_num(
            email_app_acct_fldr_data.fldr_handle,
            SRV_EMAIL_FLDR_MSG_MARKED,
            &num);
        if (num == 0)
        {
            mmi_email_lib_error_popup(STR_EMAIL_COMP_RECENT_MARK_FIRST_ID);
        }
        else if (num == 1)
        {
            mmi_email_util_display_confirm(
                email_app_acct_fldr_data.grp_id,
                mmi_email_acct_folder_delete_msg,
                mmi_frm_scrn_close_active_id,
                NULL,
                FALSE,
                GetString(STR_EMAIL_DEL_MARKED_MAIL_ID),
                MMI_EVENT_QUERY);
        }
        else
        {
            mmi_email_util_display_confirm(
                email_app_acct_fldr_data.grp_id,
                mmi_email_acct_folder_delete_msg,
                mmi_frm_scrn_close_active_id,
                NULL,
                FALSE,
                GetString(STR_EMAIL_DEL_MARKED_MAILS_ID),
                MMI_EVENT_QUERY);
        }
    }
    else
    {
    if (
        (email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_OUTBOX) 
        && (mmi_email_app_nwk_is_sending(email_app_acct_fldr_data.folder_info.acct_id) 
            ||  mmi_email_app_nwk_is_refreshing(email_app_acct_fldr_data.folder_info.acct_id)
           )
       )
        {
            mmi_email_lib_error_popup(STR_EMAIL_CANNOT_DELE_WHEN_BUSY_ID);
            return;
        }

        mmi_email_util_display_confirm(
            email_app_acct_fldr_data.grp_id,
            mmi_email_acct_folder_delete_msg,
            mmi_frm_scrn_close_active_id,
            NULL,
            FALSE,
            GetString(STR_EMAIL_DEL_SEL_MAIL_ID),
            MMI_EVENT_QUERY);
    }
}


void mmi_email_acct_folder_delete_msg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_fldr_delete_msg_struct delete_info;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    EMAIL_MSG_ID msg_id = email_app_acct_fldr_data.curr_msg_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_DELETE_MSG, __LINE__);

    if (msg_id == 0)
    {
        mmi_email_lib_error_popup(STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID);
        return;
    }

    if (
        (email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_OUTBOX) 
        && (mmi_email_app_nwk_is_sending(email_app_acct_fldr_data.folder_info.acct_id) 
            ||  mmi_email_app_nwk_is_refreshing(email_app_acct_fldr_data.folder_info.acct_id)
           )
       )
    {
        mmi_email_lib_error_popup(STR_EMAIL_CANNOT_DELE_WHEN_BUSY_ID);
        return;
    }

    if (email_app_acct_fldr_data.delete_marked)
    {
        delete_info.delete_all = MMI_FALSE;
        delete_info.delete_all_marked = MMI_TRUE;
        delete_info.delete_header = MMI_FALSE;
        delete_info.delete_server = MMI_TRUE;
        delete_info.msg_id = 0;
    }
    else
    {
        delete_info.delete_all = MMI_FALSE;
        delete_info.delete_all_marked = MMI_FALSE;
        delete_info.delete_header = MMI_FALSE;
        delete_info.delete_server = MMI_TRUE;
        delete_info.msg_id = msg_id;
    }

    if (email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_DRAFT ||
        email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_OUTBOX ||
        email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_SENT)
    {
        delete_info.delete_header = MMI_TRUE;
    }

    result = srv_email_fldr_delete_msg(
                email_app_acct_fldr_data.fldr_handle,
                &delete_info,
                &email_app_acct_fldr_data.req_id);
    if (result == SRV_EMAIL_RESULT_WOULDBLOCK)
    {
        email_app_acct_fldr_opt = MMI_EMAIL_FOLDER_OPT_DEL;
        email_app_acct_fldr_data.loading_scr_id = SCR_EMAIL_LOADING_ID;
        mmi_email_entry_folder_opt_loading();
    }
    else
    {
        // TODO...
        if (result == SRV_EMAIL_RESULT_SUCC)
        {
            //mmi_email_lib_succ_popup(STR_GLOBAL_DELETED);
        }
        else
        {
            mmi_email_util_display_error_popup(email_app_acct_fldr_data.grp_id, result);
        }
    }

    if (email_app_acct_fldr_data.delete_marked)
    {
        // close mark several screen
        mmi_frm_group_close(email_app_acct_fldr_data.mark_grp_id);
        email_app_acct_fldr_data.mark_grp_id = 0;
    }
}

void mmi_email_acct_folder_mark_unread_msg(BOOL marked, EMAIL_MSG_ID msg_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_fldr_set_msg_flag_struct flag;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    S32 num = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_MARK_UNREAD_MSG, __LINE__);

    flag.msg_id = msg_id;
    flag.msg_flag = 0;
    flag.flag_mask = 0x01;
    flag.set_all = MMI_FALSE;
    srv_email_fldr_get_msg_num(
        email_app_acct_fldr_data.fldr_handle,
        SRV_EMAIL_FLDR_MSG_MARKED,
        &num);
    if (marked)
    {
        if (num == 0)
        {
            mmi_email_lib_error_popup(STR_EMAIL_COMP_RECENT_MARK_FIRST_ID);
            return;
        }
        flag.set_all_marked = MMI_TRUE;
    }
    else
    {
        flag.set_all_marked = MMI_FALSE;
    }

    result = srv_email_fldr_set_msg_flag(
        email_app_acct_fldr_data.fldr_handle,
        &flag,
        &email_app_acct_fldr_data.req_id);
    if (result == SRV_EMAIL_RESULT_WOULDBLOCK)
    {
        email_app_acct_fldr_opt = MMI_EMAIL_FOLDER_OPT_SET_STATE;
        email_app_acct_fldr_data.loading_scr_id = SCR_ID_EMAIL_FOLDER_MARK_UNREAD_LOADING;
        mmi_email_entry_folder_opt_loading();
    }
    else
    {
        if (result == SRV_EMAIL_RESULT_SUCC)
        {
            if (!marked)
            {
                cui_menu_close(email_app_acct_fldr_data.option_menu_id);
            }
        }
        else
        {
            mmi_email_util_display_error_popup(email_app_acct_fldr_data.grp_id, result);
        }
    }

    // close mark several screen
    mmi_frm_group_close(email_app_acct_fldr_data.mark_grp_id);
    email_app_acct_fldr_data.mark_grp_id = 0;
}


void mmi_email_acct_folder_move_to_drafts(EMAIL_MSG_ID msg_id, EMAIL_ACCT_ID acct_id, EMAIL_FLDR_ID fldr_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    EMAIL_MSG_HANDLE msg_handle = 0;
    EMAIL_ACCT_HANDLE acct_handle = 0;
    S32 folder_id_num = 4;
    EMAIL_FLDR_ID fldr_id_array[4] = {0};
    EMAIL_MSG_ID new_msg_id = 0;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_MOVE_TO_DRAFTS, __LINE__);
    if (
        (email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_OUTBOX) 
        && (mmi_email_app_nwk_is_sending(email_app_acct_fldr_data.folder_info.acct_id) 
            ||  mmi_email_app_nwk_is_refreshing(email_app_acct_fldr_data.folder_info.acct_id)
           )
       )
    {
        mmi_email_lib_error_popup(STR_EMAIL_CANNOT_MOVE_WHEN_BUSY_ID);
        return;
    }

    result = srv_email_msg_create(0, &msg_handle);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_acct_fldr_data.grp_id, result);
        return;
    }
    result = srv_email_msg_open(msg_handle, acct_id, fldr_id, msg_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_acct_fldr_data.grp_id,result);
        srv_email_msg_destroy(msg_handle);
        return;
    }
    result = srv_email_acct_create(0, &acct_handle);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_acct_fldr_data.grp_id,result);
        srv_email_msg_destroy(msg_handle);
        return;
    }
    result = srv_email_acct_open(acct_handle, acct_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_acct_fldr_data.grp_id,result);
        srv_email_msg_destroy(msg_handle);
        srv_email_acct_destroy(acct_handle);
        return;
    }
    result = srv_email_acct_get_fldr_id(
        acct_handle,
        SRV_EMAIL_ACCT_FLDR_TYPE_BASIC,
        0,
        &folder_id_num,
        fldr_id_array);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_acct_fldr_data.grp_id,result);
        srv_email_msg_destroy(msg_handle);
        srv_email_acct_destroy(acct_handle);
        return;
    }
    result = srv_email_msg_move(msg_handle, acct_id, fldr_id_array[SRV_EMAIL_FLDR_TYPE_DRAFT], &new_msg_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_acct_fldr_data.grp_id,result);
        srv_email_msg_destroy(msg_handle);
        srv_email_acct_destroy(acct_handle);
        return;
    }

    srv_email_msg_destroy(msg_handle);
    srv_email_acct_destroy(acct_handle);
}


void mmi_email_acct_folder_sort_msg(
        EMAIL_MSG_ID msg_id,
        srv_email_fldr_sort_msg_mode_enum sort_mode)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_SORT_MSG, __LINE__);

    if (email_app_acct_fldr_data.fldr_type != SRV_EMAIL_FLDR_TYPE_DRAFT)
    {
        if (mmi_email_app_nwk_is_sending(email_app_acct_fldr_data.folder_info.acct_id) 
            || mmi_email_app_nwk_is_refreshing(email_app_acct_fldr_data.folder_info.acct_id))
        {
            mmi_email_lib_error_popup(STR_EMAIL_CANNOT_SORT_WHEN_BUSY_ID);
            return;
        }
    }

    email_app_sort_info.msg_id = msg_id;
    email_app_sort_info.msg_index = email_app_acct_fldr_data.hilight;
    email_app_sort_info.sort_mode = sort_mode;
    if (email_app_acct_fldr_data.folder_info.sort_mode == sort_mode)
    {
        email_app_sort_info.sort_order = (email_app_acct_fldr_data.folder_info.sort_order ? MMI_FALSE : MMI_TRUE);
    }
    else
    {
        email_app_sort_info.sort_order = MMI_FALSE;
    }
    result = srv_email_fldr_sort_msg_async(
                email_app_acct_fldr_data.fldr_handle,
                &email_app_sort_info,
                &email_app_acct_fldr_data.req_id);
    if (result == SRV_EMAIL_RESULT_SUCC)
    {
        email_app_acct_fldr_data.folder_info.sort_mode = email_app_sort_info.sort_mode;
        email_app_acct_fldr_data.folder_info.sort_order = email_app_sort_info.sort_order;
        email_app_acct_fldr_data.need_reset = TRUE;
        email_app_acct_fldr_data.hilight = email_app_sort_info.msg_index;
        cui_menu_close(email_app_acct_fldr_data.option_menu_id);
    }
    else if (result == SRV_EMAIL_RESULT_WOULDBLOCK)
    {
        mmi_email_app_nwk_freeze(email_app_acct_fldr_data.folder_info.acct_id, TRUE);

        email_app_acct_fldr_opt = MMI_EMAIL_FOLDER_OPT_SORT;
        email_app_acct_fldr_data.loading_scr_id = SCR_ID_EMAIL_FOLDER_SORT_LOADING;
        mmi_email_entry_folder_opt_loading();
    }
    else
    {
        mmi_email_util_display_error_popup(email_app_acct_fldr_data.grp_id, result);
    }
}


void mmi_email_acct_folder_mark_msg(EMAIL_MSG_ID msg_id, BOOL mark, BOOL mark_all)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_MARK_MSG, __LINE__);

    result = srv_email_fldr_mark_msg(
                email_app_acct_fldr_data.fldr_handle,
                (MMI_BOOL)mark_all,
                msg_id,
                (MMI_BOOL)mark);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_acct_fldr_data.grp_id, result);
        return;
    }
    cui_menu_close(email_app_acct_fldr_data.option_menu_id);
}


void mmi_email_entry_folder_opt_loading(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_FOLDER_OPT_LOADING, 1);
    if (!mmi_frm_scrn_enter(
            email_app_acct_fldr_data.grp_id,
            email_app_acct_fldr_data.loading_scr_id,
            NULL,
            mmi_email_entry_folder_opt_loading,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_FOLDER_OPT_LOADING, 2);
        return;
    }
    if (email_app_acct_fldr_opt == MMI_EMAIL_FOLDER_OPT_DEL)
    {
        ShowCategory66Screen(
            STR_GLOBAL_EMAIL,
            GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
            0,
            0,
            STR_GLOBAL_CANCEL,
            IMG_GLOBAL_BACK,
            (U8*)GetString(STR_GLOBAL_DELETING),
            mmi_email_lib_get_progress_img_id(),
            NULL);
        SetLeftSoftkeyFunction(NULL, KEY_EVENT_UP);
        SetRightSoftkeyFunction(mmi_email_folder_general_cancel, KEY_EVENT_UP);
    }
    else if (email_app_acct_fldr_opt == MMI_EMAIL_FOLDER_OPT_SORT)
    {
        ShowCategory66Screen(
            STR_GLOBAL_EMAIL,
            GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
            0,
            0,
            STR_GLOBAL_CANCEL,
            IMG_GLOBAL_BACK,
            (U8*)GetString(STR_GLOBAL_LOADING),
            mmi_email_lib_get_progress_img_id(),
            NULL);
        SetLeftSoftkeyFunction(NULL, KEY_EVENT_UP);
        SetRightSoftkeyFunction(NULL, KEY_EVENT_UP);
    }
    else
    {
        ShowCategory66Screen(
            STR_GLOBAL_EMAIL,
            GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
            0,
            0,
            STR_GLOBAL_CANCEL,
            IMG_GLOBAL_BACK,
            (U8*)GetString(STR_GLOBAL_LOADING),
            mmi_email_lib_get_progress_img_id(),
            NULL);
        SetLeftSoftkeyFunction(NULL, KEY_EVENT_UP);
        SetRightSoftkeyFunction(mmi_email_folder_general_cancel, KEY_EVENT_UP);
    }
}


S32 mmi_email_acct_folder_get_items(S32 start_indx, gui_iconlist_menu_item *menuData, S32 num_item)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    S32 j = 0, tmp_len = 0, n_from_len = 0, n_subject_len = 0, sub_menu_size = MAX_SUBMENU_CHARACTERS;
    S32 get_num = 0, req_num = 0, index = 0;
    U32 temp_get_num = 0;
    BOOL last_get = FALSE;
    srv_email_fldr_msg_info_struct *msgs_list = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    msgs_list = OslMalloc(sizeof(srv_email_fldr_msg_info_struct) * 2);
    get_num = ((num_item < 2) ? num_item : 2);
    while (req_num < num_item)
    {
        temp_get_num = (U32)get_num;
        result = srv_email_fldr_get_msg_list(
                    email_app_acct_fldr_data.fldr_handle,
                    start_indx,
                    &temp_get_num,
                    msgs_list);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            OslMfree(msgs_list);
            mmi_email_util_display_error_popup(0, result);
            mmi_frm_group_close(email_app_acct_fldr_data.grp_id);
            return 0;
        }

        if (temp_get_num == 0)
        {
            OslMfree(msgs_list);
            return req_num;
        }

        if (get_num != (S32)temp_get_num)
        {
            last_get = TRUE;
        }
        get_num = (S32)temp_get_num;
        start_indx += get_num;

        /* fill data */
        for (j = 0; j < get_num; j++)
        {
            U16 status_img;
            WCHAR *subject_ptr = NULL;
            U32 curr_time;
            U32 local_time;
            BOOL has_attach = FALSE, is_read = FALSE;
            applib_time_struct time_info = {0};
            applib_time_struct curr_time_info = {0};

            index = req_num + j;
            /*the first line*/
            /*item_list[i] at most reach MAX_SUBMENU_CHARACTERS(41) characters*/
            /* the first line time area of fixed position */
            local_time = applib_dt_sec_utc_to_local(msgs_list[j].time);
            applib_dt_utc_sec_2_mytime(local_time, &time_info, MMI_FALSE);
            curr_time = app_getcurrtime();
            applib_dt_utc_sec_2_mytime(curr_time, &curr_time_info, MMI_FALSE);
            if (curr_time_info.nYear != time_info.nYear)
            {
                kal_wsprintf((WCHAR*)menuData[index].item_list[1], "%04d", time_info.nYear);
            }
            else if (curr_time_info.nDay != time_info.nDay ||
                     curr_time_info.nMonth != time_info.nMonth)
            {
                kal_wsprintf(
                    (WCHAR*)menuData[index].item_list[1],
                    "%02d/%02d",
                    time_info.nMonth,
                    time_info.nDay);
            }
            else
            {
                kal_wsprintf(
                    (WCHAR*)menuData[index].item_list[1],
                    "%02d:%02d",
                    time_info.nHour,
                    time_info.nMin);
            }

            /* the first line address area */
            tmp_len = mmi_wcslen(msgs_list[j].addr.email_addr);
            if (tmp_len)
            {
                mmi_wcscpy((WCHAR*)menuData[index].item_list[2], (WCHAR*)g_email_subj_left_op); /* '<' */
                if (tmp_len + 2 > sub_menu_size)
                {
                    n_from_len = sub_menu_size - mmi_wcslen((WCHAR*)g_email_2dots) - 2;
                    mmi_wcsncat((WCHAR*)menuData[index].item_list[2], (WCHAR*)msgs_list[j].addr.email_addr, n_from_len);
                    n_from_len += 1; /*addr + <*/
                    (menuData[index].item_list[2])[n_from_len] = L'\0';
                    mmi_wcscat((WCHAR*)menuData[index].item_list[2], (WCHAR*)g_email_2dots);/*...*/
                    n_from_len = sub_menu_size - 1; /*addr + ... + <*/ 
                    (menuData[index].item_list[2])[n_from_len] = L'\0';
                    n_from_len = sub_menu_size;
                }
                else
                {
                    n_from_len = tmp_len;
                    mmi_wcsncat((WCHAR*)menuData[index].item_list[2], (WCHAR*)msgs_list[j].addr.email_addr, n_from_len);
                    n_from_len += 1; /*addr + <*/ 
                    (menuData[index].item_list[2])[n_from_len] = L'\0';
                    n_from_len += 1; /*addr + <>*/ 
                }
                mmi_wcscat((WCHAR*)menuData[index].item_list[2], (WCHAR*)g_email_subj_right_op); /* '>' */
            }
            else
            {
                n_from_len = 0;
            }
            (menuData[index].item_list[2])[n_from_len] = L'\0';
            
            /*the second line*/
            if (!mmi_wcslen((WCHAR*)msgs_list[j].buff))
            {
                subject_ptr = (WCHAR*)GetString(STR_EMAIL_COMMON_NO_SUBJECT_ID);
            }
            else
            {
                subject_ptr = msgs_list[j].buff;
            }
            tmp_len = mmi_wcslen(subject_ptr);
            if (tmp_len > sub_menu_size - MMI_EMAIL_MAX_TIME_DISP_LEN - 1)
            {
                n_subject_len = sub_menu_size - mmi_wcslen(g_email_2dots) - MMI_EMAIL_MAX_TIME_DISP_LEN - 1;
                mmi_wcsncpy((WCHAR*)menuData[index].item_list[0], subject_ptr, n_subject_len);
                (menuData[index].item_list[0])[n_subject_len] = L'\0';
                mmi_wcscat((WCHAR*)menuData[index].item_list[0], g_email_2dots);/*...*/
                n_subject_len = sub_menu_size - MMI_EMAIL_MAX_TIME_DISP_LEN - 1;
                (menuData[index].item_list[0])[n_subject_len] = L'\0';
            }
            else
            {
                mmi_wcscpy((WCHAR*)menuData[index].item_list[0], subject_ptr);
            }

            /*  fill status icon */
            has_attach = ((msgs_list[j].has_attach == 0) ? FALSE : TRUE);
            is_read = ((msgs_list[j].flag & EMAIL_MSG_FLAG_SEEN) ? TRUE : FALSE);
            status_img = mmi_email_folder_get_status_icon(
                msgs_list[j].msg_id,
                has_attach,
                msgs_list[j].priority,
                is_read);
            menuData[index].image_list[0] = (PU8)GetImage(status_img);
        }
        req_num += get_num;
        if (last_get)
        {
            break;
        }
        get_num = ((num_item - req_num < 2) ? num_item - req_num : 2);
    }
    OslMfree(msgs_list);
    return req_num;
}


static mmi_ret mmi_email_acct_folder_mark_several_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_MARK_SEVERAL_PROC, menu_evt->evt_id);
    switch (menu_evt->evt_id)
    {
        case EVT_ID_GROUP_FOCUSED:
            mmi_email_set_active_group_id(email_app_acct_fldr_data.mark_grp_id);
            break;

        case EVT_ID_GROUP_DEINIT:
            // TODO...
            // Allow refresh again
            mmi_email_app_nwk_freeze(0, FALSE);
            break;

        case EVT_ID_CUI_MENU_LIST_ENTRY:
            mmi_email_acct_folder_mark_option_hide(menu_evt->sender_id);
            break;

        case EVT_ID_CUI_MENU_ITEM_SELECT:
            cui_menu_close(menu_evt->sender_id);
            mmi_email_acct_folder_mark_option_action(menu_evt->highlighted_menu_id);
            break;

        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
            cui_menu_close(menu_evt->sender_id);
            break;
    }
    return MMI_RET_OK;
}

static void mmi_email_acct_folder_mark_several(void)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_MARK_SEVERAL, 1);

    if (email_app_acct_fldr_data.fldr_type != SRV_EMAIL_FLDR_TYPE_DRAFT)
    {
        if (mmi_email_app_nwk_is_sending(email_app_acct_fldr_data.folder_info.acct_id) 
            || mmi_email_app_nwk_is_refreshing(email_app_acct_fldr_data.folder_info.acct_id))
        {
            mmi_email_lib_error_popup(STR_EMAIL_CANNOT_MARK_WHEN_BUSY_ID);
            return;
        }
    }

    /* reset */
    mmi_email_acct_folder_mark_msg(0, FALSE, TRUE);

    /* create group */
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_MARK_SEVERAL, 2);
    email_app_acct_fldr_data.mark_grp_id = mmi_frm_group_create(
        email_app_acct_fldr_data.grp_id,
        GRP_ID_AUTO_GEN,
        mmi_email_acct_folder_mark_several_proc,
        (void*)NULL);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_MARK_SEVERAL, 3);
    mmi_frm_group_enter(email_app_acct_fldr_data.mark_grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_MARK_SEVERAL, 4);

    mmi_email_app_nwk_freeze(email_app_acct_fldr_data.folder_info.acct_id, TRUE);

    /* enter screen */
    email_app_acct_fldr_data.mark_hilight_idx = 0;
    mmi_email_acct_folder_mark_several_screen_enter();

    cui_menu_close(email_app_acct_fldr_data.option_menu_id);
}

static void mmi_email_acct_folder_mark_several_screen_enter(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *gui_buffer;
    S32 list_not_ready;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_MARK_SEVERAL_SCREEN_ENTER, 1);
    if (!mmi_frm_scrn_enter(
            email_app_acct_fldr_data.mark_grp_id,
            SCR_ID_EMAIL_FOLDER_MARK_SEVERAL,
            NULL,
            mmi_email_acct_folder_mark_several_screen_enter,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_MARK_SEVERAL_SCREEN_ENTER, 2);
        return;
    }
    srv_email_fldr_get_msg_num(
        email_app_acct_fldr_data.fldr_handle,
        SRV_EMAIL_FLDR_MSG,
        &email_app_acct_fldr_data.count);
    if (!email_app_acct_fldr_data.count)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_MARK_SEVERAL_SCREEN_ENTER, 3);
        mmi_frm_scrn_close(email_app_acct_fldr_data.mark_grp_id, SCR_ID_EMAIL_FOLDER_MARK_SEVERAL);
        return;
    }

    if (email_app_acct_fldr_data.need_reset)
    {
        gui_buffer = NULL;
        email_app_acct_fldr_data.need_reset = MMI_FALSE;
    }
    else
    {
        gui_buffer = mmi_frm_scrn_get_active_gui_buf();
    }

    RegisterHighlightHandler(mmi_email_acct_folder_mark_several_hilight);
    EnableCenterSoftkey(0, IMG_GLOBAL_MARK_CSK);
    wgui_cat263_set_display_style(MMI_CAT263_DISPLAY_ALL);
    ShowCategory267Screen(
        get_string(STR_EMAIL_FOLDER_MARK_SEVERAL),
        get_image(GetRootTitleIcon(MENU_ID_EMAIL_MAIN)),
        get_string(STR_GLOBAL_OPTIONS),
        get_image(IMG_GLOBAL_OPTIONS),
        get_string(STR_GLOBAL_BACK),
        get_image(IMG_GLOBAL_BACK),
        email_app_acct_fldr_data.count,
        mmi_email_acct_folder_get_items,
        NULL,// hint
        mmi_email_acct_folder_get_check_state, 
        mmi_email_acct_folder_mark_several_click, // Set mark
        get_string(STR_GLOBAL_BACK),
        (S32)email_app_acct_fldr_data.mark_hilight_idx,
        IMG_EMAIL_READ_NORMAL_ID,
        gui_buffer,
        &list_not_ready);
    if (list_not_ready)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_MARK_SEVERAL_SCREEN_ENTER, 4);
        mmi_frm_group_close(email_app_acct_fldr_data.mark_grp_id);
        return;
    }

    SetLeftSoftkeyFunction(mmi_email_acct_folder_mark_several_lsk, KEY_EVENT_UP);
    SetCenterSoftkeyFunction(mmi_email_acct_folder_mark_several_csk, KEY_EVENT_UP);
    SetRightSoftkeyFunction(mmi_email_acct_folder_mark_several_rsk, KEY_EVENT_UP);

    // TODO...
    // Forbid background refresh during this time

    //if (email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_INBOX)
    //{
    //    mmi_email_acct_set_refresh_pending(TRUE);
    //}

#ifdef __MMI_TOUCH_SCREEN__
    wgui_register_list_item_selected_callback_all(mmi_email_acct_folder_mark_several_pen_down);
#endif /* __MMI_TOUCH_SCREEN__ */

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
    wgui_register_tap_callback(mmi_email_acct_folder_mark_several_tap_callback);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */
}

static void mmi_email_acct_folder_mark_several_lsk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	mmi_id menu_cui_id;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_MARK_SEVERAL_LSK, __LINE__);

    menu_cui_id = cui_menu_create(
                    email_app_acct_fldr_data.mark_grp_id,
                    CUI_MENU_SRC_TYPE_RESOURCE,
                    CUI_MENU_TYPE_OPTION,
                    MENU_ID_EMAIL_MARK_SEVERAL_OPT,
                    MMI_FALSE,
                    NULL);
    cui_menu_set_default_title(menu_cui_id, NULL, get_image(GetRootTitleIcon(MENU_ID_EMAIL_MAIN)));
    cui_menu_run(menu_cui_id);
}

static void mmi_email_acct_folder_mark_several_csk(void)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_MARK_SEVERAL_CSK, __LINE__);
    mmi_email_acct_folder_mark_several_change_state();
    mmi_email_refresh_mark_screen();
}

static void mmi_email_acct_folder_mark_several_rsk(void)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_MARK_SEVERAL_RSK, __LINE__);
    mmi_email_acct_folder_mark_msg(0, FALSE, TRUE);
    mmi_frm_scrn_close_active_id();
}

static BOOL mmi_email_acct_folder_mark_is_marked(S32 idx, EMAIL_MSG_ID *msg_id)
{
    static srv_email_fldr_msg_info_struct item;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    U32 temp_get_num = 1;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (msg_id != NULL)
    {
        *msg_id = 0;
    }

    result = srv_email_fldr_get_msg_list(
        email_app_acct_fldr_data.fldr_handle,
        idx,
        &temp_get_num,
        &item);
    if (result == SRV_EMAIL_RESULT_SUCC)
    {
        if (msg_id != NULL)
        {
            *msg_id = item.msg_id;
        }
        return (BOOL)item.marked;
    }    

    return FALSE;
}

static void mmi_email_acct_folder_mark_option_hide(mmi_id menu_id)
{
    S32 idx = email_app_acct_fldr_data.mark_hilight_idx;
    S32 num = 0;
    S32 num_marked = 0;
    S32 num_unread_marked = 0;

    if (mmi_email_acct_folder_mark_is_marked(idx, NULL))
    {
        cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_MARK_SEVERAL_MARK, MMI_TRUE);
        cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_MARK_SEVERAL_UNMARK, MMI_FALSE);
    }
    else
    {
        cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_MARK_SEVERAL_MARK, MMI_FALSE);
        cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_MARK_SEVERAL_UNMARK, MMI_TRUE);
    }

    num = email_app_acct_fldr_data.count;
    srv_email_fldr_get_msg_num(
        email_app_acct_fldr_data.fldr_handle,
        SRV_EMAIL_FLDR_MSG_MARKED,
        &num_marked);
    srv_email_fldr_get_msg_num(
        email_app_acct_fldr_data.fldr_handle,
        SRV_EMAIL_FLDR_MSG_UNREAD_FROM_MARKED,
        &num_unread_marked);

    if (num <= 1)
    {
        cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_MARK_SEVERAL_MARK_ALL, MMI_TRUE);
        cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_MARK_SEVERAL_UNMARK_ALL, MMI_TRUE);
    }
    else
    {
        if (num == num_marked)
        {
            cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_MARK_SEVERAL_MARK_ALL, MMI_TRUE);
            cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_MARK_SEVERAL_UNMARK_ALL, MMI_FALSE);
        }
        else
        {
            cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_MARK_SEVERAL_MARK_ALL, MMI_FALSE);
            cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_MARK_SEVERAL_UNMARK_ALL, MMI_TRUE);
        }
    }

    cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_MARK_SEVERAL_DELETE, MMI_FALSE);

    if (email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_INBOX)
    {
        cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_MARK_SEVERAL_UNREAD, MMI_FALSE);
    }
    else
    {
        cui_menu_set_item_hidden(menu_id, MENU_ID_EMAIL_MARK_SEVERAL_UNREAD, MMI_TRUE);
    }
}

static void mmi_email_acct_folder_mark_option_action(mmi_id menu_id)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_MARK_OPTION_ACTION, menu_id);

    switch (menu_id)
    {
    case MENU_ID_EMAIL_MARK_SEVERAL_MARK:
    case MENU_ID_EMAIL_MARK_SEVERAL_UNMARK:
        mmi_email_acct_folder_mark_several_change_state();
        mmi_email_refresh_mark_screen();
        break;

    case MENU_ID_EMAIL_MARK_SEVERAL_MARK_ALL:
        srv_email_fldr_mark_msg(
            email_app_acct_fldr_data.fldr_handle,
            MMI_TRUE,
            0,
            MMI_TRUE);
        mmi_email_refresh_mark_screen();
        //standard_check_list_handle_left_softkey_up();
        break;

    case MENU_ID_EMAIL_MARK_SEVERAL_UNMARK_ALL:
        srv_email_fldr_mark_msg(
            email_app_acct_fldr_data.fldr_handle,
            MMI_TRUE,
            0,
            MMI_FALSE);
        mmi_email_refresh_mark_screen();
        //standard_check_list_handle_left_softkey_up();
        break;

    case MENU_ID_EMAIL_MARK_SEVERAL_DELETE:
        mmi_email_folder_delete_msg_check(TRUE);
        break;

    case MENU_ID_EMAIL_MARK_SEVERAL_UNREAD:
        mmi_email_acct_folder_mark_unread_msg(TRUE, 0);
        break;

    default:
        break;
    }
}

static void mmi_email_acct_folder_mark_several_hilight(S32 index)
{
    email_app_acct_fldr_data.mark_hilight_idx = index;
}

static S32 mmi_email_acct_folder_get_check_state(S32 item_index, PU8 *checkbox_image)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    BOOL marked = FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    marked = mmi_email_acct_folder_mark_is_marked(item_index, NULL);
    *checkbox_image = (marked) ? (PU8)GetImage(CHECKBOX_ON_IMAGE_ID) : (PU8)GetImage(CHECKBOX_OFF_IMAGE_ID);
    return MMI_TRUE;
}

static S32 mmi_email_acct_folder_mark_several_click(S32 item_index)
{
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_FOLDER_MARK_SEVERAL_CLICK, __LINE__);

    email_app_acct_fldr_data.mark_hilight_idx = item_index;
    mmi_email_acct_folder_mark_several_change_state();
    return MMI_TRUE;
}

static void mmi_email_acct_folder_mark_several_change_state(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 item_index = email_app_acct_fldr_data.mark_hilight_idx;
    MMI_BOOL marked = MMI_FALSE;
    EMAIL_MSG_ID msg_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (item_index < 0 || item_index >= email_app_acct_fldr_data.count)
    {
        return;
    }

    marked = (MMI_BOOL)mmi_email_acct_folder_mark_is_marked(item_index, &msg_id);
    srv_email_fldr_mark_msg(
        email_app_acct_fldr_data.fldr_handle,
        MMI_FALSE,
        msg_id,
        (MMI_BOOL)(!marked));
}

static void mmi_email_refresh_mark_screen(void)
{
    /*
        mmi_cat_refresh_asyncdynamic_list(email_app_acct_fldr_data.count, 
        email_app_acct_fldr_data.mark_hilight_idx,
        mmi_email_acct_folder_get_items,
        NULL);
        */
    RedrawCategoryFunction();
}

#ifdef __MMI_TOUCH_SCREEN__
static void mmi_email_acct_folder_mark_several_pen_down(void)
{
    //mmi_email_acct_folder_mark_several_change_state();
}
#endif /* __MMI_TOUCH_SCREEN__ */

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_acct_folder_mark_several_tap_callback(mmi_tap_type_enum tap_type, S32 index)
{
    email_app_acct_fldr_data.mark_hilight_idx = index;
    mmi_email_acct_folder_mark_several_change_state();
}
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

U16 mmi_email_folder_get_status_icon(EMAIL_MSG_ID msg_id, BOOL has_attach, U8 priority, BOOL is_read)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    EMAIL_ACCT_ID acc_id = email_app_acct_fldr_data.folder_info.acct_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!is_read && email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_INBOX)
    {
        if (priority == EMAIL_MSG_PRIO_LOW)
        {
            return ((has_attach) ? IMG_EMAIL_UNREAD_LOW_ATT_ID : IMG_EMAIL_UNREAD_LOW_ID);
        }
        else if (priority == EMAIL_MSG_PRIO_HIGH)
        {
            return ((has_attach) ? IMG_EMAIL_UNREAD_HIGH_ATT_ID : IMG_EMAIL_UNREAD_HIGH_ID);
        }
        else    /* (priority == EMAIL_MSG_PRIO_MED) */
        {
            return ((has_attach) ? IMG_EMAIL_UNREAD_NORMAL_ATT_ID : IMG_EMAIL_UNREAD_NORMAL_ID);
        }
    }
    else if(email_app_acct_fldr_data.fldr_type == SRV_EMAIL_FLDR_TYPE_OUTBOX
        && mmi_email_app_nwk_is_outbox_sending(acc_id))
    {
        if (mmi_email_app_nwk_is_msg_sendfail(acc_id, msg_id))
        {
            // Send failed
            return IMG_EMAIL_OUTBOX_SEND_FAILED;
        }
        else if (mmi_email_app_nwk_is_msg_sending(acc_id, msg_id))
        {
            return IMG_EMAIL_OUTBOX_SEND_ONGOING;
        }
        else
        {
            // Wait for send
            return IMG_EMAIL_OUTBOX_TO_SEND;
        }
    }
    else
    {
        if (priority == EMAIL_MSG_PRIO_LOW)
        {
            return ((has_attach) ? IMG_EMAIL_READ_LOW_ATT_ID : IMG_EMAIL_READ_LOW_ID);
        }
        else if (priority == EMAIL_MSG_PRIO_HIGH)
        {
            return ((has_attach) ? IMG_EMAIL_READ_HIGH_ATT_ID : IMG_EMAIL_READ_HIGH_ID);
        }
        else    /* (priority == EMAIL_MSG_PRIO_MED) */
        {
            return ((has_attach) ? IMG_EMAIL_READ_NORMAL_ATT_ID : IMG_EMAIL_READ_NORMAL_ID);
        }
    }
}

void mmi_email_util_get_folder_name(
        EMAIL_ACCT_ID acct_id,
        EMAIL_ACCT_HANDLE acct_handle,
        EMAIL_FLDR_ID fldr_id,
        srv_email_fldr_type_enum *fldr_type,
        WCHAR *name)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_acct_folder_struct *folder_info_ptr = NULL;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    srv_email_fldr_type_enum curr_fldr_type = SRV_EMAIL_FLDR_TYPE_INVALID;
    WCHAR *name_ptr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    folder_info_ptr = OslMalloc(sizeof(srv_email_acct_folder_struct));
    memset(folder_info_ptr, 0, sizeof(srv_email_acct_folder_struct));
    result = srv_email_acct_get_fldr_info(
        acct_handle,
        fldr_id,
        folder_info_ptr);
    if (result == SRV_EMAIL_RESULT_SUCC)
    {
        curr_fldr_type = srv_email_fldr_id_to_fldr_type(acct_id, fldr_id);
        if (folder_info_ptr->fldr_type == SRV_EMAIL_ACCT_FLDR_TYPE_LOCAL)
        {
            name_ptr = mmi_wcsrchr(folder_info_ptr->folder_name, folder_info_ptr->fldr_name_separator);
            if (!name_ptr)
            {
                mmi_wcscpy(name, folder_info_ptr->folder_name);
            }
            else
            {
                mmi_wcscpy(name, name_ptr + 1);
            }
        }
        else
        {
            switch (curr_fldr_type)
            {
                case SRV_EMAIL_FLDR_TYPE_INBOX:
                    mmi_wcscpy(name, (WCHAR*)GetString(STR_GLOBAL_INBOX));
                    break;
                case SRV_EMAIL_FLDR_TYPE_SENT:
                    mmi_wcscpy(name, (WCHAR*)GetString(STR_EMAIL_SENT_ID));
                    break;
                case SRV_EMAIL_FLDR_TYPE_OUTBOX:
                    mmi_wcscpy(name, (WCHAR*)GetString(STR_GLOBAL_OUTBOX));
                    break;
                case SRV_EMAIL_FLDR_TYPE_DRAFT:
                    mmi_wcscpy(name, (WCHAR*)GetString(STR_GLOBAL_DRAFTS));
                    break;
                default:
                    name[0] = L'\0';
                    break;
            }
        }
        if (fldr_type)
        {
            *fldr_type = curr_fldr_type;
        }
    }
    else
    {
        name[0] = L'\0';
        if (fldr_type)
        {
            *fldr_type = SRV_EMAIL_FLDR_TYPE_INVALID;
        }
    }
    OslMfree(folder_info_ptr);
}


#endif /* __MMI_EMAIL__ */
