/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*******************************************************************************
 * Filename:
 * ---------
 * EmailAppUtil.c
 *
 * Project:
 * --------
 * MAUI
 *
 * Description:
 * ------------
 * 
 *
 * Author:
 * -------
 * 
 *
 *==============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!! 
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!! 
 *==============================================================================
 *******************************************************************************/
#include "MMI_features.h"

#ifdef __MMI_EMAIL__

#if (defined(__XML_SUPPORT__) && defined(__WBXML_SUPPORT__))
#ifndef __MMI_EMAIL_EMN__
#define __MMI_EMAIL_EMN__
#endif /* __MMI_EMAIL_EMN__ */
#endif /* (defined(__XML_SUPPORT__) && defined(__WBXML_SUPPORT__)) */

#include "conversions.h"

#include "UcmSrvGprot.h"
#include "App_usedetails.h"
#include "soc_api.h"

#ifdef __USB_IN_NORMAL_MODE__
#include "USBDeviceGprot.h"
#include "USBSrvGProt.h"
#endif 

#ifdef __DRM_SUPPORT__
#include "Drm_gprot.h"
#endif /* __DRM_SUPPORT__ */

#include "app_mine.h"


#ifdef BROWSER_SUPPORT
#include "browser_api.h"
#endif

#include "cbmsrvgprot.h"
#include "cbmcuigprot.h"
#include "simctrlsrvgprot.h"
#include "Menucuigprot.h"

#ifdef __OP12__
#include "IdleHomescreenGprot.h"
#include "IdleGProt.h"
#endif

#include "IdleNotificationManagergprot.h"
#include "NotificationGprot.h"

#include "EmailAppAccount.h"
#include "EmailAppGProt.h"
#include "EmailAppProt.h"
#include "EmailAppEMN.h"

#include "emailsrvgprot.h"
#include "MMIDataType.h"
#include "kal_general_types.h"
#include "UriAgentSrvGprot.h"
#include "customer_ps_inc.h"
#include "GlobalResDef.h"
#include "wgui_categories_list.h"
#include "drm_def.h"
#include "mmi_rp_app_email_def.h"
#include "EmailAppCore.h"
#include "string.h"
#include "mmi_frm_mem_gprot.h"
#include "kal_public_api.h"
#include "Unicodexdcl.h"
#include "mmi_frm_scenario_gprot.h"
#include "mmi_frm_events_gprot.h"
#include "wgui_categories_popup.h"
#include "wgui_categories_util.h"
#include "custom_events_notify.h"
#include "GlobalConstants.h"
#include "CustDataRes.h"
#include "gui_typedef.h"
#include "gui_data_types.h"
#include "FileMgrSrvGProt.h"
#include "AlertScreen.h"
#include "CommonScreensResDef.h"
#include "fs_type.h"
#include "fs_errcode.h"
#include "drm_errcode.h"
#include "NetSetSrvGprot.h"
#include "NetSetAppGprot.h"
#include "mmi_frm_timer_gprot.h"
#include "TimerEvents.h"
#include "mmi_frm_input_gprot.h"
#include "NotificationGprot.h"
#include "fs_func.h"
#include "NwUsabSrvGprot.h"
#include "mmi_inet_app_trc.h"

#ifdef __DM_LAWMO_SUPPORT__
#include "dmuigprot.h"
#endif

#if defined( __MMI_OP11_HOMESCREEN_0301__) || defined(__MMI_OP11_HOMESCREEN_0302__)
#include "HomeScreenOp11V32Gprot.h"
#endif

#include "EmailAppAccountData.h"
#include "EmailAppNetwork.h"
#include "EmailAppLib.h"
#include "EmailAppOperators.h"

#ifdef __MMI_EMAIL_OTAP__
#include "EmailAppOtap.h"
#endif /* __MMI_EMAIL_OTAP__ */

#include "EmailAppNCenter.h"
#include "StatusIconRes.h"

/************************************************************************/
/*                   defines                                            */
/************************************************************************/
#define MMI_EMAIL_GRP_MAGIC_ID 65535


typedef struct
{
    S32 err_no;
    U16 str_id;
} email_app_err_string_struct;


typedef enum
{
    EMAIL_IDLE_NONE = 0,
    EMAIL_IDLE_SOFT_NOTE = 0x01,
#ifdef __OP12__
    EMAIL_IDLE_VF_LIST = 0x02,
#endif /* __OP12__ */
#ifdef __MMI_EMAIL_EMN__
    EMAIL_IDLE_EMN = 0x04,
#endif /* __MMI_EMAIL_EMN__ */
    EMAIL_IDLE_TOTAL
} email_app_idle_data_enum;

typedef struct
{
    mmi_email_batch_receive_result_struct receive_result_array[MMI_EMAIL_MAX_ACCTS];
    S32 result_num;

    mmi_id emn_group_id;
    mmi_id emn_error_grp_id;
    MMI_BOOL has_new_emn_notify;
    WCHAR *emn_screen_memory_ptr;
    S32 highlight_account_index;

    EMAIL_ACCT_ID last_error_acc_id;
    S32 last_error_code;

} mmi_email_batch_receive_result_queue_struct;


/************************************************************************/
/*                          Variables                                   */
/************************************************************************/

#ifdef __DRM_SUPPORT__
CHAR rights_issuer[DRM_MAX_URL_LENGTH];
#endif /* __DRM_SUPPORT__ */

static email_app_idle_data_enum email_idle_data = EMAIL_IDLE_NONE;

static FuncPtr email_confirm_lsk_func;
static FuncPtr email_confirm_rsk_func;
static FuncPtr email_confirm_interrupt_func;
static S32 attach_copy_job_id = 0;
static mmi_id attach_copy_parent_id = 0;
static WCHAR *copy_file_dst_path = NULL;

const email_app_err_string_struct g_email_err_tbl[] = 
{
    {SRV_EMAIL_RESULT_NO_MEMORY, STR_GLOBAL_NOT_ENOUGH_MEMORY},
    {SRV_EMAIL_RESULT_ACTIVATE_BEARER_FAIL, STR_EMAIL_ERROR_CODE_BEARER_FAIL},
    {SRV_EMAIL_RESULT_AUTH_FAIL, STR_EMAIL_ERROR_CODE_AUTH_FAIL_ID},
    {SRV_EMAIL_RESULT_INVALID_USERNAME, STR_EMAIL_ERROR_CODE_AUTH_FAIL_ID},
    {SRV_EMAIL_RESULT_INVALID_PASSWORD, STR_EMAIL_ERROR_CODE_AUTH_FAIL_ID},
    {SRV_EMAIL_RESULT_MSG_NOT_EXIST, STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID},
    {SRV_EMAIL_RESULT_INVALID_MSG, STR_EMAIL_ERROR_CODE_MSG_NOT_EXISTING_ID},
    {SRV_EMAIL_RESULT_SERVER_NOT_SUPPORT_STARTTLS, STR_EMAIL_MSG_SERVER_TLS_FAIL},
    {SRV_EMAIL_RESULT_SERVER_NOT_SUPPORT_APOP, STR_EMAIL_ERROR_CODE_NOT_SUPPORT_APOP_ID},
    {SRV_EMAIL_RESULT_SERVER_ERROR, STR_EMAIL_ERROR_CODE_CONN_FAIL_ID},
    {SRV_EMAIL_RESULT_NETWORK_ERROR, STR_EMAIL_ERROR_CODE_CONN_FAIL_ID},
    {SRV_EMAIL_RESULT_INCOMPLETE_ACCT, STR_EMAIL_ERROR_CODE_CONN_FAIL_ID},
    {SRV_EMAIL_RESULT_NETWORK_TIMEOUT, STR_EMAIL_ERROR_CODE_NETWORK_ID},
    {SRV_EMAIL_RESULT_RECIPIENTS_ERROR, STR_EMAIL_SMTP_RCPT_TO_FAIL},
    {SRV_EMAIL_RESULT_INVALID_FORMAT, STR_EMAIL_INVALID_MAIL_MESSAGE},
    {SRV_EMAIL_RESULT_SMTP_CMD_ERROR, STR_EMAIL_ERROR_CODE_SMTP_CMD},
    {SRV_EMAIL_RESULT_POP3_CMD_ERROR, STR_EMAIL_ERROR_CODE_POP_CMD},
    {SRV_EMAIL_RESULT_IMAP4_CMD_ERROR, STR_EMAIL_ERROR_CODE_IMAP_CMD},
    {SRV_EMAIL_RESULT_SELECT_FOLDER_ERROR, STR_EMAIL_ERROR_CODE_SELECT_FOLDER},
    {SRV_EMAIL_RESULT_MSG_REACH_MAX_NUM, STR_EMAIL_ERROR_CODE_REACH_MAX_NUM},
    {0, STR_EMAIL_ERROR_CODE_OPT_FAIL_ID}
};

const email_app_err_string_struct g_email_app_core_err_tbl[] = 
{
    {MMI_EMAIL_FAIL, STR_EMAIL_ERROR_CODE_OPT_FAIL_ID},
    {MMI_EMAIL_ACCOUNT_ALREADY_EXIST, STR_EMAIL_ERROR_CODE_ACCOUNT_ALREADY_EXIST},
    {MMI_EMAIL_ACCOUNT_NOT_EXIST, STR_EMAIL_ERROR_CODE_ACCOUNT_NOT_EXIST},
    {0, STR_EMAIL_ERROR_CODE_OPT_FAIL_ID}
};

static mmi_email_batch_receive_result_queue_struct g_receive_list; 

/************************************************************************/
/*                          Prototypes                                  */
/************************************************************************/
static mmi_ret mmi_email_general_cnf_cb(mmi_event_struct *evt);
static mmi_email_copy_file_to_view_callback copy_file_callback = NULL;
static void mmi_email_copy_file_loading(void);
static mmi_ret mmi_email_copy_file_del_callback(mmi_event_struct *evt);
static mmi_ret mmi_email_copy_file_to_view_copy_callback(mmi_event_struct *param);


/* autocheck & emn report */
static NMGR_HANDLE g_nmgr_newmail_handler = NULL;
#ifndef __MMI_NCENTER_SUPPORT__
static NMGR_HANDLE g_nmgr_error_handler = NULL;
#endif
static MMI_BOOL reenter_by_cmcc = MMI_FALSE;
static void mmi_email_nmgr_emn_view(void *user_data);
static mmi_ret mmi_email_emn_entry_list_group_proc(mmi_event_struct *p_event);
static void mmi_email_emn_entry_list(void);
static void mmi_email_emn_entry_list_screen_lsk(void);
static void mmi_email_emn_entry_list_screen_rsk(void);
static void mmi_email_emn_entry_list_screen_highlight_handler(S32 highlight_index);
static mmi_ret mmi_email_emn_entry_list_screen(mmi_scrn_essential_struct *p_screen_data);
static mmi_ret mmi_email_emn_exit_list_screen(mmi_scrn_essential_struct *p_screen_data);
#if 0
/* under construction !*/
#endif
static mmi_ret mmi_email_emn_show_error_info_screen(mmi_scrn_essential_struct *p_screen_data);


static void mmi_email_nmgr_play_tone(void);
static void mmi_email_nmgr_show_newmail(void);
static void mmi_email_nmgr_cancel_newmail(void);
#ifndef __MMI_NCENTER_SUPPORT__
static void mmi_email_nmgr_show_error(void);
static void mmi_email_nmgr_cancel_error(void);
static mmi_ret mmi_email_nmgr_error_func(mmi_event_struct *evt);
#endif
static mmi_ret mmi_email_nmgr_newmail_func(mmi_event_struct *evt);
static S32 get_total_received_number(void);

/************************************************************************/
/*                           Implements                                 */
/************************************************************************/
U16 mmi_email_util_get_err_code(S32 major, S32 minor)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S16 i = 0, entry = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_UTIL_GET_ERR_CODE, major);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_UTIL_GET_ERR_CODE, minor);
    switch (major)
    {
        case SRV_EMAIL_MAIL_ERROR:
            {
                entry = sizeof(g_email_err_tbl) / sizeof(email_app_err_string_struct);
                for (i = 0; i < entry; i++) // loop the error table to match the minor
                {
                    if (g_email_err_tbl[i].err_no == minor)
                    {
                        return g_email_err_tbl[i].str_id;
                    }
                }

                WARRING();
                return STR_EMAIL_ERROR_CODE_OPT_FAIL_ID;
            }
        case SRV_EMAIL_SOCKET_ERROR:
#ifdef __SSL_SUPPORT__
        case SRV_EMAIL_TLS_ERROR:
#endif
            return STR_EMAIL_ERROR_CODE_NETWORK_ID;
        case SRV_EMAIL_FS_ERROR:
        case SRV_EMAIL_RESULT_FS_ERROR:
            return srv_fmgr_fs_error_get_string(minor);
        case SRV_EMAIL_DRM_ERROR:
        default:
            WARRING();
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_UTIL_GET_ERR_CODE, __LINE__);
            return STR_EMAIL_ERROR_CODE_OPT_FAIL_ID;
    }
}


void mmi_email_util_display_error_popup(mmi_id grp_id, S32 error_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
   

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_UTIL_DISPLAY_ERROR_POPUP, error_id);
    mmi_email_lib_error_popup(mmi_email_util_get_error_string_id(error_id));
}


U16 mmi_email_util_get_error_string_id(S32 error_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S16 i = 0, entry = 0;
    U16 str_id = STR_GLOBAL_CURRENTLY_NOT_AVAILABLE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_UTIL_GET_ERROR_STRING_ID, error_id);
    if (error_id == SRV_EMAIL_RESULT_FS_ERROR)
    {
        str_id = (U16)srv_fmgr_fs_error_get_string(srv_email_errno_get());
    }
    else
    {
        entry = sizeof(g_email_err_tbl) / sizeof(email_app_err_string_struct);
        for (i = 0; i < entry - 1; i++)
        {
            if (g_email_err_tbl[i].err_no == error_id)
            {
                str_id = g_email_err_tbl[i].str_id;
            }
        }
    }

    if (str_id == STR_EMAIL_ERROR_CODE_OPT_FAIL_ID)
    {
        WARRING();
    }

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_UTIL_GET_ERROR_STRING_ID, str_id);
    return str_id;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_util_display_popup
 * DESCRIPTION
 *  Call DisplayPopup function and turn on back light
 * PARAMETERS
 *  string          [IN]    Char array of string
 *  event           [IN]    the event ID for image and tone
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_email_util_display_popup(
                mmi_id grp_id,
                CHAR *string,
                mmi_event_notify_enum event)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_UTIL_DISPLAY_POPUP, __LINE__);
    mmi_email_util_display_popup_ext(
        grp_id,
        NULL,
        (WCHAR*)string,
        event);
}


void mmi_email_util_display_popup_ext(
        mmi_id grp_id,
        mmi_proc_func func,
        WCHAR *string,
        mmi_event_notify_enum event)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_popup_property_struct property;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_UTIL_DISPLAY_POPUP_EXT, grp_id);

    mmi_popup_property_init(&property);
    if (grp_id == 0)
    {
        property.parent_id = GRP_ID_ROOT;
    }
    else
    {
        property.parent_id = grp_id;
    }
    property.callback = func;
    mmi_popup_display(
        string,
        event,
        &property);
}


void mmi_email_util_display_confirm(
                mmi_id grp_id,
                FuncPtr lsk_func,
                FuncPtr rsk_func,
                mmi_proc_func func,
                BOOL is_map_csk,
                CHAR *string,
                mmi_event_notify_enum event)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_UTIL_DISPLAY_CONFIRM, grp_id);
    mmi_email_util_display_confirm_ext(
        grp_id,
        lsk_func,
        rsk_func,
        NULL,
        func,
        is_map_csk,
        string,
        event);
}


void mmi_email_util_display_confirm_ext(
                mmi_id grp_id,
                FuncPtr lsk_func,
                FuncPtr rsk_func,
                FuncPtr interrupt_func,
                mmi_proc_func func,
                BOOL is_map_csk,
                CHAR *string,
                mmi_event_notify_enum event)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_confirm_property_struct property;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_UTIL_DISPLAY_CONFIRM_EXT, grp_id);

    mmi_confirm_property_init(&property, CNFM_TYPE_YESNO);
    if (grp_id == 0)
    {
        property.parent_id = GRP_ID_ROOT;
    }
    else
    {
        property.parent_id = grp_id;
    }
    if (func)
    {
        property.callback = func;
    }
    else
    {
        property.callback = mmi_email_general_cnf_cb;
    }
    if (!is_map_csk)
    {
        property.f_auto_map_empty_softkey = 0;
    }

    if (rsk_func == NULL)
    {
        rsk_func = mmi_frm_scrn_close_active_id;
    }

    email_confirm_lsk_func = lsk_func;
    email_confirm_rsk_func = rsk_func;
    email_confirm_interrupt_func = interrupt_func;
    mmi_confirm_display(
        (WCHAR*)string,
        event,
        &property);
}


static mmi_ret mmi_email_general_cnf_cb(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_alert_result_evt_struct *alert_result_evt = (mmi_alert_result_evt_struct*)evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_GENERAL_CNF_CB, __LINE__);

    if (alert_result_evt->evt_id == EVT_ID_ALERT_QUIT)
    {
        switch (alert_result_evt->result)
        {
            case MMI_ALERT_CNFM_YES:
                (*email_confirm_lsk_func)();
                break;

            case MMI_ALERT_CNFM_NO:
                (*email_confirm_rsk_func)();
                break;

            case MMI_ALERT_CNFM_CANCEL:
                if (email_confirm_interrupt_func)
                {
                    (*email_confirm_interrupt_func)();
                }
                break;

            case MMI_ALERT_INTERRUPT_EXIT:
                if (email_confirm_interrupt_func)
                {
                    (*email_confirm_interrupt_func)();
                }
                break;
        }
    }

    return MMI_RET_OK;
}


srv_email_result_enum mmi_email_get_acct_del_opt(
                        EMAIL_ACCT_ID acct_id,
                        EMAIL_ACCT_HANDLE acct_handle,
                        srv_email_delete_option_enum *del_opt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    EMAIL_ACCT_HANDLE handle = 0;
    srv_email_acct_info_struct *acct_info = NULL;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!acct_handle)
    {
        result = srv_email_acct_create(
                    0,
                    &handle);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            *del_opt = SRV_EMAIL_DELETE_ALWAYS_ASK;
            return result;
        }
        result = srv_email_acct_open(handle, acct_id);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            srv_email_acct_destroy(handle);
            *del_opt = SRV_EMAIL_DELETE_ALWAYS_ASK;
            return result;
        }
    }
    else
    {
        handle = acct_handle;
    }
    acct_info = OslMalloc(sizeof(srv_email_acct_info_struct));
    result = srv_email_acct_read(handle, acct_info);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        OslMfree(acct_info);
        if (handle != acct_handle)
        {
            srv_email_acct_destroy(handle);
        }
        *del_opt = SRV_EMAIL_DELETE_ALWAYS_ASK;
        return result;
    }
    if (handle != acct_handle)
    {
        srv_email_acct_destroy(handle);
    }
    *del_opt = acct_info->delete_option;
    OslMfree(acct_info);
    return SRV_EMAIL_RESULT_SUCC;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_util_chk_addr
 * DESCRIPTION
 *  To check if an email address is valid (contains '@' character *).
 * PARAMETERS
 *  mailAddr        [IN]        Address to be checked (in UCS).
 * RETURNS
 *  TRUE if valid; otherwise FALSE.
 *****************************************************************************/
BOOL mmi_email_util_chk_addr(WCHAR *mailAddr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return (BOOL)applib_is_valid_email_address_unicode((kal_wchar *)mailAddr);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_util_is_server_vaild
 * DESCRIPTION
 *  Check if the server address is begin with '.'
 * PARAMETERS
 *  server        [IN]        String to be check
 * RETURNS
 *  TRUE if username is valid; otherwise, FALSE
 *****************************************************************************/
BOOL mmi_email_util_is_server_vaild(CHAR *server)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    kal_bool ip_validity = KAL_FALSE;
    kal_uint8 ip_addr[4];
    kal_char in_server[(SRV_EMAIL_MAX_SERVER_NAME_LEN + 1)];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(server[0] == '.' && server[1] == '\0')
    {
        return FALSE;
    }
    mmi_ucs2_to_asc(in_server, server);
    if ((soc_ip_check(in_server, ip_addr, &ip_validity) == TRUE) && (ip_validity == FALSE))
    {
        return FALSE;
    }

    return TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_util_is_username_vaild
 * DESCRIPTION
 *  Check if the user name is all ASCII
 * PARAMETERS
 *  username        [IN]        String to be check
 * RETURNS
 *  TRUE if username is valid; otherwise, FALSE
 *****************************************************************************/
BOOL mmi_email_util_is_username_vaild(CHAR *username)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    while (!((*username == 0) && (*(username + 1) == 0)))
    {
        if (username[0] != 0 && username[1] != 0)
        {
            return FALSE;
        }

        if (username[0] < 0x20  || username[1] > 0x7E)
        {
            return FALSE;
        }

        username += 2;
    }

    return TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_util_get_num_len
 * DESCRIPTION
 *  Compute the length of an integer.
 * PARAMETERS
 *  number      [IN]        Number to be computed.
 * RETURNS
 *  the length of the number.
 *****************************************************************************/
S32 mmi_email_util_get_num_len(U32 number)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 len;
    WCHAR *asciiMaxString = OslMalloc(MMI_EMAIL_MAX_DWNL_LEN * 2 + 2);

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    kal_wsprintf(asciiMaxString, "%d", number);
    len = mmi_wcslen(asciiMaxString);
    OslMfree(asciiMaxString);
    return len;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_wizard_get_default_server
 * DESCRIPTION
 *  get default server address from email address
 * PARAMETERS
 *  
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_email_util_get_default_server(WCHAR *p_email_addr, WCHAR *p_server_buf)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    WCHAR *p = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    p = mmi_wcschr((const WCHAR*)p_email_addr, L'@');
    if (NULL == p)  /* should not occur */
    {
    }
    else
    {
        if (mmi_wcslen(p) > SRV_EMAIL_MAX_SERVER_NAME_LEN)
        {
            mmi_wcsncpy(p_server_buf, p, SRV_EMAIL_MAX_SERVER_NAME_LEN);
            p_server_buf[SRV_EMAIL_MAX_SERVER_NAME_LEN] = 0;
        }
        else
        {
            mmi_wcscpy(p_server_buf, p);
        }
        /* replace '@' by '.' */    // replace the fist char, maybe not {@}
        p_server_buf[0] = '.';
    }
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_wizard_get_default_user_name
 * DESCRIPTION
 *  get default user name from email address
 * PARAMETERS
 *  
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_email_util_get_default_user_name(WCHAR *p_email_addr, WCHAR *p_name_buf)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    WCHAR *p = NULL;
    U32 length = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    p = mmi_wcschr(p_email_addr, L'@');
    if (p == NULL) /* should not occur */
    {
    }
    else
    {
        length = p - p_email_addr;
        if (length > SRV_EMAIL_MAX_USERNAME_LEN)
        {
            length = SRV_EMAIL_MAX_USERNAME_LEN;
        }
        mmi_wcsncpy(p_name_buf, p_email_addr, length);
    }
    return;
}


WCHAR *mmi_email_get_file_ext(WCHAR *file_name)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 length = 0;
    WCHAR *file_ptr = NULL;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    length = mmi_wcslen(file_name);
    if (length) /* in case empty filename */
    {
        --length;
        
        if (file_name[0] == L'.')
        {
            return file_name;
        }
        // could use {mmi_wcsstr}
        while (length)
        {
            if (file_name[length] == L'.')
            {
                break;
            }
            else
            {
                length -= 1;
            }
        }
        
        if (length) /* in case no file extension */
        {
            file_ptr = file_name + length;
        }
    }
    
    return file_ptr;
}


void mmi_email_util_get_mine_type(WCHAR *filename, S32 *mime_type, S32 *mime_subtype)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    WCHAR *fileExtPtr = mmi_email_get_file_ext(filename);
    CHAR *fileExt = OslMalloc((SRV_FMGR_PATH_MAX_FILE_EXT_LEN + 1) * ENCODING_LENGTH);
    S32 extLen = 0;
    applib_mime_type_struct *mimeTypePtr = NULL;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(fileExt, 0, (SRV_FMGR_PATH_MAX_FILE_EXT_LEN + 1) * ENCODING_LENGTH);
    if (fileExtPtr)
    {
        /* neglect "." */   // ignore {.} and convert to {ASCII}
        fileExtPtr = fileExtPtr + 1;
        extLen = (((SRV_FMGR_PATH_MAX_FILE_EXT_LEN + 1) > (mmi_wcslen(fileExtPtr))) ? (mmi_wcslen(fileExtPtr)) : (SRV_FMGR_PATH_MAX_FILE_EXT_LEN + 1)); 
        mmi_ucs2_n_to_asc(fileExt, (CHAR*)fileExtPtr, (U32)(extLen * ENCODING_LENGTH));
    }
    if (strlen(fileExt))
    {
        mimeTypePtr = applib_mime_type_look_up(NULL, fileExt, MIME_TYPE_NONE, MIME_SUBTYPE_NONE);
    }
    if (mimeTypePtr != NULL)
    {
        *mime_type = mimeTypePtr->mime_type;
        *mime_subtype = mimeTypePtr->mime_subtype;
    }
    else
    {
        *mime_type = MIME_TYPE_UNKNOWN;
        *mime_subtype = MIME_SUBTYPE_UNRECOGNIZED;
    }
    OslMfree(fileExt);
}


#ifdef __DRM_SUPPORT__
BOOL mmi_email_drm_is_file_lock(WCHAR* file_name, BOOL *is_drm_file)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 method = DRM_METHOD_NONE;
    FS_HANDLE handle;
    BOOL can_fwd = FALSE;
    BOOL temp_is_drm_file = FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    handle = DRM_open_file((PU16)file_name, FS_READ_ONLY | FS_OPEN_SHARED, DRM_PERMISSION_NONE);
    if (handle >= FS_NO_ERROR)
    {
        if ((method = DRM_get_object_method(handle, NULL)) == DRM_METHOD_NONE)
        {
            /* non DRM file, can forward to anywhere */
            can_fwd = TRUE;
            temp_is_drm_file = FALSE;
        }
        else
        {
            if (method & DRM_METHOD_V2)
            {
                can_fwd = TRUE;
                temp_is_drm_file = FALSE;
            }
            else
            {
                temp_is_drm_file = TRUE;

                if (method & DRM_METHOD_SEPARATE_DELIVERY)
                {
                    can_fwd = TRUE;
                }
                else
                {
                    can_fwd = FALSE;
                }
            }
        }
        DRM_close_file(handle);
    }
    else
    {
        can_fwd = FALSE;
        /* CD or FL without right */
        if (handle == DRM_RESULT_NO_PERMISSION)
        {
            temp_is_drm_file = TRUE;
        }
        else
        {
            temp_is_drm_file = FALSE;
        }
    }
    if (is_drm_file != NULL)
    {
        *is_drm_file = temp_is_drm_file;
    }
    return can_fwd;
}
#endif /* __DRM_SUPPORT__ */ 


srv_email_result_enum mmi_email_util_get_fldr_id_by_acct(
                        EMAIL_ACCT_ID acct_id,
                        S32 count,
                        S32 *folder_type,
                        EMAIL_FLDR_ID *fldr_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    EMAIL_ACCT_HANDLE acct_handle = 0;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    S32 fldr_count = 1;
    S32 index = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    result = srv_email_acct_create(0, &acct_handle);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        return result;
    }
    result = srv_email_acct_open(acct_handle, acct_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        srv_email_acct_destroy(acct_handle);
        return result;
    }
    for (; index < count; index++)
    {
        result = srv_email_acct_get_fldr_id(
                    acct_handle,
                    SRV_EMAIL_ACCT_FLDR_TYPE_BASIC,
                    folder_type[index],
                    &fldr_count,
                    &(fldr_id[index]));
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            srv_email_acct_destroy(acct_handle);
            return result;
        }
    }
    srv_email_acct_destroy(acct_handle);
    return SRV_EMAIL_RESULT_SUCC;
}


/*****************************************************************************
* FUNCTION
*  mmi_email_uti_strnicmp
* DESCRIPTION
*  Compare two string without regarding upper/lower case
* PARAMETERS
*  first       [IN]        First string
*  last        [IN]        Last string
*  length      [IN]        Maximum number of characters to compare
* RETURNS
*  returns <0 if first < last
*  returns 0 if first == last
*  returns >0 if first > last
*****************************************************************************/
S32 mmi_email_uti_strnicmp(char *first, char *last, S32 length)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 ch1, ch2;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (length)
    {
        do
        {
            if (
                ((ch1 = (U8)(*(first++))) >= 'A') &&
                (ch1 <= 'Z')
                )
            {
                ch1 -= 'A' - 'a';
            }
            if (
                ((ch2 = (U8)(*(last++))) >= 'A') &&
                (ch2 <= 'Z')
                )
            {
                ch2 -= 'A' - 'a';
            }
        } while (--length && ch1 && (ch1 == ch2));
        return (ch1 - ch2);
    }

    return 0;
}


/*****************************************************************************
* FUNCTION
*  mmi_email_util_chk_addr_ex
* DESCRIPTION
*  To check if an email address is valid (contains '@' character *).
*  ignore blank space and change the source string
* PARAMETERS
*  mailAddr        [IN]        Address to be checked (in UCS).
* RETURNS
*  TRUE if valid; otherwise FALSE.
*****************************************************************************/
BOOL mmi_email_util_chk_addr_ex(WCHAR *mailAddr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 i = 0, j = 0;
    WCHAR *temp_str = NULL;
    BOOL has_space = FALSE;
    U32 src_len = mmi_wcslen(mailAddr);
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    temp_str = OslMalloc((src_len + 1) * sizeof(WCHAR*));
    memset(temp_str, 0, (src_len + 1) * sizeof(WCHAR*));
    for (; i < src_len; )
    {
        if (!(mailAddr[i] == L' '))
        {
            temp_str[j] = mailAddr[i];
            j += 1;
        }
        else
        {
            has_space = TRUE;
        }
        i += 1;
    }
    if (has_space)
    {
        mmi_wcscpy(mailAddr, temp_str);
    }
    OslMfree(temp_str);
    return (BOOL)applib_is_valid_email_address_unicode((kal_wchar*)mailAddr);
}


#ifdef __DRM_SUPPORT__
/*****************************************************************************
* FUNCTION
*  mmi_email_request_rights
* DESCRIPTION
*  Request rights from WAP browser for DRM
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
void mmi_email_request_rights(void)
{
#ifdef BROWSER_SUPPORT
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    WCHAR temp[DRM_MAX_URL_LENGTH] = {0};

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_REQUEST_RIGHTS, 1);
    mmi_asc_n_to_wcs(temp, rights_issuer, strlen(rights_issuer));
    wap_start_browser(WAP_BROWSER_GOTO_URL, (const kal_uint8*)temp);
#else
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_REQUEST_RIGHTS, 2);
    mmi_frm_scrn_close_active_id();
#endif
}
#endif /* __DRM_SUPPORT__ */


void mmi_email_reset_storage_loading(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_RESET_STORAGE_LOADING, 1);
    if (!mmi_frm_scrn_enter(
            GRP_ID_ROOT,
            SCR_EMAIL_LOADING_ID,
            NULL,
            mmi_email_reset_storage_loading,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_RESET_STORAGE_LOADING, 2);
        return;
    }
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_RESET_STORAGE_LOADING, 3);
    ShowCategory66Screen(
        STR_GLOBAL_EMAIL,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        0,
        0,
        0,
        0,
        (U8*)GetString(STR_GLOBAL_LOADING),
        mmi_email_lib_get_progress_img_id(),
        NULL);
    SetLeftSoftkeyFunction(NULL, KEY_EVENT_UP);
    SetRightSoftkeyFunction(NULL, KEY_EVENT_UP);
    SetKeyHandler(NULL, KEY_END, KEY_EVENT_DOWN);
}

void mmi_email_exit_app_by_asm(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_EXIT_APP_BY_ASM, __LINE__);

    mmi_email_reset_curr_fldr_info();
    if (mmi_email_get_main_group_id() != 0)
    {
        mmi_frm_group_close(mmi_email_get_main_group_id());
    }

    mmi_email_comp_asm_stop();
    mmi_email_read_asm_stop();
}


BOOL mmi_email_check_show_idle_data(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __OP12__
    if (srv_email_get_srv_init_state() == SRV_EMAIL_INIT_STATE_READY &&
        mmi_email_vf_get_flag() &&
        mmi_email_get_unread_count())
    {
        email_idle_data |= EMAIL_IDLE_VF_LIST;
    }
#endif

    return ((email_idle_data == EMAIL_IDLE_NONE) ? FALSE : TRUE);
}


void mmi_email_show_idle_data(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __OP12__
    if (email_idle_data & EMAIL_IDLE_VF_LIST)
    {
        mmi_frm_nmgr_notify_by_idle(MMI_SCENARIO_ID_NEW_EMAIL, MMI_EVENT_EMAIL, NULL);
    }
#endif
    email_idle_data = EMAIL_IDLE_NONE;
}


void mmi_email_acct_del_notify(EMAIL_ACCT_ID acct_id)
{
#if defined( __MMI_OP11_HOMESCREEN_0301__) || defined(__MMI_OP11_HOMESCREEN_0302__)
    mmi_email_hs_remove_shct_acct_by_id(acct_id);
#endif /* defined( __MMI_OP11_HOMESCREEN_0301__) || defined(__MMI_OP11_HOMESCREEN_0302__) */
}


void mmi_email_display_app_core_popup(mmi_id group_id, mmi_email_app_core_result_enum app_core_result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S16 i = 0, entry = 0;
    U16 str_id = STR_EMAIL_ERROR_CODE_OPT_FAIL_ID;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_DISPLAY_APP_CORE_POPUP, app_core_result);

    entry = sizeof(g_email_app_core_err_tbl) / sizeof(email_app_err_string_struct);
    for (i = 0; i < entry; i++)
    {
        if (g_email_app_core_err_tbl[i].err_no == app_core_result)
        {
            str_id = g_email_app_core_err_tbl[i].str_id;
        }
    }

    mmi_email_lib_error_popup(str_id);
}


MMI_BOOL mmi_email_play_tone_dummy_entry_func(mmi_scenario_id scen_id, void *arg)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return MMI_TRUE;
}



void mmi_email_util_play_receive_tone(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_UTIL_PLAY_RECEIVE_TONE, __LINE__);
    mmi_email_nmgr_play_tone();
}


void mmi_email_copy_file_to_view(mmi_id grp_id, WCHAR *file_path, WCHAR *file_ext, mmi_email_copy_file_to_view_callback callback)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    CHAR drive = srv_email_get_drive();
    S32 attr = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COPY_FILE_TO_VIEW, __LINE__);

    copy_file_dst_path = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(WCHAR));
    memset(copy_file_dst_path, 0, (SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(WCHAR));
    kal_wsprintf(copy_file_dst_path, "%scopy_file\\attach%w", srv_email_get_root_path(), file_ext);
    attr = FS_GetAttributes((const WCHAR*)copy_file_dst_path);
    if (attr & FS_ATTR_READ_ONLY)
    {
        FS_SetAttributes((const WCHAR*)copy_file_dst_path, (U8)(attr & ~(FS_ATTR_READ_ONLY)));
    }
    FS_Delete((U16*)copy_file_dst_path);
    attach_copy_job_id =
        srv_fmgr_async_copy(
            file_path,
            copy_file_dst_path,
            0,
            mmi_email_copy_file_to_view_copy_callback,
            NULL);
    if (attach_copy_job_id > 0)
    {
        attach_copy_parent_id = grp_id;
        copy_file_callback = callback;
        mmi_email_copy_file_loading();
    }
    else
    {
        mmi_email_util_display_popup(
            0,
            GetString((U16)srv_fmgr_fs_error_get_string(attach_copy_job_id)),
            MMI_EVENT_FAILURE);
        OslMfree(copy_file_dst_path);
        copy_file_dst_path = NULL;
    }
}


static void mmi_email_copy_file_loading(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COPY_FILE_LOADING, __LINE__);

    if (!mmi_frm_scrn_enter(
            attach_copy_parent_id,
            SCR_ID_EMAIL_READ_ATTCH_SAVE,
            NULL,
            mmi_email_copy_file_loading,
            MMI_FRM_FULL_SCRN))
    {
        return;
    }
    ShowCategory66Screen(
        STR_GLOBAL_EMAIL,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        0,
        0,
        0,
        0,
        (U8*)GetString(STR_GLOBAL_LOADING),
        mmi_email_lib_get_progress_img_id(),
        NULL);
    SetLeftSoftkeyFunction(NULL, KEY_EVENT_UP);
    SetRightSoftkeyFunction(NULL, KEY_EVENT_UP);
    mmi_frm_scrn_set_leave_proc(
        attach_copy_parent_id,
        SCR_ID_EMAIL_READ_ATTCH_SAVE,
        mmi_email_copy_file_del_callback);
}


static mmi_ret mmi_email_copy_file_del_callback(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COPY_FILE_DEL_CALLBACK, __LINE__);

    switch (evt->evt_id)
    {
        case EVT_ID_SCRN_GOBACK_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ:
        case EVT_ID_SCRN_GOBACK:
            if (attach_copy_job_id)
            {
                srv_fmgr_async_abort(
                    attach_copy_job_id,
                    MMI_TRUE);
            }
            attach_copy_job_id = 0;
            copy_file_callback = NULL;
            if (copy_file_dst_path)
            {
                OslMfree(copy_file_dst_path);
                copy_file_dst_path = NULL;
            }
            break;
    }
    return MMI_RET_OK;
}


static mmi_ret mmi_email_copy_file_to_view_copy_callback(mmi_event_struct *param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_fmgr_async_done_event_struct *async_evt;
    BOOL is_exit = FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_COPY_FILE_TO_VIEW_COPY_CALLBACK, __LINE__);

    switch (param->evt_id)
    {
        case EVT_ID_SRV_FMGR_ASYNC_DONE:
            {
                async_evt = (srv_fmgr_async_done_event_struct*)param;
                if (mmi_frm_scrn_get_active_id() != SCR_ID_EMAIL_READ_ATTCH_SAVE)
                {
                    if (!mmi_frm_group_is_present(attach_copy_parent_id))
                    {
                        is_exit = TRUE;
                    }
                }
                if (!is_exit)
                {
                    if (async_evt->result == 0)
                    {
                        (*copy_file_callback)(copy_file_dst_path);
                    }
                    else
                    {
                        mmi_email_util_display_popup(
                            attach_copy_parent_id,
                            GetString((U16)srv_fmgr_fs_error_get_string(async_evt->result)),
                            MMI_EVENT_FAILURE);
                    }
                }
                attach_copy_job_id = 0;
                copy_file_callback = NULL;
                if (copy_file_dst_path)
                {
                    OslMfree(copy_file_dst_path);
                    copy_file_dst_path = NULL;
                }
                mmi_frm_scrn_close(attach_copy_parent_id, SCR_ID_EMAIL_READ_ATTCH_SAVE);
            }
            break;
    }
    return MMI_RET_OK;
}

// need modified, refer {srv_email_util_dir_exist}
MMI_BOOL mmi_email_util_dir_exist(const WCHAR *path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    FS_HANDLE handle;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    handle = FS_Open(path, FS_OPEN_DIR | FS_READ_ONLY);
    if (handle >= FS_NO_ERROR)
    {
        FS_Close(handle);
        return MMI_TRUE;
    }
    return MMI_FALSE;
}

// for attach temp file
void mmi_email_init_copy_file_dir(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    CHAR drive = srv_email_get_drive();
    WCHAR *dir_path;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    dir_path = OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1) * sizeof(WCHAR));
    kal_wsprintf(dir_path, "%scopy_file\\", srv_email_get_root_path());
    if (!mmi_email_util_dir_exist(dir_path))
    {
        FS_CreateDir(dir_path);
    }
    OslMfree(dir_path);
}

// check MSG's validity from Storage
BOOL mmi_email_check_msg_valid(EMAIL_MSG_ID msg_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL is_valid = MMI_FALSE;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    result = srv_email_msg_check_valid(msg_id, &is_valid);
    if (result != SRV_EMAIL_RESULT_SUCC || !is_valid)
    {
        return FALSE;
    }
    return TRUE;
}

static WCHAR* mmi_email_batch_file_get_name(void)
{
    static WCHAR filename[32];

    kal_wsprintf(filename, "%slastnewmailnoti", srv_email_get_root_path());

    return filename;
}

static void mmi_email_batch_file_read(void)
{
#ifdef __MMI_NCENTER_SUPPORT__
    FS_HANDLE h = 0;

    memset(&g_receive_list, 0, sizeof(mmi_email_batch_receive_result_queue_struct));
    h = FS_Open(mmi_email_batch_file_get_name(), FS_READ_ONLY);
    if (h < 0)
    {
        return;
    }

    FS_Read(h, &g_receive_list, sizeof(mmi_email_batch_receive_result_queue_struct), NULL);
    FS_Close(h);
#endif /* #ifdef __MMI_NCENTER_SUPPORT__ */

}

static void mmi_email_batch_file_write(void)
{
#ifdef __MMI_NCENTER_SUPPORT__
    FS_HANDLE h = 0;
    h = FS_Open(mmi_email_batch_file_get_name(), FS_READ_WRITE | FS_CREATE_ALWAYS);
    if (h < 0)
    {
        return;
    }

    FS_Write(h, &g_receive_list, sizeof(mmi_email_batch_receive_result_queue_struct), NULL);
    FS_Close(h);
#endif /* __MMI_NCENTER_SUPPORT__ */
}

static void mmi_email_nc_restore(void)
{
#ifdef __MMI_NCENTER_SUPPORT__
    mmi_email_batch_file_read();

    g_receive_list.emn_group_id = 0;
    g_receive_list.emn_error_grp_id = 0;
    g_receive_list.has_new_emn_notify = (MMI_BOOL)0;
    g_receive_list.emn_screen_memory_ptr = NULL;
    g_receive_list.highlight_account_index = 0;
    g_receive_list.last_error_acc_id = 0;
    g_receive_list.last_error_code = 0;

    mmi_email_ncenter_newmail(get_total_received_number());
#endif /* __MMI_NCENTER_SUPPORT__ */
}



void mmi_email_batch_receive_init(void)
{
    g_receive_list.result_num = 0;
    g_receive_list.emn_screen_memory_ptr = NULL;

#ifdef __MMI_NCENTER_SUPPORT__
    mmi_email_nc_restore();
    mmi_email_ncenter_restore_error();
#endif
}

void mmi_email_batch_receive_report(mmi_email_batch_receive_result_struct *ret, MMI_BOOL working)
{
    S32 i = 0;
    WCHAR acct_name[SRV_EMAIL_MAX_ACCT_NAME_LEN + 1];

    MMI_TRACE(
        MMI_INET_TRC_G9_EMAIL,
        MMI_EMAIL_RECEIVE_EMN_RESULT_HANDLER_LOG3, 
        g_receive_list.result_num,
        ret->result,
        ret->unread_count,
        ret->total_count,
        ret->error_code,
        ret->acct_id);

    acct_name[0] = 0;
    if ((srv_email_acct_get_name(ret->acct_id, acct_name, SRV_EMAIL_MAX_ACCT_NAME_LEN) != SRV_EMAIL_RESULT_SUCC)
        || acct_name[0] == 0)
    {
        return;
    }

    if (!ret->result)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_BATCH_RECEIVE_REPORT, 2);

        g_receive_list.last_error_acc_id = ret->acct_id;
        g_receive_list.last_error_code = ret->error_code;

#ifdef __MMI_NCENTER_SUPPORT__
        mmi_email_ncenter_error(ret->acct_id, ret->error_code);
#else /* __MMI_NCENTER_SUPPORT__ */
        mmi_email_nmgr_show_error();
#endif /* __MMI_NCENTER_SUPPORT__ */
    }

    if (ret->total_count == 0)
    {
        return;
    }

    if (working)
    {
        // Only play tone if user is in current account
        mmi_email_util_play_receive_tone();
        return;
    }

    MMI_ASSERT(g_receive_list.result_num < MMI_EMAIL_MAX_ACCTS);
    for (i = 0; i < g_receive_list.result_num; i++)
    {
        if (g_receive_list.receive_result_array[i].acct_id == ret->acct_id)
        {
            g_receive_list.receive_result_array[i].unread_count += ret->unread_count;
            g_receive_list.receive_result_array[i].total_count += ret->total_count;

            g_receive_list.receive_result_array[i].result = ret->result;
            g_receive_list.receive_result_array[i].error_code = ret->error_code;
            break;
        }
    }

    if (i == g_receive_list.result_num)
    {
        memcpy(
            &g_receive_list.receive_result_array[g_receive_list.result_num],
            ret,
            sizeof(mmi_email_batch_receive_result_struct));
        g_receive_list.result_num++;
    }

    mmi_email_nmgr_show_newmail();

#ifdef __MMI_NCENTER_SUPPORT__
    //mmi_email_util_play_receive_tone();
    mmi_email_ncenter_newmail(get_total_received_number());
    mmi_email_batch_file_write();
#endif /* __MMI_NCENTER_SUPPORT__ */
}

// Deinit
void mmi_email_close_nmgr_screen(void)
{

    mmi_frm_scrn_close(g_receive_list.emn_group_id, SCR_ID_EMAIL_EMN_LIST);
    mmi_frm_scrn_close(g_receive_list.emn_error_grp_id, SCR_ID_EMAIL_EMN_ERROR);

    mmi_email_nmgr_cancel_newmail();

#ifndef __MMI_NCENTER_SUPPORT__
    mmi_email_nmgr_cancel_error();
#endif /* __MMI_NCENTER_SUPPORT__ */
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_emn_nmgr_query
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_email_emn_nmgr_query(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_nmgr_info_struct info;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_EMN_NMGR_QUERY, __LINE__);

    info.idle_text1 = GetString(STR_EMAIL_EMN_NEW_EMAIL_ID);
    info.idle_text2 = NULL;
    info.image = IMG_EMAIL_EMN_IDLE_NOTIFY_ID;
    info.left_softkey = STR_GLOBAL_VIEW;
    info.user_data = NULL;
    /* misc */
    info.icon = 0;
    info.total_num = 1;

    mmi_nmgr_answer(
        MMI_NMGR_APP_EMAIL,
        (g_receive_list.result_num == 0) ? (MMI_NMGR_RESULT_NOT_READY) : (MMI_NMGR_RESULT_OK),
        &info,
        mmi_email_nmgr_emn_view);
}


static S32 get_total_received_number(void)
{
    S32 i, total = 0;

    for (i = 0; i < g_receive_list.result_num; i++)
    {
        total += g_receive_list.receive_result_array[i].total_count;
    }

    return total;
}

void remove_all_received_number(void)
{
    S32 i;

    for (i = 0; i < g_receive_list.result_num; i++)
    {
        memset(&g_receive_list.receive_result_array[i], 0, sizeof(mmi_email_batch_receive_result_struct));
    }

    mmi_email_emn_set_new_emn_notify_flag(MMI_FALSE);
    mmi_email_nmgr_cancel_newmail();

#ifdef __MMI_NCENTER_SUPPORT__
    mmi_email_batch_file_write();
#endif /* __MMI_NCENTER_SUPPORT__ */
}


void mmi_email_cmcc_new_email_hdlr(void)
{
    reenter_by_cmcc = MMI_TRUE;


#ifdef __MMI_EMAIL_OTAP__
    // close OTAP screen
    mmi_email_otap_deinit();
#endif /* __MMI_EMAIL_OTAP__ */

    // Close native screen
    mmi_email_reset_curr_comp_info();
    mmi_email_reset_curr_fldr_info();
    mmi_email_reset_curr_read_info();

    if (mmi_email_get_main_group_id() != 0)
    {
        mmi_frm_group_close(mmi_email_get_main_group_id());
    }

    reenter_by_cmcc = MMI_FALSE;

    mmi_email_nmgr_emn_view(NULL);
}

/*****************************************************************************
 * FUNCTION
 *  mmi_email_nmgr_emn_view
 * DESCRIPTION
 *  Handler of EMN notification screen to view Emails
 * PARAMETERS
 *  user_data       [IN]
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_email_nmgr_emn_view(void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(
        MMI_INET_TRC_G9_EMAIL,
        MMI_EMAIL_NMGR_EMN_VIEW_LOG1, 
        g_receive_list.result_num,
        g_receive_list.receive_result_array[0].acct_id);
    mmi_email_emn_set_new_emn_notify_flag(MMI_FALSE);

    if (g_receive_list.result_num == 0)
    {
        mmi_email_dummy_refresh(NULL);
    }
    else if(g_receive_list.result_num > 1)
    {
        mmi_email_emn_entry_list();
    }
    else
    {
        mmi_email_app_entry_inbox_by_acct(g_receive_list.receive_result_array[0].acct_id);
        g_receive_list.result_num = 0;
#ifdef __MMI_NCENTER_SUPPORT__
        mmi_email_batch_file_write();
#endif /* #ifdef __MMI_NCENTER_SUPPORT__ */
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_emn_entry_list_group_proc
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  void
 *****************************************************************************/
static mmi_ret mmi_email_emn_entry_list_group_proc(mmi_event_struct *p_event)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_batch_receive_result_queue_struct *p = NULL;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    p = (mmi_email_batch_receive_result_queue_struct*)p_event->user_data;
    switch (p_event->evt_id)
    {
        case EVT_ID_EMN_LIST_SCREEN_EXIT:
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_EMN_ENTRY_LIST_GROUP_PROC, __LINE__);
            mmi_frm_scrn_close(p->emn_group_id, SCR_ID_EMAIL_EMN_LIST);
            break;

        default:
            break;
    }

    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_emn_entry_list
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_email_emn_entry_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_EMN_ENTRY_LIST, __LINE__);

    mmi_frm_group_close(g_receive_list.emn_group_id);
    g_receive_list.emn_group_id = mmi_frm_group_create(
        GRP_ID_ROOT, 
        GRP_ID_AUTO_GEN, 
        mmi_email_emn_entry_list_group_proc, 
        &g_receive_list);
    mmi_frm_group_enter(g_receive_list.emn_group_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    mmi_frm_scrn_first_enter(
        g_receive_list.emn_group_id, 
        SCR_ID_EMAIL_EMN_LIST, 
        (FuncPtr)mmi_email_emn_entry_list_screen, 
        &g_receive_list);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_emn_entry_list_screen_highlight_handler
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_email_emn_entry_list_screen_highlight_handler(S32 highlight_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_EMN_ENTRY_LIST_SCREEN_HIGHLIGHT_HANDLER_LOG1, highlight_index);
    g_receive_list.highlight_account_index = highlight_index;
    return;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_emn_entry_list_screen
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  mmi_ret
 *****************************************************************************/
static mmi_ret mmi_email_emn_entry_list_screen(mmi_scrn_essential_struct *p_screen_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer = NULL;
    U8 *acct_string[MMI_EMAIL_MAX_ACCTS];
    U8 *unread_error_string[MMI_EMAIL_MAX_ACCTS];
    S32 i = 0, string_len = 0;
    U8 *string_ptr = subMenuData[0];
    U16 icon[MMI_EMAIL_MAX_ACCTS];
    S32 account_number = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_EMN_ENTRY_LIST_SCREEN, 1);
    if (MMI_TRUE == mmi_frm_scrn_enter(
                        p_screen_data->group_id,
                        p_screen_data->scrn_id,
                        (FuncPtr)mmi_email_emn_exit_list_screen,
                        (FuncPtr)mmi_email_emn_entry_list_screen,
                        MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_EMN_ENTRY_LIST_SCREEN, 2);

        guiBuffer = mmi_frm_scrn_get_active_gui_buf();
        
        memset(subMenuData, 0, sizeof(subMenuData));
        g_receive_list.emn_screen_memory_ptr = applib_mem_screen_alloc(MMI_EMAIL_EMN_SCREEN_SIZE);
        MMI_ASSERT(NULL != g_receive_list.emn_screen_memory_ptr);

        if (g_receive_list.result_num > 0)
        {
            for (i = 0; i < g_receive_list.result_num; i++)
            {
                if (SRV_EMAIL_RESULT_SUCC == srv_email_acct_get_name(
                                                g_receive_list.receive_result_array[i].acct_id, 
                                                g_receive_list.emn_screen_memory_ptr + i * (SRV_EMAIL_MAX_ACCT_NAME_LEN + 1), 
                                                (SRV_EMAIL_MAX_ACCT_NAME_LEN + 1)))
                {
                    acct_string[i] = (U8*)(g_receive_list.emn_screen_memory_ptr + i * (SRV_EMAIL_MAX_ACCT_NAME_LEN + 1));
                    
                    if (!g_receive_list.receive_result_array[i].error_code)
                    {
                        kal_wsprintf(
                            (WCHAR*)string_ptr,
                            "%d %w",
                            g_receive_list.receive_result_array[i].unread_count,
                            (WCHAR*)GetString(STR_EMAIL_EMN_UNREAD_ID));
                    }
                    else
                    {
                        kal_wsprintf(
                            (WCHAR*)string_ptr,
                            "%d %w%w%w",
                            g_receive_list.receive_result_array[i].unread_count,
                            (WCHAR*)GetString(STR_EMAIL_EMN_UNREAD_ID),
                            (WCHAR*)GetString(STR_EMAIL_COLON_ID),
                            (WCHAR*)GetString(g_receive_list.receive_result_array[i].error_code));
                    }
                    
                    string_len = mmi_wcslen((WCHAR*)string_ptr);
                    unread_error_string[i] = string_ptr;
                    string_ptr += (string_len + 1) * ENCODING_LENGTH;
                    icon[i] = IMG_EMAIL_EMN_LIST_ID;

                    account_number++;
                }
            }
            
            RegisterHighlightHandler(mmi_email_emn_entry_list_screen_highlight_handler);
            EnableCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
            ShowCategory354Screen(
                (U8*)GetString(STR_GLOBAL_EMAIL),
                GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
                STR_GLOBAL_VIEW,
                IMG_GLOBAL_OK,
                STR_GLOBAL_BACK,
                IMG_GLOBAL_BACK,
                account_number,
                acct_string,
                unread_error_string,
                icon,
                0,
                guiBuffer);
            SetLeftSoftkeyFunction(mmi_email_emn_entry_list_screen_lsk, KEY_EVENT_UP);
            SetRightSoftkeyFunction(mmi_email_emn_entry_list_screen_rsk, KEY_EVENT_UP);
            SetCenterSoftkeyFunction(mmi_email_emn_entry_list_screen_lsk, KEY_EVENT_UP);
        }
        else
        {
            mmi_event_struct evt;
            MMI_FRM_INIT_EVENT(&evt, EVT_ID_EMN_LIST_SCREEN_EXIT);
            MMI_FRM_POST_EVENT(&evt, mmi_email_emn_entry_list_group_proc, p_screen_data->user_data);
        }
    }
    return MMI_RET_OK;
} 


/*****************************************************************************
 * FUNCTION
 *  mmi_email_emn_exit_list_screen
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  mmi_ret
 *****************************************************************************/
static mmi_ret mmi_email_emn_exit_list_screen(mmi_scrn_essential_struct *p_screen_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_EMN_EXIT_LIST_SCREEN, __LINE__);

    if (NULL != g_receive_list.emn_screen_memory_ptr)
    {
        applib_mem_screen_free(g_receive_list.emn_screen_memory_ptr);
        g_receive_list.emn_screen_memory_ptr = NULL;
    }
    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_emn_entry_list_screen_lsk
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_email_emn_entry_list_screen_lsk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    EMAIL_ACCT_ID acc_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_EMN_ENTRY_LIST_SCREEN_LSK, __LINE__);

    acc_id = g_receive_list.receive_result_array[g_receive_list.highlight_account_index].acct_id;
    mmi_email_app_entry_inbox_by_acct(acc_id);
    mmi_email_batch_receive_remove(acc_id);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_emn_entry_list_screen_rsk
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_email_emn_entry_list_screen_rsk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_EMN_ENTRY_LIST_SCREEN_RSK, __LINE__);

    mmi_frm_scrn_close_active_id();
}


static void mmi_email_nmgr_play_tone(void)
{
    static NMGR_HANDLE h;
    mmi_frm_nmgr_alert_struct alert;

    if (h != NULL)
    {
        mmi_frm_nmgr_alert_cancel(h);
    }

    memset(&alert, 0, sizeof(mmi_frm_nmgr_alert_struct));
    alert.app_id = APP_EMAIL;
    alert.scen_id = MMI_SCENARIO_ID_NEW_EMAIL;
    alert.event_type = MMI_EVENT_EMAIL;
    alert.alert_option = MMI_FRM_NMGR_DISABLE_PREVIEW | 
                         MMI_FRM_NMGR_DISABLE_POPUP | 
                         MMI_FRM_NMGR_DISABLE_STATUS_ICON;


    h = mmi_frm_nmgr_alert(&alert);
}


static mmi_ret mmi_email_nmgr_newmail_func(mmi_event_struct *evt)
{
    if (evt->evt_id == EVT_ID_NMGR_TEXT_PREVIEW_APP_LAUNCH ||
        evt->evt_id == EVT_ID_NMGR_POPUP_APP_LAUNCH)
    {
        mmi_email_cmcc_new_email_hdlr();
    }

    return MMI_RET_OK;
}


static void mmi_email_nmgr_show_newmail(void)
{
    mmi_frm_nmgr_alert_struct alert;

    mmi_email_nmgr_cancel_newmail();
    if (get_total_received_number() == 0)
    {
        return;
    }

    memset(&alert, 0, sizeof(mmi_frm_nmgr_alert_struct));

    alert.app_id = APP_EMAIL;
    alert.scen_id = MMI_SCENARIO_ID_NEW_EMAIL;
    alert.event_type = MMI_EVENT_EMAIL;
    alert.ui_mask = MMI_FRM_NMGR_UI_STATUS_ICON_MASK | MMI_FRM_NMGR_UI_STATUS_BAR_MASK | MMI_FRM_NMGR_UI_POPUP_MASK;
    alert.behavior_mask = PREFER_POPUP;
    alert.alert_option = 0;

    alert.status_bar_para.status_bar_type = MMI_FRM_NMGR_ALERT_ST_PREVIEW_TYPE;
    alert.status_bar_para.image_type = MMI_NMGR_IMG_RES_ID;
    alert.status_bar_para.image.id = IMG_SI_NEW_EMAIL;
    alert.status_bar_para.display_string = (WCHAR*)GetString(STR_EMAIL_EMN_NEW_EMAIL_ID);

    alert.popup_para.image_type = MMI_NMGR_IMG_RES_ID;
    alert.popup_para.image.id = IMG_EMAIL_EMN_IDLE_NOTIFY_ID;
    alert.popup_para.popup_type = MMI_FRM_NMGR_ALERT_POPUP_TWO_BUTTON_TYPE;
    alert.popup_para.popup_string = (WCHAR*)GetString(STR_EMAIL_EMN_NEW_EMAIL_ID);
    alert.popup_para.popup_button_string = (WCHAR*)GetString(STR_GLOBAL_VIEW);

    alert.status_bar_icon_para.icon_id = STATUS_ICON_NEW_EMAIL;

    alert.app_proc_para.scrn_group_proc = mmi_email_nmgr_newmail_func;
    alert.app_proc_para.user_data = NULL;
    alert.app_proc_para.data_size = 0;

    g_nmgr_newmail_handler = mmi_frm_nmgr_alert(&alert);
}

static void mmi_email_nmgr_cancel_newmail(void)
{
    if (g_nmgr_newmail_handler != NULL)
    {
        mmi_frm_nmgr_alert_cancel(g_nmgr_newmail_handler);
        g_nmgr_newmail_handler = NULL;
    }
}

#ifndef __MMI_NCENTER_SUPPORT__
static mmi_ret mmi_email_nmgr_error_func(mmi_event_struct *evt)
{
    if (evt->evt_id == EVT_ID_NMGR_ALERT_END)
    {
        // Clear NCetner error item
    }


    return MMI_RET_OK;
}


static void mmi_email_nmgr_show_error(void)
{
    WCHAR txt[64 + 1];
    mmi_frm_nmgr_alert_struct alert;

    // Prepair error string
    txt[0] = 0;
    kal_wstrncat(txt, (WCHAR*)GetString(STR_GLOBAL_EMAIL), 64 - kal_wstrlen(txt));
    kal_wstrncat(txt, (WCHAR*)GetString(STR_EMAIL_COLON_ID), 64 - kal_wstrlen(txt));
    kal_wstrncat(txt, (WCHAR*)GetString(g_receive_list.last_error_code), 64 - kal_wstrlen(txt));

    memset(&alert, 0, sizeof(mmi_frm_nmgr_alert_struct));

    alert.app_id = APP_EMAIL;
    alert.scen_id = MMI_SCENARIO_ID_EMAIL_EMN_INFO;
    alert.event_type = MMI_EVENT_EMAIL;
    alert.ui_mask = MMI_FRM_NMGR_UI_POPUP_MASK;
    alert.behavior_mask = FORCE_POPUP;
    alert.alert_option = 0;

    alert.popup_para.image_type = MMI_NMGR_IMG_RES_ID;
    alert.popup_para.image.id = IMG_EMAIL_EMN_IDLE_NOTIFY_ID;
    alert.popup_para.popup_type = MMI_FRM_NMGR_ALERT_POPUP_ONE_BUTTON_TYPE;
    alert.popup_para.popup_string = txt;
    alert.popup_para.popup_button_string = (WCHAR*)GetString(STR_GLOBAL_OK);

    alert.app_proc_para.scrn_group_proc = mmi_email_nmgr_error_func;
    alert.app_proc_para.user_data = NULL;
    alert.app_proc_para.data_size = 0;

    mmi_email_nmgr_cancel_error();
    g_nmgr_error_handler = mmi_frm_nmgr_alert(&alert);
}

static void mmi_email_nmgr_cancel_error(void)
{
    if (g_nmgr_error_handler != NULL)
    {
        mmi_frm_nmgr_alert_cancel(g_nmgr_error_handler);
        g_nmgr_error_handler = NULL;
    }
}
#endif /* __MMI_NCENTER_SUPPORT__ */

void mmi_email_batch_receive_remove(EMAIL_ACCT_ID acct_id)
{
    S32 i = 0;

    if (reenter_by_cmcc)
    {
        return;
    }

    for (i = 0; i < g_receive_list.result_num; i++)
    {
        if (g_receive_list.receive_result_array[i].acct_id == acct_id)
        {
            break;
        }
    }

    if (i == g_receive_list.result_num)
    {
        // NOT FOUND
        return;
    }

    g_receive_list.result_num--;
    for (; i < g_receive_list.result_num; i++)
    {
        g_receive_list.receive_result_array[i] = 
            g_receive_list.receive_result_array[i + 1];
    }

    if (g_receive_list.result_num == 0)
    {
        mmi_email_emn_set_new_emn_notify_flag(MMI_FALSE);
        mmi_email_nmgr_cancel_newmail();
    }

#ifdef __MMI_NCENTER_SUPPORT__
    mmi_email_ncenter_newmail(get_total_received_number());
    mmi_email_batch_file_write();
#endif /* __MMI_NCENTER_SUPPORT__ */
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_emn_set_new_emn_notify_flag
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_email_emn_set_new_emn_notify_flag(MMI_BOOL flag)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_EMN_SET_NEW_EMN_NOTIFY_FLAG_LOG1, flag);
    g_receive_list.has_new_emn_notify = flag;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_emn_get_new_emn_notify_flag
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
MMI_BOOL mmi_email_emn_get_new_emn_notify_flag(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return g_receive_list.has_new_emn_notify;
}

#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_email_emn_show_error_info_screen
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  mmi_ret
 *****************************************************************************/
static mmi_ret mmi_email_emn_show_error_info_screen(mmi_scrn_essential_struct *p_screen_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer = NULL;
    WCHAR *p_account_name = NULL;
    srv_email_result_enum srv_op_result = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_EMN_SHOW_ERROR_INFO_SCREEN, 1);
    if (MMI_TRUE == mmi_frm_scrn_enter(
                        p_screen_data->group_id,
                        p_screen_data->scrn_id,
                        NULL,
                        (FuncPtr)mmi_email_emn_show_error_info_screen,
                        MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_EMN_SHOW_ERROR_INFO_SCREEN, 2);

        p_account_name = OslMalloc((SRV_EMAIL_MAX_ACCT_NAME_LEN + 1) * sizeof(WCHAR));
        srv_op_result = srv_email_acct_get_name(
                            g_receive_list.last_error_acc_id, 
                            p_account_name, 
                            (SRV_EMAIL_MAX_ACCT_NAME_LEN + 1));

        if (SRV_EMAIL_RESULT_SUCC != srv_op_result)
        {
            p_account_name[0] = 0;
        }
        kal_wsprintf(
            (WCHAR*)subMenuData,
            "%w %w%w%w",
            (WCHAR*)p_account_name,
            (WCHAR*)GetString(STR_EMAIL_EMN_RETRIEVE_ERROR_LOWCASE_ID),
            (WCHAR*)GetString(g_receive_list.last_error_code),
            (WCHAR*)GetString(STR_EMAIL_FULL_STOP_ID));

        guiBuffer = mmi_frm_scrn_get_active_gui_buf();
        ShowCategory74Screen(
            STR_EMAIL_EMN_ID,
            GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
            0,
            0,
            STR_GLOBAL_BACK,
            IMG_GLOBAL_BACK,
            (U8*)subMenuData,
            mmi_wcslen((const WCHAR*)subMenuData),
            guiBuffer);

        SetRightSoftkeyFunction(mmi_frm_scrn_close_active_id, KEY_EVENT_UP);

        if (NULL != p_account_name)
        {
            OslMfree(p_account_name);
            p_account_name = NULL;
        }
    }
    return MMI_RET_OK;
}


void mmi_email_generate_default_acct_name(
        WCHAR *p_acct_name,
        S32 acct_num, 
        WCHAR (*p_exist_acct_name_array)[SRV_EMAIL_MAX_ACCT_NAME_LEN + 1])
{
    WCHAR *p_acct_name_base = NULL;
    S32 j = 0;
    S32 i = 0;

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_GENERATE_DEFAULT_ACCT_NAME, __LINE__);
    if (mmi_wcslen(p_acct_name) < SRV_EMAIL_MAX_ACCT_NAME_LEN - 3)
    {
        for (j = 0; j < acct_num; j++)
        {
            if (0 == mmi_wcscmp(p_acct_name, p_exist_acct_name_array[j]))
            {
                if (p_acct_name_base == NULL)
                {
                    p_acct_name_base = p_exist_acct_name_array[j];
            }
                ++i;
                j = -1;
                kal_wsprintf(p_acct_name, "%w%c%d%c", p_acct_name_base, '(', i, ')');
        }
    }
    }
}


MMI_BOOL mmi_email_store_acct_misc_info(EMAIL_ACCT_ID account_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_account_extra_info_struct extra_info;
    mmi_email_app_core_result_enum app_core_result = MMI_EMAIL_SUCCESS;
    S32 count = 0;
    mmi_email_auto_check_time_segment time_segment;
    MMI_BOOL return_value = MMI_TRUE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_STORE_ACCT_MISC_INFO, __LINE__);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_STORE_ACCT_MISC_INFO_LOG1, account_id);
    /* save extra info */
    extra_info.account_id = account_id;
    extra_info.save_sent_emails = MMI_TRUE;
    
    if (MMI_FALSE == mmi_email_entry_edit_account_add_account_extra_info(&extra_info, NULL))
    {
        return_value = MMI_FALSE;
        goto MMI_EMAIL_STORE_ACCT_MISC_INFO_END;
    }

    /* save signature info */
    app_core_result = mmi_email_sig_create(account_id);
    if (MMI_EMAIL_SUCCESS != app_core_result)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_STORE_ACCT_MISC_INFO_LOG2, app_core_result);
        mmi_email_entry_edit_account_delete_account_extra_info(account_id, NULL);
        return_value = MMI_FALSE;
        goto MMI_EMAIL_STORE_ACCT_MISC_INFO_END;
    }

    /* save auto check info */
#ifndef __MMI_SLIM_EMAIL_NO_AUTO_CHECK__
    app_core_result = mmi_email_auto_check_create(account_id);
    if (MMI_EMAIL_SUCCESS != app_core_result)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_STORE_ACCT_MISC_INFO_LOG3, app_core_result);
        mmi_email_entry_edit_account_delete_account_extra_info(account_id, NULL);
        mmi_email_sig_delete_acct(account_id, MMI_TRUE);
        return_value = MMI_FALSE;
        goto MMI_EMAIL_STORE_ACCT_MISC_INFO_END;
    }

    time_segment.start_time = MMI_EMAIL_CHECK_INTERVAL_DAY_START_TIME;
    time_segment.stop_time = MMI_EMAIL_CHECK_INTERVAL_DAY_END_TIME;
    time_segment.interval = 0;
    for (count = MMI_EMAIL_CHECK_INTERVAL_DAY_BEGIN; count <= MMI_EMAIL_CHECK_INTERVAL_DAY_END; count++)
    {
        app_core_result = mmi_email_auto_check_add_segment(account_id, (U16)count, &time_segment);        
        if (MMI_EMAIL_SUCCESS != app_core_result)
        {
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_STORE_ACCT_MISC_INFO_LOG4, count, app_core_result);
            mmi_email_destroy_acct_misc_info(account_id);
            return_value = MMI_FALSE;
            goto MMI_EMAIL_STORE_ACCT_MISC_INFO_END;
        }

        app_core_result = mmi_email_auto_check_set_day_enable(account_id, (U16)count, MMI_FALSE);
        if (MMI_EMAIL_SUCCESS != app_core_result)
        {
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_STORE_ACCT_MISC_INFO_LOG5, count, app_core_result);
            mmi_email_destroy_acct_misc_info(account_id);
            return_value = MMI_FALSE;
            goto MMI_EMAIL_STORE_ACCT_MISC_INFO_END;
        }
    }
    
    app_core_result = mmi_email_auto_check_stop(account_id);
    if (MMI_EMAIL_SUCCESS != app_core_result)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_STORE_ACCT_MISC_INFO_LOG6, app_core_result);
        mmi_email_destroy_acct_misc_info(account_id);
        return_value = MMI_FALSE;
        goto MMI_EMAIL_STORE_ACCT_MISC_INFO_END;   
    }

#endif /* __MMI_SLIM_EMAIL_NO_AUTO_CHECK__ */

MMI_EMAIL_STORE_ACCT_MISC_INFO_END:
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_STORE_ACCT_MISC_INFO_LOG7, return_value);
    return return_value;
}


void mmi_email_destroy_acct_misc_info(EMAIL_ACCT_ID account_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL delete_extra_info = MMI_TRUE;
    mmi_email_app_core_result_enum sig_delete_result = MMI_EMAIL_SUCCESS;
    mmi_email_app_core_result_enum auto_check_delete_result = MMI_EMAIL_SUCCESS;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_DESTROY_ACCT_MISC_INFO, __LINE__);

    delete_extra_info = mmi_email_entry_edit_account_delete_account_extra_info(account_id, NULL);
    sig_delete_result = mmi_email_sig_delete_acct(account_id, MMI_TRUE);
    auto_check_delete_result = mmi_email_auto_check_delete_acct(account_id, MMI_TRUE);
    MMI_TRACE(
        MMI_INET_TRC_G9_EMAIL, 
        MMI_EMAIL_DESTROY_ACCT_MISC_INFO_LOG1, 
        account_id,
        delete_extra_info,
        sig_delete_result,
        auto_check_delete_result);
    return;
}


void mmi_email_set_acct_attribute(srv_email_acct_info_struct *p_acct_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SET_ACCT_ATTRIBUTE, __LINE__);

    p_acct_info->acct_attr = (0 | SRV_EMAIL_ACCT_ATTR_SMTP);

    if (SRV_EMAIL_PROT_POP3 == p_acct_info->protocol)
    {
        p_acct_info->acct_attr |= SRV_EMAIL_ACCT_ATTR_POP3;
    }
    else if (SRV_EMAIL_PROT_IMAP4 == p_acct_info->protocol)
    {
        p_acct_info->acct_attr |= SRV_EMAIL_ACCT_ATTR_IMAP4;
    }
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, MMI_EMAIL_SET_ACCT_ATTRIBUTE_LOG1, p_acct_info->protocol, p_acct_info->acct_attr);
    return;
}

#endif

