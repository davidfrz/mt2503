/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE.
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/
/*****************************************************************************
 *
 * Filename:
 * ---------
 *
 *
 * Project:
 * --------
 *  MAUI
 *
 * Description:
 * ------------
 *
 *
 * Author:
 * -------
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/
#define _FMGR_INTERNAL_SOURCE_C_
/****************************************************************************
* Include Files                                                                
*****************************************************************************/
#include "MMI_features.h"

#if defined (__MMI_FILE_MANAGER__)

#include "CommonScreens.h"

#include "FileMgrGProt.h"
#include "FileMgrProt.h"
#include "FileMgrInstance.h"
#include "FileMgrFSData.h"
#include "FileMgrMain.h"
#include "FileMgrService.h"

#include "FileMgrResDef.h"

#ifdef __DRM_SUPPORT__
#include "drm_gprot.h"                
#include "RightsMgrGProt.h"
#endif

#include "med_api.h"

#ifdef __FMGR_USE_MENU_CUI__
#include "MenuCuiGProt.h"
#endif

#include "FileMgrSrvGProt.h"

#ifdef __MMI_VUI_MEDIAWALL__
#include "MediaWall\vadp_mediawall.h"
#endif /* __MMI_VUI_MEDIAWALL__ */

#include "MMIDataType.h"
#include "kal_general_types.h"
#include "string.h"
#include "mmi_rp_file_type_def.h"
#include "FileMgrType.h"
#include "mmi_frm_mem_gprot.h"
#include "kal_public_api.h"
#include "fs_errcode.h"
#include "mmi_rp_app_filemanager_def.h"
#include "CustMenuRes.h"
#include "fs_type.h"
#include "wgui_categories_list.h"
#include "mmi_frm_scenario_gprot.h"
#include "MMI_common_app_trc.h"
#include "DebugInitDef_Int.h"
#include "kal_trace.h"
#include "mmi_common_app_trc.h"
#include "CustDataRes.h"
#include "GlobalConstants.h"
#include "wgui_categories_util.h"
#include "wgui_touch_screen.h"
#include "mmi_frm_events_gprot.h"
#include "GlobalResDef.h"
#include "wgui_inputs.h"
#include "ScreenRotationGprot.h"
#include "Unicodexdcl.h"
#include "AlertScreen.h"
#include "med_smalloc.h"
#include "stack_config.h"
/****************************************************************************
* Define
*****************************************************************************/

#define FMGR_MAX_FILEPATH_BUFFER    5

typedef struct _mmi_fmgr_filepath_buffer_struct
{
    S8* path;
    S32 line;
} mmi_fmgr_filepath_buffer_struct;

typedef struct _mmi_fmgr_common_context_struct
{
    U16 fwd_send_link_id;
    U16 fwd_use_link_id;

} mmi_fmgr_common_context_struct;

/****************************************************************************
* Global Variable
*****************************************************************************/

/****************************************************************************
* Static Variable
*****************************************************************************/
static mmi_fmgr_filepath_buffer_struct g_file_path_array[FMGR_MAX_FILEPATH_BUFFER];
static S8 g_file_path_buffer[(SRV_FMGR_PATH_MAX_LEN + 1) * ENCODING_LENGTH];

static mmi_fmgr_context_struct  g_fmgr_context;

mmi_fmgr_context_struct* fmgr_p = &g_fmgr_context;

static mmi_fmgr_common_context_struct g_fmgr_cmn_context;

#ifndef __MTK_TARGET__
static S8 g_fmgr_modis_trace_on = 0;
#endif

/****************************************************************************
* Function Forward Declaration
*****************************************************************************/

static void fmgr_option_init(void);

#ifdef __MMI_RMGR__
extern void mmi_rmgr_option_enabler_more_rits(mmi_menu_id menu_id, const WCHAR* filepath, const srv_fmgr_fileinfo_struct* fileinfo);
#endif


#define END_OF_FUNCTION_DECLARATION

/****************************************************************************
* Function Body
*****************************************************************************/

/*****************************************************************************
 * FUNCTION
 *  mmi_fmgr_init
 * DESCRIPTION
 *  Init FMGR, includes: context init, drive init, application init...
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_fmgr_init(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    extern void mmi_fmgri_service_hdlr_init(void);
    extern void mmi_fmgr_util_init(void);
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(FMGR_INTERNAL_TEST) && !defined(__MTK_TARGET__)
    g_fmgr_modis_trace_on = 1;
#endif

    /********* Init instance module *********/    
    mmi_fmgri_instance_init();

    /********* Init fsdata context *********/    
    mmi_fmgri_fsdata_init();
    
    /********* Init main context ***********/    
    mmi_fmgri_main_init();

    /********* Init service module *********/    
    mmi_fmgri_service_init();

    /********* Init service_hdlr module *********/    
    mmi_fmgri_service_hdlr_init();    

    /********* Init util module *********/    
    mmi_fmgr_util_init();

    /* init option module */
    fmgr_option_init();

    memset(g_file_path_array, 0, sizeof(g_file_path_array));

    memset(&g_fmgr_cmn_context, 0, sizeof(g_fmgr_cmn_context));    
}


/*****************************************************************************
 * FUNCTION
 *  mmi_fmgr_init_mmi
 * DESCRIPTION
 *  Init FMGR MMI related context.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_fmgr_init_mmi(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    /********* Init main context ***********/    
    mmi_fmgri_main_init_mmi_context();   
}


#define OPTION_ENABLER_API

void mmi_fmgr_general_option_enabler(mmi_menu_id item_id, const WCHAR* filepath, const srv_fmgr_fileinfo_struct* fileinfo)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    FMGR_FILE_INFO_STRUCT *file_info = NULL;
    mmi_fmgr_filetype_enum file_type;
    S32 fs_ret;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    file_info = OslMalloc(sizeof(FMGR_FILE_INFO_STRUCT));
    memset(file_info, 0, sizeof(FMGR_FILE_INFO_STRUCT));
    fs_ret = mmi_fmgr_get_file_info_by_path((S8*)filepath, file_info);
    if (fs_ret < FS_NO_ERROR)
    {
        /* File doesn't exist now */
        OslMfree(file_info);
        return;
    }

    switch (item_id)
    {
    #ifdef __MMI_RMGR__
        case MENU_ID_FMGR_GEN_OPTION_MORE_RITS:            
            mmi_rmgr_option_enabler_more_rits(item_id, filepath, fileinfo);
            break;
    #endif /* __MMI_RMGR__ */

        case MENU_ID_FMGR_GEN_OPTION_FORWARD_SEND:

            file_type = srv_fmgr_types_get_main_type(&(file_info->file_type));
            if (srv_fmgr_types_get_send_option_menu(file_type, (WCHAR*)filepath) <= 0)
            {
                mmi_frm_hide_menu_item(MENU_ID_FMGR_GEN_OPTION_FORWARD_SEND);
            }

#ifdef __FS_CARD2_SUPPORT__
            /* If filepath is the second T-card, hide this menu item */
            if (mmi_fmgri_is_drv_card_2_type_by_path((const S8*)filepath))
            {
                mmi_frm_hide_menu_item(MENU_ID_FMGR_GEN_OPTION_FORWARD_SEND);
            }
#endif
            break;

        case MENU_ID_FMGR_GEN_OPTION_FORWARD_USE:

            file_type = srv_fmgr_types_get_main_type(&(file_info->file_type));
            if (srv_fmgr_types_get_use_option_menu(file_type, (WCHAR*)filepath) <= 0)
            {
                mmi_frm_hide_menu_item(MENU_ID_FMGR_GEN_OPTION_FORWARD_USE);
            }

#ifdef __FS_CARD2_SUPPORT__
            /* If filepath is the second T-card, hide this menu item */
            if (mmi_fmgri_is_drv_card_2_type_by_path((const S8*)filepath))
            {
                mmi_frm_hide_menu_item(MENU_ID_FMGR_GEN_OPTION_FORWARD_USE);
            }
#endif
#ifndef __MMI_TELEPHONY_SUPPORT__
            mmi_frm_hide_menu_item(MENU_ID_FMGR_GEN_OPTION_FORWARD_USE);
#endif
            break;
        case MENU_ID_FMGR_FOLDER_OPTIONS:
#ifndef __MMI_FMGR_FOLDER_COPY_SUPPORT__
        #ifdef __MMI_FMGR_MULTI_SELECT_SUPPORT__
            mmi_frm_hide_menu_item(MENU_ID_FMGR_GEN_OPTION_MARK_SEVERAL);
        #endif /* __MMI_FMGR_MULTI_SELECT_SUPPORT__ */            
            mmi_frm_hide_menu_item(MENU_ID_FMGR_GEN_OPTION_COPY);
            mmi_frm_hide_menu_item(MENU_ID_FMGR_GEN_OPTION_MOVE);
#endif
            break;
        default:
            mmi_frm_hide_menu_item(item_id);
            break;
    }

    OslMfree(file_info);
}

void mmi_fmgri_prepare_option(mmi_fmgr_instance_struct *instance, U16 menu_id, const FMGR_FILE_INFO_STRUCT* fileinfo)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 num_of_child;
    U16 child_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    num_of_child = GetNumOfChild_Ext(menu_id);
    if (num_of_child == 0)
    {
        /* No item in the menu */
        return;
    }

    while (num_of_child)
    {
        child_id = GetSeqItemId_Ext(menu_id, (U16)(num_of_child - 1));

        switch (child_id)
        {
            case MENU_ID_FMGR_GEN_OPTION_COPY:
            case MENU_ID_FMGR_GEN_OPTION_MOVE:
        #ifdef __MMI_FMGR_MULTI_SELECT_SUPPORT__
            case MENU_ID_FMGR_GEN_OPTION_MARK_SEVERAL:
        #endif /* __MMI_FMGR_MULTI_SELECT_SUPPORT__ */
        case MENU_ID_FMGR_FOLDER_CREATE:
            /* In current design, only FMGR can use Copy/Move */
            if ((instance != NULL) && (instance->type != MMI_FMGR_TYPE_APP))
            {
                mmi_frm_hide_menu_item(child_id);
            }
        #ifdef __DRM_V02__
            if (FMGR_FLAG_IS_SET(fileinfo->flag, MMI_FMGR_FILEINFO_FLAG_IS_IN_ARCHIEVE))
            {
                mmi_frm_hide_menu_item(child_id);
            }
        #endif /* __DRM_V02__ */
	#ifdef __MMI_BTD_BOX_UI_STYLE__
	    if(MENU_ID_FMGR_FOLDER_CREATE == child_id)
	    {
		  mmi_frm_hide_menu_item(child_id);
	    }
        #endif/*__MMI_BTD_BOX_UI_STYLE__*/
            break;
       
        case MENU_ID_FMGR_GEN_OPTION_RENAME:
        case MENU_ID_FMGR_GEN_OPTION_DELETE:
        #ifdef __DRM_V02__
            if (FMGR_FLAG_IS_SET(fileinfo->flag, MMI_FMGR_FILEINFO_FLAG_IS_IN_ARCHIEVE))
            {
                mmi_frm_hide_menu_item(child_id);
            }
        #endif /* __DRM_V02__ */
	#ifdef __MMI_BTD_BOX_UI_STYLE__
	   if(MENU_ID_FMGR_GEN_OPTION_RENAME == child_id)
	    {
		   mmi_frm_hide_menu_item(child_id);
	    }
        #endif/*__MMI_BTD_BOX_UI_STYLE__*/
            break;

        case MENU_ID_FMGR_GEN_OPTION_DETAIL:
           if (fileinfo->attribute & FS_ATTR_DIR)
           {
		   	#ifndef __OP01__
                mmi_frm_hide_menu_item(child_id);
			#endif
           }
            break;
#ifndef __MMI_SLIM_FILE_MANAGER__ 
        case MENU_ID_FMGR_GEN_OPTION_DELETE_ALL:
            if (fileinfo->attribute & FS_ATTR_DIR)
            {
                mmi_frm_hide_menu_item(child_id);
            }
        #ifdef __DRM_V02__
            if (FMGR_FLAG_IS_SET(fileinfo->flag, MMI_FMGR_FILEINFO_FLAG_IS_IN_ARCHIEVE))
            {
                mmi_frm_hide_menu_item(child_id);
            }
        #endif /* __DRM_V02__ */
            break;
#endif
    #ifdef __FS_SORT_SUPPORT__
        case MENU_ID_FMGR_GEN_OPTION_SORT:
        #ifdef __DRM_V02__
            if (FMGR_FLAG_IS_SET(fileinfo->flag, MMI_FMGR_FILEINFO_FLAG_IS_IN_ARCHIEVE))
            {
                mmi_frm_hide_menu_item(child_id);
            }
        #endif /* __DRM_V02__ */
            break;
    #endif /* __FS_SORT_SUPPORT__ */
        }
        num_of_child--;
    }
    
}

void mmi_fmgri_prepare_forward_option(U16 menu_id, const FMGR_FILE_INFO_STRUCT* fileinfo)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32                         num_of_child;
    U16                         child_id;
    mmi_fmgr_enabler_callback   enabler;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* traverse all child item, call each enabler if has */    
    num_of_child = GetNumOfChild(menu_id);
    if(!num_of_child)
        return;

    // must call mmi_fmgri_query_result_setup() before this API
    FMGR_ASSERT(mmi_fmgr_get_current_fileinfo(NULL, NULL));
    
    while(num_of_child)
    {
        child_id = GetSeqItemId(menu_id, (U16)(num_of_child-1));
        num_of_child--;

        mmi_frm_unhide_menu_item(child_id);
        
        enabler = mmi_fmgri_table_get_forward_enabler(child_id);
        if(enabler)
            enabler(child_id, fileinfo);
    }
}

void mmi_fmgr_reset_menu_set(U16 parent_menu_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 num_of_child;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* unhide all menu under the parent */
    num_of_child = GetNumOfChild(parent_menu_id);
    if(!num_of_child)
        return;

    while(num_of_child)
    {
        mmi_frm_unhide_menu_item(GetSeqItemId(parent_menu_id, (U16)(num_of_child-1)));
        num_of_child--;
    }
}


void mmi_fmgr_hide_all_menu_set(U16 parent_menu_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 num_of_child;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* unhide all menu under the parent */
    num_of_child = GetNumOfChild(parent_menu_id);
    if(!num_of_child)
        return;

    while(num_of_child)
    {
        mmi_frm_hide_menu_item(GetSeqItemId(parent_menu_id, (U16)(num_of_child-1)));
        num_of_child--;
    }
}


U16 mmi_fmgri_get_menu_link(U16 menu_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct* instance;
    FMGR_FILE_INFO_STRUCT *file_info;
    mmi_fmgr_filetype_enum file_type;
    S8 *buffer;
    S32 fwd_menu_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    instance = mmi_fmgri_get_active_instance();
    file_info = OslMalloc(sizeof(FMGR_FILE_INFO_STRUCT));
    memset(file_info, 0, sizeof(FMGR_FILE_INFO_STRUCT));
    mmi_fmgri_fsdata_instance_get_file_info(instance->id, instance->cur_index, file_info);

    buffer = mmi_fmgri_get_and_lock_buffer();

    switch (menu_id)
    {
        case MENU_ID_FMGR_GEN_OPTION_FORWARD_SEND:
        case MENU_ID_FMGR_GEN_OPTION_FORWARD_USE:
            if (!mmi_fmgri_filepath_compose(buffer, (SRV_FMGR_PATH_MAX_LEN + 1),
                      instance->file_path, file_info, MMI_FALSE))
            {
                FMGR_ASSERT(0);
                break;
            }

            file_type = srv_fmgr_types_get_main_type(&(file_info->file_type));

            if (menu_id == MENU_ID_FMGR_GEN_OPTION_FORWARD_SEND)
            {
                fwd_menu_id = srv_fmgr_types_get_send_option_menu(file_type, (WCHAR*)buffer);
            }
            else
            {
                fwd_menu_id = srv_fmgr_types_get_use_option_menu(file_type, (WCHAR*)buffer);
            }

            if (fwd_menu_id)
            {
                mmi_fmgri_free_and_unlock_buffer(buffer);
                OslMfree(file_info);
                return fwd_menu_id;
            }
            break;

        default:
            break;
    }

    mmi_fmgri_free_and_unlock_buffer(buffer);
    OslMfree(file_info);
    return menu_id;
}


#define OPTION_API
#ifdef __FMGR_USE_SELF_MENU__
static void fmgr_option_register_keys(void);
#endif
#ifdef __FMGR_HYPERLINK_SUPPORT__
static U16              g_option_appstr_id;
#endif

typedef struct {
    U16 parent_menu_id;
    U16 highlight_menu_id;
    U8  display_type;
} fmgr_option_level_struct;

static fmgr_option_level_struct g_option_next_level;

static void fmgr_option_init(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __FMGR_HYPERLINK_SUPPORT__
    g_option_appstr_id = 0;
#endif
}

#ifdef __FMGR_USE_SELF_MENU__
static void fmgr_option_highlight_hdlr(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    fmgr_option_info_struct* opt_obj;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    opt_obj = (fmgr_option_info_struct*)mmi_frm_group_get_user_data(mmi_frm_group_get_active_id());
    
    opt_obj->highlight_idx = (U16)index;
    opt_obj->highlight_menu_id = GetSeqItemId_Ext(opt_obj->option_menu_id, (U16)index);
}

static void fmgr_option_key_hdlr(const fmgr_option_info_struct* opt_obj, U16 keyCode)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 menu_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    FMGR_PERF_START(fmgr_option_key_hdlr, keyCode);

    menu_id = GetSeqItemId_Ext(opt_obj->option_menu_id, opt_obj->highlight_idx);
    FMGR_ASSERT(menu_id);

    FMGR_TRACE3(TRC_MMI_FMGR_BA40D7FF80BF4B328CB635F4575E741F, "Fmgr > Option > Callback menu=%d,%d,<%S>\n", 
        opt_obj->option_menu_id, menu_id, GetString(GetStringIdOfItem(menu_id)));

    /* Callback */
    menu_id = opt_obj->callback(opt_obj->option_menu_id, menu_id, opt_obj->data, keyCode);
    if(menu_id > 0)
    {
        mmi_fmgri_show_option_ex(opt_obj->parent_group_id,
                                menu_id, opt_obj->callback, 
                                opt_obj->data, opt_obj->icon_id, 
                                GetStringIdOfItem(menu_id),
                                NULL, 0, 0);
    }

    FMGR_PERF_END(fmgr_option_key_hdlr);
}

static void fmgr_option_lsk_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_option_key_hdlr((fmgr_option_info_struct*)mmi_frm_group_get_user_data(mmi_frm_group_get_active_id()), KEY_LSK);
}
#ifndef __FMGR_KEY_RULE__    
static void fmgr_option_arrow_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_option_key_hdlr((fmgr_option_info_struct*)mmi_frm_group_get_user_data(mmi_frm_group_get_active_id()), KEY_RIGHT_ARROW);
}
#endif
#ifdef __MMI_TOUCH_SCREEN__
static void fmgr_option_click_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_option_key_hdlr((fmgr_option_info_struct*)mmi_frm_group_get_user_data(mmi_frm_group_get_active_id()), MAX_KEYS);
}
#endif
#endif

static void fmgr_option_delete_callback(const mmi_scenario_evt_struct* evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    fmgr_option_info_struct* opt_obj;
    mmi_id grp_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    grp_id = evt->targ_group;
    FMGR_ASSERT(grp_id >= SCR_ID_FMGR_OPTION_BASE && grp_id < SCR_ID_FMGR_OPTION_END);
    opt_obj = (fmgr_option_info_struct*)mmi_frm_group_get_user_data(grp_id);

    mmi_ime_delete_editor_common_scr(grp_id);

    if(opt_obj->callback)
    {
        opt_obj->callback(opt_obj->option_menu_id, 0, opt_obj->data, 0);
    }

    FMGR_TRACE2(TRC_MMI_FMGR_24526FFA97F44DA2BA43579B48C21903, "Fmgr > Option (%d) > Delete callback, m=%d\n", grp_id, opt_obj->option_menu_id);
    OslMfree(opt_obj);
    
}

#ifdef __FMGR_USE_SELF_MENU__
static void fmgr_option_register_keys(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    SetLeftSoftkeyFunction(fmgr_option_lsk_hdlr, KEY_EVENT_UP);
#ifndef __FMGR_KEY_RULE__    
    SetKeyHandler(fmgr_option_arrow_hdlr, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_frm_scrn_close_active_id, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
#endif    
#ifdef __MMI_TOUCH_SCREEN__
    wgui_register_list_item_selected_callback(fmgr_option_click_hdlr);
#endif    
    SetRightSoftkeyFunction(mmi_frm_scrn_close_active_id, KEY_EVENT_UP);
}
#endif

#ifdef __FMGR_USE_SELF_MENU__
static void fmgr_entry_option(mmi_scrn_essential_struct* info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16     *nStrItemList;
    U16     nNumofItem, i;
    U8      *guiBuffer;
    S32     highlight_idx;

    U16     grp_id;

    fmgr_option_info_struct* opt_obj;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    grp_id = info->group_id;
    FMGR_ASSERT(grp_id >= SCR_ID_FMGR_OPTION_BASE && grp_id < SCR_ID_FMGR_OPTION_END);
        
    opt_obj = (fmgr_option_info_struct*)mmi_frm_group_get_user_data(grp_id);

    if(!mmi_frm_scrn_enter(grp_id, FMGR_SCR_BASE, NULL, (FuncPtr)fmgr_entry_option, 0))
        return;
    guiBuffer = mmi_frm_scrn_get_gui_buf(grp_id, FMGR_SCR_BASE);

    if(guiBuffer)
    {
        /* load item mask */
        nNumofItem = GetNumOfChild(opt_obj->option_menu_id);
        if(nNumofItem <= 32)
        {
            for(i=0;i<nNumofItem;i++)
            {
                if(opt_obj->item_mask & 1)
                    mmi_frm_unhide_menu_item(GetSeqItemId(opt_obj->option_menu_id, i));
                else
                    mmi_frm_hide_menu_item(GetSeqItemId(opt_obj->option_menu_id, i));
                opt_obj->item_mask >>= 1;
            }
        }
    }

    nStrItemList = (U16*)subMenuData;

    if(opt_obj->entry_callback)
    {
        if(opt_obj->entry_callback(opt_obj->option_menu_id, opt_obj->data) < 0)
        {
            mmi_frm_scrn_close(grp_id, FMGR_SCR_BASE);
            return;
        }
    }

    /* store the item mask */
    nNumofItem = GetNumOfChild(opt_obj->option_menu_id);
    if(nNumofItem <= 32)
    {
        opt_obj->item_mask = 0;
        while(nNumofItem)
        {
            opt_obj->item_mask <<= 1;
            if(!mmi_frm_test_menu_item_hide(GetSeqItemId(opt_obj->option_menu_id, nNumofItem-1)))
                opt_obj->item_mask |= 1;
            nNumofItem--;
        }
    }

    RegisterHighlightHandler(fmgr_option_highlight_hdlr);
    nNumofItem = GetNumOfChild_Ext(opt_obj->option_menu_id);
    GetSequenceStringIds_Ext(opt_obj->option_menu_id, nStrItemList);
    SetParentHandler(opt_obj->option_menu_id);

#ifdef __FMGR_HYPERLINK_SUPPORT__
    /* Replace string */
    if(g_option_appstr_id)
    {
        for(i=0;i<nNumofItem;i++)
        {
            if(GetSeqItemId_Ext(opt_obj->option_menu_id, i) == MENU_ID_FMGR_HYPERLINK_APP_FUNC)
            {
                nStrItemList[i] = g_option_appstr_id;
                break;
            }
        }
    }
#endif

    ConstructHintsList(opt_obj->option_menu_id, hintDataPtrs);

    /* find highlight index */
    if(!guiBuffer && opt_obj->highlight_menu_id)
    {
        /* find highlight */
        highlight_idx = nNumofItem - 1;
        while(highlight_idx > 0)
        {
            if(opt_obj->highlight_menu_id == GetSeqItemId_Ext(opt_obj->option_menu_id, (U16)highlight_idx))
                break;
            highlight_idx--;
        }
    }
    else
    {
        highlight_idx = 0;
    }

    switch(opt_obj->display_type)
    {
#ifdef __FMGR_FTE_TOOLBAR_SUPPORT__
    case MMI_FMGR_OPTION_TYPE_SUB_LEVEL:
        for(i=0;i<nNumofItem;i++)
            subMenuDataPtrs[i] = (U8*)get_string(nStrItemList[i]);
        wgui_cat1003_show(
            (U8*)get_string(opt_obj->title_str_id),
            (U8*)get_image(opt_obj->icon_id),
            (U8*)get_string(STR_GLOBAL_SELECT),
            (U8*)get_image(IMG_GLOBAL_OK),
            (U8*)get_string(STR_GLOBAL_BACK),
            (U8*)get_image(IMG_GLOBAL_BACK),
            nNumofItem,
            (U8**)subMenuDataPtrs,
            NULL,
            0,
            highlight_idx,
            guiBuffer);
        break;
#endif

    case MMI_FMGR_OPTION_TYPE_RADIO:
        /* Editor special case */
        if(opt_obj->ime_close_callback)
        {
            ShowCategory118Screen(
                opt_obj->title_str_id,
                opt_obj->icon_id,
                STR_GLOBAL_OK,
                IMG_GLOBAL_OK,
                STR_GLOBAL_BACK,
                IMG_GLOBAL_BACK,
                nNumofItem,
                nStrItemList,
                highlight_idx,
                guiBuffer,
                fmgr_option_highlight_hdlr,
                opt_obj->ime_close_callback);
            break;
        }

        ShowCategory11Screen(
            opt_obj->title_str_id,
            opt_obj->icon_id,
            STR_GLOBAL_OK,
            IMG_GLOBAL_OK,
            STR_GLOBAL_BACK,
            IMG_GLOBAL_BACK,
            nNumofItem,
            nStrItemList,
            highlight_idx,
            guiBuffer);
        break;
        
    case MMI_FMGR_OPTION_TYPE_NORMAL:
    case MMI_FMGR_OPTION_TYPE_FULL_SCREEN:
    default:
        /* Editor special case */
        if(opt_obj->ime_close_callback)
        {
            ShowCategory529Screen(
                opt_obj->title_str_id,
                opt_obj->icon_id,
                STR_GLOBAL_OK,
                IMG_GLOBAL_OK,
                STR_GLOBAL_BACK,
                IMG_GLOBAL_BACK,
                nNumofItem,
                nStrItemList,
                (U16*) gIndexIconsImageList,
                hintDataPtrs,
                1,
                highlight_idx,
                guiBuffer,
                fmgr_option_highlight_hdlr,
                opt_obj->ime_close_callback);
            break;
        }

        ShowCategory52Screen(
            opt_obj->title_str_id,
            opt_obj->icon_id,
            STR_GLOBAL_OK,
            IMG_GLOBAL_OK,
            STR_GLOBAL_BACK,
            IMG_GLOBAL_BACK,
            nNumofItem,
            nStrItemList,
            (U16*) gIndexIconsImageList,
            hintDataPtrs,
            1,
            highlight_idx,
            guiBuffer);
        break;
    }

    /* Editor special case */
    if (!opt_obj->ime_close_callback ||
        wgui_inputs_menu_index_in_editor_range() == MMI_FALSE)
    {
        fmgr_option_register_keys();
    }
}
#endif

#ifdef __FMGR_USE_MENU_CUI__
static mmi_ret fmgr_option_group_menu_proc(cui_menu_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    fmgr_option_info_struct *opt_obj = (fmgr_option_info_struct*)evt->user_data;
    U16 next_level;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    
    switch (evt->evt_id)
    {
        case EVT_ID_CUI_MENU_LIST_ENTRY:
            /* If there is next level information */
            if (evt->parent_menu_id == g_option_next_level.parent_menu_id)
            {
                cui_menu_set_currlist_highlighted_id(opt_obj->menu_group_id, g_option_next_level.highlight_menu_id); 
                cui_menu_set_currlist_flags(opt_obj->menu_group_id, CUI_MENU_NORMAL_LIST);       
                memset(&g_option_next_level, 0, sizeof(g_option_next_level));
            }

            /* Entry callback */
            if (opt_obj->entry_callback)
            {
                if(opt_obj->entry_callback(evt->parent_menu_id, opt_obj->data) < 0)
                {
                    return MMI_RET_ERR;
                }
            }

            /* Prepare App's menu id */            
            mmi_frm_group_send_to_caller(opt_obj->option_group_id, (mmi_group_event_struct*)evt);

        #ifdef __FMGR_HYPERLINK_SUPPORT__
            /* Replace string */
            if (g_option_appstr_id)
            {
                cui_menu_set_item_string(opt_obj->menu_group_id, MENU_ID_FMGR_HYPERLINK_APP_FUNC, get_string(g_option_appstr_id));
            }
        #endif /* __FMGR_HYPERLINK_SUPPORT__ */

            cui_menu_set_non_leaf_item(opt_obj->menu_group_id, MENU_ID_FMGR_GEN_OPTION_FORWARD_SEND, MMI_TRUE);
            cui_menu_set_non_leaf_item(opt_obj->menu_group_id, MENU_ID_FMGR_GEN_OPTION_FORWARD_USE, MMI_TRUE);

        #ifdef __FS_SORT_SUPPORT__
            /* Sort by */
            if (evt->parent_menu_id == MENU_ID_FMGR_GEN_OPTION_SORT)
            {
                switch (srv_fmgr_sort_get())
                {
                    case FS_SORT_NAME: 
                        next_level = MENU_ID_FMGR_SORT_BY_NAME; 
                        break;
                    case FS_SORT_SIZE:
                        next_level = MENU_ID_FMGR_SORT_BY_SIZE;
                        break;
                    case FS_SORT_TYPE:
                        next_level = MENU_ID_FMGR_SORT_BY_TYPE;
                        break;
                    case FS_SORT_TIME:
                        next_level = MENU_ID_FMGR_SORT_BY_TIME;
                        break;
                    default:
                        next_level = MENU_ID_FMGR_SORT_BY_NAME;
                        break;
                }
                cui_menu_set_currlist_highlighted_id(opt_obj->menu_group_id, next_level);
            }
        #endif /* __FS_SORT_SUPPORT__ */

            break;
        
        case EVT_ID_CUI_MENU_ITEM_SELECT:
            FMGR_ASSERT(opt_obj->callback);
            memset(&g_option_next_level, 0, sizeof(g_option_next_level));
            next_level = opt_obj->callback(evt->parent_menu_id, evt->highlighted_menu_id, opt_obj->data, KEY_LSK);
            if (next_level)
            {
                cui_menu_set_new_list_parent_id(opt_obj->menu_group_id, next_level);
            }
            else if (g_option_next_level.parent_menu_id)
            {
                cui_menu_set_new_list_parent_id(opt_obj->menu_group_id, g_option_next_level.parent_menu_id);
            }
            break;

        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
            mmi_frm_group_close(opt_obj->option_group_id);
            break;   

        default:
            return MMI_RET_ERR;
    }

    return MMI_RET_OK;
}
#endif /* __FMGR_USE_MENU_CUI__ */

static mmi_ret fmgr_option_group_proc(mmi_event_struct *param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    switch (param->evt_id)
    {
        case EVT_ID_GROUP_ACTIVE:
            FMGR_TRACE1(TRC_MMI_FMGR_5E4CFAF095484BF1A27F5CB3CAF8D689, "Fmgr > Option (%d) > Entry Screen\n", ((mmi_scenario_evt_struct*)param)->targ_group);
            break;
        case EVT_ID_GROUP_INACTIVE:
            FMGR_TRACE1(TRC_MMI_FMGR_611F665EF38B49A5B376B30E210C54F8, "Fmgr > Option (%d) > Exit + Add history \n", ((mmi_scenario_evt_struct*)param)->targ_group);
            break;
        case EVT_ID_GROUP_DEINIT:
            fmgr_option_delete_callback((mmi_scenario_evt_struct*)param);
            break;
        default:
        #ifdef __FMGR_USE_MENU_CUI__
            fmgr_option_group_menu_proc((cui_menu_event_struct*)param);
        #endif /* __FMGR_USE_MENU_CUI__ */
        break;
    }

    return MMI_RET_OK;
}

static void fmgr_show_option_ex(mmi_id parent_id,
                           U16 option_menu_id, 
                           mmi_fmgri_option_callback callback, 
                           U32 data, U16 icon_id, 
                           U16 title_str_id,
                           mmi_fmgri_option_entry_callback entry_callback,
                           mmi_fmgri_option_type_enum type,
                           U16 highlight_menu_id,
                           FuncPtr ime_close_callback,
                           WCHAR* title_str)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/	
    U16 opt_gid;
    fmgr_option_info_struct *opt_obj;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* Should not happen this case */
    /* check if given menu is empty */
    if (!GetNumOfChild_Ext(option_menu_id) && !entry_callback)
    {
        FMGR_DisplayPopup(STR_GLOBAL_ERROR, MMI_EVENT_FAILURE);
        return;
    }

    /* Find a non-used screen id */
    for (opt_gid = SCR_ID_FMGR_OPTION_BASE;
        opt_gid < SCR_ID_FMGR_OPTION_END;
        opt_gid++)
    {
        if (!mmi_frm_group_is_present(opt_gid) && mmi_frm_group_get_active_id() != opt_gid)
        {
            break;
        }
    }
    FMGR_ASSERT(opt_gid != SCR_ID_FMGR_OPTION_END);

    if (title_str_id == 0)
    {
        title_str_id = GetStringIdOfItem(option_menu_id);
    }
    if (title_str_id == 0)
    {
        title_str_id = STR_GLOBAL_OPTIONS;
    }

    opt_obj = OslMalloc(sizeof(fmgr_option_info_struct));
    opt_obj->parent_group_id = parent_id;
    opt_obj->option_group_id = opt_gid;
    opt_obj->option_menu_id = option_menu_id;
    opt_obj->highlight_idx = 0;
    opt_obj->callback = callback;
    opt_obj->data = data;
#ifndef __MMI_MAINLCD_96X64__
    opt_obj->icon_id = icon_id;
#else
    opt_obj->icon_id = 0;
#endif  /* #ifndef __MMI_MAINLCD_96X64__ */
    opt_obj->title_str_id = title_str_id;
    opt_obj->entry_callback = entry_callback;
    opt_obj->display_type = (U8)type;
    opt_obj->highlight_menu_id = highlight_menu_id;
    opt_obj->ime_close_callback = ime_close_callback;

    mmi_frm_group_create(parent_id, opt_gid, fmgr_option_group_proc, opt_obj);
    mmi_frm_group_enter(opt_gid, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    
    FMGR_TRACE1(TRC_MMI_FMGR_1983F988A8664C5490CE96E43C3D07DD, "Fmgr > Option (%d) > Show\n", opt_gid);

#ifdef __FMGR_USE_MENU_CUI__
    if (!opt_obj->ime_close_callback) /* Not editor */
    {
        opt_obj->menu_group_id = cui_menu_create(opt_gid, CUI_MENU_SRC_TYPE_RESOURCE, CUI_MENU_TYPE_OPTION, option_menu_id, MMI_TRUE, opt_obj);
        //cui_menu_set_default_title(opt_obj->menu_group_id, NULL, get_image(icon_id));
    #ifndef __MMI_MAINLCD_96X64__
        cui_menu_set_default_title(opt_obj->menu_group_id, title_str, get_image(icon_id));
    #else
        cui_menu_set_default_title(opt_obj->menu_group_id, title_str, NULL);
    #endif /* __MMI_MAINLCD_96X64__ */
        if (type == MMI_FMGR_OPTION_TYPE_FULL_SCREEN)
        {
           cui_menu_disable_cascading_option_menu(opt_obj->menu_group_id);
        }

    #ifdef __MMI_VUI_MEDIAWALL__
        if (vapp_mediawall_get_direction() == VADP_MEDIAWALL_LANDSCAPE)
        {
            if (mmi_fmgri_instance_get_list_style((U8)data) == FMGR_DISPLAY_TYPE_MATRIX)
            {
                cui_menu_set_rotate_screen(opt_obj->menu_group_id, MMI_FRM_SCREEN_ROTATE_270);
            }
        }
        else
        {
            cui_menu_set_rotate_screen(opt_obj->menu_group_id, MMI_FRM_SCREEN_ROTATE_0);
        }
    #endif /* __MMI_VUI_MEDIAWALL__ */
        cui_menu_run(opt_obj->menu_group_id);
        return;
    }
#endif /* __FMGR_USE_MENU_CUI__ */

#ifdef __FMGR_USE_SELF_MENU__
    mmi_frm_scrn_first_enter(
        opt_gid, FMGR_SCR_BASE, 
        (FuncPtr)fmgr_entry_option, 
        (void*)opt_obj);
#else /* __FMGR_USE_SELF_MENU__ */
    FMGR_ASSERT(0);
#endif /* __FMGR_USE_SELF_MENU__ */
}

void mmi_fmgri_show_option(mmi_id parent, U16 option_menu_id, 
                           mmi_fmgri_option_callback callback, 
                           U32 data, U16 icon_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_show_option_ex(parent, option_menu_id, callback, data, icon_id, 
        0, NULL, (mmi_fmgri_option_type_enum)0, 0, NULL, NULL);
}

void mmi_fmgri_show_option_ex(mmi_id parent, U16 option_menu_id, 
                           mmi_fmgri_option_callback callback, 
                           U32 data, U16 icon_id, 
                           U16 title_str_id,
                           mmi_fmgri_option_entry_callback entry_callback,
                           mmi_fmgri_option_type_enum type,
                           U16 highlight_menu_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_show_option_ex(parent, option_menu_id, callback, data, icon_id, 
                        title_str_id, entry_callback, type, highlight_menu_id, NULL, NULL);
}

#ifndef __FMGR_USE_EDITOR_CUI__
void mmi_fmgri_show_edit_option(mmi_id parent, U16 option_menu_id, 
                                  mmi_fmgri_option_callback callback, 
                                  U32 data, 
                                  U16 icon_id,
                                  FuncPtr ime_close_callback)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __FMGR_USE_SELF_MENU__
    fmgr_show_option_ex(parent, option_menu_id, callback, data, icon_id, 
        0, NULL, 0, 0, ime_close_callback, NULL);
#else
    FMGR_ASSERT(0);
#endif
}
#endif

#ifdef __FMGR_FILE_OPTION_CUI__
void mmi_fmgri_show_option_for_file_option_cui(mmi_id parent, U16 option_menu_id, 
                           mmi_fmgri_option_callback callback, 
                           U32 data, U16 icon_id, 
                           U16 title_str_id,
                           mmi_fmgri_option_entry_callback entry_callback,
                           mmi_fmgri_option_type_enum type,
                           U16 highlight_menu_id,
                           WCHAR* title_str)
{
    fmgr_show_option_ex(parent, option_menu_id, callback, data, icon_id, 
                        title_str_id, entry_callback, type, highlight_menu_id, NULL, title_str);    
}
#endif

void mmi_fmgri_close_option(U16 option_menu_id, U32 data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    fmgr_option_info_struct *opt_obj;
    mmi_id                  grp_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(!option_menu_id)
        return;

    for(grp_id = SCR_ID_FMGR_OPTION_BASE;
        grp_id < SCR_ID_FMGR_OPTION_END;
        grp_id ++)
    {
        opt_obj = (fmgr_option_info_struct*)mmi_frm_group_get_user_data(grp_id);
        if(!opt_obj)
            continue;

        if(opt_obj->option_menu_id == option_menu_id &&
            opt_obj->data == data)
        {
            mmi_frm_group_close(grp_id);
            FMGR_TRACE1(TRC_MMI_FMGR_DF6156FED1504AE98E43A196E7B0F207, "Fmgr > Option (%d) > Closed\n", grp_id);
            return;
        }

    }

    FMGR_TRACE0(TRC_MMI_FMGR_D01EC6090412425B8C31E401FE81A51F, "Fmgr > Option > Close fail, screen not found\n");
}

void mmi_fmgri_close_options(U32 data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    fmgr_option_info_struct *opt_obj;
    mmi_id grp_id;
    U16 count = 0;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    for (grp_id = SCR_ID_FMGR_OPTION_BASE; grp_id < SCR_ID_FMGR_OPTION_END; grp_id ++)
    {
        opt_obj = (fmgr_option_info_struct*)mmi_frm_group_get_user_data(grp_id);
        if (!opt_obj)
        {
            continue;
        }

        if (opt_obj->data == data)
        {
            mmi_frm_group_close(grp_id);
            count ++;
            FMGR_TRACE1(TRC_MMI_FMGR_DF6156FED1504AE98E43A196E7B0F207, "Fmgr > Option (%d) > Closed\n", grp_id);
        }
    }
}

#ifdef __FMGR_HYPERLINK_SUPPORT__
void mmi_fmgri_option_replace_appstring(U16 menu_id, U16 string_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    FMGR_ASSERT(menu_id == MENU_ID_FMGR_HYPERLINK_APP_FUNC);
    g_option_appstr_id = string_id;
}
#endif

#define FILEPATH_API

MMI_BOOL mmi_fmgri_filepath_go_up_level(S8* file_path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (mmi_ucs2cmp(file_path, (S8*)SRV_FMGR_PATH_ROOT) == 0)
    {
        return MMI_FALSE;
    }
    else if (mmi_ucs2strlen(file_path) == 3)
    {
        /* Drive -> Root */
        mmi_ucs2cpy(file_path, (S8*)SRV_FMGR_PATH_ROOT);
    }
    else
    {
        /* Folder change */
        srv_fmgr_path_remove_filename((WCHAR*)file_path);
    }
    return MMI_TRUE;
}

MMI_BOOL mmi_fmgri_filepath_compose(S8* buffer,
                                    U32 buffer_len, 
                                    S8* base_folder, 
                                    FMGR_FILE_INFO_STRUCT *file_info,
                                    MMI_BOOL add_slash)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 length;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    length = mmi_ucs2strlen(base_folder);
    length += mmi_ucs2strlen(file_info->file_name);
#ifndef __MMI_SHOW_FILE_EXT__
    length += mmi_ucs2strlen(file_info->file_ext);
#endif /* __MMI_SHOW_FILE_EXT__ */

    if (add_slash)
    {
        length ++;
    }

    if (length > buffer_len - 1)    /* Reserve for '\0'; */
    {
        return MMI_FALSE;
    }

    if (!buffer)
    {
        return MMI_TRUE;
    }

    if (buffer != base_folder)
    {
        mmi_ucs2ncpy(buffer, base_folder, buffer_len-1);
    }

    mmi_ucs2cat(buffer, file_info->file_name);
#ifndef __MMI_SHOW_FILE_EXT__
    mmi_ucs2cat(buffer, file_info->file_ext);
#endif /* __MMI_SHOW_FILE_EXT__ */

    if(add_slash)
    {
        mmi_ucs2cat(buffer, (S8*)L"\\");
    }
    return MMI_TRUE;

}

#define QUERY_API

void mmi_fmgri_query_result_setup(S8* filepath, FMGR_FILE_INFO_STRUCT* info, U16 app_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_p->query_filepath = filepath;
    fmgr_p->query_fileinfo = *info;
    fmgr_p->query_app_id = app_id;
}

#ifdef FMGR_TAB_SUPPORT
void mmi_fmgri_query_result_tab_setup(U32 tab_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_p->query_tab_id = tab_id;    
}

U32  mmi_fmgri_get_query_tab(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return fmgr_p->query_tab_id;
}
#endif /* FMGR_TAB_SUPPORT */

void mmi_fmgri_query_result_clear(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_p->query_filepath = 0;
    memset(&fmgr_p->query_fileinfo, 0, sizeof(fmgr_p->query_fileinfo));
    fmgr_p->query_app_id = 0;
#ifdef FMGR_TAB_SUPPORT
    fmgr_p->query_tab_id = 0;
#endif
}


S8* mmi_fmgr_get_current_fileinfo(FMGR_FILE_INFO_STRUCT* info, U16* app_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(info)
        *info = fmgr_p->query_fileinfo;
    if(app_id)
        *app_id = fmgr_p->query_app_id;
    return fmgr_p->query_filepath;
}

#define COMMON_TOOL_API

S8* mmi_fmgri_get_and_lock_buffer_internal(S32 line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for ( i= 0; i< FMGR_MAX_FILEPATH_BUFFER; i++)
    {
        if (!g_file_path_array[i].path)
        {
            break;
        }
    }

    FMGR_ASSERT(i != FMGR_MAX_FILEPATH_BUFFER);

    if (i == 0)
    {
        g_file_path_array[i].path = g_file_path_buffer;
    }
    else
    {
        g_file_path_array[i].path = (S8*)OslMalloc((SRV_FMGR_PATH_MAX_LEN + 1) * ENCODING_LENGTH);
    }
    g_file_path_array[i].path[0] = g_file_path_array[i].path[1] = 0;
    g_file_path_array[i].line = line;
    
    return g_file_path_array[i].path;
}

void mmi_fmgri_free_and_unlock_buffer(S8* buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    FMGR_ASSERT(buffer);
     for ( i= 0; i< FMGR_MAX_FILEPATH_BUFFER; i++)
    {
        if (g_file_path_array[i].path == buffer)
        {
            break;
        }
    }
    FMGR_ASSERT(i != FMGR_MAX_FILEPATH_BUFFER);

    if (i != 0)
    {
        OslMfree(buffer);
    }
    g_file_path_array[i].path = NULL;
    g_file_path_array[i].line = 0;
}

/* Note: please use FMGR_DisplayPopup(), instead of this API */
void mmi_fmgri_displaypopup(U16 err_str_id, mmi_event_notify_enum popup_type, S32 fileline, FuncPtr f)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* Function pointer doesn't work anymore */
    FMGR_TRACE3(TRC_MMI_FMGR_DB003BC7CA7E4FB392E536175D1F39C2, "Fmgr > Popup > id=%d at <%d>:%d \n", err_str_id, 0, fileline);

    mmi_popup_display_simple((WCHAR*)GetString(err_str_id), popup_type, GRP_ID_ROOT, NULL);

}

#ifndef __MTK_TARGET__
void mmi_fmgri_modis_showtrace(char* format, ...)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    va_list argptr;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(!g_fmgr_modis_trace_on)
        return;

    va_start(argptr, format);
    vprintf(format, argptr);
    va_end(argptr);
}
#endif

#define PERFORMANCE
#ifdef _MMI_FMGR_ENABLE_PERF_
U32 g_fmgr_perf_ticks[MMI_FMGRI_PERF_NUM];
S32 g_fmgr_perf_data[MMI_FMGRI_PERF_NUM];

void mmi_fmgri_perf_start(mmi_fmgri_perf_enum id, S32 data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 ticks;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    kal_get_time(&ticks);
    g_fmgr_perf_ticks[id] = ticks;
    g_fmgr_perf_data[id] = data;
}

void mmi_fmgri_perf_end(mmi_fmgri_perf_enum id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 ticks;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    kal_get_time(&ticks);
    ticks = ticks - g_fmgr_perf_ticks[id];
    
    FMGR_TRACE3(TRC_MMI_FMGR_81A40D71FD974ECF83D8480C81F4528B,   
        "[MMIFMGR] > PerfGUI > id=%d, data=%d, time=%d\n",
        id, g_fmgr_perf_data[id], ticks);
}

#endif

#endif // defined (__MMI_FILE_MANAGER__)


