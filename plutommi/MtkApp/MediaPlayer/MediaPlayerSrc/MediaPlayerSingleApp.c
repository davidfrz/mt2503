/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*******************************************************************************
* Filename:
* ---------
*  MediaPlayerSinglApp.c
*
* Project:
* --------
*   MAUI
*
* Description:
* ------------
*   Media Single Player main program
*
* Author:
* -------
 * -------
*
*==============================================================================
*           HISTORY
* Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!! 
*------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
*------------------------------------------------------------------------------
* Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!! 
*==============================================================================
*******************************************************************************/
#include "MMI_features.h"

//#include "MMI_include.h"

#ifdef __MMI_MEDIA_PLAYER__

#include "MMI_features_mediaplayer.h"

//#include "ProfilesSrvGProt.h"
//#include "CommonScreens.h"   /*display pop up*/
#include "app_mine.h"        /* mine type */

#include "mdi_datatype.h"
#include "mdi_audio.h"
#include "mdi_video.h"

#ifdef MOTION_SENSOR_SUPPORT
#include "sensorSrvGport.h"
#endif

#include "MediaPlayerProt.h"
#include "MediaPlayerGprot.h"
//#include "MediaPlayerResDef.h"
#include "MediaPlayerPlayList.h"

#ifdef __MMI_DOWNLOAD_AGENT__
//#include "FileMgr.h"
#include "FileMgrResDef.h"
#include "DLAgentSrvDef.h"
#include "DLAgentSrvGprot.h"
#endif /*__MMI_DOWNLOAD_AGENT__*/

#ifdef __MMI_A2DP_SUPPORT__
#include "av_bt.h"
#endif

#ifdef __MMI_AVRCP_SUPPORT__
#include "BTMMIAVRCPGProt.h"
#endif

/*check usb mode*/
#ifdef __USB_IN_NORMAL_MODE__
#include "USBDeviceGprot.h"
#include "USBSrvGProt.h"
#endif 

/*check in call*/
#include "UcmSrvGprot.h"

/*DRM related*/
#include "DRM_gprot.h"

#ifdef __MMI_RMGR_EXTEND_RIGHTS_AFTER_EXIT_AP__
#include "RightsMgrGprot.h"
#endif

#ifdef __DM_LAWMO_SUPPORT__
#include "Dmuigprot.h"
#endif

#include "FileMgrSrvGProt.h"

#include "UriAgentSrvGprot.h"
#include "MMIDataType.h"
#include "kal_general_types.h"
#include "mmi_frm_events_gprot.h"
#include "mmi_rp_app_medply_def.h"
#include "MediaPlayerEnumDef.h"
#include "stack_msgs.h"
#include "kal_public_api.h"
#include "DebugInitDef_Int.h"
#include "mmi_frm_nvram_gprot.h"
#include "custom_mmi_default_value.h"
#include "TimerEvents.h"
#include "mmi_frm_timer_gprot.h"
#include "MMI_media_app_trc.h"
#include "mmi_media_app_trc.h"
#include "kal_trace.h"
#include "SoundEffect.h"
#include "mmi_frm_scenario_gprot.h"
#include "gdi_include.h"
#include "kurodatatype.h"
#include "mmi_frm_input_gprot.h"
#include "CustDataRes.h"
#include "AlertScreen.h"
#include "device.h"
//#include "kurotypedef.h"
//#include "kuroapi.h"
#include "CommonScreensResDef.h"
#include "gui_data_types.h"
#include "Unicodexdcl.h"
#include "GlobalConstants.h"
#include "app_mem.h"
#include "fs_type.h"
#include "fs_func.h"
#include "mmi_frm_mem_gprot.h"
#include "mmi_res_range_def.h"
#include "GlobalResDef.h"
#include "wgui_categories_util.h"
#include "drm_def.h"
#include "fs_errcode.h"
#include "mmiapi_dm_struct.h"
#include "string.h"
#include "GpioSrvGprot.h"
#include "common_nvram_editor_data_item.h"
#include "mmi_frm_queue_gprot.h"
#include "app_ltlcom.h"
#include "stack_config.h"
#include "FileMgrType.h"
#include "gui_touch_feedback.h"
#include "UCMGProt.h"

#ifdef __TCPIP__
#ifdef __MMI_MEDIA_PLAYER_STREAM__
#include "cbm_api.h"
#endif /*__TCPIP__*/
#endif /*__MMI_MEDIA_PLAYER_STREAM__*/

#ifdef __MMI_MEDIA_PLAYER_STREAM__
#include "CbmSrvGprot.h"
#include "DtcntSrvGprot.h"
#endif
#ifdef __MMI_NCENTER_SUPPORT__
#include "vsrv_ncenter.h"
#endif

#ifdef __MMI_VIDEO_PDL_YOUTUBE__
#include "app_url.h"
#include "app_str.h"
#endif 

#define MMI_MEDPLY_QUERY_BEARER_TIMER 250


#ifdef __MMI_TOUCH_SCREEN__
#define MMI_MEDPLY_SINGLE_HIGH_RATE_SAMPLING_PROGRESS_BAR_PERFORMANCE
#endif
medply_single_struct g_single;

#ifdef __MMI_URI_AGENT__
static void mmi_medply_single_uri_scheme_handler(
                srv_uriagent_appid_enum ura_appid,
                char *url,
                char *param,
                srv_uriagent_options_enum options,
                srv_uriagent_uri_request_hdlr_cb uri_agent_cb);
#endif

#ifdef __MMI_A2DP_SUPPORT__
static void mmi_medply_single_bt_open_callback(S32 result);
#endif
#ifdef __MMI_AVRCP_SUPPORT__
static U8 mmi_medply_single_bt_avrcp_cmd_hdlr(U8 command, mmi_avrcp_key_events key_events);
#endif

#ifdef __MMI_MEDIA_PLAYER_VIDEO__
static void mmi_medply_single_video_play_callback_hdlr(MDI_RESULT result, void *user_data);
#endif
#ifdef __MMI_VIDEO_PDL__
static void mmi_medply_single_pdl_video_play_callback_hdlr(MDI_RESULT result, void *user_data);
#endif

#ifdef __MMI_MEDIA_PLAYER_STREAM__
void mmi_medply_single_bear_event_disconnect(void);
void mmi_medply_single_bear_event_reconnect(void);
static mmi_ret mmi_medply_single_bear_event_callback_hdlr(mmi_event_struct* evt);
static mmi_ret mmi_medply_single_bear_info_callback_hdlr(mmi_event_struct* evt);

#endif
static void mmi_medply_single_group_screen_enter(void);
void mmi_medply_single_enter_main_screen(void);

#ifdef __MTK_TARGET__
__align(4)
#endif /*__MTK_TARGET__*/
U8 g_single_audio_cache[MEDPLY_BUILD_CACHE_SIZE];

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_set_continue_flag
 * DESCRIPTION
 *  set/reset continue flag
 * PARAMETERS
 *  MMI_BOOL    [IN]
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_set_continue_flag(MMI_BOOL flag)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    
    g_single.continue_to_play = flag;
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_set_self_stop_flag
 * DESCRIPTION
 *  set/reset self stop flag
 * PARAMETERS
 *  MMI_BOOL    [IN]
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_set_self_stop_flag(MMI_BOOL flag)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    
    g_single.self_stop = flag;
    return;
}

#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_set_pop_up_flag
 * DESCRIPTION
 *  set pop up flag; this flag shall be called right before pop up so that
 *  exit main screen will skip processing and reset this flag
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_set_pop_up_flag(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 

    g_single.pop_up = MMI_TRUE;
    return;
}
#endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_init_single_app
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL mmi_medply_is_single_player_activated(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL result = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(g_single.state != SINGLE_STATE_IDLE || GetActiveScreenId() == SCR_ID_MEDPLY_SINGLE_MAIN)
    {
        result = MMI_TRUE;
    }

    //MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_IS_SINGLE_ACTIVATED, result);
    return result;
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_init_single_app
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_init_single_app(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S16 error;
#if defined(__MMI_URI_AGENT__) && defined(__MMI_MEDIA_PLAYER_STREAM__)
    srv_uriagent_err_enum result;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

#ifdef __MMI_MEDIA_PLAYER_STREAM__
    SetProtocolEventHandler(mmi_medply_rtsp_url_hdlr, MSG_ID_MMI_MEDPLY_RTSP_URL_REQ);

#ifdef __MMI_URI_AGENT__
    /* register rtsp scheme */
    g_single.confirm_count = 0;
    result = srv_uriagent_register_hdlr_by_scheme("rtsp", mmi_medply_single_uri_scheme_handler, MMI_FALSE);
    MMI_ASSERT(result == SRV_URIAGENT_ERR_OK);
#endif /* defined(__MMI_URI_AGENT__) && defined(__MMI_VIDEO_STREAM__) */


#endif

    ReadValue(NVRAM_MEDIA_PLAYER_SINGLE_VOLUME, &g_single.volume, DS_BYTE, &error);
    if(g_single.volume > MDI_AUD_VOL_EX_MUTE_MAX)
    {
        g_single.volume = MDI_AUD_VOL_EX_7 ;
    }

    ReadValue(NVRAM_MEDIA_PLAYER_SINGLE_MUTE, &g_single.mute, DS_BYTE, &error);
    if(g_single.mute == 0xff)
    {
        g_single.mute = MMI_FALSE;
    }

    if((!g_single.mute) && (MDI_AUD_VOL_EX_MUTE_MIN == g_single.volume))
    {
        g_single.mute = MMI_TRUE;
    }



    g_single.state = SINGLE_STATE_IDLE;
#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
    g_single.intro_play = MMI_FALSE;
#endif
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_update_current_time
 * DESCRIPTION
 *  update current time continuously while in play states
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_update_current_time(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U64 current_time = 0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    switch(g_single.state)
    {
    #ifdef __MMI_MEDIA_PLAYER_AUDIO__
        case SINGLE_STATE_AUDIO_PLAY:
        {
            mdi_result result = MDI_AUDIO_SUCCESS;
            result = mdi_audio_get_progress_time((U32*)&current_time);
            if(result != MDI_AUDIO_SUCCESS)
            {
                return;
            }
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

    #ifdef __MMI_MEDIA_PLAYER_VIDEO__
        case SINGLE_STATE_VIDEO_PLAY:
        {
            mdi_video_ply_get_cur_play_time(&current_time);
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

    #ifdef __MMI_MEDIA_PLAYER_STREAM__
        case SINGLE_STATE_STREAM_PLAY:
        {
            mdi_video_stream_get_cur_play_time(&current_time);
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

    #ifdef __MMI_VIDEO_PDL__
        case SINGLE_STATE_PDL_VIDEO_PLAY:
        {
            mdi_video_ply_get_cur_play_time(&current_time);
            break;
        }
    #endif /*__MMI_VIDEO_PDL__*/

    #ifdef __MMI_AUDIO_PDL__
        case SINGLE_STATE_PDL_AUDIO_PLAY:
        {
            mdi_result result = MDI_AUDIO_SUCCESS;
            result = mdi_audio_mma_get_current_time(g_single.pdl_audio_handle,(U32*)&current_time);
            if(result != MDI_AUDIO_SUCCESS)
            {
                return;
            }
            if(current_time > g_single.current_time && current_time > g_single.duration)
            {
    	        g_single.duration =  current_time;
            }
            break;
        }
    #endif /*__MMI_AUDIO_PDL__*/
        default:
        {
            return;
        }
    }

    g_single.current_time = current_time;

    if(g_single.current_time > g_single.duration)
    {
        g_single.duration = g_single.current_time;
    }
    StartTimer(MEDPLY_UPDATE_TIME_TIMER, 250, mmi_medply_single_update_current_time);

    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_UPDATE_TIME,g_single.state,g_single.current_time, MMI_TRUE);

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_enter_single_states
 * DESCRIPTION
 *  enter single state and redraw main screen
 * PARAMETERS
 *  entered_state     [IN]    entered state
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_enter_single_states(mmi_medply_single_state_enum entered_state)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_SINGLE_STATE,g_single.state,entered_state,g_single.continue_to_play);

#ifdef __MMI_MEDIA_PLAYER_STREAM__
    if(g_single.state == SINGLE_STATE_STREAM_BUFFERING)
    {
        StopTimer(MEDPLY_STREAM_BUFFER_TIMER);
    }
#endif

    g_single.state = entered_state;
    
    switch (entered_state)
    {
        case SINGLE_STATE_IDLE:
        {
            StopTimer(MEDPLY_UPDATE_TIME_TIMER);

        #ifdef __DRM_SUPPORT__    
            g_single.DRM_consumed = MMI_FALSE;
        #endif

            if(!g_single.continue_to_play)
            {
                break;
            }

            switch (g_single.media_type)
            {
            #ifdef __MMI_MEDIA_PLAYER_AUDIO__
                case MEDPLY_TYPE_AUDIO:
                {
                    mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_READY);
                    break;
                }
            #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

            #ifdef __MMI_MEDIA_PLAYER_VIDEO__
                case MEDPLY_TYPE_VIDEO:
                {
                    MMI_BOOL result;
                    result = mmi_medply_single_video_open();
                    if(!result)
                    {
                        return;
                    }
                    break;
                }
            #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

            #ifdef __MMI_MEDIA_PLAYER_STREAM__
                case MEDPLY_TYPE_STREAM:
                {
                    if(g_single.continue_to_play)
                    {
                        mmi_medply_single_set_continue_flag(MMI_FALSE);
                        if(mmi_medply_single_stream_init())
                        {
                            mmi_medply_single_stream_connect();
                        }
                    }
                    else
                    {
                        mmi_medply_change_status(MMI_TRUE);
                    }
                    break;
                }
            #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

                case MEDPLY_TYPE_NONE:
                {
                    mmi_medply_single_set_continue_flag(MMI_FALSE);
                    mmi_medply_change_status(MMI_TRUE);
                    break;
                }

                default:
                {
                    MMI_ASSERT(0);
                    break;
                }
            }
            break;
        }

        case SINGLE_STATE_WAIT_NEXT:
        {
        #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__                
            StopTimer(MEDPLY_UPDATE_TIME_TIMER);
        
            g_single.current_time = 0;
        
            if(!g_single.wait_next_with_pop_up)
            {
                StartTimer(MEDPLY_SINGLE_WAIT_NEXT_TIMER, 700, mmi_medply_single_wait_next_time_out);
            }
            mmi_medply_change_status(MMI_TRUE);
        #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/
            break;
        }

    #ifdef __MMI_MEDIA_PLAYER_AUDIO__    
        case SINGLE_STATE_AUDIO_READY:
        {
            if(g_single.continue_to_play)
            {
                mmi_medply_single_set_continue_flag(MMI_FALSE);
                mmi_medply_single_audio_play();
            }
            else
            {
                StopTimer(MEDPLY_UPDATE_TIME_TIMER);
                mmi_medply_change_status(MMI_TRUE);
            }
            break;
        }

        case SINGLE_STATE_AUDIO_PLAY:
        {
            StartTimer(MEDPLY_UPDATE_TIME_TIMER, 250, mmi_medply_single_update_current_time);
        #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
            if(g_single.intro_play)
            {
                StartTimer(MEDPLY_INTRO_PLAY_TIMER, MEDPLY_INTRO_PLAY_DURATION, mmi_medply_single_intro_play_time_out_hdlr);
            }
        #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/
            mmi_medply_change_status(MMI_TRUE);
            break;
        }

        case SINGLE_STATE_AUDIO_BT_CONNECTING:
        case SINGLE_STATE_AUDIO_PAUSE_PROGRESSING:
        case SINGLE_STATE_AUDIO_PLAY_PROGRESSING:
        {
            StopTimer(MEDPLY_UPDATE_TIME_TIMER);            
            mmi_medply_change_status(MMI_TRUE);
            break; 
        }

        case SINGLE_STATE_AUDIO_IN_HISTORY:
        {
            StopTimer(MEDPLY_UPDATE_TIME_TIMER);            

            if(!g_single.is_audio_seekable)
            {
                g_single.current_time = 0;
            }

            break;
        }        

    #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

    #ifdef __MMI_MEDIA_PLAYER_VIDEO__
        case SINGLE_STATE_VIDEO_OPENING:
        {
            StopTimer(MEDPLY_UPDATE_TIME_TIMER);            
            mmi_medply_change_status(MMI_TRUE);
            break;
        }

        case SINGLE_STATE_VIDEO_READY:
        {
            if(g_single.continue_to_play)
            {
                mmi_medply_single_set_continue_flag(MMI_FALSE);
                mmi_medply_single_video_play();
            }
            else
            {
                StopTimer(MEDPLY_UPDATE_TIME_TIMER);            
                mmi_medply_change_status(MMI_TRUE);
            }            
            break;
        }

        case SINGLE_STATE_VIDEO_PLAY:
        {
            StartTimer(MEDPLY_UPDATE_TIME_TIMER, 250, mmi_medply_single_update_current_time);
        #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
            if(g_single.intro_play)
            {        
                StartTimer(MEDPLY_INTRO_PLAY_TIMER, MEDPLY_INTRO_PLAY_DURATION, mmi_medply_single_intro_play_time_out_hdlr);
            }
        #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/
            mmi_medply_change_status(MMI_TRUE);
            break;
        }

        case SINGLE_STATE_VIDEO_BT_CONNECTING:
        case SINGLE_STATE_VIDEO_PAUSE_PROGRESSING:
        case SINGLE_STATE_VIDEO_PAUSE_SEEKING:
        case SINGLE_STATE_VIDEO_PLAY_PROGRESSING:
        case SINGLE_STATE_VIDEO_PLAY_SEEKING:
        {
            StopTimer(MEDPLY_UPDATE_TIME_TIMER);            
            mmi_medply_change_status(MMI_TRUE);
            break;
        }

        case SINGLE_STATE_VIDEO_IN_HISTORY:
        {
            StopTimer(MEDPLY_UPDATE_TIME_TIMER);            
            break;
        }        
    #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

    #ifdef __MMI_MEDIA_PLAYER_STREAM__
        case SINGLE_STATE_STREAM_CONNECTED:
        {
            if(g_single.continue_to_play)
            {
                mmi_medply_single_set_continue_flag(MMI_FALSE);
                mmi_medply_single_stream_buffer();
            }
            else
            {
                StopTimer(MEDPLY_UPDATE_TIME_TIMER);
                mmi_medply_change_status(MMI_TRUE);
            }
            break;
        }

        case SINGLE_STATE_STREAM_PLAY:
        {
            StartTimer(MEDPLY_UPDATE_TIME_TIMER, 250, mmi_medply_single_update_current_time);
        #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
            if(g_single.intro_play)
            {
                StartTimer(MEDPLY_INTRO_PLAY_TIMER, MEDPLY_INTRO_PLAY_DURATION, mmi_medply_single_intro_play_time_out_hdlr);
            }
        #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/
            mmi_medply_change_status(MMI_TRUE);
            break;
        }

        case SINGLE_STATE_STREAM_CONNECTING:
        case SINGLE_STATE_STREAM_BUFFERING:
        case SINGLE_STATE_STREAM_INITED:
        case SINGLE_STATE_STREAM_BT_CONNECTING:
        case SINGLE_STATE_STREAM_PLAY_PROGRESSING:
        {
            StopTimer(MEDPLY_UPDATE_TIME_TIMER);
            mmi_medply_change_status(MMI_TRUE);         
            break;
        }

        case SINGLE_STATE_STREAM_IN_HISTORY:
        {
            StopTimer(MEDPLY_UPDATE_TIME_TIMER);
            break;
        }        
    #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

    #ifdef __MMI_VIDEO_PDL__
        case SINGLE_STATE_PDL_VIDEO_OPENING:
        {
            StopTimer(MEDPLY_UPDATE_TIME_TIMER);
            mmi_medply_change_status(MMI_TRUE);
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_READY:
        {
            if(g_single.continue_to_play)
            {
                mmi_medply_single_set_continue_flag(MMI_FALSE);
                mmi_medply_single_pdl_video_play();
            }
            else
            {
                StopTimer(MEDPLY_UPDATE_TIME_TIMER);
                mmi_medply_change_status(MMI_TRUE);
            }            
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_PLAY:
        {
            StartTimer(MEDPLY_UPDATE_TIME_TIMER, 250, mmi_medply_single_update_current_time);
            mmi_medply_change_status(MMI_TRUE);
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_BT_CONNECTING:
        case SINGLE_STATE_PDL_VIDEO_PAUSE_BUFFERING:
        case SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING:
        case SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING:
        case SINGLE_STATE_PDL_VIDEO_PAUSE_SEEKING:
        case SINGLE_STATE_PDL_VIDEO_PLAY_PROGRESSING:
        case SINGLE_STATE_PDL_VIDEO_PLAY_SEEKING:
        {
           StopTimer(MEDPLY_UPDATE_TIME_TIMER);
           mmi_medply_change_status(MMI_TRUE);   
           break;            
        }

        case SINGLE_STATE_PDL_VIDEO_IN_HISTORY:
        {
            StopTimer(MEDPLY_UPDATE_TIME_TIMER);
            break;
        }
    #endif /*__MMI_VIDEO_PDL__*/

    #ifdef __MMI_AUDIO_PDL__

        case SINGLE_STATE_PDL_AUDIO_READY:
        {
            /*after open success, enter open state, since mma_open is blocking api,
              we can not execute the play action here*/
            StopTimer(MEDPLY_UPDATE_TIME_TIMER);
            mmi_medply_change_status(MMI_TRUE);
            break;           
        }

        case SINGLE_STATE_PDL_AUDIO_BT_CONNECTING:
        case SINGLE_STATE_PDL_AUDIO_BUFFERING:
        {
            StopTimer(MEDPLY_UPDATE_TIME_TIMER);
            mmi_medply_change_status(MMI_TRUE);
            break;
        }

        case SINGLE_STATE_PDL_AUDIO_PLAY:
        {
            StartTimer(MEDPLY_UPDATE_TIME_TIMER, 250, mmi_medply_single_update_current_time);
            mmi_medply_change_status(MMI_TRUE);
            break;
        }

        case SINGLE_STATE_PDL_AUDIO_IN_HISTORY:
        {
            StopTimer(MEDPLY_UPDATE_TIME_TIMER);
            break;
        }
    #endif /*__MMI_AUDIO_PDL__*/

        default:
        {
            break;
        }
    }
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_stop_button_down
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_stop_button_down(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_STOP_DOWN,g_single.selected_button, MMI_TRUE);

    if(g_single.selected_button == MEDPLY_MAIN_DISABLED)
    {
        return;
    }

    g_single.selected_button = MEDPLY_MAIN_STOP;
    g_single.selected_button_down = MMI_TRUE;

    mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_STOP, 
            MMI_MEDPLY_RGN_STATUS_DOWN);
    mmi_medply_main_screen_blt();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_stop_button_up
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_stop_button_up(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_STOP_UP,g_single.selected_button,g_single.selected_button_down,g_single.state, MMI_TRUE); 

    if(g_single.selected_button != MEDPLY_MAIN_STOP || g_single.selected_button_down != MMI_TRUE)
    {
        return;
    }

    g_single.selected_button_down = MMI_FALSE;

    mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_STOP,
        MMI_MEDPLY_RGN_STATUS_UP);
    mmi_medply_main_screen_blt();

    switch(g_single.state)
    {
    /*----audio----*/        
    #ifdef __MMI_MEDIA_PLAYER_AUDIO__
        case SINGLE_STATE_AUDIO_READY:
        {
            g_single.current_time = 0;

        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif

            mmi_medply_main_screen_reset();
            mmi_medply_main_screen_blt();
            break;
        }
        case SINGLE_STATE_AUDIO_BT_CONNECTING:
        {

        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif

        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_single_set_continue_flag(MMI_FALSE);
            g_single.current_time = 0;
            
            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_READY);
            break;
        }

        case SINGLE_STATE_AUDIO_PLAY:
        {
            mmi_medply_single_set_self_stop_flag(MMI_TRUE);

            /*stop file*/
            mdi_audio_stop_file();

            mmi_medply_single_set_self_stop_flag(MMI_FALSE);

        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif

            mmi_medply_single_set_continue_flag(MMI_FALSE);
            g_single.current_time = 0;
            
            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_READY);
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

    /*----video----*/
    #ifdef __MMI_MEDIA_PLAYER_VIDEO__
        case SINGLE_STATE_VIDEO_OPENING:
        {
            mmi_medply_single_set_continue_flag(MMI_FALSE);
            break;
        }

        case SINGLE_STATE_VIDEO_READY:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            g_single.current_time = 0;

        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_seek_and_get_frame(
                        g_single.current_time,
                        video_layer_info.layer_hdl
                        #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                        ,video_layer_info.layer_subtitle_hdl
                        #endif
                        );

            if(result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }
            else
            {
                mmi_medply_main_screen_reset();
                mmi_medply_main_screen_blt();
            }

            break;
        }

        case SINGLE_STATE_VIDEO_BT_CONNECTING:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            g_single.current_time = 0;

        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif

        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_seek_and_get_frame(
                        g_single.current_time,
                        video_layer_info.layer_hdl
                        #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                        ,video_layer_info.layer_subtitle_hdl
                        #endif
                        );

            if(result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }
            else
            {
                mmi_medply_main_screen_reset();
                mmi_medply_main_screen_blt();
                mmi_medply_single_set_continue_flag(MMI_FALSE);
                mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_READY);
            }
            break;
        }

        case SINGLE_STATE_VIDEO_PLAY:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            /*stop video*/
            mdi_video_ply_stop();
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            g_single.current_time = 0;
        
        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;       
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_seek_and_get_frame(
                        g_single.current_time,
                        video_layer_info.layer_hdl
                        #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                        ,video_layer_info.layer_subtitle_hdl
                        #endif
                        );
        
            if(result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }
            else
            {
                mmi_medply_main_screen_blt();
                mmi_medply_single_set_continue_flag(MMI_FALSE);
                mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_READY);
            }
            break;
        }

        case SINGLE_STATE_VIDEO_PLAY_SEEKING:
        case SINGLE_STATE_VIDEO_PAUSE_SEEKING:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            g_single.current_time = 0;

        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif

            mdi_video_ply_stop_non_block_seek();

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_seek_and_get_frame(
                        g_single.current_time,
                        video_layer_info.layer_hdl
                        #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                        ,video_layer_info.layer_subtitle_hdl
                        #endif
                        );
                        
            if(result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }
            else
            {
                mmi_medply_main_screen_blt();            
                mmi_medply_single_set_continue_flag(MMI_FALSE);
                mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_READY);
            }            
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

    /*----stream----*/
    #ifdef __MMI_MEDIA_PLAYER_STREAM__

        case SINGLE_STATE_STREAM_INITED:
        {
            g_single.current_time = 0;
        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif
            mmi_medply_single_set_continue_flag(MMI_FALSE);        
            mmi_medply_main_screen_draw_duration();
            mmi_medply_main_screen_blt();

            break;
        }

        case SINGLE_STATE_STREAM_CONNECTING:
        {
            g_single.current_time = 0;
        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif            
            mmi_medply_single_set_continue_flag(MMI_FALSE);
            mdi_video_stream_disconnect();
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
            break;
        }

        case SINGLE_STATE_STREAM_CONNECTED:
        {
	     mmi_medply_video_play_para_struct video_layer_info;

            g_single.current_time = 0;
        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif            
            mmi_medply_single_set_continue_flag(MMI_FALSE);
            mdi_video_stream_disconnect();
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);

            mmi_medply_main_screen_reset();

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);
            gdi_layer_push_and_set_active(video_layer_info.layer_hdl);
            gdi_layer_clear(GDI_COLOR_BLACK);    
            gdi_layer_set_source_key(TRUE, GDI_COLOR_TRANSPARENT);
            gdi_layer_pop_and_restore_active();

            mmi_medply_main_screen_blt();
            break;
        }

        case SINGLE_STATE_STREAM_BT_CONNECTING:
        {
            g_single.current_time = 0;

        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif

        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_single_set_continue_flag(MMI_FALSE);
            mdi_video_stream_disconnect();
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
            break;
        }

        case SINGLE_STATE_STREAM_BUFFERING:
        {
            StopTimer(MEDPLY_STREAM_BUFFER_TIMER);            
        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif

        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mdi_video_stream_stop_buffering();
            mmi_medply_single_set_continue_flag(MMI_FALSE);
            mdi_video_stream_disconnect();
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
            break;
        }

        case SINGLE_STATE_STREAM_PLAY:
        {
            mmi_medply_video_play_para_struct video_layer_info;
            mdi_video_stream_stop();
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            g_single.current_time = 0;
        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif
            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);
            gdi_layer_push_and_set_active(video_layer_info.layer_hdl);
            gdi_layer_clear(GDI_COLOR_BLACK);    
            gdi_layer_set_source_key(TRUE, GDI_COLOR_TRANSPARENT);
            gdi_layer_pop_and_restore_active();

            mmi_medply_main_screen_blt();

            mmi_medply_single_set_continue_flag(MMI_FALSE);
            mdi_video_stream_disconnect();
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

    /*----pdl video----*/
    #ifdef __MMI_VIDEO_PDL__
        case SINGLE_STATE_PDL_VIDEO_READY:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;
            
            g_single.current_time = 0;

    #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
    #endif

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_seek_and_get_frame(
                        g_single.current_time,
                        video_layer_info.layer_hdl
                        #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                        ,video_layer_info.layer_subtitle_hdl
                        #endif
                        );

            if(result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }
            else
            {
                mmi_medply_main_screen_blt();
                mmi_medply_change_status(MMI_TRUE);
            }

            break;
        }

        case SINGLE_STATE_PDL_VIDEO_BT_CONNECTING:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;
            
            g_single.current_time = 0;

    #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
    #endif

        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_seek_and_get_frame(
                        g_single.current_time,
                        video_layer_info.layer_hdl
                        #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                        ,video_layer_info.layer_subtitle_hdl
                        #endif
                        );

            if(result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }
            else
            {
                mmi_medply_main_screen_blt();
                mmi_medply_single_set_continue_flag(MMI_FALSE);
                mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_READY);
            }

            break;
   
        }

        case SINGLE_STATE_PDL_VIDEO_PLAY:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            /*stop video*/
            mdi_video_ply_stop();
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif


            g_single.current_time = 0;
        
    #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
    #endif    

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_seek_and_get_frame(
                        g_single.current_time,
                        video_layer_info.layer_hdl
                        #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                        ,video_layer_info.layer_subtitle_hdl
                        #endif
                        );
        
            if(result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }
            else
            {
                mmi_medply_main_screen_blt();
                mmi_medply_single_set_continue_flag(MMI_FALSE);
                mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_READY);
            }
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_PLAY_SEEKING:
        case SINGLE_STATE_PDL_VIDEO_PAUSE_SEEKING:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            g_single.current_time = 0;

    #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
    #endif

            mdi_video_ply_stop_non_block_seek();

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_seek_and_get_frame(
                        g_single.current_time,
                        video_layer_info.layer_hdl
                        #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                        ,video_layer_info.layer_subtitle_hdl
                        #endif
                        );
                        
            if(result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }
            else
            {
                mmi_medply_main_screen_blt();
                mmi_medply_single_set_continue_flag(MMI_FALSE);
                mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_READY);
            }            
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING:
        case SINGLE_STATE_PDL_VIDEO_PAUSE_BUFFERING:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            StopTimer(MEDPLY_PDL_BUFFER_TIMER);
        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif  
                    
            g_single.current_time = 0;
                
            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_seek_and_get_frame(
                        g_single.current_time,
                        video_layer_info.layer_hdl
                        #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                        ,video_layer_info.layer_subtitle_hdl
                        #endif
                        );
            
            if(result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }
            else
            {
                mmi_medply_main_screen_blt();
                mmi_medply_single_set_continue_flag(MMI_FALSE);
                mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_READY);
            }
            break;
        }
    #endif /*__MMI_VIDEO_PDL__*/

    /*----pdl audio----*/
    #ifdef __MMI_AUDIO_PDL__
        case SINGLE_STATE_PDL_AUDIO_READY:
        {
            g_single.current_time = 0;
            mmi_medply_main_screen_reset();
            mmi_medply_main_screen_blt();
            break;
        }

        case SINGLE_STATE_PDL_AUDIO_PLAY:
        {
            mdi_result result;
            g_single.current_time = 0;
            result = mdi_audio_mma_stop(g_single.pdl_audio_handle);
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            if(result != MDI_AUDIO_SUCCESS)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                return;
            }
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_AUDIO_READY);
            break;
        }

        case SINGLE_STATE_PDL_AUDIO_BUFFERING:
        {
            g_single.current_time = 0;
            StopTimer(MEDPLY_PDL_BUFFER_TIMER);
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_AUDIO_READY);
            break;
        }

        case SINGLE_STATE_PDL_AUDIO_BT_CONNECTING:
        {
            g_single.current_time = 0;
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_AUDIO_READY);
            break;
        }

    #endif /*__MMI_AUDIO_PDL__*/

    }

    ClearKeyEvents();

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_play_button_down
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_play_button_down(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PLAY_DOWN,g_single.selected_button, MMI_TRUE);

    if(g_single.selected_button == MEDPLY_MAIN_DISABLED || mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_PAUSE) || mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_PLAY))
    {
        return;
    }

    g_single.selected_button = MEDPLY_MAIN_PLAY;
    g_single.selected_button_down = MMI_TRUE;

    mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PLAY_PAUSE,
            MMI_MEDPLY_RGN_STATUS_DOWN);
    mmi_medply_main_screen_blt();

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_play_button_up
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_play_button_up(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PLAY_UP,g_single.selected_button,g_single.selected_button_down,g_single.state, MMI_TRUE);
    
    if (g_single.selected_button != MEDPLY_MAIN_PLAY || g_single.selected_button_down != MMI_TRUE)
    {
        return;
    }

    g_single.selected_button_down = MMI_FALSE;

    mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PLAY_PAUSE,
        MMI_MEDPLY_RGN_STATUS_UP);

    if(mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_PAUSE) || mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_PLAY))
    {
        mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PLAY_PAUSE,
            MMI_MEDPLY_RGN_STATUS_DISABLE);
        mmi_medply_main_screen_blt();
        return;
    }

    mmi_medply_main_screen_blt();

    switch (g_single.state)
    {
    /*----audio----*/
    #ifdef __MMI_MEDIA_PLAYER_AUDIO__
        case SINGLE_STATE_AUDIO_READY:
        {
            mmi_medply_single_audio_play();
            break;
        }

        case SINGLE_STATE_AUDIO_PLAY:
        {
            U32 current_time;
            if(!g_single.is_audio_seekable)
            {
                mmi_popup_display_simple((WCHAR*)GetString(STR_ID_MEDPLY_ERR_ADIF_NOT_SUPPORT_PAUSE), MMI_EVENT_FAILURE, GRP_ID_MEDPLY_SINGLE, NULL);
                return;
            }

            /*set to latest time*/
            mdi_audio_get_progress_time(&current_time);

            if(current_time > g_single.duration)
            {
                g_single.duration = current_time;
            }

            /*this means alrady played to the end, so do not reset time back to 0*/
            if( current_time == 0 && g_single.current_time != 0) 
            {
                g_single.current_time = g_single.duration;
            }
            else
            {
                g_single.current_time = (U64)current_time ;
            }

            mmi_medply_single_set_self_stop_flag(MMI_TRUE);

            /*stop file*/
            mdi_audio_stop_file();

            mmi_medply_single_set_self_stop_flag(MMI_FALSE);

        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_single_set_continue_flag(MMI_FALSE);

            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_READY);


            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

    /*----video----*/
    #ifdef __MMI_MEDIA_PLAYER_VIDEO__

        case SINGLE_STATE_VIDEO_READY:
        {
            mmi_medply_single_video_play();
            break;
        }

        case SINGLE_STATE_VIDEO_PLAY:
        {
            mmi_medply_single_video_pause();
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

    /*----stream----*/
    #ifdef __MMI_MEDIA_PLAYER_STREAM__
        case SINGLE_STATE_STREAM_INITED:
        {
            mmi_medply_single_stream_connect();
            break;
        }

        case SINGLE_STATE_STREAM_CONNECTED:
        {
            mmi_medply_single_stream_buffer();
            break;
        }

        case SINGLE_STATE_STREAM_PLAY:
        {
            mdi_video_stream_stop();

        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

        if(!g_single.seekable)
        {
            g_single.duration = 0;
            g_single.current_time = 0;
        }

            mmi_medply_single_set_continue_flag(MMI_FALSE);
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_CONNECTED);            
            break;
        }

    /* FTE project needs to handle stop actions for following states*/
    #ifdef __MMI_MEDIA_PLAYER_FTE__
        case SINGLE_STATE_STREAM_CONNECTING:
        {
        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif            
            mmi_medply_single_set_continue_flag(MMI_FALSE);
            mdi_video_stream_disconnect();
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
            break;
        }

        case SINGLE_STATE_STREAM_BUFFERING:
        {
            StopTimer(MEDPLY_STREAM_BUFFER_TIMER);            
        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif
            mdi_video_stream_stop_buffering();
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif
            mmi_medply_single_set_continue_flag(MMI_FALSE);
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_CONNECTED);
            break;
        }

    #endif /*__MMI_MEDIA_PLAYER_FTE__*/

    #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

    /*----pdl video----*/
    #ifdef __MMI_VIDEO_PDL__

        case SINGLE_STATE_PDL_VIDEO_READY:
        {
            mmi_medply_single_pdl_video_play();
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_PLAY:
        {
            mmi_medply_single_pdl_video_pause();
            break;
        }

    /* FTE project needs to handle stop actions for following states*/
    #ifdef __MMI_MEDIA_PLAYER_FTE__
        case SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING:
        case SINGLE_STATE_PDL_VIDEO_PAUSE_BUFFERING:
        {
            mmi_medply_video_play_para_struct video_layer_info;

            StopTimer(MEDPLY_PDL_BUFFER_TIMER);
        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif  

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            gdi_layer_push_and_set_active(video_layer_info.layer_hdl);
            gdi_layer_clear(GDI_COLOR_BLACK);    
            gdi_layer_set_source_key(TRUE, GDI_COLOR_TRANSPARENT);
            gdi_layer_pop_and_restore_active();
            mmi_medply_main_screen_blt();
        
            mmi_medply_single_set_continue_flag(MMI_FALSE);
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_READY);
            break;
        }

    #endif /*__MMI_MEDIA_PLAYER_FTE__*/

    #endif /*__MMI_VIDEO_PDL__*/

    /*----pdl audio----*/
    #ifdef __MMI_AUDIO_PDL__
        case SINGLE_STATE_PDL_AUDIO_READY:
        {
            mmi_medply_single_pdl_audio_play();
            break;
        }

        case SINGLE_STATE_PDL_AUDIO_PLAY:
        {
            mdi_result result;
            result = mdi_audio_mma_stop(g_single.pdl_audio_handle);
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            if(result != MDI_AUDIO_SUCCESS)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                return;
            }
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_AUDIO_READY);
            break;
        }

    /* FTE project needs to handle stop actions for following states*/
    #ifdef __MMI_MEDIA_PLAYER_FTE__
        case SINGLE_STATE_PDL_AUDIO_BUFFERING:
        {
            StopTimer(MEDPLY_PDL_BUFFER_TIMER);
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_AUDIO_READY);
        }
    #endif

    #endif /*__MMI_AUDIO_PDL__*/

        default:
        {
            break;
        }

    }

    ClearKeyEvents();

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_prev_button_down
 * DESCRIPTION
 *  handle event previous button down
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_prev_button_down(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PREV_DOWN,g_single.selected_button, MMI_TRUE);

    if(g_single.selected_button == MEDPLY_MAIN_DISABLED || mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_PREV_NEXT))
    {
        return;
    }

    g_single.selected_button = MEDPLY_MAIN_PREV;
    g_single.selected_button_down = MMI_TRUE;

    mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PREV, 
		MMI_MEDPLY_RGN_STATUS_DOWN);
    mmi_medply_main_screen_blt();

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_prev_button_up
 * DESCRIPTION
 *  handle event previous button up
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_prev_button_up(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PREV_UP,g_single.selected_button,g_single.selected_button_down,g_single.state, MMI_TRUE);

    if(g_single.selected_button != MEDPLY_MAIN_PREV || g_single.selected_button_down != MMI_TRUE)
    {
        return;
    }

    g_single.selected_button_down = MMI_FALSE;

    mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PREV,
        MMI_MEDPLY_RGN_STATUS_UP);
    mmi_medply_main_screen_blt();

    switch(g_single.state)
    {
    /*----audio----*/
    #ifdef __MMI_MEDIA_PLAYER_AUDIO__    
        case SINGLE_STATE_AUDIO_PAUSE_PROGRESSING:
        {
            if(g_single.need_to_build_cache)
            {
                mdi_audio_stop_build_cache();
            }
            mmi_medply_main_screen_duration_seek_done();

            mmi_medply_single_set_continue_flag(MMI_FALSE);            
            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_READY);
            break;
        }

        case SINGLE_STATE_AUDIO_PLAY_PROGRESSING:
        {
            if(g_single.need_to_build_cache)
            {
                mdi_audio_stop_build_cache();
            }
            mmi_medply_main_screen_duration_seek_done();

            mmi_medply_single_audio_play();
            break;
        }

        case SINGLE_STATE_AUDIO_BT_CONNECTING:
        case SINGLE_STATE_AUDIO_PLAY:
        case SINGLE_STATE_AUDIO_READY:
        {
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PREV, MMI_MEDPLY_RGN_STATUS_UP);
            mmi_medply_main_screen_blt();
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

    /*----video----*/
    #ifdef __MMI_MEDIA_PLAYER_VIDEO__
        case SINGLE_STATE_VIDEO_PAUSE_PROGRESSING:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            mmi_medply_main_screen_duration_seek_done();

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                    g_single.current_time,
                    video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                    mmi_medply_single_video_seek_callback_hdlr,
                    0);

            if (result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }

            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PAUSE_SEEKING);
            
            break;
        }

        case SINGLE_STATE_VIDEO_PLAY_PROGRESSING:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            mmi_medply_main_screen_duration_seek_done();

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                    g_single.current_time,
                    video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                    mmi_medply_single_video_seek_callback_hdlr,
                    0);

            if (result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }

            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PLAY_SEEKING);

            break;
        }

        case SINGLE_STATE_VIDEO_BT_CONNECTING:
        case SINGLE_STATE_VIDEO_PAUSE_SEEKING:
        case SINGLE_STATE_VIDEO_PLAY_SEEKING:
        case SINGLE_STATE_VIDEO_OPENING:
        case SINGLE_STATE_VIDEO_READY:
        case SINGLE_STATE_VIDEO_PLAY:
        {
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PREV, MMI_MEDPLY_RGN_STATUS_UP);
            mmi_medply_main_screen_blt();
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

    /*----stream----*/
    #ifdef __MMI_MEDIA_PLAYER_STREAM__

        case SINGLE_STATE_STREAM_PLAY_PROGRESSING:
        {
            mmi_medply_main_screen_duration_seek_done();
            mmi_medply_single_stream_buffer();            
            break;
        }

        case SINGLE_STATE_STREAM_BT_CONNECTING:
        case SINGLE_STATE_STREAM_INITED:
        case SINGLE_STATE_STREAM_CONNECTING:
        case SINGLE_STATE_STREAM_CONNECTED:
        case SINGLE_STATE_STREAM_BUFFERING:
        case SINGLE_STATE_STREAM_PLAY:
        {
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PREV, MMI_MEDPLY_RGN_STATUS_UP);
            mmi_medply_main_screen_blt();
            break;
        }
 
    #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

    /*----pdl----*/
    #ifdef __MMI_VIDEO_PDL__
        case SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            mmi_medply_main_screen_duration_seek_done();

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                    g_single.current_time,
                    video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                    mmi_medply_single_pdl_video_seek_callback_hdlr,
                    0);

            if (result == MDI_RES_VDOPLY_PROGRESSIVE_FILE_NOT_ENOUGH)
            {
                StartTimer(MEDPLY_PDL_BUFFER_TIMER, 100, mmi_medply_single_pdl_video_update_buffer_percent);
                mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PAUSE_BUFFERING);
                break;
            }

            if (result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }

            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PAUSE_SEEKING);
            
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_PLAY_PROGRESSING:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            mmi_medply_main_screen_duration_seek_done();

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                    g_single.current_time,
                    video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                    mmi_medply_single_pdl_video_seek_callback_hdlr,
                    0);

            if (result == MDI_RES_VDOPLY_PROGRESSIVE_FILE_NOT_ENOUGH)
            {
                StartTimer(MEDPLY_PDL_BUFFER_TIMER, 100, mmi_medply_single_pdl_video_update_buffer_percent);
                mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING);
                break;
            }

            if (result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }

            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PLAY_SEEKING);

            break;
        }

        case SINGLE_STATE_PDL_VIDEO_BT_CONNECTING:
        case SINGLE_STATE_PDL_VIDEO_PAUSE_SEEKING:
        case SINGLE_STATE_PDL_VIDEO_PLAY_SEEKING:
        case SINGLE_STATE_PDL_VIDEO_OPENING:
        case SINGLE_STATE_PDL_VIDEO_READY:
        case SINGLE_STATE_PDL_VIDEO_PLAY:
        {
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PREV, MMI_MEDPLY_RGN_STATUS_UP);
            mmi_medply_main_screen_blt();
            break;
        }
    #endif /*__MMI_VIDEO_PDL__*/

    #ifdef __MMI_AUDIO_PDL__
        case SINGLE_STATE_PDL_AUDIO_BT_CONNECTING:
        case SINGLE_STATE_PDL_AUDIO_PLAY:
        case SINGLE_STATE_PDL_AUDIO_READY:
        {
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PREV, MMI_MEDPLY_RGN_STATUS_UP);
            mmi_medply_main_screen_blt();
            break;
        }
    #endif /*__MMI_AUDIO_PDL__*/

        default:
        {
            break;
        }

    }

    ClearKeyEvents();

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_next_button_down
 * DESCRIPTION
 *  handle event next button down
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_next_button_down(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_NEXT_DOWN,g_single.selected_button, MMI_TRUE);

    if(g_single.selected_button == MEDPLY_MAIN_DISABLED || mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_PREV_NEXT))
    {
        return;
    }

    g_single.selected_button = MEDPLY_MAIN_NEXT;
    g_single.selected_button_down = MMI_TRUE;

    mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_NEXT, MMI_MEDPLY_RGN_STATUS_DOWN);
    mmi_medply_main_screen_blt();

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_press_next_button_up
 * DESCRIPTION
 *  handle event next button up
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_next_button_up(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_NEXT_UP,g_single.selected_button,g_single.selected_button_down,g_single.state, MMI_FALSE);

    if(g_single.selected_button != MEDPLY_MAIN_NEXT || g_single.selected_button_down != MMI_TRUE)
    {
        return;
    }

    g_single.selected_button_down = MMI_FALSE;

    mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_NEXT,
        MMI_MEDPLY_RGN_STATUS_UP);
    mmi_medply_main_screen_blt();

    switch(g_single.state)
    {
    /*----audio----*/
    #ifdef __MMI_MEDIA_PLAYER_AUDIO__    
        case SINGLE_STATE_AUDIO_PAUSE_PROGRESSING:
        {
            if(g_single.need_to_build_cache)
            {
                mdi_audio_stop_build_cache();
            }
            mmi_medply_main_screen_duration_seek_done();        
            mmi_medply_single_set_continue_flag(MMI_FALSE);            
            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_READY);
            break;
        }
        
        case SINGLE_STATE_AUDIO_PLAY_PROGRESSING:
        {
            if(g_single.need_to_build_cache)
            {
                mdi_audio_stop_build_cache();
            }
            mmi_medply_main_screen_duration_seek_done();
            mmi_medply_single_audio_play();
            break;
        }

        case SINGLE_STATE_AUDIO_BT_CONNECTING:
        case SINGLE_STATE_AUDIO_PLAY:
        case SINGLE_STATE_AUDIO_READY:
        {
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_NEXT, MMI_MEDPLY_RGN_STATUS_UP);
            mmi_medply_main_screen_blt();
            break;
        }

    #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

    /*----video----*/
    #ifdef __MMI_MEDIA_PLAYER_VIDEO__

        case SINGLE_STATE_VIDEO_PAUSE_PROGRESSING:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            mmi_medply_main_screen_duration_seek_done();

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                    g_single.current_time,
                    video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                    mmi_medply_single_video_seek_callback_hdlr,
                    0);

            if (result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }

            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PAUSE_SEEKING);            
            break;
        }
        
        case SINGLE_STATE_VIDEO_PLAY_PROGRESSING:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            mmi_medply_main_screen_duration_seek_done();

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                    g_single.current_time,
                    video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                    mmi_medply_single_video_seek_callback_hdlr,
                    0);

            if (result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }

            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PLAY_SEEKING);            
            break;
        }

        case SINGLE_STATE_VIDEO_BT_CONNECTING:
        case SINGLE_STATE_VIDEO_PAUSE_SEEKING:
        case SINGLE_STATE_VIDEO_PLAY_SEEKING:
        case SINGLE_STATE_VIDEO_OPENING:
        case SINGLE_STATE_VIDEO_READY:
        case SINGLE_STATE_VIDEO_PLAY:
        {
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_NEXT, MMI_MEDPLY_RGN_STATUS_UP);
            mmi_medply_main_screen_blt();
            break;
        }

    #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

    /*----stream----*/
    #ifdef __MMI_MEDIA_PLAYER_STREAM__

        case SINGLE_STATE_STREAM_PLAY_PROGRESSING:
        {
            mmi_medply_main_screen_duration_seek_done();
            mmi_medply_single_stream_buffer();
            break;
        }

        case SINGLE_STATE_STREAM_BT_CONNECTING:
        case SINGLE_STATE_STREAM_INITED:
        case SINGLE_STATE_STREAM_CONNECTING:
        case SINGLE_STATE_STREAM_CONNECTED:
        case SINGLE_STATE_STREAM_BUFFERING:
        case SINGLE_STATE_STREAM_PLAY:
        {
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_NEXT, MMI_MEDPLY_RGN_STATUS_UP);
            mmi_medply_main_screen_blt();
            break;
        }
    
    #endif /*__MMI_MEDIA_PLAYER_STREAM__*/    

    /*----PDL----*/
    #ifdef __MMI_VIDEO_PDL__

        case SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            mmi_medply_main_screen_duration_seek_done();

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mdi_video_ply_non_block_seek_and_get_frame(
                    g_single.current_time,
                    video_layer_info.layer_hdl,
                    mmi_medply_single_pdl_video_seek_callback_hdlr,
                    0);

            if (result == MDI_RES_VDOPLY_PROGRESSIVE_FILE_NOT_ENOUGH)
            {
                StartTimer(MEDPLY_PDL_BUFFER_TIMER, 100, mmi_medply_single_pdl_video_update_buffer_percent);
                mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PAUSE_BUFFERING);
                break;
            }

            if (result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                break;
            }

            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PAUSE_SEEKING);
            break;
        }
        
        case SINGLE_STATE_PDL_VIDEO_PLAY_PROGRESSING:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            mmi_medply_main_screen_duration_seek_done();

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mdi_video_ply_non_block_seek_and_get_frame(
                    g_single.current_time,
                    video_layer_info.layer_hdl,
                    mmi_medply_single_pdl_video_seek_callback_hdlr,
                    0);

            if (result == MDI_RES_VDOPLY_PROGRESSIVE_FILE_NOT_ENOUGH)
            {
                StartTimer(MEDPLY_PDL_BUFFER_TIMER, 100, mmi_medply_single_pdl_video_update_buffer_percent);
                mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING);
                break;
            }

            if (result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                break;
            }

            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PLAY_SEEKING);            
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_BT_CONNECTING:
        case SINGLE_STATE_PDL_VIDEO_PAUSE_SEEKING:
        case SINGLE_STATE_PDL_VIDEO_PLAY_SEEKING:
        case SINGLE_STATE_PDL_VIDEO_OPENING:
        case SINGLE_STATE_PDL_VIDEO_READY:
        case SINGLE_STATE_PDL_VIDEO_PLAY:
        {
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_NEXT, MMI_MEDPLY_RGN_STATUS_UP);
            mmi_medply_main_screen_blt();
            break;
        }

    #endif /*__MMI_VIDEO_PDL__*/

    #ifdef __MMI_AUDIO_PDL__
        case SINGLE_STATE_PDL_AUDIO_BT_CONNECTING:
        case SINGLE_STATE_PDL_AUDIO_PLAY:
        case SINGLE_STATE_PDL_AUDIO_READY:
        {
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_NEXT, MMI_MEDPLY_RGN_STATUS_UP);
            mmi_medply_main_screen_blt();
            break;
        }
    #endif /*__MMI_AUDIO_PDL__*/

        default:
        {
            break;
        }
            
    }

    ClearKeyEvents();

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_fast_forward
 * DESCRIPTION
 *  fast forward
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_fast_forward(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_FAST_FORWARD,g_single.seekable,g_single.state, MMI_TRUE);
    
    if(!g_single.seekable)
    {
        return;
    }

    if (!(g_single.selected_button == MEDPLY_MAIN_NEXT && g_single.selected_button_down == MMI_TRUE ))
    {
        return; 
    }

    switch(g_single.state)
    {
    /*----audio----*/
    #ifdef __MMI_MEDIA_PLAYER_AUDIO__
        case SINGLE_STATE_AUDIO_READY:
        {
            MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_FAST_FORWARD_AUDIO,g_single.need_to_build_cache,g_single.audio_build_cache_process, MMI_TRUE);

            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_PAUSE_PROGRESSING);

            if (g_single.need_to_build_cache && g_single.audio_build_cache_process< 100)
            {
                /*send message to med_v to start process*/
                mdi_audio_start_build_cache(g_single.filefullpath,
                                            g_single_audio_cache,
                                            MEDPLY_BUILD_CACHE_SIZE,
                                            NULL,//g_single.audio_cache_file_buf_p,
                                            0,//MEDPLY_BUILD_CACHE_FILE_BUF_SIZE,
                                            NULL,//g_single.audio_cache_proc_buf_p,
                                            0,//MEDPLY_BUILD_CACHE_PROC_BUF_SIZE,
                                            mmi_medply_single_build_cache_fail_callback_hdlr,
                                            &g_single.audio_build_cache_process);
            }
            mmi_medply_main_screen_duration_seek_next();
            break;
        }

        case SINGLE_STATE_AUDIO_PLAY:
        {

            MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_FAST_FORWARD_AUDIO,g_single.need_to_build_cache,g_single.audio_build_cache_process, MMI_TRUE);

            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_PLAY_PROGRESSING);

            mmi_medply_single_set_self_stop_flag(MMI_TRUE);
        
            mdi_audio_stop_file();
        
            mmi_medply_single_set_self_stop_flag(MMI_FALSE);

        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_single_set_continue_flag(MMI_FALSE);


            if (g_single.need_to_build_cache && g_single.audio_build_cache_process< 100)
            {
                /*send message to med_v to start process*/
                mdi_audio_start_build_cache(g_single.filefullpath,
                                            g_single_audio_cache,
                                            MEDPLY_BUILD_CACHE_SIZE,
                                            NULL,//g_single.audio_cache_file_buf_p,
                                            0,//MEDPLY_BUILD_CACHE_FILE_BUF_SIZE,
                                            NULL,//g_single.audio_cache_proc_buf_p,
                                            0,//MEDPLY_BUILD_CACHE_PROC_BUF_SIZE,
                                            mmi_medply_single_build_cache_fail_callback_hdlr,
                                            &g_single.audio_build_cache_process);
            }
            mmi_medply_main_screen_duration_seek_next();            
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

    /*----video----*/
    #ifdef __MMI_MEDIA_PLAYER_VIDEO__
        case SINGLE_STATE_VIDEO_READY:
        {
            mmi_medply_main_screen_duration_seek_next();
            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PAUSE_PROGRESSING);
            break;
        }

        case SINGLE_STATE_VIDEO_PLAY:
        {
            mdi_video_ply_stop();
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PLAY_PROGRESSING);
            mmi_medply_main_screen_duration_seek_next();

            break;
        }

        case SINGLE_STATE_VIDEO_PLAY_SEEKING:
        {
            mdi_video_ply_stop_non_block_seek();
            mmi_medply_main_screen_duration_seek_next();
            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PLAY_PROGRESSING);

            break;
        }

        case SINGLE_STATE_VIDEO_PAUSE_SEEKING:
        {
            mdi_video_ply_stop_non_block_seek();
            mmi_medply_main_screen_duration_seek_next();
            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PAUSE_PROGRESSING);

            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

    /*----stream----*/
    #ifdef __MMI_MEDIA_PLAYER_STREAM__    
        case SINGLE_STATE_STREAM_CONNECTED:
        {
            mmi_medply_main_screen_duration_seek_next();
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_PLAY_PROGRESSING);
            break;
        }

        case SINGLE_STATE_STREAM_PLAY:
        {
            mdi_video_stream_stop();
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_PLAY_PROGRESSING);

            mmi_medply_main_screen_duration_seek_next();

            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

    /*----pdl----*/
    #ifdef __MMI_VIDEO_PDL__
        case SINGLE_STATE_PDL_VIDEO_READY:
        {
            mmi_medply_main_screen_duration_seek_next();            
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING);
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_PLAY:
        {
            mdi_video_ply_stop();
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PLAY_PROGRESSING);

            mmi_medply_main_screen_duration_seek_next();            

            break;
        }
    #endif /*__MMI_VIDEO_PDL__*/

        default:
        {
            break;
        }
    }
    
}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_rewind
 * DESCRIPTION
 *  rewind
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_rewind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/ 

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_REWIND,g_single.seekable,g_single.state, MMI_TRUE);

    if(!g_single.seekable)
    {
        return;
    }

    if (!(g_single.selected_button == MEDPLY_MAIN_PREV && g_single.selected_button_down == MMI_TRUE ))
    {
        return; 
    }

    switch(g_single.state)
    {
    /*----audio----*/
    #ifdef __MMI_MEDIA_PLAYER_AUDIO__
        case SINGLE_STATE_AUDIO_READY:
        {
            MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_REWIND_AUDIO,g_single.need_to_build_cache,g_single.audio_build_cache_process, MMI_TRUE);

            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_PAUSE_PROGRESSING);

            if (g_single.need_to_build_cache && g_single.audio_build_cache_process< 100)
            {
                /*send message to med_v to start process*/
                mdi_audio_start_build_cache(g_single.filefullpath,
                                            g_single_audio_cache,
                                            MEDPLY_BUILD_CACHE_SIZE,
                                            NULL,//g_single.audio_cache_file_buf_p,
                                            0,//MEDPLY_BUILD_CACHE_FILE_BUF_SIZE,
                                            NULL,//g_single.audio_cache_proc_buf_p,
                                            0,//MEDPLY_BUILD_CACHE_PROC_BUF_SIZE,
                                            mmi_medply_single_build_cache_fail_callback_hdlr,
                                            &g_single.audio_build_cache_process);
            }
            mmi_medply_main_screen_duration_seek_prev();
            break;
        }

        case SINGLE_STATE_AUDIO_PLAY:
        {
            MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_REWIND_AUDIO,g_single.need_to_build_cache,g_single.audio_build_cache_process, MMI_TRUE);

            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_PLAY_PROGRESSING);

            mmi_medply_single_set_self_stop_flag(MMI_TRUE);
        
            mdi_audio_stop_file();
        
            mmi_medply_single_set_self_stop_flag(MMI_FALSE);

        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_single_set_continue_flag(MMI_FALSE);


            if (g_single.need_to_build_cache && g_single.audio_build_cache_process< 100)
            {
                /*send message to med_v to start process*/
                mdi_audio_start_build_cache(g_single.filefullpath,
                                            g_single_audio_cache,
                                            MEDPLY_BUILD_CACHE_SIZE,
                                            NULL,//g_single.audio_cache_file_buf_p,
                                            0,//MEDPLY_BUILD_CACHE_FILE_BUF_SIZE,
                                            NULL,//g_single.audio_cache_proc_buf_p,
                                            0,//MEDPLY_BUILD_CACHE_PROC_BUF_SIZE,
                                            mmi_medply_single_build_cache_fail_callback_hdlr,
                                            &g_single.audio_build_cache_process);
            }
            mmi_medply_main_screen_duration_seek_prev();
            break;
        }        
    #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

    /*----video----*/
    #ifdef __MMI_MEDIA_PLAYER_VIDEO__
        case SINGLE_STATE_VIDEO_READY:
        {
            mmi_medply_main_screen_duration_seek_prev();
            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PAUSE_PROGRESSING);
            break;
        }

        case SINGLE_STATE_VIDEO_PLAY:
        {
            mdi_video_ply_stop();
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PLAY_PROGRESSING);

            mmi_medply_main_screen_duration_seek_prev();            

            break;
        }    

        case SINGLE_STATE_VIDEO_PLAY_SEEKING:
        {
            mdi_video_ply_stop_non_block_seek();
            mmi_medply_main_screen_duration_seek_prev();
            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PLAY_PROGRESSING);

            break;
        }

        case SINGLE_STATE_VIDEO_PAUSE_SEEKING:
        {
            mdi_video_ply_stop_non_block_seek();
            mmi_medply_main_screen_duration_seek_prev();
            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PAUSE_PROGRESSING);

            break;
        }

    #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

    /*----stream----*/
    #ifdef __MMI_MEDIA_PLAYER_STREAM__
        case SINGLE_STATE_STREAM_CONNECTED:
        {
            mmi_medply_main_screen_duration_seek_prev();            
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_PLAY_PROGRESSING);
            break;
        }
        
        case SINGLE_STATE_STREAM_PLAY:
        {
            mdi_video_stream_stop();
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_PLAY_PROGRESSING);            

            mmi_medply_main_screen_duration_seek_prev();            

            break;
        }

    #endif /*__MMI_MEDIA_PLAYER_STREAM__*/    

   /*----pdl----*/
    #ifdef __MMI_VIDEO_PDL__
        case SINGLE_STATE_PDL_VIDEO_READY:
        {
            mmi_medply_main_screen_duration_seek_prev();            
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING);
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_PLAY:
        {
            mdi_video_ply_stop();
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PLAY_PROGRESSING);

            mmi_medply_main_screen_duration_seek_prev();            

            break;
        }    

    #endif /*__MMI_VIDEO_PDL__*/

        default:
        {
            break;
        }
    }


}

#ifdef __MMI_MEDIA_PLAYER_FTE__
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_FTE_inc_volume
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_press_FTE_inc_volume(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_INC_VOL,g_single.volume,g_single.mute, MMI_FALSE);
    
    if (g_single.volume < MDI_AUD_VOL_EX_MUTE_MAX)
    {
        g_single.volume ++ ;

        if(g_single.state != SINGLE_STATE_IDLE)
        {
            mdi_audio_set_volume(MDI_VOLUME_MEDIA, MDI_AUD_VOL_EX_MUTE(g_single.volume));
        }

        if(g_single.mute)
        {
            g_single.mute = MMI_FALSE;

            mmi_medply_main_screen_update_mute();
        }
    }

    if(!g_medply.fullscreen)
    {
        mmi_medply_main_screen_update_vol();
        mmi_medply_main_screen_blt();
    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_press_FTE_inc_volume_down
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_FTE_inc_volume_down(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_INC_VOL_DOWN, MMI_FALSE);

    mmi_medply_single_press_FTE_inc_volume();

    StartTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER, 300, mmi_medply_single_press_FTE_inc_volume_down);

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_FTE_inc_volume_up
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_FTE_inc_volume_up(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_INC_VOL_UP, MMI_FALSE);

    StopTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER);
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_FTE_inc_volume_key
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_FTE_inc_volume_key(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_FTE_INC_VOL_KEY, MMI_TRUE);

    if(mmi_medply_main_screen_show_volme_tuning())
    {
        #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
        if(!g_single.has_subtitle)
        #endif
        {
            mmi_medply_single_register_key_hdlrs(MMI_MEDPLY_SCREEN_VOLUME);
        }
        mmi_medply_single_press_FTE_inc_volume_down();
    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_FTE_dec_volume
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_press_FTE_dec_volume(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_DEC_VOL,g_single.volume,g_single.mute, MMI_FALSE);

    if (g_single.volume > MDI_AUD_VOL_EX_MUTE_MIN)
    {
        g_single.volume-- ;
  
        if(g_single.state != SINGLE_STATE_IDLE)
        {
            mdi_audio_set_volume(MDI_VOLUME_MEDIA, MDI_AUD_VOL_EX_MUTE(g_single.volume));
        }

        if(!g_single.mute && (MDI_AUD_VOL_EX_MUTE_MIN == g_single.volume))
        {
            g_single.mute = MMI_TRUE;

            mmi_medply_main_screen_update_mute();
         }
    }    

    if(!g_medply.fullscreen)
    {
        mmi_medply_main_screen_update_vol();
        mmi_medply_main_screen_blt();
    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_FTE_dec_volume_down
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_FTE_dec_volume_down(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_DEC_VOL_DOWN, MMI_FALSE);

    mmi_medply_single_press_FTE_dec_volume();

    StartTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER, 300, mmi_medply_single_press_FTE_dec_volume_down);

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_FTE_dec_volume_up
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_FTE_dec_volume_up(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_DEC_VOL_UP, MMI_FALSE);

    StopTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_FTE_dec_volume_key
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_FTE_dec_volume_key(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_FTE_DEC_VOL_KEY, MMI_TRUE);

    if(mmi_medply_main_screen_show_volme_tuning())
    {
        #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
        if(!g_single.has_subtitle)
        #endif
        {
            mmi_medply_single_register_key_hdlrs(MMI_MEDPLY_SCREEN_VOLUME);
        }
        mmi_medply_single_press_FTE_dec_volume_down();
    }
}

#else

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_inc_volume
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_inc_volume(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_INC_VOL,g_single.volume,g_single.mute, MMI_TRUE);

    if (g_single.volume < MDI_AUD_VOL_EX_MUTE_MAX)
    {
        g_single.volume ++ ;

        if(g_single.state != SINGLE_STATE_IDLE)
        {
            mdi_audio_set_volume(MDI_VOLUME_MEDIA, MDI_AUD_VOL_EX_MUTE(g_single.volume));
        }

        if(g_single.mute)
        {
            g_single.mute = MMI_FALSE;
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_SPEAK,MMI_MEDPLY_RGN_STATUS_UP);
        }

        mmi_medply_main_screen_draw_volume(g_single.volume);
        if(!g_medply.fullscreen)
        {
            mmi_medply_main_screen_blt();        
        }
    }
    else
    {
        mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_INC,
        MMI_MEDPLY_RGN_STATUS_DISABLE);

        if(!g_medply.fullscreen)
        {
            mmi_medply_main_screen_blt();
        }
    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_inc_volume_down
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_inc_volume_down(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_INC_VOL_DOWN, MMI_TRUE);

    if(mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_VOL_INC))
    {
        mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_INC,MMI_MEDPLY_RGN_STATUS_DISABLE);
        if(!g_medply.fullscreen)
        {
            mmi_medply_main_screen_blt();
        }
        return;
    }

    if(mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_VOL_DEC))
    {
        mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_DEC,
            MMI_MEDPLY_RGN_STATUS_UP);
    }

    mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_INC, MMI_MEDPLY_RGN_STATUS_DOWN);

    if(!g_medply.fullscreen)
    {
        mmi_medply_main_screen_blt();
    }        

    mmi_medply_single_press_inc_volume();

    StartTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER, 300, mmi_medply_single_press_inc_volume_down);
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_inc_volume_up
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_inc_volume_up(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_INC_VOL_UP, MMI_TRUE);

    if(mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_VOL_INC))
    {
        mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_INC,
                MMI_MEDPLY_RGN_STATUS_DISABLE);
    }
    else
    {
        mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_INC,
            MMI_MEDPLY_RGN_STATUS_UP);
    }

    if(!g_medply.fullscreen)
    {
        mmi_medply_main_screen_blt();

    }

    StopTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER);

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_press_dec_volume
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_dec_volume(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_DEC_VOL,g_single.volume,g_single.mute, MMI_TRUE);
    
    if (g_single.volume > MDI_AUD_VOL_EX_MUTE_MIN)
    {
        g_single.volume-- ;
  
        if(g_single.state != SINGLE_STATE_IDLE)
        {
            mdi_audio_set_volume(MDI_VOLUME_MEDIA, MDI_AUD_VOL_EX_MUTE(g_single.volume));
        }

        if(g_single.mute)
        {
            g_single.mute = MMI_FALSE;
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_SPEAK,MMI_MEDPLY_RGN_STATUS_UP);
        }
#if defined (__MMI_FTE_SUPPORT__) 
	if (g_single.volume == 0)
	{
            /* make sure enter mute mode when volume is 0 */
            g_single.mute = MMI_TRUE;
            mdi_audio_set_mute(VOL_TYPE_MEDIA,g_single.mute);
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_SPEAK,MMI_MEDPLY_RGN_STATUS_UP);
	}
#endif

        mmi_medply_main_screen_draw_volume(g_single.volume);
        if(!g_medply.fullscreen)
        {
            mmi_medply_main_screen_blt();
        }
    }
    else
    {
        mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_DEC,
        MMI_MEDPLY_RGN_STATUS_DISABLE);

        if(!g_medply.fullscreen)
        {
            mmi_medply_main_screen_blt();
        }
    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_dec_volume_down
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_dec_volume_down(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_DEC_VOL_DOWN, MMI_TRUE);

    if(mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_VOL_DEC))
    {
        mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_DEC,MMI_MEDPLY_RGN_STATUS_DISABLE);
        if(!g_medply.fullscreen)
        {
            mmi_medply_main_screen_blt();
        }
        return;
    }

    if(mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_VOL_INC))
    {
        mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_INC,
            MMI_MEDPLY_RGN_STATUS_UP);
    }

    mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_DEC, MMI_MEDPLY_RGN_STATUS_DOWN);
    if(!g_medply.fullscreen)
    {
        mmi_medply_main_screen_blt();
    }

    mmi_medply_single_press_dec_volume();

    StartTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER, 300, mmi_medply_single_press_dec_volume_down);

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_press_dec_volume_up
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_dec_volume_up(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_DEC_VOL_UP, MMI_TRUE);

    if(mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_VOL_DEC))
    {
        mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_DEC,
            MMI_MEDPLY_RGN_STATUS_DISABLE);
    }
    else
    {
        mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_DEC,
            MMI_MEDPLY_RGN_STATUS_UP);
    }

    if(!g_medply.fullscreen)
    {
        mmi_medply_main_screen_blt();
    }

    StopTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER);

}
#endif /* __MMI_MEDIA_PLAYER_FTE__ */

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_lsk_down
 * DESCRIPTION
 *  only takes care of the draw button part
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_lsk_down(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_LSK_DOWN, MMI_TRUE);

    g_single.unaffected_button_down = MMI_MEDPLY_RGN_ID_LKEY;

    mmi_medply_main_screen_draw_lkey_down();
    mmi_medply_main_screen_blt();
}

#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_rsk_hdlr
 * DESCRIPTION
 *  handle drm rights request ro goback
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_rsk_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

#ifdef __MMI_RMGR_EXTEND_RIGHTS_AFTER_EXIT_AP__

    if(g_single.media_type != MEDPLY_TYPE_AUDIO && g_single.media_type != MEDPLY_TYPE_VIDEO)
    {
        mmi_frm_scrn_close_active_id();
        return;
    }

    mmi_rmgr_extend_rights_full_procedure((U16*)g_single.filefullpath, DRM_PERMISSION_PLAY, GetRootTitleIcon(MENU_ID_MEDPLY_MAIN));

    if (GetActiveScreenId() == SCR_ID_MEDPLY_SINGLE_MAIN)
    {
        mmi_frm_scrn_close_active_id();
    }
    else
    {
        if(mmi_frm_scrn_is_present(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
        {
            mmi_frm_scrn_close(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN);
        }
    }
#else
    mmi_frm_scrn_close_active_id();
#endif

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_rsk_down
 * DESCRIPTION
 *  only takes care of the draw button part
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_rsk_down(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_RSK_DOWN, MMI_TRUE);

    g_single.unaffected_button_down = MMI_MEDPLY_RGN_ID_RKEY;

    mmi_medply_main_screen_draw_rkey_down();
    mmi_medply_main_screen_blt();

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_rsk_up
 * DESCRIPTION
 *  only takes care of the draw button part
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_rsk_up(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_RSK_UP, MMI_TRUE);

    mmi_medply_main_screen_draw_rkey_up();
    mmi_medply_main_screen_blt();    

    if(g_single.unaffected_button_down != MMI_MEDPLY_RGN_ID_RKEY)
    {
        return;
    }

    g_single.unaffected_button_down = MMI_MEDPLY_RGN_ID_NULL;
    mmi_medply_single_rsk_hdlr();
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_toggle_mute
 * DESCRIPTION
 *  handle mute / un-mute
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_toggle_mute(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_TOGGLE_MUTE,g_single.mute, MMI_TRUE);
    
    if(g_single.mute)
    {
        g_single.mute = MMI_FALSE;
        mdi_audio_set_volume(VOL_TYPE_MEDIA,MDI_AUD_VOL_EX_MUTE(g_single.volume));
    }
    else
    {
        g_single.mute = MMI_TRUE;
    }

    mdi_audio_set_mute(VOL_TYPE_MEDIA,g_single.mute);
    
    mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_SPEAK,MMI_MEDPLY_RGN_STATUS_UP);
    mmi_medply_main_screen_blt();

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_mute_down
 * DESCRIPTION
 *  handle press mute key down
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_mute_down(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_MUTE_DOWN, MMI_TRUE);

    g_single.unaffected_button_down = MMI_MEDPLY_RGN_ID_VOLUME_SPEAK;
    
    mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_SPEAK,
        MMI_MEDPLY_RGN_STATUS_DOWN);
    mmi_medply_main_screen_blt();
 
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_mute_up
 * DESCRIPTION
 *  handle press muet key up
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_mute_up(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_MUTE_UP, MMI_TRUE);

    if( g_single.unaffected_button_down != MMI_MEDPLY_RGN_ID_VOLUME_SPEAK)
    {
        return;
    }

    g_single.unaffected_button_down = MMI_MEDPLY_RGN_ID_NULL;

    mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_SPEAK,
            MMI_MEDPLY_RGN_STATUS_UP);
    mmi_medply_main_screen_blt();

    mmi_medply_single_toggle_mute();

    ClearKeyEvents();

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_dummy_key_hdlr
 * DESCRIPTION
 *  dummy key hdlr
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_dummy_key_hdlr()
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    /*dummy*/
}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_toggle_full_screen
 * DESCRIPTION
 *  handle switch in/out full screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_toggle_full_screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_TOGGLE_FULL,g_medply.fullscreen,g_single.state);

    if(!g_medply.fullscreen)
    {
        /*toggle to fullscreen*/

        g_medply.fullscreen = MMI_TRUE;

        /*register key hdlr*/
        mmi_medply_single_register_key_hdlrs(MMI_MEDPLY_SCREEN_FULL);

        switch(g_single.state)
        {
        #ifdef __MMI_MEDIA_PLAYER_AUDIO__
            case SINGLE_STATE_AUDIO_READY:
            {
                mmi_medply_main_screen_set_full_screen(MMI_TRUE);
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();
                mmi_medply_single_audio_play();
                break;
            }
            case SINGLE_STATE_AUDIO_PLAY:
            case SINGLE_STATE_AUDIO_BT_CONNECTING:
            {
                mmi_medply_main_screen_set_full_screen(MMI_TRUE);
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();
                break;
            }
        #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

        #ifdef __MMI_MEDIA_PLAYER_VIDEO__
            case SINGLE_STATE_VIDEO_OPENING:
            {
                mdi_video_ply_stop_non_block_seek();
                mmi_medply_single_video_close();

                mmi_medply_main_screen_set_full_screen(MMI_TRUE);
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();

                mmi_medply_single_set_continue_flag(MMI_TRUE);
                mmi_medply_single_video_open();

                break;
            }

            case SINGLE_STATE_VIDEO_READY:
            {
                mmi_medply_video_play_para_struct video_layer_info;
                //MDI_RESULT result;

                mmi_medply_main_screen_set_full_screen(MMI_TRUE);

                video_layer_info.video_height = g_single.height;
                video_layer_info.video_width = g_single.width;
                mmi_medply_main_screen_get_video_parameter(&video_layer_info);

                mmi_medply_adption_video_get_frame(
                            video_layer_info.layer_hdl
                #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                            ,video_layer_info.layer_subtitle_hdl
                #endif
                            );

                mmi_medply_single_set_continue_flag(MMI_TRUE);
                mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_READY);

                break;
            }

            case SINGLE_STATE_VIDEO_PLAY_SEEKING:
            case SINGLE_STATE_VIDEO_PAUSE_SEEKING:
            {
                MDI_RESULT result;
                mmi_medply_video_play_para_struct video_layer_info;
                
                /*switch to full screen*/
                mdi_video_ply_stop_non_block_seek();
                mmi_medply_main_screen_set_full_screen(MMI_TRUE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();

                video_layer_info.video_height = g_single.height;
                video_layer_info.video_width = g_single.width;
                mmi_medply_main_screen_get_video_parameter(&video_layer_info);

                result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                          g_single.current_time, 
                          video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                          mmi_medply_single_video_seek_callback_hdlr,
                          0); 

                if (result < 0)
                {
                    mmi_medply_display_popup(result,MMI_FALSE);
                    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                    return;
                }

                mmi_medply_enter_single_states(g_single.state);
                break;
            }

            case SINGLE_STATE_VIDEO_PLAY:
            {
                MDI_RESULT result;
                mmi_medply_video_play_para_struct video_layer_info;
                    
                result = mdi_video_ply_update_layer_pause();

                if (result < 0)
                {
                    mmi_medply_display_popup(result,MMI_FALSE);
                    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                    return;
                }
                
                mmi_medply_main_screen_set_full_screen(MMI_TRUE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_blt();

                video_layer_info.video_height = g_single.height;
                video_layer_info.video_width = g_single.width;
                mmi_medply_main_screen_get_video_parameter(&video_layer_info);

                result = mmi_medply_adption_video_update_layer_resume(
                            video_layer_info.layer_hdl, 
                            video_layer_info.layer_blt_flag, 
                            video_layer_info.layer_play_flag, 
                            #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                            video_layer_info.layer_subtitle_hdl,
                            video_layer_info.layer_subtitle_flag,
                            #endif 
                            MMI_TRUE, 
                            video_layer_info.layer_lcd_rotate
                            );

                if (result < 0)
                {
                    mmi_medply_display_popup(result,MMI_FALSE);
                    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                    return;
                }

                break;
            }

            case SINGLE_STATE_VIDEO_BT_CONNECTING:
            {
                mmi_medply_video_play_para_struct video_layer_info;
                //MDI_RESULT result;

            #ifdef __MMI_A2DP_SUPPORT__
                mmi_medply_bt_stop(MMI_FALSE);
            #endif

                mmi_medply_main_screen_set_full_screen(MMI_TRUE);

                video_layer_info.video_height = g_single.height;
                video_layer_info.video_width = g_single.width;
                mmi_medply_main_screen_get_video_parameter(&video_layer_info);

                mmi_medply_adption_video_get_frame(
                        video_layer_info.layer_hdl
                #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                        ,video_layer_info.layer_subtitle_hdl
                #endif
                        );
                mmi_medply_main_screen_blt();

                mmi_medply_single_set_continue_flag(MMI_TRUE);
                mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_READY);
                
                break;
            }
        #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

        #ifdef __MMI_MEDIA_PLAYER_STREAM__
            case SINGLE_STATE_STREAM_INITED:
            {
                mmi_medply_main_screen_set_full_screen(MMI_TRUE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();

                mmi_medply_single_stream_connect();
                break;
            }

            case SINGLE_STATE_STREAM_CONNECTING:
            {
                mmi_medply_main_screen_set_full_screen(MMI_TRUE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();
                break;
            }

            case SINGLE_STATE_STREAM_BUFFERING:                
            {
                mmi_medply_main_screen_set_full_screen(MMI_TRUE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();
                break;
            }

            case SINGLE_STATE_STREAM_CONNECTED:
            {
                mmi_medply_main_screen_set_full_screen(MMI_TRUE);
                mmi_medply_single_stream_buffer();
                break;
            }

            case SINGLE_STATE_STREAM_PLAY:
            {
                mmi_medply_video_play_para_struct video_layer_info;
                    
                mdi_video_stream_pause();
                mmi_medply_main_screen_set_full_screen(MMI_TRUE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_blt();

                video_layer_info.video_height = g_single.height;
                video_layer_info.video_width = g_single.width;
                mmi_medply_main_screen_get_video_parameter(&video_layer_info);

                mdi_video_stream_resume(
                    video_layer_info.layer_hdl, 
                    video_layer_info.layer_blt_flag, 
                    video_layer_info.layer_play_flag, 
                    MMI_TRUE, 
                    MDI_DEVICE_SPEAKER2, 
                    video_layer_info.layer_lcd_rotate
                    );

                mmi_medply_change_status(MMI_TRUE);
                break;
            }

            case SINGLE_STATE_STREAM_BT_CONNECTING:
            {
                mmi_medply_main_screen_set_full_screen(MMI_TRUE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();
                break;
            }

        #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

            /*PDL*/
        #ifdef __MMI_VIDEO_PDL__
            case SINGLE_STATE_PDL_VIDEO_OPENING:
            {
                StopTimer(MEDPLY_PDL_CALC_DOWNLOAD_TIMER);
                mdi_video_ply_stop_non_block_seek();
                mdi_video_progressive_close_file();

                mmi_medply_main_screen_set_full_screen(MMI_TRUE);
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();

                mmi_medply_single_set_continue_flag(MMI_TRUE);
                mmi_medply_single_pdl_video_open();   
                break;
            }

            case SINGLE_STATE_PDL_VIDEO_READY:
            {
                mmi_medply_video_play_para_struct video_layer_info;
                MDI_RESULT result;

                mmi_medply_main_screen_set_full_screen(MMI_TRUE);

                video_layer_info.video_height = g_single.height;
                video_layer_info.video_width = g_single.width;
                mmi_medply_main_screen_get_video_parameter(&video_layer_info);

                mmi_medply_adption_video_get_frame(
                            video_layer_info.layer_hdl
                #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                            ,video_layer_info.layer_subtitle_hdl
                #endif
                            );

                mmi_medply_single_set_continue_flag(MMI_TRUE);
                mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_READY);

                break;
            }

            case SINGLE_STATE_PDL_VIDEO_PLAY:
            {
                MDI_RESULT result;
                mmi_medply_video_play_para_struct video_layer_info;
                    
                result = mdi_video_ply_update_layer_pause();
                if (result < 0)
                {
                    mmi_medply_display_popup(result,MMI_FALSE);
                    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                    return;
                }

                mmi_medply_main_screen_set_full_screen(MMI_TRUE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_blt();

                video_layer_info.video_height = g_single.height;
                video_layer_info.video_width = g_single.width;
                mmi_medply_main_screen_get_video_parameter(&video_layer_info);

                result = mmi_medply_adption_video_update_layer_resume(
                            video_layer_info.layer_hdl, 
                            video_layer_info.layer_blt_flag, 
                            video_layer_info.layer_play_flag, 
                            #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                            video_layer_info.layer_subtitle_hdl,
                            video_layer_info.layer_subtitle_flag, 
                            #endif
                            MMI_TRUE, 
                            video_layer_info.layer_lcd_rotate
                            );

                if (result < 0)
                {
                    mmi_medply_display_popup(result,MMI_FALSE);
                    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                    return;
                }

                break;
            }

            case SINGLE_STATE_PDL_VIDEO_PAUSE_BUFFERING:
            case SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING:
            {
                mmi_medply_main_screen_set_full_screen(MMI_TRUE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();

                g_single.state = SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING;

                break;
            }

            case SINGLE_STATE_PDL_VIDEO_PAUSE_SEEKING:
            case SINGLE_STATE_PDL_VIDEO_PLAY_SEEKING:
            {
                MDI_RESULT result;
                mmi_medply_video_play_para_struct video_layer_info;

                /*switch to full screen*/
                mdi_video_ply_stop_non_block_seek();
                mmi_medply_main_screen_set_full_screen(MMI_TRUE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();

                video_layer_info.video_height = g_single.height;
                video_layer_info.video_width = g_single.width;
                mmi_medply_main_screen_get_video_parameter(&video_layer_info);

                result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                        g_single.current_time,
                        video_layer_info.layer_hdl,
                #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                        video_layer_info.layer_subtitle_hdl,
                #endif
                        mmi_medply_single_video_seek_callback_hdlr,
                        0);

                if (result < 0)
                {
                    mmi_medply_display_popup(result,MMI_FALSE);
                    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                    return;
                }

                mmi_medply_enter_single_states(g_single.state);
                break;
            }

            case SINGLE_STATE_PDL_VIDEO_BT_CONNECTING:
            {
                mmi_medply_video_play_para_struct video_layer_info;
                MDI_RESULT result;

            #ifdef __MMI_A2DP_SUPPORT__
                mmi_medply_bt_stop(MMI_FALSE);
            #endif

                mmi_medply_main_screen_set_full_screen(MMI_TRUE);

                video_layer_info.video_height = g_single.height;
                video_layer_info.video_width = g_single.width;
                mmi_medply_main_screen_get_video_parameter(&video_layer_info);

                mmi_medply_adption_video_get_frame(
                                    video_layer_info.layer_hdl
                        #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                                    ,video_layer_info.layer_subtitle_hdl
                        #endif
                                    ); 

                mmi_medply_single_set_continue_flag(MMI_TRUE);
                mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_READY);
                
                break;
            }
        #endif /*__MMI_VIDEO_PDL__*/

        #ifdef __MMI_AUDIO_PDL__

            case SINGLE_STATE_PDL_AUDIO_READY:
            {
                mmi_medply_main_screen_set_full_screen(MMI_TRUE);
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();
                mmi_medply_single_pdl_audio_play();
                break;
            }

            case SINGLE_STATE_PDL_AUDIO_BUFFERING:
            case SINGLE_STATE_PDL_AUDIO_PLAY:
            case SINGLE_STATE_PDL_AUDIO_BT_CONNECTING:    
            {
                mmi_medply_main_screen_set_full_screen(MMI_TRUE);
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();
                break;
            }

        #endif /*__MMI_AUDIO_PDL__*/

            default :
            {
                return;
            }
        
        }

    }
    else
    {
        /*toggle to normal screen*/

        g_medply.fullscreen = MMI_FALSE;

        /*register key hdlr*/
        mmi_medply_single_register_key_hdlrs(MMI_MEDPLY_SCREEN_NORMAL);

        switch(g_single.state)
        {
        #ifdef __MMI_MEDIA_PLAYER_AUDIO__
            case SINGLE_STATE_AUDIO_PLAY:
            case SINGLE_STATE_AUDIO_BT_CONNECTING:
            {
                mmi_medply_main_screen_set_full_screen(MMI_FALSE);
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();
                break;
            }
        #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

        #ifdef __MMI_MEDIA_PLAYER_VIDEO__
            case SINGLE_STATE_VIDEO_OPENING:
            {
                mdi_video_ply_stop_non_block_seek();
                mmi_medply_single_video_close();

                mmi_medply_main_screen_set_full_screen(MMI_FALSE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();

                mmi_medply_single_set_continue_flag(MMI_TRUE);
                mmi_medply_single_video_open();
                break;
            }

            case SINGLE_STATE_VIDEO_PLAY_SEEKING:
            case SINGLE_STATE_VIDEO_PAUSE_SEEKING:
            {
                MDI_RESULT result;
                mmi_medply_video_play_para_struct video_layer_info;

                /*switch to full screen*/
                mdi_video_ply_stop_non_block_seek();
                mmi_medply_main_screen_set_full_screen(MMI_FALSE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();

                video_layer_info.video_height = g_single.height;
                video_layer_info.video_width = g_single.width;
                mmi_medply_main_screen_get_video_parameter(&video_layer_info);

                result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                        g_single.current_time,
                        video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                        mmi_medply_single_video_seek_callback_hdlr,
                        0);

                if (result < 0)
                {
                    mmi_medply_display_popup(result,MMI_FALSE);
                    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                    return;
                }

                mmi_medply_enter_single_states(g_single.state);
                break;
            }

            case SINGLE_STATE_VIDEO_PLAY:
            {
                MDI_RESULT result;
                mmi_medply_video_play_para_struct video_layer_info;

                result = mdi_video_ply_update_layer_pause();

                if (result < 0)
                {
                    mmi_medply_display_popup(result,MMI_FALSE);
                    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                    return;
                }

                mmi_medply_main_screen_set_full_screen(MMI_FALSE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_blt();

                video_layer_info.video_height = g_single.height;
                video_layer_info.video_width = g_single.width;
                mmi_medply_main_screen_get_video_parameter(&video_layer_info);

                result = mmi_medply_adption_video_update_layer_resume(
                            video_layer_info.layer_hdl, 
                            video_layer_info.layer_blt_flag, 
                            video_layer_info.layer_play_flag, 
                            #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                            video_layer_info.layer_subtitle_hdl,
                            video_layer_info.layer_subtitle_flag, 
                            #endif
                            MMI_TRUE, 
                            video_layer_info.layer_lcd_rotate
                            );

                if (result < 0)
                {
                    mmi_medply_display_popup(result,MMI_FALSE);
                    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                    return;
                }

                break;
            }

            case SINGLE_STATE_VIDEO_BT_CONNECTING:
            {
                mmi_medply_video_play_para_struct video_layer_info;
                MDI_RESULT result;

            #ifdef __MMI_A2DP_SUPPORT__
                mmi_medply_bt_stop(MMI_FALSE);
            #endif

                mmi_medply_main_screen_set_full_screen(MMI_FALSE);

                video_layer_info.video_height = g_single.height;
                video_layer_info.video_width = g_single.width;
                mmi_medply_main_screen_get_video_parameter(&video_layer_info);

                result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                          g_single.current_time, 
                          video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                          mmi_medply_single_video_seek_callback_hdlr,
                          0); 

                if (result < 0)
                {
                    mmi_medply_display_popup(result,MMI_FALSE);
                    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                    return;
                }

                mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PLAY_SEEKING);

                break;
            }
        #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/ 

        #ifdef __MMI_MEDIA_PLAYER_STREAM__
            case SINGLE_STATE_STREAM_INITED:
            case SINGLE_STATE_STREAM_CONNECTING:
            case SINGLE_STATE_STREAM_BUFFERING:
            case SINGLE_STATE_STREAM_BT_CONNECTING:
            {
                mmi_medply_main_screen_set_full_screen(MMI_FALSE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();
                break;
            }

            case SINGLE_STATE_STREAM_PLAY:
            {
                mmi_medply_video_play_para_struct video_layer_info;

                mdi_video_stream_pause();
                mmi_medply_main_screen_set_full_screen(MMI_FALSE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_blt();

                video_layer_info.video_height = g_single.height;
                video_layer_info.video_width = g_single.width;
                mmi_medply_main_screen_get_video_parameter(&video_layer_info);

                mdi_video_stream_resume(
                    video_layer_info.layer_hdl, 
                    video_layer_info.layer_blt_flag, 
                    video_layer_info.layer_play_flag, 
                    MMI_TRUE, 
                    MDI_DEVICE_SPEAKER2, 
                    video_layer_info.layer_lcd_rotate
                    );
                break;
            }

        #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

            /*PDL*/
        #ifdef __MMI_VIDEO_PDL__
            case SINGLE_STATE_PDL_VIDEO_OPENING:
            {
                StopTimer(MEDPLY_PDL_CALC_DOWNLOAD_TIMER);
                mdi_video_ply_stop_non_block_seek();
                mdi_video_progressive_close_file();

                mmi_medply_main_screen_set_full_screen(MMI_FALSE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();

                mmi_medply_single_set_continue_flag(MMI_TRUE);
                mmi_medply_single_pdl_video_open();
                break;
            }

            case SINGLE_STATE_PDL_VIDEO_PLAY:
            {
                MDI_RESULT result;
                mmi_medply_video_play_para_struct video_layer_info;

                result = mdi_video_ply_update_layer_pause();

                if (result < 0)
                {
                    mmi_medply_display_popup(result,MMI_FALSE);
                    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                    return;
                }

                mmi_medply_main_screen_set_full_screen(MMI_FALSE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_blt();

                video_layer_info.video_height = g_single.height;
                video_layer_info.video_width = g_single.width;
                mmi_medply_main_screen_get_video_parameter(&video_layer_info);

                result = mmi_medply_adption_video_update_layer_resume(
                            video_layer_info.layer_hdl, 
                            video_layer_info.layer_blt_flag, 
                            video_layer_info.layer_play_flag, 
                            #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                            video_layer_info.layer_subtitle_hdl,
                            video_layer_info.layer_subtitle_flag, 
                            #endif
                            MMI_TRUE, 
                            video_layer_info.layer_lcd_rotate
                            );

                if (result < 0)
                {
                    mmi_medply_display_popup(result,MMI_FALSE);
                    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                    return;
                }

                break;
            }

            case SINGLE_STATE_PDL_VIDEO_PAUSE_BUFFERING:
            case SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING:
            {
                mmi_medply_main_screen_set_full_screen(MMI_FALSE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();
                break;
            }
 
            case SINGLE_STATE_PDL_VIDEO_PAUSE_SEEKING:
            case SINGLE_STATE_PDL_VIDEO_PLAY_SEEKING:
            {
                MDI_RESULT result;
                mmi_medply_video_play_para_struct video_layer_info;

                /*switch to full screen*/
                mdi_video_ply_stop_non_block_seek();
                mmi_medply_main_screen_set_full_screen(MMI_FALSE);
                mmi_medply_main_screen_clear_video_layer();
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();

                video_layer_info.video_height = g_single.height;
                video_layer_info.video_width = g_single.width;
                mmi_medply_main_screen_get_video_parameter(&video_layer_info);

                result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                        g_single.current_time,
                        video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                    mmi_medply_single_video_seek_callback_hdlr,
                        0);

                if (result < 0)
                {
                    mmi_medply_display_popup(result,MMI_FALSE);
                    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                    return;
                }

                mmi_medply_enter_single_states(g_single.state);
                break;
            } 

            case SINGLE_STATE_PDL_VIDEO_BT_CONNECTING:
            {
                mmi_medply_video_play_para_struct video_layer_info;
                MDI_RESULT result;

            #ifdef __MMI_A2DP_SUPPORT__
                mmi_medply_bt_stop(MMI_FALSE);
            #endif

                mmi_medply_main_screen_set_full_screen(MMI_FALSE);

                video_layer_info.video_height = g_single.height;
                video_layer_info.video_width = g_single.width;
                mmi_medply_main_screen_get_video_parameter(&video_layer_info);

                result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                          g_single.current_time, 
                          video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                          mmi_medply_single_pdl_video_seek_callback_hdlr,
                         0); 

                if (result < 0)
                {
                    mmi_medply_display_popup(result,MMI_FALSE);
                    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                    return;
                }

                mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PLAY_SEEKING);

                break;
            }

        #endif /*__MMI_VIDEO_PDL__*/

        #ifdef __MMI_AUDIO_PDL__
            case SINGLE_STATE_PDL_AUDIO_BUFFERING:
            case SINGLE_STATE_PDL_AUDIO_PLAY:
            case SINGLE_STATE_PDL_AUDIO_BT_CONNECTING:
            {
                mmi_medply_main_screen_set_full_screen(MMI_FALSE);
                mmi_medply_main_screen_redraw();
                mmi_medply_main_screen_blt();
                break;
            }

        #endif /*__MMI_AUDIO_PDL__*/

            default:
            {
                MMI_ASSERT(0);
            }
        }
    }

    ClearKeyEvents();

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_full_screen_down
 * DESCRIPTION
 *  handle press full sceen key down
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_full_screen_down(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_FULL_DOWN,g_single.state);

    g_single.affected_button_down = MMI_MEDPLY_RGN_ID_ZOOM;
    
    mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_ZOOM,
        MMI_MEDPLY_RGN_STATUS_DOWN);
    mmi_medply_main_screen_blt();
 
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_full_screen_up
 * DESCRIPTION
 *  handle press full sceen key up
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_full_screen_up(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_FULL_UP);

    /*in case the flag is reset for state change, always redraw key up*/
    mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_ZOOM,
            MMI_MEDPLY_RGN_STATUS_UP);
    mmi_medply_main_screen_blt();

    if( g_single.affected_button_down != MMI_MEDPLY_RGN_ID_ZOOM)
    {
        return;
    }

    g_single.affected_button_down = MMI_MEDPLY_RGN_ID_NULL;

    mmi_medply_single_toggle_full_screen();

}


#ifdef __MMI_VIDEO_3D_ANAGLYPH__
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_toggle_play_mode
 * DESCRIPTION
 *  handle switch in/out full screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_toggle_play_mode(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	switch(g_single.state)
        {
    #ifdef __MMI_MEDIA_PLAYER_VIDEO__
            case SINGLE_STATE_VIDEO_OPENING:
            {
                mdi_video_ply_stop_non_block_seek();
                mmi_medply_single_video_close();
				
                mmi_medply_single_video_open();
                break;
            }

            case SINGLE_STATE_VIDEO_READY:
            {
                mmi_medply_single_video_close();
                mmi_medply_single_video_open();
                break;
            }

            case SINGLE_STATE_VIDEO_PLAY_SEEKING:
			{
                mdi_video_ply_stop_non_block_seek();
                mmi_medply_single_video_close();
                mmi_medply_single_set_continue_flag(MMI_TRUE);
                mdi_audio_clear_interrupt_callback();
                mmi_medply_single_video_open();
                break;
            }
			
            case SINGLE_STATE_VIDEO_PAUSE_SEEKING:
            {
                mdi_video_ply_stop_non_block_seek();
                mmi_medply_single_video_close();
                mmi_medply_single_set_continue_flag(MMI_FALSE);
                mdi_audio_clear_interrupt_callback();
                mmi_medply_single_video_open();
                break;
            }

            case SINGLE_STATE_VIDEO_PLAY:
            {
				mdi_video_ply_stop();
                #ifdef __MMI_A2DP_SUPPORT__
                   mmi_medply_bt_stop(MMI_FALSE);
                #endif
                
				mmi_medply_single_video_close();
                mmi_medply_single_set_continue_flag(MMI_TRUE);
                mdi_audio_clear_interrupt_callback();
                mmi_medply_single_video_open();
                break;
            }

            case SINGLE_STATE_VIDEO_BT_CONNECTING:
            {   
		mmi_medply_single_video_close();
                mmi_medply_single_set_continue_flag(MMI_TRUE);
                mmi_medply_single_video_open();
                break;
            }
        #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/
		    default:
		        break;
		}

}
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_press_play_mode_down
 * DESCRIPTION
 *  handle press full sceen key down
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_play_mode_down(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_3D_MODE_DOWN,g_medply.state);

    if(g_single.has_3d_mode)
    {
        g_single.affected_button_down = MMI_MEDPLY_RGN_ID_MODE;
    
		mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_MODE,
		    MMI_MEDPLY_RGN_STATUS_DOWN);
		mmi_medply_main_screen_blt();
    }
 
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_press_play_mode_up
 * DESCRIPTION
 *  handle press full sceen key up
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_play_mode_up(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	//U16 play_mode;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_3D_MODE_UP);

    /*in case the flag is reset for state change, always redraw key up*/

    if( g_single.affected_button_down != MMI_MEDPLY_RGN_ID_MODE)
    {
        return;
    }

    if(!g_single.has_2d_mode)
    {
        mmi_medply_display_popup_with_sg((U16)STR_ID_MEDPLY_3D_ONLY, MMI_EVENT_FAILURE);
        return;
    }

    g_single.affected_button_down = MMI_MEDPLY_RGN_ID_NULL;

	mmi_medply_settings_toggle_play_mode();

	mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_MODE,
            MMI_MEDPLY_RGN_STATUS_UP);
    mmi_medply_main_screen_blt();

    mmi_medply_single_toggle_play_mode();

}
#endif



/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_full_screen_key_down_hdlr
 * DESCRIPTION
 *  handle full screen key down
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_full_screen_key_down_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_ZOOM))
    {
        return;
    }

        mmi_medply_single_press_full_screen_down();

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_full_screen_key_up_hdlr
 * DESCRIPTION
 *  handle full screen key up
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_full_screen_key_up_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_ZOOM))
    {
        mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_ZOOM,
            MMI_MEDPLY_RGN_STATUS_DISABLE);
        mmi_medply_main_screen_blt();

        return;
    }

        mmi_medply_single_press_full_screen_up();


}




/*****************************************************************************
 * FUNCTION
 *  mmi_medply_clear_key_down
 * DESCRIPTION
 *  to clear all key down states
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_clear_key_down(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(g_single.affected_button_down != MMI_MEDPLY_RGN_ID_NULL)
    {
        switch(g_single.affected_button_down)
        {
            case MMI_MEDPLY_RGN_ID_ZOOM:
            {
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_ZOOM,
                    MMI_MEDPLY_RGN_STATUS_UP);
                break;
            }

            default:
            {
                break;
            }
        }
        g_single.affected_button_down = MMI_MEDPLY_RGN_ID_NULL;
    }

    if(g_single.unaffected_button_down != MMI_MEDPLY_RGN_ID_NULL)
    {
        switch(g_single.unaffected_button_down)
        {
            case MMI_MEDPLY_RGN_ID_LKEY:
            {
                mmi_medply_main_screen_draw_lkey_up();
                break;
            }

            case MMI_MEDPLY_RGN_ID_RKEY:
            {
                mmi_medply_main_screen_draw_rkey_up();
                break;
            }

            case MMI_MEDPLY_RGN_ID_VOLUME_SPEAK:
            {
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_SPEAK,
                    MMI_MEDPLY_RGN_STATUS_UP);
                break;
            }

            default:
            {
                break;
            }
        }

        g_single.unaffected_button_down = MMI_MEDPLY_RGN_ID_NULL;
    }


    if(g_single.selected_button_down)
    {
        switch(g_single.selected_button)
        {
            case MEDPLY_MAIN_PLAY:
            {
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PLAY_PAUSE,
                    MMI_MEDPLY_RGN_STATUS_UP);   
                break;
            }

        #ifndef __MMI_MEDIA_PLAYER_FTE__
            case MEDPLY_MAIN_STOP:
            {
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_STOP,
                    MMI_MEDPLY_RGN_STATUS_UP);
                break;
            }
        #endif

            case MEDPLY_MAIN_PREV:
            {
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PREV,
                    MMI_MEDPLY_RGN_STATUS_UP);
                break;
            }

            case MEDPLY_MAIN_NEXT:
            {
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_NEXT,
                    MMI_MEDPLY_RGN_STATUS_UP);
                break;
            }

            default:
            {
                break;
            }
        }

        g_single.selected_button_down = MMI_FALSE;
    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_press_button_canceled
 * DESCRIPTION
 *  to cancel key down action
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_press_button_canceled(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_medply_regn_id_enum button_rgn_id = MMI_MEDPLY_RGN_ID_NULL;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_AVRCP_CANCELED,g_single.selected_button,g_single.selected_button_down);

    if(g_single.selected_button == MEDPLY_MAIN_DISABLED || g_single.selected_button_down == MMI_FALSE)
    {
        return;
    }

    switch(g_single.selected_button)
    {
        case MEDPLY_MAIN_PLAY:
        case MEDPLY_MAIN_PAUSE:
        {
            button_rgn_id = MMI_MEDPLY_RGN_ID_PLAY_PAUSE;
            break;
        }
        case MEDPLY_MAIN_NEXT:
        {
            button_rgn_id = MMI_MEDPLY_RGN_ID_NEXT;
            break;
        }
        case MEDPLY_MAIN_PREV:
        {
            button_rgn_id = MMI_MEDPLY_RGN_ID_PREV;
            break;
        }
        case MEDPLY_MAIN_STOP:
        {
            button_rgn_id = MMI_MEDPLY_RGN_ID_STOP;
            break;
        }
    }

    g_single.selected_button_down = MMI_FALSE ;

    mmi_medply_main_screen_set_and_draw_button(button_rgn_id,
            MMI_MEDPLY_RGN_STATUS_UP);

    mmi_medply_main_screen_blt();

}

#ifdef __MMI_TOUCH_SCREEN__
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_clear_pen_down
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_clear_pen_down(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    switch (g_single.pen_on_object)
    {
        case MMI_MEDPLY_RGN_ID_LKEY:
        {
            mmi_medply_main_screen_draw_lkey_up();
            break;
        }

        case MMI_MEDPLY_RGN_ID_RKEY:
        {
            mmi_medply_main_screen_draw_rkey_up();
            break;
        }

        case MMI_MEDPLY_RGN_ID_DURATION_BAR:
        {
            mmi_medply_main_screen_duration_pen_up(0);
            switch(g_single.state)
            {
            /*----audio----*/
            #ifdef __MMI_MEDIA_PLAYER_AUDIO__    
                case SINGLE_STATE_AUDIO_PAUSE_PROGRESSING:
                case SINGLE_STATE_AUDIO_PLAY_PROGRESSING:
                {
                    if(g_single.need_to_build_cache)
                    {
                        mdi_audio_stop_build_cache();
                    }
                    if(g_single.state == SINGLE_STATE_AUDIO_PAUSE_PROGRESSING)
                    {
                        mmi_medply_single_set_continue_flag(MMI_FALSE);
                    }
                    else
                    {
                        mmi_medply_single_set_continue_flag(MMI_TRUE);
                    }
                    mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_READY);
                    break;
                }
            #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

            /*----video----*/
            #ifdef __MMI_MEDIA_PLAYER_VIDEO__
                case SINGLE_STATE_VIDEO_PAUSE_PROGRESSING:
                case SINGLE_STATE_VIDEO_PLAY_PROGRESSING:
                {
                    if(g_single.state == SINGLE_STATE_VIDEO_PAUSE_PROGRESSING)
                    {
                        mmi_medply_single_set_continue_flag(MMI_FALSE);
                    }
                    else
                    {
                        mmi_medply_single_set_continue_flag(MMI_TRUE);
                    }
                    mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_READY);
                    break;
                }
            #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

            /*----stream----*/
            #ifdef __MMI_MEDIA_PLAYER_STREAM__

                case SINGLE_STATE_STREAM_PLAY_PROGRESSING:
                {
                    mmi_medply_single_set_continue_flag(MMI_TRUE);
                    mmi_medply_enter_single_states(SINGLE_STATE_STREAM_CONNECTED);
                    break;
                }

            #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

            #ifdef __MMI_VIDEO_PDL__   
                case SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING:
                case SINGLE_STATE_PDL_VIDEO_PLAY_PROGRESSING:
                {
                    if(g_single.state == SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING)
                    {
                        mmi_medply_single_set_continue_flag(MMI_FALSE);
                    }
                    else
                    {
                        mmi_medply_single_set_continue_flag(MMI_TRUE);
                    }
                    mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_READY);
                    break;
                }
            #endif /*__MMI_VIDEO_PDL__*/

            #ifdef __MMI_AUDIO_PDL__
                case SINGLE_STATE_PDL_AUDIO_PLAY:
                case SINGLE_STATE_PDL_AUDIO_READY:
                {
                    break;
                }
            #endif /*__MMI_AUDIO_PDL__*/

                default:
                {
                    break;
                }
            }
            break;
        }

        case MMI_MEDPLY_RGN_ID_NEXT:
        case MMI_MEDPLY_RGN_ID_PREV:
        {
            switch(g_single.state)
            {
            /*----audio----*/
            #ifdef __MMI_MEDIA_PLAYER_AUDIO__    
                case SINGLE_STATE_AUDIO_PAUSE_PROGRESSING:
                case SINGLE_STATE_AUDIO_PLAY_PROGRESSING:
                {
                    mmi_medply_main_screen_duration_seek_done();
                    if(g_single.need_to_build_cache)
                    {
                        mdi_audio_stop_build_cache();
                    }
                    if(g_single.state == SINGLE_STATE_AUDIO_PAUSE_PROGRESSING)
                    {
                        mmi_medply_single_set_continue_flag(MMI_FALSE);
                    }
                    else
                    {
                        mmi_medply_single_set_continue_flag(MMI_TRUE);
                    }
                    mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_READY);
                    break;
                }
            #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

            /*----video----*/
            #ifdef __MMI_MEDIA_PLAYER_VIDEO__
                case SINGLE_STATE_VIDEO_PAUSE_PROGRESSING:
                case SINGLE_STATE_VIDEO_PLAY_PROGRESSING:
                {
                    mmi_medply_main_screen_duration_seek_done();
                    if(g_single.state == SINGLE_STATE_VIDEO_PAUSE_PROGRESSING)
                    {
                        mmi_medply_single_set_continue_flag(MMI_FALSE);
                    }
                    else
                    {
                        mmi_medply_single_set_continue_flag(MMI_TRUE);
                    }
                    mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_READY);
                    break;
                }
            #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

            /*----stream----*/
            #ifdef __MMI_MEDIA_PLAYER_STREAM__

                case SINGLE_STATE_STREAM_PLAY_PROGRESSING:
                {
                    mmi_medply_main_screen_duration_seek_done();
                    mmi_medply_single_set_continue_flag(MMI_TRUE);
                    mmi_medply_enter_single_states(SINGLE_STATE_STREAM_CONNECTED);
                    break;
                }

            #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

            #ifdef __MMI_VIDEO_PDL__   
                case SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING:
                case SINGLE_STATE_PDL_VIDEO_PLAY_PROGRESSING:
                {
                    mmi_medply_main_screen_duration_seek_done();
                    if(g_single.state == SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING)
                    {
                        mmi_medply_single_set_continue_flag(MMI_FALSE);
                    }
                    else
                    {
                        mmi_medply_single_set_continue_flag(MMI_TRUE);
                    }
                    mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_READY);
                    break;
                }
            #endif /*__MMI_VIDEO_PDL__*/
                default:
                {
                    break;
                }
            }

            if(g_single.pen_on_object == MMI_MEDPLY_RGN_ID_NEXT)
            {
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_NEXT,
                        MMI_MEDPLY_RGN_STATUS_UP);
            }
            else
            {
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PREV,
                        MMI_MEDPLY_RGN_STATUS_UP);
            }
            break;
        }

    #ifndef __MMI_MEDIA_PLAYER_FTE__
        case MMI_MEDPLY_RGN_ID_STOP:
        {
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_STOP,
                    MMI_MEDPLY_RGN_STATUS_UP);
            break;
        }
    #endif

        case MMI_MEDPLY_RGN_ID_PLAY_PAUSE:
        {
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PLAY_PAUSE,
                    MMI_MEDPLY_RGN_STATUS_UP);
            break;
        }

    #ifdef __MMI_MEDIA_PLAYER_FTE__
        case MMI_MEDPLY_RGN_ID_VOLUME_BAR:
        {
            break;
        }
    #else
        case MMI_MEDPLY_RGN_ID_VOLUME_INC:
        {
            StopTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER);
            mmi_medply_single_press_inc_volume_up();
            break;
        }

        case MMI_MEDPLY_RGN_ID_VOLUME_DEC:
        {
            StopTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER);
            mmi_medply_single_press_dec_volume_up();
            break;
        }
    #endif

        case MMI_MEDPLY_RGN_ID_VOLUME_SPEAK:
        {
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_SPEAK,
                    MMI_MEDPLY_RGN_STATUS_UP);
            break;
        }


    #ifdef __MMI_MEDIA_PLAYER_FTE__
        case MMI_MEDPLY_RGN_ID_USER_RATING:
        {
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_USER_RATING,
                MMI_MEDPLY_RGN_STATUS_UP);

            break;
        }
    #endif

        default:
        {
            break;
        }

    }

    StopTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER);
    StopTimer(MEDPLY_TOUCH_LONG_PRESS_TIMER);

    g_single.pen_on_object = MMI_MEDPLY_RGN_ID_NULL;

}
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_touch_progress_hdlr
 * DESCRIPTION
 *  take care the touch progress build cache and progress bar drawing
 * PARAMETERS
 *  cor_x       [IN]    x coordinate of touch down position
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_touch_progress_hdlr(S16 cor_x)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/ 

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_TOUCH_PROGRESS_HDLR,g_single.seekable,g_single.state,cor_x, MMI_TRUE);

    if(!g_single.seekable)
    {
        g_single.pen_on_object = MMI_MEDPLY_RGN_ID_NULL;
        return;
    }
    
    switch(g_single.state)
    {
    /*----audio----*/
#ifdef __MMI_MEDIA_PLAYER_AUDIO__
        case SINGLE_STATE_AUDIO_READY:
        {
            MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_TOUCH_PROGRESS_AUDIO,g_single.need_to_build_cache,g_single.audio_build_cache_process, MMI_TRUE);
            mmi_medply_main_screen_duration_pen_down(cor_x);

            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_PAUSE_PROGRESSING);

            if (g_single.need_to_build_cache && g_single.audio_build_cache_process< 100)
            {
                /*send message to med_v to start process*/
                mdi_audio_start_build_cache(g_single.filefullpath,
                                            g_single_audio_cache,
                                            MEDPLY_BUILD_CACHE_SIZE,
                                            NULL,//g_single.audio_cache_file_buf_p,
                                            0,//MEDPLY_BUILD_CACHE_FILE_BUF_SIZE,
                                            NULL,//g_single.audio_cache_proc_buf_p,
                                            0,//MEDPLY_BUILD_CACHE_PROC_BUF_SIZE,
                                            mmi_medply_single_build_cache_fail_callback_hdlr,
                                            &g_single.audio_build_cache_process);
            }

            break;
        }

        case SINGLE_STATE_AUDIO_PLAY:
        {
            MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_TOUCH_PROGRESS_AUDIO,g_single.need_to_build_cache,g_single.audio_build_cache_process, MMI_TRUE);

            mmi_medply_main_screen_duration_pen_down(cor_x);

            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_PLAY_PROGRESSING);
            
            mmi_medply_single_set_self_stop_flag(MMI_TRUE);
        
            mdi_audio_stop_file();
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_single_set_self_stop_flag(MMI_FALSE);

            mmi_medply_single_set_continue_flag(MMI_FALSE);

            if (g_single.need_to_build_cache && g_single.audio_build_cache_process< 100)
            {
                /*send message to med_v to start process*/
                mdi_audio_start_build_cache(g_single.filefullpath,
                                            g_single_audio_cache,
                                            MEDPLY_BUILD_CACHE_SIZE,
                                            NULL,//g_single.audio_cache_file_buf_p,
                                            0,//MEDPLY_BUILD_CACHE_FILE_BUF_SIZE,
                                            NULL,//g_single.audio_cache_proc_buf_p,
                                            0,//MEDPLY_BUILD_CACHE_PROC_BUF_SIZE,
                                            mmi_medply_single_build_cache_fail_callback_hdlr,
                                            &g_single.audio_build_cache_process);
            }
            break;
        }
#endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

    /*----video----*/
#ifdef __MMI_MEDIA_PLAYER_VIDEO__
        case SINGLE_STATE_VIDEO_READY:
        {
            mmi_medply_main_screen_duration_pen_down(cor_x);
            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PAUSE_PROGRESSING);            
            break;
        }

        case SINGLE_STATE_VIDEO_PLAY:
        {
            mmi_medply_main_screen_duration_pen_down(cor_x);            
            mdi_video_ply_stop();
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PLAY_PROGRESSING);

            break;
        }

        case SINGLE_STATE_VIDEO_PLAY_SEEKING:
        {
            mmi_medply_main_screen_duration_pen_down(cor_x);
            mdi_video_ply_stop_non_block_seek();
            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PLAY_PROGRESSING);

            break;
        }

        case SINGLE_STATE_VIDEO_PAUSE_SEEKING:
        {
            mmi_medply_main_screen_duration_pen_down(cor_x);
            mdi_video_ply_stop_non_block_seek();
            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PAUSE_PROGRESSING);

            break;
        }
#endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

    /*----stream----*/
#ifdef __MMI_MEDIA_PLAYER_STREAM__    
        case SINGLE_STATE_STREAM_CONNECTED:
        {
            mmi_medply_main_screen_duration_pen_down(cor_x);            
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_PLAY_PROGRESSING);
            break;
        }

        case SINGLE_STATE_STREAM_PLAY:
        {
            mmi_medply_main_screen_duration_pen_down(cor_x);            
            mdi_video_stream_stop();
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_PLAY_PROGRESSING);            
            break;
        }
#endif /*__MMI_MEDIA_PLAYER_STREAM__*/

    /*----pdl----*/
#ifdef __MMI_VIDEO_PDL__
        case SINGLE_STATE_PDL_VIDEO_READY:
        {
            mmi_medply_main_screen_duration_pen_down(cor_x);            
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING);
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_PLAY:
        {
            mmi_medply_main_screen_duration_pen_down(cor_x);            
            mdi_video_ply_stop();
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PLAY_PROGRESSING);
            break;
        }
#endif /*__MMI_VIDEO_PDL__*/

        default:
        {
            break;
        }
    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_touch_progress_pen_up
 * DESCRIPTION
 *  handle progress pen up
 * PARAMETERS
 *  S16      x position of current pen up
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_touch_progress_pen_up(S16 cor_x)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/  
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_TOUCH_PROGRESS_UP,g_single.state, MMI_TRUE);

    switch(g_single.state)
    {
    /*----audio----*/
    #ifdef __MMI_MEDIA_PLAYER_AUDIO__    
        case SINGLE_STATE_AUDIO_PAUSE_PROGRESSING:
        {

            if(g_single.need_to_build_cache)
            {
                mdi_audio_stop_build_cache();
            }
            mmi_medply_main_screen_duration_pen_up(cor_x);
            mmi_medply_single_set_continue_flag(MMI_FALSE);            
            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_READY);
            break;
        }

        case SINGLE_STATE_AUDIO_PLAY_PROGRESSING:
        {
            if(g_single.need_to_build_cache)
            {
                mdi_audio_stop_build_cache();
            }
            mmi_medply_main_screen_duration_pen_up(cor_x);
            mmi_medply_single_audio_play();
            break;
        }

    #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

    /*----video----*/
    #ifdef __MMI_MEDIA_PLAYER_VIDEO__
        case SINGLE_STATE_VIDEO_PAUSE_PROGRESSING:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            mmi_medply_main_screen_duration_pen_up(cor_x);

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                    g_single.current_time,
                    video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                    mmi_medply_single_video_seek_callback_hdlr,
                    0);

            if (result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }

            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PAUSE_SEEKING);            
            break;
        }

        case SINGLE_STATE_VIDEO_PLAY_PROGRESSING:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            mmi_medply_main_screen_duration_pen_up(cor_x);

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                    g_single.current_time,
                    video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                    mmi_medply_single_video_seek_callback_hdlr,
                    0);

            if (result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }

            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PLAY_SEEKING);            
            break;
        }

    #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

    /*----stream----*/
    #ifdef __MMI_MEDIA_PLAYER_STREAM__

        case SINGLE_STATE_STREAM_PLAY_PROGRESSING:
        {
            mmi_medply_main_screen_duration_pen_up(cor_x);
            mmi_medply_single_stream_buffer();
            break;
        }

    #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

    #ifdef __MMI_VIDEO_PDL__   
        case SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            mmi_medply_main_screen_duration_pen_up(cor_x);

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                    g_single.current_time,
                    video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                    mmi_medply_single_pdl_video_seek_callback_hdlr,
                    0);

            if (result == MDI_RES_VDOPLY_PROGRESSIVE_FILE_NOT_ENOUGH)
            {
                StartTimer(MEDPLY_PDL_BUFFER_TIMER, 100, mmi_medply_single_pdl_video_update_buffer_percent);
                mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PAUSE_BUFFERING);
                return;
            }

            if (result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                break;
            }

            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PAUSE_SEEKING);
            break;
        }
        
        case SINGLE_STATE_PDL_VIDEO_PLAY_PROGRESSING:
        {
            MDI_RESULT result;
            mmi_medply_video_play_para_struct video_layer_info;

            mmi_medply_main_screen_duration_pen_up(cor_x);

            video_layer_info.video_height = g_single.height;
            video_layer_info.video_width = g_single.width;
            mmi_medply_main_screen_get_video_parameter(&video_layer_info);

            result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                    g_single.current_time,
                    video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                    mmi_medply_single_pdl_video_seek_callback_hdlr,
                    0);

            if (result == MDI_RES_VDOPLY_PROGRESSIVE_FILE_NOT_ENOUGH)
            {
                StartTimer(MEDPLY_PDL_BUFFER_TIMER, 100, mmi_medply_single_pdl_video_update_buffer_percent);
                mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING);
                break;
            }

            if (result < 0)
            {
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                return;
            }

            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PLAY_SEEKING);            
            break;
        }

    #endif /*__MMI_VIDEO_PDL__*/

    #ifdef __MMI_AUDIO_PDL__
        case SINGLE_STATE_PDL_AUDIO_PLAY:
        case SINGLE_STATE_PDL_AUDIO_READY:
        {
            break;
        }
    #endif /*__MMI_AUDIO_PDL__*/

        default:
        {
            break;
        }

    }

}

#ifdef __MMI_MEDIA_PLAYER_FTE__
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_touch_rating_hdlr
 * DESCRIPTION
 *  touch rating hdlr
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_touch_rating_hdlr(S16 cor_x)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    mmi_medply_main_screen_update_rating(cor_x);

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_touch_rating_pen_up
 * DESCRIPTION
 *  handle progress pen up
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_touch_rating_pen_up(S16 cor_x)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8  new_rating;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    new_rating = mmi_medply_main_screen_update_rating(cor_x);

    mmi_medply_plst_store_rating(new_rating);
}
#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_touch_longpressed
 * DESCRIPTION
 *  handle touch long pressed timer time out
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_touch_longpressed(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch(g_single.selected_button)
    {
        case MEDPLY_MAIN_PREV:
        {
            mmi_medply_single_rewind();
            break;
        }

        case MEDPLY_MAIN_NEXT:
        {
            mmi_medply_single_fast_forward();
            break;
        }

        default:
        {
            break;
        }
    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pen_down_hdlr
 * DESCRIPTION
 *  
 * PARAMETERS
 *  pos     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_pen_down_hdlr(mmi_pen_point_struct pos)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 pen_object = mmi_medply_main_screen_get_pt_rgn(pos);
    S32 icon_id;
    wgui_status_icon_bar_pen_enum evt_type;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_TOUCH_PEN_DOWN, pen_object, MMI_TRUE);

    if(g_medply.fullscreen)
    {
        gui_touch_feedback_play(GUI_TOUCH_FEEDBACK_DOWN);
        mmi_medply_single_toggle_full_screen();
        return;
    }

#ifdef __MMI_MEDIA_PLAYER_FTE__
    /* single player shares the same flag as media player*/
    kal_get_time((kal_uint32*)&g_medply.pen_event_dur);
#endif

#if defined(__MMI_BACKGROUND_CALL__) && !defined(__RF_DESENSE_TEST__) && !defined(__CS_STREAMING_CONCURRENT_SUPPORT__)
    if(srv_ucm_is_background_call())
    {
        switch (pen_object)
        {
            case MMI_MEDPLY_RGN_ID_RKEY:
            {
                break;
            }

            default:
            {
                pen_object = MMI_MEDPLY_RGN_ID_NULL;
            }
        }
    }
#endif

    if (MMI_MEDPLY_RGN_ID_NULL != pen_object)
    {
        gui_touch_feedback_play(GUI_TOUCH_FEEDBACK_DOWN);
    }

    switch (pen_object)
    {
        case MMI_MEDPLY_RGN_ID_LKEY:
        {
            ExecuteCurrKeyHandler(KEY_LSK, KEY_EVENT_DOWN);
            break;
        }

        case MMI_MEDPLY_RGN_ID_RKEY:
        {
            ExecuteCurrKeyHandler(KEY_RSK, KEY_EVENT_DOWN);
            break;
        }

        case MMI_MEDPLY_RGN_ID_PREV:
        {
            mmi_medply_single_press_prev_button_down();
            if(g_single.selected_button == MEDPLY_MAIN_PREV && g_single.selected_button_down == MMI_TRUE)
            {
                StartTimer(MEDPLY_TOUCH_LONG_PRESS_TIMER, MEDPLY_PEN_LONGPRESSED_MS, mmi_medply_single_touch_longpressed);
            }

            break;
        }

        case MMI_MEDPLY_RGN_ID_NEXT:
        {
            mmi_medply_single_press_next_button_down();
            if(g_single.selected_button == MEDPLY_MAIN_NEXT && g_single.selected_button_down == MMI_TRUE)
            {
                StartTimer(MEDPLY_TOUCH_LONG_PRESS_TIMER, MEDPLY_PEN_LONGPRESSED_MS, mmi_medply_single_touch_longpressed);
            }

            break;
        }

        case MMI_MEDPLY_RGN_ID_DURATION_BAR:
        {
            mmi_medply_single_touch_progress_hdlr(pos.x);
            break;
        }

        case MMI_MEDPLY_RGN_ID_STOP:
        {
            mmi_medply_single_press_stop_button_down();
            break;
        }

        case MMI_MEDPLY_RGN_ID_PLAY_PAUSE:
        {
            mmi_medply_single_press_play_button_down();
            break;
        }

        case MMI_MEDPLY_RGN_ID_ZOOM:
        {
            mmi_medply_single_full_screen_key_down_hdlr();
            break;
        }

    #ifdef __MMI_MEDIA_PLAYER_FTE__
        case MMI_MEDPLY_RGN_ID_VOLUME_BAR:
        {
            g_single.volume = mmi_medply_main_screen_update_touch_volume(pos.x, 1);

            if(g_single.state != SINGLE_STATE_IDLE)
            {
                mdi_audio_set_volume(MDI_VOLUME_MEDIA, MDI_AUD_VOL_EX_MUTE(g_single.volume));
            }

            if(!g_single.mute && (MDI_AUD_VOL_EX_MUTE_MIN == g_single.volume))
            {
                g_single.mute = MMI_TRUE;
                mmi_medply_main_screen_update_mute();
            }
            else if(g_single.mute && (MDI_AUD_VOL_EX_MUTE_MIN != g_single.volume))
            {
                g_single.mute = MMI_FALSE;
                mmi_medply_main_screen_update_mute();
            }
            mmi_medply_main_screen_blt();
            break;
        }
    #else
        case MMI_MEDPLY_RGN_ID_VOLUME_INC:
        {
            mmi_medply_single_press_inc_volume_down();
            break;
        }

        case MMI_MEDPLY_RGN_ID_VOLUME_DEC:
        {
            mmi_medply_single_press_dec_volume_down();
            break;
        }
    #endif

        case MMI_MEDPLY_RGN_ID_VOLUME_SPEAK:
        {
            mmi_medply_single_press_mute_down();
            break;
        }


    #ifdef __MMI_MEDIA_PLAYER_FTE__
        case MMI_MEDPLY_RGN_ID_USER_RATING:
        {
            g_single.media_based_button_down = MMI_MEDPLY_RGN_ID_USER_RATING;

            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_USER_RATING,
                MMI_MEDPLY_RGN_STATUS_DOWN);

            mmi_medply_main_screen_blt();

            break;
        }

        case MMI_MEDPLY_RGN_ID_MODIFY_RATING:
        {
            mmi_medply_single_touch_rating_hdlr(pos.x);
            break;
        }

        case MMI_MEDPLY_RGN_ID_POPUP:
        {
            break;
        }
    #endif

        #ifdef __MMI_VIDEO_3D_ANAGLYPH__
	    case MMI_MEDPLY_RGN_ID_MODE:
            if(mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_PLAY_MODE))
            {
                return;
            }
			mmi_medply_single_press_play_mode_down();
			break;
        #endif

        default:
        {
            if(g_medply.fullscreen)
            {
                mmi_medply_single_toggle_full_screen();
            }
        #ifdef __MMI_MEDIA_PLAYER_FTE__
            else
            {
                mmi_medply_main_screen_close_popup_setting();
            }
        #endif
        #ifdef __MMI_TOUCH_SCREEN__
            if(!g_medply.fullscreen)
            {
                wgui_status_icon_bar_translate_pen_event(
                    MMI_PEN_EVENT_DOWN,
                    pos.x,
                    pos.y,
                    &icon_id,
                    &evt_type);
            }
        #endif 
            g_single.pen_on_object = MMI_MEDPLY_RGN_ID_NULL;
            return;
        }

    }

    g_single.pen_on_object= pen_object;

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pen_up_hdlr
 * DESCRIPTION
 *  
 * PARAMETERS
 *  pos     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_pen_up_hdlr(mmi_pen_point_struct pos)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 pen_object = mmi_medply_main_screen_get_pt_rgn(pos);
    S32 icon_id;
    wgui_status_icon_bar_pen_enum evt_type;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_TOUCH_PEN_UP, g_single.pen_on_object, pen_object, MMI_TRUE);


    switch (g_single.pen_on_object)
    {
        case MMI_MEDPLY_RGN_ID_LKEY:
        {
            if(g_single.pen_on_object == pen_object)
            {
                ExecuteCurrKeyHandler(KEY_LSK, KEY_EVENT_UP);
            }
            else
            {
                g_single.unaffected_button_down = MMI_MEDPLY_RGN_ID_NULL;
                mmi_medply_main_screen_draw_lkey_up();
                mmi_medply_main_screen_blt();
            }
            break;
        }

        case MMI_MEDPLY_RGN_ID_RKEY:
        {
            if(g_single.pen_on_object == pen_object)
            {
                ExecuteCurrKeyHandler(KEY_RSK, KEY_EVENT_UP);
            }
            else
            {
                g_single.unaffected_button_down = MMI_MEDPLY_RGN_ID_NULL;
                mmi_medply_main_screen_draw_rkey_up();
                mmi_medply_main_screen_blt();
            }            
            break;
        }

        case MMI_MEDPLY_RGN_ID_NEXT:
        {
            StopTimer(MEDPLY_TOUCH_LONG_PRESS_TIMER);
            switch(g_single.state)
            {
                case SINGLE_STATE_AUDIO_PAUSE_PROGRESSING:
                case SINGLE_STATE_AUDIO_PLAY_PROGRESSING:
                case SINGLE_STATE_VIDEO_PAUSE_PROGRESSING:
                case SINGLE_STATE_VIDEO_PLAY_PROGRESSING:
                case SINGLE_STATE_STREAM_PLAY_PROGRESSING:
                case SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING:
                case SINGLE_STATE_PDL_VIDEO_PLAY_PROGRESSING:
                {
                    mmi_medply_single_press_next_button_up();
                    return;
                }
            }

            if(g_single.pen_on_object == pen_object)
            {
                mmi_medply_single_press_next_button_up();
            }
            else
            {
                g_single.selected_button_down = MMI_FALSE;
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_NEXT,
                        MMI_MEDPLY_RGN_STATUS_UP);
                mmi_medply_main_screen_blt();
            }

            break;
        }

        case MMI_MEDPLY_RGN_ID_PREV:
        {
            StopTimer(MEDPLY_TOUCH_LONG_PRESS_TIMER);
            switch(g_single.state)
            {
                case SINGLE_STATE_AUDIO_PAUSE_PROGRESSING:
                case SINGLE_STATE_AUDIO_PLAY_PROGRESSING:
                case SINGLE_STATE_VIDEO_PAUSE_PROGRESSING:
                case SINGLE_STATE_VIDEO_PLAY_PROGRESSING:
                case SINGLE_STATE_STREAM_PLAY_PROGRESSING:
                case SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING:
                case SINGLE_STATE_PDL_VIDEO_PLAY_PROGRESSING:
                {
                    mmi_medply_single_press_prev_button_up();
                    return;
                }
            }

            if(g_single.pen_on_object == pen_object)
            {
                mmi_medply_single_press_prev_button_up();
            }
            else
            {                
                g_single.selected_button_down = MMI_FALSE;
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PREV,
                        MMI_MEDPLY_RGN_STATUS_UP);
                mmi_medply_main_screen_blt();
            }
            break;
        }

        case MMI_MEDPLY_RGN_ID_DURATION_BAR:
        {
                mmi_medply_single_touch_progress_pen_up(pos.x);
            break;
        }

        case MMI_MEDPLY_RGN_ID_STOP:
        {
            if(g_single.pen_on_object == pen_object)
            {
                mmi_medply_single_press_stop_button_up();
            }
            else
            {
                g_single.selected_button_down = MMI_FALSE;
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_STOP,
                        MMI_MEDPLY_RGN_STATUS_UP);
                mmi_medply_main_screen_blt();
            }
            break;
        }

        case MMI_MEDPLY_RGN_ID_PLAY_PAUSE:
        {
            if(mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_PAUSE) || mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_PLAY))
            {
                return;
            }
            
            if(g_single.pen_on_object == pen_object)
            {
                mmi_medply_single_press_play_button_up();
            }
            else
            {
                g_single.selected_button_down = MMI_FALSE;
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PLAY_PAUSE,
                        MMI_MEDPLY_RGN_STATUS_UP);
                mmi_medply_main_screen_blt();
            }
            break;
        }

        case MMI_MEDPLY_RGN_ID_ZOOM:
        {
            mmi_medply_single_full_screen_key_up_hdlr();
            break;
        }

    #ifdef __MMI_MEDIA_PLAYER_FTE__
        case MMI_MEDPLY_RGN_ID_VOLUME_BAR:
        {
            g_single.volume = mmi_medply_main_screen_update_touch_volume(pos.x, 0);

            if(!g_single.mute && (MDI_AUD_VOL_EX_MUTE_MIN == g_single.volume))
            {
                g_single.mute = MMI_TRUE;
                mmi_medply_main_screen_update_mute();
            }
            else if(g_single.mute && (MDI_AUD_VOL_EX_MUTE_MIN != g_single.volume))
            {
                g_single.mute = MMI_FALSE;
                mmi_medply_main_screen_update_mute();
            }
            mmi_medply_main_screen_blt();

            if(g_single.state != SINGLE_STATE_IDLE)
            {
                mdi_audio_set_volume(MDI_VOLUME_MEDIA, MDI_AUD_VOL_EX_MUTE(g_single.volume));
            }
            break;
        }
    #else
        case MMI_MEDPLY_RGN_ID_VOLUME_INC:
        {
            if(g_single.pen_on_object == pen_object)
            {
                StopTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER);
                mmi_medply_single_press_inc_volume_up();
            }
            break;
        }

        case MMI_MEDPLY_RGN_ID_VOLUME_DEC:
        {
            if(g_single.pen_on_object == pen_object)
            {
                StopTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER);
                mmi_medply_single_press_dec_volume_up();
            }
            break;
        }
    #endif

        case MMI_MEDPLY_RGN_ID_VOLUME_SPEAK:
        {
            if (g_single.pen_on_object == pen_object)
            {
                mmi_medply_single_press_mute_up();
            }
            else
            {
                g_single.unaffected_button_down = MMI_MEDPLY_RGN_ID_NULL;
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_SPEAK,
                        MMI_MEDPLY_RGN_STATUS_UP);
                mmi_medply_main_screen_blt();
            }
            break;
        }


    #ifdef __MMI_MEDIA_PLAYER_FTE__
        case MMI_MEDPLY_RGN_ID_USER_RATING:
        {
            if(g_single.pen_on_object == pen_object)
            {
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_USER_RATING,
                    MMI_MEDPLY_RGN_STATUS_UP);

                if(g_single.media_based_button_down == MMI_MEDPLY_RGN_ID_USER_RATING)
                {
                    if(mmi_medply_main_screen_show_user_rating())
                    {
                        mmi_medply_single_register_key_hdlrs(MMI_MEDPLY_SCREEN_RATING);
                    }
                }
                else
                {
                    mmi_medply_main_screen_blt();
                }

                g_single.media_based_button_down = MMI_MEDPLY_RGN_ID_NULL;
            }
            else
            {
                g_single.media_based_button_down = MMI_MEDPLY_RGN_ID_NULL;
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_USER_RATING,
                    MMI_MEDPLY_RGN_STATUS_UP);

                mmi_medply_main_screen_blt();
            }

            break;
        }

        case MMI_MEDPLY_RGN_ID_MODIFY_RATING:
        {
            mmi_medply_single_touch_rating_pen_up(pos.x);
            break;
        }
    #endif

	#ifdef __MMI_VIDEO_3D_ANAGLYPH__
	    case MMI_MEDPLY_RGN_ID_MODE:
			mmi_medply_single_press_play_mode_up();
			break;
        #endif

        default:
        {
            if(g_medply.fullscreen)
            {
                mmi_medply_single_toggle_full_screen();
            }
            else
            {
                wgui_status_icon_bar_translate_pen_event(
                    MMI_PEN_EVENT_UP,
                    pos.x,
                    pos.y,
                    &icon_id,
                    &evt_type);
            }
            break;
        }
    }

    g_single.pen_on_object = MMI_MEDPLY_RGN_ID_NULL;
    
}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_pen_move_hdlr
 * DESCRIPTION
 *  
 * PARAMETERS
 *  pos     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_pen_move_hdlr(mmi_pen_point_struct pos)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 pen_object = mmi_medply_main_screen_get_pt_rgn(pos);
    S32 icon_id;
    wgui_status_icon_bar_pen_enum evt_type;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_TOUCH_PEN_MOVE, g_single.pen_on_object, pen_object, MMI_TRUE);

/* since gesture will make touch event detection becomes so much more frequently, need to drop some events*/
#ifdef __MMI_MEDIA_PLAYER_FTE__
{
    U32 event_dur;

    kal_get_time((kal_uint32*)&event_dur);
    /* single player shares the same flag as media player*/
    if(event_dur - g_medply.pen_event_dur < MEDPLY_FTE_PEN_MOVE_MIN_TICKS)
    {
        return;
    }
    g_medply.pen_event_dur = event_dur;
}
#endif


    switch (g_single.pen_on_object)
    {
        case MMI_MEDPLY_RGN_ID_LKEY:
        {
            if (g_single.pen_on_object == pen_object)
            {
                mmi_medply_single_press_lsk_down();
            }
            else
            {
                g_single.unaffected_button_down = MMI_MEDPLY_RGN_ID_NULL;
                mmi_medply_main_screen_draw_lkey_up();
                mmi_medply_main_screen_blt();
            }
            break;
        }

        case MMI_MEDPLY_RGN_ID_RKEY:
        {
            if (g_single.pen_on_object == pen_object)
            {
                mmi_medply_single_press_rsk_down();
            }
            else
            {
                g_single.unaffected_button_down = MMI_MEDPLY_RGN_ID_NULL;
                mmi_medply_main_screen_draw_rkey_up();
                mmi_medply_main_screen_blt();
            }
            break;
        }

        case MMI_MEDPLY_RGN_ID_DURATION_BAR:
        {
            mmi_medply_main_screen_duration_pen_move(pos.x);
            break;
        }

        case MMI_MEDPLY_RGN_ID_NEXT:
        {
            switch(g_single.state)
            {
                case SINGLE_STATE_AUDIO_PAUSE_PROGRESSING:
                case SINGLE_STATE_AUDIO_PLAY_PROGRESSING:
                case SINGLE_STATE_VIDEO_PAUSE_PROGRESSING:
                case SINGLE_STATE_VIDEO_PLAY_PROGRESSING:
                case SINGLE_STATE_STREAM_PLAY_PROGRESSING:
                case SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING:
                case SINGLE_STATE_PDL_VIDEO_PLAY_PROGRESSING:
                {
                    if (g_single.pen_on_object != pen_object)
                    {
                        mmi_medply_single_press_next_button_up();
                    }
                    return;
                }
            }

            if (g_single.pen_on_object == pen_object)
            {
                if(g_single.selected_button_down)
                {
                    return;
                }

                mmi_medply_single_press_next_button_down();
                if(g_single.selected_button == MEDPLY_MAIN_NEXT && g_single.selected_button_down == MMI_TRUE)
                {
                    StartTimer(MEDPLY_TOUCH_LONG_PRESS_TIMER, MEDPLY_PEN_LONGPRESSED_MS, mmi_medply_single_touch_longpressed);
                }
            }
            else
            {
                StopTimer(MEDPLY_TOUCH_LONG_PRESS_TIMER);

                g_single.selected_button_down = MMI_FALSE;
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_NEXT,
                        MMI_MEDPLY_RGN_STATUS_UP);
                mmi_medply_main_screen_blt();
            }
			break;
        }

        case MMI_MEDPLY_RGN_ID_PREV:
        {
            switch(g_single.state)
            {
                case SINGLE_STATE_AUDIO_PAUSE_PROGRESSING:
                case SINGLE_STATE_AUDIO_PLAY_PROGRESSING:
                case SINGLE_STATE_VIDEO_PAUSE_PROGRESSING:
                case SINGLE_STATE_VIDEO_PLAY_PROGRESSING:
                case SINGLE_STATE_STREAM_PLAY_PROGRESSING:
                case SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING:
                case SINGLE_STATE_PDL_VIDEO_PLAY_PROGRESSING:
                {
                    if (g_single.pen_on_object != pen_object)
                    {
                        mmi_medply_single_press_prev_button_up();
                    }
                    return;
                }
            }

            if (g_single.pen_on_object == pen_object)
            {
                if(g_single.selected_button_down)
                {
                    return;
                }

                mmi_medply_single_press_prev_button_down();
                if(g_single.selected_button == MEDPLY_MAIN_PREV && g_single.selected_button_down == MMI_TRUE)
                {
                    StartTimer(MEDPLY_TOUCH_LONG_PRESS_TIMER, MEDPLY_PEN_LONGPRESSED_MS, mmi_medply_single_touch_longpressed);
                }

            }
            else
            {
                StopTimer(MEDPLY_TOUCH_LONG_PRESS_TIMER);

                g_single.selected_button_down = MMI_FALSE;
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PREV,
                        MMI_MEDPLY_RGN_STATUS_UP);
                mmi_medply_main_screen_blt();
            }
			break;
        }

        case MMI_MEDPLY_RGN_ID_STOP:
        {
            if (g_single.pen_on_object == pen_object)
            {
                mmi_medply_single_press_stop_button_down();
            }
            else
            {
                g_single.selected_button_down = MMI_FALSE;
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_STOP,
                        MMI_MEDPLY_RGN_STATUS_UP);
                mmi_medply_main_screen_blt();
            }
            break;
        }

        case MMI_MEDPLY_RGN_ID_PLAY_PAUSE:
        {
            if(mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_PAUSE) || mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_PLAY))
            {
                return;
            }

            if (g_single.pen_on_object == pen_object)
            {
                mmi_medply_single_press_play_button_down();
            }else
            {
                g_single.selected_button_down = MMI_FALSE;
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PLAY_PAUSE,
                        MMI_MEDPLY_RGN_STATUS_UP);
                mmi_medply_main_screen_blt();
            }
            break;
        }

    #ifdef __MMI_MEDIA_PLAYER_FTE__
        case MMI_MEDPLY_RGN_ID_VOLUME_BAR:
        {
            g_single.volume = mmi_medply_main_screen_update_touch_volume(pos.x, 1);

            if(!g_single.mute && (MDI_AUD_VOL_EX_MUTE_MIN == g_single.volume))
            {
                g_single.mute = MMI_TRUE;
                mmi_medply_main_screen_update_mute();
            }
            else if(g_single.mute && (MDI_AUD_VOL_EX_MUTE_MIN != g_single.volume))
            {
                g_single.mute = MMI_FALSE;
                mmi_medply_main_screen_update_mute();
            }
            mmi_medply_main_screen_blt();

            mmi_medply_main_screen_blt();
            if(g_single.state != SINGLE_STATE_IDLE)
            {
                mdi_audio_set_volume(MDI_VOLUME_MEDIA, MDI_AUD_VOL_EX_MUTE(g_single.volume));
            }
            break;
        }
    #else
        case MMI_MEDPLY_RGN_ID_VOLUME_INC:
        {
            if (g_single.pen_on_object == pen_object)
            {
                StopTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER);
                mmi_medply_single_press_inc_volume_down();
            }
            else
            {
                StopTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER);
                mmi_medply_single_press_inc_volume_up();
            }
            break;
        }

        case MMI_MEDPLY_RGN_ID_VOLUME_DEC:
        {
            if (g_single.pen_on_object == pen_object)
            {
                StopTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER);
                mmi_medply_single_press_dec_volume_down();
            }
            else
            {
                StopTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER);            
                mmi_medply_single_press_dec_volume_up();
            }
            break;
        }
    #endif

        case MMI_MEDPLY_RGN_ID_VOLUME_SPEAK:
        {
            if (g_single.pen_on_object == pen_object)
            {
                mmi_medply_single_press_mute_down();
            }
            else
            {
                g_single.unaffected_button_down = MMI_MEDPLY_RGN_ID_NULL;
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_SPEAK,
                        MMI_MEDPLY_RGN_STATUS_UP);
                mmi_medply_main_screen_blt();
            }
            break;
        }


        case MMI_MEDPLY_RGN_ID_ZOOM:
        {
            if(mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_ZOOM))
            {
                return;
            }

            if(g_single.pen_on_object == pen_object)
            {
                mmi_medply_single_press_full_screen_down();
            }
            else
            {
                g_single.affected_button_down = MMI_MEDPLY_RGN_ID_NULL;
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_ZOOM,
                        MMI_MEDPLY_RGN_STATUS_UP);
                mmi_medply_main_screen_blt();
            }
            break;
        }

    #ifdef __MMI_MEDIA_PLAYER_FTE__
        case MMI_MEDPLY_RGN_ID_USER_RATING:
        {
            if(g_single.pen_on_object == pen_object)
            {            
                g_single.media_based_button_down = MMI_MEDPLY_RGN_ID_USER_RATING;
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_USER_RATING,
                    MMI_MEDPLY_RGN_STATUS_DOWN);

                mmi_medply_main_screen_blt();
            }
            else
            {
                g_single.media_based_button_down = MMI_MEDPLY_RGN_ID_NULL;
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_USER_RATING,
                    MMI_MEDPLY_RGN_STATUS_UP);

                mmi_medply_main_screen_blt();
            }
            break;
        }

        case MMI_MEDPLY_RGN_ID_MODIFY_RATING:
        {
            mmi_medply_main_screen_update_rating(pos.x);
            mmi_medply_main_screen_blt();
            break;
        }
    #endif

    #ifdef __MMI_VIDEO_3D_ANAGLYPH__
	case MMI_MEDPLY_RGN_ID_MODE:
        {
            if(mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_PLAY_MODE))
            {
                return;
            }
            
            if (g_single.pen_on_object == pen_object)
            {
                mmi_medply_single_press_play_mode_down();
            }
            else
            {
                g_single.selected_button_down = MMI_FALSE;
                g_single.affected_button_down = MMI_MEDPLY_RGN_ID_NULL;
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_MODE,
                    MMI_MEDPLY_RGN_STATUS_UP);

                mmi_medply_main_screen_blt();
            }
			break;
        }
    #endif

        default:
        {
            if(!g_medply.fullscreen)
            {
                wgui_status_icon_bar_translate_pen_event(
                    MMI_PEN_EVENT_MOVE,
                    pos.x,
                    pos.y,
                    &icon_id,
                    &evt_type);
            }
            break;
        }
    }
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_pen_abort_hdlr
 * DESCRIPTION
 *  
 * PARAMETERS
 *  pos     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_pen_abort_hdlr(mmi_pen_point_struct pos)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 icon_id;
    wgui_status_icon_bar_pen_enum evt_type;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_TOUCH_PEN_ABORT,g_single.pen_on_object, MMI_TRUE);

    switch (g_single.pen_on_object)
    {
        case MMI_MEDPLY_RGN_ID_LKEY:
        {
            g_single.unaffected_button_down = MMI_MEDPLY_RGN_ID_NULL;
            mmi_medply_main_screen_draw_lkey_up();
            mmi_medply_main_screen_blt();
            break;
        }

        case MMI_MEDPLY_RGN_ID_RKEY:
        {
            g_single.unaffected_button_down = MMI_MEDPLY_RGN_ID_NULL;
            mmi_medply_main_screen_draw_rkey_up();
            mmi_medply_main_screen_blt();
            break;
        }

        case MMI_MEDPLY_RGN_ID_DURATION_BAR:
        {
            mmi_medply_main_screen_duration_pen_up(pos.x);
            switch(g_single.state)
            {
            /*----audio----*/
            #ifdef __MMI_MEDIA_PLAYER_AUDIO__    
                case SINGLE_STATE_AUDIO_PAUSE_PROGRESSING:
                case SINGLE_STATE_AUDIO_PLAY_PROGRESSING:
                {
                    if(g_single.need_to_build_cache)
                    {
                        mdi_audio_stop_build_cache();
                    }
                    mmi_medply_single_set_continue_flag(MMI_FALSE);            
                    mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_READY);
                    break;
                }
            #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

            /*----video----*/
            #ifdef __MMI_MEDIA_PLAYER_VIDEO__
                case SINGLE_STATE_VIDEO_PAUSE_PROGRESSING:
                case SINGLE_STATE_VIDEO_PLAY_PROGRESSING:
                {
                    mmi_medply_single_set_continue_flag(MMI_FALSE);
                    mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_READY);
                    break;
                }
            #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

            /*----stream----*/
            #ifdef __MMI_MEDIA_PLAYER_STREAM__

                case SINGLE_STATE_STREAM_PLAY_PROGRESSING:
                {
                    mmi_medply_single_set_continue_flag(MMI_FALSE);
                    mmi_medply_enter_single_states(SINGLE_STATE_STREAM_CONNECTED);
                    break;
                }

            #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

            #ifdef __MMI_VIDEO_PDL__   
                case SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING:
                case SINGLE_STATE_PDL_VIDEO_PLAY_PROGRESSING:
                {
                    mmi_medply_single_set_continue_flag(MMI_FALSE);
                    mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_READY);
                    break;
                }
            #endif /*__MMI_VIDEO_PDL__*/

            #ifdef __MMI_AUDIO_PDL__
                case SINGLE_STATE_PDL_AUDIO_PLAY:
                case SINGLE_STATE_PDL_AUDIO_READY:
                {
                    break;
                }
            #endif /*__MMI_AUDIO_PDL__*/

                default:
                {
                    break;
                }
            }
            break;
        }

        case MMI_MEDPLY_RGN_ID_NEXT:
        case MMI_MEDPLY_RGN_ID_PREV:
        {
            switch(g_single.state)
            {
            /*----audio----*/
            #ifdef __MMI_MEDIA_PLAYER_AUDIO__    
                case SINGLE_STATE_AUDIO_PAUSE_PROGRESSING:
                case SINGLE_STATE_AUDIO_PLAY_PROGRESSING:
                {
                    mmi_medply_main_screen_duration_seek_done();
                    if(g_single.need_to_build_cache)
                    {
                        mdi_audio_stop_build_cache();
                    }
                    mmi_medply_single_set_continue_flag(MMI_FALSE);            
                    mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_READY);
                    break;
                }
            #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

            /*----video----*/
            #ifdef __MMI_MEDIA_PLAYER_VIDEO__
                case SINGLE_STATE_VIDEO_PAUSE_PROGRESSING:
                case SINGLE_STATE_VIDEO_PLAY_PROGRESSING:
                {
                    mmi_medply_main_screen_duration_seek_done();
                    mmi_medply_single_set_continue_flag(MMI_FALSE);
                    mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_READY);
                    break;
                }
            #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

            /*----stream----*/
            #ifdef __MMI_MEDIA_PLAYER_STREAM__

                case SINGLE_STATE_STREAM_PLAY_PROGRESSING:
                {
                    mmi_medply_main_screen_duration_seek_done();
                    mmi_medply_single_set_continue_flag(MMI_FALSE);
                    mmi_medply_enter_single_states(SINGLE_STATE_STREAM_CONNECTED);
                    break;
                }

            #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

            #ifdef __MMI_VIDEO_PDL__   
                case SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING:
                case SINGLE_STATE_PDL_VIDEO_PLAY_PROGRESSING:
                {
                    mmi_medply_main_screen_duration_seek_done();
                    mmi_medply_single_set_continue_flag(MMI_FALSE);
                    mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_READY);
                    break;
                }
            #endif /*__MMI_VIDEO_PDL__*/
                default:
                {
                    break;
                }
            }
            
            g_single.selected_button_down = MMI_FALSE;

            if(g_single.pen_on_object == MMI_MEDPLY_RGN_ID_NEXT)
            {
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_NEXT,
                        MMI_MEDPLY_RGN_STATUS_UP);
            }
            else
            {
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PREV,
                        MMI_MEDPLY_RGN_STATUS_UP);
            }
            mmi_medply_main_screen_blt();
            break;
        }

    #ifndef __MMI_MEDIA_PLAYER_FTE__
        case MMI_MEDPLY_RGN_ID_STOP:
        {
            g_single.selected_button_down = MMI_FALSE;
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_STOP,
                    MMI_MEDPLY_RGN_STATUS_UP);
            mmi_medply_main_screen_blt();
            break;
        }
    #endif

        case MMI_MEDPLY_RGN_ID_PLAY_PAUSE:
        {
            g_single.selected_button_down = MMI_FALSE;
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_PLAY_PAUSE,
                    MMI_MEDPLY_RGN_STATUS_UP);
            mmi_medply_main_screen_blt();
            break;
        }

    #ifdef __MMI_MEDIA_PLAYER_FTE__
        case MMI_MEDPLY_RGN_ID_VOLUME_BAR:
        {
            g_single.volume = mmi_medply_main_screen_update_touch_volume(pos.x, 0);

            if(g_single.state != SINGLE_STATE_IDLE)
            {
                mdi_audio_set_volume(MDI_VOLUME_MEDIA, MDI_AUD_VOL_EX_MUTE(g_single.volume));
            }
            break;
        }
    #else
        case MMI_MEDPLY_RGN_ID_VOLUME_INC:
        {
            StopTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER);
            mmi_medply_single_press_inc_volume_up();
            break;
        }

        case MMI_MEDPLY_RGN_ID_VOLUME_DEC:
        {
            StopTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER);
            mmi_medply_single_press_dec_volume_up();
            break;
        }
    #endif

        case MMI_MEDPLY_RGN_ID_VOLUME_SPEAK:
        {
            g_single.unaffected_button_down = MMI_MEDPLY_RGN_ID_NULL;
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_SPEAK,
                    MMI_MEDPLY_RGN_STATUS_UP);
            mmi_medply_main_screen_blt();

            break;
        }

    #ifdef __MMI_MEDIA_PLAYER_FTE__
        case MMI_MEDPLY_RGN_ID_USER_RATING:
        {
            g_single.media_based_button_down = MMI_MEDPLY_RGN_ID_NULL;
            mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_USER_RATING,
                MMI_MEDPLY_RGN_STATUS_UP);
            mmi_medply_main_screen_blt();

            break;
        }
    #endif

    #ifdef __MMI_VIDEO_3D_ANAGLYPH__
	    case MMI_MEDPLY_RGN_ID_MODE:
			g_medply.affected_button_down = MMI_MEDPLY_RGN_ID_NULL;
                mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_MODE,
                    MMI_MEDPLY_RGN_STATUS_UP);

                mmi_medply_main_screen_blt();
			break;
    #endif

        default:
        {
            if(!g_medply.fullscreen)
            {
                wgui_status_icon_bar_translate_pen_event(
                    MMI_PEN_EVENT_ABORT,
                    pos.x,
                    pos.y,
                    &icon_id,
                    &evt_type);
            }
            break;
        }

    }

    StopTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER);
    StopTimer(MEDPLY_TOUCH_LONG_PRESS_TIMER);

    g_single.pen_on_object = MMI_MEDPLY_RGN_ID_NULL;
    g_single.selected_button_down = MMI_FALSE;
    g_single.unaffected_button_down = MMI_MEDPLY_RGN_ID_NULL;

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_pen_long_tab_hdlr
 * DESCRIPTION
 *  
 * PARAMETERS
 *  pos     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_pen_long_tap_hdlr(mmi_pen_point_struct pos)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 pen_object = mmi_medply_main_screen_get_pt_rgn(pos);
    S32 icon_id;
    wgui_status_icon_bar_pen_enum evt_type;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_TOUCH_PEN_LONG_TAB,g_single.pen_on_object, MMI_TRUE);

    if ((MMI_MEDPLY_RGN_ID_NEXT == g_medply.pen_on_object) ||
        (MMI_MEDPLY_RGN_ID_PREV == g_medply.pen_on_object))
    {
        gui_touch_feedback_play(GUI_TOUCH_FEEDBACK_HOLD);
    }

    switch (g_single.pen_on_object)
    {
        case MMI_MEDPLY_RGN_ID_NEXT:
        {
            StopTimer(MEDPLY_TOUCH_LONG_PRESS_TIMER);

            if(g_single.pen_on_object == pen_object)
            {
                mmi_medply_single_fast_forward();
            }
            break;
        }

        case MMI_MEDPLY_RGN_ID_PREV:
        {
            StopTimer(MEDPLY_TOUCH_LONG_PRESS_TIMER);

            if(g_single.pen_on_object == pen_object)
            {
                mmi_medply_single_rewind();
            }
            break;
        }

        default:
        {
            if(!g_medply.fullscreen)
            {
                wgui_status_icon_bar_translate_pen_event(
                    MMI_PEN_EVENT_LONG_TAP,
                    pos.x,
                    pos.y,
                    &icon_id,
                    &evt_type);
            }
            break;
        }
    }
    

}


#endif /*__MMI_TOUCH_SCREEN__*/

#ifdef MOTION_SENSOR_SUPPORT
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_motion_tilt_hdlr
 * DESCRIPTION
 *  tilt motin handler
 * PARAMETERS
 *  dirsct  [IN]
 *  action  [IN]
 *  detail  [IN]
 *  user data [IN]
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_motion_tilt_hdlr(srv_sensor_type_enum sensor_type, void *sensor_data, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL switch_by_motion ;
    srv_sensor_motion_direct_enum direction;
    srv_sensor_motion_direct_struct *p_direct;
    srv_sensor_motion_action_enum action;
    U32 curr_time;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /*MAUI_03010605*/
    kal_get_time((kal_uint32*)&curr_time);
    if(curr_time - g_medply.motion_reg_time < MMI_MEDPLY_MOTION_AVAILABLE_TIME)
    {
        return;
    }

    p_direct = (srv_sensor_motion_direct_struct *)sensor_data;

    direction = p_direct->direct;
    action = p_direct->action;

    mmi_medply_settings_read_value(MMI_MEDPLY_SETTINGS_MOTIONSENSOR, (void*)&switch_by_motion);

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_MOTION_TILT, direction, action, switch_by_motion, g_medply.fullscreen);

    if(mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_ZOOM) || !switch_by_motion || action == SRV_SENSOR_MOTION_ACTION_NULL)
    {
        return;
    }

    switch(direction)
    {
        case SRV_SENSOR_MOTION_ANGLE_GX180:
        {
            /*horizontal*/
            if(!g_medply.fullscreen)
            {
                mmi_medply_single_clear_key_down();
            #ifdef __MMI_TOUCH_SCREEN__
                mmi_medply_single_clear_pen_down();
            #endif
                mmi_medply_single_toggle_full_screen();
            }
            break;
        }

        case SRV_SENSOR_MOTION_ANGLE_GY180:
        {
            /*vertical*/
            if(g_medply.fullscreen)
            {
                mmi_medply_single_toggle_full_screen();
            }
            break;
        }

        default:
        {
            break;
        }
    }


}
#endif /*MOTION_SENSOR_SUPPORT*/

#ifdef __BT_SPK_VOL_CONTROL__
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_handfree_volume_sync_callback
 * DESCRIPTION
 *  
 * PARAMETERS
 *
 * RETURNS
 *  
 *****************************************************************************/
MMI_BOOL mmi_medply_single_handfree_volume_sync_callback(U8 volume, MMI_BOOL is_mute)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_HFP_VOL_CALLBACK, g_single.state, MMI_TRUE, g_single.volume, volume, g_single.mute, MMI_TRUE);

    ASSERT(volume <= MDI_AUD_VOL_EX_MUTE_MAX);

    g_single.volume = volume;

    if (g_single.state != SINGLE_STATE_IDLE)
    {
        mdi_audio_set_volume(MDI_VOLUME_MEDIA, (U8)(MDI_AUD_VOL_EX_MUTE(g_single.volume)));
    }

#ifdef __MMI_MEDIA_PLAYER_FTE__
    if(!g_single.mute &&  (MDI_AUD_VOL_EX_MUTE_MIN == g_single.volume))
    {
        g_single.mute = MMI_TRUE;
    }
    else if(g_single.mute && (MDI_AUD_VOL_EX_MUTE_MIN != g_single.volume))
    {
        g_single.mute = MMI_FALSE;
    }

    if(mmi_medply_main_screen_show_volme_tuning())
    {
        mmi_medply_single_clear_key_down();
    #ifdef __MMI_TOUCH_SCREEN__
        mmi_medply_single_clear_pen_down();
    #endif

        mmi_medply_single_register_key_hdlrs(MMI_MEDPLY_SCREEN_VOLUME);        
        mmi_medply_main_screen_update_mute();    
        mmi_medply_main_screen_update_vol();
    }

#else
    if(g_single.mute)
    {
        g_single.mute = MMI_FALSE;
        mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_SPEAK,MMI_MEDPLY_RGN_STATUS_UP);
    }

    if(mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_VOL_DEC))
    {
        mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_DEC,
            MMI_MEDPLY_RGN_STATUS_DISABLE);
    }
    else
    {
        mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_DEC,
            MMI_MEDPLY_RGN_STATUS_UP);
    }
    
    if(mmi_medply_is_button_disabled(MMI_MEDPLY_DISABLED_VOL_INC))
    {
        mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_INC,
            MMI_MEDPLY_RGN_STATUS_DISABLE);
    }
    else
    {
        mmi_medply_main_screen_set_and_draw_button(MMI_MEDPLY_RGN_ID_VOLUME_INC,
            MMI_MEDPLY_RGN_STATUS_UP);
    }

    mmi_medply_main_screen_draw_volume(g_single.volume);
#endif /*__MMI_MEDIA_PLAYER_FTE__*/

    if(!g_medply.fullscreen)
    {
        mmi_medply_main_screen_blt();
    }

    return MMI_TRUE;

}
#endif/*__BT_SPK_VOL_CONTROL__*/

#ifdef __MMI_MEDIA_PLAYER_FTE__
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_register_key_rating
 * DESCRIPTION
 *  register key hdlrs for raing main screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_register_key_rating(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 

    /*clear key events*/
    ClearInputEventHandler(MMI_DEVICE_KEY);

    /* register volume inc, dec handlers */
    SetKeyHandler(mmi_medply_single_press_FTE_inc_volume_key, KEY_VOL_UP, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_press_FTE_dec_volume_key, KEY_VOL_DOWN, KEY_EVENT_DOWN);

    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_LSK, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_RSK, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_ENTER, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_UP_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_DOWN_ARROW, KEY_EVENT_DOWN);

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_register_key_volume
 * DESCRIPTION
 *  register key hdlrs for volume setting main screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_register_key_volume(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 

    /*clear key events*/
    ClearInputEventHandler(MMI_DEVICE_KEY);

    /* register volume inc, dec handlers */
    SetKeyHandler(mmi_medply_single_press_FTE_inc_volume_down, KEY_VOL_UP, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_press_FTE_inc_volume_up, KEY_VOL_UP, KEY_EVENT_UP);
    SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_VOL_UP, KEY_EVENT_REPEAT);
    SetKeyHandler(mmi_medply_single_press_FTE_dec_volume_down, KEY_VOL_DOWN, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_press_FTE_dec_volume_up, KEY_VOL_DOWN, KEY_EVENT_UP);
    SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_VOL_DOWN, KEY_EVENT_REPEAT);

    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_LSK, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_RSK, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_ENTER, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_UP_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_DOWN_ARROW, KEY_EVENT_DOWN);

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_register_key_kuro
 * DESCRIPTION
 *  register key hdlrs for kuro setting main screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_register_key_kuro(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 

    /*clear key events*/
    ClearInputEventHandler(MMI_DEVICE_KEY);

    /* register volume inc, dec handlers */
    SetKeyHandler(mmi_medply_single_press_FTE_inc_volume_key, KEY_VOL_UP, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_press_FTE_dec_volume_key, KEY_VOL_DOWN, KEY_EVENT_DOWN);

    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_LSK, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_RSK, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_ENTER, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_UP_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_main_screen_close_popup_setting, KEY_DOWN_ARROW, KEY_EVENT_DOWN);

}
#endif /*__MMI_MEDIA_PLAYER_FTE__*/

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_register_key_normal
 * DESCRIPTION
 *  register key hdlrs for normal main screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_register_key_normal(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 

    ClearInputEventHandler(MMI_DEVICE_KEY);

#if defined(__MMI_BACKGROUND_CALL__) && !defined(__RF_DESENSE_TEST__) && !defined(__CS_STREAMING_CONCURRENT_SUPPORT__)
    if(srv_ucm_is_background_call())
    {
        /* register LSK, RSK hanlders */
        SetKeyHandler(mmi_medply_single_press_rsk_up, KEY_RSK, KEY_EVENT_UP);
        SetKeyHandler(mmi_medply_single_press_rsk_down, KEY_RSK, KEY_EVENT_DOWN);
        SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_RSK, KEY_EVENT_REPEAT);
        return;
    }
#endif

    /* register LSK, RSK hanlders */
    SetKeyHandler(NULL, KEY_LSK, KEY_EVENT_UP);
    SetKeyHandler(mmi_medply_single_press_rsk_up, KEY_RSK, KEY_EVENT_UP);
    SetKeyHandler(NULL, KEY_LSK, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_press_rsk_down, KEY_RSK, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_LSK, KEY_EVENT_REPEAT);
    SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_RSK, KEY_EVENT_REPEAT);

#if defined(__MMI_FTE_SUPPORT__) && !defined(__MMI_MEDIA_PLAYER_FTE__)
   SetKeyHandler(mmi_medply_single_press_play_button_down, KEY_ENTER, KEY_EVENT_DOWN);
   SetKeyHandler(mmi_medply_single_press_play_button_up, KEY_ENTER, KEY_EVENT_UP);
   SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_ENTER, KEY_EVENT_REPEAT);
#else
   SetKeyHandler(mmi_medply_single_press_play_button_up, KEY_UP_ARROW, KEY_EVENT_UP);
   SetKeyHandler(mmi_medply_single_press_play_button_down, KEY_UP_ARROW, KEY_EVENT_DOWN);
   SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_UP_ARROW, KEY_EVENT_REPEAT);
#endif

    /* register play / pause, stop, prev, next button handlers */
    SetKeyHandler(mmi_medply_single_press_prev_button_up, KEY_LEFT_ARROW, KEY_EVENT_UP);
    SetKeyHandler(mmi_medply_single_press_next_button_up, KEY_RIGHT_ARROW, KEY_EVENT_UP);
#if defined(__MMI_MEDIA_PLAYER_FTE__) && !defined(MMI_MEDPLY_FTE_STOP_SUPPORT_ICON)
    SetKeyHandler(mmi_medply_single_press_play_button_up, KEY_DOWN_ARROW, KEY_EVENT_UP);
#else
    #if defined(__MMI_FTE_SUPPORT__) && !defined(__MMI_MEDIA_PLAYER_FTE__) && defined(__MMI_MAINLCD_320X240__)
    SetKeyHandler(mmi_medply_single_press_stop_button_up, KEY_UP_ARROW, KEY_EVENT_UP);
    #else
    SetKeyHandler(mmi_medply_single_press_stop_button_up, KEY_DOWN_ARROW, KEY_EVENT_UP);    
    #endif
#endif

    SetKeyHandler(mmi_medply_single_press_prev_button_down, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_press_next_button_down, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);

#if defined(__MMI_MEDIA_PLAYER_FTE__) && !defined(MMI_MEDPLY_FTE_STOP_SUPPORT_ICON)
    SetKeyHandler(mmi_medply_single_press_play_button_down, KEY_DOWN_ARROW, KEY_EVENT_DOWN);
#else
    #if defined(__MMI_FTE_SUPPORT__) && defined(__MMI_MAINLCD_320X240__)
    SetKeyHandler(mmi_medply_single_press_stop_button_down, KEY_UP_ARROW, KEY_EVENT_DOWN);
    #else
    SetKeyHandler(mmi_medply_single_press_stop_button_down, KEY_DOWN_ARROW, KEY_EVENT_DOWN);
    #endif
#endif

    SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_LEFT_ARROW, KEY_EVENT_REPEAT);
    SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_RIGHT_ARROW, KEY_EVENT_REPEAT);
    SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_DOWN_ARROW, KEY_EVENT_REPEAT);

    /*register next / prev button long press handlers*/
    SetKeyHandler(mmi_medply_single_rewind, KEY_LEFT_ARROW, KEY_EVENT_LONG_PRESS);
    SetKeyHandler(mmi_medply_single_fast_forward, KEY_RIGHT_ARROW, KEY_EVENT_LONG_PRESS);

    /* register volume inc, dec handlers */
#ifdef __MMI_MEDIA_PLAYER_FTE__
    SetKeyHandler(mmi_medply_single_press_FTE_inc_volume_key, KEY_VOL_UP, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_press_FTE_inc_volume_up, KEY_VOL_UP, KEY_EVENT_UP);
    SetKeyHandler(mmi_medply_single_press_FTE_dec_volume_key, KEY_VOL_DOWN, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_press_FTE_dec_volume_up, KEY_VOL_DOWN, KEY_EVENT_UP);
#else
    SetKeyHandler(mmi_medply_single_press_inc_volume_down, KEY_VOL_UP, KEY_EVENT_DOWN);
	SetKeyHandler(mmi_medply_single_press_inc_volume_up, KEY_VOL_UP, KEY_EVENT_UP);
	SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_VOL_UP, KEY_EVENT_REPEAT);
    SetKeyHandler(mmi_medply_single_press_dec_volume_down, KEY_VOL_DOWN, KEY_EVENT_DOWN);
	SetKeyHandler(mmi_medply_single_press_dec_volume_up, KEY_VOL_DOWN, KEY_EVENT_UP);
	SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_VOL_DOWN, KEY_EVENT_REPEAT);
#endif

    /* register mute/un-mute */
#ifndef __MMI_MEDIA_PLAYER_FTE__
    SetKeyHandler(mmi_medply_single_press_mute_down, KEY_POUND, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_press_mute_up, KEY_POUND, KEY_EVENT_UP);
    SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_POUND, KEY_EVENT_REPEAT);
#endif

#ifdef __MMI_MEDIA_PLAYER_FTE__
    SetKeyHandler(mmi_medply_single_full_screen_key_down_hdlr, KEY_ENTER, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_full_screen_key_up_hdlr, KEY_ENTER, KEY_EVENT_UP);
    SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_ENTER, KEY_EVENT_REPEAT);
#elif defined(__MMI_FTE_SUPPORT__)
    #if defined(__MMI_MAINLCD_320X240__)
    SetKeyHandler(mmi_medply_single_full_screen_key_up_hdlr, KEY_DOWN_ARROW, KEY_EVENT_UP);
    SetKeyHandler(mmi_medply_single_full_screen_key_down_hdlr, KEY_DOWN_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_DOWN_ARROW, KEY_EVENT_REPEAT);
    #else
    SetKeyHandler(mmi_medply_single_full_screen_key_up_hdlr, KEY_UP_ARROW, KEY_EVENT_UP);
    SetKeyHandler(mmi_medply_single_full_screen_key_down_hdlr, KEY_UP_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_UP_ARROW, KEY_EVENT_REPEAT);
    #endif
#else
    SetKeyHandler(mmi_medply_single_full_screen_key_down_hdlr, KEY_STAR, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_full_screen_key_up_hdlr, KEY_STAR, KEY_EVENT_UP);
    SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_STAR, KEY_EVENT_REPEAT);
#endif

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_register_key_normal
 * DESCRIPTION
 *  register key hdlrs for normal main screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_register_key_full(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 

    ClearInputEventHandler(MMI_DEVICE_KEY);

    /*toggle full screen*/
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_1, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_2, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_3, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_4, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_5, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_6, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_7, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_8, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_9, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_0, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_POUND, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_LSK, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_RSK, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_ENTER, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_UP_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_DOWN_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_CLEAR, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_STAR, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_CAMERA, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_toggle_full_screen, KEY_SEND, KEY_EVENT_DOWN); 

    /* register volume inc, dec handlers */
#ifdef __MMI_MEDIA_PLAYER_FTE__
    SetKeyHandler(mmi_medply_single_press_FTE_inc_volume_down, KEY_VOL_UP, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_press_FTE_inc_volume_up, KEY_VOL_UP, KEY_EVENT_UP);
    SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_VOL_UP, KEY_EVENT_REPEAT);    
    SetKeyHandler(mmi_medply_single_press_FTE_dec_volume_down, KEY_VOL_DOWN, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_press_FTE_dec_volume_up, KEY_VOL_DOWN, KEY_EVENT_UP);
    SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_VOL_DOWN, KEY_EVENT_REPEAT);
#else
    SetKeyHandler(mmi_medply_single_press_inc_volume_down, KEY_VOL_UP, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_press_inc_volume_up, KEY_VOL_UP, KEY_EVENT_UP);
    SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_VOL_UP, KEY_EVENT_REPEAT);
    SetKeyHandler(mmi_medply_single_press_dec_volume_down, KEY_VOL_DOWN, KEY_EVENT_DOWN);
    SetKeyHandler(mmi_medply_single_press_dec_volume_up, KEY_VOL_DOWN, KEY_EVENT_UP);
    SetKeyHandler(mmi_medply_single_dummy_key_hdlr, KEY_VOL_DOWN, KEY_EVENT_REPEAT);
#endif

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_register_key_hdlrs
 * DESCRIPTION
 *  register key hdlrs for different main screen cases
 * PARAMETERS
 *  screen_status   [IN]
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_register_key_hdlrs(mmi_medply_main_screen_status_enum screen_status)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/ 
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 

    switch(screen_status)
    {
        case MMI_MEDPLY_SCREEN_NORMAL:
        {
            mmi_medply_single_register_key_normal(); 
            break;
        }
        case MMI_MEDPLY_SCREEN_FULL:
        {
            mmi_medply_single_register_key_full();
            break;
        }

    #ifdef __MMI_MEDIA_PLAYER_FTE__
        case MMI_MEDPLY_SCREEN_KURO:
        {
            mmi_medply_single_register_key_kuro();
            break;
        }

        case MMI_MEDPLY_SCREEN_VOLUME:
        {
            mmi_medply_single_register_key_volume();
            break;
        }

        case MMI_MEDPLY_SCREEN_RATING:
        {
            mmi_medply_single_register_key_rating();
            break;
        }
    #endif /* __MMI_MEDIA_PLAYER_FTE__ */

        default:
        {
            ASSERT(0);
        }

    }


}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_delete_player_screen
 * DESCRIPTION
 *  for other applicatons to delete single player screen.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_delete_player_screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_DELETE_SINGLE_SCREEN);
    
    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_delete_history_hdlr
 * DESCRIPTION
 *  delete main screen history function
 * PARAMETERS
 *  in_param        [in]
 * RETURNS
 *  mmi_ret
 *****************************************************************************/
static mmi_ret mmi_medply_single_delete_history_hdlr(mmi_event_struct* evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_DELETE_HISTORY,g_single.state,g_single.continue_to_play, MMI_TRUE);
    if(EVT_ID_SCRN_DEINIT != evt->evt_id)
    {
	return MMI_RET_OK; 
    }

    switch(g_single.state)
    {
    #ifdef __MMI_MEDIA_PLAYER_AUDIO__
        case SINGLE_STATE_AUDIO_PLAY:
        {
            /*stop file*/
            mdi_audio_stop_file();
            break;
        }

        case SINGLE_STATE_AUDIO_PLAY_PROGRESSING:
        case SINGLE_STATE_AUDIO_PAUSE_PROGRESSING:
        {
            if(g_single.need_to_build_cache)
            {
                g_single.need_to_build_cache = MMI_FALSE;
                mdi_audio_stop_build_cache();
            }
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

    #ifdef __MMI_MEDIA_PLAYER_VIDEO__
        case SINGLE_STATE_VIDEO_OPENING:
        {
            mdi_video_ply_stop_non_block_seek();
            mmi_medply_single_video_close();
            break;
        }

        case SINGLE_STATE_VIDEO_BT_CONNECTING:
        case SINGLE_STATE_VIDEO_READY:
        case SINGLE_STATE_VIDEO_PLAY_PROGRESSING:
        case SINGLE_STATE_VIDEO_PAUSE_PROGRESSING:
        {
            /*close video*/
            mmi_medply_single_video_close();
            break;            
        }

        case SINGLE_STATE_VIDEO_PAUSE_SEEKING:
        case SINGLE_STATE_VIDEO_PLAY_SEEKING:
        {
            mdi_video_ply_stop_non_block_seek();
            mmi_medply_single_video_close();            
            break;
        }

        case SINGLE_STATE_VIDEO_PLAY:
        {
            mdi_video_ply_stop();
            mmi_medply_single_video_close();
            break;
        }

    #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

    #ifdef __MMI_MEDIA_PLAYER_STREAM__
        case SINGLE_STATE_STREAM_INITED:
        {
            mmi_medply_single_stream_deinit();
            break;
        }

        case SINGLE_STATE_STREAM_BT_CONNECTING:
        case SINGLE_STATE_STREAM_CONNECTING:
        case SINGLE_STATE_STREAM_CONNECTED:            
        {
            mdi_video_stream_disconnect();
            mmi_medply_single_stream_deinit();
            break;
        }

        case SINGLE_STATE_STREAM_BUFFERING:
        {
            StopTimer(MEDPLY_STREAM_BUFFER_TIMER);            
            mdi_video_stream_stop_buffering();
            mdi_video_stream_disconnect();
            mmi_medply_single_stream_deinit();
            break;
        }

        case SINGLE_STATE_STREAM_PLAY:
        {
            mdi_video_stream_stop();
            mdi_video_stream_disconnect();
            mmi_medply_single_stream_deinit();
            break;
        }

        case SINGLE_STATE_STREAM_PLAY_PROGRESSING:
        {
            mdi_video_stream_disconnect();
            mmi_medply_single_stream_deinit();            
            break;
        }

        case SINGLE_STATE_STREAM_IN_HISTORY:
        {
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_STREAM__*/
    
    #ifdef __MMI_AUDIO_PDL__
        case SINGLE_STATE_PDL_AUDIO_PLAY:
        {
            /*stop file*/
            mdi_audio_mma_stop(g_single.pdl_audio_handle);
            mdi_audio_mma_close(g_single.pdl_audio_handle);
            g_single.pdl_audio_handle = NULL;
            break;
        }

        case SINGLE_STATE_PDL_AUDIO_BT_CONNECTING:
        case SINGLE_STATE_PDL_AUDIO_READY:
        case SINGLE_STATE_PDL_AUDIO_BUFFERING:            
        case SINGLE_STATE_PDL_AUDIO_IN_HISTORY:
        {
            StopTimer(MEDPLY_PDL_BUFFER_TIMER);
            if(g_single.pdl_audio_handle != NULL)
            {
                mdi_audio_mma_close(g_single.pdl_audio_handle);
                g_single.pdl_audio_handle = NULL;
            }
            break;
        }
    #endif /*__MMI_AUDIO_PDL__*/

    #ifdef __MMI_VIDEO_PDL__
        case SINGLE_STATE_PDL_VIDEO_OPENING:
        {
            StopTimer(MEDPLY_PDL_BUFFER_TIMER);
            StopTimer(MEDPLY_PDL_CALC_DOWNLOAD_TIMER);
            mdi_video_ply_stop_non_block_seek();
            mdi_video_progressive_close_file();
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_BT_CONNECTING:
        case SINGLE_STATE_PDL_VIDEO_READY:
        case SINGLE_STATE_PDL_VIDEO_PLAY_PROGRESSING:            
        case SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING:
        case SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING:
        case SINGLE_STATE_PDL_VIDEO_PAUSE_BUFFERING:
        {
            StopTimer(MEDPLY_PDL_BUFFER_TIMER);
            StopTimer(MEDPLY_PDL_CALC_DOWNLOAD_TIMER);
            
            /*close video*/
            mdi_video_progressive_close_file();
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_PAUSE_SEEKING:
        case SINGLE_STATE_PDL_VIDEO_PLAY_SEEKING:
        {
            StopTimer(MEDPLY_PDL_CALC_DOWNLOAD_TIMER);            
            mdi_video_ply_stop_non_block_seek();
            mdi_video_progressive_close_file();
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_PLAY:
        {
            StopTimer(MEDPLY_PDL_CALC_DOWNLOAD_TIMER);
            mdi_video_ply_stop();
            mdi_video_progressive_close_file();
            
            break;
        }
    #endif /*__MMI_VIDEO_PDL__*/

        case SINGLE_STATE_WAIT_NEXT:
        /*for intro play finish callback*/
        case SINGLE_STATE_IDLE:
        {
        #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
            g_single.wait_next_with_pop_up = MMI_FALSE;
            StopTimer(MEDPLY_SINGLE_WAIT_NEXT_TIMER);
        #endif
            break;
        }

        default:
        {
            break;
        }
    }

#if defined(__MMI_VIDEO_PDL__) || defined(__MMI_AUDIO_PDL__)
    if(g_single.media_type == MEDPLY_TYPE_PDL_AUDIO || g_single.media_type == MEDPLY_TYPE_PDL_VIDEO)
    {
        srv_da_stop_pdl(g_single.pdl_session_id);
        g_single.pdl_session_id = -1;
        g_single.pdl_state = MEDPLY_PDL_STATE_EXIT;
     }
#endif /*defined(__MMI_VIDEO_PDL__) || defined(__MMI_AUDIO_PDL__)*/

#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
    g_single.intro_play = MMI_FALSE;
    g_single.intro_play_finish = MMI_FALSE;
#endif

#ifdef __MMI_MEDIA_PLAYER_AUDIO__
    if(g_single.media_type == MEDPLY_TYPE_AUDIO)
    {
        mdi_audio_reset_build_cache_variables();
    }
#endif

#ifdef __TCPIP__
#ifdef __MMI_MEDIA_PLAYER_STREAM__
    /*check if file still exists*/
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_RELEASE_BEARER, __LINE__);
    switch(g_single.media_type)
    {
        case MEDPLY_TYPE_STREAM_RTSP:
        case MEDPLY_TYPE_STREAM_SDP:
        case MEDPLY_TYPE_STREAM_RAM:
        {
            U32 data_account_id;
            mmi_medply_settings_get_data_account_id(&data_account_id);
            cbm_release_bearer(cbm_get_app_id(data_account_id));
            break;
        }
    }
#endif
#endif


    mmi_medply_single_set_continue_flag(MMI_FALSE);
    mmi_medply_enter_single_states(SINGLE_STATE_IDLE);

    g_single.selected_button = MEDPLY_MAIN_PLAY;

    mmi_medply_main_screen_delete(NULL);
    

#ifdef __MMI_MEDIA_PLAYER_AUDIO__
    if(g_single.audio_exit_callback_func != NULL)
    {
        g_single.audio_exit_callback_func();
        g_single.audio_exit_callback_func = NULL;
    }
#endif

    mdi_audio_resume_background_play();
#ifdef __MMI_NCENTER_SUPPORT__
    if (g_single.ncenter_ghandle)
    {
        mmi_medply_ncenter_add_app_item();
        g_single.ncenter_ghandle = NULL;
    }
#endif 

    return MMI_RET_OK;
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_update_main
 * DESCRIPTION
 *  entry snigle main screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_update_main()
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#ifdef MOTION_SENSOR_SUPPORT
    srv_sensor_motion_direct_cfg_struct sensitive;
#endif
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_UPDATE_MAIN,g_single.state,g_single.media_type, MMI_TRUE);

    mmi_medply_main_screen_redraw();
    mmi_medply_main_screen_blt();

    /* register delete screen hdlr, prvent return without registering*/
    mmi_frm_scrn_set_leave_proc(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN, mmi_medply_single_delete_history_hdlr);

#ifdef __MMI_AVRCP_SUPPORT__
    mmi_bt_avrcp_set_cmd_hdlr(mmi_medply_single_bt_avrcp_cmd_hdlr);
#endif 

#ifdef MOTION_SENSOR_SUPPORT
    /*MAUI_03010605*/
    kal_get_time((kal_uint32*)&g_medply.motion_reg_time);
    sensitive.angle_threshold = 30;
    //modify for sensor split
    // g_medply.tilt_handle = mdi_motion_start_listen_tilt(MDI_MOTION_SENSITIVE_HIGH, MDI_MOTION_TILT_EVENT_AXIS, mmi_medply_single_motion_tilt_hdlr, NULL);
    g_medply.tilt_handle = srv_sensor_start_listen(SRV_SENSOR_MOTION_DIRECT,&sensitive, mmi_medply_single_motion_tilt_hdlr , NULL);

#endif

#ifdef __MMI_TOUCH_FEEDBACK_SUPPORT__
/* under construction !*/
#endif


#ifdef __TCPIP__
#ifdef __MMI_MEDIA_PLAYER_STREAM__
        /*check if file still exists*/
        MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_HOLD_BEARER, g_single.bearer_pause, __LINE__);
        if(g_single.bearer_pause != MMI_TRUE)
        {
           switch(g_single.media_type)
           {
                case MEDPLY_TYPE_STREAM_RTSP:
                case MEDPLY_TYPE_STREAM_SDP:
                case MEDPLY_TYPE_STREAM_RAM:
                {
                    U32 data_account_id;
                    mmi_medply_settings_get_data_account_id(&data_account_id);
                    cbm_hold_bearer(cbm_get_app_id(data_account_id));
                    break;
                }
            }
        }
#endif
#endif


    /*check if file still exists*/
    switch(g_single.media_type)
    {
        case MEDPLY_TYPE_AUDIO:
        case MEDPLY_TYPE_VIDEO:
        case MEDPLY_TYPE_STREAM_SDP:
        case MEDPLY_TYPE_STREAM_RAM:
        /*PDL can not use FS_OPEN with read only, since it is not possible for PDL to be killed
          so, do not need to check for PDL */
        /*case MEDPLY_TYPE_PDL_VIDEO:*/
        /*case MEDPLY_TYPE_PDL_AUDIO:*/
        {
            FS_HANDLE file_handle;

        #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
            if(g_single.intro_play)
            {
                break;
            }
        #endif
            /*Chnage for MMS Requirement for FS_GetAttribute can not open virtual file*/
            file_handle = FS_Open((U16*)g_single.filefullpath, FS_READ_ONLY);

            if (file_handle < 0)
            {
                mmi_event_notify_enum result_type ;
                MMI_ID_TYPE fs_string;

                fs_string = srv_fmgr_fs_error_get_string_and_popup_type(file_handle,(S32*)&result_type);

                mmi_popup_display_simple((WCHAR*)GetString(fs_string), result_type, GRP_ID_MEDPLY_SINGLE, NULL);

                if(mmi_frm_scrn_is_present(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
                {
                    mmi_frm_scrn_close(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN);
                }
                else
                {
                    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
                }
                return;
            }
            FS_Close(file_handle);
            break;
        }

        default:
        {
            break;
        }
    }


#if defined(__MMI_BACKGROUND_CALL__) && !defined(__RF_DESENSE_TEST__) && !defined(__CS_STREAMING_CONCURRENT_SUPPORT__)
    if(srv_ucm_is_background_call())
    {

        mmi_medply_single_register_key_hdlrs(MMI_MEDPLY_SCREEN_NORMAL);

        /* register pen hdlr*/
    #ifdef __MMI_TOUCH_SCREEN__
        mmi_pen_register_down_handler(mmi_medply_single_pen_down_hdlr);
        mmi_pen_register_up_handler(mmi_medply_single_pen_up_hdlr);
        mmi_pen_register_move_handler(mmi_medply_single_pen_move_hdlr);
        mmi_pen_register_abort_handler(mmi_medply_single_pen_abort_hdlr);
        mmi_pen_register_long_tap_handler(mmi_medply_single_pen_long_tap_hdlr);
    #endif /* __MMI_TOUCH_SCREEN__ */ 

        return;
    }
#endif

    MMI_ASSERT(g_medply.fullscreen != MMI_TRUE);

    mmi_medply_single_register_key_hdlrs(MMI_MEDPLY_SCREEN_NORMAL);

    /* register pen hdlr*/
#ifdef __MMI_TOUCH_SCREEN__
    mmi_pen_register_down_handler(mmi_medply_single_pen_down_hdlr);
    mmi_pen_register_up_handler(mmi_medply_single_pen_up_hdlr);
    mmi_pen_register_move_handler(mmi_medply_single_pen_move_hdlr);
    mmi_pen_register_abort_handler(mmi_medply_single_pen_abort_hdlr);
    mmi_pen_register_long_tap_handler(mmi_medply_single_pen_long_tap_hdlr);
#endif /* __MMI_TOUCH_SCREEN__ */ 

    switch (g_single.state)
    {
        case SINGLE_STATE_IDLE:
        {
            /*to handle intro play finish with pop up and entry main again*/
            if(!g_single.continue_to_play)
            {
                break;
            }
            switch(g_single.media_type)
            {
                case MEDPLY_TYPE_AUDIO:
                {
                #ifdef __MMI_MEDIA_PLAYER_AUDIO__
                    mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_READY);
                #endif
                    break;
                }

                case MEDPLY_TYPE_VIDEO:
                {
                #ifdef __MMI_MEDIA_PLAYER_VIDEO__
                    MMI_BOOL result;
                    result = mmi_medply_single_video_open();
                    if(!result)
                    {
                        return;
                    }
                #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/
                    break;
                }

                case MEDPLY_TYPE_STREAM_RTSP:
                case MEDPLY_TYPE_STREAM_SDP:
                case MEDPLY_TYPE_STREAM_RAM:
                {
                #ifdef __MMI_MEDIA_PLAYER_STREAM__
                    MMI_BOOL result;
                    result = mmi_medply_single_stream_init();
                    if(!result)
                    {
                        return;
                    }
                    mmi_medply_single_set_continue_flag(MMI_FALSE);
                    mmi_medply_single_stream_connect();
                #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/
                    break;
                }

                case MEDPLY_TYPE_PDL_VIDEO:
                {
                #ifdef __MMI_VIDEO_PDL__
                    MMI_BOOL result;
                    result = mmi_medply_single_pdl_video_open();
                    if(!result)
                    {
                        return;
                    }
                    break;
                #endif /*__MMI_VIDEO_PDL__*/
                }

                case MEDPLY_TYPE_PDL_AUDIO:
                {
                #ifdef __MMI_AUDIO_PDL__
                    MMI_BOOL result;
                    result = mmi_medply_single_pdl_audio_open();
                    if(!result)
                    {
                        return;
                    }
                    mmi_medply_single_pdl_audio_play();
                    break;
                #endif /*__MMI_AUDIO_PDL__*/
                }

                case MEDPLY_TYPE_NONE:
                {
                    mmi_medply_single_set_continue_flag(MMI_FALSE);
                    break;
                }

                default:
                {
                    MMI_ASSERT(0);
                    break;
                }
            }

            break;
        }

    #ifdef __MMI_MEDIA_PLAYER_AUDIO__    
        case SINGLE_STATE_AUDIO_IN_HISTORY:
        case SINGLE_STATE_AUDIO_WAIT_ACTIVATE:
        case SINGLE_STATE_AUDIO_PLAY_WAIT_ACTIVATE:
        {
            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_READY);
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

    #ifdef __MMI_MEDIA_PLAYER_VIDEO__
        case SINGLE_STATE_VIDEO_IN_HISTORY:
        {
            MMI_BOOL result;
            result = mmi_medply_single_video_open();
            if(!result)
            {
                return;
            }
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

    #ifdef __MMI_MEDIA_PLAYER_STREAM__
        case SINGLE_STATE_STREAM_IN_HISTORY:
        {
            MMI_BOOL result;
            result = mmi_medply_single_stream_init();
            if(!result)
            {
                return;
            }
            if(g_single.continue_to_play)
            {
                mmi_medply_single_stream_connect();
                mmi_medply_single_set_continue_flag(MMI_FALSE);
            }
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

    #ifdef __MMI_VIDEO_PDL__
        case SINGLE_STATE_PDL_VIDEO_IN_HISTORY:
        {
            MMI_BOOL result;
            result = mmi_medply_single_pdl_video_open();
            if(!result)
            {
                return;
            }
            break;
        }
    #endif /*__MMI_VIDEO_PDL__*/

    #ifdef __MMI_AUDIO_PDL__
        case SINGLE_STATE_PDL_AUDIO_IN_HISTORY:
        {
            MMI_BOOL result;
            result = mmi_medply_single_pdl_audio_open();
            if(!result)
            {
                return;
            }

            break;
        }
    #endif /*__MMI_AUDIO_PDL__*/

        case SINGLE_STATE_WAIT_NEXT:
        {
            break;
        }

        default:
        {
            MMI_ASSERT(0);
            break;            
        }
    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_exit_main
 * DESCRIPTION
 *  exit main screen function
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_exit_main()
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S16 error;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_EXIT_MAIN,g_single.state,MMI_FALSE, MMI_TRUE);

    g_single.selected_button_down = MMI_FALSE;
#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
    if(!g_single.intro_play)
#endif
    {
        g_single.selected_button = MEDPLY_MAIN_PLAY;
    }

    g_single.unaffected_button_down = MMI_MEDPLY_RGN_ID_NULL;

#ifdef __MMI_AVRCP_SUPPORT__
    mmi_bt_avrcp_clear_cmd_hdlr(mmi_medply_single_bt_avrcp_cmd_hdlr);
#endif 

#ifdef MOTION_SENSOR_SUPPORT
    if(g_medply.tilt_handle >= 0)
    {
        srv_sensor_stop_listen(g_medply.tilt_handle);
        g_medply.tilt_handle = -1 ;
    }
#endif

#ifdef __MMI_TOUCH_FEEDBACK_SUPPORT__
/* under construction !*/
#endif


    StopTimer(MEDPLY_TOUCH_AUTO_RUN_TIMER);

    #ifdef __MMI_MEDIA_PLAYER_AUDIO__
    if(g_single.media_type == MEDPLY_TYPE_AUDIO)
    {
        mdi_audio_close_build_cache();
    }
    #endif

#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
    if(g_single.pop_up)
    {
        if(g_medply.fullscreen)
        {
            mmi_medply_main_screen_set_full_screen(MMI_FALSE);
            mmi_medply_main_screen_clear_video_layer();
            g_medply.fullscreen = MMI_FALSE;
        }

    #ifdef MMI_MEDPLY_SINGLE_HIGH_RATE_SAMPLING_PROGRESS_BAR_PERFORMANCE
        mmi_pen_config_sampling_period(MMI_PEN_SAMPLING_PERIOD_1,MMI_PEN_SAMPLING_PERIOD_2);
    #endif

        mmi_medply_main_screen_unprepare();
    
    #ifdef __MMI_MEDIA_PLAYER_AUDIO__
#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif
    #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

        #ifdef MMI_MEDPLY_SINGLE_HIGH_RATE_SAMPLING_PROGRESS_BAR_PERFORMANCE
        mmi_pen_config_sampling_period(MMI_PEN_SAMPLING_PERIOD_1,MMI_PEN_SAMPLING_PERIOD_2);
        #endif
        mmi_medply_main_screen_unprepare();

    #ifdef  __MMI_TOUCH_SCREEN__
        ClearInputEventHandler(MMI_DEVICE_PEN);
    #endif
        g_single.pop_up = MMI_FALSE;

        return;
    }
#endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

    switch(g_single.state)
    {
    /*----audio----*/
    #ifdef __MMI_MEDIA_PLAYER_AUDIO__
        case SINGLE_STATE_AUDIO_PLAY_PROGRESSING:
        case SINGLE_STATE_AUDIO_PAUSE_PROGRESSING:
        {
            if(g_single.need_to_build_cache)
            {
                mdi_audio_stop_build_cache();
            }
            mmi_medply_single_set_continue_flag(MMI_FALSE);            
            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_IN_HISTORY);
            break;
        }
        
        case SINGLE_STATE_AUDIO_PLAY:
        {
            mmi_medply_single_set_self_stop_flag(MMI_TRUE);

            /*stop file*/
            mdi_audio_stop_file();

            mmi_medply_single_set_self_stop_flag(MMI_FALSE);

            mmi_medply_single_set_continue_flag(MMI_FALSE);
            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_IN_HISTORY);

            break;
        }

        case SINGLE_STATE_AUDIO_BT_CONNECTING:
        case SINGLE_STATE_AUDIO_READY:
        {
            mmi_medply_single_set_continue_flag(MMI_FALSE);
            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_IN_HISTORY);
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

    #ifdef __MMI_MEDIA_PLAYER_VIDEO__
        case SINGLE_STATE_VIDEO_OPENING:
        {
            mdi_video_ply_stop_non_block_seek();
            mmi_medply_single_video_close();
            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_IN_HISTORY);
            break;
        }
        case SINGLE_STATE_VIDEO_BT_CONNECTING:
        case SINGLE_STATE_VIDEO_READY:
        case SINGLE_STATE_VIDEO_PLAY_PROGRESSING:
        case SINGLE_STATE_VIDEO_PAUSE_PROGRESSING:
        {
            if(!g_single.seekable)
            {
                g_single.current_time = 0;
            }

            /*close video*/
            mmi_medply_single_video_close();
            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_IN_HISTORY);
            break;
        }

        case SINGLE_STATE_VIDEO_PLAY:
        {
            mdi_video_ply_stop();

            if(!g_single.seekable)
            {
                g_single.current_time = 0;
            }

            mmi_medply_single_video_close();
            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_IN_HISTORY);
            break;
        }

        case SINGLE_STATE_VIDEO_PLAY_SEEKING:
        case SINGLE_STATE_VIDEO_PAUSE_SEEKING:
        {
            mdi_video_ply_stop_non_block_seek();
            mmi_medply_single_video_close();
            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_IN_HISTORY);
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

    #ifdef __MMI_MEDIA_PLAYER_STREAM__
        case SINGLE_STATE_STREAM_INITED:
        {
            mmi_medply_single_stream_deinit();
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_IN_HISTORY);
            break;
        }

        case SINGLE_STATE_STREAM_CONNECTED:
        {            
            mdi_video_stream_disconnect();
            mmi_medply_single_stream_deinit();
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_IN_HISTORY);
            break;
        }


        case SINGLE_STATE_STREAM_BT_CONNECTING:
        case SINGLE_STATE_STREAM_CONNECTING:
        {            
            mdi_video_stream_disconnect();
            mmi_medply_single_stream_deinit();
            mmi_medply_single_set_continue_flag(MMI_TRUE);
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_IN_HISTORY);
            break;
        }

        case SINGLE_STATE_STREAM_BUFFERING:
        {
            StopTimer(MEDPLY_STREAM_BUFFER_TIMER);
            mdi_video_stream_stop_buffering();
            mdi_video_stream_disconnect();
            mmi_medply_single_stream_deinit();
            mmi_medply_single_set_continue_flag(MMI_TRUE);
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_IN_HISTORY);
            break;
        }

        case SINGLE_STATE_STREAM_PLAY:
        {
            mdi_video_stream_stop();
            mdi_video_stream_disconnect();
            mmi_medply_single_stream_deinit();
            mmi_medply_single_set_continue_flag(MMI_TRUE);
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_IN_HISTORY);
            break;
        }

        case SINGLE_STATE_STREAM_PLAY_PROGRESSING:
        {
            mdi_video_stream_disconnect();
            mmi_medply_single_stream_deinit();
            mmi_medply_single_set_continue_flag(MMI_TRUE);
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_IN_HISTORY);            
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

    #ifdef __MMI_AUDIO_PDL__
        case SINGLE_STATE_PDL_AUDIO_PLAY:
        {
            /*set to latest time*/
            mdi_audio_mma_get_current_time(g_single.pdl_audio_handle,(U32*)(&g_single.current_time));

            if(g_single.current_time > g_single.duration)
            {
    	        g_single.duration = g_single.current_time;
            }

            mmi_medply_single_set_self_stop_flag(MMI_TRUE);
        
            /*stop file*/
            mdi_audio_mma_stop(g_single.pdl_audio_handle);

            if(g_single.pdl_audio_handle != NULL)
            {
                mdi_audio_mma_close(g_single.pdl_audio_handle);
                g_single.pdl_audio_handle = NULL;
            }


            mmi_medply_single_set_self_stop_flag(MMI_FALSE);
        
            mmi_medply_single_set_continue_flag(MMI_FALSE);
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_AUDIO_IN_HISTORY);
        
            break;
        }
        case SINGLE_STATE_PDL_AUDIO_BT_CONNECTING:
        case SINGLE_STATE_PDL_AUDIO_READY:
        case SINGLE_STATE_PDL_AUDIO_BUFFERING:            
        {
            StopTimer(MEDPLY_PDL_BUFFER_TIMER);

            if(g_single.pdl_audio_handle != NULL)
            {
                mdi_audio_mma_close(g_single.pdl_audio_handle);
                g_single.pdl_audio_handle = NULL;
            }

            mmi_medply_single_set_continue_flag(MMI_FALSE);
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_AUDIO_IN_HISTORY);
            break;
        }
    #endif /*__MMI_AUDIO_PDL__*/

    #ifdef __MMI_VIDEO_PDL__
        case SINGLE_STATE_PDL_VIDEO_OPENING:
        {
            StopTimer(MEDPLY_PDL_BUFFER_TIMER);
            StopTimer(MEDPLY_PDL_CALC_DOWNLOAD_TIMER);
            mdi_video_ply_stop_non_block_seek();
            mdi_video_progressive_close_file();
            mmi_medply_single_set_continue_flag(MMI_FALSE);            
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_IN_HISTORY); 
            break;
        }
        case SINGLE_STATE_PDL_VIDEO_BT_CONNECTING:
        case SINGLE_STATE_PDL_VIDEO_READY:
        case SINGLE_STATE_PDL_VIDEO_PLAY_PROGRESSING:            
        case SINGLE_STATE_PDL_VIDEO_PAUSE_PROGRESSING:
        case SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING:
        case SINGLE_STATE_PDL_VIDEO_PAUSE_BUFFERING:
        {
            StopTimer(MEDPLY_PDL_BUFFER_TIMER);
            StopTimer(MEDPLY_PDL_CALC_DOWNLOAD_TIMER);
            
            /*close video*/
            mdi_video_progressive_close_file();
            mmi_medply_single_set_continue_flag(MMI_FALSE);            
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_IN_HISTORY); 
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_PAUSE_SEEKING:
        case SINGLE_STATE_PDL_VIDEO_PLAY_SEEKING:
        {
            StopTimer(MEDPLY_PDL_CALC_DOWNLOAD_TIMER);            
            mdi_video_ply_stop_non_block_seek();
            mdi_video_progressive_close_file();

            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_IN_HISTORY);             
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_PLAY:
        {
            StopTimer(MEDPLY_PDL_CALC_DOWNLOAD_TIMER);
            mdi_video_ply_stop();
            mdi_video_progressive_close_file();


            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_IN_HISTORY);
            break;
        }
    #endif /*__MMI_VIDEO_PDL__*/

        case SINGLE_STATE_WAIT_NEXT:
        {
            break;
        }

        /*for intro play finish callback*/
        case SINGLE_STATE_IDLE:
        {
        #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
            g_single.wait_next_with_pop_up = MMI_FALSE;
            StopTimer(MEDPLY_SINGLE_WAIT_NEXT_TIMER);
        #endif
            break;
        }

    }

    if(g_medply.fullscreen)
    {
        mmi_medply_main_screen_set_full_screen(MMI_FALSE);
        mmi_medply_main_screen_clear_video_layer();
        g_medply.fullscreen = MMI_FALSE;
    }

#ifdef __MMI_A2DP_SUPPORT__
    mmi_medply_bt_stop(MMI_FALSE);
#endif

    #ifdef MMI_MEDPLY_SINGLE_HIGH_RATE_SAMPLING_PROGRESS_BAR_PERFORMANCE
    mmi_pen_config_sampling_period(MMI_PEN_SAMPLING_PERIOD_1,MMI_PEN_SAMPLING_PERIOD_2);
    #endif

    mmi_medply_main_screen_unprepare();

    WriteValue(NVRAM_MEDIA_PLAYER_SINGLE_VOLUME, &g_single.volume, DS_BYTE, &error);
    WriteValue(NVRAM_MEDIA_PLAYER_SINGLE_MUTE, &g_single.mute, DS_BYTE, &error);

#ifdef __MMI_MEDIA_PLAYER_AUDIO__
#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif
#endif /*__MMI_MEDIA_PLAYER_AUDIO__*/


#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
    StopTimer(MEDPLY_INTRO_PLAY_TIMER);

    if(g_single.intro_play)/*something wrong here, shall not always add entry func*/
    {
        mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);

    }
#endif

#ifdef  __MMI_TOUCH_SCREEN__
    ClearInputEventHandler(MMI_DEVICE_PEN);
#endif

#ifdef __BT_SPK_VOL_CONTROL__
    mdi_audio_bt_clear_volume_sync_callback(APP_MEDPLY_SINGLE);
#endif
    
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_event_proc
 * DESCRIPTION
 *  Single player screen group
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
MMI_RET mmi_medply_single_launch_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (evt->evt_id)
    {
        case EVT_ID_APP_POST_ENTER:
        {
            mmi_medply_single_group_screen_enter();
            mmi_medply_single_enter_main_screen();
            break;
        }
    }
    return MMI_RET_OK;
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_event_proc
 * DESCRIPTION
 *  Single player screen group
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_launch()
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_frm_app_is_launched(APP_MEDPLY_SINGLE) == MMI_TRUE)
    {
        mmi_frm_app_close(APP_MEDPLY_SINGLE);
        /* App close resets continue to play and enter idle
         * so update state will fail to start playback */
        mmi_medply_single_set_continue_flag(MMI_TRUE);
    }
    mmi_frm_app_launch(APP_MEDPLY_SINGLE, 0, 0, mmi_medply_single_launch_proc, NULL, 0);
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_event_proc
 * DESCRIPTION
 *  Single player screen group
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_medply_single_event_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    switch(evt->evt_id)
    {
    case EVT_ID_GROUP_INACTIVE:
        // TODO: May move intro play close screen group in mmi_medply_single_exit_main() to here.
        break;
    case EVT_ID_GROUP_DEINIT:
        break;
    case EVT_ID_SCRN_INACTIVE:
        break;
    default:
        break;
    }
    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_group_screen_enter
 * DESCRIPTION
 *  entry single app screen group and main screen function
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_group_screen_enter(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Enter screen group, the reentry function will be mmi_medply_single_entry_main() */
    mmi_frm_group_create(APP_MEDPLY_SINGLE, GRP_ID_MEDPLY_SINGLE, mmi_medply_single_event_proc, NULL);
    mmi_frm_group_enter(GRP_ID_MEDPLY_SINGLE, MMI_FRM_NODE_SMART_CLOSE_FLAG);

#ifdef __MMI_NCENTER_SUPPORT__
    g_single.ncenter_ghandle = g_medply.ncenter_ghandle;
    mmi_medply_ncenter_clear_app_item();
#endif 
    /*Decide whether add history in exit function*/
    mmi_frm_scrn_enter(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN, mmi_medply_single_exit_main, mmi_medply_single_entry_main, MMI_FRM_UNKNOW_SCRN);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_enter_main_screen
 * DESCRIPTION
 *  entry main screen function
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_enter_main_screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_ENTRY_MAIN, MMI_TRUE);

#ifndef __MMI_MAINLCD_240X400__
    entry_full_screen();
#endif

    /*always suspend sicne other screen upon single player might resume bagckground play*/
    mdi_audio_suspend_background_play();

#ifdef __BT_SPK_VOL_CONTROL__
    mdi_audio_bt_register_volume_sync_callback(APP_MEDPLY_SINGLE,MDI_AUD_VOL_LEVEL_EXTEND_MUTE,mmi_medply_single_handfree_volume_sync_callback);
#endif

#ifdef __MMI_MEDIA_PLAYER_AUDIO__
    //bql: no need to allocate for build cache buffer.
    g_single.audio_cache_file_buf_p = NULL;
    g_single.audio_cache_proc_buf_p = NULL;

    //g_single.audio_cache_file_buf_p = mmi_frm_scrmem_alloc(MEDPLY_BUILD_CACHE_FILE_BUF_SIZE);
    //g_single.audio_cache_proc_buf_p = mmi_frm_scrmem_alloc(MEDPLY_BUILD_CACHE_PROC_BUF_SIZE);
#endif

    #ifdef MMI_MEDPLY_SINGLE_HIGH_RATE_SAMPLING_PROGRESS_BAR_PERFORMANCE
    mmi_pen_config_sampling_period(MMI_PEN_SAMPLING_PERIOD_2,MMI_PEN_SAMPLING_PERIOD_2);
    #endif
    mmi_medply_main_screen_prepare();

    mmi_medply_single_update_main();

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_entry_main
 * DESCRIPTION
 *  entry main screen function
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_entry_main(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_ENTRY_MAIN, MMI_TRUE);

    /*Decide whether add history in exit function*/
    mmi_frm_scrn_enter(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN, mmi_medply_single_exit_main, mmi_medply_single_entry_main, MMI_FRM_UNKNOW_SCRN);

    mmi_medply_single_enter_main_screen();
}


#ifdef __MMI_MEDIA_PLAYER_AUDIO__
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_build_cache_fail_callback_hdlr
 * DESCRIPTION
 *  when build cache fail, set to non seekable
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_build_cache_fail_callback_hdlr(void *inMsg)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_BUILD_CACHE_FAIL, g_single.state, MMI_TRUE);

    g_single.seekable = MMI_FALSE ;
    g_single.build_cache_failed = MMI_TRUE;


    /*there is a case that pen up or key up is faster than build cache fail ind, so state might not always be one of these two states*/
    if(g_single.state == SINGLE_STATE_AUDIO_PAUSE_PROGRESSING || g_single.state == SINGLE_STATE_AUDIO_PLAY_PROGRESSING )
    {

        mdi_audio_stop_build_cache();

        mmi_medply_main_screen_duration_seek_done();
        mmi_medply_single_set_continue_flag(MMI_FALSE);
        mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_READY);
    }

    mmi_popup_display_simple((WCHAR*)GetString(STR_ID_MEDPLY_ERR_BUILD_CACHE_FAIL), MMI_EVENT_FAILURE, GRP_ID_MEDPLY_SINGLE, NULL);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_audio_auto_update_duration_hdlr
 * DESCRIPTION
 *  handle auto update duration
 * PARAMETERS
 *  duration    [IN]
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_auto_update_duration_hdlr(U32 duration)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_AUTO_UPDATE_DUR, duration, g_single.state, MMI_TRUE);

    if(duration == 0)
    {
        return;
    }

    if(g_single.state == SINGLE_STATE_AUDIO_PLAY)
    {
        g_single.duration = duration;
        
        mmi_medply_main_screen_draw_duration();
        mmi_medply_main_screen_blt();        
        g_single.progress_speed = mmi_medply_determine_progress_speed(g_single.duration);
        if(g_single.duration == 0)
        {
            g_single.seekable = MMI_FALSE;
        }
    }
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_build_cache_fail_callback_hdlr
 * DESCRIPTION
 *  when build cache fail, set to non seekable
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_build_cache_update_dur_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 duration;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(g_single.state != SINGLE_STATE_AUDIO_PAUSE_PROGRESSING && g_single.state != SINGLE_STATE_AUDIO_PLAY_PROGRESSING)
    {
        return;
    }

    if (g_single.need_to_build_cache)
    {
        if(mdi_audio_build_cache_get_total_duration(&duration))
        {
            if(g_single.duration != duration)
            {
                g_single.duration = (U64)duration;
                g_single.progress_speed = mmi_medply_determine_progress_speed(g_single.duration);
                if(g_single.duration == 0)
                {
                    g_single.seekable = MMI_FALSE;
                }

                MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL,MMI_TRC_MEDPLY_CTL_UPDATE_DUR_BY_CACHE,duration,MMI_TRUE);
            }
        }
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_check_build_cache
 * DESCRIPTION
 *  return if current audio type need to build cache or not
 * PARAMETERS
 *  void
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
static MMI_BOOL mmi_medply_single_check_build_cache(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_medply_media_format_enum format;
    UI_character_type ext[SRV_FMGR_PATH_MAX_FILE_EXT_LEN + 1];
    MMI_BOOL need_to_build_cache;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    mmi_medply_util_extract_ext(g_single.filefullpath, ext);
    format = (mmi_medply_media_format_enum)mmi_medply_util_is_support_format(ext);

    if(format == MEDPLY_FORMAT_NONE)
    {
        g_single.seekable = MMI_FALSE;
    }


    g_single.is_audio_seekable = MMI_TRUE;

    {
        MMI_BOOL audio_seekable = MMI_TRUE;
        audio_seekable = mdi_audio_is_file_seekable(g_single.filefullpath);
        if(!audio_seekable)
        {
            g_single.is_audio_seekable = MMI_FALSE;
            g_single.seekable = MMI_FALSE;
        }
    }

    need_to_build_cache = (media_file_info_table[format].need_build_cache > 0 ? MMI_TRUE : MMI_FALSE);

    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_SINGLE_CHECK_CACHE, need_to_build_cache);

    return need_to_build_cache;

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_determine_cache_ptr
 * DESCRIPTION
 *  return cache pointer for L1 build cache to use
 * PARAMETERS
 *  void
 * RETURNS
 *  cache_ptr
 *****************************************************************************/
static U8* mmi_medply_single_determine_cache_ptr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(g_single.need_to_build_cache)
    {
        return g_single_audio_cache;
    }
    else
    {
        return NULL;
    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_audio_play_callback_hdlr
 * DESCRIPTION
 *  
 * PARAMETERS
 *  result      [IN]
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_audio_play_callback_hdlr(mdi_result result, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PLAY_CALLBACK, g_single.state, result, MMI_TRUE);


    if(g_single.state != SINGLE_STATE_AUDIO_PLAY)
    {
        return;
    } 

    switch (result)
    {
        case MDI_AUDIO_END_OF_FILE:
        {

        #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
            if(g_single.intro_play)
            {
                mmi_medply_single_play_completed(MMI_FALSE);
                break;
            }
        #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

        if(!g_medply.fullscreen)
        {
            g_single.current_time= g_single.duration;
            mmi_medply_main_screen_draw_duration();
            mmi_medply_main_screen_blt();
        }
        else
        {
            mmi_medply_main_screen_set_full_screen(MMI_FALSE);

            g_medply.fullscreen = MMI_FALSE;

            /*register key hdlr*/
            mmi_medply_register_key_hdlrs(MMI_MEDPLY_SCREEN_NORMAL);
        }

        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif /*__DRM_SUPPORT__*/

            g_single.current_time = 0 ;
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_single_set_continue_flag(MMI_FALSE);
            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_READY);
            break;
        }

        case MDI_AUDIO_TERMINATED:
        {
            if(g_single.self_stop)
            {
                return;
            }
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_single_set_continue_flag(MMI_FALSE);
            mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_READY);

            break;
        }

    #ifdef __DRM_SUPPORT__
        case MDI_AUDIO_DRM_TIMEOUT:
        {
            mmi_medply_set_self_stop_flag(MMI_TRUE);

            mdi_audio_stop_file();

            mmi_medply_set_self_stop_flag(MMI_FALSE);

            g_single.DRM_consumed = MMI_FALSE;

        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_display_popup(result,MMI_FALSE);
            break;
        }
    #endif /* __DRM_SUPPORT__ */


        default:
        {
        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif /*__DRM_SUPPORT__*/

        #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__    
            if(g_single.intro_play)
            {
                mmi_medply_single_set_pop_up_flag();
                mmi_medply_display_popup(result,MMI_FALSE);
                mmi_medply_single_play_completed(MMI_TRUE);
            }
            else
        #endif
            {
                mmi_medply_display_popup(result,MMI_FALSE);
            }
            break;
        }
    }
}


#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_audio_play_popup_callback
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
mmi_ret mmi_medply_single_audio_play_popup_callback(mmi_alert_result_evt_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(evt->evt_id == EVT_ID_ALERT_QUIT)
    {
        switch(evt->result)
        {
            case MMI_ALERT_NORMAL_EXIT:
                mmi_medply_single_pop_up_wait_next_callback();
                break;
            case MMI_ALERT_INTERRUPT_EXIT:
                mmi_medply_single_intro_popup_callback();
                break;
        }
    }
    return MMI_RET_OK;
}
#endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_audio_do_play_action
 * DESCRIPTION
 *  do paly audio main function
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_audio_do_play_action(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mdi_result result;
    U8* cache_ptr = NULL ;
    U8 volume = g_single.volume;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    cache_ptr = mmi_medply_single_determine_cache_ptr();

    /*regisiter auto update time callback*/
    mdi_audio_regisiter_auto_update_duration_handler(mmi_medply_single_auto_update_duration_hdlr);

#ifdef __DRM_SUPPORT__
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_DRM_CONSUMED, g_single.DRM_consumed);
    if (g_single.DRM_consumed)
    {
        mdi_audio_drm_disable_consume_count();            
    }
    else
    {
        g_single.DRM_consumed = MMI_TRUE;
    }
#endif /* __DRM_SUPPORT__ */

    if(g_single.mute)
    {
        volume = 0;
    }

    /* Portion play request */
    result = mdi_audio_play_file_portion_with_vol_path(
               g_single.filefullpath,
               g_single.current_time,
               0,
               DEVICE_AUDIO_PLAY_ONCE,
               cache_ptr,
               mmi_medply_single_audio_play_callback_hdlr,
               NULL,
               MDI_AUD_VOL_EX_MUTE(volume),
               MDI_AUD_PTH_EX(MDI_DEVICE_SPEAKER2));

    if( result == MDI_AUDIO_END_OF_FILE)
    {

    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            mmi_medply_single_play_completed(MMI_FALSE);
            return;
        }
    #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

        if(!g_medply.fullscreen)
        {
            g_single.current_time= g_single.duration;
            mmi_medply_main_screen_draw_duration();
            mmi_medply_main_screen_blt();
        }
        else
        {
            mmi_medply_main_screen_set_full_screen(MMI_FALSE);
            g_medply.fullscreen = MMI_FALSE;
            /*register key hdlr*/
            mmi_medply_register_key_hdlrs(MMI_MEDPLY_SCREEN_NORMAL);
        }

        g_single.current_time = 0 ;
        mmi_medply_single_set_continue_flag(MMI_FALSE);
    #ifdef __MMI_A2DP_SUPPORT__
        mmi_medply_bt_stop(MMI_FALSE);
    #endif

        mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_READY);
        return;
    }


    if(result != MDI_AUDIO_SUCCESS)
    {
    #ifdef __DRM_SUPPORT__    
         g_single.DRM_consumed = MMI_FALSE;
    #endif
    
    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__    
        if(g_single.intro_play)
        {
            mmi_medply_single_set_pop_up_flag();
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_medply_single_play_completed(MMI_TRUE);
            return;
        }
    #endif


    #ifdef __MMI_A2DP_SUPPORT__
        mmi_medply_bt_stop(MMI_FALSE);
    #endif

        mmi_medply_display_popup(result,MMI_FALSE);
    }
    else
    {
        mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_PLAY);
    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_audio_play
 * DESCRIPTION
 *  paly audio main function
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_audio_play(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    FS_HANDLE handle;
#ifdef __DRM_SUPPORT__
    MMI_BOOL DRM_with_rights = MMI_TRUE;   
#endif
#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
    mmi_popup_property_struct popup_args;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    handle = DRM_open_file((PU16)g_single.filefullpath, FS_READ_ONLY, DRM_PERMISSION_PLAY);

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_SINGLE_AUD_PLAY, g_single.mute, g_single.current_time, handle);

    if (handle >= FS_NO_ERROR)
    {
    #ifdef __DRM_SUPPORT__
        if(!DRM_validate_permission(handle, NULL, DRM_PERMISSION_PLAY))
        {   
            DRM_with_rights = MMI_FALSE;
        }        
    #endif
        DRM_close_file(handle);
    }
    else
    {
        mmi_event_notify_enum result_type ;
        MMI_ID_TYPE fs_string;

        fs_string = srv_fmgr_fs_error_get_string_and_popup_type(handle,(S32*)&result_type);

    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            mmi_medply_single_set_pop_up_flag();

            mmi_popup_property_init(&popup_args);
            popup_args.parent_id = GRP_ID_MEDPLY_SINGLE;
            popup_args.callback = mmi_medply_single_audio_play_popup_callback;

            mmi_popup_display((WCHAR*)GetString(fs_string), result_type, &popup_args);

            mmi_medply_single_play_completed(MMI_TRUE);
            return;            
        }
    #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

        mmi_popup_display_simple((WCHAR*) GetString(fs_string), result_type, GRP_ID_MEDPLY_SINGLE, NULL);
        if(mmi_frm_scrn_is_present(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
        {
            mmi_frm_scrn_close(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN);
        }
        return;
    }

    if(g_single.duration == 0)
    {
        if (mdi_audio_get_duration(g_single.filefullpath, (U32*)&(g_single.duration)) != MDI_AUDIO_SUCCESS)
        {
            g_single.duration = 0 ;
        }

        g_single.progress_speed = mmi_medply_determine_progress_speed(g_single.duration);

        g_single.seekable = MMI_TRUE;

        if(g_single.duration == 0)
        {
            g_single.seekable = MMI_FALSE;
        }
        else
        {
            UI_character_type ext[SRV_FMGR_PATH_MAX_FILE_EXT_LEN + 1];
            mmi_medply_media_format_enum format;

            mmi_medply_util_extract_ext(g_single.filefullpath, ext);

            format = (mmi_medply_media_format_enum)mmi_medply_util_is_support_format(ext);

            if(format == MEDPLY_FORMAT_NONE || g_single.is_audio_seekable == MMI_FALSE)
            {
                g_single.seekable = MMI_FALSE;
            }
        }
    }

    #ifdef __DRM_SUPPORT__
    if(!DRM_with_rights)
    {
        g_single.seekable = MMI_FALSE;
    }
    #endif

#ifdef __MMI_A2DP_SUPPORT__
    if( mmi_medply_settings_is_output_to_bt() )
    { 
        mmi_medply_enter_single_states(SINGLE_STATE_AUDIO_BT_CONNECTING);

        av_bt_open(mmi_medply_settings_get_bt_headset(), g_single.filefullpath,
            mmi_medply_single_bt_open_callback, KAL_TRUE,KAL_TRUE);
        return;
    }
    else
#endif /* __MMI_A2DP_SUPPORT__ */
    {
        mmi_medply_single_audio_do_play_action();
    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_play_audio
 * DESCRIPTION
 *  entery function of media single player main screen for audio file
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_play_audio(UI_string_type filefullname, void (*exit_callback_func)(void))
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    mmi_medply_single_play_audio_with_title(filefullname, exit_callback_func, NULL);

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_play_audio
 * DESCRIPTION
 *  entery function of media single player main screen for audio file
 *  and also defines the title
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_play_audio_with_title(UI_string_type filefullname, void (*exit_callback_func)(void), UI_string_type title)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

#ifndef __RF_DESENSE_TEST__
    if (srv_ucm_query_call_count(SRV_UCM_INCOMING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0 ||
        srv_ucm_query_call_count(SRV_UCM_OUTGOING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0 ||
        srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_NO_CSD, NULL) > 0)
    {
        mmi_ucm_app_entry_error_message();
        return; 
    }
#endif

#ifdef __DM_LAWMO_SUPPORT__
    if(mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_PARTIALLYLOCK || mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_ON_LOCKING)
    {
        MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_LAWMO_LOCK);
        return;
    }
#endif

    //mmi_medply_single_group_screen_enter();
    //Put a dummy group here, keep the old behavior
    mmi_frm_group_create_ex(GRP_ID_ROOT, GRP_ID_AUTO_GEN, NULL, NULL,  MMI_FRM_NODE_SMART_CLOSE_FLAG);

#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
    g_single.intro_play = MMI_FALSE;
#endif

    g_single.media_type = MEDPLY_TYPE_AUDIO;
    g_single.continue_to_play = MMI_TRUE;
    g_single.seekable = MMI_TRUE;
    g_single.build_cache_failed = MMI_FALSE;
    g_single.current_time = 0;
    g_single.is_short = MMI_FALSE;
    g_single.audio_exit_callback_func = exit_callback_func;
#ifdef __DRM_SUPPORT__
    g_single.DRM_consumed = MMI_FALSE;
#endif /*__DRM_SUPPORT__*/

    mmi_ucs2cpy((CHAR*)g_single.filefullpath, (CHAR*)filefullname);

    memset(g_single.specified_title, 0, sizeof(g_single.specified_title));
    if(title != NULL)
    {
        mmi_ucs2cpy((CHAR*)g_single.specified_title, (CHAR*)title);
    }

    if(mdi_audio_get_duration(g_single.filefullpath, (U32*)(&g_single.duration)) != MDI_AUDIO_SUCCESS)
    {
        g_single.duration = 0 ;
    }

    g_single.progress_speed = mmi_medply_determine_progress_speed(g_single.duration);

    if(g_single.duration == 0)
    {
        g_single.seekable = MMI_FALSE;
    }

    /*check and reset build cache related contexts*/
    g_single.need_to_build_cache = mmi_medply_single_check_build_cache();
    mdi_audio_close_build_cache();
    mdi_audio_reset_build_cache_variables();
    memset( g_single_audio_cache, 0, MEDPLY_BUILD_CACHE_SIZE ); 
    g_single.audio_build_cache_process = 0 ;
    g_single.audio_cached_duration = 0 ;

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_SINGLE_PLAY_AUD, g_single.duration, g_single.seekable);

    //mmi_medply_single_enter_main_screen();
    //use launch to cover OOM problem;
    mmi_medply_single_launch();
}

#endif /* __MMI_MEDIA_PLAYER_AUDIO__ */

#ifdef __MMI_MEDIA_PLAYER_VIDEO__

#ifdef __MMI_VIDEO_3D_ANAGLYPH__
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_check_and_set_play_mode
 * DESCRIPTION
 *  
 * PARAMETERS
 * 
 * RETURNS
 *  S16
 *****************************************************************************/
static void mmi_medply_single_check_and_set_play_mode(mdi_video_info_struct *vdo_clip)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 play_mode = 0;
	U32 i;
    U32 index_2d = 0, index_3d = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_VDO_CHECK_AND_SET_TRACK,g_single.has_2d_mode, g_single.has_3d_mode);
    for( i = 0; i < vdo_clip->track_num; i++)
    {
        if(g_single.has_3d_mode == MMI_FALSE && MDI_VIDEO_TRACK_3D == vdo_clip->track_info[i].track_type)
        {
            g_single.has_3d_mode = MMI_TRUE;
            index_3d = vdo_clip->track_info[i].track_index;
        }
        else if(g_single.has_2d_mode == MMI_FALSE && MDI_VIDEO_TRACK_2D_NORMAL == vdo_clip->track_info[i].track_type)
        {
            g_single.has_2d_mode = MMI_TRUE;
            index_2d = vdo_clip->track_info[i].track_index;
        }     
    }  

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_VDO_CHECK_AND_SET_TRACK,g_single.has_2d_mode, g_single.has_3d_mode);
    
    if(g_single.has_3d_mode && g_single.has_2d_mode)
    {
        mmi_medply_settings_read_value(MMI_MEDPLY_SETTINGS_PLAY_MODE,(void*)&play_mode);
        if(play_mode == MDI_VIDEO_TRACK_3D)
        {
            mdi_video_ply_set_track_index(index_3d);
        }
        else if(play_mode == MDI_VIDEO_TRACK_2D_NORMAL)
        {
           mdi_video_ply_set_track_index(index_2d);
        }
    }
    else if(g_single.has_3d_mode)
    {
        mdi_video_ply_set_track_index(index_3d);
    }
    else if(g_single.has_2d_mode)
    {
        mdi_video_ply_set_track_index(index_2d);
    }
    
    
}
#endif

#ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_check_and_set_play_mode
 * DESCRIPTION
 *  
 * PARAMETERS
 * 
 * RETURNS
 *  S16
 *****************************************************************************/
static void mmi_medply_single_check_and_set_subtitle(mdi_video_info_struct *vdo_clip)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 i;
    U32 settings_iso;
    U8* subtitle_lcc;
    U8* phone_lcc;
    MMI_BOOL result;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_VDO_CHECK_AND_SET_SUBTITLE_TRACK,vdo_clip->subtitle_num);
    if(g_single.track == MDI_VIDEO_TRACK_A_ONLY || vdo_clip->subtitle_num<=0)
    {
         g_single.has_subtitle = MMI_FALSE;
         return;
    }
    
    g_single.has_subtitle = MMI_TRUE;

    result = mmi_medply_settings_read_value(MMI_MEDPLY_SETTINGS_SUBTITLE_LCC, &settings_iso);

    for( i = 0; i < vdo_clip->subtitle_num; i++)
    {
        if(result == MMI_TRUE)
        {
            if(vdo_clip->subtitle_info[i].language == settings_iso)
            {
                mdi_video_ply_set_subtitle_track_index(vdo_clip->subtitle_info[i].track_index);
                break;
            }
        }
        else
        {
            mmi_li_Get_Current_LCC(&phone_lcc);
            mmi_li_get_lcc(vdo_clip->subtitle_info[i].language, &subtitle_lcc);
            if(phone_lcc == subtitle_lcc)
            {
                mdi_video_ply_set_subtitle_track_index(vdo_clip->subtitle_info[i].track_index);
                break;
            }
        }
    }

    mdi_video_ply_set_subtitle_font_size(g_medply.subtitle_font_size);
}
#endif


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_video_play_callback_hdlr
 * DESCRIPTION
 *  video play callback handler
 * PARAMETERS
 *  result      [IN]        >=0, means successfully finished, 
 *                          if result < 0 measn some error happened
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_video_play_callback_hdlr(MDI_RESULT result, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_medply_video_play_para_struct video_layer_info;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* if not in player screen */
    /* 
     * this may happend when video has error and driver send out this message, 
     * but before MMI receive this message, MMI stop and play the video again, 
     * that will cause driver to send another play finish message. When MMI 
     * receive first message, it will exit and display popup, when the second 
     * message comes, MMI already exit video play app. so we shall igore this 
     * message.
     */

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_VDO_PLAY_CALLBACK, result, MMI_TRUE, MMI_TRUE);
     
    if(g_single.state != SINGLE_STATE_VIDEO_PLAY)
    {
        return;
    }

    /* new mdi error code , following error code should be ignore */
    if(result == MDI_RES_VDOPLY_ONLY_VIDEO_TRACK_ERROR || result == MDI_RES_VDOPLY_ONLY_AUDIO_TRACK_ERROR)
    {
        return;
    }

    /* error happened */
    if (result < 0 )
    {
    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__    
        if(g_single.intro_play)
        {
            mmi_medply_single_video_close();
            mmi_medply_single_set_pop_up_flag();
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_medply_single_play_completed(MMI_TRUE);
            return;
        }
    #endif
    #ifdef __MMI_A2DP_SUPPORT__
        mmi_medply_bt_stop(MMI_FALSE);
    #endif

        mmi_medply_display_popup(result,MMI_FALSE);

        if(result == MDI_RES_VDOPLY_ERR_DRM_PROHIBITED || result == MDI_RES_VDOPLY_ERR_DRM_DURATION_USED)
        {
            mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
        }

        return;
    }

    /*when play finish, seek to the fornt of the video*/
#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__    
    if(g_single.intro_play)
    {
        mmi_medply_single_video_close();
        mmi_medply_single_play_completed(MMI_FALSE);
        return;
    }
#endif    

    #ifdef __MMI_A2DP_SUPPORT__
        mmi_medply_bt_stop(MMI_FALSE);
    #endif

    if(!g_medply.fullscreen)
    {
        g_single.current_time = g_single.duration;
        mmi_medply_main_screen_draw_duration();
        mmi_medply_main_screen_blt();
    }
    else
    {
        mmi_medply_main_screen_set_full_screen(MMI_FALSE);
        mmi_medply_main_screen_clear_video_layer();

        g_medply.fullscreen = MMI_FALSE;

        /*register key hdlr*/
        mmi_medply_register_key_hdlrs(MMI_MEDPLY_SCREEN_NORMAL);
    }

    g_single.current_time = 0;

#ifdef __DRM_SUPPORT__
    g_single.DRM_consumed = MMI_FALSE;
#endif /*__DRM_SUPPORT__*/

    video_layer_info.video_height = g_single.height;
    video_layer_info.video_width = g_single.width;
    mmi_medply_main_screen_get_video_parameter(&video_layer_info);

    result = mmi_medply_adption_video_seek_and_get_frame(
              g_single.current_time,
              video_layer_info.layer_hdl
                        #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                        ,video_layer_info.layer_subtitle_hdl
                        #endif
              );

    if(result < 0)
    {
        mmi_medply_display_popup(result,MMI_FALSE);
        mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
        return;
    }

    mmi_medply_main_screen_blt();
    mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_READY);


}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_video_seek_callback_hdlr
 * DESCRIPTION
 *  seek result
 * PARAMETERS
 *  result      [IN]        Seek result
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_video_seek_callback_hdlr(MDI_RESULT result, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_VDO_SEEK_CALLBACK, result, g_single.state, MMI_TRUE);

    /* error happened */
    if (result < 0 && result != MDI_RES_VDOPLY_ERR_GET_FRAME_FAILED)
    {
    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            mmi_medply_single_video_close();
            mmi_medply_single_set_pop_up_flag();
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_medply_single_play_completed(MMI_TRUE);
            return;
        }
    #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

        mmi_medply_display_popup(result,MMI_FALSE);
        mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
        return;
    }

    if(g_medply.fullscreen && g_single.state==SINGLE_STATE_VIDEO_PAUSE_SEEKING)
    {
        g_single.state = SINGLE_STATE_VIDEO_PLAY_SEEKING ;
    }

    /* seek partial done, so need to reassign current time to seek time */
    if (result == MDI_RES_VDOPLY_SEEK_PARTIAL_DONE)
    {
        /* get current play time */
        mdi_video_ply_get_cur_play_time(&g_single.current_time);
    }

    mmi_medply_main_screen_video_updated();
    mmi_medply_main_screen_blt();

    mmi_medply_main_screen_stop_animation(MMI_MEDPLY_ANI_VIDEO_OPENING);

    /* enter next state */
    switch (g_single.state)
    {
        case SINGLE_STATE_VIDEO_PLAY_SEEKING:
        {
            mmi_medply_single_set_continue_flag(MMI_TRUE);
            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_READY);
            break;
        }

        case SINGLE_STATE_VIDEO_PAUSE_SEEKING:
        {
            mmi_medply_single_set_continue_flag(MMI_FALSE);
            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_READY);
            break;
        }

        case SINGLE_STATE_VIDEO_OPENING:
        {
            mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_READY);
            break;
        }

    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_video_open_callback_hdlr
 * DESCRIPTION
 *  to handle open callback, continue to do seek action if open success
 * PARAMETERS
 *  result          [IN]        >=0, means successfully opened, if result < 0 measn some error happened)
 *  vdo_clip        [IN]        Video info
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_video_open_callback_hdlr(MDI_RESULT result, mdi_video_info_struct *vdo_clip, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_medply_video_play_para_struct video_layer_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_VDO_OPEN_CALLBACK_1,result, MMI_TRUE);

    if (result >= 0)
    {
        /* open sucess */
        U16 brightness, contrast;
        mmi_medply_settings_read_value(MMI_MEDPLY_SETTINGS_BRIGHTNESS,(void*)&brightness);
        mmi_medply_settings_read_value(MMI_MEDPLY_SETTINGS_CONTRAST,(void*)&contrast);  

        /* set brightness/contrast */
        mdi_video_ply_set_brightness(brightness);
        mdi_video_ply_set_contrast(contrast);

        /* fit it into player window */
        g_single.width = vdo_clip->width;
        g_single.height = vdo_clip->height;

        if(g_single.duration != vdo_clip->total_time_duration)
        {
            g_single.duration = vdo_clip->total_time_duration;
        }
        g_single.progress_speed = mmi_medply_determine_progress_speed(g_single.duration);        
        g_single.seekable = vdo_clip->is_seekable;
    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            g_single.seekable = MMI_FALSE;
        }
    #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/        
        g_single.track = vdo_clip->track;
        g_single.aud_channel_no = vdo_clip->aud_channel_no;        
        g_single.aud_sample_rate= vdo_clip->aud_sample_rate;

        /* this avoid driver return total time druation == 0, which will cause divid by zero */
        if (g_single.duration == 0)
        {
            g_single.seekable = MMI_FALSE;
        }

        MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_VDO_OPEN_CALLBACK_2, g_single.duration, g_single.seekable,g_single.track, MMI_TRUE);

        if(g_single.track == MDI_VIDEO_TRACK_A_ONLY)
        {
            g_single.height = 0;
            g_single.width = 0;
        }

       #ifdef __MMI_VIDEO_3D_ANAGLYPH__
       mmi_medply_single_check_and_set_play_mode(vdo_clip);
       #endif
       
        #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
       mmi_medply_single_check_and_set_subtitle(vdo_clip);
       #endif

        video_layer_info.video_height = g_single.height;
        video_layer_info.video_width = g_single.width;
        mmi_medply_main_screen_get_video_parameter(&video_layer_info);

        /* since we might have to seek to far away from begining, so we use non_block seek*/
        result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                g_single.current_time,
                video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                mmi_medply_single_video_seek_callback_hdlr,
                0);

        if(result >= 0)
        {
            return;
        }

    }

#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
    if(g_single.intro_play)
    {
        mmi_medply_single_set_pop_up_flag();
        mmi_medply_display_popup(result,MMI_FALSE);
        mmi_medply_single_play_completed(MMI_TRUE);
        return;
    }

#endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

    mmi_medply_display_popup(result,MMI_FALSE);
    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);

    return;

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_video_pause
 * DESCRIPTION
 *  pause video fucntion, actually it stops video file but not reset time
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_video_pause(void)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MDI_RESULT result;
    mmi_medply_video_play_para_struct video_layer_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_VDO_PAUSE,g_single.state, MMI_TRUE);

    /*stop video*/
    result = mdi_video_ply_stop();

#ifdef __MMI_A2DP_SUPPORT__
    mmi_medply_bt_stop(MMI_FALSE);
#endif

    if(result == MDI_RES_VDOPLY_ALREADY_FINISHED)
    {
        /*
        * Due to video wouldn't seek to end by itself
        * so app need do seek when video already finished
        */
        g_single.current_time = 0;
    #ifdef __DRM_SUPPORT__
        g_single.DRM_consumed = MMI_FALSE;
    #endif
        video_layer_info.video_height = g_single.height;
        video_layer_info.video_width = g_single.width;
        mmi_medply_main_screen_get_video_parameter(&video_layer_info);

        result = mmi_medply_adption_video_seek_and_get_frame(
                   g_single.current_time,
                    video_layer_info.layer_hdl
                        #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                        ,video_layer_info.layer_subtitle_hdl
                        #endif
                    );
    
        if(result < 0)
        {
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
            return;
        }
    }
    else
    {
        /* set current time to lastest */
        mdi_video_ply_get_cur_play_time(&g_single.current_time);
        if(g_single.current_time > g_single.duration)
        {
            g_single.duration = g_single.current_time;
        }
    }

    mmi_medply_single_set_continue_flag(MMI_FALSE);
    mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_READY);

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_video_do_play_action
 * DESCRIPTION
 *  do paly video main function
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_video_do_play_action(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MDI_RESULT result;
    mmi_medply_video_play_para_struct video_layer_info;
    U8 volume = g_single.volume;
    BOOL is_play_audio = TRUE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_SINGLE_VDO_PLAY,g_single.mute);

#ifdef __DRM_SUPPORT__
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_DRM_CONSUMED, g_single.DRM_consumed);
    if (g_single.DRM_consumed)
    {
        mdi_video_ply_drm_disable_consume_count();
    }
    else
    {
        g_single.DRM_consumed = MMI_TRUE;
    }
#endif /* __DRM_SUPPORT__ */

    if(g_single.mute)
    {
        volume = 0;
    }

    mdi_audio_set_volume(MDI_VOLUME_MEDIA, MDI_AUD_VOL_EX_MUTE(volume));

    video_layer_info.video_height = g_single.height;
    video_layer_info.video_width = g_single.width;
    mmi_medply_main_screen_get_video_parameter(&video_layer_info);

    /*turn on backlight to make sure video will not play in LCD turn off situation*/
    srv_backlight_turn_on(SRV_BACKLIGHT_SHORT_TIME);

#if defined(__RF_DESENSE_TEST__) && defined(__MMI_BACKGROUND_CALL__)
    if (srv_ucm_is_background_call())
    {
        is_play_audio = FALSE;
    }
#endif /* defined(__RF_DESENSE_TEST__) && defined(__MMI_BACKGROUND_CALL__) */


    result = mmi_medply_adption_video_play(
            video_layer_info.layer_hdl,                  /* play layer handle */
            video_layer_info.layer_blt_flag,             /* blt layer flag */
            video_layer_info.layer_play_flag,            /* play layer flag */
            #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
            video_layer_info.layer_subtitle_hdl,         /* subtitle layer handle */
            video_layer_info.layer_subtitle_flag,        /* subtitle layer flag */
            #endif
            1,                                           /* repeat */
            TRUE,                                        /* visual update */
            is_play_audio,                               /* play aud */
            MDI_DEVICE_SPEAKER2,                         /* audio path */
            video_layer_info.layer_lcd_rotate,           /* rotate */
            100,                                         /* speed factor */
            mmi_medply_single_video_play_callback_hdlr,
            0); /* play layer */

    if(result >= 0)
    {
        mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_PLAY);
        return;
    }
    else
    {
    #ifdef __DRM_SUPPORT__    
         g_single.DRM_consumed = MMI_FALSE;
    #endif

    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            mmi_medply_single_video_close();
            mmi_medply_single_set_pop_up_flag();
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_medply_single_play_completed(MMI_TRUE);
            return;
        }
    #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

    #ifdef __MMI_A2DP_SUPPORT__
        mmi_medply_bt_stop(MMI_FALSE);
    #endif

        mmi_medply_display_popup(result,MMI_FALSE);

        if(result == MDI_RES_VDOPLY_ERR_DRM_PROHIBITED || result == MDI_RES_VDOPLY_ERR_DRM_DURATION_USED)
        {
            mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
        }
    
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_video_play
 * DESCRIPTION
 *  paly video main function
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_video_play(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

#ifdef __MMI_A2DP_SUPPORT__
    if( mmi_medply_settings_is_output_to_bt())
    {
        MMI_BOOL is_stereo;   
        
        if (g_single.aud_channel_no == 2)
        {
            is_stereo = MMI_TRUE;
        }
        else
        {
            is_stereo = MMI_FALSE;
        }
        
        switch(g_single.state)
        {
            case SINGLE_STATE_VIDEO_PLAY_SEEKING:
            case SINGLE_STATE_VIDEO_READY:
            case SINGLE_STATE_VIDEO_PAUSE_SEEKING: /*for full screen case*/
            {
                if(g_single.track != MDI_VIDEO_TRACK_V_ONLY)
                {
                    mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_BT_CONNECTING);

                    /*put this behind enter states because some times it will callback directly with in 
                    this function, in that case, entering bt connecting state would be too late*/        
                    av_bt_open_ex(
                          mmi_medply_settings_get_bt_headset(),
                          g_single.aud_sample_rate,
                         (kal_bool)is_stereo,
                         mmi_medply_single_bt_open_callback,
                         KAL_TRUE);
                }
                else
                {
                    mmi_medply_single_video_do_play_action();
                    return;
                }
                break;
            }

            default:
                break;
        }

    }
    else
#endif /* __MMI_A2DP_SUPPORT__ */
    {
        switch(g_single.state)
        {
            case SINGLE_STATE_VIDEO_PLAY_SEEKING:
            case SINGLE_STATE_VIDEO_READY:
            case SINGLE_STATE_VIDEO_PAUSE_SEEKING: /*for full screen case*/
            {        
                mmi_medply_single_video_do_play_action();
                break;
            }

            default:
                break;
        }
    }

    return;

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_video_open
 * DESCRIPTION
 *  open video file
 * PARAMETERS
 *  void
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
MMI_BOOL mmi_medply_single_video_open(void)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MDI_RESULT result;
    FS_HANDLE handle;
#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
    mmi_popup_property_struct popup_args;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    handle = DRM_open_file((PU16)g_single.filefullpath, FS_READ_ONLY, DRM_PERMISSION_PLAY);

    if (handle >= FS_NO_ERROR)
    {
        DRM_close_file(handle);
    }
    else
    {
        mmi_event_notify_enum result_type ;
        MMI_ID_TYPE fs_string;

        fs_string = srv_fmgr_fs_error_get_string_and_popup_type(handle,(S32*)&result_type);

    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            mmi_medply_single_set_pop_up_flag();

            mmi_popup_property_init(&popup_args);
            popup_args.parent_id = GRP_ID_MEDPLY_SINGLE;
            popup_args.callback = mmi_medply_single_audio_play_popup_callback;

            mmi_popup_display((WCHAR*)GetString(fs_string), result_type, &popup_args);

            mmi_medply_single_play_completed(MMI_TRUE);
            return MMI_FALSE;            
        }
    #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/
        mmi_popup_display_simple((WCHAR*) GetString(fs_string), result_type, GRP_ID_MEDPLY_SINGLE, NULL);

        if(mmi_frm_scrn_is_present(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
        {
            mmi_frm_scrn_close(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN);
        }

        return MMI_FALSE;
    }

#ifdef __DRM_SUPPORT__
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_DRM_CONSUMED, g_single.DRM_consumed);
    if (g_single.DRM_consumed)
    {
        mdi_video_ply_drm_disable_consume_count();            
    }
#endif /* __DRM_SUPPORT__ */

    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
    mdi_video_ply_set_scenario_type(MDI_VIDEO_SCENARIO_DEFAULT_N_SUBTITLE);
    #endif

    result = mdi_video_ply_open_file(GRP_ID_MEDPLY_SINGLE, (CHAR*)g_single.filefullpath, mmi_medply_single_video_open_callback_hdlr, 0);

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_VDO_OPEN, result, g_single.continue_to_play, MMI_TRUE);

    if(result<0)
    {
        /*error happened*/
    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            mmi_medply_single_set_pop_up_flag();
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_medply_single_play_completed(MMI_TRUE);
            return MMI_FALSE;
        }
    #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

        mmi_medply_display_popup(result,MMI_FALSE);
        mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);

        return MMI_FALSE;
    }
    else
    {
        mmi_medply_enter_single_states(SINGLE_STATE_VIDEO_OPENING);
    }
    return MMI_TRUE;

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_video_close
 * DESCRIPTION
 *  close video file fucntion
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_video_close(void)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mdi_video_ply_close_file();
    #ifdef __MMI_VIDEO_3D_ANAGLYPH__
    g_single.has_2d_mode = MMI_FALSE;
    g_single.has_3d_mode = MMI_FALSE;
    #endif
    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
    g_single.has_subtitle = MMI_FALSE;
    #endif
}



/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_play_video
 * DESCRIPTION
 *  entery function of media single player main screen for video file
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_play_video(UI_string_type filefullname, MMI_BOOL is_short)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_SINGLE_PLAY_VDO);

    mmi_medply_single_play_video_with_title(filefullname, is_short, NULL);
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_play_video
 * DESCRIPTION
 *  entery function of media single player main screen for video file
 *  and also defines the title
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_play_video_with_title(UI_string_type filefullname, MMI_BOOL is_short, UI_string_type title)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_SINGLE_PLAY_VDO);

#ifndef __RF_DESENSE_TEST__
    if (srv_ucm_query_call_count(SRV_UCM_INCOMING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0 ||
        srv_ucm_query_call_count(SRV_UCM_OUTGOING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0 ||
        srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_NO_CSD, NULL) > 0)
    {
        mmi_medply_display_popup_with_sg(STR_GLOBAL_CURRENTLY_NOT_AVAILABLE_IN_CALL, MMI_EVENT_FAILURE);
        return; 
    }
#endif

#ifdef __DM_LAWMO_SUPPORT__
    if(mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_PARTIALLYLOCK || mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_ON_LOCKING)
    {
        MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_LAWMO_LOCK);
        return;
    }
#endif

    //mmi_medply_single_group_screen_enter();
    //Put a dummy group here, keep the old behavior
    mmi_frm_group_create_ex(GRP_ID_ROOT, GRP_ID_AUTO_GEN, NULL, NULL,  MMI_FRM_NODE_SMART_CLOSE_FLAG);

#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
    g_single.intro_play = MMI_FALSE;
#endif
    g_single.media_type = MEDPLY_TYPE_VIDEO;
    g_single.continue_to_play = MMI_TRUE;
    g_single.seekable = MMI_TRUE;
    g_single.build_cache_failed = MMI_FALSE;
    g_single.current_time = 0;

    g_single.is_short = is_short;
#ifdef __DRM_SUPPORT__
    g_single.DRM_consumed = MMI_FALSE;
#endif /*__DRM_SUPPORT__*/


    g_single.need_to_build_cache = MMI_FALSE;

    mmi_ucs2cpy((CHAR*)g_single.filefullpath, (CHAR*)filefullname);

    memset(g_single.specified_title, 0, sizeof(g_single.specified_title));

    if(title != NULL)
    {
        mmi_ucs2cpy((CHAR*)g_single.specified_title, (CHAR*)title);
    }

    if (mdi_audio_get_mp4_duration(g_single.filefullpath, (U32*)(&g_single.duration)) != MDI_AUDIO_SUCCESS)
    {
        g_single.duration = 0;
    }

    //mmi_medply_single_enter_main_screen();
    //use launch to cover OOM problem;
    mmi_medply_single_launch();
}

#endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

#ifdef __MMI_MEDIA_PLAYER_STREAM__

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_stream_connect_callback_hdlr
 * DESCRIPTION
 *  callback handler of stream connecting
 * PARAMETERS
 *  result          [IN]        >=0, means successfully opened, if result < 0 measn some error happened)
 *  stream_info     [IN]        stream info
 * RETURNS
 * BOOL
 *****************************************************************************/
static void mmi_medply_single_stream_connect_callback_hdlr(MDI_RESULT result, mdi_video_info_struct *stream_info, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 str_len;
    S32 i;
    MMI_BOOL is_valid;
 
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_STREAM_CONNECT_CALLBACK_1,result, g_single.state, MMI_TRUE);

    if (result == MDI_RES_VDOPLY_ERR_NETWORK_DISCONNECT)
    {
    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            mmi_medply_single_stream_deinit();        
            mmi_medply_single_set_pop_up_flag();
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_medply_single_play_completed(MMI_TRUE);
            return;
        }
    #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

        mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
        mmi_medply_display_popup(result,MMI_FALSE);
        return;
    }
    else if (result == MDI_RES_VDOPLY_ERR_NETWORK_FORBIDDEN)
    { 
    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            mmi_medply_single_stream_deinit();        
            mmi_medply_single_set_pop_up_flag();
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_medply_single_play_completed(MMI_TRUE);
            return;
        }
    #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

        mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
        mmi_medply_display_popup(result,MMI_FALSE);
        return;
    }
    else if (result == MDI_RES_VDOPLY_STREAM_DRM_NEED_RIGHT)
    {
        /* no permission - shall disconnect and show popup */
        mdi_video_stream_disconnect();
    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            mmi_medply_single_stream_deinit();        
            mmi_medply_single_set_pop_up_flag();
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_medply_single_play_completed(MMI_TRUE);
            return;
        }
    #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

        mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
        mmi_medply_display_popup(result,MMI_FALSE);
        return;
    }

    if (result >= 0)
    {
        mmi_medply_main_screen_stop_animation(MMI_MEDPLY_ANI_RTP_CONNECTING);
    
        g_single.duration = stream_info->total_time_duration;
        g_single.progress_speed = mmi_medply_determine_progress_speed(g_single.duration);        
        g_single.seekable = stream_info->is_seekable;

        if(g_single.current_time > g_single.duration)
        {
            g_single.current_time = g_single.duration ;
        }

    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            g_single.seekable = MMI_FALSE;
        }
    #endif
        g_single.track = stream_info->track;
        g_single.aud_channel_no = stream_info->aud_channel_no;
        g_single.aud_sample_rate = stream_info->aud_sample_rate;

        str_len = strlen((CHAR*)stream_info->title_desc);

        MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_STREAM_CONNECT_CALLBACK_2,g_single.duration, g_single.seekable, g_single.track, str_len, MMI_TRUE);

        /* stream has title, change title name to this 
           when steram title is null, use file_title*/
        if (str_len != 0)
        {
            /* check if title is all space */
            is_valid = MMI_FALSE;
            for (i = 0; i < str_len; i++)
            {
                if (stream_info->title_desc[i] != ' ')
                {
                    is_valid = MMI_TRUE;
                    break;
                }
            }

            if (is_valid)
            {
                /*reset it again since it might be overwritten by play sdp with title*/
                memset(g_single.specified_title, 0, sizeof(g_single.specified_title)); 

                mmi_asc_n_to_ucs2(
                    (CHAR*)g_single.specified_title,
                    (CHAR*)&stream_info->title_desc, 
                    MDI_VIDEO_INFO_TITLE_CHAR_COUNT - 1);
            }
        }

        if (g_single.media_type == MEDPLY_TYPE_STREAM_RAM)
        {
            mmi_medply_history_insert_url((CHAR*)g_single.url_path, (CHAR*)g_single.specified_title, MMI_TRUE);
        }
        else
        {
            mmi_medply_history_insert_url((CHAR*)g_single.filefullpath, (CHAR*)g_single.specified_title, MMI_TRUE);
        }

        mmi_medply_main_screen_update_title();
        mmi_medply_single_set_continue_flag(MMI_TRUE);
        mmi_medply_enter_single_states(SINGLE_STATE_STREAM_CONNECTED);
    
    }
    else
    {
    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            mmi_medply_single_stream_deinit();        
            mmi_medply_single_set_pop_up_flag();
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_medply_single_play_completed(MMI_TRUE);
            return;
        }
    #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/    

        mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
        mmi_medply_display_popup(result,MMI_FALSE);
    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_stream_single_buffering_callback_hdlr
 * DESCRIPTION
 *  callback handler of stream buffering
 * PARAMETERS
 *  result          [IN]        >=0, means successfully opened, if result < 0 measn some error happened)
 *  stream_info     [IN]        stream info
 * RETURNS
 * BOOL
 *****************************************************************************/
static void mmi_medply_single_stream_buffering_callback_hdlr(MDI_RESULT result, mdi_video_info_struct *stream_info, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_STREAM_BUF_CALLBACK,result,MMI_TRUE);

    StopTimer(MEDPLY_STREAM_BUFFER_TIMER);

    /*open sucessfully */
    if (result >= 0)
    {
        U16 brightness, contrast;

        /* redraw progress bar to 100%*/
        mmi_medply_main_screen_show_loading(100);

        mmi_medply_main_screen_stop_animation(MMI_MEDPLY_ANI_LOADING);

        mmi_medply_settings_read_value(MMI_MEDPLY_SETTINGS_BRIGHTNESS,(void*)&brightness);
        mmi_medply_settings_read_value(MMI_MEDPLY_SETTINGS_CONTRAST,(void*)&contrast);    
    
        mdi_video_stream_set_brightness(brightness);
        mdi_video_stream_set_contrast(contrast);

        g_single.width = stream_info->width;
        g_single.height = stream_info->height;

        if(g_single.track == MDI_VIDEO_TRACK_A_ONLY)
        {
            g_single.height = 0;
            g_single.width = 0;
        }

        /*turn on backlight to make sure video will not play in LCD turn off situation*/
        srv_backlight_turn_on(SRV_BACKLIGHT_SHORT_TIME);

        mmi_medply_single_stream_play();

    }
    else
    {
    #ifdef __DRM_SUPPORT__
        g_single.DRM_consumed = MMI_FALSE;
    #endif /*__DRM_SUPPORT__*/

        mdi_video_stream_disconnect();
    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            mmi_medply_single_stream_deinit();        
            mmi_medply_single_set_pop_up_flag();
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_medply_single_play_completed(MMI_TRUE);
            return;
        }
    #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/
        mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
        mmi_medply_display_popup(result,MMI_FALSE);
    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_stream_play_callback_hdlr
 * DESCRIPTION
 *  callback handler of stream play
 * PARAMETERS
 *  result          [IN]        >=0, means successfully opened, if result < 0 measn some error happened
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_stream_play_callback_hdlr(MDI_RESULT result, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_medply_video_play_para_struct video_layer_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_STREAM_PLAY_CALLBACK, result, g_single.seekable, MMI_TRUE);

    if(result<0)
    {
        mdi_video_stream_disconnect();
    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            mmi_medply_single_stream_deinit();        
            mmi_medply_single_set_pop_up_flag();
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_medply_single_play_completed(MMI_TRUE);
            return;
        }
    #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

        mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
        mmi_medply_display_popup(result,MMI_FALSE);

        return;
    }

    /* new mdi error code , following error code should be ignore */
    if(result == MDI_RES_VDOPLY_ONLY_VIDEO_TRACK_ERROR || result == MDI_RES_VDOPLY_ONLY_AUDIO_TRACK_ERROR)
    {
        return;
    }

    if(result== MDI_RES_VDOPLY_STREAM_BUFFER_OVERFLOW || result== MDI_RES_VDOPLY_STREAM_BUFFER_UNDERFLOW)
    {
        if(g_single.seekable)
        {
            mdi_video_stream_get_cur_play_time(&g_single.current_time);
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_single_stream_buffer();
        }
        else
        {
            mdi_video_stream_disconnect();
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif
    
        #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
            if(g_single.intro_play)
            {
                mmi_medply_single_stream_deinit();
                mmi_medply_single_play_completed(MMI_TRUE);
            }
            else
        #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/
            {
                mmi_medply_single_stream_connect();
            }
        }
        return;
    }

    /*play finished*/

    if(g_single.seekable && !g_medply.fullscreen)
    {
        g_single.current_time = g_single.duration;
        mmi_medply_main_screen_draw_duration();
        mmi_medply_main_screen_blt();        
    }

    if(g_medply.fullscreen)
    {
        mmi_medply_main_screen_set_full_screen(MMI_FALSE);
        mmi_medply_main_screen_clear_video_layer();

        g_medply.fullscreen = MMI_FALSE;

        /*register key hdlr*/
        mmi_medply_register_key_hdlrs(MMI_MEDPLY_SCREEN_NORMAL);
    }

    mdi_video_stream_disconnect();
#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
    if(g_single.intro_play)
    {
        mmi_medply_single_stream_deinit();
        mmi_medply_single_play_completed(MMI_FALSE);
        return;
    }
#endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

#ifdef __MMI_A2DP_SUPPORT__
    mmi_medply_bt_stop(MMI_FALSE);
#endif

    g_single.current_time = 0 ;
    mmi_medply_main_screen_draw_duration();

    video_layer_info.video_height = g_single.height;
    video_layer_info.video_width = g_single.width;
    mmi_medply_main_screen_get_video_parameter(&video_layer_info);
    gdi_layer_push_and_set_active(video_layer_info.layer_hdl);
    gdi_layer_clear(GDI_COLOR_BLACK);    
    gdi_layer_set_source_key(TRUE, GDI_COLOR_TRANSPARENT);
    gdi_layer_pop_and_restore_active();
    mmi_medply_main_screen_blt();

#ifdef __DRM_SUPPORT__
    g_single.DRM_consumed = MMI_FALSE;
#endif

    mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
    
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_stream_update_buffer_percent
 * DESCRIPTION
 *  start a timer to update buffer percentage
 * PARAMETERS
 *  
 * RETURNS
 * 
 *****************************************************************************/
static void mmi_medply_single_stream_update_buffer_percent()
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 percentage;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_ASSERT(g_single.state == SINGLE_STATE_STREAM_BUFFERING);

    mdi_video_stream_get_buf_percentage(&percentage);

    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_STREAM_UPDATE_BUF_PERCENT, percentage, MMI_TRUE);

    /* update progress bar*/
    mmi_medply_main_screen_show_loading(percentage);

    if(percentage <100)
    {
        StartTimer(MEDPLY_STREAM_BUFFER_TIMER, 300, mmi_medply_single_stream_update_buffer_percent);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_stream_init
 * DESCRIPTION
 *  init stream
 * PARAMETERS
 *  void
 * RETURNS
 * MMI_BOOL     to see if init success or not
 *****************************************************************************/
MMI_BOOL mmi_medply_single_stream_init(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MDI_RESULT result;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_medply_register_bear_event(mmi_medply_single_bear_event_callback_hdlr);
    mmi_medply_register_bear_info(mmi_medply_single_bear_info_callback_hdlr);
    result = mdi_video_stream_init(GRP_ID_MEDPLY_SINGLE);

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_STREAM_INIT, result, MMI_TRUE);

    if(result != MDI_RES_VDOPLY_SUCCEED)
    {
        /*error happened*/

    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            /*redraw main screen before pop up*/
            mmi_medply_main_screen_redraw();
            mmi_medply_main_screen_blt();
            mmi_medply_single_set_pop_up_flag();
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_medply_single_play_completed(MMI_TRUE);
            return MMI_FALSE;
        }

    #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

            /*redraw main screen before pop up*/
            mmi_medply_main_screen_redraw();
            mmi_medply_main_screen_blt();
            mmi_medply_display_popup(result,MMI_FALSE);

            mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);

        return MMI_FALSE;
    }

    mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
    return MMI_TRUE;

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_stream_deinit
 * DESCRIPTION
 *  init stream
 * PARAMETERS
 *  void
 * RETURNS
 * MMI_BOOL     to see if init success or not
 *****************************************************************************/
void mmi_medply_single_stream_deinit(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mdi_video_stream_deinit();
    mmi_medply_deregister_bear_event();
    mmi_medply_deregister_bear_info();
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_stream_connect
 * DESCRIPTION
 *  connect for streamming main function
 * PARAMETERS
 *  void
 * RETURNS
 * BOOL
 *****************************************************************************/
static void mmi_medply_single_stream_connect_internal(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MDI_RESULT result;
    nvram_ef_medply_settings_profile_struct *profile_p;
    mdi_video_stream_type_enum stream_type = MDI_VIDEO_STREAM_RTSP_URL ;
    U32 data_account_id;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_STREAM_CONNECT, 888, MMI_TRUE);

    mmi_medply_settings_read_value(MMI_MEDPLY_SETTINGS_PROFILE,(void*)&profile_p);
    mmi_medply_settings_get_data_account_id(&data_account_id);
    if(g_single.media_type == MEDPLY_TYPE_STREAM_RTSP || g_single.media_type == MEDPLY_TYPE_STREAM_RAM)
    {
        stream_type = MDI_VIDEO_STREAM_RTSP_URL;
    }
    else if(g_single.media_type == MEDPLY_TYPE_STREAM_SDP)
    {
        stream_type = MDI_VIDEO_STREAM_SDP_FILE;
    }
    else
    {
         MMI_ASSERT(0);
    }
    
    #ifdef __DRM_SUPPORT__
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_DRM_CONSUMED, g_single.DRM_consumed);
    if (g_single.DRM_consumed)
    {
        /*skip DRM right checking*/
        mdi_video_stream_drm_disable_consume_count();            
    }
    #endif /* __DRM_SUPPORT__ */

    if(g_single.media_type != MEDPLY_TYPE_STREAM_RAM )
    {
        result = mdi_video_stream_connect(
                    data_account_id,
                    stream_type,
                    (CHAR*)g_single.filefullpath, 
                    (MMI_BOOL)profile_p->proxy_on_off, 
                    profile_p->proxy_addr, 
                    profile_p->proxy_port,
                    MMI_TRUE,
                    profile_p->highest_udp_port,
                    profile_p->lowest_udp_port,                          
                    mmi_medply_single_stream_connect_callback_hdlr,
                    NULL);
    }
    else
    {
        result = mdi_video_stream_connect(
                    data_account_id,
                    stream_type,
                    (CHAR*)g_single.url_path, 
                    (MMI_BOOL)profile_p->proxy_on_off, 
                    profile_p->proxy_addr, 
                    profile_p->proxy_port,
                    MMI_TRUE,
                    profile_p->highest_udp_port,
                    profile_p->lowest_udp_port,                          
                    mmi_medply_single_stream_connect_callback_hdlr,
                    NULL);
    }

    
    if(result != MDI_RES_VDOPLY_SUCCEED)
    {
        /*error happened*/
    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            mmi_medply_single_set_pop_up_flag();
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_medply_single_play_completed(MMI_TRUE);
            return;
        }
    #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/
        mmi_medply_display_popup(result,MMI_FALSE);
        return;
    }

    mmi_medply_enter_single_states(SINGLE_STATE_STREAM_CONNECTING);

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_stream_connect
 * DESCRIPTION
 *  connect for streamming main function
 * PARAMETERS
 *  void
 * RETURNS
 * BOOL
 *****************************************************************************/
void mmi_medply_single_stream_connect(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MDI_RESULT result;
    nvram_ef_medply_settings_profile_struct *profile_p;
    mdi_video_stream_type_enum stream_type = MDI_VIDEO_STREAM_RTSP_URL ;
    U32 data_account_id;
    kal_int8 ret = 0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_STREAM_CONNECT, 999, MMI_TRUE);
    
    #ifdef __TCPIP__
    mmi_medply_settings_read_value(MMI_MEDPLY_SETTINGS_PROFILE,(void*)&profile_p);
    mmi_medply_settings_get_data_account_id(&data_account_id);
    g_single.async_open_bearer = MMI_FALSE;
    ret = cbm_open_bearer(data_account_id);
    if(ret == CBM_WOULDBLOCK)
    {
       g_single.async_open_bearer = MMI_TRUE;
    }
    else if(ret == CBM_OK)
    {
        mmi_medply_single_stream_connect_internal();
    }
    else
    {
        mmi_popup_display_simple((WCHAR*) GetString(STR_GLOBAL_ERROR),
                          MMI_EVENT_FAILURE, GRP_ID_MEDPLY_SINGLE, NULL);
    }
    
    #else
    mmi_medply_single_stream_connect_internal();
    #endif

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_stream_do_buffer_action
 * DESCRIPTION
 *  do stream buffer main function
 * PARAMETERS
 *  void
 * RETURNS
 * 
 *****************************************************************************/
void mmi_medply_single_stream_do_buffer_action(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MDI_RESULT result;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_SINGLE_STREAM_BUF, g_single.seekable);

#if defined(__MMI_BACKGROUND_CALL__) && defined(__CS_STREAMING_CONCURRENT_SUPPORT__)
    if(srv_ucm_is_background_call())
    {
        mdi_video_stream_set_track(MDI_VIDEO_TRACK_V_ONLY);
    }
#endif

    if (g_single.seekable)
    {
        result = mdi_video_stream_start_buffering(
                 g_single.current_time,            
                 mmi_medply_single_stream_buffering_callback_hdlr,
                 NULL);
    }
    else
    {
        result = mdi_video_stream_start_buffering(
                 0,            
                 mmi_medply_single_stream_buffering_callback_hdlr,
                 NULL);
    }

    if (result == MDI_RES_VDOPLY_STREAM_DRM_NEED_RIGHT)
    {
        /* no permission - shall disconnect and show popup */
        mdi_video_stream_disconnect();

    #ifdef __MMI_A2DP_SUPPORT__
        mmi_medply_bt_stop(MMI_FALSE);
    #endif
    
        mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
        mmi_medply_display_popup(result,MMI_FALSE);
        return;    
    }
   
    if(result<0)
    {
        mdi_video_stream_disconnect();
    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            mmi_medply_single_stream_deinit();        
            mmi_medply_single_set_pop_up_flag();
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_medply_single_play_completed(MMI_TRUE);
            return;
        }
    #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

        mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
        mmi_medply_display_popup(result,MMI_FALSE);
    }
    else
    {
        StartTimer(MEDPLY_STREAM_BUFFER_TIMER, 100, mmi_medply_single_stream_update_buffer_percent);
        mmi_medply_enter_single_states(SINGLE_STATE_STREAM_BUFFERING);
    }


}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_stream_buffer
 * DESCRIPTION
 *  stream buffer main function
 * PARAMETERS
 *  void
 * RETURNS
 * 
 *****************************************************************************/
void mmi_medply_single_stream_buffer(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

#ifdef __MMI_A2DP_SUPPORT__
    if(mmi_medply_settings_is_output_to_bt())
    {
        MMI_BOOL is_stereo;
        
        if(g_single.track != MDI_VIDEO_TRACK_V_ONLY)
        {
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_BT_CONNECTING);
        }
        else
        {
            mmi_medply_single_stream_do_buffer_action();
            return;
        }

        if(g_single.aud_channel_no == 0 || g_single.aud_sample_rate == 0)
        {
            mdi_video_stream_get_audio_info(&(g_single.aud_channel_no),&(g_single.aud_sample_rate));
        }

        if (g_single.aud_channel_no == 2)
        {
            is_stereo = MMI_TRUE;
        }
        else
        {
            is_stereo = MMI_FALSE;
        }

       /*put this behind enter states because some times it will callback directly with in 
         this function, in that case, entering bt connecting state would be too late*/
        av_bt_open_ex(
            mmi_medply_settings_get_bt_headset(),
            g_single.aud_sample_rate,
            (kal_bool)is_stereo,
            mmi_medply_single_bt_open_callback,
            KAL_TRUE
            );

    }
    else
#endif /*__MMI_A2DP_SUPPORT__*/
    {
        mmi_medply_single_stream_do_buffer_action();
    }


}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_stream_play
 * DESCRIPTION
 *  stream play main funcion
 * PARAMETERS
 *  void
 * RETURNS
 * 
 *****************************************************************************/
void mmi_medply_single_stream_play(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MDI_RESULT  result;
    mmi_medply_video_play_para_struct video_layer_info;
    U8 volume = g_single.volume;    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_STREAM_PLAY, MMI_TRUE, g_single.mute, MMI_TRUE);

#ifdef __DRM_SUPPORT__
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_DRM_CONSUMED, g_single.DRM_consumed);
    if (g_single.DRM_consumed)
    {
        mdi_video_stream_drm_disable_consume_count();        
    }
#endif /* __DRM_SUPPORT__ */

    if(g_single.mute)
    {
        volume = 0;
    }

#if defined(__MMI_BACKGROUND_CALL__) && defined(__CS_STREAMING_CONCURRENT_SUPPORT__)
    if(srv_ucm_is_background_call())
    {
        mdi_video_stream_set_track(MDI_VIDEO_TRACK_V_ONLY);
    }
#endif


    mdi_audio_set_volume(MDI_VOLUME_MEDIA, MDI_AUD_VOL_EX_MUTE(volume));

    video_layer_info.video_height = g_single.height;
    video_layer_info.video_width = g_single.width;
    mmi_medply_main_screen_get_video_parameter(&video_layer_info);

    result = mdi_video_stream_play(
                video_layer_info.layer_hdl, 
                video_layer_info.layer_blt_flag, 
                video_layer_info.layer_play_flag, 
                MMI_TRUE,
                MDI_DEVICE_SPEAKER2, 
                video_layer_info.layer_lcd_rotate, 
                mmi_medply_single_stream_play_callback_hdlr,
                NULL
                );
                

    if (result == MDI_RES_VDOPLY_SUCCEED)
    {
    #ifdef __DRM_SUPPORT__
        if(!g_single.DRM_consumed)
        {
            g_single.DRM_consumed = MMI_TRUE;
        }
    #endif /* __DRM_SUPPORT__ */        
        mmi_medply_enter_single_states(SINGLE_STATE_STREAM_PLAY);
    }    
    else
    {
    #ifdef __DRM_SUPPORT__    
         g_single.DRM_consumed = MMI_FALSE;
    #endif

        mdi_video_stream_disconnect();

    #ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
        if(g_single.intro_play)
        {
            mmi_medply_single_stream_deinit();        
            mmi_medply_single_set_pop_up_flag();
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_medply_single_play_completed(MMI_TRUE);
            return;
        }
    #endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

    #ifdef __MMI_A2DP_SUPPORT__
        mmi_medply_bt_stop(MMI_FALSE);
    #endif
    
        mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
        mmi_medply_display_popup(result,MMI_FALSE);

    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_play_stream_from_rtsp_link
 * DESCRIPTION
 *  entery function of media single player main screen for stream rtsp link
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_play_stream_from_rtsp_link(UI_string_type rtsp_url)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/  

    mmi_medply_single_play_stream_from_rtsp_link_with_title(rtsp_url,NULL);
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_play_stream_from_rtsp_link_with_title
 * DESCRIPTION
 *  entery function of media single player main screen for stream rtsp link
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_play_stream_from_rtsp_link_with_title(UI_string_type rtsp_url, UI_string_type title)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_SINGLE_STREAM_PLAY_RTSP);

#if !defined( __RF_DESENSE_TEST__) && !defined(__CS_STREAMING_CONCURRENT_SUPPORT__)
    if (srv_ucm_query_call_count(SRV_UCM_INCOMING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0 ||
        srv_ucm_query_call_count(SRV_UCM_OUTGOING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0 ||
        srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_NO_CSD, NULL) > 0)
    {
        mmi_medply_display_popup_with_sg(STR_GLOBAL_CURRENTLY_NOT_AVAILABLE_IN_CALL, MMI_EVENT_FAILURE);
        return; 
    }
#endif

#ifdef __DM_LAWMO_SUPPORT__
    if(mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_PARTIALLYLOCK || mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_ON_LOCKING)
    {
        MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_LAWMO_LOCK);
        return;
    }
#endif

    //mmi_medply_single_group_screen_enter();
    //Put a dummy group here, keep the old behavior
    mmi_frm_group_create_ex(GRP_ID_ROOT, GRP_ID_AUTO_GEN, NULL, NULL,  MMI_FRM_NODE_SMART_CLOSE_FLAG);

#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
    g_single.intro_play = MMI_FALSE;
#endif
    g_single.media_type = MEDPLY_TYPE_STREAM_RTSP;
    g_single.continue_to_play = MMI_TRUE;
    g_single.seekable = MMI_TRUE;
    g_single.build_cache_failed = MMI_FALSE;
    g_single.current_time = 0;
    g_single.duration = 0;
    g_single.is_short = MMI_FALSE;

#ifdef __DRM_SUPPORT__
    g_single.DRM_consumed = MMI_FALSE;
#endif /*__DRM_SUPPORT__*/


    g_single.need_to_build_cache = MMI_FALSE;

    if(rtsp_url != g_single.filefullpath)
    {
        memset(g_single.filefullpath, 0, sizeof(g_single.filefullpath)); 
        mmi_ucs2ncpy((CHAR*)g_single.filefullpath, (CHAR*)rtsp_url, (sizeof(g_single.filefullpath)/ENCODING_LENGTH)-1);
    }

    memset(g_single.specified_title, 0, sizeof(g_single.specified_title)); 

    if(title != NULL)
    {
        mmi_ucs2cpy((CHAR*)g_single.specified_title, (CHAR*)title);
    }

    //mmi_medply_single_enter_main_screen();
    //use launch to cover OOM problem;
    mmi_medply_single_launch();
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_play_stream_from_sdp_file
 * DESCRIPTION
 *  entery function of media single player main screen for stream rtsp link
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_play_stream_from_sdp_file(UI_string_type sdp_file, MMI_BOOL is_short)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_SINGLE_STREAM_PLAY_SDP);

    mmi_medply_single_play_stream_from_sdp_file_with_title(sdp_file, is_short, NULL);

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_play_stream_from_sdp_file_with_title
 * DESCRIPTION
 *  entery function of media single player main screen for stream rtsp link
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_play_stream_from_sdp_file_with_title(UI_string_type sdp_file, MMI_BOOL is_short, UI_string_type title)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_SINGLE_STREAM_PLAY_SDP);

#if !defined( __RF_DESENSE_TEST__) && !defined(__CS_STREAMING_CONCURRENT_SUPPORT__)
    if (srv_ucm_query_call_count(SRV_UCM_INCOMING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0 ||
        srv_ucm_query_call_count(SRV_UCM_OUTGOING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0 ||
        srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_NO_CSD, NULL) > 0)
    {
        mmi_medply_display_popup_with_sg(STR_GLOBAL_CURRENTLY_NOT_AVAILABLE_IN_CALL, MMI_EVENT_FAILURE);
        return; 
    }
#endif

#ifdef __DM_LAWMO_SUPPORT__
    if(mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_PARTIALLYLOCK || mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_ON_LOCKING)
    {
        MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_LAWMO_LOCK);
        return;
    }
#endif

    //mmi_medply_single_group_screen_enter();
    //Put a dummy group here, keep the old behavior
    mmi_frm_group_create_ex(GRP_ID_ROOT, GRP_ID_AUTO_GEN, NULL, NULL,  MMI_FRM_NODE_SMART_CLOSE_FLAG);

#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
    g_single.intro_play = MMI_FALSE;
#endif
    g_single.media_type = MEDPLY_TYPE_STREAM_SDP;
    g_single.continue_to_play = MMI_TRUE;
    g_single.seekable = MMI_TRUE;
    g_single.build_cache_failed = MMI_FALSE;
    g_single.current_time = 0;
    g_single.duration = 0;    
    g_single.is_short = is_short;

#ifdef __DRM_SUPPORT__
    g_single.DRM_consumed = MMI_FALSE;
#endif /*__DRM_SUPPORT__*/


    g_single.need_to_build_cache = MMI_FALSE;

    mmi_ucs2cpy((CHAR*)g_single.filefullpath, (CHAR*)sdp_file);
    memset(g_single.specified_title, 0, sizeof(g_single.specified_title)); 

    if(title != NULL)
    {
        mmi_ucs2cpy((CHAR*)g_single.specified_title, (CHAR*)title);
    }

    //mmi_medply_single_enter_main_screen();
    //use launch to cover OOM problem;
    mmi_medply_single_launch();

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_play_stream_from_ram_file
 * DESCRIPTION
 *  entery function of media single player main screen for stream ram file
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_play_stream_from_ram_file(UI_string_type ram_file, MMI_BOOL is_short)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    FS_HANDLE file_handle;
    U32 readed;
    CHAR url_buf[MEDPLY_URL_MAX_LENGTH + 1];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_SINGLE_STREAM_PLAY_RAM);

#if !defined( __RF_DESENSE_TEST__) && !defined(__CS_STREAMING_CONCURRENT_SUPPORT__)
    if (srv_ucm_query_call_count(SRV_UCM_INCOMING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0 ||
        srv_ucm_query_call_count(SRV_UCM_OUTGOING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0 ||
        srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_NO_CSD, NULL) > 0)
    {
        mmi_medply_display_popup_with_sg(STR_GLOBAL_CURRENTLY_NOT_AVAILABLE_IN_CALL, MMI_EVENT_FAILURE);
        return; 
    }
#endif

#ifdef __DM_LAWMO_SUPPORT__
    if(mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_PARTIALLYLOCK || mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_ON_LOCKING)
    {
        MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_LAWMO_LOCK);
        return;
    }
#endif

    //mmi_medply_single_group_screen_enter();
    //Put a dummy group here, keep the old behavior
    mmi_frm_group_create_ex(GRP_ID_ROOT, GRP_ID_AUTO_GEN, NULL, NULL,  MMI_FRM_NODE_SMART_CLOSE_FLAG);

#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
    g_single.intro_play = MMI_FALSE;
#endif
    g_single.media_type = MEDPLY_TYPE_STREAM_RAM;
    g_single.continue_to_play = MMI_TRUE;
    g_single.seekable = MMI_TRUE;
    g_single.build_cache_failed = MMI_FALSE;
    g_single.current_time = 0;
    g_single.duration = 0;    
    g_single.is_short = is_short;

#ifdef __DRM_SUPPORT__
    g_single.DRM_consumed = MMI_FALSE;
#endif /*__DRM_SUPPORT__*/


    g_single.need_to_build_cache = MMI_FALSE;

    file_handle = FS_Open((U16*)ram_file, FS_READ_ONLY);
    memset(url_buf, 0, MEDPLY_URL_MAX_LENGTH+1);

    if (file_handle >=0)
    {
        FS_Read(file_handle, (void*)url_buf, MEDPLY_URL_MAX_LENGTH, &readed);
        FS_Close(file_handle);
    }

    mmi_ucs2cpy((CHAR*)g_single.filefullpath, (CHAR*)ram_file);
    memset(g_single.specified_title, 0, sizeof(g_single.specified_title));

    memset(g_single.url_path, 0 , sizeof(g_single.url_path));
    mmi_asc_to_ucs2((CHAR*)g_single.url_path, (CHAR*)url_buf);

    //mmi_medply_single_enter_main_screen();
    //use launch to cover OOM problem;
    mmi_medply_single_launch();

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_stream_receive_da_file
 * DESCRIPTION
 *  handle da receive a sdp file and request to play
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_stream_receive_da_file(
        S32 session_id, 
        S32 mime_type, 
        S32 mime_subtype, 
        S32 action, 
        PU16 file_path, 
        CHAR* url, 
        CHAR* mime_type_string)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_SINGLE_STREAM_RECEIVE_DA_FILE);
    
    MMI_ASSERT(mime_type == MIME_TYPE_APPLICATION);
    MMI_ASSERT(mime_subtype == MIME_SUBTYPE_SDP);    

    mmi_medply_single_play_stream_from_sdp_file((UI_string_type)file_path, MMI_FALSE);
    
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_rtsp_url_hdlr
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_rtsp_url_hdlr(void *msg_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_medply_rtsp_url_data_struct *url_data_ptr;
    S32 str_len;
    CHAR str_buf[(MEDPLY_URL_MAX_LENGTH+1)*ENCODING_LENGTH];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_NO_CSD, NULL) > 0)
    {
        /* receive this message after call launched, should igore */
        return;
    }
    
    url_data_ptr = (mmi_medply_rtsp_url_data_struct*)msg_ptr;

    str_len = strlen(url_data_ptr->rtsp_url);
    if (str_len > MEDPLY_URL_MAX_LENGTH)
    {
        /* TODO: change string to URL too long */
        mmi_popup_display_simple((WCHAR*) GetString(STR_GLOBAL_ERROR), MMI_EVENT_FAILURE, GRP_ID_MEDPLY_SINGLE, NULL);

        return;
    }
    
    /* path is ASCII, we need covent it to Unicode */
    mmi_asc_to_ucs2(str_buf, url_data_ptr->rtsp_url);

    mmi_medply_single_play_stream_from_rtsp_link((UI_string_type)str_buf);

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_send_rtsp_url_req
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_send_rtsp_url_req(CHAR* rtsp_url)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_medply_rtsp_url_data_struct *url_data_ptr;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    url_data_ptr = OslAllocDataPtr(mmi_medply_rtsp_url_data_struct);
    /* url is ascii string */
    ASSERT(url_data_ptr!=NULL);

    strncpy(url_data_ptr->rtsp_url, rtsp_url, (MEDPLY_URL_MAX_LENGTH+1)*ENCODING_LENGTH);

	mmi_frm_send_ilm(MOD_MMI, MSG_ID_MMI_MEDPLY_RTSP_URL_REQ, (oslParaType*)url_data_ptr, NULL);
    
    
}


#ifdef __MMI_URI_AGENT__
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_uri_lauch_streaming
 * DESCRIPTION
 *  launch streaming
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_uri_lauch_streaming(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(g_single.uri_agent_cb)
    {
        g_single.uri_agent_cb(g_single.ura_appid, SRV_URIAGENT_APPID_STREAMING, SRV_URIAGENT_ERR_OK);
        g_single.uri_agent_cb = NULL;
    }

    if(g_single.temp_url_p)
    {
        mmi_ucs2cpy((CHAR*)g_single.filefullpath, g_single.temp_url_p);
    }

    mmi_medply_single_play_stream_from_rtsp_link(g_single.filefullpath);

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_uri_go_back
 * DESCRIPTION
 *  go back history
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_uri_go_back(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
 
    if(g_single.uri_agent_cb)
    {
        g_single.uri_agent_cb(g_single.ura_appid, SRV_URIAGENT_APPID_STREAMING, SRV_URIAGENT_ERR_OK);
        g_single.uri_agent_cb = NULL;
    }

    mmi_frm_scrn_close_active_id();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_uri_activate_popup_confirm_callback
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void       
 * RETURNS
 *  S32
 *****************************************************************************/
static mmi_ret mmi_medply_single_uri_activate_popup_confirm_callback(mmi_event_struct *mmi_evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_alert_result_evt_struct *evt = (mmi_alert_result_evt_struct*)mmi_evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(evt->evt_id == EVT_ID_ALERT_QUIT)
    {
        switch(evt->result)
        {
            case MMI_ALERT_CNFM_YES:
                mmi_medply_single_uri_lauch_streaming();
                break;
            case MMI_ALERT_CNFM_NO:
                mmi_medply_single_uri_go_back();
                break;

            case MMI_POPUP_INTERRUPT_EXIT:
            case MMI_POPUP_NORMAL_EXIT:
                g_single.confirm_count -- ;
                break;

            default:
                break;
        }

        if(g_single.confirm_count == 0)
        {
            /* Callback application when confirm screen exit */
            if(g_single.uri_agent_cb)
            {
                g_single.uri_agent_cb(g_single.ura_appid, SRV_URIAGENT_APPID_STREAMING, SRV_URIAGENT_ERR_OK);
                g_single.uri_agent_cb = NULL;
            }

            if(g_single.temp_url_p)
            {
                free_ctrl_buffer(g_single.temp_url_p);
                g_single.temp_url_p = NULL;
            }
        }
    }
    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_uri_activate_popup_confirm
 * DESCRIPTION
 *  uri agent pop up confrim
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_uri_activate_popup_confirm(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_confirm_property_struct confirm_arg;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    mmi_confirm_property_init(&confirm_arg, CNFM_TYPE_YESNO);

    confirm_arg.parent_id = GRP_ID_ROOT;
    confirm_arg.callback = mmi_medply_single_uri_activate_popup_confirm_callback;

    g_single.confirm_count ++ ;

    mmi_confirm_display((WCHAR*)GetString(STR_ID_MEDPLY_NOTIFY_CONFIRM_STREAMING),
                        MMI_EVENT_QUERY,
                        &confirm_arg);
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_uri_scheme_handler
 * DESCRIPTION
 *  uri scheme handler
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_uri_scheme_handler(
    srv_uriagent_appid_enum ura_appid,
    char *url,
    char *param,
    srv_uriagent_options_enum options,
    srv_uriagent_uri_request_hdlr_cb uri_agent_cb)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

#if !defined( __RF_DESENSE_TEST__) && !defined(__CS_STREAMING_CONCURRENT_SUPPORT__)
    if (srv_ucm_query_call_count(SRV_UCM_INCOMING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0 ||
        srv_ucm_query_call_count(SRV_UCM_OUTGOING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0 ||
        srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_NO_CSD, NULL) > 0)
    {
        mmi_medply_display_popup_with_sg(STR_GLOBAL_CURRENTLY_NOT_AVAILABLE_IN_CALL, MMI_EVENT_FAILURE);
        if(uri_agent_cb != NULL)
        {
            uri_agent_cb(ura_appid, SRV_URIAGENT_APPID_STREAMING, SRV_URIAGENT_ERR_OK);
        }
        return; 
    }
#endif

    /* Do not launch the media player during screen lock */
    if(mmi_scr_locker_is_launched())
    {
        if(uri_agent_cb != NULL)
        {
            uri_agent_cb(ura_appid, SRV_URIAGENT_APPID_STREAMING, SRV_URIAGENT_ERR_OK);
        }
        return;
    }

#ifdef __DM_LAWMO_SUPPORT__
    if(mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_PARTIALLYLOCK || mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_ON_LOCKING)
    {
        MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_LAWMO_LOCK);
        if(uri_agent_cb != NULL)
        {
            uri_agent_cb(ura_appid, SRV_URIAGENT_APPID_STREAMING, SRV_URIAGENT_ERR_OK);
        }
        return;
    }
#endif

    if (options == SRV_URIAGENT_OPTION_NEED_CONFIRM_POPUP)
    {
        if(g_single.temp_url_p)
        {
            free_ctrl_buffer(g_single.temp_url_p);
            g_single.temp_url_p = NULL;
        }

        if(g_single.uri_agent_cb)
        {
            g_single.uri_agent_cb(g_single.ura_appid, SRV_URIAGENT_APPID_STREAMING, SRV_URIAGENT_ERR_OK);
            g_single.uri_agent_cb = NULL;
        }

        g_single.ura_appid = ura_appid;
        g_single.uri_agent_cb = uri_agent_cb;
        g_single.temp_url_p = (CHAR*)get_ctrl_buffer(sizeof(g_single.filefullpath));

        if(g_single.temp_url_p)
        {
            /* note: the url from uri scheme manager is ascii */
            mmi_asc_n_to_ucs2(g_single.temp_url_p, (CHAR*)url, MEDPLY_URL_MAX_LENGTH);
        }

        mmi_medply_single_uri_activate_popup_confirm();

    }
    else
    {
        /* note: the url from uri scheme manager is ascii */
        mmi_asc_n_to_ucs2((CHAR*)g_single.filefullpath, (CHAR*)url, MEDPLY_URL_MAX_LENGTH);

        mmi_medply_single_play_stream_from_rtsp_link(g_single.filefullpath);
        if(uri_agent_cb != NULL)
        {
            uri_agent_cb(ura_appid, SRV_URIAGENT_APPID_STREAMING, SRV_URIAGENT_ERR_OK);
        }
    }
    
}
#endif /* __MMI_URI_AGENT__ */

#endif /*__MMI_MEDIA_PLAYER_STREAM__*/

#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_intro_popup_callback
 * DESCRIPTION
 *  if popup when intro play, and other screen covers over the popup, shall delete
 *  single player intro play from the history to follw the original scenario.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_intro_popup_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if(mmi_frm_scrn_is_present(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
    {
        mmi_frm_scrn_close(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN);
    }
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_intro_finish
 * DESCRIPTION
 *  handle intro play finish process
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_intro_finish(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    mmi_frm_scrn_close_active_id();
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pop_up_wait_next_callback
 * DESCRIPTION
 *  to start wait next timer for intro pop up cases
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_pop_up_wait_next_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(g_single.wait_next_with_pop_up)
    {
        StartTimer(MEDPLY_SINGLE_WAIT_NEXT_TIMER, 700, mmi_medply_single_wait_next_time_out);
        g_single.wait_next_with_pop_up = MMI_FALSE;
    }

    if(g_single.intro_play_finish)
    {
        if(mmi_frm_scrn_is_present(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
        {
            mmi_frm_scrn_close(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN);
        }

        g_single.intro_play_finish = MMI_FALSE;
    }
    mmi_frm_scrn_close_active_id();
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_intro_play_time_out_hdlr
 * DESCRIPTION
 *  handle intro play duration time out, stop current media, pick next to play
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_intro_play_time_out_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    switch(g_single.state)
    {
    #ifdef __MMI_MEDIA_PLAYER_AUDIO__
        case SINGLE_STATE_AUDIO_PLAY:
        {
            mmi_medply_single_set_self_stop_flag(MMI_TRUE);
            /*stop file*/
            mdi_audio_stop_file();
            mmi_medply_single_set_self_stop_flag(MMI_FALSE);

            g_single.current_time = MEDPLY_INTRO_PLAY_DURATION ;
            mmi_medply_main_screen_draw_duration();
            mmi_medply_main_screen_blt();

            mmi_medply_single_play_completed(MMI_FALSE);
            break;
        }
    #endif /*#ifdef __MMI_MEDIA_PLAYER_AUDIO__*/

    #ifdef __MMI_MEDIA_PLAYER_VIDEO__
        case SINGLE_STATE_VIDEO_PLAY:
        {        
            /*stop video*/
            mdi_video_ply_stop();
            /*close video*/            
            mmi_medply_single_video_close();

            g_single.current_time = MEDPLY_INTRO_PLAY_DURATION ;
            mmi_medply_main_screen_draw_duration();
            mmi_medply_main_screen_blt();

            mmi_medply_single_play_completed(MMI_FALSE);
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

    #ifdef __MMI_MEDIA_PLAYER_STREAM__
        case SINGLE_STATE_STREAM_PLAY:
        {
            /*stop streaming*/
            mdi_video_stream_stop();
            /*disconnect*/
            mdi_video_stream_disconnect();
            /*deinit*/
            mmi_medply_single_stream_deinit();

            g_single.current_time = MEDPLY_INTRO_PLAY_DURATION ;
            mmi_medply_main_screen_draw_duration();
            mmi_medply_main_screen_blt();

            mmi_medply_single_play_completed(MMI_FALSE);
            break;
        }
    #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

        default:
        {
            break;
        }
    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_wait_next_time_out
 * DESCRIPTION
 *  handle wait next time out, play next media file
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_wait_next_time_out(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_WAIT_NEXT_TIME_OUT,g_single.state,MMI_TRUE);

    /* in case entery main screen and time out happened at the same time, so that
       this will be executed two times*/
    if(g_single.state == SINGLE_STATE_WAIT_NEXT)
    {
        mmi_medply_enter_single_states(SINGLE_STATE_IDLE);
    }
    
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_play_completed
 * DESCRIPTION
 *  in charge of pick up next song and play it if play list return a song to play
 *
 * PARAMETERS
 *  with_pop_up [IN]    indicate whether there is pop up for play complete or not
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_play_completed(MMI_BOOL with_pop_up)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 apply_result = 0 ;
        
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PLAY_COMPLETED, with_pop_up, MMI_TRUE, MMI_TRUE);

    StopTimer(MEDPLY_INTRO_PLAY_TIMER);

#ifdef __MMI_A2DP_SUPPORT__
    mmi_medply_bt_stop(MMI_FALSE);
#endif

    if(mmi_medply_plst_single_do_pick() >=0 )
    {
        apply_result = mmi_medply_plst_single_apply_picked_file();

        if(apply_result<0)
        {
            /*in case that the delete screen will do all the disconenct/deinit process 
              while stream has been deinited already*/
            g_single.state = SINGLE_STATE_IDLE;
            mmi_medply_plst_display_popup(apply_result,NULL);
            mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
            return;
        }

        if(with_pop_up)
        {
            g_single.wait_next_with_pop_up = MMI_TRUE;
        }
        mmi_medply_single_set_continue_flag(MMI_TRUE);
        mmi_medply_enter_single_states(SINGLE_STATE_WAIT_NEXT);
    }
    else
    {
        mmi_medply_single_set_continue_flag(MMI_FALSE);
        mmi_medply_enter_single_states(SINGLE_STATE_IDLE);
        if(with_pop_up)
        {
            g_single.intro_play_finish = MMI_TRUE;
        }
        else
        {
            StartTimer(MEDPLY_SINGLE_WAIT_NEXT_TIMER, 700, mmi_medply_single_intro_finish);
        }
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_intro_play
 * DESCRIPTION
 *  interface for playlist to start intro play mode
 *  every media file will be played for 5 seconds 
 *  and then auto switch to next media
 * PARAMETERS
 *  
 * RETURNS
 * 
 *****************************************************************************/
void mmi_medply_single_intro_play(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 apply_result = 0 ;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    apply_result = mmi_medply_plst_single_apply_picked_file();
    
    if(apply_result<0)
    {
        mmi_medply_plst_display_popup(apply_result,NULL);
        return;
    }

    //mmi_medply_single_group_screen_enter();
    //Put a dummy group here, keep the old behavior
    mmi_frm_group_create_ex(GRP_ID_ROOT, GRP_ID_AUTO_GEN, NULL, NULL,  MMI_FRM_NODE_SMART_CLOSE_FLAG);

    g_single.intro_play = MMI_TRUE;
    g_single.continue_to_play = MMI_TRUE;
    g_single.current_time = 0;
    g_single.selected_button = MEDPLY_MAIN_DISABLED;
    g_single.seekable = MMI_FALSE;
    g_single.build_cache_failed = MMI_FALSE;
    g_single.intro_play_finish = MMI_FALSE;
#ifdef __DRM_SUPPORT__
    g_single.DRM_consumed = MMI_FALSE;
#endif /*__DRM_SUPPORT__*/

    memset(g_single.specified_title, 0, sizeof(g_single.specified_title));

    //mmi_medply_single_enter_main_screen();
    //use launch to cover OOM problem;
    mmi_medply_single_launch();

}
#endif /*__MMI_MEDIA_PLAYER_INTRO_PLAY__*/

#ifdef __MMI_VIDEO_PDL__

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_video_update_download_percent_timer
 * DESCRIPTION
 *  an agent for mmi_medply_single_pdl_video_update_download_percent
 * PARAMETERS
 *  
 * RETURNS
 * 
 *****************************************************************************/
void mmi_medply_single_pdl_video_update_download_percent_timer(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    mmi_medply_single_pdl_video_update_download_percent();

    return;
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_video_update_download_percent
 * DESCRIPTION
 *  start a timer to update downloaded percent
 * PARAMETERS
 *  
 * RETURNS
 * 
 *****************************************************************************/
MMI_BOOL mmi_medply_single_pdl_video_update_download_percent(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 result;
    U64 max_play_time;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    result = mdi_video_progressive_get_max_play_time(&max_play_time);

    if(result >= 0)
    {
        g_single.pdl_video_max_play_time = max_play_time;

        if(g_single.pdl_state == MEDPLY_PDL_STATE_DOWNLOADING && g_single.seekable)
        {
            StartTimer(MEDPLY_PDL_CALC_DOWNLOAD_TIMER, 300, mmi_medply_single_pdl_video_update_download_percent_timer);
        }

        MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDLV_UPDATE_DWN_PERCENT, max_play_time, g_single.state);
        mmi_medply_main_screen_draw_cache();
        mmi_medply_main_screen_blt();
        return MMI_TRUE;
    }

    mmi_medply_display_popup(result,MMI_FALSE);
    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
    return MMI_FALSE;

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_video_update_buffer_percent
 * DESCRIPTION
 *  start a timer to update buffer percentage
 * PARAMETERS
 *  
 * RETURNS
 * 
 *****************************************************************************/
void mmi_medply_single_pdl_video_update_buffer_percent(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 percentage;
    S32 result;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_ASSERT(g_single.state == SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING || g_single.state == SINGLE_STATE_PDL_VIDEO_PAUSE_BUFFERING);

    result = mdi_video_progressive_get_buf_percentage(&percentage);

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDLV_UPDATE_BUF_PERCENT, result, percentage, g_single.state);

    if(result<0)
    {
        mmi_medply_display_popup(result,MMI_FALSE);
        return;        
    }

    /*update progress bar*/
    mmi_medply_main_screen_show_loading(percentage);

    if(percentage <100)
    {
        StartTimer(MEDPLY_PDL_BUFFER_TIMER, 900, mmi_medply_single_pdl_video_update_buffer_percent);
    }
    else
    {
        /* sleep 100ms to let 100% progress bar show longer */
        kal_sleep_task(30);

        mmi_medply_main_screen_stop_animation(MMI_MEDPLY_ANI_LOADING);

        switch(g_single.state)
        {
            case SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING:
            {
                mmi_medply_single_pdl_video_play();
                break;
            }

            case SINGLE_STATE_PDL_VIDEO_PAUSE_BUFFERING:
            {
                mmi_medply_single_set_continue_flag(MMI_FALSE);
                mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_READY);
                break;
            }

            default:
            {
                MMI_ASSERT(0);
                return;
            }

        }
    }
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_video_buffer_for_seek_file
 * DESCRIPTION
 *  this is in case that in open state, seek buffer not enough,
 *  to wait buffer download in opening state
 * PARAMETERS
 *  
 * RETURNS
 * 
 *****************************************************************************/
void mmi_medply_single_pdl_video_buffer_for_seek_file(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 percentage;
    MDI_RESULT result;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    result = mdi_video_progressive_get_buf_percentage(&percentage);

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDLV_UPDATE_BUF_PERCENT, result, percentage, g_single.state);

    if(result<0)
    {
        mmi_medply_display_popup(result,MMI_FALSE);
        mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
        return;        
    }

    if(percentage <100)
    {
        StartTimer(MEDPLY_PDL_BUFFER_TIMER, 50, mmi_medply_single_pdl_video_buffer_for_seek_file);
        return;
    }
    else
    {
        mmi_medply_video_play_para_struct video_layer_info;

        video_layer_info.video_height = g_single.height;
        video_layer_info.video_width = g_single.width;
        mmi_medply_main_screen_get_video_parameter(&video_layer_info);

        /* since we might have to seek to far away from begining, so we use non_block seek*/
        result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                g_single.current_time,
                video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                mmi_medply_single_pdl_video_seek_callback_hdlr,
                0);

        if(result >= 0)
        {
            return;
        }
        else
        {
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
            return;
        }
    }
}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_video_play_callback_hdlr
 * DESCRIPTION
 *  video play callback handler
 * PARAMETERS
 *  result      [IN]        >=0, means successfully finished, 
 *                          if result < 0 measn some error happened
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_pdl_video_play_callback_hdlr(MDI_RESULT result, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDLV_PLAY_CALLBACK, result);

    if(g_single.state != SINGLE_STATE_PDL_VIDEO_PLAY)
    {
        return;
    }

    /* new mdi error code , following error code should be ignore */
    if(result == MDI_RES_VDOPLY_ONLY_VIDEO_TRACK_ERROR || result == MDI_RES_VDOPLY_ONLY_AUDIO_TRACK_ERROR)
    {
        return;
    }

    /* error happened */
    if (result < 0 )
    {
    #ifdef __DRM_SUPPORT__
        g_single.DRM_consumed = MMI_FALSE;
    #endif /*__DRM_SUPPORT__*/
        mmi_medply_display_popup(result,MMI_FALSE);
        return;
    }
    else if (result == MDI_RES_VDOPLY_PROGRESSIVE_FILE_NOT_ENOUGH)
    {
    #ifdef __MMI_A2DP_SUPPORT__
        mmi_medply_bt_stop(MMI_FALSE);
    #endif
        StartTimer(MEDPLY_PDL_BUFFER_TIMER, 100, mmi_medply_single_pdl_video_update_buffer_percent);
        mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING);
        return;
    }
    else
    {
        mmi_medply_video_play_para_struct video_layer_info;

        if(!g_medply.fullscreen)
        {
            g_single.current_time = g_single.duration;
            mmi_medply_main_screen_draw_duration();
            mmi_medply_main_screen_blt();
        }
        else
        {
            mmi_medply_main_screen_set_full_screen(MMI_FALSE);
            mmi_medply_main_screen_clear_video_layer();

            g_medply.fullscreen = MMI_FALSE;

            /*register key hdlr*/
            mmi_medply_register_key_hdlrs(MMI_MEDPLY_SCREEN_NORMAL);
        }

        /*when play finish, seek to the fornt of the video*/
        g_single.current_time = 0;

    #ifdef __DRM_SUPPORT__
        g_single.DRM_consumed = MMI_FALSE;
    #endif /*__DRM_SUPPORT__*/

    #ifdef __MMI_A2DP_SUPPORT__
        mmi_medply_bt_stop(MMI_FALSE);
    #endif

        video_layer_info.video_height = g_single.height;
        video_layer_info.video_width = g_single.width;
        mmi_medply_main_screen_get_video_parameter(&video_layer_info);

        result = mmi_medply_adption_video_seek_and_get_frame(
                  g_single.current_time,
                  video_layer_info.layer_hdl
                        #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                        ,video_layer_info.layer_subtitle_hdl
                        #endif
                  );

        if(result < 0)
        {
            mmi_medply_display_popup(result,MMI_FALSE);
            mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
            return;
        }

        mmi_medply_main_screen_blt();
        mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_READY);
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_video_seek_callback_hdlr
 * DESCRIPTION
 *  seek result
 * PARAMETERS
 *  result      [IN]        Seek result
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_pdl_video_seek_callback_hdlr(MDI_RESULT result, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDLV_SEEK_CALLBACK, result, g_single.state);

    /* error happened */
    if (result < 0)
    {
        mmi_medply_display_popup(result,MMI_FALSE);
        mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
        return;
    }

    /* seek partial done, so need to reassign current time to seek time */
    if (result == MDI_RES_VDOPLY_SEEK_PARTIAL_DONE)
    {
        /* get current play time */
        mdi_video_ply_get_cur_play_time(&g_single.current_time);
    }

    mmi_medply_main_screen_video_updated();
    mmi_medply_main_screen_blt();

    mmi_medply_main_screen_stop_animation(MMI_MEDPLY_ANI_VIDEO_OPENING);

    if(g_medply.fullscreen && g_single.state==SINGLE_STATE_PDL_VIDEO_PAUSE_SEEKING)
    {
        g_single.state = SINGLE_STATE_PDL_VIDEO_PLAY_SEEKING ;
    }

    /* enter next state */
    switch (g_single.state)
    {
        case SINGLE_STATE_PDL_VIDEO_PLAY_SEEKING:
        {
            mmi_medply_single_set_continue_flag(MMI_TRUE);
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_READY);
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_PAUSE_SEEKING:
        {
            mmi_medply_single_set_continue_flag(MMI_FALSE);
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_READY);
            break;
        }

        case SINGLE_STATE_PDL_VIDEO_OPENING:
        {
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_READY);
            break;
        }

    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_video_open_callback_hdlr
 * DESCRIPTION
 *  to handle open callback, continue to do seek action if open success
 * PARAMETERS
 *  result          [IN]        >=0, means successfully opened, if result < 0 measn some error happened)
 *  vdo_clip        [IN]        Video info
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_pdl_video_open_callback_hdlr(MDI_RESULT result, mdi_video_info_struct *vdo_clip, void *user_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDLV_OPEN_CALLBACK_1, result);

    if (result >= 0)
    {
        mmi_medply_video_play_para_struct video_layer_info;

        /* open sucess */
        U16 brightness, contrast;
        mmi_medply_settings_read_value(MMI_MEDPLY_SETTINGS_BRIGHTNESS,(void*)&brightness);
        mmi_medply_settings_read_value(MMI_MEDPLY_SETTINGS_CONTRAST,(void*)&contrast);  

        /* set brightness/contrast */
        mdi_video_ply_set_brightness(brightness);
        mdi_video_ply_set_contrast(contrast);

        /* fit it into player window */
        g_single.width = vdo_clip->width;
        g_single.height = vdo_clip->height;
        g_single.duration = vdo_clip->total_time_duration;
        g_single.progress_speed = mmi_medply_determine_progress_speed(g_single.duration);        
        g_single.seekable = vdo_clip->is_seekable;
        g_single.track = vdo_clip->track;
        g_single.aud_channel_no = vdo_clip->aud_channel_no;        
        g_single.aud_sample_rate= vdo_clip->aud_sample_rate;

        /* this avoid driver return total time druation == 0, which will cause divid by zero */
        if (g_single.duration == 0)
        {
            g_single.seekable = MMI_FALSE;
        }

        MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_PDLV_OPEN_CALLBACK_2, g_single.duration, g_single.seekable, g_single.track);

        if(g_single.seekable)
        {
            MMI_BOOL result;
            result = mmi_medply_single_pdl_video_update_download_percent();
            if(result != MMI_TRUE)
            {
                return;
            }
        }

        if(g_single.track == MDI_VIDEO_TRACK_A_ONLY)
        {
            g_single.height = 0;
            g_single.width = 0;
        }

        video_layer_info.video_height = g_single.height;
        video_layer_info.video_width = g_single.width;
        mmi_medply_main_screen_get_video_parameter(&video_layer_info);

        /* since we might have to seek to far away from begining, so we use non_block seek*/
        result = mmi_medply_adption_video_non_block_seek_and_get_frame(
                g_single.current_time,
                video_layer_info.layer_hdl,
                    #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
                    video_layer_info.layer_subtitle_hdl,
                    #endif
                    mmi_medply_single_pdl_video_seek_callback_hdlr,
                    0);

        if(result == MDI_RES_VDOPLY_PROGRESSIVE_FILE_NOT_ENOUGH)
        {
            mmi_medply_single_pdl_video_buffer_for_seek_file();
        }

        if(result >= 0)
        {
            return;
        }

    }

    mmi_medply_display_popup(result,MMI_FALSE);
    mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);

    return;

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_video_pause
 * DESCRIPTION
 *  pause video fucntion, actually it stops video file but not reset time
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_pdl_video_pause(void)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MDI_RESULT result;
    mmi_medply_video_play_para_struct video_layer_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDLV_PAUSE);

    /*stop video*/
    result = mdi_video_ply_stop();

    #ifdef __MMI_A2DP_SUPPORT__
        mmi_medply_bt_stop(MMI_FALSE);
    #endif

    if(result == MDI_RES_VDOPLY_ALREADY_FINISHED)
    {
        g_single.current_time = 0;
    #ifdef __DRM_SUPPORT__
        g_single.DRM_consumed = MMI_FALSE;
    #endif
    }
    else
    {    
        /* set current time to lastest */
        mdi_video_ply_get_cur_play_time(&g_single.current_time);
        if(g_single.current_time > g_single.duration)
        {
            g_single.duration = g_single.current_time;
        }
    }

    mmi_medply_main_screen_blt();
    mmi_medply_single_set_continue_flag(MMI_FALSE);
    mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_READY);

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_video_do_play_action
 * DESCRIPTION
 *  do paly pdl video main function
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_pdl_video_do_play_action(void)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MDI_RESULT result;
    mmi_medply_video_play_para_struct video_layer_info;
    S32 percentage;
    U8 volume = g_single.volume;
    BOOL is_play_audio = TRUE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    result = mdi_video_progressive_get_buf_percentage(&percentage);

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDLV_PLAY, result, percentage, g_single.mute);

    if(result<0)
    {
        mmi_medply_display_popup(result,MMI_FALSE);
        return;        
    }

    if(percentage <100)
    {
        StartTimer(MEDPLY_PDL_BUFFER_TIMER, 100, mmi_medply_single_pdl_video_update_buffer_percent);
        mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING);
        return;
    }


#ifdef __DRM_SUPPORT__
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_DRM_CONSUMED, g_single.DRM_consumed);
    if (g_single.DRM_consumed)
    {
        mdi_video_ply_drm_disable_consume_count();
    }
    else
    {
        g_single.DRM_consumed = MMI_TRUE;
    }
#endif /* __DRM_SUPPORT__ */

    if(g_single.mute)
    {
        volume = 0;
    }

    mdi_audio_set_volume(MDI_VOLUME_MEDIA, MDI_AUD_VOL_EX_MUTE(volume));

    /*turn on backlight to make sure video will not play in LCD turn off situation*/
    srv_backlight_turn_on(SRV_BACKLIGHT_SHORT_TIME);

    video_layer_info.video_height = g_single.height;
    video_layer_info.video_width = g_single.width;
    mmi_medply_main_screen_get_video_parameter(&video_layer_info);

#if defined(__RF_DESENSE_TEST__) && defined(__MMI_BACKGROUND_CALL__)
    if (srv_ucm_is_background_call())
    {
        is_play_audio = FALSE;
    }
#endif /* defined(__RF_DESENSE_TEST__) && defined(__MMI_BACKGROUND_CALL__) */


    result = mmi_medply_adption_video_play(
            video_layer_info.layer_hdl,                  /* play layer handle */
            video_layer_info.layer_blt_flag,             /* blt layer flag */
            video_layer_info.layer_play_flag,            /* play layer flag */
            #ifdef __MMI_VIDEO_SUBTITLE_SUPPORT__
            video_layer_info.layer_subtitle_hdl,         /* subtitle layer handle */
            video_layer_info.layer_subtitle_flag,        /* subtitle layer flag */
            #endif
            1,                                           /* repeat */
            TRUE,                                        /* visual update */
            is_play_audio,                               /* play aud */
            MDI_DEVICE_SPEAKER2,                         /* audio path */
            video_layer_info.layer_lcd_rotate,           /* rotate */
            100,                                         /* speed factor */
            mmi_medply_single_pdl_video_play_callback_hdlr,
            0); 

    if(result >= 0)
    {
        if(result == MDI_RES_VDOPLY_PROGRESSIVE_FILE_NOT_ENOUGH)
        {
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif
            StartTimer(MEDPLY_PDL_BUFFER_TIMER, 100, mmi_medply_single_pdl_video_update_buffer_percent);
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING);
            return;
        }

        mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PLAY);
        return;
    }
    else
    {
    #ifdef __DRM_SUPPORT__    
         g_single.DRM_consumed = MMI_FALSE;
    #endif

    #ifdef __MMI_A2DP_SUPPORT__
        mmi_medply_bt_stop(MMI_FALSE);
    #endif

        mmi_medply_display_popup(result,MMI_FALSE);
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_video_play
 * DESCRIPTION
 *  paly video main function
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_pdl_video_play(void)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MDI_RESULT result;
    S32 percentage;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    result = mdi_video_progressive_get_buf_percentage(&percentage);

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDLV_PLAY, result, percentage, g_single.mute);

    if(result<0)
    {
        mmi_medply_display_popup(result,MMI_FALSE);
        return;        
    }

    if(percentage <100)
    {
        StartTimer(MEDPLY_PDL_BUFFER_TIMER, 100, mmi_medply_single_pdl_video_update_buffer_percent);
        mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING);
        return;
    }

#ifdef __MMI_A2DP_SUPPORT__
    if( mmi_medply_settings_is_output_to_bt())
    {
        MMI_BOOL is_stereo;   
        
        if (g_single.aud_channel_no == 2)
        {
            is_stereo = MMI_TRUE;
        }
        else
        {
            is_stereo = MMI_FALSE;
        }
        
        switch(g_single.state)
        {
            case SINGLE_STATE_PDL_VIDEO_PLAY_SEEKING:
            case SINGLE_STATE_PDL_VIDEO_READY:
            case SINGLE_STATE_PDL_VIDEO_PAUSE_SEEKING: /*for full screen case*/
            case SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING:
            {
                if(g_single.track != MDI_VIDEO_TRACK_V_ONLY)
                {
                    mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_BT_CONNECTING);

                    /*put this behind enter states because some times it will callback directly with in 
                    this function, in that case, entering bt connecting state would be too late*/        
                    av_bt_open_ex(
                          mmi_medply_settings_get_bt_headset(),
                          g_single.aud_sample_rate,
                         (kal_bool)is_stereo,
                         mmi_medply_single_bt_open_callback,
                         KAL_TRUE);
                }
                else
                {
                    mmi_medply_single_pdl_video_do_play_action();
                    return;
                }
                break;
            }

            default:
                break;
        }

    }
    else
#endif /* __MMI_A2DP_SUPPORT__ */
    {
        switch(g_single.state)
        {
            case SINGLE_STATE_PDL_VIDEO_PLAY_SEEKING:
            case SINGLE_STATE_PDL_VIDEO_READY:
            case SINGLE_STATE_PDL_VIDEO_PAUSE_SEEKING: /*for full screen case*/
            case SINGLE_STATE_PDL_VIDEO_PLAY_BUFFERING:
            {        
                mmi_medply_single_pdl_video_do_play_action();
                break;
            }

            default:
                break;
        }
    }

    return;

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_video_open
 * DESCRIPTION
 *  open pdl video file
 * PARAMETERS
 *  void
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
MMI_BOOL mmi_medply_single_pdl_video_open(void)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MDI_RESULT result;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

#ifdef __DRM_SUPPORT__
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_DRM_CONSUMED, g_single.DRM_consumed);
    if (g_single.DRM_consumed)
    {
        mdi_video_ply_drm_disable_consume_count();            
    }
#endif /* __DRM_SUPPORT__ */

    result = mdi_video_progressive_open_file(0, (CHAR*)g_single.filefullpath, mmi_medply_single_pdl_video_open_callback_hdlr, 0);

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDLV_OPEN, result);

    if(result<0)
    {
        /*error happened*/
        mmi_medply_display_popup(result,MMI_FALSE);
        mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
        return MMI_FALSE;
    }

    mmi_medply_enter_single_states(SINGLE_STATE_PDL_VIDEO_OPENING);
    return MMI_TRUE;

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_play_pdl_vidoe_file
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/

void mmi_medply_single_play_pdl_vidoe_file(UI_string_type filename)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PLAY_PDLV_FILE);

#ifndef __RF_DESENSE_TEST__
    if (srv_ucm_query_call_count(SRV_UCM_INCOMING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0 ||
        srv_ucm_query_call_count(SRV_UCM_OUTGOING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0 ||
        srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_NO_CSD, NULL) > 0)
    {
        mmi_medply_display_popup_with_sg(STR_GLOBAL_CURRENTLY_NOT_AVAILABLE_IN_CALL, MMI_EVENT_FAILURE);
        srv_da_stop_pdl(g_single.pdl_session_id);
        g_single.pdl_session_id = -1;
        g_single.pdl_state = MEDPLY_PDL_STATE_EXIT;            
        return;
    }
#endif

#ifdef __DM_LAWMO_SUPPORT__
    if(mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_PARTIALLYLOCK || mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_ON_LOCKING)
    {
        MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_LAWMO_LOCK);
        srv_da_stop_pdl(g_single.pdl_session_id);
        g_single.pdl_session_id = -1;
        g_single.pdl_state = MEDPLY_PDL_STATE_EXIT;
        return;
    }
#endif

#ifdef __USB_IN_NORMAL_MODE__
    if (srv_usb_is_in_mass_storage_mode())
    {
        /* in mass storage mode */
        if (srv_usb_check_path_exported((WCHAR*)filename))
        {
        /* file is in exported device */
            MMI_STR_ID string_id = 0;
            mmi_event_notify_enum event_type = MMI_EVENT_DEFAULT;
            MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_MASS_STORAGE_MODE);
            string_id = mmi_usb_get_error_info(SRV_USB_ERROR_UNAVAILABLE, &event_type);
            mmi_medply_display_popup_with_sg((U16)string_id, event_type);
            srv_da_stop_pdl(g_single.pdl_session_id);
            g_single.pdl_session_id = -1;
            g_single.pdl_state = MEDPLY_PDL_STATE_EXIT;            
            return;
        }
    }
#endif /* __USB_IN_NORMAL_MODE__ */ 

    //mmi_medply_single_group_screen_enter();
    //Put a dummy group here, keep the old behavior
    mmi_frm_group_create_ex(GRP_ID_ROOT, GRP_ID_AUTO_GEN, NULL, NULL,  MMI_FRM_NODE_SMART_CLOSE_FLAG);

    g_single.media_type = MEDPLY_TYPE_PDL_VIDEO;

#ifdef __DRM_SUPPORT__
    g_single.DRM_consumed = MMI_FALSE;
#endif /*__DRM_SUPPORT__*/

#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
    g_single.intro_play = MMI_FALSE;
#endif


    g_single.continue_to_play = MMI_TRUE;
    g_single.seekable = MMI_TRUE;
    g_single.build_cache_failed = MMI_FALSE;
    g_single.current_time = 0;
    g_single.duration = 0;    
    g_single.is_short = MMI_FALSE;
    g_single.pdl_video_max_play_time = 0;

    g_single.need_to_build_cache = MMI_FALSE;

    memset(g_single.specified_title, 0, sizeof(g_single.specified_title));

    //mmi_medply_single_enter_main_screen();
    //use launch to cover OOM problem;
    mmi_medply_single_launch();

}
#endif /*__MMI_VIDEO_PDL__*/

#ifdef __MMI_AUDIO_PDL__

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_audio_update_buffer_percent
 * DESCRIPTION
 *  start a timer to update buffer percentage
 * PARAMETERS
 *  
 * RETURNS
 * 
 *****************************************************************************/
static void mmi_medply_single_pdl_audio_update_buffer_percent()
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 percentage;
    mdi_result result;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_ASSERT(g_single.state == SINGLE_STATE_PDL_AUDIO_BUFFERING);

    result = mdi_audio_mma_pdl_get_buf_percent(g_single.pdl_audio_handle, 5, &percentage);

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDLA_UPDATE_BUF_PERCENT, result, percentage);

    if(result<0)
    {
        mmi_medply_display_popup(result,MMI_FALSE);
        return;        
    }

    /*update progress bar*/
    mmi_medply_main_screen_show_loading(percentage);

    if(percentage <100)
    {
        StartTimer(MEDPLY_PDL_BUFFER_TIMER, 300, mmi_medply_single_pdl_audio_update_buffer_percent);
    }
    else
    {
        /* sleep 30ms to let 100% progress bar show longer */
        kal_sleep_task(30);

        mmi_medply_main_screen_stop_animation(MMI_MEDPLY_ANI_LOADING);
        
        mmi_medply_single_pdl_audio_play();
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_audio_callback_hdlr
 * DESCRIPTION
 *  to handle all pdl audio mma callback
 * PARAMETERS
 *
 *
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_pdl_audio_callback_hdlr(kal_int32 handle, kal_int32 result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_ASSERT(g_single.pdl_audio_handle  == handle);

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDLA_CALLBACK, result, g_single.state);

    switch(result)
    {
        /*under flow*/
        case MDI_AUDIO_BUFFER_INSUFFICIENT:
        {
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            StartTimer(MEDPLY_PDL_BUFFER_TIMER, 100, mmi_medply_single_pdl_audio_update_buffer_percent);
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_AUDIO_BUFFERING);
            break;
        }

        case MDI_AUDIO_END_OF_FILE:
        {
            if(!g_medply.fullscreen)
            {
                g_single.current_time= g_single.duration;
                mmi_medply_main_screen_draw_duration();
                mmi_medply_main_screen_blt();
            }
            else
            {
                mmi_medply_main_screen_set_full_screen(MMI_FALSE);

                g_medply.fullscreen = MMI_FALSE;

                /*register key hdlr*/
                mmi_medply_register_key_hdlrs(MMI_MEDPLY_SCREEN_NORMAL);
            }

            g_single.current_time = 0;
        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif /*__DRM_SUPPORT__*/    

        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mmi_medply_enter_single_states(SINGLE_STATE_PDL_AUDIO_READY);
            break;
        }

        case MDI_AUDIO_DUR_UPDATED:
        {
            break;
        }

        case MDI_AUDIO_TERMINATED:
        {
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif
            mmi_medply_enter_single_states(SINGLE_STATE_PDL_AUDIO_READY);
            break;
        }

        /*error happened*/
        default:
        {
            g_single.current_time = 0;
        #ifdef __DRM_SUPPORT__
            g_single.DRM_consumed = MMI_FALSE;
        #endif /*__DRM_SUPPORT__*/
            mmi_medply_display_popup(result,MMI_FALSE);
            break;
        }
    }

    return;

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_audio_do_play_action
 * DESCRIPTION
 *  do paly pdl audio main function
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_pdl_audio_do_play_action(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 percentage ;
    mdi_result result = MDI_AUDIO_SUCCESS;
    U8 volume = g_single.volume;    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    mdi_audio_mma_set_start_time(g_single.pdl_audio_handle,g_single.current_time);

    if(g_single.pdl_state == MEDPLY_PDL_STATE_FINISHED)
    {
        percentage = 100 ;
    }
    else
    {
        result = mdi_audio_mma_pdl_get_buf_percent(g_single.pdl_audio_handle, 5, &percentage);
    }

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDLA_PLAY, result, percentage, g_single.current_time, g_single.mute);

    if(result != MDI_AUDIO_SUCCESS)
    {
        mmi_medply_display_popup(result,MMI_FALSE);
    }

    if(percentage != 100)
    {
        StartTimer(MEDPLY_PDL_BUFFER_TIMER, 100, mmi_medply_single_pdl_audio_update_buffer_percent);
        mmi_medply_enter_single_states(SINGLE_STATE_PDL_AUDIO_BUFFERING);
        return;
    }

#ifdef __DRM_SUPPORT__
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_DRM_CONSUMED, g_single.DRM_consumed);
    if (g_single.DRM_consumed)
    {
        mdi_audio_drm_disable_consume_count();            
    }
    else
    {
        g_single.DRM_consumed = MMI_TRUE;
    }
#endif /* __DRM_SUPPORT__ */

    if(g_single.mute)
    {
        volume = 0;
    }

    mdi_audio_set_volume(MDI_VOLUME_MEDIA, MDI_AUD_VOL_EX_MUTE(volume));

    result = mdi_audio_mma_play(g_single.pdl_audio_handle);

    if(result == MDI_AUDIO_SUCCESS)
    {
        mmi_medply_enter_single_states(SINGLE_STATE_PDL_AUDIO_PLAY);
        return;
    }
    else if(result == MDI_AUDIO_BUFFER_INSUFFICIENT)
    {

    #ifdef __MMI_A2DP_SUPPORT__
        mmi_medply_bt_stop(MMI_FALSE);
    #endif

        StartTimer(MEDPLY_PDL_BUFFER_TIMER, 100, mmi_medply_single_pdl_audio_update_buffer_percent);
        mmi_medply_enter_single_states(SINGLE_STATE_PDL_AUDIO_BUFFERING);
    }
    else if(result == MDI_AUDIO_END_OF_FILE)
    {
        if(!g_medply.fullscreen)
        {
            g_single.current_time= g_single.duration;
            mmi_medply_main_screen_draw_duration();
            mmi_medply_main_screen_blt();
        }
        else
        {
            mmi_medply_main_screen_set_full_screen(MMI_FALSE);

            g_medply.fullscreen = MMI_FALSE;

            /*register key hdlr*/
            mmi_medply_register_key_hdlrs(MMI_MEDPLY_SCREEN_NORMAL);
        }

    #ifdef __MMI_A2DP_SUPPORT__
        mmi_medply_bt_stop(MMI_FALSE);
    #endif

        g_single.current_time = 0;
    #ifdef __DRM_SUPPORT__
        g_single.DRM_consumed = MMI_FALSE;
    #endif /*__DRM_SUPPORT__*/            
        mmi_medply_enter_single_states(SINGLE_STATE_PDL_AUDIO_READY);
    }
    else
    {
    #ifdef __DRM_SUPPORT__    
         g_single.DRM_consumed = MMI_FALSE;
    #endif
        mmi_medply_display_popup(result,MMI_FALSE);
    }

    return;

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_audio_play
 * DESCRIPTION
 *  paly pdl audio main function
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_single_pdl_audio_play(void)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 percentage ;
    mdi_result result = MDI_AUDIO_SUCCESS;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    mdi_audio_mma_set_start_time(g_single.pdl_audio_handle,g_single.current_time);

    if(g_single.pdl_state == MEDPLY_PDL_STATE_FINISHED)
    {
        percentage = 100 ;
    }
    else
    {
        result = mdi_audio_mma_pdl_get_buf_percent(g_single.pdl_audio_handle, 5, &percentage);
    }

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDLA_PLAY, result, percentage, g_single.current_time, g_single.mute);

    if(result != MDI_AUDIO_SUCCESS)
    {
        mmi_medply_display_popup(result,MMI_FALSE);
    }

    if(percentage != 100)
    {
        StartTimer(MEDPLY_PDL_BUFFER_TIMER, 100, mmi_medply_single_pdl_audio_update_buffer_percent);
        mmi_medply_enter_single_states(SINGLE_STATE_PDL_AUDIO_BUFFERING);
        return;
    }

#ifdef __MMI_A2DP_SUPPORT__
    if( mmi_medply_settings_is_output_to_bt() )
    { 
        mmi_medply_enter_single_states(SINGLE_STATE_PDL_AUDIO_BT_CONNECTING);

        av_bt_open(mmi_medply_settings_get_bt_headset(), g_single.filefullpath,
            mmi_medply_single_bt_open_callback, KAL_TRUE,KAL_TRUE);
        return;
    }
    else
#endif /* __MMI_A2DP_SUPPORT__ */
    {
        mmi_medply_single_pdl_audio_do_play_action();
    }

    return;

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_audio_open
 * DESCRIPTION
 *  open pdl audio file
 * PARAMETERS
 *  void
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
MMI_BOOL mmi_medply_single_pdl_audio_open(void)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mdi_handle handle = NULL;
    MMI_BOOL audio_pdl = MMI_TRUE;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(g_single.pdl_state == MEDPLY_PDL_STATE_FINISHED)
    {
        audio_pdl = MMI_FALSE;
    }

    mdi_audio_set_headset_mode_output_path(MDI_DEVICE_SPEAKER2);

    handle = mdi_audio_mma_open_file(0, g_single.filefullpath,1, audio_pdl, mmi_medply_single_pdl_audio_callback_hdlr, NULL);

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDLA_OPEN,handle,audio_pdl);

    if(handle == NULL)
    {
        /*error happened*/
        mmi_medply_display_popup(STR_GLOBAL_ERROR,MMI_FALSE);
        mmi_frm_group_close(GRP_ID_MEDPLY_SINGLE);
        return MMI_FALSE;
    }

    g_single.pdl_audio_handle = handle;
    mdi_audio_mma_set_cache_table(g_single.pdl_audio_handle,g_single_audio_cache);
    mmi_medply_enter_single_states(SINGLE_STATE_PDL_AUDIO_READY);
    return MMI_TRUE;

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_play_pdl_vidoe_file
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_play_pdl_audio_file(UI_string_type filename)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PLAY_PDLA_FILE);

#ifndef __RF_DESENSE_TEST__
    if (srv_ucm_query_call_count(SRV_UCM_INCOMING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0 ||
        srv_ucm_query_call_count(SRV_UCM_OUTGOING_STATE, SRV_UCM_CALL_TYPE_ALL, NULL) > 0 ||
        srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_NO_CSD, NULL) > 0)
    {
        mmi_medply_display_popup_with_sg(STR_GLOBAL_CURRENTLY_NOT_AVAILABLE_IN_CALL, MMI_EVENT_FAILURE);
        srv_da_stop_pdl(g_single.pdl_session_id);
        g_single.pdl_session_id = -1;
        g_single.pdl_state = MEDPLY_PDL_STATE_EXIT;            
        return;
    }
#endif

#ifdef __DM_LAWMO_SUPPORT__
    if(mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_PARTIALLYLOCK || mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_ON_LOCKING)
    {
        MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_LAWMO_LOCK);
        srv_da_stop_pdl(g_single.pdl_session_id);
        g_single.pdl_session_id = -1;
        g_single.pdl_state = MEDPLY_PDL_STATE_EXIT;
        return;
    }
#endif

#ifdef __USB_IN_NORMAL_MODE__
    if (srv_usb_is_in_mass_storage_mode())
    {
        /* in mass storage mode */
        if (srv_usb_check_path_exported((WCHAR*)filename))
        {
            /* file is in exported device */
            MMI_STR_ID string_id = 0;
            mmi_event_notify_enum event_type = MMI_EVENT_DEFAULT;
            MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_MASS_STORAGE_MODE);
            string_id = mmi_usb_get_error_info(SRV_USB_ERROR_UNAVAILABLE, &event_type);
            mmi_medply_display_popup_with_sg((U16)string_id, event_type);
            srv_da_stop_pdl(g_single.pdl_session_id);    
            g_single.pdl_session_id = -1;
            g_single.pdl_state = MEDPLY_PDL_STATE_EXIT;

            return;
        }
    }
#endif /* __USB_IN_NORMAL_MODE__ */ 

    //mmi_medply_single_group_screen_enter();
    //Put a dummy group here, keep the old behavior
    mmi_frm_group_create_ex(GRP_ID_ROOT, GRP_ID_AUTO_GEN, NULL, NULL,  MMI_FRM_NODE_SMART_CLOSE_FLAG);

    g_single.media_type = MEDPLY_TYPE_PDL_AUDIO;

#ifdef __DRM_SUPPORT__
    g_single.DRM_consumed = MMI_FALSE;
#endif /*__DRM_SUPPORT__*/

#ifdef __MMI_MEDIA_PLAYER_INTRO_PLAY__
    g_single.intro_play = MMI_FALSE;
#endif


    g_single.continue_to_play = MMI_TRUE;
    g_single.need_to_build_cache = MMI_FALSE;
    g_single.seekable = MMI_FALSE;
    g_single.build_cache_failed = MMI_FALSE;
    g_single.duration = 0;
    g_single.current_time = 0;
    g_single.is_short = MMI_FALSE;
    memset( g_single_audio_cache, 0, MEDPLY_BUILD_CACHE_SIZE ); 

    memset(g_single.specified_title, 0, sizeof(g_single.specified_title));

    //mmi_medply_single_enter_main_screen();
    //use launch to cover OOM problem;
    mmi_medply_single_launch();

}
#endif /*__MMI_AUDIO_PDL__*/

#if defined(__MMI_DOWNLOAD_AGENT__) && (defined(__MMI_VIDEO_PDL__) || defined(__MMI_AUDIO_PDL__))
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_da_report_hdlr
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_pdl_da_report_hdlr(
                S32 session_id,
                S32 status,
                S32 cause,
                U32 seq_num,
                U32 acc_size, 
                U32 total_size)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 scr_id;
    PU8 str_ptr;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDL_DA_REPORT,status,g_single.pdl_state,g_single.pdl_media_type);

    switch (status)
    {
        case SRV_DA_STATE_DOWNLOADING:
            MMI_ASSERT(session_id == g_single.pdl_session_id);            
            if (g_single.pdl_state == MEDPLY_PDL_STATE_EXIT)
            {
                if (srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_CALL_TYPE_NO_CSD, NULL) > 0)
                {
                    /* this may happened when WAP send message to DA, at this time, a call happened */
                    srv_da_stop_pdl(g_single.pdl_session_id);
                    g_single.pdl_session_id = -1;
                    return;
                }
                
                g_single.pdl_state = MEDPLY_PDL_STATE_DOWNLOADING;

                switch(g_single.pdl_media_type)
                {
                    case MEDPLY_PDL_TYPE_AUDIO:
                    {
                    #ifdef __MMI_AUDIO_PDL__
                        mmi_medply_single_play_pdl_audio_file(g_single.filefullpath);
                    #endif
                        break;
                    }

                    case MEDPLY_PDL_TYPE_VIDEO:
                    {
                    #ifdef __MMI_VIDEO_PDL__
                        mmi_medply_single_play_pdl_vidoe_file(g_single.filefullpath);
                    #endif
                        break;  
                    }
                }

            }
            break;

        case SRV_DA_STATE_COMPLETE:
            MMI_ASSERT(session_id == g_single.pdl_session_id);
            /*handle file too small so that the first report is complete*/
            if(g_single.pdl_state == MEDPLY_PDL_STATE_EXIT)
            {
                g_single.pdl_session_id = -1;
            #ifdef __MMI_MEDIA_PLAYER_AUDIO__
                if(g_single.pdl_media_type == MEDPLY_PDL_TYPE_AUDIO)
                {
                    mmi_medply_single_play_audio(g_single.filefullpath,NULL);
                }
            #endif
            #ifdef __MMI_MEDIA_PLAYER_VIDEO__
                if(g_single.pdl_media_type == MEDPLY_PDL_TYPE_VIDEO)
                {
                    mmi_medply_single_play_video(g_single.filefullpath,MMI_FALSE);
                }
            #endif
                break;
            }

            g_single.pdl_state = MEDPLY_PDL_STATE_FINISHED;  
            g_single.pdl_session_id = -1;
        #ifdef __MMI_MEDIA_PLAYER_AUDIO__            
            if(g_single.pdl_media_type == MEDPLY_PDL_TYPE_AUDIO && g_single.pdl_audio_handle != NULL)
            {
                mdi_audio_mma_pdl_write_data_ind(g_single.pdl_audio_handle, MMI_TRUE);
            }
        #endif
            break;

        case SRV_DA_STATE_PAUSE:
        case SRV_DA_STATE_ABORT:
            g_single.pdl_state = MEDPLY_PDL_STATE_EXIT;
            
            if (cause == SRV_DA_ERROR_DISK_FULL)
            {
                str_ptr = (PU8)GetString(FMGR_FS_DISK_FULL_TEXT);
            }
            else
            {
                str_ptr = (PU8)GetString(STR_GLOBAL_FAILED_TO_SAVE);
            }

            /*if in history, then delete screen up to single player screen*/
            scr_id = GetExitScrnID();
            if(scr_id == SCR_ID_MEDPLY_SINGLE_MAIN)
            {
                mmi_popup_display_simple((WCHAR*) str_ptr, MMI_EVENT_FAILURE, GRP_ID_MEDPLY_SINGLE, NULL);
            }

            /* delete up to the prvious screen of video player */
            if(mmi_frm_scrn_is_present(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
            {
                mmi_frm_scrn_close(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN);
            }
            g_single.pdl_session_id = -1;

            break;

        case SRV_DA_STATE_USER_CANCEL:
        {
            g_single.pdl_session_id = -1;
            break;
        }

        default:
        {
            MMI_ASSERT(0);
            break;
        }

    }

}

#ifdef __MMI_VIDEO_PDL__
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_da_video_filepath_hdlr
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static BOOL mmi_medply_single_pdl_da_video_filepath_hdlr(
                S32 session_id,
                S32 mime_type, 
                S32 mime_subtype, 
                PU16 filepath)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDL_DA_FILEPATH);

    if (g_single.pdl_session_id == -1 || g_single.pdl_state == MEDPLY_PDL_STATE_EXIT)
    {
        /* start a new session or resume download, the session id of current context will be -1 */
        /* or pdl_dl_state== exit becuz d/l agent won't reported during call                    */
        g_single.pdl_session_id = session_id;
    }
    else
    {
        MMI_ASSERT(session_id == g_single.pdl_session_id);
    }

    mmi_ucs2cpy((CHAR*)g_single.filefullpath, (CHAR*)filepath);
    g_single.pdl_media_type = MEDPLY_PDL_TYPE_VIDEO;

    return TRUE;

}

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_sinlge_pdl_da_notify_video_file
 * DESCRIPTION
 *  download agent callback for video file (3GP)
 * PARAMETERS
 *  
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_sinlge_pdl_da_notify_video_file(
    	S32	session_id,
    	S32	mime_type,                  
    	S32	mime_subtype, 
    	S32 action,
    	U32	filesize,
    	CHAR*	url,                        
    	CHAR*	mime_type_string,           
    	U32	content_len,
    	CHAR*	content,
    	srv_da_setting_struct *settings_p)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL is_pdl;
#ifdef __MMI_VIDEO_PDL_YOUTUBE__
    applib_url_struct url_info;
#endif 

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/  
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDL_DA_VDO_FILE, action, g_single.state);

    srv_da_default_setting(
        session_id,
        mime_type,
        mime_subtype,
        action,
        filesize,
        url,
        mime_type_string,
        content_len,
        content,
        settings_p);
        
    if (action == MMI_DA_WAP_DOWNLOAD)
    {
        mdi_video_progressive_is_pdl_format((PU8)content, content_len, &is_pdl);

    #ifdef __MMI_VIDEO_PDL_YOUTUBE__
        if (!(S32)(applib_parse_url((CHAR*) url, &url_info)))
        {
            if ((strstr(app_strtolower((kal_char*)(url_info.parts[APPLIB_URL_HOST_PART])), "youtube")))
            {
                mdi_video_progressive_scramble_buffer((U8*)content, (S32)content_len);
            }
        }
    #endif 
        if (is_pdl)
        {
            /*to prevent from re-entry*/
            if(mmi_frm_scrn_is_present(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
            {
                mmi_frm_scrn_close(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN);
            }
            if (g_single.state != SINGLE_STATE_IDLE)
            {
                /*it means current screen is media player, do not support this case*/
                return;
            }

            /* is progressive dl 3gp and it is from WAP download */

            settings_p->bypass = MMI_DA_BYPASS_FALSE;                                      /* bypass */
            settings_p->default_filename = MMI_FALSE;                            /* incoming's name, user can edit */
            settings_p->filepath_hdlr = mmi_medply_single_pdl_da_video_filepath_hdlr;  /* notify where is the file */
            settings_p->report_hdlr = mmi_medply_single_pdl_da_report_hdlr;      /* download status report */
            settings_p->percentage_bar = MMI_FALSE;                       /* do not show process bar */
            settings_p->storage = SRV_DA_STORAGE_NONE;                    /* let user choose storage */
            settings_p->drv = 0;                                          /* not usesed if storage is none*/
            settings_p->keepfile = MMI_TRUE;                                  /* keep file when cancel */
            settings_p->can_minimize = MMI_TRUE;
            mmi_ucs2cpy((CHAR*)settings_p->folder, (CHAR*)FMGR_DEFAULT_FOLDER_VIDEO);

            return;
        }
    }
}
#endif /*__MMI_VIDEO_PDL__*/

#ifdef __MMI_AUDIO_PDL__
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_pdl_da_audio_filepath_hdlr
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static BOOL mmi_medply_single_pdl_da_audio_filepath_hdlr(
                S32 session_id,
                S32 mime_type, 
                S32 mime_subtype, 
                PU16 filepath)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDL_DA_FILEPATH);

    if (g_single.pdl_session_id == -1 || g_single.pdl_state == MEDPLY_PDL_STATE_EXIT)
    {
        /* start a new session or resume download, the session id of current context will be -1 */
        /* or pdl_dl_state== exit becuz d/l agent won't reported during call                    */
        g_single.pdl_session_id = session_id;
    }
    else
    {
        MMI_ASSERT(session_id == g_single.pdl_session_id);
    }

    mmi_ucs2cpy((CHAR*)g_single.filefullpath, (CHAR*)filepath);
    g_single.pdl_media_type = MEDPLY_PDL_TYPE_AUDIO;

    return TRUE;

}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_sinlge_pdl_da_notify_audio_file
 * DESCRIPTION
 *  download agent callback for audio file
 * PARAMETERS
 *  
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_medply_sinlge_pdl_da_notify_audio_file(
    	S32	session_id,
    	S32	mime_type,                  
    	S32	mime_subtype, 
    	S32 action,
    	U32	filesize,
    	CHAR*	url,                        
    	CHAR*	mime_type_string,           
    	U32	content_len,
    	CHAR* content,
    	srv_da_setting_struct *settings_p)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_PDL_DA_AUD_FILE, action, g_single.state);

    srv_da_default_setting(
        session_id,
        mime_type,
        mime_subtype,
        action,
        filesize,
        url,
        mime_type_string,
        content_len,
        content,
        settings_p);
        
    if (action == MMI_DA_WAP_DOWNLOAD)
    {
        /*to prevent from re-entry*/
        if(mmi_frm_scrn_is_present(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN, MMI_FRM_NODE_EXCLUDE_ACTIVE_SCRN_FLAG))
        {
            mmi_frm_scrn_close(GRP_ID_MEDPLY_SINGLE, SCR_ID_MEDPLY_SINGLE_MAIN);
        }

        if (g_single.state != SINGLE_STATE_IDLE)
        {
            /*it means current screen is media player, do not support this case*/
            return;
        }

        settings_p->bypass = MMI_DA_BYPASS_FALSE;                                      /* bypass */
        settings_p->default_filename = MMI_FALSE;                            /* incoming's name, user can edit */
        settings_p->filepath_hdlr = mmi_medply_single_pdl_da_audio_filepath_hdlr;  /* notify where is the file */
        settings_p->report_hdlr = mmi_medply_single_pdl_da_report_hdlr;      /* download status report */
        settings_p->percentage_bar = MMI_FALSE;                       /* do not show process bar */
        settings_p->storage = SRV_DA_STORAGE_NONE;                    /* let user choose storage */
        settings_p->drv = 0;                                          /* not usesed if storage is none*/
        settings_p->keepfile = MMI_TRUE;                                  /* keep file when cancel */
        settings_p->can_minimize = MMI_TRUE;
        mmi_ucs2cpy((CHAR*)settings_p->folder, (CHAR*)FMGR_DEFAULT_FOLDER_AUDIO);

    }
}
#endif /*__MMI_AUDIO_PDL__*/

#endif /*defined(__MMI_DOWNLOAD_AGENT__) && (defined(__MMI_VIDEO_PDL__) || defined(__MMI_AUDIO_PDL__))*/

#ifdef __MMI_A2DP_SUPPORT__
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_bt_open_callback
 * DESCRIPTION
 *  a callback function invoked by av_bt_open apis
 * PARAMETERS
 *  result  [IN]
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_medply_single_bt_open_callback(S32 result)
{

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_BT_OPEN_CALLBACK_IN, result, g_single.state, g_medply.inquiry_paused, g_medply.bt_success_during_inquiry);

    mmi_medply_main_screen_stop_animation(MMI_MEDPLY_ANI_BT_CONNECTING);

    switch( result )
    {
        case AV_BT_CALLBACK_EVENT_OPEN_OK:
        {
            switch(g_single.state)
            {
            #ifdef __MMI_MEDIA_PLAYER_AUDIO__
                case SINGLE_STATE_AUDIO_BT_CONNECTING:
                {
                    av_bt_open_codec(KAL_FALSE);
                #if defined(__MMI_MEDIA_PLAYER_A2DP_BLOCK_SPECTRUM__) || defined(__MMI_MEDIA_PLAYER_A2DP_BLOCK_PITCH_SHIFT__)
                    g_medply.A2DP_blocked = MMI_TRUE;
                    #ifdef __MMI_MEDIA_PLAYER_A2DP_BLOCK_PITCH_SHIFT__
                    mmi_medply_block_pitch_shift();
                    #endif
                #endif    
                    mmi_medply_single_audio_do_play_action();
                    break;
                }

            #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/
            
            #ifdef __MMI_MEDIA_PLAYER_VIDEO__
                case SINGLE_STATE_VIDEO_BT_CONNECTING:
                {
                    av_bt_open_codec(KAL_FALSE);
                    mmi_medply_single_video_do_play_action();
                    break;
                }
            #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

            #ifdef __MMI_MEDIA_PLAYER_STREAM__
                case SINGLE_STATE_STREAM_BT_CONNECTING:
                {
                    av_bt_open_codec(KAL_FALSE);
                    mmi_medply_single_stream_do_buffer_action();
                    break;
                }
            #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

            #ifdef __MMI_VIDEO_PDL__
                case SINGLE_STATE_PDL_VIDEO_BT_CONNECTING:
                {
                    av_bt_open_codec(KAL_FALSE);
                    mmi_medply_single_pdl_video_do_play_action();
                    break;
                }
            #endif /*__MMI_VIDEO_PDL__*/

            #ifdef __MMI_AUDIO_PDL__
                case SINGLE_STATE_PDL_AUDIO_BT_CONNECTING:
                {
                    av_bt_open_codec(KAL_FALSE);
                    mmi_medply_single_pdl_audio_do_play_action();
                    break;
                }
            #endif /*__MMI_AUDIO_PDL__*/

            }
            break;
        }
                
        case AV_BT_CALLBACK_EVENT_OPEN_FAILED:
        case AV_BT_CALLBACK_EVENT_OPEN_STOPPED:
#ifdef __MMI_BT_AUDIO_VIA_SCO__
        case AV_BT_CALLBACK_EVENT_OPEN_SCO:
#endif
        {
            switch(g_single.state)
            {
            #ifdef __MMI_MEDIA_PLAYER_AUDIO__
                case SINGLE_STATE_AUDIO_BT_CONNECTING:
                {
                    mmi_medply_single_audio_do_play_action();
                    break;
                }

                case SINGLE_STATE_AUDIO_PLAY:
                {
                    av_bt_close_codec();
                #if defined(__MMI_MEDIA_PLAYER_A2DP_BLOCK_SPECTRUM__) || defined(__MMI_MEDIA_PLAYER_A2DP_BLOCK_PITCH_SHIFT__)
                    g_medply.A2DP_blocked = MMI_FALSE;
                    #ifdef __MMI_MEDIA_PLAYER_A2DP_BLOCK_SPECTRUM__
                    mmi_medply_main_screen_play_spectrum();
                    #endif
                    #ifdef __MMI_MEDIA_PLAYER_A2DP_BLOCK_PITCH_SHIFT__
                    mmi_medply_unblock_pitch_shift();
                    #endif
                #endif                        
                    break;
                }
            #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

            #ifdef __MMI_MEDIA_PLAYER_VIDEO__
                case SINGLE_STATE_VIDEO_BT_CONNECTING:
                {
                    mmi_medply_single_video_do_play_action();
                    break;
                }

                case SINGLE_STATE_VIDEO_PLAY:
                {
                    av_bt_close_codec();
                    break;
                }
            #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

            #ifdef __MMI_MEDIA_PLAYER_STREAM__
                case SINGLE_STATE_STREAM_BT_CONNECTING:
                {
                    mmi_medply_single_stream_do_buffer_action();
                    break;
                }

                case SINGLE_STATE_STREAM_PLAY:
                {
                    av_bt_close_codec();
                    break;
                }

            #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

            #ifdef __MMI_VIDEO_PDL__
                case SINGLE_STATE_PDL_VIDEO_BT_CONNECTING:
                {
                    mmi_medply_single_pdl_video_do_play_action();
                    break;
                }

                case SINGLE_STATE_PDL_VIDEO_PLAY:
                {
                    av_bt_close_codec();
                    break;
                }
            #endif /*__MMI_VIDEO_PDL__*/

            #ifdef __MMI_AUDIO_PDL__
                case SINGLE_STATE_PDL_AUDIO_BT_CONNECTING:
                {
                    mmi_medply_single_pdl_audio_do_play_action();
                    break;
                }

                case SINGLE_STATE_PDL_AUDIO_PLAY:
                {
                    av_bt_close_codec();
                    break;
                }
            #endif /*__MMI_AUDIO_PDL__*/

            }
            break;
        }

        case AV_BT_CALLBACK_EVENT_STREAM_ABORT_IND:
        case AV_BT_CALLBACK_EVENT_STREAM_CLOSE_IND:
        case AV_BT_CALLBACK_EVENT_STREAM_SUSPEND_IND:
        case AV_BT_CALLBACK_EVENT_UNEXPECTED_DISCONNECT_IND:
        {
            switch(g_single.state)
            {
            #ifdef __MMI_MEDIA_PLAYER_AUDIO__
                case SINGLE_STATE_AUDIO_BT_CONNECTING:
                {
                    mmi_medply_single_audio_do_play_action();
                    break;
                }

                case SINGLE_STATE_AUDIO_PLAY:
                {
                    av_bt_close_codec();
                #if defined(__MMI_MEDIA_PLAYER_A2DP_BLOCK_SPECTRUM__) || defined(__MMI_MEDIA_PLAYER_A2DP_BLOCK_PITCH_SHIFT__)
                    g_medply.A2DP_blocked = MMI_FALSE;
                    #ifdef __MMI_MEDIA_PLAYER_A2DP_BLOCK_SPECTRUM__
                    mmi_medply_main_screen_play_spectrum();
                    #endif
                    #ifdef __MMI_MEDIA_PLAYER_A2DP_BLOCK_PITCH_SHIFT__
                    mmi_medply_unblock_pitch_shift();
                    #endif
                #endif
                    break;
                }

            #endif /*__MMI_MEDIA_PLAYER_AUDIO__*/

            #ifdef __MMI_MEDIA_PLAYER_VIDEO__
                case SINGLE_STATE_VIDEO_BT_CONNECTING:
                {
                    mmi_medply_single_video_do_play_action();
                    break;
                }

                case SINGLE_STATE_VIDEO_PLAY:
                {
                    av_bt_close_codec();
                    break;
                }
            #endif /*__MMI_MEDIA_PLAYER_VIDEO__*/

            #ifdef __MMI_MEDIA_PLAYER_STREAM__
                case SINGLE_STATE_STREAM_BT_CONNECTING:
                {
                    mmi_medply_single_stream_do_buffer_action();
                    break;
                }

                case SINGLE_STATE_STREAM_BUFFERING:
                case SINGLE_STATE_STREAM_PLAY:
                {
                    av_bt_close_codec();
                    break;
                }
            #endif /*__MMI_MEDIA_PLAYER_STREAM__*/

            #ifdef __MMI_VIDEO_PDL__
                case SINGLE_STATE_PDL_VIDEO_BT_CONNECTING:
                {
                    mmi_medply_single_pdl_video_do_play_action();
                    break;
                }

                case SINGLE_STATE_PDL_VIDEO_PLAY:
                {
                    av_bt_close_codec();
                    break;
                }
            #endif /*__MMI_VIDEO_PDL__*/

            #ifdef __MMI_AUDIO_PDL__
                case SINGLE_STATE_PDL_AUDIO_BT_CONNECTING:
                {
                    mmi_medply_single_pdl_audio_do_play_action();
                    break;
                }

                case SINGLE_STATE_PDL_AUDIO_PLAY:
                {
                    av_bt_close_codec();
                    break;
                }
            #endif /*__MMI_AUDIO_PDL__*/

            }
            break;
        }

        /* Currently do not support */
        case AV_BT_CALLBACK_EVENT_STREAM_START_IND:
        {
            av_bt_close(KAL_FALSE);
            break;
        }

        /*this result means someone else is using mdi audio thus current playing is canceled, shall exit screen first*/
        case AV_BT_CALLBACK_EVENT_OPEN_CANCELED:
        /* Shall not happen */
        case AV_BT_CALLBACK_EVENT_INQUIRY_START_IND:
        case AV_BT_CALLBACK_EVENT_INQUIRY_STOP_IND:
        {
            break;
        }
    }

    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_BT_OPEN_CALLBACK_OUT,g_medply.inquiry_paused, g_medply.bt_success_during_inquiry);
}
#endif

#ifdef __MMI_AVRCP_SUPPORT__

/*****************************************************************************
 * FUNCTION
 *  mmi_medply_single_bt_avrcp_cmd_hdlr
 * DESCRIPTION
 *  
 * PARAMETERS
 *  command         [IN]        
 *  key_press       [IN]        
 * RETURNS
 *  U8
 *****************************************************************************/
static U8 mmi_medply_single_bt_avrcp_cmd_hdlr(U8 command, mmi_avrcp_key_events key_events)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 result = MMI_AVRCP_CR_ACCEPT;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_AVRCP_CMD,g_single.state,command,key_events);

#ifdef __USB_IN_NORMAL_MODE__
    /* check is in mass storage mode */
    if (srv_usb_is_in_mass_storage_mode())
    {
        MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_MASS_STORAGE_MODE);
        /* phone drive is exported, cant use this app, popup message in key up */
        if(key_events == MMI_AVRCP_KEY_UP)
        {
        #ifdef __MMI_MEDIA_PLAYER_FTE__
            MMI_STR_ID string_id = 0;
            mmi_event_notify_enum event_type = MMI_EVENT_DEFAULT;
            string_id = mmi_usb_get_error_info(SRV_USB_ERROR_UNAVAILABLE, &event_type);
            mmi_medply_display_popup_with_sg((U16)string_id, event_type);
        #else
            mmi_usb_app_unavailable_popup(0);   /* pass 0 will show default string */
        #endif
        }
        result = MMI_AVRCP_CR_REJECT;
        goto avrcp_finish;
    }
#endif /* __USB_IN_NORMAL_MODE__ */ 

#ifdef __DM_LAWMO_SUPPORT__
    if(mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_PARTIALLYLOCK || mmi_dmui_get_status(MMI_DMUI_MO_TYPE_LAWMO_LOCK) == MMI_DMUI_STATUS_LAWMO_LOCK_ON_LOCKING)
    {
        MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_LAWMO_LOCK);
        result = MMI_AVRCP_CR_REJECT;
        goto avrcp_finish;
    }
#endif

    switch(g_single.state)
    {
        case SINGLE_STATE_IDLE:
        case SINGLE_STATE_AUDIO_IN_HISTORY:
        case SINGLE_STATE_AUDIO_WAIT_ACTIVATE:
        case SINGLE_STATE_AUDIO_PLAY_WAIT_ACTIVATE:
        case SINGLE_STATE_VIDEO_IN_HISTORY:
        case SINGLE_STATE_STREAM_IN_HISTORY:
        case SINGLE_STATE_PDL_AUDIO_IN_HISTORY:
        case SINGLE_STATE_PDL_VIDEO_IN_HISTORY: 
        {
            result = MMI_AVRCP_CR_REJECT;
            goto avrcp_finish;
        }

        default:
        {
            if(g_medply.fullscreen)
            {
                switch (command)
                {
                    case MMI_AVRCP_POP_PLAY:
                    case MMI_AVRCP_POP_STOP:
                    case MMI_AVRCP_POP_PAUSE:
                    case MMI_AVRCP_POP_FORWARD:
                    case MMI_AVRCP_POP_BACKWARD:
                    case MMI_AVRCP_POP_FAST_FORWARD:
                    case MMI_AVRCP_POP_REWIND:
                    {
                        result = MMI_AVRCP_CR_REJECT;
                        mmi_medply_single_toggle_full_screen();
                        goto avrcp_finish;
                    }
                    default :
                        break;
                }
                break;
            }

            break;
        }
    }

    if (key_events == MMI_AVRCP_KEY_CANCELED)
    {
        switch (command)
        {
            case MMI_AVRCP_POP_PLAY:
            case MMI_AVRCP_POP_STOP:
            case MMI_AVRCP_POP_PAUSE:
            case MMI_AVRCP_POP_FORWARD:
            case MMI_AVRCP_POP_BACKWARD:
            case MMI_AVRCP_POP_FAST_FORWARD:
            case MMI_AVRCP_POP_REWIND:
                mmi_medply_single_press_button_canceled();
                break;
            default :
                break;
        }
        /*the return value do not mean anything in key canceled event*/
        result = MMI_AVRCP_CR_REJECT;
        goto avrcp_finish;
    }

    switch (command)
    {
        case MMI_AVRCP_POP_PLAY:
        {
            if (key_events == MMI_AVRCP_KEY_UP)
            {
                mmi_medply_single_press_play_button_up();
            }
            else if(key_events == MMI_AVRCP_KEY_DOWN)
            {
                mmi_medply_single_press_play_button_down();
            }
            break;
        }

        case MMI_AVRCP_POP_STOP:
        {
            if (key_events == MMI_AVRCP_KEY_UP)
            {
                mmi_medply_single_press_stop_button_up();
            }
            else if(key_events == MMI_AVRCP_KEY_DOWN)
            {
                mmi_medply_single_press_stop_button_down();
            }
            break;
        }

        case MMI_AVRCP_POP_PAUSE:
        {
            if (key_events == MMI_AVRCP_KEY_UP)
            {
                mmi_medply_single_press_play_button_up();
            }
            else if(key_events == MMI_AVRCP_KEY_DOWN)
            {
                mmi_medply_single_press_play_button_down();
            }
            break;
        }

        case MMI_AVRCP_POP_FORWARD:
        case MMI_AVRCP_POP_FAST_FORWARD:
            if (key_events == MMI_AVRCP_KEY_UP)
            {
                mmi_medply_single_press_next_button_up();
            }
            else if (key_events == MMI_AVRCP_KEY_DOWN)
            {
                mmi_medply_single_press_next_button_down();
            }            
            else if(key_events == MMI_AVRCP_KEY_LONGPRESS)
            {
                mmi_medply_single_fast_forward();
            }
            else
            {
                result = MMI_AVRCP_CR_REJECT;
            }
            break;

        case MMI_AVRCP_POP_BACKWARD:
        case MMI_AVRCP_POP_REWIND:
            if (key_events == MMI_AVRCP_KEY_UP)
            {
                mmi_medply_single_press_prev_button_up();
            }
            else if(key_events == MMI_AVRCP_KEY_DOWN)
            {
                mmi_medply_single_press_prev_button_down();
            }
            else if(key_events == MMI_AVRCP_KEY_LONGPRESS)
            {
                mmi_medply_single_rewind();
            }
            else
            {
                result = MMI_AVRCP_CR_REJECT;
            }
            break;

        default:
            result = MMI_AVRCP_CR_NOT_IMPLEMENT;
            break;
    }


avrcp_finish:
    MMI_TRACE(MMI_MEDIA_TRC_G3_APP_DETAIL, MMI_TRC_MEDPLY_CTL_AVRCP_RETURN,result);
    return result;

    
}
#endif /* __MMI_AVRCP_SUPPORT__ */ 

#ifdef __MMI_MEDIA_PLAYER_STREAM__
/*****************************************************************************
 * FUNCTION
 *  mmi_medply_bear_event_callback_hdlr
 * DESCRIPTION
 *  check if mediaplayer is currently playing or prepare to play
 * PARAMETERS
 *  void
 * RETURNS
 * MMI_BOOL
 *****************************************************************************/
void mmi_medply_single_bear_event_disconnect(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    #ifdef __TCPIP__
    U32 data_account_id;
    #endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(g_single.bearer_pause == MMI_TRUE)
    {
        return;
    }
    
    mmi_medply_single_set_continue_flag(MMI_FALSE);
    switch(g_single.state)
    {
        case SINGLE_STATE_STREAM_CONNECTING:
        {
            mdi_video_stream_disconnect();
            g_single.bearer_pause = MMI_TRUE;
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
            break;
        }

        case SINGLE_STATE_STREAM_CONNECTED:
        {
            mdi_video_stream_disconnect();
            g_single.bearer_pause = MMI_TRUE;
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);

            mmi_medply_main_screen_reset();
            mmi_medply_main_screen_blt();
            break;
        }

        case SINGLE_STATE_STREAM_BT_CONNECTING:
        {
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif
            mdi_video_stream_disconnect();
            g_single.bearer_pause = MMI_TRUE;
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
            break;
        }

        case SINGLE_STATE_STREAM_BUFFERING:
        {
            StopTimer(MEDPLY_STREAM_BUFFER_TIMER);            

        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif

            mdi_video_stream_stop_buffering();
            mdi_video_stream_disconnect();
            g_single.bearer_pause = MMI_TRUE;
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
            break;
        }

        case SINGLE_STATE_STREAM_PLAY:
        {
            mdi_video_stream_stop();
        #ifdef __MMI_A2DP_SUPPORT__
            mmi_medply_bt_stop(MMI_FALSE);
        #endif
        
            g_single.current_time = 0;
            mdi_video_stream_disconnect();
            g_single.bearer_pause = MMI_TRUE;
            mmi_medply_enter_single_states(SINGLE_STATE_STREAM_INITED);
            break;
        }
        default:
        	break;
    } 
    #ifdef __TCPIP__
    mmi_medply_settings_get_data_account_id(&data_account_id);
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_RELEASE_BEARER, __LINE__);
    cbm_release_bearer(cbm_get_app_id(data_account_id));
    #endif
}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_bear_event_callback_hdlr
 * DESCRIPTION
 *  check if mediaplayer is currently playing or prepare to play
 * PARAMETERS
 *  void
 * RETURNS
 * MMI_BOOL
 *****************************************************************************/
void mmi_medply_single_bear_event_reconnect(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    #ifdef __TCPIP__
    U32 data_account_id;
    S32 status;
    #endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    #ifdef __TCPIP__
    mmi_medply_settings_get_data_account_id(&data_account_id);
    status = cbm_get_bearer_status(data_account_id);
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_HOLD_BEARER, status, __LINE__);
    if(CBM_DEACTIVATED == status)
    {
        gui_start_timer(MMI_MEDPLY_QUERY_BEARER_TIMER, mmi_medply_single_bear_event_reconnect);
        return;
    }
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_HOLD_BEARER, status, __LINE__);
    cbm_hold_bearer(cbm_get_app_id(data_account_id));
    #endif
    
    if(g_single.bearer_pause == MMI_TRUE)
    {
        g_single.bearer_pause = MMI_FALSE;
        if(g_single.state == SINGLE_STATE_STREAM_IN_HISTORY)
        {
            mmi_medply_single_set_continue_flag(MMI_TRUE);
        }            
        else if(g_single.state == SINGLE_STATE_STREAM_INITED)
        {
            mmi_medply_single_stream_connect();
        }
    }
}



/*****************************************************************************
 * FUNCTION
 *  mmi_medply_bear_event_callback_hdlr
 * DESCRIPTION
 *  check if mediaplayer is currently playing or prepare to play
 * PARAMETERS
 *  void
 * RETURNS
 * MMI_BOOL
 *****************************************************************************/
static mmi_ret mmi_medply_single_bear_event_callback_hdlr(mmi_event_struct* evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_cbm_bearer_event_struct *cbm_event = (srv_cbm_bearer_event_struct *)evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_BEAR_EVENT_CALLBACK, cbm_event->type, g_single.state, g_single.bearer_pause);
    if (g_single.media_type != MEDPLY_TYPE_STREAM &&
        g_single.media_type != MEDPLY_TYPE_STREAM_RAM && 
        g_single.media_type != MEDPLY_TYPE_STREAM_RTSP &&
        g_single.media_type != MEDPLY_TYPE_STREAM_SDP)
    {
        return MMI_RET_OK;
    }
    
    switch(cbm_event->type)
    {
        case SRV_CBM_BEARER_EVENT_DISCONNECT:
            mmi_medply_single_bear_event_disconnect();
            break;

        case SRV_CBM_BEARER_EVENT_SWITCH:
            mmi_medply_single_bear_event_disconnect();
            mmi_medply_single_bear_event_reconnect();            
            break;
        
        default:
            break;
    }
    return MMI_RET_OK;
      
}


/*****************************************************************************
 * FUNCTION
 *  mmi_medply_bear_event_callback_hdlr
 * DESCRIPTION
 *  check if mediaplayer is currently playing or prepare to play
 * PARAMETERS
 *  void
 * RETURNS
 * MMI_BOOL
 *****************************************************************************/
static mmi_ret mmi_medply_single_bear_info_callback_hdlr(mmi_event_struct* evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_cbm_bearer_info_struct *cbm_info = (srv_cbm_bearer_info_struct *)evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_MEDIA_TRC_G2_APP, MMI_TRC_MEDPLY_CTL_BEAR_EVENT_CALLBACK, cbm_info->type, __LINE__, g_single.async_open_bearer);
    if (g_single.media_type != MEDPLY_TYPE_STREAM &&
        g_single.media_type != MEDPLY_TYPE_STREAM_RAM && 
        g_single.media_type != MEDPLY_TYPE_STREAM_RTSP &&
        g_single.media_type != MEDPLY_TYPE_STREAM_SDP)
    {
        return MMI_RET_OK;
    }
    
    switch(cbm_info->state)
    {
        case SRV_CBM_ACTIVATED:
            if(g_single.async_open_bearer == MMI_TRUE)
            {
                g_single.async_open_bearer = MMI_FALSE;
                mmi_medply_single_stream_connect_internal();
            }
            break;

        case SRV_CBM_DEACTIVATED:
            if(g_single.async_open_bearer == MMI_TRUE)
            {
                g_single.async_open_bearer = MMI_FALSE;
                mmi_medply_single_set_continue_flag(MMI_FALSE);
                mmi_popup_display_simple((WCHAR*)get_string(STR_GLOBAL_CURRENTLY_NOT_AVAILABLE),
                          MMI_EVENT_FAILURE, GRP_ID_MEDPLY_SINGLE, NULL);
            }            
            break;
        
        default:
            break;
    }
    return MMI_RET_OK;
      
}
#endif


#endif /*__MMI_MEDIA_PLAYER__*/

