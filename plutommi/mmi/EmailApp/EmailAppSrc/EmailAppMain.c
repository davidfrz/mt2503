/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*******************************************************************************
 * Filename:
 * ---------
 * EmailAppMain.c
 *
 * Project:
 * --------
 * MAUI
 *
 * Description:
 * ------------
 * 
 *
 * Author:
 * -------
 * 
 *
 *==============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!! 
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!! 
 *==============================================================================
 *******************************************************************************/
#include "MMI_features.h"

#ifdef __MMI_EMAIL__

#include "CommonScreens.h"
#include "Menucuigprot.h"
#include "conversions.h"
#include "ModeSwitchSrvGprot.h"

#include "EmailSrvGprot.h"
#include "EmailAppMem.h"
#include "EmailAppGProt.h"
#include "EmailAppAccount.h"
#include "EmailAppProt.h"

#include "MMIDataType.h"
#include "kal_general_types.h"
#include "CbmSrvGprot.h"
#include "mmi_rp_app_email_def.h"
#include "gui_typedef.h"
#include "gui_data_types.h"
#include "mmi_frm_scenario_gprot.h"
#include "GlobalResDef.h"
#include "mmi_frm_events_gprot.h"
#include "wgui_categories_popup.h"
#include "wgui_categories_util.h"
#include "CustDataRes.h"
#include "custom_events_notify.h"
#include "GlobalConstants.h"
#include "mmi_frm_input_gprot.h"
#include "fs_type.h"
#include "fs_func.h"
#include "FileMgrSrvGProt.h"
#include "fs_errcode.h"
#include "mmi_frm_mem_gprot.h"
#include "app_mem.h"
#include "kal_public_api.h"
#include "string.h"
#include "customer_ps_inc.h"
#include "wgui_categories_list.h"
#include "Unicodexdcl.h"
#include "wgui_categories_email.h"
#include "CbmCuiGprot.h"
#include "wgui_categories_text_viewer.h"
#include "mmi_frm_history_gprot.h"
#include "custom_mmi_default_value.h"
#include "wgui.h"
#include "app_datetime.h"
#include "FSEditorCuiGprot.h"
#include "EmailAppCore.h"
#include "PixcomFontEngine.h"
#include "ImeGprot.h"
#include "wgui_touch_screen.h"
#include "wgui_categories.h"
#include "NwUsabSrvGprot.h"
#include "mmi_inet_app_trc.h"
#ifdef __MMI_USB_SUPPORT__
#include "USBSrvGProt.h"
#endif

#include "EmailAppStateMgr.h"
#include "EmailAppSwitchStorage.h"
#include "EmailAppAccountData.h"
#include "EmailAppDtcnt.h"
#include "EmailAppNetwork.h"
#include "EmailAppAccset.h"
#include "EmailAppLib.h"
#include "EmailAppSSO.h"

typedef struct
{
    S32 hilight;
    U32 acct_num;
    mmi_id option_grp_id;
} email_app_acct_sel_struct;

typedef struct
{
    S32 num_items;
    S32 hilight;
    mmi_id main_grp_id;
    mmi_id option_grp_id;
    mmi_id parent_grp_id;
    EMAIL_ACCT_ID acct_id;
    EMAIL_ACCT_HANDLE connect_handle;
    BOOL is_connected;
} email_app_acct_main_struct;

typedef struct 
{
    EMAIL_ACCT_ID acct_id;
    EMAIL_FLDR_ID fldr_id;
    EMAIL_MSG_ID msg_id;
    mmi_id parent_id;
} email_app_msg_detail_struct;


/************************************************************************/
/*                          Variables                                   */
/************************************************************************/

mmi_id g_email_parent_id = 0;
void *g_email_mem_ptr = NULL;
mmi_id g_email_group_id = 0;
mmi_id g_email_active_grp_id = 0;
mmi_email_main_entry_gid_array_struct g_email_screen_group_id_info;

static email_app_acct_sel_struct email_app_acct_sel_data;
static email_app_acct_main_struct email_app_acct_main_data;
static email_app_msg_detail_struct email_app_msg_detail_info;
WCHAR email_app_msg_detail_buff[MMI_EMAIL_MAX_DETAIL_LEN + 1];

#ifdef __MMI_EMAIL_REMOTE_FOLDER__
#define MAX_REMOTE 20
static srv_email_acct_folder_struct remote_info[MAX_REMOTE];
static EMAIL_FLDR_ID remote_id_array[MAX_REMOTE];
static S32 remote_num = 0;
static S32 remote_hilit_index = 0;
static mmi_id remote_option_grp_id = 0;
#endif /* __MMI_EMAIL_REMOTE_FOLDER__ */

static WCHAR email_main_acct_name[SRV_EMAIL_MAX_ACCT_NAME_LEN + 1];

static S32 email_curr_hilit_template_index = 0;
static BOOL email_is_select_from_comp = FALSE;
static mmi_id template_grp_id = 0;
static mmi_id template_editor_id = 0;
static WCHAR template_edit_buff[MMI_EMAIL_MAX_TEMPLATE_LENGTH + 1];
static mmi_menu_id template_edit_menu_id[] = {MENU_ID_EMAIL_TEMPL_EDIT_SAVE};

const WCHAR g_email_subj_left_op[] = { '<', '\0' };
const WCHAR g_email_subj_right_op[] = { '>', '\0' };
const WCHAR g_email_2dots[] = { '.', '.', '\0' };
const WCHAR g_email_kilobyte[] = { 'K', 'B', '\0' };

/************************************************************************/
/*                          Prototypes                                  */
/************************************************************************/

static void mmi_email_main_pre_entry(void);
static mmi_ret mmi_email_main_group_proc(mmi_event_struct *evt);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_acct_sel_tap_callback(mmi_tap_type_enum tap_type, S32 index);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

static void mmi_email_hilite_acct_sel_item(S32 index);
static void mmi_email_acct_sel_csk(void);
static void mmi_email_acct_sel_lsk(void);
static void mmi_email_acct_sel_rsk(void);
static void mmi_email_exit_email(void);
static mmi_ret mmi_email_acct_sel_opt_proc(mmi_event_struct *evt);
static mmi_ret mmi_email_acct_sel_options_handler(mmi_menu_id menu_id, EMAIL_ACCT_ID acc_id);
static void mmi_email_entry_account_main_internal(void);
static mmi_ret mmi_email_acct_del_callback(mmi_event_struct *evt);
static S32 mmi_email_acct_main_get_items(S32 start_indx, gui_iconlist_menu_item *menuData, S32 num_item);
static mmi_ret mmi_email_acct_main_group_proc(mmi_event_struct *evt);
static mmi_ret mmi_email_acct_main_opt_proc(mmi_event_struct *evt);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_acct_main_tap_callback(mmi_tap_type_enum tap_type, S32 index);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

static void mmi_email_hilite_acct_main_item(S32 index);
static void mmi_email_acct_main_csk(void);
static void mmi_email_acct_main_lsk(void);
static mmi_ret mmi_email_acct_main_options_handler(mmi_menu_id menu_id, void *app_data);

static void mmi_email_acct_main_rsk(void);

static srv_email_result_enum mmi_email_prepare_msg_detail(void);
static void mmi_email_util_size_to_str(WCHAR *result, U32 size);
#ifdef __MMI_EMAIL_REMOTE_FOLDER__
static void mmi_email_pre_entry_remote_folder(mmi_id parent_id, EMAIL_ACCT_ID acct_id);
static void mmi_email_entry_remote_folder(void);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_remote_folder_tap_callback(mmi_tap_type_enum tap_type, S32 index);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

static S32 mmi_email_remote_main_get_items(S32 start_indx, gui_iconlist_menu_item *menuData, S32 num_item);
static void mmi_email_hilite_remote_main_item(S32 index);
static void mmi_email_remote_folder_lsk(void);
static mmi_ret mmi_email_entry_remote_folder_opt_proc(mmi_event_struct *evt);
static mmi_ret mmi_email_entry_remote_folder_options_handler(mmi_menu_id menu_id);
static void mmi_email_remote_entry_full_name(void);
static void mmi_email_remote_folder_csk(void);
#endif
static mmi_ret mmi_email_entry_template_proc(mmi_event_struct *evt);
static void mmi_email_entry_template_list(void);
static pBOOL mmi_email_template_list_get_item(S32 item_index, UI_string_type str_buff, PU8 *img_buff_p, U8 str_img_mask);
static void mmi_email_template_hilit_handler(S32 index);
static void mmi_email_insert_template(void);
static void mmi_email_entry_template_option(void);
static void mmi_email_entry_template_options_handler(mmi_menu_id menu_id);
static void mmi_email_entry_template_edit(void);
static void mmi_email_erase_template(void);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_template_list_tap_callback(mmi_tap_type_enum tap_type, S32 index);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

static void mmi_email_main_pre_entry_from_message_ext(void);

extern pBOOL IsTrChineseSet(void);
extern pBOOL IsSmChineseSet(void);

/************************************************************************/
/*                           Implements                                 */
/************************************************************************/

void mmi_email_change_drive_loading(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_CHANGE_DRIVE_LOADING, 1);
    if (!mmi_frm_scrn_enter(
            GRP_ID_ROOT,
            SCR_EMAIL_LOADING_ID,
            NULL,
            mmi_email_change_drive_loading,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_CHANGE_DRIVE_LOADING, 2);
        return;
    }
    ShowCategory66Screen(
        STR_GLOBAL_EMAIL,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        0,
        0,
        0,
        0,
        (U8*)GetString(STR_GLOBAL_LOADING),
        mmi_email_lib_get_progress_img_id(),
        NULL);
    SetLeftSoftkeyFunction(NULL, KEY_EVENT_UP);
    SetRightSoftkeyFunction(NULL, KEY_EVENT_UP);
    SetKeyHandler(NULL, KEY_END, KEY_EVENT_DOWN);
}



BOOL mmi_email_is_drive_valid(CHAR drive)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    int result = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    result = FS_GetDevStatus((U16)drive, FS_MOUNT_STATE_ENUM);
    switch (result)
    {
        case FS_DRIVE_NOT_FOUND:
        case FS_UNSUPPORTED_DEVICE:
        case FS_DRIVE_NOT_READY:
        case FS_DEVICE_BUSY:
        case FS_FLASH_MOUNT_ERROR:
        case FS_MSDC_MOUNT_ERROR:
        case FS_MSDC_READ_SECTOR_ERROR:
        case FS_MSDC_WRITE_SECTOR_ERROR:
        case FS_MSDC_NOT_PRESENT:
            {
                MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_IS_DRIVE_VALID, 0);
                return FALSE;
            }
        default:
            break;
    }
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_IS_DRIVE_VALID, 1);
    return TRUE;
}


void mmi_email_main_entry_from_shortcut(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_MAIN_ENTRY_FROM_SHORTCUT, __LINE__);
    mmi_email_main_pre_entry_from_message(GRP_ID_ROOT);
}

mmi_id mmi_email_entry_main_screen_from_cosmos(void* param, U32 param_size)
{
    mmi_email_main_pre_entry_from_message(GRP_ID_ROOT);
    return g_email_group_id;
}

void mmi_email_main_pre_entry_from_menu(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_MAIN_PRE_ENTRY_FROM_MENU, __LINE__);

    mmi_email_main_pre_entry_from_message(GRP_ID_ROOT);
}


void mmi_email_main_pre_entry_from_message(mmi_id parent_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    CHAR drive = srv_email_get_drive();

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_MAIN_PRE_ENTRY_FROM_MESSAGE, parent_id);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_MAIN_PRE_ENTRY_FROM_MESSAGE, drive);

    g_email_parent_id = parent_id;
    mmi_email_main_pre_entry_from_message_ext();
}


void mmi_email_main_pre_entry_from_message_ext(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_MAIN_PRE_ENTRY_FROM_MESSAGE_EXT, 1);
    if (!mmi_email_smgr_show_ui_check(mmi_email_main_pre_entry_from_message_ext))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_MAIN_PRE_ENTRY_FROM_MESSAGE_EXT, -1);
        return;
    }

    mmi_email_reset_curr_comp_info();
    mmi_email_reset_curr_read_info();
    mmi_email_reset_curr_fldr_info();
    if (g_email_group_id)
    {
        mmi_frm_group_close(g_email_group_id);
        g_email_group_id = 0;
    }

    if (g_email_mem_ptr == NULL)
    {
        g_email_mem_ptr = mmi_email_app_mem_pool_malloc(MMI_EMAIL_MEM_POOL_SIZE);
        if (g_email_mem_ptr == NULL)
        {
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_MAIN_PRE_ENTRY_FROM_MESSAGE_EXT, 8);
            mmi_frm_appmem_prompt_to_release_mem(
                APPLIB_MEM_AP_ID_EMAIL,
                0,
                MMI_EMAIL_MEM_POOL_SIZE,
                mmi_email_main_pre_entry_from_message_ext);
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_MAIN_PRE_ENTRY_FROM_MESSAGE_EXT, -1);
            return;
        }
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_MAIN_PRE_ENTRY_FROM_MESSAGE_EXT, 9);
    }
    srv_email_set_mem_func(
        0,
        mmi_email_app_mem_malloc,
        mmi_email_app_mem_free);

    mmi_email_main_pre_entry();
}

static void mmi_email_sso_callback(void)
{
    if (email_mmi_account_data_get_count() == 0)
    {
        mmi_email_wizard_new_account_launch(g_email_group_id);
    }
}

void mmi_email_main_pre_entry(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_MAIN_PRE_ENTRY, g_email_parent_id);

    (g_email_parent_id == 0) ? g_email_parent_id = GRP_ID_ROOT : (NULL);
    g_email_group_id = mmi_frm_group_create(
                        GRP_ID_ROOT,
                        GRP_ID_AUTO_GEN, 
                        mmi_email_main_group_proc,
                        NULL);
    mmi_frm_group_enter(g_email_group_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);

    mmi_email_entry_account_select();
    
#ifdef __MMI_SSO__
    if (!mmi_email_sso_precheck(mmi_email_sso_callback))
    {
        if (email_mmi_account_data_get_count() == 0)
        {
            mmi_email_wizard_new_account_launch(g_email_group_id);
        }
    }
#else
    if (email_mmi_account_data_get_count() == 0)
    {
        mmi_email_wizard_new_account_launch(g_email_group_id);
    }
#endif /* __MMI_SSO__ */
}


static mmi_ret mmi_email_main_group_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_MAIN_GROUP_PROC, evt->evt_id);
    switch(evt->evt_id)
    {
        case EVT_ID_ACCT_SETTING_EXIT:
            {
                if (email_mmi_account_data_get_count() == 0)
                {
                    mmi_frm_scrn_close(g_email_group_id, SCR_EMAIL_ACCT_SELECT_ID);
                }
            }
            break;

        case EVT_ID_GROUP_FOCUSED:
            mmi_email_set_active_group_id(g_email_group_id);
            break;

        case EVT_ID_GROUP_DEINIT:
            g_email_group_id = 0;
            email_app_acct_sel_data.hilight = 0;
            mmi_email_set_active_group_id(0);
            if (g_email_mem_ptr)
            {
                mmi_email_app_mem_pool_free(g_email_mem_ptr);
                g_email_mem_ptr = NULL;
            }
            break;

        default:
            break;
    }

    return MMI_RET_OK;
}

static S32 mmi_email_acc_list_entry_get_item(S32 start_index, gui_iconlist_menu_item *menu_data, S32 num)
{
    S32 i;
    for (i = 0; i < num; i++)
    {
        mmi_wcsncpy((WCHAR*)menu_data[i].item_list[0], 
            email_mmi_account_data_get_name(i + start_index), 
            MAX_SUBMENU_CHARACTERS);

        menu_data[i].image_list[0] = (PU8) GetImage(email_mmi_account_data_get_icon1(i + start_index));
        menu_data[i].image_list[1] = (PU8) GetImage(email_mmi_account_data_get_icon2(i + start_index));
    }
    return num;
}

static S32 mmi_email_acc_list_entry_get_hint(S32 start_index, UI_string_type *hint_array)
{
    hint_array[0] = (UI_string_type)email_mmi_account_data_get_hint(start_index);
    return 1;
}

static void refresh_mainmenu_worker(void)
{
    if(mmi_frm_scrn_get_active_id() != SCR_EMAIL_ACCT_SELECT_ID)
    {
        return;
    }

    if (email_mmi_account_data_get_count() == 0)
    {
        return;
    }

    wgui_cat1032_refresh_list(
        email_mmi_account_data_get_count(),
        email_app_acct_sel_data.hilight,
        mmi_email_acc_list_entry_get_item,
        mmi_email_acc_list_entry_get_hint);
}

void mmi_email_ui_refresh_mainmenu(void)
{
    if(mmi_frm_scrn_get_active_id() != SCR_EMAIL_ACCT_SELECT_ID)
    {
        return;
    }

    mmi_email_dummy_refresh(refresh_mainmenu_worker);
}


void mmi_email_entry_account_select(void)
{
    U8 *gui_buffer;

    if (!mmi_frm_scrn_enter(
            mmi_email_get_main_group_id(),
            SCR_EMAIL_ACCT_SELECT_ID,
            NULL,
            mmi_email_entry_account_select,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_ACCOUNT_SELECT, 3);
        return;
    }

    RegisterHighlightHandler(mmi_email_hilite_acct_sel_item);
    EnableCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);

    gui_buffer = mmi_frm_scrn_get_active_gui_buf();
    wgui_cat1032_show(
        (WCHAR*) GetString(STR_GLOBAL_EMAIL),
        (PU8) GetImage(GetRootTitleIcon(MENU_ID_EMAIL_MAIN)),
        (WCHAR*) GetString(STR_GLOBAL_OPTIONS),
        (PU8) GetImage(IMG_GLOBAL_OPTIONS),
        (WCHAR*) GetString(STR_GLOBAL_BACK),
        (PU8) GetImage(IMG_GLOBAL_BACK),
        email_mmi_account_data_get_count(),
        mmi_email_acc_list_entry_get_item,
        mmi_email_acc_list_entry_get_hint,
        0,
        0,
        IMG_EMAIL_READ_NORMAL_ID,
        IMG_EMAIL_READ_NORMAL_ID,
        gui_buffer,
        NULL);

    SetCenterSoftkeyFunction(mmi_email_acct_sel_csk, KEY_EVENT_UP);
    SetLeftSoftkeyFunction(mmi_email_acct_sel_lsk, KEY_EVENT_UP);
    SetRightSoftkeyFunction(mmi_email_acct_sel_rsk, KEY_EVENT_UP);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
    wgui_register_tap_callback(mmi_email_acct_sel_tap_callback);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */
}

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_acct_sel_tap_callback(mmi_tap_type_enum tap_type, S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_SEL_TAP_CALLBACK, __LINE__);

    email_app_acct_sel_data.hilight = index;
    if (tap_type == ENUM_TAP_ON_HIGHLIGHTED_ITEM)
    {
        mmi_email_acct_sel_csk();
    }
}
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */


static void mmi_email_hilite_acct_sel_item(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    email_app_acct_sel_data.hilight = index;
}


static void mmi_email_acct_sel_lsk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    EMAIL_ACCT_ID acc_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_SEL_LSK, __LINE__);

    if (email_mmi_account_data_get_count() > 0)
    {
        acc_id = email_mmi_account_data_get_id(email_app_acct_sel_data.hilight);
    }

    email_app_acct_sel_data.option_grp_id = mmi_frm_group_create(
                                                mmi_email_get_main_group_id(),
                                                GRP_ID_AUTO_GEN,
                                                mmi_email_acct_sel_opt_proc,
                                                (void*)acc_id); 
    mmi_frm_group_enter(email_app_acct_sel_data.option_grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);

    email_app_acct_sel_data.option_grp_id = cui_menu_create(
                                                email_app_acct_sel_data.option_grp_id,
                                                CUI_MENU_SRC_TYPE_RESOURCE,
                                                CUI_MENU_TYPE_OPTION,
                                                MENU_ID_EMAIL_ACCOUNT_SELECT_OPT,
                                                MMI_FALSE,
                                                (void*)acc_id);
    cui_menu_set_default_title(email_app_acct_sel_data.option_grp_id, NULL, get_image(GetRootTitleIcon(MENU_ID_EMAIL_MAIN)));
    cui_menu_run(email_app_acct_sel_data.option_grp_id);
}


static mmi_ret mmi_email_acct_sel_opt_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_SEL_OPT_PROC, menu_evt->evt_id);

    switch (menu_evt->evt_id)
    {
        case EVT_ID_CUI_MENU_LIST_ENTRY:
            if (email_mmi_account_data_get_count() == 0)
            {
                cui_menu_set_item_hidden(menu_evt->sender_id, MENU_ID_EMAIL_OPEN_ACCOUNT, MMI_TRUE);
                cui_menu_set_item_hidden(menu_evt->sender_id, MENU_ID_EMAIL_WRITE_EMAIL, MMI_TRUE);
                cui_menu_set_item_hidden(menu_evt->sender_id, MENU_ID_EMAIL_ACCT_SET_IMAPPUSH, MMI_TRUE);
                cui_menu_set_item_hidden(menu_evt->sender_id, MENU_ID_EMAIL_ACCT_SET_DEFAULT, MMI_TRUE);
            }
            else
            {
                cui_menu_set_item_hidden(menu_evt->sender_id, MENU_ID_EMAIL_OPEN_ACCOUNT, MMI_FALSE);
                cui_menu_set_item_hidden(menu_evt->sender_id, MENU_ID_EMAIL_WRITE_EMAIL, MMI_FALSE);
#ifdef __MMI_EMAIL_IMAP_PUSH__
                cui_menu_set_item_hidden(menu_evt->sender_id, MENU_ID_EMAIL_ACCT_SET_IMAPPUSH, MMI_FALSE);
#else
                cui_menu_set_item_hidden(menu_evt->sender_id, MENU_ID_EMAIL_ACCT_SET_IMAPPUSH, MMI_TRUE);
#endif /* __MMI_EMAIL_IMAP_PUSH__ */
                cui_menu_set_item_hidden(menu_evt->sender_id, MENU_ID_EMAIL_ACCT_SET_DEFAULT, MMI_FALSE);
            }
            break;

        case EVT_ID_CUI_MENU_ITEM_SELECT:
            mmi_email_acct_sel_options_handler(menu_evt->highlighted_menu_id, ((EMAIL_ACCT_ID)menu_evt->app_data));
            break;

        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
            cui_menu_close(menu_evt->sender_id);
            break;
    }

    return MMI_RET_OK;
}


static mmi_ret mmi_email_acct_sel_options_handler(mmi_menu_id menu_id, EMAIL_ACCT_ID acc_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_SEL_OPTIONS_HANDLER, menu_id);
    switch (menu_id)
    {
        case MENU_ID_EMAIL_OPEN_ACCOUNT:
            mmi_email_entry_account_main(mmi_email_get_main_group_id(), acc_id);
            break;

        case MENU_ID_EMAIL_WRITE_EMAIL:
            {
                mmi_email_prepare_comp_struct *comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));
                memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
                comp_data->acct_id = acc_id;
                comp_data->fldr_id = 0;
                comp_data->msg_id = 0;
                comp_data->parent_id = mmi_email_get_main_group_id();
                comp_data->type = EMAIL_PRE_COMP_TYPE_NEW;
                mmi_email_reset_curr_comp_info();
                mmi_email_prepare_entry_comp(comp_data);
                OslMfree(comp_data);
            }
            break;

        case MENU_ID_EMAIL_MAILBOXES:
            mmi_email_entry_account_list_launch(mmi_email_get_main_group_id());
            break;

        case MENU_ID_EMAIL_ACCT_STORAGE:
            mmi_email_switch_storage(mmi_email_get_main_group_id());
            break;

#ifdef __MMI_EMAIL_IMAP_PUSH__
        case MENU_ID_EMAIL_ACCT_SET_IMAPPUSH:
            email_mmi_account_set_push(mmi_email_get_main_group_id());
            break;
#endif /* __MMI_EMAIL_IMAP_PUSH__ */

        case MENU_ID_EMAIL_ACCT_SET_DEFAULT:
            email_mmi_account_set_default(mmi_email_get_main_group_id());
            break;

        default:
            break;
    }

    return MMI_RET_OK;
}


static void mmi_email_acct_sel_rsk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_SEL_RSK, __LINE__);
    mmi_email_exit_email();
}


static void mmi_email_exit_email(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_EXIT_EMAIL, g_email_group_id);
    mmi_frm_group_close(g_email_group_id);
}


static void mmi_email_acct_sel_csk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_SEL_CSK, __LINE__);

    if (email_mmi_account_data_get_count() > 0)
    {
        mmi_email_entry_account_main(
            mmi_email_get_main_group_id(), 
            email_mmi_account_data_get_id(email_app_acct_sel_data.hilight));
    }
    else
    {
        mmi_email_entry_account_list_launch(mmi_email_get_main_group_id());
    }
}


void mmi_email_entry_account_main(mmi_id parent_id, EMAIL_ACCT_ID acct_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_ACCOUNT_MAIN, 1);
    email_app_acct_main_data.main_grp_id = mmi_frm_group_create(
                                            parent_id,
                                            GRP_ID_AUTO_GEN, 
                                            mmi_email_acct_main_group_proc,
                                            NULL);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_ACCOUNT_MAIN, 2);
    mmi_frm_group_enter(email_app_acct_main_data.main_grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_ACCOUNT_MAIN, 3);
    mmi_frm_display_dummy_screen();

    mmi_email_app_nwk_user_enter(acct_id);

    email_app_acct_main_data.acct_id = acct_id;
    email_app_acct_main_data.parent_grp_id = parent_id;
    email_app_acct_main_data.hilight = 0;
    email_app_acct_main_data.option_grp_id = 0;
    mmi_email_entry_account_main_internal();
}


static mmi_ret mmi_email_acct_main_group_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_MAIN_GROUP_PROC, evt->evt_id);
    switch(evt->evt_id)
    {
        case EVT_ID_GROUP_FOCUSED:
            mmi_email_set_active_group_id(email_app_acct_main_data.main_grp_id);
            break;

        case EVT_ID_GROUP_DEINIT:
            mmi_email_app_nwk_user_leave();
            break;

        default:
            break;
    }
    
    return MMI_RET_OK;
}


void mmi_email_ui_refresh_account(EMAIL_ACCT_ID acc_id)
{
    if (acc_id != email_app_acct_main_data.acct_id)
    {
        return;
    }

    if(mmi_frm_scrn_get_active_id() != SCR_EMAIL_ACCT_ENTRY_ID
#ifdef __MMI_EMAIL_REMOTE_FOLDER__
        && mmi_frm_scrn_get_active_id() != SCR_ID_EMAIL_REMOTE_FOLDER
#endif /* __MMI_EMAIL_REMOTE_FOLDER__ */
        )
    {
        return;
    }

    if(mmi_frm_scrn_get_active_id() == SCR_EMAIL_ACCT_ENTRY_ID)
    {
        mmi_cat_refresh_asyncdynamic_list(
            (S32)email_app_acct_main_data.num_items,
            (S32)email_app_acct_main_data.hilight,
            mmi_email_acct_main_get_items,
            NULL);
    }

#ifdef __MMI_EMAIL_REMOTE_FOLDER__
    if (mmi_frm_scrn_get_active_id() == SCR_ID_EMAIL_REMOTE_FOLDER)
    {
        mmi_cat_refresh_asyncdynamic_list(
            remote_num,
            (S32)remote_hilit_index,
            mmi_email_remote_main_get_items,
            NULL);
    }
#endif /* __MMI_EMAIL_REMOTE_FOLDER__ */

    //mmi_email_dummy_refresh();
}

static void mmi_email_entry_account_main_internal(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *gui_buffer = NULL;
    U16 num_items = 4;
    S32 list_not_ready = 0;
#ifdef __MMI_EMAIL_REMOTE_FOLDER__
    S32 num = 0;
    EMAIL_ACCT_HANDLE acct_handle = 0;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
#endif
    srv_email_acct_info_cache_struct *acct_info = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_ACCOUNT_MAIN_INTERNAL, 1);

#ifdef __MMI_EMAIL_REMOTE_FOLDER__
    result = srv_email_acct_create(0, &acct_handle);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_acct_main_data.main_grp_id, result);
        return;
    }
    result = srv_email_acct_open(acct_handle, email_app_acct_main_data.acct_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        srv_email_acct_destroy(acct_handle);
        mmi_email_util_display_error_popup(email_app_acct_main_data.main_grp_id, result);
        return;
    }
    result = srv_email_acct_get_fldr_num(
        acct_handle,
        SRV_EMAIL_ACCT_FLDR_TYPE_LOCAL,
        &num);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        srv_email_acct_destroy(acct_handle);
        mmi_email_util_display_error_popup(email_app_acct_main_data.main_grp_id, result);
        return;
    }
    srv_email_acct_destroy(acct_handle);
#endif
    if (!mmi_frm_scrn_enter(
            email_app_acct_main_data.main_grp_id,
            SCR_EMAIL_ACCT_ENTRY_ID,
            NULL,
            mmi_email_entry_account_main_internal,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_ACCOUNT_MAIN_INTERNAL, 2);
        return;
    }
    gui_buffer = mmi_frm_scrn_get_active_gui_buf();
    RegisterHighlightHandler(mmi_email_hilite_acct_main_item);
    EnableCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    acct_info = OslMalloc(sizeof(srv_email_acct_info_cache_struct));
    srv_email_acct_cache_get(email_app_acct_main_data.acct_id, acct_info);
#ifdef __MMI_EMAIL_REMOTE_FOLDER__
    if (num != 0)
    {
        if (acct_info->protocol == SRV_EMAIL_PROT_IMAP4)
        {
            num_items = 5;
        }
    }
#endif
    email_app_acct_main_data.num_items = num_items;

    mmi_wcscpy(email_main_acct_name, acct_info->acct_name);
    OslMfree(acct_info);
    wgui_cat261_ext_show(
        (U8*)email_main_acct_name,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        STR_GLOBAL_OPTIONS,
        IMG_GLOBAL_OPTIONS,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        num_items,
        mmi_email_acct_main_get_items,
        NULL,
        (S32)email_app_acct_main_data.hilight,
        IMG_EMAIL_INBOX_ID,
        gui_buffer,
        &list_not_ready);
    if (list_not_ready)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_ACCOUNT_MAIN_INTERNAL, 3);
        mmi_frm_group_close(email_app_acct_main_data.main_grp_id);
        return;
    }
    SetCenterSoftkeyFunction(mmi_email_acct_main_csk, KEY_EVENT_UP);
    SetLeftSoftkeyFunction(mmi_email_acct_main_lsk, KEY_EVENT_UP);
    SetRightSoftkeyFunction(mmi_email_acct_main_rsk, KEY_EVENT_UP);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
    wgui_register_tap_callback(mmi_email_acct_main_tap_callback);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

    mmi_frm_scrn_set_leave_proc(
        email_app_acct_main_data.main_grp_id,
        SCR_EMAIL_ACCT_ENTRY_ID,
        mmi_email_acct_del_callback);
}


mmi_ret mmi_email_acct_del_callback(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_DEL_CALLBACK, evt->evt_id);
    switch (evt->evt_id)
    {
        case EVT_ID_SCRN_GOBACK_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ_IN_END_KEY:
        case EVT_ID_SCRN_DELETE_REQ:
            //srv_email_acct_destroy(mmi_email_get_acct_main_nwk_handle());
            //mmi_email_set_acct_main_nwk_state(FALSE);
            //mmi_email_set_acct_main_nwk_handle(0);
            //mmi_email_acct_set_refresh_status(0, FALSE);
            //mmi_email_disconnect_from_server(NULL);
            break;
        case EVT_ID_SCRN_GOBACK:
            break;
    }
    return MMI_RET_OK;
}


static S32 mmi_email_acct_main_get_items(S32 start_indx, gui_iconlist_menu_item *menuData, S32 num_item)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 num = 0;
    S32 index = start_indx, i = 0, get_index = 0;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    EMAIL_ACCT_HANDLE acct_handle;
    srv_email_acct_folder_struct *folder_info_ptr = NULL;

    U16 str_item_list[5] =
    {
        STR_GLOBAL_INBOX,
        STR_GLOBAL_OUTBOX,
        STR_EMAIL_SENT_ID,
        STR_GLOBAL_DRAFTS,
        STR_EMAIL_MORE_FOLDER_ID
    };
    U16 icon_array[5] =
    {
        IMG_EMAIL_INBOX_ID,
        IMG_EMAIL_OUTBOX_ID,
        IMG_EMAIL_SENT_ID,
        IMG_EMAIL_DRAFT_ID,
        IMG_EMAIL_MORE_FOLDER_ID
    };

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    result = srv_email_acct_create(0, &acct_handle);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        return 0;
    }
    result = srv_email_acct_open(acct_handle, email_app_acct_main_data.acct_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        srv_email_acct_destroy(acct_handle);
        return 0;
    }
    folder_info_ptr = OslMalloc(sizeof(srv_email_acct_folder_struct));
    memset(folder_info_ptr, 0, sizeof(srv_email_acct_folder_struct));
    for (; get_index < num_item; get_index++, index++)
    {
#ifdef __MMI_EMAIL_REMOTE_FOLDER__
        if (index == 4)
        {
            mmi_wcscpy((WCHAR*)menuData[get_index].item_list[0], (WCHAR*)GetString(str_item_list[index]));

            result = srv_email_acct_get_fldr_num(
                        acct_handle,
                        SRV_EMAIL_ACCT_FLDR_TYPE_LOCAL,
                        &num);
            if (result != SRV_EMAIL_RESULT_SUCC)
            {
                srv_email_acct_destroy(acct_handle);
                OslMfree(folder_info_ptr);
                return 0;
            }
            kal_wsprintf(
                (WCHAR*)menuData[get_index].item_list[1],
                "%d %w",
                num,
                (WCHAR*)GetString(STR_EMAIL_FOLDERS_ID));
            menuData[get_index].image_list[0] = (U8*)GetImage(icon_array[index]);
            for (i = 0; i < 3; i++) // 
            {
                menuData[get_index].image_list[i + 1] = NULL;
            }
            break;
        }
#endif
        mmi_wcscpy((WCHAR*)menuData[get_index].item_list[0], (WCHAR*)GetString(str_item_list[index]));
        result = srv_email_acct_get_fldr_info(acct_handle, 
            email_mmi_account_data_get_fldid(email_app_acct_main_data.acct_id, index),
            folder_info_ptr);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            srv_email_acct_destroy(acct_handle);
            OslMfree(folder_info_ptr);
            return 0;
        }
        kal_wsprintf(
            (WCHAR*)menuData[get_index].item_list[1],
            "%d %w",
            folder_info_ptr->msg_count,
            (WCHAR*)GetString(STR_EMAIL_MAILS_ID));
        menuData[get_index].image_list[0] = (U8*)GetImage(icon_array[index]);
        for (i = 0; i < 3; i++) // 
        {
            menuData[get_index].image_list[i + 1] = NULL;
        }
    }
    srv_email_acct_destroy(acct_handle);
    OslMfree(folder_info_ptr);
    return num_item;
}


#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_acct_main_tap_callback(mmi_tap_type_enum tap_type, S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_MAIN_TAP_CALLBACK, __LINE__);

    email_app_acct_main_data.hilight = index;
    if (tap_type == ENUM_TAP_ON_HIGHLIGHTED_ITEM)
    {
        mmi_email_acct_main_csk();
    }
}
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */


static void mmi_email_hilite_acct_main_item(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    email_app_acct_main_data.hilight = index;
}


static void mmi_email_acct_main_lsk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    void *user_data = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_MAIN_LSK, __LINE__);

    if (email_app_acct_main_data.hilight < 4)
    {
        user_data = (void*)email_mmi_account_data_get_fldid(email_app_acct_main_data.acct_id, email_app_acct_main_data.hilight);
    }
    else
    {
        user_data = NULL;
    }

    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_MAIN_LSK, __LINE__);
    email_app_acct_main_data.option_grp_id = mmi_frm_group_create(
                                                email_app_acct_main_data.main_grp_id,
                                                GRP_ID_AUTO_GEN,
                                                mmi_email_acct_main_opt_proc,
                                                NULL);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_MAIN_LSK, __LINE__);
    mmi_frm_group_enter(email_app_acct_main_data.option_grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_MAIN_LSK, __LINE__);

    email_app_acct_main_data.option_grp_id = cui_menu_create(
                                                email_app_acct_main_data.option_grp_id,
                                                CUI_MENU_SRC_TYPE_RESOURCE,
                                                CUI_MENU_TYPE_OPTION,
                                                MENU_ID_EMAIL_ACCOUNT_ENTRY_OPT,
                                                MMI_FALSE,
                                                user_data);
    cui_menu_set_default_title(email_app_acct_main_data.option_grp_id, NULL, get_image(GetRootTitleIcon(MENU_ID_EMAIL_MAIN)));
    cui_menu_run(email_app_acct_main_data.option_grp_id);
}


static mmi_ret mmi_email_acct_main_opt_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_MAIN_OPT_PROC, menu_evt->evt_id);
    switch (menu_evt->evt_id)
    {
        case EVT_ID_CUI_MENU_LIST_ENTRY:
            if (mmi_email_app_nwk_is_refreshing(email_app_acct_main_data.acct_id))
            {
                cui_menu_set_item_hidden(email_app_acct_main_data.option_grp_id, MENU_ID_EMAIL_ACCT_RETRIEVE_START, MMI_TRUE);
                cui_menu_set_item_hidden(email_app_acct_main_data.option_grp_id, MENU_ID_EMAIL_ACCT_RETRIEVE_STOP, MMI_FALSE);
            }
            else
            {
                cui_menu_set_item_hidden(email_app_acct_main_data.option_grp_id, MENU_ID_EMAIL_ACCT_RETRIEVE_START, MMI_FALSE);
                cui_menu_set_item_hidden(email_app_acct_main_data.option_grp_id, MENU_ID_EMAIL_ACCT_RETRIEVE_STOP, MMI_TRUE);
            }
            break;

        case EVT_ID_CUI_MENU_ITEM_SELECT:
            mmi_email_acct_main_options_handler(menu_evt->highlighted_menu_id, menu_evt->app_data);
            cui_menu_close(menu_evt->sender_id);
            break;

        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
            cui_menu_close(menu_evt->sender_id);
            break;
    }

    return MMI_RET_OK;
}


static mmi_ret mmi_email_acct_main_options_handler(mmi_menu_id menu_id, void *app_data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_MAIN_OPTIONS_HANDLER, menu_id);
    switch (menu_id)
    {
        case MENU_ID_EMAIL_OPEN_FOLDER:
            {
                srv_email_fldr_type_enum type = SRV_EMAIL_FLDR_TYPE_INBOX;
                type = (srv_email_fldr_type_enum)email_app_acct_main_data.hilight;
#ifdef __MMI_EMAIL_REMOTE_FOLDER__
                if (type == SRV_EMAIL_FLDR_TYPE_BASICS_END + 1)
                {
                    mmi_email_pre_entry_remote_folder(
                        email_app_acct_main_data.main_grp_id,
                        email_app_acct_main_data.acct_id);
                }
                else
#endif
                {
                    EMAIL_FLDR_ID folder_id = (EMAIL_FLDR_ID)app_data;
                    mmi_email_pre_entry_folder(
                        email_app_acct_main_data.main_grp_id,
                        email_app_acct_main_data.acct_id,
                        folder_id,
                        type,
                        FALSE);
                }
            }
            break;

        case MENU_ID_EMAIL_WRITE_EMAIL:
            {
                mmi_email_prepare_comp_struct *comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));
                memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
                comp_data->acct_id = email_app_acct_main_data.acct_id;
                comp_data->fldr_id = 0;
                comp_data->msg_id = 0;
                comp_data->parent_id = email_app_acct_main_data.main_grp_id;
                comp_data->type = EMAIL_PRE_COMP_TYPE_NEW;
                mmi_email_reset_curr_comp_info();
                mmi_email_prepare_entry_comp(comp_data);
                OslMfree(comp_data);
            }
            break;

        case MENU_ID_EMAIL_ACCT_RETRIEVE_START:
            mmi_email_app_nwk_user_refresh(email_app_acct_main_data.acct_id);
            break;

        case MENU_ID_EMAIL_ACCT_RETRIEVE_STOP:
            mmi_email_app_nwk_user_refresh_stop(email_app_acct_main_data.acct_id);
            break;

        case MENU_ID_EMAIL_SETTING:
            mmi_email_entry_edit_account_launch(mmi_email_get_main_group_id(), email_app_acct_main_data.acct_id);
            break;

        case MENU_ID_EMAIL_TEMPALTE_LIST:
            mmi_email_pre_entry_template_list(email_app_acct_main_data.main_grp_id, FALSE);
            break;

        default:
            break;
    }

    return MMI_RET_OK;
}


static void mmi_email_acct_main_rsk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_MAIN_RSK, __LINE__);
    mmi_frm_group_close(email_app_acct_main_data.main_grp_id);
}


static void mmi_email_acct_main_csk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ACCT_MAIN_CSK, __LINE__);

    if (email_app_acct_main_data.hilight < 4)
    {
        srv_email_fldr_type_enum type = SRV_EMAIL_FLDR_TYPE_INBOX;
        EMAIL_FLDR_ID folder_id = 0;

        type = (srv_email_fldr_type_enum)email_app_acct_main_data.hilight;
        folder_id = email_mmi_account_data_get_fldid(email_app_acct_main_data.acct_id,email_app_acct_main_data.hilight);
        mmi_email_pre_entry_folder(
            email_app_acct_main_data.main_grp_id,
            email_app_acct_main_data.acct_id,
            folder_id,
            type,
            FALSE);
    }
#ifdef __MMI_EMAIL_REMOTE_FOLDER__
    else
    {
        mmi_email_pre_entry_remote_folder(
            email_app_acct_main_data.main_grp_id,
            email_app_acct_main_data.acct_id);
    }
#endif
}


void mmi_email_init_msg_detail_struct(EMAIL_MSG_ID msg_id, EMAIL_FLDR_ID fldr_id, EMAIL_ACCT_ID acct_id, mmi_id grp_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    email_app_msg_detail_info.acct_id = acct_id;
    email_app_msg_detail_info.fldr_id = fldr_id;
    email_app_msg_detail_info.msg_id = msg_id;
    email_app_msg_detail_info.parent_id = grp_id;
}


void mmi_email_show_msg_detail(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    U8 *gui_buffer = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SHOW_MSG_DETAIL, 1);

    result = mmi_email_prepare_msg_detail();
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SHOW_MSG_DETAIL, 2);
        mmi_email_util_display_error_popup(email_app_msg_detail_info.parent_id, result);
        return;
    }

    if (!mmi_frm_scrn_enter(
            email_app_msg_detail_info.parent_id,
            SCR_ID_EMAIL_MSG_DETAIL,
            NULL,
            mmi_email_show_msg_detail,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SHOW_MSG_DETAIL, 3);
        return;
    }
    gui_buffer = mmi_frm_scrn_get_active_gui_buf();
    ShowCategory74Screen(
        STR_GLOBAL_DETAILS,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        0,
        0,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        (U8*)email_app_msg_detail_buff,
        mmi_wcslen(email_app_msg_detail_buff),
        gui_buffer);

    SetRightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);
}


srv_email_result_enum mmi_email_prepare_msg_detail(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    WCHAR *sub_buff = NULL, *str_buff = NULL;
    UI_time time;
    U32 local_time;
    WCHAR line[] = {0x0A, 0x00};
    WCHAR seperator[10];
    CHAR quote[] = {'\"', '\0', '\0', '\0'};
    CHAR space[] = {' ', '\0', '\0', '\0'};
    U32 lengh_before_size = 0, sub_len = MMI_EMAIL_MAX_SUBJ_LEN + 1;
    S32 line_length = mmi_wcslen(line), sep_length = 0;
    WCHAR *detail_ptr = NULL;
    U16 temp_length = 0;
    EMAIL_MSG_HANDLE msg_handle = 0;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;
    srv_email_msg_get_basic_info_struct *msg_basic_info = NULL;
    srv_email_addr_struct *msg_addr_info = NULL;
    applib_time_struct time_info = {0};
    srv_email_msg_get_recipient_struct recp_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PREPARE_MSG_DETAIL, __LINE__);

    result = srv_email_msg_create(0, &msg_handle);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        return result;
    }
    result = srv_email_msg_open(
                msg_handle,
                email_app_msg_detail_info.acct_id,
                email_app_msg_detail_info.fldr_id,
                email_app_msg_detail_info.msg_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        srv_email_msg_destroy(msg_handle);
        return result;
    }
    memset(email_app_msg_detail_buff, 0, sizeof(email_app_msg_detail_buff));
    mmi_wcscpy(seperator, line);
    mmi_wcscat(seperator, line);
    sep_length = mmi_wcslen(seperator);
    detail_ptr = email_app_msg_detail_buff;

    msg_addr_info = OslMalloc(sizeof(srv_email_addr_struct));
    result = srv_email_msg_get_sender(
                msg_handle,
                msg_addr_info);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        OslMfree(msg_addr_info);
        srv_email_msg_destroy(msg_handle);
        return result;
    }
    /* sender field */
    mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_FROM_ID));
    detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_EMAIL_FROM_ID));
    mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_COLON_ID));
    detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_EMAIL_COLON_ID));
    mmi_wcscpy(detail_ptr, line);
    detail_ptr += line_length;
    /* display name */
    if (msg_addr_info->disp_name_len != 0)
    {
        mmi_wcscpy(detail_ptr, (WCHAR*)quote);
        detail_ptr += 1;
        mmi_wcscpy(detail_ptr, msg_addr_info->disp_name);
        detail_ptr += msg_addr_info->disp_name_len;
        mmi_wcscpy(detail_ptr, (WCHAR*)quote);
        detail_ptr += 1;
        mmi_wcscpy(detail_ptr, (WCHAR*)space);
        detail_ptr += 1;
    }
    /* address */
    if ((temp_length = mmi_wcslen(msg_addr_info->email_addr)) != 0)
    {
        mmi_wcscpy(detail_ptr, g_email_subj_left_op);
        detail_ptr += 1;
        mmi_wcscpy(detail_ptr, msg_addr_info->email_addr);
        detail_ptr += temp_length;
        mmi_wcscpy(detail_ptr, g_email_subj_right_op);
        detail_ptr += 1;
    }
    else
    {
        mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_GLOBAL_EMPTY_LIST));
        detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_GLOBAL_EMPTY_LIST));
    }
    mmi_wcscpy(detail_ptr, seperator);
    detail_ptr += sep_length;
    OslMfree(msg_addr_info);

    sub_buff = OslMalloc((MMI_EMAIL_MAX_SUBJ_LEN + 1) * ENCODING_LENGTH);
    result = srv_email_msg_get_subject(msg_handle, sub_buff, &sub_len);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        OslMfree(sub_buff);
        srv_email_msg_destroy(msg_handle);
        return result;
    }
    /* subject field */
    mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_GLOBAL_SUBJECT));
    detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_GLOBAL_SUBJECT));
    mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_COLON_ID));
    detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_EMAIL_COLON_ID));
    mmi_wcscpy(detail_ptr, line);
    detail_ptr += line_length;
    if (sub_len != 0)
    {
        mmi_wcscpy(detail_ptr, sub_buff);
        detail_ptr += sub_len;
    }
    else
    {
        mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_COMMON_NO_SUBJECT_ID));
        detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_EMAIL_COMMON_NO_SUBJECT_ID));
    }
    mmi_wcscpy(detail_ptr, seperator);
    detail_ptr += sep_length;
    OslMfree(sub_buff);

    /* date field */
    msg_basic_info = OslMalloc(sizeof(srv_email_msg_get_basic_info_struct));
    result = srv_email_msg_get_basic_info(
                msg_handle,
                msg_basic_info);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        OslMfree(msg_basic_info);
        srv_email_msg_destroy(msg_handle);
        return result;
    }
    str_buff = OslMalloc(20 * ENCODING_LENGTH);
    memset(str_buff, 0, 20 * ENCODING_LENGTH);
    mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_GLOBAL_DATE));
    detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_GLOBAL_DATE));
    mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_COLON_ID));
    detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_EMAIL_COLON_ID));
    mmi_wcscpy(detail_ptr, line);
    detail_ptr += line_length;
    local_time = applib_dt_sec_utc_to_local(msg_basic_info->mail_date);
    applib_dt_utc_sec_2_mytime(local_time, &time_info, MMI_FALSE);
    if ((time_info.nMonth == 0) || (time_info.nDay == 0))
    {
        mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_GLOBAL_EMPTY_LIST));
        detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_GLOBAL_EMPTY_LIST));
    }
    else
    {
        time.nYear = time_info.nYear;
        time.nMonth = time_info.nMonth;
        time.nDay = time_info.nDay;
        time.DayIndex = 0;
        date_string(&time, (UI_string_type)str_buff, DT_IDLE_SCREEN);
        mmi_wcscpy(detail_ptr, str_buff);
        detail_ptr += mmi_wcslen(str_buff);
    }
    mmi_wcscpy(detail_ptr, seperator);
    detail_ptr += sep_length;

    /* time field */
    mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_GLOBAL_TIME));
    detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_GLOBAL_TIME));
    mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_COLON_ID));
    detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_EMAIL_COLON_ID));
    mmi_wcscpy(detail_ptr, line);
    detail_ptr += line_length;
    memset(str_buff, 0, 20 * ENCODING_LENGTH);
    if ((time_info.nMonth == 0) || (time_info.nDay == 0))
    {
        mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_GLOBAL_EMPTY_LIST));
        detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_GLOBAL_EMPTY_LIST));
    }
    else
    {
        time.nHour = time_info.nHour;
        time.nMin = time_info.nMin;
        time.nSec = time_info.nSec;
        time.DayIndex = 0;
        time_string(&time, (UI_string_type)str_buff, DT_IDLE_SCREEN);
        mmi_wcscpy(detail_ptr, str_buff);
        detail_ptr += mmi_wcslen(str_buff);
    }
    mmi_wcscpy(detail_ptr, seperator);
    detail_ptr += sep_length;

    OslMfree(str_buff);

    /* priority field */
    mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_GLOBAL_PRIORITY));
    detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_GLOBAL_PRIORITY));
    mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_COLON_ID));
    detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_EMAIL_COLON_ID));
    mmi_wcscpy(detail_ptr, line);
    detail_ptr += line_length;
    if (msg_basic_info->priority == EMAIL_MSG_PRIO_MED)
    {
        mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_GLOBAL_MEDIUM));
        detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_GLOBAL_MEDIUM));
    }
    else if (msg_basic_info->priority == EMAIL_MSG_PRIO_HIGH)
    {
        mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_GLOBAL_HIGH));
        detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_GLOBAL_HIGH));
    }
    else
    {
        mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_GLOBAL_LOW));
        detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_GLOBAL_LOW));
    }
    mmi_wcscpy(detail_ptr, seperator);
    detail_ptr += sep_length;

    /* size field */
    str_buff = OslMalloc(20 * ENCODING_LENGTH);
    mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_SIZE_ID));
    detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_EMAIL_SIZE_ID));
    mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_COLON_ID));
    detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_EMAIL_COLON_ID));
    mmi_wcscpy(detail_ptr, line);
    detail_ptr += line_length;
    mmi_email_util_size_to_str(str_buff, msg_basic_info->server_size);
    mmi_wcscpy(detail_ptr, str_buff);
    detail_ptr += mmi_wcslen(str_buff);
    if (msg_basic_info->to_addr_num ||
        msg_basic_info->cc_addr_num ||
        msg_basic_info->bcc_addr_num)
    {
        mmi_wcscpy(detail_ptr, seperator);
        detail_ptr += sep_length;
    }
    OslMfree(str_buff);

    /* to field */
    if (msg_basic_info->to_addr_num)
    {
        mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_TO_ID));
        detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_EMAIL_TO_ID));
        mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_COLON_ID));
        detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_EMAIL_COLON_ID));
        mmi_wcscpy(detail_ptr, line);
        detail_ptr += line_length;
        lengh_before_size = mmi_wcslen(email_app_msg_detail_buff);
        recp_info.addr_list = OslMalloc(sizeof(srv_email_addr_struct));
        recp_info.type = SRV_EMAIL_ADDR_TYPE_TO;
        recp_info.number = 1;
        for (recp_info.start_index = 0; recp_info.start_index < (U32)msg_basic_info->to_addr_num; recp_info.start_index++)
        {
            result = srv_email_msg_get_recipient(
                        msg_handle,
                        &recp_info);
            if (result != SRV_EMAIL_RESULT_SUCC)
            {
                OslMfree(msg_basic_info);
                OslMfree(recp_info.addr_list);
                srv_email_msg_destroy(msg_handle);
                return result;
            }
            if (recp_info.start_index != 0)
            {
                temp_length = mmi_wcslen((WCHAR*)GetString(STR_EMAIL_SEPERATOR_COMMA_ID));
                if ((lengh_before_size + temp_length) * ENCODING_LENGTH > sizeof(email_app_msg_detail_buff) - ENCODING_LENGTH)
                {
                    mmi_wcscpy(detail_ptr, (WCHAR*)g_email_2dots);
                    OslMfree(msg_basic_info);
                    OslMfree(recp_info.addr_list);
                    srv_email_msg_destroy(msg_handle);
                    return SRV_EMAIL_RESULT_SUCC;
                }
                mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_SEPERATOR_COMMA_ID));
                detail_ptr += temp_length;
                lengh_before_size += temp_length;
            }
            /* display name */
            if (recp_info.addr_list->disp_name_len != 0)
            {
                if ((lengh_before_size + recp_info.addr_list->disp_name_len + 3) * ENCODING_LENGTH > sizeof(email_app_msg_detail_buff) - ENCODING_LENGTH)
                {
                    mmi_wcscpy(detail_ptr, g_email_2dots);
                    OslMfree(msg_basic_info);
                    OslMfree(recp_info.addr_list);
                    srv_email_msg_destroy(msg_handle);
                    return SRV_EMAIL_RESULT_SUCC;
                }
                mmi_wcscpy(detail_ptr, (WCHAR*)quote);
                detail_ptr += 1;
                lengh_before_size += 1;
                mmi_wcscpy(detail_ptr, recp_info.addr_list->disp_name);
                detail_ptr += recp_info.addr_list->disp_name_len;
                lengh_before_size += recp_info.addr_list->disp_name_len;
                mmi_wcscpy(detail_ptr, (WCHAR*)quote);
                detail_ptr += 1;
                lengh_before_size += 1;
                mmi_wcscpy(detail_ptr, (WCHAR*)space);
                detail_ptr += 1;
                lengh_before_size += 1;
            }
            /* address */
            temp_length = mmi_wcslen(recp_info.addr_list->email_addr);
            if ((lengh_before_size + temp_length + 2) * ENCODING_LENGTH > sizeof(email_app_msg_detail_buff) - ENCODING_LENGTH)
            {
                mmi_wcscpy(detail_ptr, g_email_2dots);
                OslMfree(msg_basic_info);
                OslMfree(recp_info.addr_list);
                srv_email_msg_destroy(msg_handle);
                return SRV_EMAIL_RESULT_SUCC;
            }
            mmi_wcscpy(detail_ptr, g_email_subj_left_op);
            detail_ptr += 1;
            lengh_before_size += 1;
            mmi_wcscpy(
                detail_ptr,
                recp_info.addr_list->email_addr);
            detail_ptr += temp_length;
            lengh_before_size += temp_length;
            mmi_wcscpy(detail_ptr, g_email_subj_right_op);
            detail_ptr += 1;
            lengh_before_size += 1;
        }
        OslMfree(recp_info.addr_list);
        if (msg_basic_info->cc_addr_num ||
            msg_basic_info->bcc_addr_num)
        {
            if ((lengh_before_size + sep_length) * ENCODING_LENGTH > sizeof(email_app_msg_detail_buff) - ENCODING_LENGTH)
            {
                if ((lengh_before_size + mmi_wcslen((WCHAR*)g_email_2dots)) * ENCODING_LENGTH > sizeof(email_app_msg_detail_buff) - ENCODING_LENGTH)
                {
                    mmi_wcscpy(&email_app_msg_detail_buff[MMI_EMAIL_MAX_DETAIL_LEN - 2], (WCHAR*)g_email_2dots);
                }
                else
                {
                    mmi_wcscpy(detail_ptr, (WCHAR*)g_email_2dots);
                }
                OslMfree(msg_basic_info);
                srv_email_msg_destroy(msg_handle);
                return SRV_EMAIL_RESULT_SUCC;
            }
            mmi_wcscpy(detail_ptr, seperator);
            detail_ptr += sep_length;
            lengh_before_size += sep_length;
        }
    }

    /* Cc field */
    if (msg_basic_info->cc_addr_num)
    {
        mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_CC_ID));
        detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_EMAIL_CC_ID));
        mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_COLON_ID));
        detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_EMAIL_COLON_ID));
        mmi_wcscpy(detail_ptr, line);
        detail_ptr += line_length;
        //lengh_before_size = mmi_wcslen(email_app_msg_detail_buff);
        recp_info.addr_list = OslMalloc(sizeof(srv_email_addr_struct));
        recp_info.type = SRV_EMAIL_ADDR_TYPE_CC;
        recp_info.number = 1;
        for (recp_info.start_index = 0; recp_info.start_index < (U32)msg_basic_info->cc_addr_num; recp_info.start_index++)
        {
            result = srv_email_msg_get_recipient(
                        msg_handle,
                        &recp_info);
            if (result != SRV_EMAIL_RESULT_SUCC)
            {
                OslMfree(msg_basic_info);
                OslMfree(recp_info.addr_list);
                srv_email_msg_destroy(msg_handle);
                return result;
            }
            if (recp_info.start_index != 0)
            {
                temp_length = mmi_wcslen((WCHAR*)GetString(STR_EMAIL_SEPERATOR_COMMA_ID));
                if ((lengh_before_size + temp_length) * ENCODING_LENGTH > sizeof(email_app_msg_detail_buff) - ENCODING_LENGTH)
                {
                    mmi_wcscpy(detail_ptr, (WCHAR*)g_email_2dots);
                    OslMfree(msg_basic_info);
                    OslMfree(recp_info.addr_list);
                    srv_email_msg_destroy(msg_handle);
                    return SRV_EMAIL_RESULT_SUCC;
                }
                mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_SEPERATOR_COMMA_ID));
                detail_ptr += temp_length;
                lengh_before_size += temp_length;
            }
            /* display name */
            if (recp_info.addr_list->disp_name_len != 0)
            {
                if ((lengh_before_size + recp_info.addr_list->disp_name_len + 3) * ENCODING_LENGTH > sizeof(email_app_msg_detail_buff) - ENCODING_LENGTH)
                {
                    mmi_wcscpy(detail_ptr, g_email_2dots);
                    OslMfree(msg_basic_info);
                    OslMfree(recp_info.addr_list);
                    srv_email_msg_destroy(msg_handle);
                    return SRV_EMAIL_RESULT_SUCC;
                }
                mmi_wcscpy(detail_ptr, (WCHAR*)quote);
                detail_ptr += 1;
                lengh_before_size += 1;
                mmi_wcscpy(detail_ptr, recp_info.addr_list->disp_name);
                detail_ptr += recp_info.addr_list->disp_name_len;
                lengh_before_size += recp_info.addr_list->disp_name_len;
                mmi_wcscpy(detail_ptr, (WCHAR*)quote);
                detail_ptr += 1;
                lengh_before_size += 1;
                mmi_wcscpy(detail_ptr, (WCHAR*)space);
                detail_ptr += 1;
                lengh_before_size += 1;
            }
            /* address */
            temp_length = mmi_wcslen(recp_info.addr_list->email_addr);
            if ((lengh_before_size + temp_length + 2) * ENCODING_LENGTH > sizeof(email_app_msg_detail_buff) - ENCODING_LENGTH)
            {
                mmi_wcscpy(detail_ptr, g_email_2dots);
                OslMfree(msg_basic_info);
                OslMfree(recp_info.addr_list);
                srv_email_msg_destroy(msg_handle);
                return SRV_EMAIL_RESULT_SUCC;
            }
            mmi_wcscpy(detail_ptr, g_email_subj_left_op);
            detail_ptr += 1;
            lengh_before_size += 1;
            mmi_wcscpy(
                detail_ptr,
                recp_info.addr_list->email_addr);
            detail_ptr += temp_length;
            lengh_before_size += temp_length;
            mmi_wcscpy(detail_ptr, g_email_subj_right_op);
            detail_ptr += 1;
            lengh_before_size += 1;
        }
        OslMfree(recp_info.addr_list);
        if (msg_basic_info->bcc_addr_num)
        {
            if ((lengh_before_size + sep_length) * ENCODING_LENGTH > sizeof(email_app_msg_detail_buff) - ENCODING_LENGTH)
            {
                if ((lengh_before_size + mmi_wcslen((WCHAR*)g_email_2dots)) * ENCODING_LENGTH > sizeof(email_app_msg_detail_buff) - ENCODING_LENGTH)
                {
                    mmi_wcscpy(&email_app_msg_detail_buff[MMI_EMAIL_MAX_DETAIL_LEN - 2], (WCHAR*)g_email_2dots);
                }
                else
                {
                    mmi_wcscpy(detail_ptr, (WCHAR*)g_email_2dots);
                }
                OslMfree(msg_basic_info);
                srv_email_msg_destroy(msg_handle);
                return SRV_EMAIL_RESULT_SUCC;
            }
            mmi_wcscpy(detail_ptr, seperator);
            detail_ptr += sep_length;
            lengh_before_size += sep_length;
        }
    }

#ifdef __MMI_EMAIL_BCC__
    /* Bcc field */
    if (msg_basic_info->bcc_addr_num)
    {
        mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_BCC_ID));
        detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_EMAIL_BCC_ID));
        mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_COLON_ID));
        detail_ptr += mmi_wcslen((WCHAR*)GetString(STR_EMAIL_COLON_ID));
        mmi_wcscpy(detail_ptr, line);
        detail_ptr += line_length;
        //lengh_before_size = mmi_wcslen(email_app_msg_detail_buff);
        recp_info.addr_list = OslMalloc(sizeof(srv_email_addr_struct));
        recp_info.type = SRV_EMAIL_ADDR_TYPE_BCC;
        recp_info.number = 1;
        for (recp_info.start_index = 0; recp_info.start_index < (U32)msg_basic_info->bcc_addr_num; recp_info.start_index++)
        {
            result = srv_email_msg_get_recipient(
                msg_handle,
                &recp_info);
            if (result != SRV_EMAIL_RESULT_SUCC)
            {
                OslMfree(msg_basic_info);
                OslMfree(recp_info.addr_list);
                srv_email_msg_destroy(msg_handle);
                return result;
            }
            if (recp_info.start_index != 0)
            {
                temp_length = mmi_wcslen((WCHAR*)GetString(STR_EMAIL_SEPERATOR_COMMA_ID));
                if ((lengh_before_size + temp_length) * ENCODING_LENGTH > sizeof(email_app_msg_detail_buff) - ENCODING_LENGTH)
                {
                    mmi_wcscpy(detail_ptr, (WCHAR*)g_email_2dots);
                    OslMfree(msg_basic_info);
                    OslMfree(recp_info.addr_list);
                    srv_email_msg_destroy(msg_handle);
                    return SRV_EMAIL_RESULT_SUCC;
                }
                mmi_wcscpy(detail_ptr, (WCHAR*)GetString(STR_EMAIL_SEPERATOR_COMMA_ID));
                detail_ptr += temp_length;
                lengh_before_size += temp_length;
            }
            /* display name */
            if (recp_info.addr_list->disp_name_len != 0)
            {
                if ((lengh_before_size + recp_info.addr_list->disp_name_len + 3) * ENCODING_LENGTH > sizeof(email_app_msg_detail_buff) - ENCODING_LENGTH)
                {
                    mmi_wcscpy(detail_ptr, g_email_2dots);
                    OslMfree(msg_basic_info);
                    OslMfree(recp_info.addr_list);
                    srv_email_msg_destroy(msg_handle);
                    return SRV_EMAIL_RESULT_SUCC;
                }
                mmi_wcscpy(detail_ptr, (WCHAR*)quote);
                detail_ptr += 1;
                lengh_before_size += 1;
                mmi_wcscpy(detail_ptr, recp_info.addr_list->disp_name);
                detail_ptr += recp_info.addr_list->disp_name_len;
                lengh_before_size += recp_info.addr_list->disp_name_len;
                mmi_wcscpy(detail_ptr, (WCHAR*)quote);
                detail_ptr += 1;
                lengh_before_size += 1;
                mmi_wcscpy(detail_ptr, (WCHAR*)space);
                detail_ptr += 1;
                lengh_before_size += 1;
            }
            /* address */
            temp_length = mmi_wcslen(recp_info.addr_list->email_addr);
            if ((lengh_before_size + temp_length + 2) * ENCODING_LENGTH > sizeof(email_app_msg_detail_buff) - ENCODING_LENGTH)
            {
                mmi_wcscpy(detail_ptr, g_email_2dots);
                OslMfree(msg_basic_info);
                OslMfree(recp_info.addr_list);
                srv_email_msg_destroy(msg_handle);
                return SRV_EMAIL_RESULT_SUCC;
            }
            mmi_wcscpy(detail_ptr, g_email_subj_left_op);
            detail_ptr += 1;
            lengh_before_size += 1;
            mmi_wcscpy(
                detail_ptr,
                recp_info.addr_list->email_addr);
            detail_ptr += temp_length;
            lengh_before_size += temp_length;
            mmi_wcscpy(detail_ptr, g_email_subj_right_op);
            detail_ptr += 1;
            lengh_before_size += 1;
        }
        OslMfree(recp_info.addr_list);
    }
    OslMfree(msg_basic_info);
    srv_email_msg_destroy(msg_handle);
    return SRV_EMAIL_RESULT_SUCC;
#endif /* __MMI_EMAIL_BCC__ */
}


void mmi_email_util_size_to_str(WCHAR *result, U32 size)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    WCHAR *strBuff = OslMalloc(10 * ENCODING_LENGTH);

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    kal_wsprintf(strBuff, "%d", ((size + 1023) / 1024));
    mmi_wcscpy(result, strBuff);
    mmi_wcscat(result, g_email_kilobyte);

    OslMfree(strBuff);
}


#ifdef __MMI_EMAIL_REMOTE_FOLDER__

void mmi_email_pre_entry_remote_folder(mmi_id parent_id, EMAIL_ACCT_ID acct_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 index = 0;
    EMAIL_ACCT_HANDLE acct_handle = 0;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_REMOTE_FOLDER, parent_id);

    result = srv_email_acct_create(0, &acct_handle);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        mmi_email_util_display_error_popup(email_app_acct_main_data.main_grp_id, result);
        return;
    }
    result = srv_email_acct_open(acct_handle, email_app_acct_main_data.acct_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        srv_email_acct_destroy(acct_handle);
        mmi_email_util_display_error_popup(email_app_acct_main_data.main_grp_id, result);
        return;
    }
    result = srv_email_acct_get_fldr_num(
                acct_handle,
                SRV_EMAIL_ACCT_FLDR_TYPE_LOCAL,
                &remote_num);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        srv_email_acct_destroy(acct_handle);
        mmi_email_util_display_error_popup(email_app_acct_main_data.main_grp_id, result);
        return;
    }
    result = srv_email_acct_get_fldr_id(
                acct_handle,
                SRV_EMAIL_ACCT_FLDR_TYPE_LOCAL,
                0,
                &remote_num,
                remote_id_array);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        srv_email_acct_destroy(acct_handle);
        mmi_email_util_display_error_popup(email_app_acct_main_data.main_grp_id, result);
        return;
    }
    for (; index < remote_num; index++)
    {
        result = srv_email_acct_get_fldr_info(
                    acct_handle,
                    remote_id_array[index],
                    &remote_info[index]);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            srv_email_acct_destroy(acct_handle);
            mmi_email_util_display_error_popup(email_app_acct_main_data.main_grp_id, result);
            return;
        }
    }
    srv_email_acct_destroy(acct_handle);
    remote_hilit_index = 0;
    mmi_email_entry_remote_folder();
}


void mmi_email_entry_remote_folder(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *gui_buffer = NULL;
    S32 list_not_ready = 0;
    U16 index = 0;
    EMAIL_ACCT_HANDLE acct_handle = 0;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_REMOTE_FOLDER, 1);
    if (!mmi_frm_scrn_enter(
            email_app_acct_main_data.main_grp_id,
            SCR_ID_EMAIL_REMOTE_FOLDER,
            NULL,
            mmi_email_entry_remote_folder,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_REMOTE_FOLDER, 2);
        return;
    }
    result = srv_email_acct_create(0, &acct_handle);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_REMOTE_FOLDER, 3);
        mmi_email_util_display_error_popup(email_app_acct_main_data.main_grp_id, result);
        mmi_frm_scrn_close_active_id();
        return;
    }
    result = srv_email_acct_open(acct_handle, email_app_acct_main_data.acct_id);
    if (result != SRV_EMAIL_RESULT_SUCC)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_REMOTE_FOLDER, 4);

        srv_email_acct_destroy(acct_handle);
        mmi_email_util_display_error_popup(email_app_acct_main_data.main_grp_id, result);
        mmi_frm_scrn_close_active_id();
        return;
    }
    for (; index < remote_num; index++)
    {
        result = srv_email_acct_get_fldr_info(
                    acct_handle,
                    remote_id_array[index],
                    &remote_info[index]);
        if (result != SRV_EMAIL_RESULT_SUCC)
        {
            MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_REMOTE_FOLDER, 5);
            srv_email_acct_destroy(acct_handle);
            mmi_email_util_display_error_popup(email_app_acct_main_data.main_grp_id, result);
            mmi_frm_scrn_close_active_id();
            return;
        }
    }
    srv_email_acct_destroy(acct_handle);
    gui_buffer = mmi_frm_scrn_get_active_gui_buf();
    RegisterHighlightHandler(mmi_email_hilite_remote_main_item);
    EnableCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    wgui_cat261_ext_show(
        (U8*)GetString(STR_GLOBAL_EMAIL),
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        STR_GLOBAL_OPTIONS,
        IMG_GLOBAL_OPTIONS,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        remote_num,
        mmi_email_remote_main_get_items,
        NULL,
        (S32)remote_hilit_index,
        IMG_EMAIL_INBOX_ID,
        gui_buffer,
        &list_not_ready);
    if (list_not_ready)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_REMOTE_FOLDER, 6);
        mmi_frm_scrn_close_active_id();
        return;
    }
    SetCenterSoftkeyFunction(mmi_email_remote_folder_csk, KEY_EVENT_UP);
    SetLeftSoftkeyFunction(mmi_email_remote_folder_lsk, KEY_EVENT_UP);
    SetRightSoftkeyFunction(mmi_frm_scrn_close_active_id, KEY_EVENT_UP);

#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
    wgui_register_tap_callback(mmi_email_remote_folder_tap_callback);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */
}


#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_remote_folder_tap_callback(mmi_tap_type_enum tap_type, S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_REMOTE_FOLDER_TAP_CALLBACK, 1);
    remote_hilit_index = index;
    if (tap_type == ENUM_TAP_ON_HIGHLIGHTED_ITEM)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_REMOTE_FOLDER_TAP_CALLBACK, 2);
        mmi_email_remote_folder_csk();
    }
}
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */


static S32 mmi_email_remote_main_get_items(S32 start_indx, gui_iconlist_menu_item *menuData, S32 num_item)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 index = start_indx, i = 0, get_index = 0;
    WCHAR *name_ptr = NULL;
    EMAIL_ACCT_HANDLE acct_handle = 0;
    srv_email_result_enum result = SRV_EMAIL_RESULT_SUCC;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    result = srv_email_acct_create(0, &acct_handle);
    if (result == SRV_EMAIL_RESULT_SUCC)
    {
        result = srv_email_acct_open(acct_handle, email_app_acct_main_data.acct_id);
    }

    for (; get_index < num_item; get_index++, index++)
    {
        if (result == SRV_EMAIL_RESULT_SUCC)
        {
            srv_email_acct_get_fldr_info(
                acct_handle,
                remote_id_array[index],
                &remote_info[index]);
        }

        name_ptr = mmi_wcsrchr(remote_info[index].folder_name, remote_info[index].fldr_name_separator);
        if (name_ptr == NULL)
        {
            name_ptr = remote_info[index].folder_name;
        }
        else
        {
            name_ptr += 1;
        }
        mmi_wcscpy((WCHAR*)menuData[get_index].item_list[0], name_ptr);
        kal_wsprintf(
            (WCHAR*)menuData[get_index].item_list[1],
            "%d %w",
            remote_info[index].msg_count,
            (WCHAR*)GetString(STR_EMAIL_MAILS_ID));
        menuData[get_index].image_list[0] = (U8*)GetImage(IMG_EMAIL_REMOTE_SUB_ID);
        for (i = 0; i < 3; i++)
        {
            menuData[get_index].image_list[i + 1] = NULL;
        }
        name_ptr = NULL;
    }

    if (acct_handle != 0)
    {
        srv_email_acct_destroy(acct_handle);
    }

    return num_item;
}


WCHAR *mmi_email_remote_get_curr_folder_name(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    WCHAR *name_ptr = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    name_ptr = mmi_wcsrchr(remote_info[remote_hilit_index].folder_name, remote_info[remote_hilit_index].fldr_name_separator);
    if (name_ptr == NULL)
    {
        name_ptr = remote_info[remote_hilit_index].folder_name;
    }
    else
    {
        name_ptr += 1;
    }
    return name_ptr;
}


static void mmi_email_hilite_remote_main_item(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    remote_hilit_index = index;
}


static void mmi_email_remote_folder_lsk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_id option_grp_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_REMOTE_FOLDER_LSK, 1);
    remote_option_grp_id = mmi_frm_group_create(
                            email_app_acct_main_data.main_grp_id,
                            GRP_ID_AUTO_GEN,
                            mmi_email_entry_remote_folder_opt_proc,
                            NULL);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_REMOTE_FOLDER_LSK, 2);
    mmi_frm_group_enter(remote_option_grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_REMOTE_FOLDER_LSK, 3);

    option_grp_id = cui_menu_create(
                        remote_option_grp_id,
                        CUI_MENU_SRC_TYPE_RESOURCE,
                        CUI_MENU_TYPE_OPTION,
                        MENU_ID_EMAIL_ENTRY_REMOTE_FOLDER_OPT,
                        MMI_FALSE,
                        NULL);
    cui_menu_set_default_title(option_grp_id, NULL, get_image(GetRootTitleIcon(MENU_ID_EMAIL_MAIN)));
    cui_menu_run(option_grp_id);
}


static mmi_ret mmi_email_entry_remote_folder_opt_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_REMOTE_FOLDER_OPT_PROC, menu_evt->evt_id);
    switch (menu_evt->evt_id)
    {
        case EVT_ID_CUI_MENU_ITEM_SELECT:
            mmi_email_entry_remote_folder_options_handler(menu_evt->highlighted_menu_id);
            break;
        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
            cui_menu_close(menu_evt->sender_id);
            break;
    }

    return MMI_RET_OK;
}


static mmi_ret mmi_email_entry_remote_folder_options_handler(mmi_menu_id menu_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_REMOTE_FOLDER_OPTIONS_HANDLER, menu_id);
    switch (menu_id)
    {
        case MENU_ID_EMAIL_REMOTE_VIEW:
                mmi_email_pre_entry_folder(
                    email_app_acct_main_data.main_grp_id,
                    email_app_acct_main_data.acct_id,
                    remote_id_array[remote_hilit_index],
                    SRV_EMAIL_FLDR_TYPE_REMOTE,
                    FALSE);
            break;

        case MENU_ID_EMAIL_REMOTE_FULL_NAME:
                mmi_email_remote_entry_full_name();
            break;

        default:
            break;
    }

    return MMI_RET_OK;
}


void mmi_email_remote_entry_full_name(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *gui_buffer = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_REMOTE_ENTRY_FULL_NAME, 1);
    if (!mmi_frm_scrn_enter(
            email_app_acct_main_data.main_grp_id,
            SCR_ID_EMAIL_REMOTE_FOLDER_FULL_NAME,
            NULL,
            mmi_email_remote_entry_full_name,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_REMOTE_ENTRY_FULL_NAME, 2);
        return;
    }
    gui_buffer = mmi_frm_scrn_get_active_gui_buf();
    ShowCategory74Screen(
        STR_EMAIL_REMOTE_FOLDER_FULL_NAME_ID,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        0,
        0,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        (PU8)remote_info[remote_hilit_index].folder_name,
        mmi_wcslen(remote_info[remote_hilit_index].folder_name),
        gui_buffer);
    SetRightSoftkeyFunction(mmi_frm_scrn_close_active_id, KEY_EVENT_UP);
}


static void mmi_email_remote_folder_csk(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_REMOTE_FOLDER_CSK, __LINE__);

    mmi_email_pre_entry_folder(
        email_app_acct_main_data.main_grp_id,
        email_app_acct_main_data.acct_id,
        remote_id_array[remote_hilit_index],
        SRV_EMAIL_FLDR_TYPE_REMOTE,
        FALSE);
}

#endif


void mmi_email_pre_entry_template_list(mmi_id parent_id, BOOL is_add_to_comp)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_TEMPLATE_LIST, 1);
    if (template_grp_id)
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_TEMPLATE_LIST, 2);
        mmi_frm_group_close(template_grp_id);
    }
    memset(template_edit_buff, 0, sizeof(template_edit_buff));
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_TEMPLATE_LIST, 3);
    template_grp_id = mmi_frm_group_create(
        parent_id,
        GRP_ID_AUTO_GEN,
        mmi_email_entry_template_proc,
        NULL);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_TEMPLATE_LIST, 4);
    mmi_frm_group_enter(template_grp_id, MMI_FRM_NODE_SMART_CLOSE_FLAG);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_PRE_ENTRY_TEMPLATE_LIST, 5);
    email_is_select_from_comp = is_add_to_comp;
    mmi_email_entry_template_list();
}


static mmi_ret mmi_email_entry_template_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_menu_event_struct *menu_evt = (cui_menu_event_struct*)evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_TEMPLATE_PROC, menu_evt->evt_id);
    switch (menu_evt->evt_id)
    {
        case EVT_ID_GROUP_FOCUSED:
            mmi_email_set_active_group_id(template_grp_id);
            break;
        case EVT_ID_GROUP_DEINIT:
            if (template_editor_id)
            {
                cui_fseditor_close(template_editor_id);
                template_editor_id = 0;
            }
            email_is_select_from_comp = FALSE;
            email_curr_hilit_template_index = 0;
            template_grp_id = 0;
            break;
        case EVT_ID_CUI_MENU_ITEM_SELECT:
            mmi_email_entry_template_options_handler(menu_evt->highlighted_menu_id);
            break;
        case EVT_ID_CUI_MENU_CLOSE_REQUEST:
            cui_menu_close(menu_evt->sender_id);
            break;
        case EVT_ID_CUI_FSEDITOR_CSK_PRESSED:
        case EVT_ID_CUI_FSEDITOR_CUSTOM_MENU_SELECTED:
        case EVT_ID_CUI_FSEDITOR_SUBMMIT:
            {
                mmi_email_cont_temp_type_enum type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_ENG;
                mmi_email_app_core_result_enum result = MMI_EMAIL_SUCCESS;
                cui_fseditor_get_text(
                    template_editor_id,
                    template_edit_buff,
                    sizeof(template_edit_buff));
                if (IsTrChineseSet())
                {
                    type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_TC;
                }
                else if (IsSmChineseSet())
                {
                    type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_SC;
                }
                else
                {
                    type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_ENG;
                }
                result = mmi_email_cont_temp_edit(
                            type,
                            (U16)email_curr_hilit_template_index,
                            template_edit_buff,
                            MMI_EMAIL_MAX_TEMPLATE_LENGTH + 1);
                if (result != MMI_EMAIL_SUCCESS)
                {
                    break;
                }
                //mmi_email_lib_succ_popup(STR_GLOBAL_SAVED);
                cui_fseditor_close(template_editor_id);
                template_editor_id = 0;
            }
            break;
        case EVT_ID_CUI_FSEDITOR_ABORT:
            cui_fseditor_close(template_editor_id);
            template_editor_id = 0;
            break;
    }
    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_entry_template_list
 * DESCRIPTION
 *  Entry template list
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_email_entry_template_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *gui_buffer = NULL;
    S32 hiliteitem = 0;
    U16 lsk_str_id = 0;
    U16 lsk_img_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_TEMPLATE_LIST, 1);
    if (!mmi_frm_scrn_enter(
            template_grp_id,
            SCR_ID_EMAIL_TEMPLATE_LIST,
            NULL,
            mmi_email_entry_template_list,
            MMI_FRM_FULL_SCRN))
    {
        MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_TEMPLATE_LIST, 2);
        return;
    }
    gui_buffer = mmi_frm_scrn_get_active_gui_buf();
    if (gui_buffer != NULL)
    {
        hiliteitem = (email_curr_hilit_template_index < MMI_EMAIL_NUM_TEMPLATES) ? email_curr_hilit_template_index : 0;
    }
    RegisterHighlightHandler(mmi_email_template_hilit_handler);

    if (email_is_select_from_comp)
    {
        lsk_str_id = STR_GLOBAL_OK;
        lsk_img_id = IMG_GLOBAL_OK;
        EnableCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    }
    else
    {
        lsk_str_id = STR_GLOBAL_OPTIONS;
        lsk_img_id = IMG_GLOBAL_OPTIONS;
        EnableCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
    }

    ShowCategory184Screen(
        STR_EMAIL_TEMPLATE_ID,
        GetRootTitleIcon(MENU_ID_EMAIL_MAIN),
        lsk_str_id,
        lsk_img_id,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        MMI_EMAIL_NUM_TEMPLATES,
        mmi_email_template_list_get_item,
        NULL,
        hiliteitem,
        gui_buffer);

    SetRightSoftkeyFunction(mmi_frm_scrn_close_active_id, KEY_EVENT_UP);

    if (email_is_select_from_comp)
    {
        SetLeftSoftkeyFunction(mmi_email_insert_template, KEY_EVENT_UP);
        SetCenterSoftkeyFunction(mmi_email_insert_template, KEY_EVENT_UP);
    }
    else
    {
#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
        wgui_register_tap_callback(mmi_email_template_list_tap_callback);
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */

        SetLeftSoftkeyFunction(mmi_email_entry_template_option, KEY_EVENT_UP);
        SetCenterSoftkeyFunction(mmi_email_entry_template_edit, KEY_EVENT_UP);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_template_list_get_item
 * DESCRIPTION
 *  Get template list item
 * PARAMETERS
 *  item_index          [IN]            
 *  str_buff            [IN]            
 *  img_buff_p          [?]             
 *  str_img_mask        [IN]            
 * RETURNS
 * TRUE
 *****************************************************************************/
static pBOOL mmi_email_template_list_get_item(S32 item_index, UI_string_type str_buff, PU8 *img_buff_p, U8 str_img_mask)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_cont_temp_type_enum type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_ENG;
    mmi_email_app_core_result_enum result = MMI_EMAIL_SUCCESS;
    WCHAR *temp_str = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((item_index < 0) || (item_index >= MMI_EMAIL_NUM_TEMPLATES))
    {
        return FALSE;
    }
    if (IsTrChineseSet())
    {
        type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_TC;
    }
    else if (IsSmChineseSet())
    {
        type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_SC;
    }
    else
    {
        type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_ENG;
    }
    temp_str = OslMalloc(sizeof(WCHAR) * (MMI_EMAIL_MAX_TEMPLATE_LENGTH + 1));
    memset(temp_str, 0, sizeof(WCHAR) * (MMI_EMAIL_MAX_TEMPLATE_LENGTH + 1));
    result = mmi_email_cont_temp_read(
                type,
                (U16)item_index,
                temp_str,
                MMI_EMAIL_MAX_TEMPLATE_LENGTH + 1);
    if (result != MMI_EMAIL_SUCCESS)
    {
        OslMfree(temp_str);
        return FALSE;
    }
    if (mmi_wcslen(temp_str) == 0)
    {
        mmi_wcscpy((WCHAR*)str_buff, (WCHAR*)GetString(STR_GLOBAL_EMPTY_LIST));
    }
    else
    {
        mmi_wcscpy((WCHAR*)str_buff, (WCHAR*)temp_str);
    }
    OslMfree(temp_str);
    *img_buff_p = get_image(gIndexIconsImageList[item_index]);
    return TRUE;
}


/*****************************************************************************
* FUNCTION
*  mmi_email_template_hilit_handler
* DESCRIPTION
*  Get current highlight index in template list
* PARAMETERS
*  nIndex      [IN]        Current highlight index
* RETURNS
*  void
*****************************************************************************/
static void mmi_email_template_hilit_handler(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    email_curr_hilit_template_index = (U16)index;
}


/*****************************************************************************
* FUNCTION
*  mmi_email_insert_template
* DESCRIPTION
*  Insert template
* PARAMETERS
*  void
* RETURNS
*  void
 *****************************************************************************/
static void mmi_email_insert_template(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_cont_temp_type_enum type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_ENG;
    mmi_email_app_core_result_enum result = MMI_EMAIL_SUCCESS;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_INSERT_TEMPLATE, __LINE__);

    if (IsTrChineseSet())
    {
        type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_TC;
    }
    else if (IsSmChineseSet())
    {
        type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_SC;
    }
    else
    {
        type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_ENG;
    }
    memset(template_edit_buff, 0, sizeof(template_edit_buff));
    result = mmi_email_cont_temp_read(
        type,
        (U16)email_curr_hilit_template_index,
        template_edit_buff,
        MMI_EMAIL_MAX_TEMPLATE_LENGTH + 1);
    if (result != MMI_EMAIL_SUCCESS)
    {
        mmi_email_util_display_error_popup(template_grp_id, result);
        return;
    }
    if (mmi_email_comp_append_template(template_edit_buff))
    {
        mmi_frm_group_close(template_grp_id);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_email_entry_template_option
 * DESCRIPTION
 *  Entry template option
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_email_entry_template_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_id option_grp_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_TEMPLATE_OPTION, __LINE__);

    option_grp_id = cui_menu_create(
                        template_grp_id,
                        CUI_MENU_SRC_TYPE_RESOURCE,
                        CUI_MENU_TYPE_OPTION,
                        MENU_ID_EMAIL_TEMPLATE_OPT,
                        MMI_FALSE,
                        NULL);
    cui_menu_set_default_title(option_grp_id, NULL, get_image(GetRootTitleIcon(MENU_ID_EMAIL_MAIN)));
    cui_menu_run(option_grp_id);
}


static void mmi_email_entry_template_options_handler(mmi_menu_id menu_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_TEMPLATE_OPTIONS_HANDLER, menu_id);
    switch (menu_id)
    {
        case MENU_ID_EMAIL_TEMPL_EDIT:
            mmi_email_entry_template_edit();
            break;
        case MENU_ID_EMAIL_TEMPL_ERASE:
            {
                mmi_email_cont_temp_type_enum type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_ENG;
                mmi_email_app_core_result_enum result = MMI_EMAIL_SUCCESS;
                if (IsTrChineseSet())
                {
                    type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_TC;
                }
                else if (IsSmChineseSet())
                {
                    type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_SC;
                }
                else
                {
                    type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_ENG;
                }
                memset(template_edit_buff, 0, sizeof(template_edit_buff));
                result = mmi_email_cont_temp_read(
                            type,
                            (U16)email_curr_hilit_template_index,
                            template_edit_buff,
                            MMI_EMAIL_MAX_TEMPLATE_LENGTH + 1);
                if (result != MMI_EMAIL_SUCCESS)
                {
                    break;
                }
                if (!mmi_wcslen(template_edit_buff))
                {
                    mmi_email_lib_error_popup(STR_GLOBAL_EMPTY);
                }
                else
                {
                    mmi_email_util_display_confirm(
                        template_grp_id,
                        mmi_email_erase_template,
                        mmi_frm_scrn_close_active_id,
                        NULL,
                        FALSE,
                        GetString(STR_EMAIL_ERASE_CONFIRM_ID),
                        MMI_EVENT_QUERY);
                }
            }
            break;
        case MENU_ID_EMAIL_TEMPL_WRITE_EMAIL:
            {
                mmi_email_prepare_comp_struct *comp_data = OslMalloc(sizeof(mmi_email_prepare_comp_struct));
                memset(comp_data, 0, sizeof(mmi_email_prepare_comp_struct));
                comp_data->acct_id = email_app_acct_main_data.acct_id;
                comp_data->fldr_id = 0;
                comp_data->msg_id = 0;
                comp_data->parent_id = mmi_email_get_main_group_id();
                comp_data->type = EMAIL_PRE_COMP_TYPE_TEMPLATE;
                mmi_email_reset_curr_comp_info();
                mmi_email_prepare_entry_comp(comp_data);
                OslMfree(comp_data);
            }
            break;
        default:
            break;
    }
    return;
}


WCHAR *mmi_email_get_template_content(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_cont_temp_type_enum type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_ENG;
    mmi_email_app_core_result_enum result = MMI_EMAIL_SUCCESS;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_GET_TEMPLATE_CONTENT, __LINE__);

    if (IsTrChineseSet())
    {
        type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_TC;
    }
    else if (IsSmChineseSet())
    {
        type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_SC;
    }
    else
    {
        type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_ENG;
    }
    memset(template_edit_buff, 0, sizeof(template_edit_buff));
    result = mmi_email_cont_temp_read(
                type,
                (U16)email_curr_hilit_template_index,
                template_edit_buff,
                MMI_EMAIL_MAX_TEMPLATE_LENGTH + 1);
    if (result != MMI_EMAIL_SUCCESS)
    {
        return NULL;
    }
    return template_edit_buff;
}


/*****************************************************************************
* FUNCTION
*  mmi_email_entry_template_edit
* DESCRIPTION
*  Entry template edit screen
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
static void mmi_email_entry_template_edit(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_cont_temp_type_enum type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_ENG;
    mmi_email_app_core_result_enum result = MMI_EMAIL_SUCCESS;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ENTRY_TEMPLATE_EDIT, __LINE__);

    if (IsTrChineseSet())
    {
        type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_TC;
    }
    else if (IsSmChineseSet())
    {
        type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_SC;
    }
    else
    {
        type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_ENG;
    }
    memset(template_edit_buff, 0, sizeof(template_edit_buff));
    result = mmi_email_cont_temp_read(
        type,
        (U16)email_curr_hilit_template_index,
        template_edit_buff,
        MMI_EMAIL_MAX_TEMPLATE_LENGTH + 1);
    if (result != MMI_EMAIL_SUCCESS)
    {
        return;
    }
    template_editor_id = cui_fseditor_create(template_grp_id);
    cui_fseditor_set_title(template_editor_id, STR_EMAIL_EDIT_TEMPLATE_ID, GetRootTitleIcon(MENU_ID_EMAIL_MAIN));
    cui_fseditor_set_text(
        template_editor_id,
        template_edit_buff,
        sizeof(template_edit_buff),
        MMI_EMAIL_MAX_TEMPLATE_LENGTH);
    cui_fseditor_set_input_method(
        template_editor_id,
        IMM_INPUT_TYPE_SENTENCE,
        NULL,
        0);
    cui_fseditor_set_custom_options_menu(
        template_editor_id,
        MMI_TRUE,
        template_edit_menu_id,
        sizeof(template_edit_menu_id) / sizeof(mmi_menu_id));
    cui_fseditor_set_softkey_text(
        template_editor_id,
        MMI_CENTER_SOFTKEY,
        0);
    cui_fseditor_set_softkey_icon(
        template_editor_id,
        MMI_CENTER_SOFTKEY,
        IMG_GLOBAL_SAVE_CSK);
    cui_fseditor_run(template_editor_id);
}


/*****************************************************************************
* FUNCTION
*  mmi_email_erase_template
* DESCRIPTION
*  Erase template
* PARAMETERS
*  void
* RETURNS
*  void
*****************************************************************************/
static void mmi_email_erase_template(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_email_cont_temp_type_enum type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_ENG;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_ERASE_TEMPLATE, __LINE__);

    if (IsTrChineseSet())
    {
        type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_TC;
    }
    else if (IsSmChineseSet())
    {
        type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_SC;
    }
    else
    {
        type = MMI_EMAIL_CONT_TEMP_TYPE_PRE_DEFINED_ENG;
    }
    if (mmi_email_cont_temp_clear(type, (U16)email_curr_hilit_template_index) == MMI_EMAIL_SUCCESS)
    {
        //mmi_email_lib_succ_popup(STR_GLOBAL_REMOVED);
    }
    else
    {
        mmi_email_lib_error_popup(STR_GLOBAL_UNFINISHED);
    }
}


#if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__)
static void mmi_email_template_list_tap_callback(mmi_tap_type_enum tap_type, S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_TEMPLATE_LIST_TAP_CALLBACK, __LINE__);

    email_curr_hilit_template_index = (U16)index;
    if (tap_type == ENUM_TAP_ON_HIGHLIGHTED_ITEM)
    {
        mmi_email_entry_template_edit();
    }
}
#endif /* #if defined (__MMI_FTE_SUPPORT__) && defined (__MMI_TOUCH_SCREEN__) */


U32 mmi_email_get_unread_count(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 email_unread_count = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    srv_email_acct_total_unread_num_get(&email_unread_count);
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_GET_UNREAD_COUNT, email_unread_count);
    return email_unread_count;
}

mmi_id mmi_email_get_main_group_id(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_GET_MAIN_GROUP_ID, g_email_group_id);
    return g_email_group_id;
}


mmi_id mmi_email_get_active_group_id(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_GET_ACTIVE_GROUP_ID, g_email_active_grp_id);
    return g_email_active_grp_id;
}


void mmi_email_set_active_group_id(mmi_id grp_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_INET_TRC_G9_EMAIL, EMAILAPP_FUNC_MMI_EMAIL_SET_ACTIVE_GROUP_ID, grp_id);
    g_email_active_grp_id = grp_id;
}


void mmi_email_highlight_main_menu(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ChangeLeftSoftkey(STR_GLOBAL_OK, IMG_GLOBAL_OK);
    ChangeRightSoftkey(STR_GLOBAL_BACK, IMG_GLOBAL_BACK);
    SetLeftSoftkeyFunction(mmi_email_main_pre_entry, KEY_EVENT_UP);
    SetRightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);
}

#endif /* __MMI_EMAIL__ */


